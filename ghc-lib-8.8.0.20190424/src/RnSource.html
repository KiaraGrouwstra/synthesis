<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[RnSource]{Main pass of renamer}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">RnSource</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-14"></a><span>        </span><a href="RnSource.html#rnSrcDecls"><span class="hs-identifier hs-var">rnSrcDecls</span></a><span class="hs-special">,</span><span> </span><a href="RnSource.html#addTcgDUs"><span class="hs-identifier hs-var">addTcgDUs</span></a><span class="hs-special">,</span><span> </span><a href="RnSource.html#findSplice"><span class="hs-identifier hs-var">findSplice</span></a><span>
</span><a name="line-15"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="RnExpr.html"><span class="hs-identifier">RnExpr</span></a><span class="hs-special">(</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="RnSplice.html"><span class="hs-identifier">RnSplice</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="RnSplice.html#rnSpliceDecl"><span class="hs-identifier hs-var">rnSpliceDecl</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#rnTopSpliceDecls"><span class="hs-identifier hs-var">rnTopSpliceDecls</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FieldLabel</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="RnTypes.html"><span class="hs-identifier">RnTypes</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="RnBinds.html"><span class="hs-identifier">RnBinds</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="RnUtils.html"><span class="hs-identifier">RnUtils</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#mapFvRn"><span class="hs-identifier hs-var">mapFvRn</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#bindLocalNames"><span class="hs-identifier hs-var">bindLocalNames</span></a><span>
</span><a name="line-31"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#checkDupRdrNames"><span class="hs-identifier hs-var">checkDupRdrNames</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#inHsDocContext"><span class="hs-identifier hs-var">inHsDocContext</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#bindLocalNamesFV"><span class="hs-identifier hs-var">bindLocalNamesFV</span></a><span>
</span><a name="line-32"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#checkShadowedRdrNames"><span class="hs-identifier hs-var">checkShadowedRdrNames</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#warnUnusedTypePatterns"><span class="hs-identifier hs-var">warnUnusedTypePatterns</span></a><span>
</span><a name="line-33"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#extendTyVarEnvFVRn"><span class="hs-identifier hs-var">extendTyVarEnvFVRn</span></a><span class="hs-special">,</span><span> </span><a href="RnUtils.html#newLocalBndrsRn"><span class="hs-identifier hs-var">newLocalBndrsRn</span></a><span>
</span><a name="line-34"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="RnUtils.html#withHsDocContext"><span class="hs-identifier hs-var">withHsDocContext</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="RnUnbound.html"><span class="hs-identifier">RnUnbound</span></a><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkUnboundName</span><span class="hs-special">,</span><span> </span><a href="RnUnbound.html#notInScopeErr"><span class="hs-identifier hs-var">notInScopeErr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="RnNames.html"><span class="hs-identifier">RnNames</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="RnHsDoc.html"><span class="hs-identifier">RnHsDoc</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="RnHsDoc.html#rnHsDoc"><span class="hs-identifier hs-var">rnHsDoc</span></a><span class="hs-special">,</span><span> </span><a href="RnHsDoc.html#rnMbLHsDoc"><span class="hs-identifier hs-var">rnMbLHsDoc</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="TcAnnotations.html"><span class="hs-identifier">TcAnnotations</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="TcAnnotations.html#annCtxt"><span class="hs-identifier hs-var">annCtxt</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ForeignCall</span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">CCallTarget</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Warnings</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">plusWarns</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">applicativeClassName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pureAName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">thenAName</span><span>
</span><a name="line-45"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">monadClassName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">returnMName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">thenMName</span><span>
</span><a name="line-46"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">semigroupClassName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sappendName</span><span>
</span><a name="line-47"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">monoidClassName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mappendName</span><span>
</span><a name="line-48"></a><span>                        </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Avail</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">pprRuleName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>             </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">debugIsOn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">lengthExceeds</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">partitionWith</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hsc_dflags</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">findDupsEq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">removeDups</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">equivClasses</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SCC</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">flattenSCC</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">flattenSCCs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Node</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniq</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.List.NonEmpty</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">NE</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List.NonEmpty</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">difference</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fromList</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toList</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">{- | @rnSourceDecl@ &quot;renames&quot; declarations.
It simultaneously performs dependency analysis and precedence parsing.
It also does the following error checks:

* Checks that tyvars are used properly. This includes checking
  for undefined tyvars, and tyvars in contexts that are ambiguous.
  (Some of this checking has now been moved to module @TcMonoType@,
  since we don't have functional dependency information at this point.)

* Checks that all variable occurrences are defined.

* Checks the @(..)@ etc constraints in the export list.

Brings the binders of the group into scope in the appropriate places;
does NOT assume that anything is in scope already
-}</span><span>
</span><a name="line-91"></a><span class="hs-identifier">rnSrcDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- Rename a top-level HsGroup; used for normal source files *and* hs-boot files</span><span>
</span><a name="line-93"></a><a name="rnSrcDecls"><a href="RnSource.html#rnSrcDecls"><span class="hs-identifier">rnSrcDecls</span></a></a><span> </span><a name="local-6989586621682271999"><a href="#local-6989586621682271999"><span class="hs-identifier">group</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_valds</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272000"><a href="#local-6989586621682272000"><span class="hs-identifier">val_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-94"></a><span>                            </span><span class="hs-identifier">hs_splcds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272001"><a href="#local-6989586621682272001"><span class="hs-identifier">splice_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-95"></a><span>                            </span><span class="hs-identifier">hs_tyclds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272002"><a href="#local-6989586621682272002"><span class="hs-identifier">tycl_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-96"></a><span>                            </span><span class="hs-identifier">hs_derivds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272003"><a href="#local-6989586621682272003"><span class="hs-identifier">deriv_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-97"></a><span>                            </span><span class="hs-identifier">hs_fixds</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272004"><a href="#local-6989586621682272004"><span class="hs-identifier">fix_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-98"></a><span>                            </span><span class="hs-identifier">hs_warnds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272005"><a href="#local-6989586621682272005"><span class="hs-identifier">warn_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>                            </span><span class="hs-identifier">hs_annds</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272006"><a href="#local-6989586621682272006"><span class="hs-identifier">ann_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>                            </span><span class="hs-identifier">hs_fords</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272007"><a href="#local-6989586621682272007"><span class="hs-identifier">foreign_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-101"></a><span>                            </span><span class="hs-identifier">hs_defds</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272008"><a href="#local-6989586621682272008"><span class="hs-identifier">default_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-102"></a><span>                            </span><span class="hs-identifier">hs_ruleds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272009"><a href="#local-6989586621682272009"><span class="hs-identifier">rule_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-103"></a><span>                            </span><span class="hs-identifier">hs_docs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272010"><a href="#local-6989586621682272010"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-105"></a><span>   </span><span class="hs-comment">-- (A) Process the fixity declarations, creating a mapping from</span><span>
</span><a name="line-106"></a><span>   </span><span class="hs-comment">--     FastStrings to FixItems.</span><span>
</span><a name="line-107"></a><span>   </span><span class="hs-comment">--     Also checks for duplicates.</span><span>
</span><a name="line-108"></a><span>   </span><a name="local-6989586621682272011"><a href="#local-6989586621682272011"><span class="hs-identifier">local_fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#makeMiniFixityEnv"><span class="hs-identifier hs-var">makeMiniFixityEnv</span></a><span> </span><a href="#local-6989586621682272004"><span class="hs-identifier hs-var">fix_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span>   </span><span class="hs-comment">-- (B) Bring top level binders (and their fixities) into scope,</span><span>
</span><a name="line-111"></a><span>   </span><span class="hs-comment">--     *except* for the value bindings, which get done in step (D)</span><span>
</span><a name="line-112"></a><span>   </span><span class="hs-comment">--     with collectHsIdBinders. However *do* include</span><span>
</span><a name="line-113"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-114"></a><span>   </span><span class="hs-comment">--        * Class ops, data constructors, and record fields,</span><span>
</span><a name="line-115"></a><span>   </span><span class="hs-comment">--          because they do not have value declarations.</span><span>
</span><a name="line-116"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-117"></a><span>   </span><span class="hs-comment">--        * For hs-boot files, include the value signatures</span><span>
</span><a name="line-118"></a><span>   </span><span class="hs-comment">--          Again, they have no value declarations</span><span>
</span><a name="line-119"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-120"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272012"><a href="#local-6989586621682272012"><span class="hs-identifier">tc_envs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272013"><a href="#local-6989586621682272013"><span class="hs-identifier">tc_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#getLocalNonValBinders"><span class="hs-identifier hs-var">getLocalNonValBinders</span></a><span> </span><a href="#local-6989586621682272011"><span class="hs-identifier hs-var">local_fix_env</span></a><span> </span><a href="#local-6989586621682271999"><span class="hs-identifier hs-var">group</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span>   </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><a href="#local-6989586621682272012"><span class="hs-identifier hs-var">tc_envs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span>   </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span> </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- No point in continuing if (say) we have duplicate declarations</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span>   </span><span class="hs-comment">-- (D1) Bring pattern synonyms into scope.</span><span>
</span><a name="line-128"></a><span>   </span><span class="hs-comment">--      Need to do this before (D2) because rnTopBindsLHS</span><span>
</span><a name="line-129"></a><span>   </span><span class="hs-comment">--      looks up those pattern synonyms (Trac #9889)</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span>   </span><a href="RnSource.html#extendPatSynEnv"><span class="hs-identifier hs-var">extendPatSynEnv</span></a><span> </span><a href="#local-6989586621682272000"><span class="hs-identifier hs-var">val_decls</span></a><span> </span><a href="#local-6989586621682272011"><span class="hs-identifier hs-var">local_fix_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682272014"><a href="#local-6989586621682272014"><span class="hs-identifier">pat_syn_bndrs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span>   </span><span class="hs-comment">-- (D2) Rename the left-hand sides of the value bindings.</span><span>
</span><a name="line-134"></a><span>   </span><span class="hs-comment">--     This depends on everything from (B) being in scope.</span><span>
</span><a name="line-135"></a><span>   </span><span class="hs-comment">--     It uses the fixity env from (A) to bind fixities for view patterns.</span><span>
</span><a name="line-136"></a><span>   </span><a name="local-6989586621682272015"><a href="#local-6989586621682272015"><span class="hs-identifier">new_lhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnTopBindsLHS"><span class="hs-identifier hs-var">rnTopBindsLHS</span></a><span> </span><a href="#local-6989586621682272011"><span class="hs-identifier hs-var">local_fix_env</span></a><span> </span><a href="#local-6989586621682272000"><span class="hs-identifier hs-var">val_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>   </span><span class="hs-comment">-- Bind the LHSes (and their fixities) in the global rdr environment</span><span>
</span><a name="line-139"></a><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272016"><a href="#local-6989586621682272016"><span class="hs-identifier">id_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectHsIdBinders</span><span> </span><a href="#local-6989586621682272015"><span class="hs-identifier hs-var">new_lhs</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>  </span><span class="hs-comment">-- Excludes pattern-synonym binders</span><span>
</span><a name="line-140"></a><span>                                                    </span><span class="hs-comment">-- They are already in scope</span><span>
</span><a name="line-141"></a><span>   </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnSrcDecls&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272016"><span class="hs-identifier hs-var">id_bndrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-142"></a><span>   </span><a name="local-6989586621682272017"><a href="#local-6989586621682272017"><span class="hs-identifier">tc_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#extendGlobalRdrEnvRn"><span class="hs-identifier hs-var">extendGlobalRdrEnvRn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">avail</span><span> </span><a href="#local-6989586621682272016"><span class="hs-identifier hs-var">id_bndrs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272011"><span class="hs-identifier hs-var">local_fix_env</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-143"></a><span>   </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><a href="#local-6989586621682272017"><span class="hs-identifier hs-var">tc_envs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span>   </span><span class="hs-comment">--  Now everything is in scope, as the remaining renaming assumes.</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span>   </span><span class="hs-comment">-- (E) Rename type and class decls</span><span>
</span><a name="line-148"></a><span>   </span><span class="hs-comment">--     (note that value LHSes need to be in scope for default methods)</span><span>
</span><a name="line-149"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-150"></a><span>   </span><span class="hs-comment">-- You might think that we could build proper def/use information</span><span>
</span><a name="line-151"></a><span>   </span><span class="hs-comment">-- for type and class declarations, but they can be involved</span><span>
</span><a name="line-152"></a><span>   </span><span class="hs-comment">-- in mutual recursion across modules, and we only do the SCC</span><span>
</span><a name="line-153"></a><span>   </span><span class="hs-comment">-- analysis for them in the type checker.</span><span>
</span><a name="line-154"></a><span>   </span><span class="hs-comment">-- So we content ourselves with gathering uses only; that</span><span>
</span><a name="line-155"></a><span>   </span><span class="hs-comment">-- means we'll only report a declaration as unused if it isn't</span><span>
</span><a name="line-156"></a><span>   </span><span class="hs-comment">-- mentioned at all.  Ah well.</span><span>
</span><a name="line-157"></a><span>   </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;Start rnTyClDecls&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272002"><span class="hs-identifier hs-var">tycl_decls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-158"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272018"><a href="#local-6989586621682272018"><span class="hs-identifier">rn_tycl_decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272019"><a href="#local-6989586621682272019"><span class="hs-identifier">src_fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnTyClDecls"><span class="hs-identifier hs-var">rnTyClDecls</span></a><span> </span><a href="#local-6989586621682272002"><span class="hs-identifier hs-var">tycl_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span>   </span><span class="hs-comment">-- (F) Rename Value declarations right-hand sides</span><span>
</span><a name="line-161"></a><span>   </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;Start rnmono&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-162"></a><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272020"><a href="#local-6989586621682272020"><span class="hs-identifier">val_bndr_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><a href="#local-6989586621682272016"><span class="hs-identifier hs-var">id_bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><a href="#local-6989586621682272014"><span class="hs-identifier hs-var">pat_syn_bndrs</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-163"></a><span>   </span><a name="local-6989586621682272021"><a href="#local-6989586621682272021"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier hs-var">tcIsHsBootOrSig</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-164"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272022"><a href="#local-6989586621682272022"><span class="hs-identifier">rn_val_decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272023"><a href="#local-6989586621682272023"><span class="hs-identifier">bind_dus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682272021"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-165"></a><span>    </span><span class="hs-comment">-- For an hs-boot, use tc_bndrs (which collects how we're renamed</span><span>
</span><a name="line-166"></a><span>    </span><span class="hs-comment">-- signatures), since val_bndr_set is empty (there are no x = ...</span><span>
</span><a name="line-167"></a><span>    </span><span class="hs-comment">-- bindings in an hs-boot.)</span><span>
</span><a name="line-168"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="RnBinds.html#rnTopBindsBoot"><span class="hs-identifier hs-var">rnTopBindsBoot</span></a><span> </span><a href="#local-6989586621682272013"><span class="hs-identifier hs-var">tc_bndrs</span></a><span> </span><a href="#local-6989586621682272015"><span class="hs-identifier hs-var">new_lhs</span></a><span>
</span><a name="line-169"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="RnBinds.html#rnValBindsRHS"><span class="hs-identifier hs-var">rnValBindsRHS</span></a><span> </span><span class="hs-special">(</span><a href="RnEnv.html#TopSigCtxt"><span class="hs-identifier hs-var">TopSigCtxt</span></a><span> </span><a href="#local-6989586621682272020"><span class="hs-identifier hs-var">val_bndr_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272015"><span class="hs-identifier hs-var">new_lhs</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-170"></a><span>   </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;finish rnmono&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272022"><span class="hs-identifier hs-var">rn_val_decls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>   </span><span class="hs-comment">-- (G) Rename Fixity and deprecations</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span>   </span><span class="hs-comment">-- Rename fixity declarations and error if we try to</span><span>
</span><a name="line-175"></a><span>   </span><span class="hs-comment">-- fix something from another module (duplicates were checked in (A))</span><span>
</span><a name="line-176"></a><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272024"><a href="#local-6989586621682272024"><span class="hs-identifier">all_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272013"><span class="hs-identifier hs-var">tc_bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272020"><span class="hs-identifier hs-var">val_bndr_set</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-177"></a><span>   </span><a name="local-6989586621682272025"><a href="#local-6989586621682272025"><span class="hs-identifier">rn_fix_decls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RnBinds.html#rnSrcFixityDecl"><span class="hs-identifier hs-var">rnSrcFixityDecl</span></a><span> </span><span class="hs-special">(</span><a href="RnEnv.html#TopSigCtxt"><span class="hs-identifier hs-var">TopSigCtxt</span></a><span> </span><a href="#local-6989586621682272024"><span class="hs-identifier hs-var">all_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>                        </span><a href="#local-6989586621682272004"><span class="hs-identifier hs-var">fix_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>   </span><span class="hs-comment">-- Rename deprec decls;</span><span>
</span><a name="line-181"></a><span>   </span><span class="hs-comment">-- check for duplicates and ensure that deprecated things are defined locally</span><span>
</span><a name="line-182"></a><span>   </span><span class="hs-comment">-- at the moment, we don't keep these around past renaming</span><span>
</span><a name="line-183"></a><span>   </span><a name="local-6989586621682272026"><a href="#local-6989586621682272026"><span class="hs-identifier">rn_warns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnSrcWarnDecls"><span class="hs-identifier hs-var">rnSrcWarnDecls</span></a><span> </span><a href="#local-6989586621682272024"><span class="hs-identifier hs-var">all_bndrs</span></a><span> </span><a href="#local-6989586621682272005"><span class="hs-identifier hs-var">warn_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span>   </span><span class="hs-comment">-- (H) Rename Everything else</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272027"><a href="#local-6989586621682272027"><span class="hs-identifier">rn_rule_decls</span></a></a><span class="hs-special">,</span><span>    </span><a name="local-6989586621682272028"><a href="#local-6989586621682272028"><span class="hs-identifier">src_fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier hs-var">setXOptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.ScopedTypeVariables</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-188"></a><span>                                   </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><a href="RnSource.html#rnHsRuleDecls"><span class="hs-identifier hs-var">rnHsRuleDecls</span></a><span> </span><a href="#local-6989586621682272009"><span class="hs-identifier hs-var">rule_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-189"></a><span>                           </span><span class="hs-comment">-- Inside RULES, scoped type variables are on</span><span>
</span><a name="line-190"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272029"><a href="#local-6989586621682272029"><span class="hs-identifier">rn_foreign_decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272030"><a href="#local-6989586621682272030"><span class="hs-identifier">src_fvs3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><a href="RnSource.html#rnHsForeignDecl"><span class="hs-identifier hs-var">rnHsForeignDecl</span></a><span> </span><a href="#local-6989586621682272007"><span class="hs-identifier hs-var">foreign_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-191"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272031"><a href="#local-6989586621682272031"><span class="hs-identifier">rn_ann_decls</span></a></a><span class="hs-special">,</span><span>     </span><a name="local-6989586621682272032"><a href="#local-6989586621682272032"><span class="hs-identifier">src_fvs4</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><a href="RnSource.html#rnAnnDecl"><span class="hs-identifier hs-var">rnAnnDecl</span></a><span>       </span><a href="#local-6989586621682272006"><span class="hs-identifier hs-var">ann_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-192"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272033"><a href="#local-6989586621682272033"><span class="hs-identifier">rn_default_decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272034"><a href="#local-6989586621682272034"><span class="hs-identifier">src_fvs5</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><a href="RnSource.html#rnDefaultDecl"><span class="hs-identifier hs-var">rnDefaultDecl</span></a><span>   </span><a href="#local-6989586621682272008"><span class="hs-identifier hs-var">default_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-193"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272035"><a href="#local-6989586621682272035"><span class="hs-identifier">rn_deriv_decls</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682272036"><a href="#local-6989586621682272036"><span class="hs-identifier">src_fvs6</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><a href="RnSource.html#rnSrcDerivDecl"><span class="hs-identifier hs-var">rnSrcDerivDecl</span></a><span>  </span><a href="#local-6989586621682272003"><span class="hs-identifier hs-var">deriv_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-194"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272037"><a href="#local-6989586621682272037"><span class="hs-identifier">rn_splice_decls</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621682272038"><a href="#local-6989586621682272038"><span class="hs-identifier">src_fvs7</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><a href="RnSplice.html#rnSpliceDecl"><span class="hs-identifier hs-var">rnSpliceDecl</span></a><span>    </span><a href="#local-6989586621682272001"><span class="hs-identifier hs-var">splice_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-195"></a><span>      </span><span class="hs-comment">-- Haddock docs; no free vars</span><span>
</span><a name="line-196"></a><span>   </span><a name="local-6989586621682272039"><a href="#local-6989586621682272039"><span class="hs-identifier">rn_docs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="RnSource.html#rnDocDecl"><span class="hs-identifier hs-var">rnDocDecl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272010"><span class="hs-identifier hs-var">docs</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>   </span><a name="local-6989586621682272040"><a href="#local-6989586621682272040"><span class="hs-identifier">last_tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-199"></a><span>   </span><span class="hs-comment">-- (I) Compute the results and return</span><span>
</span><a name="line-200"></a><span>   </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><a name="local-6989586621682272041"><a href="#local-6989586621682272041"><span class="hs-identifier">rn_group</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_ext</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">,</span><span>
</span><a name="line-201"></a><span>                             </span><span class="hs-identifier">hs_valds</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272022"><span class="hs-identifier hs-var">rn_val_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-202"></a><span>                             </span><span class="hs-identifier">hs_splcds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272037"><span class="hs-identifier hs-var">rn_splice_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-203"></a><span>                             </span><span class="hs-identifier">hs_tyclds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272018"><span class="hs-identifier hs-var">rn_tycl_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-204"></a><span>                             </span><span class="hs-identifier">hs_derivds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272035"><span class="hs-identifier hs-var">rn_deriv_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-205"></a><span>                             </span><span class="hs-identifier">hs_fixds</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272025"><span class="hs-identifier hs-var">rn_fix_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-206"></a><span>                             </span><span class="hs-identifier">hs_warnds</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- warns are returned in the tcg_env</span><span>
</span><a name="line-207"></a><span>                                             </span><span class="hs-comment">-- (see below) not in the HsGroup</span><span>
</span><a name="line-208"></a><span>                             </span><span class="hs-identifier">hs_fords</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272029"><span class="hs-identifier hs-var">rn_foreign_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-209"></a><span>                             </span><span class="hs-identifier">hs_annds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272031"><span class="hs-identifier hs-var">rn_ann_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-210"></a><span>                             </span><span class="hs-identifier">hs_defds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272033"><span class="hs-identifier hs-var">rn_default_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-211"></a><span>                             </span><span class="hs-identifier">hs_ruleds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272027"><span class="hs-identifier hs-var">rn_rule_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-212"></a><span>                             </span><span class="hs-identifier">hs_docs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272039"><span class="hs-identifier hs-var">rn_docs</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span>        </span><a name="local-6989586621682272042"><a href="#local-6989586621682272042"><span class="hs-identifier">tcf_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsTyClForeignBinders</span><span> </span><a href="#local-6989586621682272018"><span class="hs-identifier hs-var">rn_tycl_decls</span></a><span> </span><a href="#local-6989586621682272029"><span class="hs-identifier hs-var">rn_foreign_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-215"></a><span>        </span><a name="local-6989586621682272043"><a href="#local-6989586621682272043"><span class="hs-identifier">other_def</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><a href="#local-6989586621682272042"><span class="hs-identifier hs-var">tcf_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-216"></a><span>        </span><a name="local-6989586621682272044"><a href="#local-6989586621682272044"><span class="hs-identifier">other_fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFVs</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272019"><span class="hs-identifier hs-var">src_fvs1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272028"><span class="hs-identifier hs-var">src_fvs2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272030"><span class="hs-identifier hs-var">src_fvs3</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272032"><span class="hs-identifier hs-var">src_fvs4</span></a><span class="hs-special">,</span><span>
</span><a name="line-217"></a><span>                              </span><a href="#local-6989586621682272034"><span class="hs-identifier hs-var">src_fvs5</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272036"><span class="hs-identifier hs-var">src_fvs6</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272038"><span class="hs-identifier hs-var">src_fvs7</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-218"></a><span>                </span><span class="hs-comment">-- It is tiresome to gather the binders from type and class decls</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span>        </span><a name="local-6989586621682272045"><a href="#local-6989586621682272045"><span class="hs-identifier">src_dus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272043"><span class="hs-identifier hs-var">other_def</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusDU</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272023"><span class="hs-identifier hs-var">bind_dus</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusDU</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">usesOnly</span><span> </span><a href="#local-6989586621682272044"><span class="hs-identifier hs-var">other_fvs</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-221"></a><span>                </span><span class="hs-comment">-- Instance decls may have occurrences of things bound in bind_dus</span><span>
</span><a name="line-222"></a><span>                </span><span class="hs-comment">-- so we must put other_fvs last</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span>        </span><a name="local-6989586621682272046"><a href="#local-6989586621682272046"><span class="hs-identifier">final_tcg_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272047"><a href="#local-6989586621682272047"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272040"><span class="hs-identifier hs-var">last_tcg_env</span></a><span> </span><span class="hs-special">`</span><a href="RnSource.html#addTcgDUs"><span class="hs-identifier hs-var">addTcgDUs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272045"><span class="hs-identifier hs-var">src_dus</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- we return the deprecs in the env, not in the HsGroup above</span><span>
</span><a name="line-226"></a><span>                        </span><a href="#local-6989586621682272047"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_warns</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_warns</span><span> </span><a href="#local-6989586621682272047"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusWarns</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272026"><span class="hs-identifier hs-var">rn_warns</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">;</span><span>
</span><a name="line-227"></a><span>       </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-228"></a><span>   </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;finish rnSrc&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272041"><span class="hs-identifier hs-var">rn_group</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-229"></a><span>   </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;finish Dus&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272045"><span class="hs-identifier hs-var">src_dus</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-230"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272046"><span class="hs-identifier hs-var">final_tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272041"><span class="hs-identifier hs-var">rn_group</span></a><span class="hs-special">)</span><span>
</span><a name="line-231"></a><span>                    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-232"></a><span class="hs-identifier">rnSrcDecls</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsGroup</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnSrcDecls&quot;</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">addTcgDUs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DefUses</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- This function could be defined lower down in the module hierarchy,</span><span>
</span><a name="line-236"></a><span class="hs-comment">-- but there doesn't seem anywhere very logical to put it.</span><span>
</span><a name="line-237"></a><a name="addTcgDUs"><a href="RnSource.html#addTcgDUs"><span class="hs-identifier">addTcgDUs</span></a></a><span> </span><a name="local-6989586621682272048"><a href="#local-6989586621682272048"><span class="hs-identifier">tcg_env</span></a></a><span> </span><a name="local-6989586621682272049"><a href="#local-6989586621682272049"><span class="hs-identifier">dus</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272048"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_dus</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_dus</span><span> </span><a href="#local-6989586621682272048"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusDU</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272049"><span class="hs-identifier hs-var">dus</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-identifier">rnList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271997"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271998"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><a href="#local-6989586621682271997"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><a href="#local-6989586621682271998"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><a name="rnList"><a href="RnSource.html#rnList"><span class="hs-identifier">rnList</span></a></a><span> </span><a name="local-6989586621682272050"><a href="#local-6989586621682272050"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682272051"><a href="#local-6989586621682272051"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#mapFvRn"><span class="hs-identifier hs-var">mapFvRn</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span> </span><a href="#local-6989586621682272050"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272051"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-comment">{-
*********************************************************
*                                                       *
        HsDoc stuff
*                                                       *
*********************************************************
-}</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-identifier">rnDocDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DocDecl</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">DocDecl</span><span>
</span><a name="line-251"></a><a name="rnDocDecl"><a href="RnSource.html#rnDocDecl"><span class="hs-identifier">rnDocDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocCommentNext</span><span> </span><a name="local-6989586621682272052"><a href="#local-6989586621682272052"><span class="hs-identifier">doc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-252"></a><span>  </span><a name="local-6989586621682272053"><a href="#local-6989586621682272053"><span class="hs-identifier">rn_doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnHsDoc.html#rnHsDoc"><span class="hs-identifier hs-var">rnHsDoc</span></a><span> </span><a href="#local-6989586621682272052"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-253"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocCommentNext</span><span> </span><a href="#local-6989586621682272053"><span class="hs-identifier hs-var">rn_doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span class="hs-identifier">rnDocDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocCommentPrev</span><span> </span><a name="local-6989586621682272054"><a href="#local-6989586621682272054"><span class="hs-identifier">doc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-255"></a><span>  </span><a name="local-6989586621682272055"><a href="#local-6989586621682272055"><span class="hs-identifier">rn_doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnHsDoc.html#rnHsDoc"><span class="hs-identifier hs-var">rnHsDoc</span></a><span> </span><a href="#local-6989586621682272054"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocCommentPrev</span><span> </span><a href="#local-6989586621682272055"><span class="hs-identifier hs-var">rn_doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span class="hs-identifier">rnDocDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocCommentNamed</span><span> </span><a name="local-6989586621682272056"><a href="#local-6989586621682272056"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621682272057"><a href="#local-6989586621682272057"><span class="hs-identifier">doc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-258"></a><span>  </span><a name="local-6989586621682272058"><a href="#local-6989586621682272058"><span class="hs-identifier">rn_doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnHsDoc.html#rnHsDoc"><span class="hs-identifier hs-var">rnHsDoc</span></a><span> </span><a href="#local-6989586621682272057"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-259"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocCommentNamed</span><span> </span><a href="#local-6989586621682272056"><span class="hs-identifier hs-var">str</span></a><span> </span><a href="#local-6989586621682272058"><span class="hs-identifier hs-var">rn_doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span class="hs-identifier">rnDocDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocGroup</span><span> </span><a name="local-6989586621682272059"><a href="#local-6989586621682272059"><span class="hs-identifier">lev</span></a></a><span> </span><a name="local-6989586621682272060"><a href="#local-6989586621682272060"><span class="hs-identifier">doc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-261"></a><span>  </span><a name="local-6989586621682272061"><a href="#local-6989586621682272061"><span class="hs-identifier">rn_doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnHsDoc.html#rnHsDoc"><span class="hs-identifier hs-var">rnHsDoc</span></a><span> </span><a href="#local-6989586621682272060"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-262"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocGroup</span><span> </span><a href="#local-6989586621682272059"><span class="hs-identifier hs-var">lev</span></a><span> </span><a href="#local-6989586621682272061"><span class="hs-identifier hs-var">rn_doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-comment">{-
*********************************************************
*                                                       *
        Source-code deprecations declarations
*                                                       *
*********************************************************

Check that the deprecated names are defined, are defined locally, and
that there are no duplicate deprecations.

It's only imported deprecations, dealt with in RnIfaces, that we
gather them together.
-}</span><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-comment">-- checks that the deprecations are defined locally, and that there are no duplicates</span><span>
</span><a name="line-279"></a><span class="hs-identifier">rnSrcWarnDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LWarnDecls</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">Warnings</span><span>
</span><a name="line-280"></a><a name="rnSrcWarnDecls"><a href="RnSource.html#rnSrcWarnDecls"><span class="hs-identifier">rnSrcWarnDecls</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">NoWarnings</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-identifier">rnSrcWarnDecls</span><span> </span><a name="local-6989586621682272062"><a href="#local-6989586621682272062"><span class="hs-identifier">bndr_set</span></a></a><span> </span><a name="local-6989586621682272063"><a href="#local-6989586621682272063"><span class="hs-identifier">decls'</span></a></a><span>
</span><a name="line-284"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- check for duplicates</span><span>
</span><a name="line-285"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272074"><a href="#local-6989586621682272074"><span class="hs-identifier">dups</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272075"><a href="#local-6989586621682272075"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272076"><a href="#local-6989586621682272076"><span class="hs-identifier">rdr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">:|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272077"><a href="#local-6989586621682272077"><span class="hs-identifier">lrdr'</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272074"><span class="hs-identifier hs-var">dups</span></a><span>
</span><a name="line-286"></a><span>                          </span><span class="hs-keyword">in</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621682272075"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#dupWarnDecl"><span class="hs-identifier hs-var">dupWarnDecl</span></a><span> </span><a href="#local-6989586621682272077"><span class="hs-identifier hs-var">lrdr'</span></a><span> </span><a href="#local-6989586621682272076"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>               </span><a href="#local-6989586621682272068"><span class="hs-identifier hs-var">warn_rdr_dups</span></a><span>
</span><a name="line-288"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272078"><a href="#local-6989586621682272078"><span class="hs-identifier">pairs_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="#local-6989586621682272066"><span class="hs-identifier hs-var">rn_deprec</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272064"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-289"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WarnSome</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621682272078"><span class="hs-identifier hs-var">pairs_s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-290"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-291"></a><span>   </span><a name="local-6989586621682272064"><a href="#local-6989586621682272064"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">wd_warnings</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272063"><span class="hs-identifier hs-var">decls'</span></a><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span>   </span><a name="local-6989586621682272065"><a href="#local-6989586621682272065"><span class="hs-identifier">sig_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnEnv.html#TopSigCtxt"><span class="hs-identifier hs-var">TopSigCtxt</span></a><span> </span><a href="#local-6989586621682272062"><span class="hs-identifier hs-var">bndr_set</span></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span>   </span><a name="local-6989586621682272066"><a href="#local-6989586621682272066"><span class="hs-identifier">rn_deprec</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Warning</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272069"><a href="#local-6989586621682272069"><span class="hs-identifier">rdr_names</span></a></a><span> </span><a name="local-6989586621682272070"><a href="#local-6989586621682272070"><span class="hs-identifier">txt</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>       </span><span class="hs-comment">-- ensures that the names are defined locally</span><span>
</span><a name="line-297"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272071"><a href="#local-6989586621682272071"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">concatMapM</span><span> </span><span class="hs-special">(</span><a href="RnEnv.html#lookupLocalTcNames"><span class="hs-identifier hs-var">lookupLocalTcNames</span></a><span> </span><a href="#local-6989586621682272065"><span class="hs-identifier hs-var">sig_ctxt</span></a><span> </span><a href="#local-6989586621682272067"><span class="hs-identifier hs-var">what</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>                                </span><a href="#local-6989586621682272069"><span class="hs-identifier hs-var">rdr_names</span></a><span>
</span><a name="line-299"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><a href="#local-6989586621682272072"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272070"><span class="hs-identifier hs-var">txt</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272072"><a href="#local-6989586621682272072"><span class="hs-identifier">rdr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272071"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-300"></a><span>   </span><span class="hs-identifier">rn_deprec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XWarnDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnSrcWarnDecls&quot;</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>   </span><a name="local-6989586621682272067"><a href="#local-6989586621682272067"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;deprecation&quot;</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>   </span><a name="local-6989586621682272068"><a href="#local-6989586621682272068"><span class="hs-identifier">warn_rdr_dups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#findDupRdrNames"><span class="hs-identifier hs-var">findDupRdrNames</span></a><span>
</span><a name="line-305"></a><span>                   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Warning</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272073"><a href="#local-6989586621682272073"><span class="hs-identifier">ns</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272073"><span class="hs-identifier hs-var">ns</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272064"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-identifier">findDupRdrNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-308"></a><a name="findDupRdrNames"><a href="RnSource.html#findDupRdrNames"><span class="hs-identifier">findDupRdrNames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">findDupsEq</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272079"><a href="#local-6989586621682272079"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272080"><a href="#local-6989586621682272080"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272079"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272080"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-comment">-- look for duplicates among the OccNames;</span><span>
</span><a name="line-311"></a><span class="hs-comment">-- we check that the names are defined above</span><span>
</span><a name="line-312"></a><span class="hs-comment">-- invt: the lists returned by findDupsEq always have at least two elements</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-identifier">dupWarnDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-315"></a><span class="hs-comment">-- Located RdrName -&gt; DeprecDecl RdrName -&gt; SDoc</span><span>
</span><a name="line-316"></a><a name="dupWarnDecl"><a href="RnSource.html#dupWarnDecl"><span class="hs-identifier">dupWarnDecl</span></a></a><span> </span><a name="local-6989586621682272081"><a href="#local-6989586621682272081"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621682272082"><a href="#local-6989586621682272082"><span class="hs-identifier">rdr_name</span></a></a><span>
</span><a name="line-317"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Multiple warning declarations for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272082"><span class="hs-identifier hs-var">rdr_name</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-318"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;also at &quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621682272081"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Annotation declarations}
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-identifier">rnAnnDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AnnDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-329"></a><a name="rnAnnDecl"><a href="RnSource.html#rnAnnDecl"><span class="hs-identifier">rnAnnDecl</span></a></a><span> </span><a name="local-6989586621682272083"><a href="#local-6989586621682272083"><span class="hs-identifier">ann</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAnnotation</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272084"><a href="#local-6989586621682272084"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621682272085"><a href="#local-6989586621682272085"><span class="hs-identifier">provenance</span></a></a><span> </span><a name="local-6989586621682272086"><a href="#local-6989586621682272086"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcAnnotations.html#annCtxt"><span class="hs-identifier hs-var">annCtxt</span></a><span> </span><a href="#local-6989586621682272083"><span class="hs-identifier hs-var">ann</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-331"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272087"><a href="#local-6989586621682272087"><span class="hs-identifier">provenance'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272088"><a href="#local-6989586621682272088"><span class="hs-identifier">provenance_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnAnnProvenance"><span class="hs-identifier hs-var">rnAnnProvenance</span></a><span> </span><a href="#local-6989586621682272085"><span class="hs-identifier hs-var">provenance</span></a><span>
</span><a name="line-332"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272089"><a href="#local-6989586621682272089"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272090"><a href="#local-6989586621682272090"><span class="hs-identifier">expr_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Splice</span><span> </span><span class="hs-identifier hs-var">Untyped</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-333"></a><span>                              </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682272086"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-334"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAnnotation</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682272084"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621682272087"><span class="hs-identifier hs-var">provenance'</span></a><span> </span><a href="#local-6989586621682272089"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">,</span><span>
</span><a name="line-335"></a><span>                 </span><a href="#local-6989586621682272088"><span class="hs-identifier hs-var">provenance_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272090"><span class="hs-identifier hs-var">expr_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-336"></a><span class="hs-identifier">rnAnnDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XAnnDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnAnnDecl&quot;</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-identifier">rnAnnProvenance</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AnnProvenance</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-339"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AnnProvenance</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-340"></a><a name="rnAnnProvenance"><a href="RnSource.html#rnAnnProvenance"><span class="hs-identifier">rnAnnProvenance</span></a></a><span> </span><a name="local-6989586621682272091"><a href="#local-6989586621682272091"><span class="hs-identifier">provenance</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-341"></a><span>    </span><a name="local-6989586621682272092"><a href="#local-6989586621682272092"><span class="hs-identifier">provenance'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="RnEnv.html#lookupTopBndrRn"><span class="hs-identifier hs-var">lookupTopBndrRn</span></a><span> </span><a href="#local-6989586621682272091"><span class="hs-identifier hs-var">provenance</span></a><span>
</span><a name="line-342"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272092"><span class="hs-identifier hs-var">provenance'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">annProvenanceName_maybe</span><span> </span><a href="#local-6989586621682272092"><span class="hs-identifier hs-var">provenance'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Default declarations}
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span class="hs-identifier">rnDefaultDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DefaultDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DefaultDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-353"></a><a name="rnDefaultDecl"><a href="RnSource.html#rnDefaultDecl"><span class="hs-identifier">rnDefaultDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DefaultDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272093"><a href="#local-6989586621682272093"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272095"><a href="#local-6989586621682272095"><span class="hs-identifier">tys'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272096"><a href="#local-6989586621682272096"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsTypes"><span class="hs-identifier hs-var">rnLHsTypes</span></a><span> </span><a href="#local-6989586621682272094"><span class="hs-identifier hs-var">doc_str</span></a><span> </span><a href="#local-6989586621682272093"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-355"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DefaultDecl</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682272095"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272096"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-357"></a><span>    </span><a name="local-6989586621682272094"><a href="#local-6989586621682272094"><span class="hs-identifier">doc_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#DefaultDeclCtx"><span class="hs-identifier hs-var">DefaultDeclCtx</span></a><span>
</span><a name="line-358"></a><span class="hs-identifier">rnDefaultDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XDefaultDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnDefaultDecl&quot;</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Foreign declarations}
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span class="hs-identifier">rnHsForeignDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ForeignDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-369"></a><a name="rnHsForeignDecl"><a href="RnSource.html#rnHsForeignDecl"><span class="hs-identifier">rnHsForeignDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForeignImport</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272097"><a href="#local-6989586621682272097"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_sig_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272098"><a href="#local-6989586621682272098"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_fi</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272099"><a href="#local-6989586621682272099"><span class="hs-identifier">spec</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272100"><a href="#local-6989586621682272100"><span class="hs-identifier">topEnv</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span>
</span><a name="line-371"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272101"><a href="#local-6989586621682272101"><span class="hs-identifier">name'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocatedTopBndrRn"><span class="hs-identifier hs-var">lookupLocatedTopBndrRn</span></a><span> </span><a href="#local-6989586621682272097"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-372"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272102"><a href="#local-6989586621682272102"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272103"><a href="#local-6989586621682272103"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnHsSigType"><span class="hs-identifier hs-var">rnHsSigType</span></a><span> </span><span class="hs-special">(</span><a href="RnUtils.html#ForeignDeclCtx"><span class="hs-identifier hs-var">ForeignDeclCtx</span></a><span> </span><a href="#local-6989586621682272097"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272098"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span>        </span><span class="hs-comment">-- Mark any PackageTarget style imports as coming from the current package</span><span>
</span><a name="line-375"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272104"><a href="#local-6989586621682272104"><span class="hs-identifier">unitId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682272100"><span class="hs-identifier hs-var">topEnv</span></a><span>
</span><a name="line-376"></a><span>             </span><a name="local-6989586621682272105"><a href="#local-6989586621682272105"><span class="hs-identifier">spec'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#patchForeignImport"><span class="hs-identifier hs-var">patchForeignImport</span></a><span> </span><a href="#local-6989586621682272104"><span class="hs-identifier hs-var">unitId</span></a><span> </span><a href="#local-6989586621682272099"><span class="hs-identifier hs-var">spec</span></a><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForeignImport</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fd_i_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-379"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272101"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_sig_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272102"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-380"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_fi</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272105"><span class="hs-identifier hs-var">spec'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272103"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span class="hs-identifier">rnHsForeignDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForeignExport</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272106"><a href="#local-6989586621682272106"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_sig_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272107"><a href="#local-6989586621682272107"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_fe</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272108"><a href="#local-6989586621682272108"><span class="hs-identifier">spec</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272109"><a href="#local-6989586621682272109"><span class="hs-identifier">name'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocatedOccRn"><span class="hs-identifier hs-var">lookupLocatedOccRn</span></a><span> </span><a href="#local-6989586621682272106"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-384"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272110"><a href="#local-6989586621682272110"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272111"><a href="#local-6989586621682272111"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnHsSigType"><span class="hs-identifier hs-var">rnHsSigType</span></a><span> </span><span class="hs-special">(</span><a href="RnUtils.html#ForeignDeclCtx"><span class="hs-identifier hs-var">ForeignDeclCtx</span></a><span> </span><a href="#local-6989586621682272106"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272107"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-385"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForeignExport</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fd_e_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-386"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272109"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_sig_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272110"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-387"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fd_fe</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272108"><span class="hs-identifier hs-var">spec</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-388"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272111"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addOneFV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272109"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-389"></a><span>        </span><span class="hs-comment">-- NB: a foreign export is an *occurrence site* for name, so</span><span>
</span><a name="line-390"></a><span>        </span><span class="hs-comment">--     we add it to the free-variable list.  It might, for example,</span><span>
</span><a name="line-391"></a><span>        </span><span class="hs-comment">--     be imported from another module</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span class="hs-identifier">rnHsForeignDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XForeignDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnHsForeignDecl&quot;</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-comment">-- | For Windows DLLs we need to know what packages imported symbols are from</span><span>
</span><a name="line-396"></a><span class="hs-comment">--      to generate correct calls. Imported symbols are tagged with the current</span><span>
</span><a name="line-397"></a><span class="hs-comment">--      package, so if they get inlined across a package boundary we'll still</span><span>
</span><a name="line-398"></a><span class="hs-comment">--      know where they're from.</span><span>
</span><a name="line-399"></a><span class="hs-comment">--</span><span>
</span><a name="line-400"></a><span class="hs-identifier">patchForeignImport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignImport</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignImport</span><span>
</span><a name="line-401"></a><a name="patchForeignImport"><a href="RnSource.html#patchForeignImport"><span class="hs-identifier">patchForeignImport</span></a></a><span> </span><a name="local-6989586621682272112"><a href="#local-6989586621682272112"><span class="hs-identifier">unitId</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CImport</span><span> </span><a name="local-6989586621682272113"><a href="#local-6989586621682272113"><span class="hs-identifier">cconv</span></a></a><span> </span><a name="local-6989586621682272114"><a href="#local-6989586621682272114"><span class="hs-identifier">safety</span></a></a><span> </span><a name="local-6989586621682272115"><a href="#local-6989586621682272115"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-6989586621682272116"><a href="#local-6989586621682272116"><span class="hs-identifier">spec</span></a></a><span> </span><a name="local-6989586621682272117"><a href="#local-6989586621682272117"><span class="hs-identifier">src</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CImport</span><span> </span><a href="#local-6989586621682272113"><span class="hs-identifier hs-var">cconv</span></a><span> </span><a href="#local-6989586621682272114"><span class="hs-identifier hs-var">safety</span></a><span> </span><a href="#local-6989586621682272115"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#patchCImportSpec"><span class="hs-identifier hs-var">patchCImportSpec</span></a><span> </span><a href="#local-6989586621682272112"><span class="hs-identifier hs-var">unitId</span></a><span> </span><a href="#local-6989586621682272116"><span class="hs-identifier hs-var">spec</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272117"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-identifier">patchCImportSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CImportSpec</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CImportSpec</span><span>
</span><a name="line-405"></a><a name="patchCImportSpec"><a href="RnSource.html#patchCImportSpec"><span class="hs-identifier">patchCImportSpec</span></a></a><span> </span><a name="local-6989586621682272118"><a href="#local-6989586621682272118"><span class="hs-identifier">unitId</span></a></a><span> </span><a name="local-6989586621682272119"><a href="#local-6989586621682272119"><span class="hs-identifier">spec</span></a></a><span>
</span><a name="line-406"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272119"><span class="hs-identifier hs-var">spec</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-407"></a><span>        </span><span class="hs-identifier hs-var">CFunction</span><span> </span><a name="local-6989586621682272120"><a href="#local-6989586621682272120"><span class="hs-identifier">callTarget</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">CFunction</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnSource.html#patchCCallTarget"><span class="hs-identifier hs-var">patchCCallTarget</span></a><span> </span><a href="#local-6989586621682272118"><span class="hs-identifier hs-var">unitId</span></a><span> </span><a href="#local-6989586621682272120"><span class="hs-identifier hs-var">callTarget</span></a><span>
</span><a name="line-408"></a><span>        </span><span class="hs-identifier">_</span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272119"><span class="hs-identifier hs-var">spec</span></a><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-identifier">patchCCallTarget</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CCallTarget</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CCallTarget</span><span>
</span><a name="line-411"></a><a name="patchCCallTarget"><a href="RnSource.html#patchCCallTarget"><span class="hs-identifier">patchCCallTarget</span></a></a><span> </span><a name="local-6989586621682272121"><a href="#local-6989586621682272121"><span class="hs-identifier">unitId</span></a></a><span> </span><a name="local-6989586621682272122"><a href="#local-6989586621682272122"><span class="hs-identifier">callTarget</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-412"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272122"><span class="hs-identifier hs-var">callTarget</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-413"></a><span>  </span><span class="hs-identifier hs-var">StaticTarget</span><span> </span><a name="local-6989586621682272123"><a href="#local-6989586621682272123"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621682272125"><a href="#local-6989586621682272125"><span class="hs-identifier">isFun</span></a></a><span>
</span><a name="line-414"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">StaticTarget</span><span> </span><a href="#local-6989586621682272123"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272121"><span class="hs-identifier hs-var">unitId</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272125"><span class="hs-identifier hs-var">isFun</span></a><span>
</span><a name="line-415"></a><span>  </span><span class="hs-identifier">_</span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272122"><span class="hs-identifier hs-var">callTarget</span></a><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Instance declarations}
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span class="hs-identifier">rnSrcInstDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InstDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">InstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-426"></a><a name="rnSrcInstDecl"><a href="RnSource.html#rnSrcInstDecl"><span class="hs-identifier">rnSrcInstDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyFamInstD</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tfid_inst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272126"><a href="#local-6989586621682272126"><span class="hs-identifier">tfi</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-427"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272127"><a href="#local-6989586621682272127"><span class="hs-identifier">tfi'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272128"><a href="#local-6989586621682272128"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnTyFamInstDecl"><span class="hs-identifier hs-var">rnTyFamInstDecl</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272126"><span class="hs-identifier hs-var">tfi</span></a><span>
</span><a name="line-428"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyFamInstD</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tfid_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tfid_inst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272127"><span class="hs-identifier hs-var">tfi'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272128"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-identifier">rnSrcInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstD</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_inst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272129"><a href="#local-6989586621682272129"><span class="hs-identifier">dfi</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272130"><a href="#local-6989586621682272130"><span class="hs-identifier">dfi'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272131"><a href="#local-6989586621682272131"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnDataFamInstDecl"><span class="hs-identifier hs-var">rnDataFamInstDecl</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272129"><span class="hs-identifier hs-var">dfi</span></a><span>
</span><a name="line-432"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstD</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dfid_inst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272130"><span class="hs-identifier hs-var">dfi'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272131"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-identifier">rnSrcInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstD</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cid_inst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272132"><a href="#local-6989586621682272132"><span class="hs-identifier">cid</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnSrcIstDecl {&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272132"><span class="hs-identifier hs-var">cid</span></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272133"><a href="#local-6989586621682272133"><span class="hs-identifier">cid'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272134"><a href="#local-6989586621682272134"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnClsInstDecl"><span class="hs-identifier hs-var">rnClsInstDecl</span></a><span> </span><a href="#local-6989586621682272132"><span class="hs-identifier hs-var">cid</span></a><span>
</span><a name="line-437"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnSrcIstDecl end }&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-438"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstD</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cid_d_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_inst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272133"><span class="hs-identifier hs-var">cid'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272134"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span class="hs-identifier">rnSrcInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XInstDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnSrcInstDecl&quot;</span><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span class="hs-comment">-- | Warn about non-canonical typeclass instance declarations</span><span>
</span><a name="line-443"></a><span class="hs-comment">--</span><span>
</span><a name="line-444"></a><span class="hs-comment">-- A &quot;non-canonical&quot; instance definition can occur for instances of a</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- class which redundantly defines an operation its superclass</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- provides as well (c.f. `return`/`pure`). In such cases, a canonical</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- instance is one where the subclass inherits its method</span><span>
</span><a name="line-448"></a><span class="hs-comment">-- implementation from its superclass instance (usually the subclass</span><span>
</span><a name="line-449"></a><span class="hs-comment">-- has a default method implementation to that effect). Consequently,</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- a non-canonical instance occurs when this is not the case.</span><span>
</span><a name="line-451"></a><span class="hs-comment">--</span><span>
</span><a name="line-452"></a><span class="hs-comment">-- See also descriptions of 'checkCanonicalMonadInstances' and</span><span>
</span><a name="line-453"></a><span class="hs-comment">-- 'checkCanonicalMonoidInstances'</span><span>
</span><a name="line-454"></a><span class="hs-identifier">checkCanonicalInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><a name="checkCanonicalInstances"><a href="RnSource.html#checkCanonicalInstances"><span class="hs-identifier">checkCanonicalInstances</span></a></a><span> </span><a name="local-6989586621682272135"><a href="#local-6989586621682272135"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682272136"><a href="#local-6989586621682272136"><span class="hs-identifier">poly_ty</span></a></a><span> </span><a name="local-6989586621682272137"><a href="#local-6989586621682272137"><span class="hs-identifier">mbinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-456"></a><span>    </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnNonCanonicalMonadInstances</span><span>
</span><a name="line-457"></a><span>        </span><a href="#local-6989586621682272138"><span class="hs-identifier hs-var">checkCanonicalMonadInstances</span></a><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span>    </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnNonCanonicalMonoidInstances</span><span>
</span><a name="line-460"></a><span>        </span><a href="#local-6989586621682272139"><span class="hs-identifier hs-var">checkCanonicalMonoidInstances</span></a><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-463"></a><span>    </span><span class="hs-comment">-- | Warn about unsound/non-canonical 'Applicative'/'Monad' instance</span><span>
</span><a name="line-464"></a><span>    </span><span class="hs-comment">-- declarations. Specifically, the following conditions are verified:</span><span>
</span><a name="line-465"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-466"></a><span>    </span><span class="hs-comment">-- In 'Monad' instances declarations:</span><span>
</span><a name="line-467"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-468"></a><span>    </span><span class="hs-comment">--  * If 'return' is overridden it must be canonical (i.e. @return = pure@)</span><span>
</span><a name="line-469"></a><span>    </span><span class="hs-comment">--  * If '(&gt;&gt;)' is overridden it must be canonical (i.e. @(&gt;&gt;) = (*&gt;)@)</span><span>
</span><a name="line-470"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-471"></a><span>    </span><span class="hs-comment">-- In 'Applicative' instance declarations:</span><span>
</span><a name="line-472"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-473"></a><span>    </span><span class="hs-comment">--  * Warn if 'pure' is defined backwards (i.e. @pure = return@).</span><span>
</span><a name="line-474"></a><span>    </span><span class="hs-comment">--  * Warn if '(*&gt;)' is defined backwards (i.e. @(*&gt;) = (&gt;&gt;)@).</span><span>
</span><a name="line-475"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-476"></a><span>    </span><a name="local-6989586621682272138"><a href="#local-6989586621682272138"><span class="hs-identifier">checkCanonicalMonadInstances</span></a></a><span>
</span><a name="line-477"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272135"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">applicativeClassName</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-478"></a><span>          </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621682272137"><span class="hs-identifier hs-var">mbinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272146"><a href="#local-6989586621682272146"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272147"><a href="#local-6989586621682272147"><span class="hs-identifier">mbind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682272146"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-479"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272147"><span class="hs-identifier hs-var">mbind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-480"></a><span>                  </span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272148"><a href="#local-6989586621682272148"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-481"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272149"><a href="#local-6989586621682272149"><span class="hs-identifier">mg</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-482"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272148"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">pureAName</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272140"><span class="hs-identifier hs-var">isAliasMG</span></a><span> </span><a href="#local-6989586621682272149"><span class="hs-identifier hs-var">mg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">returnMName</span><span>
</span><a name="line-483"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272141"><span class="hs-identifier hs-var">addWarnNonCanonicalMethod1</span></a><span>
</span><a name="line-484"></a><span>                            </span><span class="hs-identifier hs-var">Opt_WarnNonCanonicalMonadInstances</span><span> </span><span class="hs-string">&quot;pure&quot;</span><span> </span><span class="hs-string">&quot;return&quot;</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272148"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">thenAName</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272140"><span class="hs-identifier hs-var">isAliasMG</span></a><span> </span><a href="#local-6989586621682272149"><span class="hs-identifier hs-var">mg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">thenMName</span><span>
</span><a name="line-487"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272141"><span class="hs-identifier hs-var">addWarnNonCanonicalMethod1</span></a><span>
</span><a name="line-488"></a><span>                            </span><span class="hs-identifier hs-var">Opt_WarnNonCanonicalMonadInstances</span><span> </span><span class="hs-string">&quot;(*&gt;)&quot;</span><span> </span><span class="hs-string">&quot;(&gt;&gt;)&quot;</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272135"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">monadClassName</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-493"></a><span>          </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621682272137"><span class="hs-identifier hs-var">mbinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272150"><a href="#local-6989586621682272150"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272151"><a href="#local-6989586621682272151"><span class="hs-identifier">mbind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682272150"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-494"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272151"><span class="hs-identifier hs-var">mbind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-495"></a><span>                  </span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272152"><a href="#local-6989586621682272152"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272153"><a href="#local-6989586621682272153"><span class="hs-identifier">mg</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-497"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272152"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">returnMName</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272140"><span class="hs-identifier hs-var">isAliasMG</span></a><span> </span><a href="#local-6989586621682272153"><span class="hs-identifier hs-var">mg</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">pureAName</span><span>
</span><a name="line-498"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272142"><span class="hs-identifier hs-var">addWarnNonCanonicalMethod2</span></a><span>
</span><a name="line-499"></a><span>                            </span><span class="hs-identifier hs-var">Opt_WarnNonCanonicalMonadInstances</span><span> </span><span class="hs-string">&quot;return&quot;</span><span> </span><span class="hs-string">&quot;pure&quot;</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272152"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">thenMName</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272140"><span class="hs-identifier hs-var">isAliasMG</span></a><span> </span><a href="#local-6989586621682272153"><span class="hs-identifier hs-var">mg</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">thenAName</span><span>
</span><a name="line-502"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272142"><span class="hs-identifier hs-var">addWarnNonCanonicalMethod2</span></a><span>
</span><a name="line-503"></a><span>                            </span><span class="hs-identifier hs-var">Opt_WarnNonCanonicalMonadInstances</span><span> </span><span class="hs-string">&quot;(&gt;&gt;)&quot;</span><span> </span><span class="hs-string">&quot;(*&gt;)&quot;</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>
</span><a name="line-509"></a><span>    </span><span class="hs-comment">-- | Check whether Monoid(mappend) is defined in terms of</span><span>
</span><a name="line-510"></a><span>    </span><span class="hs-comment">-- Semigroup((&lt;&gt;)) (and not the other way round). Specifically,</span><span>
</span><a name="line-511"></a><span>    </span><span class="hs-comment">-- the following conditions are verified:</span><span>
</span><a name="line-512"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-513"></a><span>    </span><span class="hs-comment">-- In 'Monoid' instances declarations:</span><span>
</span><a name="line-514"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-515"></a><span>    </span><span class="hs-comment">--  * If 'mappend' is overridden it must be canonical</span><span>
</span><a name="line-516"></a><span>    </span><span class="hs-comment">--    (i.e. @mappend = (&lt;&gt;)@)</span><span>
</span><a name="line-517"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-518"></a><span>    </span><span class="hs-comment">-- In 'Semigroup' instance declarations:</span><span>
</span><a name="line-519"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-520"></a><span>    </span><span class="hs-comment">--  * Warn if '(&lt;&gt;)' is defined backwards (i.e. @(&lt;&gt;) = mappend@).</span><span>
</span><a name="line-521"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-522"></a><span>    </span><a name="local-6989586621682272139"><a href="#local-6989586621682272139"><span class="hs-identifier">checkCanonicalMonoidInstances</span></a></a><span>
</span><a name="line-523"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272135"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">semigroupClassName</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-524"></a><span>          </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621682272137"><span class="hs-identifier hs-var">mbinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272154"><a href="#local-6989586621682272154"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272155"><a href="#local-6989586621682272155"><span class="hs-identifier">mbind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682272154"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-525"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272155"><span class="hs-identifier hs-var">mbind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-526"></a><span>                  </span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272156"><a href="#local-6989586621682272156"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-527"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272157"><a href="#local-6989586621682272157"><span class="hs-identifier">mg</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-528"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272156"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">sappendName</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272140"><span class="hs-identifier hs-var">isAliasMG</span></a><span> </span><a href="#local-6989586621682272157"><span class="hs-identifier hs-var">mg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">mappendName</span><span>
</span><a name="line-529"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272141"><span class="hs-identifier hs-var">addWarnNonCanonicalMethod1</span></a><span>
</span><a name="line-530"></a><span>                            </span><span class="hs-identifier hs-var">Opt_WarnNonCanonicalMonoidInstances</span><span> </span><span class="hs-string">&quot;(&lt;&gt;)&quot;</span><span> </span><span class="hs-string">&quot;mappend&quot;</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272135"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">monoidClassName</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-535"></a><span>          </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621682272137"><span class="hs-identifier hs-var">mbinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272158"><a href="#local-6989586621682272158"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272159"><a href="#local-6989586621682272159"><span class="hs-identifier">mbind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682272158"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-536"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272159"><span class="hs-identifier hs-var">mbind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-537"></a><span>                  </span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272160"><a href="#local-6989586621682272160"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272161"><a href="#local-6989586621682272161"><span class="hs-identifier">mg</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-539"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272160"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mappendName</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272140"><span class="hs-identifier hs-var">isAliasMG</span></a><span> </span><a href="#local-6989586621682272161"><span class="hs-identifier hs-var">mg</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">sappendName</span><span>
</span><a name="line-540"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272143"><span class="hs-identifier hs-var">addWarnNonCanonicalMethod2NoDefault</span></a><span>
</span><a name="line-541"></a><span>                            </span><span class="hs-identifier hs-var">Opt_WarnNonCanonicalMonoidInstances</span><span> </span><span class="hs-string">&quot;mappend&quot;</span><span> </span><span class="hs-string">&quot;(&lt;&gt;)&quot;</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span>    </span><span class="hs-comment">-- | test whether MatchGroup represents a trivial \&quot;lhsName = rhsName\&quot;</span><span>
</span><a name="line-548"></a><span>    </span><span class="hs-comment">-- binding, and return @Just rhsName@ if this is the case</span><span>
</span><a name="line-549"></a><span>    </span><span class="hs-identifier">isAliasMG</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MatchGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-550"></a><span>    </span><a name="local-6989586621682272140"><a href="#local-6989586621682272140"><span class="hs-identifier">isAliasMG</span></a></a><span> </span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-551"></a><span>                             </span><span class="hs-special">[</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Match</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">m_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-552"></a><span>                                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">m_grhss</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272162"><a href="#local-6989586621682272162"><span class="hs-identifier">grhss</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-553"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">GRHSs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRHS</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682272163"><a href="#local-6989586621682272163"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682272164"><a href="#local-6989586621682272164"><span class="hs-identifier">lbinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272162"><span class="hs-identifier hs-var">grhss</span></a><span>
</span><a name="line-554"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">EmptyLocalBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272164"><span class="hs-identifier hs-var">lbinds</span></a><span>
</span><a name="line-555"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272165"><a href="#local-6989586621682272165"><span class="hs-identifier">lrhsName</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272163"><span class="hs-identifier hs-var">body</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272165"><span class="hs-identifier hs-var">lrhsName</span></a><span class="hs-special">)</span><span>
</span><a name="line-556"></a><span>    </span><span class="hs-identifier">isAliasMG</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span>    </span><span class="hs-comment">-- got &quot;lhs = rhs&quot; but expected something different</span><span>
</span><a name="line-559"></a><span>    </span><a name="local-6989586621682272141"><a href="#local-6989586621682272141"><span class="hs-identifier">addWarnNonCanonicalMethod1</span></a></a><span> </span><a name="local-6989586621682272166"><a href="#local-6989586621682272166"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621682272167"><a href="#local-6989586621682272167"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621682272168"><a href="#local-6989586621682272168"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-560"></a><span>        </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621682272166"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-561"></a><span>                       </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Noncanonical&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-562"></a><span>                         </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272167"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; = &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272168"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-563"></a><span>                         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;definition detected&quot;</span><span>
</span><a name="line-564"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272144"><span class="hs-identifier hs-var">instDeclCtxt1</span></a><span> </span><a href="#local-6989586621682272136"><span class="hs-identifier hs-var">poly_ty</span></a><span>
</span><a name="line-565"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Move definition from&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-566"></a><span>                         </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682272168"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-567"></a><span>                         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682272167"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>                       </span><span class="hs-special">]</span><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span>    </span><span class="hs-comment">-- expected &quot;lhs = rhs&quot; but got something else</span><span>
</span><a name="line-571"></a><span>    </span><a name="local-6989586621682272142"><a href="#local-6989586621682272142"><span class="hs-identifier">addWarnNonCanonicalMethod2</span></a></a><span> </span><a name="local-6989586621682272169"><a href="#local-6989586621682272169"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621682272170"><a href="#local-6989586621682272170"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621682272171"><a href="#local-6989586621682272171"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-572"></a><span>        </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621682272169"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-573"></a><span>                       </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Noncanonical&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-574"></a><span>                         </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682272170"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-575"></a><span>                         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;definition detected&quot;</span><span>
</span><a name="line-576"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272144"><span class="hs-identifier hs-var">instDeclCtxt1</span></a><span> </span><a href="#local-6989586621682272136"><span class="hs-identifier hs-var">poly_ty</span></a><span>
</span><a name="line-577"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Either remove definition for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-578"></a><span>                         </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682272170"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;or define as&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-579"></a><span>                         </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272170"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; = &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272171"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>                       </span><span class="hs-special">]</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>    </span><span class="hs-comment">-- like above, but method has no default impl</span><span>
</span><a name="line-583"></a><span>    </span><a name="local-6989586621682272143"><a href="#local-6989586621682272143"><span class="hs-identifier">addWarnNonCanonicalMethod2NoDefault</span></a></a><span> </span><a name="local-6989586621682272172"><a href="#local-6989586621682272172"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621682272173"><a href="#local-6989586621682272173"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621682272174"><a href="#local-6989586621682272174"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-584"></a><span>        </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621682272172"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-585"></a><span>                       </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Noncanonical&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-586"></a><span>                         </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682272173"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-587"></a><span>                         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;definition detected&quot;</span><span>
</span><a name="line-588"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272144"><span class="hs-identifier hs-var">instDeclCtxt1</span></a><span> </span><a href="#local-6989586621682272136"><span class="hs-identifier hs-var">poly_ty</span></a><span>
</span><a name="line-589"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Define as&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-590"></a><span>                         </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272173"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; = &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272174"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span>                       </span><span class="hs-special">]</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span>    </span><span class="hs-comment">-- stolen from TcInstDcls</span><span>
</span><a name="line-594"></a><span>    </span><span class="hs-identifier">instDeclCtxt1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-595"></a><span>    </span><a name="local-6989586621682272144"><a href="#local-6989586621682272144"><span class="hs-identifier">instDeclCtxt1</span></a></a><span> </span><a name="local-6989586621682272175"><a href="#local-6989586621682272175"><span class="hs-identifier">hs_inst_ty</span></a></a><span>
</span><a name="line-596"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272145"><span class="hs-identifier hs-var">inst_decl_ctxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLHsInstDeclHead</span><span> </span><a href="#local-6989586621682272175"><span class="hs-identifier hs-var">hs_inst_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span>    </span><span class="hs-identifier">inst_decl_ctxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-599"></a><span>    </span><a name="local-6989586621682272145"><a href="#local-6989586621682272145"><span class="hs-identifier">inst_decl_ctxt</span></a></a><span> </span><a name="local-6989586621682272176"><a href="#local-6989586621682272176"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in the instance declaration for&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>                         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621682272176"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-identifier">rnClsInstDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClsInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ClsInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-604"></a><a name="rnClsInstDecl"><a href="RnSource.html#rnClsInstDecl"><span class="hs-identifier">rnClsInstDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cid_poly_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272177"><a href="#local-6989586621682272177"><span class="hs-identifier">inst_ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272178"><a href="#local-6989586621682272178"><span class="hs-identifier">mbinds</span></a></a><span>
</span><a name="line-605"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272179"><a href="#local-6989586621682272179"><span class="hs-identifier">uprags</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_tyfam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272180"><a href="#local-6989586621682272180"><span class="hs-identifier">ats</span></a></a><span>
</span><a name="line-606"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_overlap_mode</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272181"><a href="#local-6989586621682272181"><span class="hs-identifier">oflag</span></a></a><span>
</span><a name="line-607"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_datafam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272182"><a href="#local-6989586621682272182"><span class="hs-identifier">adts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-608"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272183"><a href="#local-6989586621682272183"><span class="hs-identifier">inst_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272184"><a href="#local-6989586621682272184"><span class="hs-identifier">inst_fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnHsSigType"><span class="hs-identifier hs-var">rnHsSigType</span></a><span> </span><span class="hs-special">(</span><a href="RnUtils.html#GenericCtx"><span class="hs-identifier hs-var">GenericCtx</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;an instance declaration&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272177"><span class="hs-identifier hs-var">inst_ty</span></a><span>
</span><a name="line-610"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272185"><a href="#local-6989586621682272185"><span class="hs-identifier">ktv_names</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272186"><a href="#local-6989586621682272186"><span class="hs-identifier">head_ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitLHsInstDeclTy</span><span> </span><a href="#local-6989586621682272183"><span class="hs-identifier hs-var">inst_ty'</span></a><span>
</span><a name="line-611"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272188"><a href="#local-6989586621682272188"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-612"></a><span>           </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">hsTyGetAppHead_maybe</span><span> </span><a href="#local-6989586621682272186"><span class="hs-identifier hs-var">head_ty'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-613"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272187"><a href="#local-6989586621682272187"><span class="hs-identifier">cls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621682272187"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-614"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-615"></a><span>               </span><span class="hs-comment">-- The instance is malformed. We'd still like</span><span>
</span><a name="line-616"></a><span>               </span><span class="hs-comment">-- to make *some* progress (rather than failing outright), so</span><span>
</span><a name="line-617"></a><span>               </span><span class="hs-comment">-- we report an error and continue for as long as we can.</span><span>
</span><a name="line-618"></a><span>               </span><span class="hs-comment">-- Importantly, this error should be thrown before we reach the</span><span>
</span><a name="line-619"></a><span>               </span><span class="hs-comment">-- typechecker, lest we encounter different errors that are</span><span>
</span><a name="line-620"></a><span>               </span><span class="hs-comment">-- hopelessly confusing (such as the one in Trac #16114).</span><span>
</span><a name="line-621"></a><span>               </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsSigType</span><span> </span><a href="#local-6989586621682272177"><span class="hs-identifier hs-var">inst_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-622"></a><span>                 </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal class instance:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272177"><span class="hs-identifier hs-var">inst_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>                    </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Class instances must be of the form&quot;</span><span>
</span><a name="line-624"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;context =&gt; C ty_1 ... ty_n&quot;</span><span>
</span><a name="line-625"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;where&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'C'</span><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>                              </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is a class&quot;</span><span>
</span><a name="line-627"></a><span>                            </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>               </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkUnboundName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcOccFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;&lt;class&gt;&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span>          </span><span class="hs-comment">-- Rename the bindings</span><span>
</span><a name="line-631"></a><span>          </span><span class="hs-comment">-- The typechecker (not the renamer) checks that all</span><span>
</span><a name="line-632"></a><span>          </span><span class="hs-comment">-- the bindings are for the right class</span><span>
</span><a name="line-633"></a><span>          </span><span class="hs-comment">-- (Slightly strangely) when scoped type variables are on, the</span><span>
</span><a name="line-634"></a><span>          </span><span class="hs-comment">-- forall-d tyvars scope over the method bindings too</span><span>
</span><a name="line-635"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272189"><a href="#local-6989586621682272189"><span class="hs-identifier">mbinds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272190"><a href="#local-6989586621682272190"><span class="hs-identifier">uprags'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272191"><a href="#local-6989586621682272191"><span class="hs-identifier">meth_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnMethodBinds"><span class="hs-identifier hs-var">rnMethodBinds</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682272188"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682272185"><span class="hs-identifier hs-var">ktv_names</span></a><span> </span><a href="#local-6989586621682272178"><span class="hs-identifier hs-var">mbinds</span></a><span> </span><a href="#local-6989586621682272179"><span class="hs-identifier hs-var">uprags</span></a><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnSource.html#checkCanonicalInstances"><span class="hs-identifier hs-var">checkCanonicalInstances</span></a><span> </span><a href="#local-6989586621682272188"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682272183"><span class="hs-identifier hs-var">inst_ty'</span></a><span> </span><a href="#local-6989586621682272189"><span class="hs-identifier hs-var">mbinds'</span></a><span>
</span><a name="line-638"></a><span>
</span><a name="line-639"></a><span>       </span><span class="hs-comment">-- Rename the associated types, and type signatures</span><span>
</span><a name="line-640"></a><span>       </span><span class="hs-comment">-- Both need to have the instance type variables in scope</span><span>
</span><a name="line-641"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnSrcInstDecl&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272183"><span class="hs-identifier hs-var">inst_ty'</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272185"><span class="hs-identifier hs-var">ktv_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682272196"><a href="#local-6989586621682272196"><span class="hs-identifier">ats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272197"><a href="#local-6989586621682272197"><span class="hs-identifier">adts'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272198"><a href="#local-6989586621682272198"><span class="hs-identifier">more_fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#extendTyVarEnvFVRn"><span class="hs-identifier hs-var">extendTyVarEnvFVRn</span></a><span> </span><a href="#local-6989586621682272185"><span class="hs-identifier hs-var">ktv_names</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-644"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272192"><a href="#local-6989586621682272192"><span class="hs-identifier">ats'</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621682272193"><a href="#local-6989586621682272193"><span class="hs-identifier">at_fvs</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnATInstDecls"><span class="hs-identifier hs-var">rnATInstDecls</span></a><span> </span><a href="RnSource.html#rnTyFamInstDecl"><span class="hs-identifier hs-var">rnTyFamInstDecl</span></a><span> </span><a href="#local-6989586621682272188"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682272185"><span class="hs-identifier hs-var">ktv_names</span></a><span> </span><a href="#local-6989586621682272180"><span class="hs-identifier hs-var">ats</span></a><span>
</span><a name="line-645"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272194"><a href="#local-6989586621682272194"><span class="hs-identifier">adts'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272195"><a href="#local-6989586621682272195"><span class="hs-identifier">adt_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnATInstDecls"><span class="hs-identifier hs-var">rnATInstDecls</span></a><span> </span><a href="RnSource.html#rnDataFamInstDecl"><span class="hs-identifier hs-var">rnDataFamInstDecl</span></a><span> </span><a href="#local-6989586621682272188"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682272185"><span class="hs-identifier hs-var">ktv_names</span></a><span> </span><a href="#local-6989586621682272182"><span class="hs-identifier hs-var">adts</span></a><span>
</span><a name="line-646"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272192"><span class="hs-identifier hs-var">ats'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272194"><span class="hs-identifier hs-var">adts'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272193"><span class="hs-identifier hs-var">at_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272195"><span class="hs-identifier hs-var">adt_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-647"></a><span>
</span><a name="line-648"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272199"><a href="#local-6989586621682272199"><span class="hs-identifier">all_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272191"><span class="hs-identifier hs-var">meth_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272198"><span class="hs-identifier hs-var">more_fvs</span></a><span>
</span><a name="line-649"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272184"><span class="hs-identifier hs-var">inst_fvs</span></a><span>
</span><a name="line-650"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cid_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-651"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_poly_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272183"><span class="hs-identifier hs-var">inst_ty'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272189"><span class="hs-identifier hs-var">mbinds'</span></a><span>
</span><a name="line-652"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272190"><span class="hs-identifier hs-var">uprags'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_tyfam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272196"><span class="hs-identifier hs-var">ats'</span></a><span>
</span><a name="line-653"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_overlap_mode</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272181"><span class="hs-identifier hs-var">oflag</span></a><span>
</span><a name="line-654"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cid_datafam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272197"><span class="hs-identifier hs-var">adts'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-655"></a><span>                 </span><a href="#local-6989586621682272199"><span class="hs-identifier hs-var">all_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-656"></a><span>             </span><span class="hs-comment">-- We return the renamed associated data type declarations so</span><span>
</span><a name="line-657"></a><span>             </span><span class="hs-comment">-- that they can be entered into the list of type declarations</span><span>
</span><a name="line-658"></a><span>             </span><span class="hs-comment">-- for the binding group, but we also keep a copy in the instance.</span><span>
</span><a name="line-659"></a><span>             </span><span class="hs-comment">-- The latter is needed for well-formedness checks in the type</span><span>
</span><a name="line-660"></a><span>             </span><span class="hs-comment">-- checker (eg, to ensure that all ATs of the instance actually</span><span>
</span><a name="line-661"></a><span>             </span><span class="hs-comment">-- receive a declaration).</span><span>
</span><a name="line-662"></a><span>             </span><span class="hs-comment">-- NB: Even the copies in the instance declaration carry copies of</span><span>
</span><a name="line-663"></a><span>             </span><span class="hs-comment">--     the instance context after renaming.  This is a bit</span><span>
</span><a name="line-664"></a><span>             </span><span class="hs-comment">--     strange, but should not matter (and it would be more work</span><span>
</span><a name="line-665"></a><span>             </span><span class="hs-comment">--     to remove the context).</span><span>
</span><a name="line-666"></a><span class="hs-identifier">rnClsInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XClsInstDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnClsInstDecl&quot;</span><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span class="hs-identifier">rnFamInstEqn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span>
</span><a name="line-669"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Nothing =&gt; not associated</span><span>
</span><a name="line-670"></a><span>                                     </span><span class="hs-comment">-- Just (cls,tvs) =&gt; associated,</span><span>
</span><a name="line-671"></a><span>                                     </span><span class="hs-comment">--   and gives class and tyvars of the</span><span>
</span><a name="line-672"></a><span>                                     </span><span class="hs-comment">--   parent instance decl</span><span>
</span><a name="line-673"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Kind variables from the equation's RHS</span><span>
</span><a name="line-674"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamInstEqn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><a href="#local-6989586621682271995"><span class="hs-identifier hs-type">rhs</span></a><span>
</span><a name="line-675"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682271995"><span class="hs-identifier hs-type">rhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271996"><span class="hs-identifier hs-type">rhs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-676"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FamInstEqn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><a href="#local-6989586621682271996"><span class="hs-identifier hs-type">rhs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-677"></a><a name="rnFamInstEqn"><a href="RnSource.html#rnFamInstEqn"><span class="hs-identifier">rnFamInstEqn</span></a></a><span> </span><a name="local-6989586621682272200"><a href="#local-6989586621682272200"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621682272201"><a href="#local-6989586621682272201"><span class="hs-identifier">mb_cls</span></a></a><span> </span><a name="local-6989586621682272202"><a href="#local-6989586621682272202"><span class="hs-identifier">rhs_kvars</span></a></a><span>
</span><a name="line-678"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272203"><a href="#local-6989586621682272203"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-679"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_bndrs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272204"><a href="#local-6989586621682272204"><span class="hs-identifier">mb_bndrs</span></a></a><span>
</span><a name="line-680"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_pats</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272205"><a href="#local-6989586621682272205"><span class="hs-identifier">pats</span></a></a><span>
</span><a name="line-681"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_fixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272206"><a href="#local-6989586621682272206"><span class="hs-identifier">fixity</span></a></a><span>
</span><a name="line-682"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272207"><a href="#local-6989586621682272207"><span class="hs-identifier">payload</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272208"><a href="#local-6989586621682272208"><span class="hs-identifier">rn_payload</span></a></a><span>
</span><a name="line-683"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272209"><a href="#local-6989586621682272209"><span class="hs-identifier">tycon'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupFamInstName"><span class="hs-identifier hs-var">lookupFamInstName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682272201"><span class="hs-identifier hs-var">mb_cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272203"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-684"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272210"><a href="#local-6989586621682272210"><span class="hs-identifier">pat_kity_vars_with_dups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractHsTyArgRdrKiTyVarsDup"><span class="hs-identifier hs-var">extractHsTyArgRdrKiTyVarsDup</span></a><span> </span><a href="#local-6989586621682272205"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-685"></a><span>             </span><span class="hs-comment">-- Use the &quot;...Dups&quot; form because it's needed</span><span>
</span><a name="line-686"></a><span>             </span><span class="hs-comment">-- below to report unsed binder on the LHS</span><span>
</span><a name="line-687"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272211"><a href="#local-6989586621682272211"><span class="hs-identifier">pat_kity_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#rmDupsInRdrTyVars"><span class="hs-identifier hs-var">rmDupsInRdrTyVars</span></a><span> </span><a href="#local-6989586621682272210"><span class="hs-identifier hs-var">pat_kity_vars_with_dups</span></a><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span>         </span><span class="hs-comment">-- all pat vars not explicitly bound (see extractHsTvBndrs)</span><span>
</span><a name="line-690"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272212"><a href="#local-6989586621682272212"><span class="hs-identifier">mb_imp_kity_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractHsTvBndrs"><span class="hs-identifier hs-var">extractHsTvBndrs</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682272204"><span class="hs-identifier hs-var">mb_bndrs</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621682272211"><span class="hs-identifier hs-var">pat_kity_vars</span></a><span>
</span><a name="line-691"></a><span>             </span><a name="local-6989586621682272213"><a href="#local-6989586621682272213"><span class="hs-identifier">imp_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272212"><span class="hs-identifier hs-var">mb_imp_kity_vars</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-692"></a><span>                          </span><span class="hs-comment">-- kind vars are the only ones free if we have an explicit forall</span><span>
</span><a name="line-693"></a><span>                          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682272214"><a href="#local-6989586621682272214"><span class="hs-identifier">nbnd_kity_vars</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnTypes.html#freeKiTyVarsKindVars"><span class="hs-identifier hs-var">freeKiTyVarsKindVars</span></a><span> </span><a href="#local-6989586621682272214"><span class="hs-identifier hs-var">nbnd_kity_vars</span></a><span>
</span><a name="line-694"></a><span>                          </span><span class="hs-comment">-- all pattern vars are free otherwise</span><span>
</span><a name="line-695"></a><span>                          </span><span class="hs-identifier hs-var">Nothing</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnTypes.html#freeKiTyVarsAllVars"><span class="hs-identifier hs-var">freeKiTyVarsAllVars</span></a><span> </span><a href="#local-6989586621682272211"><span class="hs-identifier hs-var">pat_kity_vars</span></a><span>
</span><a name="line-696"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272215"><a href="#local-6989586621682272215"><span class="hs-identifier">imp_var_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RnTypes.html#newTyVarNameRn"><span class="hs-identifier hs-var">newTyVarNameRn</span></a><span> </span><a href="#local-6989586621682272201"><span class="hs-identifier hs-var">mb_cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272213"><span class="hs-identifier hs-var">imp_vars</span></a><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272216"><a href="#local-6989586621682272216"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682272204"><span class="hs-identifier hs-var">mb_bndrs</span></a><span>
</span><a name="line-699"></a><span>             </span><a name="local-6989586621682272217"><a href="#local-6989586621682272217"><span class="hs-identifier">bnd_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">hsLTyVarLocName</span><span> </span><a href="#local-6989586621682272216"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-700"></a><span>             </span><a name="local-6989586621682272218"><a href="#local-6989586621682272218"><span class="hs-identifier">payload_kvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="RnTypes.html#elemRdr"><span class="hs-identifier hs-var">elemRdr</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272217"><span class="hs-identifier hs-var">bnd_vars</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272213"><span class="hs-identifier hs-var">imp_vars</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272202"><span class="hs-identifier hs-var">rhs_kvars</span></a><span>
</span><a name="line-701"></a><span>             </span><span class="hs-comment">-- Make sure to filter out the kind variables that were explicitly</span><span>
</span><a name="line-702"></a><span>             </span><span class="hs-comment">-- bound in the type patterns.</span><span>
</span><a name="line-703"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272219"><a href="#local-6989586621682272219"><span class="hs-identifier">payload_kvar_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RnTypes.html#newTyVarNameRn"><span class="hs-identifier hs-var">newTyVarNameRn</span></a><span> </span><a href="#local-6989586621682272201"><span class="hs-identifier hs-var">mb_cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272218"><span class="hs-identifier hs-var">payload_kvars</span></a><span>
</span><a name="line-704"></a><span>
</span><a name="line-705"></a><span>         </span><span class="hs-comment">-- all names not bound in an explict forall</span><span>
</span><a name="line-706"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272220"><a href="#local-6989586621682272220"><span class="hs-identifier">all_imp_var_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272215"><span class="hs-identifier hs-var">imp_var_names</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272219"><span class="hs-identifier hs-var">payload_kvar_names</span></a><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span>             </span><span class="hs-comment">-- All the free vars of the family patterns</span><span>
</span><a name="line-709"></a><span>             </span><span class="hs-comment">-- with a sensible binding location</span><span>
</span><a name="line-710"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682272233"><a href="#local-6989586621682272233"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272234"><a href="#local-6989586621682272234"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272235"><a href="#local-6989586621682272235"><span class="hs-identifier">payload'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272236"><a href="#local-6989586621682272236"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#bindLocalNamesFV"><span class="hs-identifier hs-var">bindLocalNamesFV</span></a><span> </span><a href="#local-6989586621682272220"><span class="hs-identifier hs-var">all_imp_var_names</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-712"></a><span>                 </span><a href="RnTypes.html#bindLHsTyVarBndrs"><span class="hs-identifier hs-var">bindLHsTyVarBndrs</span></a><span> </span><a href="#local-6989586621682272200"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnUtils.html#inHsDocContext"><span class="hs-identifier hs-var">inHsDocContext</span></a><span> </span><a href="#local-6989586621682272200"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-713"></a><span>                                   </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272216"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682272221"><a href="#local-6989586621682272221"><span class="hs-identifier">bndrs'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-714"></a><span>                 </span><span class="hs-comment">-- Note: If we pass mb_cls instead of Nothing here,</span><span>
</span><a name="line-715"></a><span>                 </span><span class="hs-comment">--  bindLHsTyVarBndrs will use class variables for any names</span><span>
</span><a name="line-716"></a><span>                 </span><span class="hs-comment">--  the user meant to bring in scope here. This is an explicit</span><span>
</span><a name="line-717"></a><span>                 </span><span class="hs-comment">--  forall, so we want fresh names, not class variables.</span><span>
</span><a name="line-718"></a><span>                 </span><span class="hs-comment">--  Thus: always pass Nothing</span><span>
</span><a name="line-719"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272222"><a href="#local-6989586621682272222"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272223"><a href="#local-6989586621682272223"><span class="hs-identifier">pat_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsTypeArgs"><span class="hs-identifier hs-var">rnLHsTypeArgs</span></a><span> </span><span class="hs-special">(</span><a href="RnUtils.html#FamPatCtx"><span class="hs-identifier hs-var">FamPatCtx</span></a><span> </span><a href="#local-6989586621682272203"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272205"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-720"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272224"><a href="#local-6989586621682272224"><span class="hs-identifier">payload'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272225"><a href="#local-6989586621682272225"><span class="hs-identifier">rhs_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272208"><span class="hs-identifier hs-var">rn_payload</span></a><span> </span><a href="#local-6989586621682272200"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272207"><span class="hs-identifier hs-var">payload</span></a><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span>                       </span><span class="hs-comment">-- Report unused binders on the LHS</span><span>
</span><a name="line-723"></a><span>                       </span><span class="hs-comment">-- See Note [Unused type variables in family instances]</span><span>
</span><a name="line-724"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">groups</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-725"></a><span>                          </span><a name="local-6989586621682272226"><a href="#local-6989586621682272226"><span class="hs-identifier">groups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">equivClasses</span><span> </span><span class="hs-identifier hs-var">cmpLocated</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-726"></a><span>                                   </span><a href="RnTypes.html#freeKiTyVarsAllVars"><span class="hs-identifier hs-var">freeKiTyVarsAllVars</span></a><span> </span><a href="#local-6989586621682272210"><span class="hs-identifier hs-var">pat_kity_vars_with_dups</span></a><span>
</span><a name="line-727"></a><span>                    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272228"><a href="#local-6989586621682272228"><span class="hs-identifier">nms_dups</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RnEnv.html#lookupOccRn"><span class="hs-identifier hs-var">lookupOccRn</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-728"></a><span>                                     </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682272227"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272227"><a href="#local-6989586621682272227"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-operator hs-var">:|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272226"><span class="hs-identifier hs-var">groups</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-729"></a><span>                          </span><span class="hs-comment">-- Add to the used variables</span><span>
</span><a name="line-730"></a><span>                          </span><span class="hs-comment">--  a) any variables that appear *more than once* on the LHS</span><span>
</span><a name="line-731"></a><span>                          </span><span class="hs-comment">--     e.g.   F a Int a = Bool</span><span>
</span><a name="line-732"></a><span>                          </span><span class="hs-comment">--  b) for associated instances, the variables</span><span>
</span><a name="line-733"></a><span>                          </span><span class="hs-comment">--     of the instance decl.  See</span><span>
</span><a name="line-734"></a><span>                          </span><span class="hs-comment">--     Note [Unused type variables in family instances]</span><span>
</span><a name="line-735"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272229"><a href="#local-6989586621682272229"><span class="hs-identifier">nms_used</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameSetList</span><span> </span><a href="#local-6989586621682272225"><span class="hs-identifier hs-var">rhs_fvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-736"></a><span>                                        </span><a href="#local-6989586621682272230"><span class="hs-identifier hs-var">inst_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272228"><span class="hs-identifier hs-var">nms_dups</span></a><span>
</span><a name="line-737"></a><span>                          </span><a name="local-6989586621682272230"><a href="#local-6989586621682272230"><span class="hs-identifier">inst_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272201"><span class="hs-identifier hs-var">mb_cls</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-738"></a><span>                                       </span><span class="hs-identifier hs-var">Nothing</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-739"></a><span>                                       </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272232"><a href="#local-6989586621682272232"><span class="hs-identifier">inst_tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272232"><span class="hs-identifier hs-var">inst_tvs</span></a><span>
</span><a name="line-740"></a><span>                          </span><a name="local-6989586621682272231"><a href="#local-6989586621682272231"><span class="hs-identifier">all_nms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272220"><span class="hs-identifier hs-var">all_imp_var_names</span></a><span>
</span><a name="line-741"></a><span>                                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">hsLTyVarName</span><span> </span><a href="#local-6989586621682272221"><span class="hs-identifier hs-var">bndrs'</span></a><span>
</span><a name="line-742"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#warnUnusedTypePatterns"><span class="hs-identifier hs-var">warnUnusedTypePatterns</span></a><span> </span><a href="#local-6989586621682272231"><span class="hs-identifier hs-var">all_nms</span></a><span> </span><a href="#local-6989586621682272229"><span class="hs-identifier hs-var">nms_used</span></a><span>
</span><a name="line-743"></a><span>
</span><a name="line-744"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682272221"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272222"><span class="hs-identifier hs-var">pats'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272224"><span class="hs-identifier hs-var">payload'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272225"><span class="hs-identifier hs-var">rhs_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272223"><span class="hs-identifier hs-var">pat_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272237"><a href="#local-6989586621682272237"><span class="hs-identifier">all_fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272236"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addOneFV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272209"><span class="hs-identifier hs-var">tycon'</span></a><span>
</span><a name="line-747"></a><span>            </span><span class="hs-comment">-- type instance =&gt; use, hence addOneFV</span><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272220"><span class="hs-identifier hs-var">all_imp_var_names</span></a><span> </span><span class="hs-comment">-- Note [Wildcards in family instances]</span><span>
</span><a name="line-750"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span>
</span><a name="line-751"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_ext</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-752"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_tycon</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272209"><span class="hs-identifier hs-var">tycon'</span></a><span>
</span><a name="line-753"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_bndrs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272233"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><span class="hs-operator hs-var">&lt;$</span><span> </span><a href="#local-6989586621682272204"><span class="hs-identifier hs-var">mb_bndrs</span></a><span>
</span><a name="line-754"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_pats</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272234"><span class="hs-identifier hs-var">pats'</span></a><span>
</span><a name="line-755"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_fixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272206"><span class="hs-identifier hs-var">fixity</span></a><span>
</span><a name="line-756"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272235"><span class="hs-identifier hs-var">payload'</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-757"></a><span>                 </span><a href="#local-6989586621682272237"><span class="hs-identifier hs-var">all_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-758"></a><span class="hs-identifier">rnFamInstEqn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFamEqn</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnFamInstEqn&quot;</span><span>
</span><a name="line-759"></a><span class="hs-identifier">rnFamInstEqn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnFamInstEqn&quot;</span><span>
</span><a name="line-760"></a><span>
</span><a name="line-761"></a><span class="hs-identifier">rnTyFamInstDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Just (cls,tvs) =&gt; associated,</span><span>
</span><a name="line-762"></a><span>                                        </span><span class="hs-comment">--   and gives class and tyvars of</span><span>
</span><a name="line-763"></a><span>                                        </span><span class="hs-comment">--   the parent instance decl</span><span>
</span><a name="line-764"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyFamInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-765"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyFamInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-766"></a><a name="rnTyFamInstDecl"><a href="RnSource.html#rnTyFamInstDecl"><span class="hs-identifier">rnTyFamInstDecl</span></a></a><span> </span><a name="local-6989586621682272238"><a href="#local-6989586621682272238"><span class="hs-identifier">mb_cls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyFamInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tfid_eqn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272239"><a href="#local-6989586621682272239"><span class="hs-identifier">eqn</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-767"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272240"><a href="#local-6989586621682272240"><span class="hs-identifier">eqn'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272241"><a href="#local-6989586621682272241"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnTyFamInstEqn"><span class="hs-identifier hs-var">rnTyFamInstEqn</span></a><span> </span><a href="#local-6989586621682272238"><span class="hs-identifier hs-var">mb_cls</span></a><span> </span><a href="RnSource.html#NotClosedTyFam"><span class="hs-identifier hs-var">NotClosedTyFam</span></a><span> </span><a href="#local-6989586621682272239"><span class="hs-identifier hs-var">eqn</span></a><span>
</span><a name="line-768"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyFamInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tfid_eqn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272240"><span class="hs-identifier hs-var">eqn'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272241"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span class="hs-comment">-- | Tracks whether we are renaming an equation in a closed type family</span><span>
</span><a name="line-771"></a><span class="hs-comment">-- equation ('ClosedTyFam') or not ('NotClosedTyFam').</span><span>
</span><a name="line-772"></a><span class="hs-keyword">data</span><span> </span><a name="ClosedTyFamInfo"><a href="RnSource.html#ClosedTyFamInfo"><span class="hs-identifier">ClosedTyFamInfo</span></a></a><span>
</span><a name="line-773"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NotClosedTyFam"><a href="RnSource.html#NotClosedTyFam"><span class="hs-identifier">NotClosedTyFam</span></a></a><span>
</span><a name="line-774"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ClosedTyFam"><a href="RnSource.html#ClosedTyFam"><span class="hs-identifier">ClosedTyFam</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-775"></a><span>                </span><span class="hs-comment">-- The names (RdrName and Name) of the closed type family</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span class="hs-identifier">rnTyFamInstEqn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-778"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnSource.html#ClosedTyFamInfo"><span class="hs-identifier hs-type">ClosedTyFamInfo</span></a><span>
</span><a name="line-779"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyFamInstEqn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-780"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyFamInstEqn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-781"></a><a name="rnTyFamInstEqn"><a href="RnSource.html#rnTyFamInstEqn"><span class="hs-identifier">rnTyFamInstEqn</span></a></a><span> </span><a name="local-6989586621682272242"><a href="#local-6989586621682272242"><span class="hs-identifier">mb_cls</span></a></a><span> </span><a name="local-6989586621682272243"><a href="#local-6989586621682272243"><span class="hs-identifier">ctf_info</span></a></a><span>
</span><a name="line-782"></a><span>    </span><a name="local-6989586621682272244"><a href="#local-6989586621682272244"><span class="hs-identifier">eqn</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272245"><a href="#local-6989586621682272245"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-783"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272246"><a href="#local-6989586621682272246"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272247"><a href="#local-6989586621682272247"><span class="hs-identifier">rhs_kvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractHsTyRdrTyVarsKindVars"><span class="hs-identifier hs-var">extractHsTyRdrTyVarsKindVars</span></a><span> </span><a href="#local-6989586621682272246"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-785"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272248"><a href="#local-6989586621682272248"><span class="hs-identifier">eqn'</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-786"></a><span>                       </span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dL</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272249"><a href="#local-6989586621682272249"><span class="hs-identifier">tycon'</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272250"><a href="#local-6989586621682272250"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnFamInstEqn"><span class="hs-identifier hs-var">rnFamInstEqn</span></a><span> </span><span class="hs-special">(</span><a href="RnUtils.html#TySynCtx"><span class="hs-identifier hs-var">TySynCtx</span></a><span> </span><a href="#local-6989586621682272245"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272242"><span class="hs-identifier hs-var">mb_cls</span></a><span> </span><a href="#local-6989586621682272247"><span class="hs-identifier hs-var">rhs_kvs</span></a><span> </span><a href="#local-6989586621682272244"><span class="hs-identifier hs-var">eqn</span></a><span> </span><a href="RnSource.html#rnTySyn"><span class="hs-identifier hs-var">rnTySyn</span></a><span>
</span><a name="line-788"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272243"><span class="hs-identifier hs-var">ctf_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-789"></a><span>           </span><a href="RnSource.html#NotClosedTyFam"><span class="hs-identifier hs-var">NotClosedTyFam</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-790"></a><span>           </span><a href="RnSource.html#ClosedTyFam"><span class="hs-identifier hs-var">ClosedTyFam</span></a><span> </span><a name="local-6989586621682272251"><a href="#local-6989586621682272251"><span class="hs-identifier">fam_rdr_name</span></a></a><span> </span><a name="local-6989586621682272252"><a href="#local-6989586621682272252"><span class="hs-identifier">fam_name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-791"></a><span>             </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272252"><span class="hs-identifier hs-var">fam_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682272249"><span class="hs-identifier hs-var">tycon'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-792"></a><span>             </span><a href="RnUtils.html#withHsDocContext"><span class="hs-identifier hs-var">withHsDocContext</span></a><span> </span><span class="hs-special">(</span><a href="RnUtils.html#TyFamilyCtx"><span class="hs-identifier hs-var">TyFamilyCtx</span></a><span> </span><a href="#local-6989586621682272251"><span class="hs-identifier hs-var">fam_rdr_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-793"></a><span>             </span><a href="RnSource.html#wrongTyFamName"><span class="hs-identifier hs-var">wrongTyFamName</span></a><span> </span><a href="#local-6989586621682272252"><span class="hs-identifier hs-var">fam_name</span></a><span> </span><a href="#local-6989586621682272249"><span class="hs-identifier hs-var">tycon'</span></a><span>
</span><a name="line-794"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272248"><span class="hs-identifier hs-var">eqn'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272250"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-795"></a><span class="hs-identifier">rnTyFamInstEqn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFamEqn</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnTyFamInstEqn&quot;</span><span>
</span><a name="line-796"></a><span class="hs-identifier">rnTyFamInstEqn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnTyFamInstEqn&quot;</span><span>
</span><a name="line-797"></a><span>
</span><a name="line-798"></a><span class="hs-identifier">rnTyFamDefltEqn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-799"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyFamDefltEqn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-800"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyFamDefltEqn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-801"></a><a name="rnTyFamDefltEqn"><a href="RnSource.html#rnTyFamDefltEqn"><span class="hs-identifier">rnTyFamDefltEqn</span></a></a><span> </span><a name="local-6989586621682272253"><a href="#local-6989586621682272253"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272254"><a href="#local-6989586621682272254"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-802"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_bndrs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272255"><a href="#local-6989586621682272255"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-803"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_pats</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272256"><a href="#local-6989586621682272256"><span class="hs-identifier">tyvars</span></a></a><span>
</span><a name="line-804"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_fixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272257"><a href="#local-6989586621682272257"><span class="hs-identifier">fixity</span></a></a><span>
</span><a name="line-805"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272258"><a href="#local-6989586621682272258"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-806"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272260"><a href="#local-6989586621682272260"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractHsTyRdrTyVarsKindVars"><span class="hs-identifier hs-var">extractHsTyRdrTyVarsKindVars</span></a><span> </span><a href="#local-6989586621682272258"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-807"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnTypes.html#bindHsQTyVars"><span class="hs-identifier hs-var">bindHsQTyVars</span></a><span> </span><a href="#local-6989586621682272259"><span class="hs-identifier hs-var">ctx</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272253"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272260"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="#local-6989586621682272256"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272261"><a href="#local-6989586621682272261"><span class="hs-identifier">tyvars'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-808"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272262"><a href="#local-6989586621682272262"><span class="hs-identifier">tycon'</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupFamInstName"><span class="hs-identifier hs-var">lookupFamInstName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272253"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272254"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-809"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272263"><a href="#local-6989586621682272263"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272264"><a href="#local-6989586621682272264"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><a href="#local-6989586621682272259"><span class="hs-identifier hs-var">ctx</span></a><span> </span><a href="#local-6989586621682272258"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-810"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_ext</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-811"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_tycon</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272262"><span class="hs-identifier hs-var">tycon'</span></a><span>
</span><a name="line-812"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_bndrs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">bndrs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-813"></a><span>                                        </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-814"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_pats</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272261"><span class="hs-identifier hs-var">tyvars'</span></a><span>
</span><a name="line-815"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_fixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272257"><span class="hs-identifier hs-var">fixity</span></a><span>
</span><a name="line-816"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272263"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272264"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-817"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-818"></a><span>    </span><a name="local-6989586621682272259"><a href="#local-6989586621682272259"><span class="hs-identifier">ctx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#TyFamilyCtx"><span class="hs-identifier hs-var">TyFamilyCtx</span></a><span> </span><a href="#local-6989586621682272254"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-819"></a><span class="hs-identifier">rnTyFamDefltEqn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFamEqn</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnTyFamDefltEqn&quot;</span><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span class="hs-identifier">rnDataFamInstDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataFamInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-823"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DataFamInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-824"></a><a name="rnDataFamInstDecl"><a href="RnSource.html#rnDataFamInstDecl"><span class="hs-identifier">rnDataFamInstDecl</span></a></a><span> </span><a name="local-6989586621682272265"><a href="#local-6989586621682272265"><span class="hs-identifier">mb_cls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_eqn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272266"><a href="#local-6989586621682272266"><span class="hs-identifier">eqn</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-825"></a><span>                           </span><span class="hs-identifier hs-var">FamEqn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272267"><a href="#local-6989586621682272267"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-826"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272268"><a href="#local-6989586621682272268"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-827"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272269"><a href="#local-6989586621682272269"><span class="hs-identifier">rhs_kvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractDataDefnKindVars"><span class="hs-identifier hs-var">extractDataDefnKindVars</span></a><span> </span><a href="#local-6989586621682272268"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-828"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272270"><a href="#local-6989586621682272270"><span class="hs-identifier">eqn'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272271"><a href="#local-6989586621682272271"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-829"></a><span>           </span><a href="RnSource.html#rnFamInstEqn"><span class="hs-identifier hs-var">rnFamInstEqn</span></a><span> </span><span class="hs-special">(</span><a href="RnUtils.html#TyDataCtx"><span class="hs-identifier hs-var">TyDataCtx</span></a><span> </span><a href="#local-6989586621682272267"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272265"><span class="hs-identifier hs-var">mb_cls</span></a><span> </span><a href="#local-6989586621682272269"><span class="hs-identifier hs-var">rhs_kvs</span></a><span> </span><a href="#local-6989586621682272266"><span class="hs-identifier hs-var">eqn</span></a><span> </span><a href="RnSource.html#rnDataDefn"><span class="hs-identifier hs-var">rnDataDefn</span></a><span>
</span><a name="line-830"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_eqn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272270"><span class="hs-identifier hs-var">eqn'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272271"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-831"></a><span class="hs-identifier">rnDataFamInstDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFamEqn</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-832"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnDataFamInstDecl&quot;</span><span>
</span><a name="line-833"></a><span class="hs-identifier">rnDataFamInstDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-834"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnDataFamInstDecl&quot;</span><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span class="hs-comment">-- Renaming of the associated types in instances.</span><span>
</span><a name="line-837"></a><span>
</span><a name="line-838"></a><span class="hs-comment">-- Rename associated type family decl in class</span><span>
</span><a name="line-839"></a><span class="hs-identifier">rnATDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>      </span><span class="hs-comment">-- Class</span><span>
</span><a name="line-840"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LFamilyDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-841"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LFamilyDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-842"></a><a name="rnATDecls"><a href="RnSource.html#rnATDecls"><span class="hs-identifier">rnATDecls</span></a></a><span> </span><a name="local-6989586621682272272"><a href="#local-6989586621682272272"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682272273"><a href="#local-6989586621682272273"><span class="hs-identifier">at_decls</span></a></a><span>
</span><a name="line-843"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#rnFamDecl"><span class="hs-identifier hs-var">rnFamDecl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272272"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272273"><span class="hs-identifier hs-var">at_decls</span></a><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span class="hs-identifier">rnATInstDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- The function that renames</span><span>
</span><a name="line-846"></a><span>                  </span><a href="#local-6989586621682271994"><span class="hs-identifier hs-type">decl</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span>            </span><span class="hs-comment">-- an instance. rnTyFamInstDecl</span><span>
</span><a name="line-847"></a><span>                  </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271994"><span class="hs-identifier hs-type">decl</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- or rnDataFamInstDecl</span><span>
</span><a name="line-848"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>      </span><span class="hs-comment">-- Class</span><span>
</span><a name="line-849"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-850"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271994"><span class="hs-identifier hs-type">decl</span></a><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-851"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271994"><span class="hs-identifier hs-type">decl</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span class="hs-comment">-- Used for data and type family defaults in a class decl</span><span>
</span><a name="line-853"></a><span class="hs-comment">-- and the family instance declarations in an instance</span><span>
</span><a name="line-854"></a><span class="hs-comment">--</span><span>
</span><a name="line-855"></a><span class="hs-comment">-- NB: We allow duplicate associated-type decls;</span><span>
</span><a name="line-856"></a><span class="hs-comment">--     See Note [Associated type instances] in TcInstDcls</span><span>
</span><a name="line-857"></a><a name="rnATInstDecls"><a href="RnSource.html#rnATInstDecls"><span class="hs-identifier">rnATInstDecls</span></a></a><span> </span><a name="local-6989586621682272274"><a href="#local-6989586621682272274"><span class="hs-identifier">rnFun</span></a></a><span> </span><a name="local-6989586621682272275"><a href="#local-6989586621682272275"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682272276"><a href="#local-6989586621682272276"><span class="hs-identifier">tv_ns</span></a></a><span> </span><a name="local-6989586621682272277"><a href="#local-6989586621682272277"><span class="hs-identifier">at_insts</span></a></a><span>
</span><a name="line-858"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272274"><span class="hs-identifier hs-var">rnFun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272275"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272276"><span class="hs-identifier hs-var">tv_ns</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272277"><span class="hs-identifier hs-var">at_insts</span></a><span>
</span><a name="line-859"></a><span>    </span><span class="hs-comment">-- See Note [Renaming associated types]</span><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span class="hs-comment">{- Note [Wildcards in family instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Wild cards can be used in type/data family instance declarations to indicate
that the name of a type variable doesn't matter. Each wild card will be
replaced with a new unique type variable. For instance:

    type family F a b :: *
    type instance F Int _ = Int

is the same as

    type family F a b :: *
    type instance F Int b = Int

This is implemented as follows: Unnamed wildcards remain unchanged after
the renamer, and then given fresh meta-variables during typechecking, and
it is handled pretty much the same way as the ones in partial type signatures.
We however don't want to emit hole constraints on wildcards in family
instances, so we turn on PartialTypeSignatures and turn off warning flag to
let typechecker know this.
See related Note [Wildcards in visible kind application] in TcHsType.hs

Note [Unused type variables in family instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the flag -fwarn-unused-type-patterns is on, the compiler reports
warnings about unused type variables in type-family instances. A
tpye variable is considered used (i.e. cannot be turned into a wildcard)
when

 * it occurs on the RHS of the family instance
   e.g.   type instance F a b = a    -- a is used on the RHS

 * it occurs multiple times in the patterns on the LHS
   e.g.   type instance F a a = Int  -- a appears more than once on LHS

 * it is one of the instance-decl variables, for associated types
   e.g.   instance C (a,b) where
            type T (a,b) = a
   Here the type pattern in the type instance must be the same as that
   for the class instance, so
            type T (a,_) = a
   would be rejected.  So we should not complain about an unused variable b

As usual, the warnings are not reported for type variables with names
beginning with an underscore.

Extra-constraints wild cards are not supported in type/data family
instance declarations.

Relevant tickets: #3699, #10586, #10982 and #11451.

Note [Renaming associated types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Check that the RHS of the decl mentions only type variables that are explicitly
bound on the LHS.  For example, this is not ok
   class C a b where
      type F a x :: *
   instance C (p,q) r where
      type F (p,q) x = (x, r)   -- BAD: mentions 'r'
c.f. Trac #5515

Kind variables, on the other hand, are allowed to be implicitly or explicitly
bound. As examples, this (#9574) is acceptable:
   class Funct f where
      type Codomain f :: *
   instance Funct ('KProxy :: KProxy o) where
      -- o is implicitly bound by the kind signature
      -- of the LHS type pattern ('KProxy)
      type Codomain 'KProxy = NatTr (Proxy :: o -&gt; *)
And this (#14131) is also acceptable:
    data family Nat :: k -&gt; k -&gt; *
    -- k is implicitly bound by an invisible kind pattern
    newtype instance Nat :: (k -&gt; *) -&gt; (k -&gt; *) -&gt; * where
      Nat :: (forall xx. f xx -&gt; g xx) -&gt; Nat f g
We could choose to disallow this, but then associated type families would not
be able to be as expressive as top-level type synonyms. For example, this type
synonym definition is allowed:
    type T = (Nothing :: Maybe a)
So for parity with type synonyms, we also allow:
    type family   T :: Maybe a
    type instance T = (Nothing :: Maybe a)

All this applies only for *instance* declarations.  In *class*
declarations there is no RHS to worry about, and the class variables
can all be in scope (Trac #5862):
    class Category (x :: k -&gt; k -&gt; *) where
      type Ob x :: k -&gt; Constraint
      id :: Ob x a =&gt; x a a
      (.) :: (Ob x a, Ob x b, Ob x c) =&gt; x b c -&gt; x a b -&gt; x a c
Here 'k' is in scope in the kind signature, just like 'x'.

Although type family equations can bind type variables with explicit foralls,
it need not be the case that all variables that appear on the RHS must be bound
by a forall. For instance, the following is acceptable:

   class C a where
     type T a b
   instance C (Maybe a) where
     type forall b. T (Maybe a) b = Either a b

Even though `a` is not bound by the forall, this is still accepted because `a`
was previously bound by the `instance C (Maybe a)` part. (see Trac #16116).

In each case, the function which detects improperly bound variables on the RHS
is TcValidity.checkValidFamPats.
-}</span><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span>
</span><a name="line-969"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Stand-alone deriving declarations}
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span class="hs-identifier">rnSrcDerivDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DerivDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DerivDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-978"></a><a name="rnSrcDerivDecl"><a href="RnSource.html#rnSrcDerivDecl"><span class="hs-identifier">rnSrcDerivDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DerivDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272278"><a href="#local-6989586621682272278"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682272279"><a href="#local-6989586621682272279"><span class="hs-identifier">mds</span></a></a><span> </span><a name="local-6989586621682272280"><a href="#local-6989586621682272280"><span class="hs-identifier">overlap</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-979"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272282"><a href="#local-6989586621682272282"><span class="hs-identifier">standalone_deriv_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.StandaloneDeriving</span><span>
</span><a name="line-980"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621682272282"><span class="hs-identifier hs-var">standalone_deriv_ok</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="RnSource.html#standaloneDerivErr"><span class="hs-identifier hs-var">standaloneDerivErr</span></a><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272285"><a href="#local-6989586621682272285"><span class="hs-identifier">mds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272286"><a href="#local-6989586621682272286"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272287"><a href="#local-6989586621682272287"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnLDerivStrategy"><span class="hs-identifier hs-var">rnLDerivStrategy</span></a><span> </span><a href="RnUtils.html#DerivDeclCtx"><span class="hs-identifier hs-var">DerivDeclCtx</span></a><span> </span><a href="#local-6989586621682272279"><span class="hs-identifier hs-var">mds</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682272283"><a href="#local-6989586621682272283"><span class="hs-identifier">strat_tvs</span></a></a><span> </span><a name="local-6989586621682272284"><a href="#local-6989586621682272284"><span class="hs-identifier">ppr_via_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-983"></a><span>              </span><a href="RnSource.html#rnAndReportFloatingViaTvs"><span class="hs-identifier hs-var">rnAndReportFloatingViaTvs</span></a><span> </span><a href="#local-6989586621682272283"><span class="hs-identifier hs-var">strat_tvs</span></a><span> </span><a href="#local-6989586621682272281"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682272284"><span class="hs-identifier hs-var">ppr_via_ty</span></a><span> </span><span class="hs-string">&quot;instance&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-984"></a><span>              </span><a href="RnTypes.html#rnHsSigWcType"><span class="hs-identifier hs-var">rnHsSigWcType</span></a><span> </span><a href="RnTypes.html#BindUnlessForall"><span class="hs-identifier hs-var">BindUnlessForall</span></a><span> </span><a href="RnUtils.html#DerivDeclCtx"><span class="hs-identifier hs-var">DerivDeclCtx</span></a><span> </span><a href="#local-6989586621682272278"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-985"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnSource.html#warnNoDerivStrat"><span class="hs-identifier hs-var">warnNoDerivStrat</span></a><span> </span><a href="#local-6989586621682272285"><span class="hs-identifier hs-var">mds'</span></a><span> </span><a href="#local-6989586621682272281"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-986"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DerivDecl</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682272286"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621682272285"><span class="hs-identifier hs-var">mds'</span></a><span> </span><a href="#local-6989586621682272280"><span class="hs-identifier hs-var">overlap</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272287"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-987"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-988"></a><span>    </span><a name="local-6989586621682272281"><a href="#local-6989586621682272281"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hswc_body</span><span> </span><a href="#local-6989586621682272278"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-989"></a><span class="hs-identifier">rnSrcDerivDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XDerivDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnSrcDerivDecl&quot;</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span class="hs-identifier">standaloneDerivErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-992"></a><a name="standaloneDerivErr"><a href="RnSource.html#standaloneDerivErr"><span class="hs-identifier">standaloneDerivErr</span></a></a><span>
</span><a name="line-993"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal standalone deriving declaration&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use StandaloneDeriving to enable this extension&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>
</span><a name="line-996"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Rules}
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-1003"></a><span>
</span><a name="line-1004"></a><span class="hs-identifier">rnHsRuleDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RuleDecls</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RuleDecls</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1005"></a><a name="rnHsRuleDecls"><a href="RnSource.html#rnHsRuleDecls"><span class="hs-identifier">rnHsRuleDecls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRules</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rds_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272288"><a href="#local-6989586621682272288"><span class="hs-identifier">src</span></a></a><span>
</span><a name="line-1006"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rds_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272289"><a href="#local-6989586621682272289"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272290"><a href="#local-6989586621682272290"><span class="hs-identifier">rn_rules</span></a></a><span class="hs-special">,</span><a name="local-6989586621682272291"><a href="#local-6989586621682272291"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><a href="RnSource.html#rnHsRuleDecl"><span class="hs-identifier hs-var">rnHsRuleDecl</span></a><span> </span><a href="#local-6989586621682272289"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-1008"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRules</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rds_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-1009"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rds_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272288"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-1010"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rds_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272290"><span class="hs-identifier hs-var">rn_rules</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272291"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1011"></a><span class="hs-identifier">rnHsRuleDecls</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XRuleDecls</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnHsRuleDecls&quot;</span><span>
</span><a name="line-1012"></a><span>
</span><a name="line-1013"></a><span class="hs-identifier">rnHsRuleDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RuleDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RuleDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1014"></a><a name="rnHsRuleDecl"><a href="RnSource.html#rnHsRuleDecl"><span class="hs-identifier">rnHsRuleDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272292"><a href="#local-6989586621682272292"><span class="hs-identifier">rule_name</span></a></a><span>
</span><a name="line-1015"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_act</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272293"><a href="#local-6989586621682272293"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-1016"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_tyvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272294"><a href="#local-6989586621682272294"><span class="hs-identifier">tyvs</span></a></a><span>
</span><a name="line-1017"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_tmvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272295"><a href="#local-6989586621682272295"><span class="hs-identifier">tmvs</span></a></a><span>
</span><a name="line-1018"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_lhs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272296"><a href="#local-6989586621682272296"><span class="hs-identifier">lhs</span></a></a><span>
</span><a name="line-1019"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_rhs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272297"><a href="#local-6989586621682272297"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272302"><a href="#local-6989586621682272302"><span class="hs-identifier">rdr_names_w_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272298"><span class="hs-identifier hs-var">get_var</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272295"><span class="hs-identifier hs-var">tmvs</span></a><span>
</span><a name="line-1021"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#checkDupRdrNames"><span class="hs-identifier hs-var">checkDupRdrNames</span></a><span> </span><a href="#local-6989586621682272302"><span class="hs-identifier hs-var">rdr_names_w_loc</span></a><span>
</span><a name="line-1022"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#checkShadowedRdrNames"><span class="hs-identifier hs-var">checkShadowedRdrNames</span></a><span> </span><a href="#local-6989586621682272302"><span class="hs-identifier hs-var">rdr_names_w_loc</span></a><span>
</span><a name="line-1023"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272303"><a href="#local-6989586621682272303"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#newLocalBndrsRn"><span class="hs-identifier hs-var">newLocalBndrsRn</span></a><span> </span><a href="#local-6989586621682272302"><span class="hs-identifier hs-var">rdr_names_w_loc</span></a><span>
</span><a name="line-1024"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272304"><a href="#local-6989586621682272304"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#RuleCtx"><span class="hs-identifier hs-var">RuleCtx</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272292"><span class="hs-identifier hs-var">rule_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnSource.html#bindRuleTyVars"><span class="hs-identifier hs-var">bindRuleTyVars</span></a><span> </span><a href="#local-6989586621682272304"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272299"><span class="hs-identifier hs-var">in_rule</span></a><span> </span><a href="#local-6989586621682272294"><span class="hs-identifier hs-var">tyvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272305"><a href="#local-6989586621682272305"><span class="hs-identifier">tyvs'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1026"></a><span>         </span><a href="RnSource.html#bindRuleTmVars"><span class="hs-identifier hs-var">bindRuleTmVars</span></a><span> </span><a href="#local-6989586621682272304"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272305"><span class="hs-identifier hs-var">tyvs'</span></a><span> </span><a href="#local-6989586621682272295"><span class="hs-identifier hs-var">tmvs</span></a><span> </span><a href="#local-6989586621682272303"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272306"><a href="#local-6989586621682272306"><span class="hs-identifier">tmvs'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1027"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272307"><a href="#local-6989586621682272307"><span class="hs-identifier">lhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272308"><a href="#local-6989586621682272308"><span class="hs-identifier">fv_lhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682272296"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-1028"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272309"><a href="#local-6989586621682272309"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272310"><a href="#local-6989586621682272310"><span class="hs-identifier">fv_rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621682272297"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1029"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnSource.html#checkValidRule"><span class="hs-identifier hs-var">checkValidRule</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272292"><span class="hs-identifier hs-var">rule_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272303"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="#local-6989586621682272307"><span class="hs-identifier hs-var">lhs'</span></a><span> </span><a href="#local-6989586621682272308"><span class="hs-identifier hs-var">fv_lhs'</span></a><span>
</span><a name="line-1030"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rd_ext</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsRuleRn</span><span> </span><a href="#local-6989586621682272308"><span class="hs-identifier hs-var">fv_lhs'</span></a><span> </span><a href="#local-6989586621682272310"><span class="hs-identifier hs-var">fv_rhs'</span></a><span>
</span><a name="line-1031"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272292"><span class="hs-identifier hs-var">rule_name</span></a><span>
</span><a name="line-1032"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_act</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272293"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-1033"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_tyvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272305"><span class="hs-identifier hs-var">tyvs'</span></a><span>
</span><a name="line-1034"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_tmvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272306"><span class="hs-identifier hs-var">tmvs'</span></a><span>
</span><a name="line-1035"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_lhs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272307"><span class="hs-identifier hs-var">lhs'</span></a><span>
</span><a name="line-1036"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rd_rhs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272309"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272308"><span class="hs-identifier hs-var">fv_lhs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272310"><span class="hs-identifier hs-var">fv_rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1037"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1038"></a><span>    </span><a name="local-6989586621682272298"><a href="#local-6989586621682272298"><span class="hs-identifier">get_var</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleBndrSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272300"><a href="#local-6989586621682272300"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272300"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1039"></a><span>    </span><span class="hs-identifier">get_var</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleBndr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272301"><a href="#local-6989586621682272301"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272301"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1040"></a><span>    </span><span class="hs-identifier">get_var</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XRuleBndr</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnHsRuleDecl&quot;</span><span>
</span><a name="line-1041"></a><span>    </span><a name="local-6989586621682272299"><a href="#local-6989586621682272299"><span class="hs-identifier">in_rule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in the rule&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprFullRuleName</span><span> </span><a href="#local-6989586621682272292"><span class="hs-identifier hs-var">rule_name</span></a><span>
</span><a name="line-1042"></a><span class="hs-identifier">rnHsRuleDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XRuleDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnHsRuleDecl&quot;</span><span>
</span><a name="line-1043"></a><span>
</span><a name="line-1044"></a><span class="hs-identifier">bindRuleTmVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621682271992"><span class="hs-identifier hs-type">ty_bndrs</span></a><span>
</span><a name="line-1045"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LRuleBndr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1046"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LRuleBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271993"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1047"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271993"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1048"></a><a name="bindRuleTmVars"><a href="RnSource.html#bindRuleTmVars"><span class="hs-identifier">bindRuleTmVars</span></a></a><span> </span><a name="local-6989586621682272311"><a href="#local-6989586621682272311"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621682272312"><a href="#local-6989586621682272312"><span class="hs-identifier">tyvs</span></a></a><span> </span><a name="local-6989586621682272313"><a href="#local-6989586621682272313"><span class="hs-identifier">vars</span></a></a><span> </span><a name="local-6989586621682272314"><a href="#local-6989586621682272314"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621682272315"><a href="#local-6989586621682272315"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1049"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272316"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682272313"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621682272314"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272337"><a href="#local-6989586621682272337"><span class="hs-identifier">vars'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1050"></a><span>    </span><a href="RnUtils.html#bindLocalNamesFV"><span class="hs-identifier hs-var">bindLocalNamesFV</span></a><span> </span><a href="#local-6989586621682272314"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272315"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621682272337"><span class="hs-identifier hs-var">vars'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1051"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1052"></a><span>    </span><a name="local-6989586621682272316"><a href="#local-6989586621682272316"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272318"><a href="#local-6989586621682272318"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleBndr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272319"><a href="#local-6989586621682272319"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682272320"><a href="#local-6989586621682272320"><span class="hs-identifier">vars</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272321"><a href="#local-6989586621682272321"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682272322"><a href="#local-6989586621682272322"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272323"><a href="#local-6989586621682272323"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1053"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272316"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682272320"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621682272322"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272324"><a href="#local-6989586621682272324"><span class="hs-identifier">vars'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1054"></a><span>        </span><a href="#local-6989586621682272323"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272318"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleBndr</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272319"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682272321"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272324"><span class="hs-identifier hs-var">vars'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272325"><a href="#local-6989586621682272325"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleBndrSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272326"><a href="#local-6989586621682272326"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272327"><a href="#local-6989586621682272327"><span class="hs-identifier">bsig</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682272328"><a href="#local-6989586621682272328"><span class="hs-identifier">vars</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1057"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621682272329"><a href="#local-6989586621682272329"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682272330"><a href="#local-6989586621682272330"><span class="hs-identifier">ns</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272331"><a href="#local-6989586621682272331"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1058"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#rnHsSigWcTypeScoped"><span class="hs-identifier hs-var">rnHsSigWcTypeScoped</span></a><span> </span><a href="#local-6989586621682272317"><span class="hs-identifier hs-var">bind_free_tvs</span></a><span> </span><a href="#local-6989586621682272311"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272327"><span class="hs-identifier hs-var">bsig</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272332"><a href="#local-6989586621682272332"><span class="hs-identifier">bsig'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1059"></a><span>        </span><a href="#local-6989586621682272316"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682272328"><span class="hs-identifier hs-var">vars</span></a><span> </span><a href="#local-6989586621682272330"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272333"><a href="#local-6989586621682272333"><span class="hs-identifier">vars'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1060"></a><span>        </span><a href="#local-6989586621682272331"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272325"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleBndrSig</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272326"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682272329"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272332"><span class="hs-identifier hs-var">bsig'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272333"><span class="hs-identifier hs-var">vars'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1061"></a><span>
</span><a name="line-1062"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682272334"><a href="#local-6989586621682272334"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272334"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1063"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682272335"><a href="#local-6989586621682272335"><span class="hs-identifier">vars</span></a></a><span> </span><a name="local-6989586621682272336"><a href="#local-6989586621682272336"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;bindRuleVars&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272335"><span class="hs-identifier hs-var">vars</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272336"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-1064"></a><span>
</span><a name="line-1065"></a><span>    </span><a name="local-6989586621682272317"><a href="#local-6989586621682272317"><span class="hs-identifier">bind_free_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272312"><span class="hs-identifier hs-var">tyvs</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnTypes.html#AlwaysBind"><span class="hs-identifier hs-var">AlwaysBind</span></a><span>
</span><a name="line-1066"></a><span>                                 </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnTypes.html#NeverBind"><span class="hs-identifier hs-var">NeverBind</span></a><span>
</span><a name="line-1067"></a><span>
</span><a name="line-1068"></a><span class="hs-identifier">bindRuleTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-1069"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271991"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1070"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271991"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1071"></a><a name="bindRuleTyVars"><a href="RnSource.html#bindRuleTyVars"><span class="hs-identifier">bindRuleTyVars</span></a></a><span> </span><a name="local-6989586621682272338"><a href="#local-6989586621682272338"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621682272339"><a href="#local-6989586621682272339"><span class="hs-identifier">in_doc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682272340"><a href="#local-6989586621682272340"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272341"><a href="#local-6989586621682272341"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1072"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#bindLHsTyVarBndrs"><span class="hs-identifier hs-var">bindLHsTyVarBndrs</span></a><span> </span><a href="#local-6989586621682272338"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272339"><span class="hs-identifier hs-var">in_doc</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272340"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272341"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span class="hs-special">)</span><span>
</span><a name="line-1073"></a><span class="hs-identifier">bindRuleTyVars</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272342"><a href="#local-6989586621682272342"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272342"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1074"></a><span>
</span><a name="line-1075"></a><span class="hs-comment">{-
Note [Rule LHS validity checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Check the shape of a transformation rule LHS.  Currently we only allow
LHSs of the form @(f e1 .. en)@, where @f@ is not one of the
@forall@'d variables.

We used restrict the form of the 'ei' to prevent you writing rules
with LHSs with a complicated desugaring (and hence unlikely to match);
(e.g. a case expression is not allowed: too elaborate.)

But there are legitimate non-trivial args ei, like sections and
lambdas.  So it seems simmpler not to check at all, and that is why
check_e is commented out.
-}</span><span>
</span><a name="line-1090"></a><span>
</span><a name="line-1091"></a><span class="hs-identifier">checkValidRule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1092"></a><a name="checkValidRule"><a href="RnSource.html#checkValidRule"><span class="hs-identifier">checkValidRule</span></a></a><span> </span><a name="local-6989586621682272343"><a href="#local-6989586621682272343"><span class="hs-identifier">rule_name</span></a></a><span> </span><a name="local-6989586621682272344"><a href="#local-6989586621682272344"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621682272345"><a href="#local-6989586621682272345"><span class="hs-identifier">lhs'</span></a></a><span> </span><a name="local-6989586621682272346"><a href="#local-6989586621682272346"><span class="hs-identifier">fv_lhs'</span></a></a><span>
</span><a name="line-1093"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- Check for the form of the LHS</span><span>
</span><a name="line-1094"></a><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="RnSource.html#validRuleLhs"><span class="hs-identifier hs-var">validRuleLhs</span></a><span> </span><a href="#local-6989586621682272344"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621682272345"><span class="hs-identifier hs-var">lhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1095"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1096"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682272347"><a href="#local-6989586621682272347"><span class="hs-identifier">bad</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#badRuleLhsErr"><span class="hs-identifier hs-var">badRuleLhsErr</span></a><span> </span><a href="#local-6989586621682272343"><span class="hs-identifier hs-var">rule_name</span></a><span> </span><a href="#local-6989586621682272345"><span class="hs-identifier hs-var">lhs'</span></a><span> </span><a href="#local-6989586621682272347"><span class="hs-identifier hs-var">bad</span></a><span class="hs-special">)</span><span>
</span><a name="line-1097"></a><span>
</span><a name="line-1098"></a><span>                </span><span class="hs-comment">-- Check that LHS vars are all bound</span><span>
</span><a name="line-1099"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272348"><a href="#local-6989586621682272348"><span class="hs-identifier">bad_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272349"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682272349"><a href="#local-6989586621682272349"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272344"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272349"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272346"><span class="hs-identifier hs-var">fv_lhs'</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1100"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="RnSource.html#badRuleVar"><span class="hs-identifier hs-var">badRuleVar</span></a><span> </span><a href="#local-6989586621682272343"><span class="hs-identifier hs-var">rule_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272348"><span class="hs-identifier hs-var">bad_vars</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1101"></a><span>
</span><a name="line-1102"></a><span class="hs-identifier">validRuleLhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1103"></a><span class="hs-comment">-- Nothing =&gt; OK</span><span>
</span><a name="line-1104"></a><span class="hs-comment">-- Just e  =&gt; Not ok, and e is the offending sub-expression</span><span>
</span><a name="line-1105"></a><a name="validRuleLhs"><a href="RnSource.html#validRuleLhs"><span class="hs-identifier">validRuleLhs</span></a></a><span> </span><a name="local-6989586621682272350"><a href="#local-6989586621682272350"><span class="hs-identifier">foralls</span></a></a><span> </span><a name="local-6989586621682272351"><a href="#local-6989586621682272351"><span class="hs-identifier">lhs</span></a></a><span>
</span><a name="line-1106"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272352"><span class="hs-identifier hs-var">checkl</span></a><span> </span><a href="#local-6989586621682272351"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-1107"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1108"></a><span>    </span><a name="local-6989586621682272352"><a href="#local-6989586621682272352"><span class="hs-identifier">checkl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272353"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span>
</span><a name="line-1109"></a><span>
</span><a name="line-1110"></a><span>    </span><a name="local-6989586621682272353"><a href="#local-6989586621682272353"><span class="hs-identifier">check</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272355"><a href="#local-6989586621682272355"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621682272356"><a href="#local-6989586621682272356"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621682272357"><a href="#local-6989586621682272357"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272352"><span class="hs-identifier hs-var">checkl</span></a><span> </span><a href="#local-6989586621682272356"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mplus</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272354"><span class="hs-identifier hs-var">checkl_e</span></a><span> </span><a href="#local-6989586621682272355"><span class="hs-identifier hs-var">e1</span></a><span>
</span><a name="line-1111"></a><span>                                                      </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mplus</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272354"><span class="hs-identifier hs-var">checkl_e</span></a><span> </span><a href="#local-6989586621682272357"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1112"></a><span>    </span><span class="hs-identifier">check</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272358"><a href="#local-6989586621682272358"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621682272359"><a href="#local-6989586621682272359"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272352"><span class="hs-identifier hs-var">checkl</span></a><span> </span><a href="#local-6989586621682272358"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mplus</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272354"><span class="hs-identifier hs-var">checkl_e</span></a><span> </span><a href="#local-6989586621682272359"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-1113"></a><span>    </span><span class="hs-identifier">check</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppType</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272360"><a href="#local-6989586621682272360"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272352"><span class="hs-identifier hs-var">checkl</span></a><span> </span><a href="#local-6989586621682272360"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1114"></a><span>    </span><span class="hs-identifier">check</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272361"><a href="#local-6989586621682272361"><span class="hs-identifier">lv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1115"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272361"><span class="hs-identifier hs-var">lv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272350"><span class="hs-identifier hs-var">foralls</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1116"></a><span>    </span><span class="hs-identifier">check</span><span> </span><a name="local-6989586621682272362"><a href="#local-6989586621682272362"><span class="hs-identifier">other</span></a></a><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272362"><span class="hs-identifier hs-var">other</span></a><span>  </span><span class="hs-comment">-- Failure</span><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><span>        </span><span class="hs-comment">-- Check an argument</span><span>
</span><a name="line-1119"></a><span>    </span><a name="local-6989586621682272354"><a href="#local-6989586621682272354"><span class="hs-identifier">checkl_e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1120"></a><span>    </span><span class="hs-comment">-- Was (check_e e); see Note [Rule LHS validity checking]</span><span>
</span><a name="line-1121"></a><span>
</span><a name="line-1122"></a><span class="hs-comment">{-      Commented out; see Note [Rule LHS validity checking] above
    check_e (HsVar v)     = Nothing
    check_e (HsPar e)     = checkl_e e
    check_e (HsLit e)     = Nothing
    check_e (HsOverLit e) = Nothing

    check_e (OpApp e1 op _ e2)   = checkl_e e1 `mplus` checkl_e op `mplus` checkl_e e2
    check_e (HsApp e1 e2)        = checkl_e e1 `mplus` checkl_e e2
    check_e (NegApp e _)         = checkl_e e
    check_e (ExplicitList _ es)  = checkl_es es
    check_e other                = Just other   -- Fails

    checkl_es es = foldr (mplus . checkl_e) Nothing es
-}</span><span>
</span><a name="line-1136"></a><span>
</span><a name="line-1137"></a><span class="hs-identifier">badRuleVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1138"></a><a name="badRuleVar"><a href="RnSource.html#badRuleVar"><span class="hs-identifier">badRuleVar</span></a></a><span> </span><a name="local-6989586621682272363"><a href="#local-6989586621682272363"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682272364"><a href="#local-6989586621682272364"><span class="hs-identifier">var</span></a></a><span>
</span><a name="line-1139"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Rule&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">doubleQuotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ftext</span><span> </span><a href="#local-6989586621682272363"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">,</span><span>
</span><a name="line-1140"></a><span>         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Forall'd variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272364"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1141"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;does not appear on left hand side&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1142"></a><span>
</span><a name="line-1143"></a><span class="hs-identifier">badRuleLhsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1144"></a><a name="badRuleLhsErr"><a href="RnSource.html#badRuleLhsErr"><span class="hs-identifier">badRuleLhsErr</span></a></a><span> </span><a name="local-6989586621682272365"><a href="#local-6989586621682272365"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682272366"><a href="#local-6989586621682272366"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621682272367"><a href="#local-6989586621682272367"><span class="hs-identifier">bad_e</span></a></a><span>
</span><a name="line-1145"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Rule&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprRuleName</span><span> </span><a href="#local-6989586621682272365"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">,</span><span>
</span><a name="line-1146"></a><span>         </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272368"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">,</span><span>
</span><a name="line-1147"></a><span>                       </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in left-hand side:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272366"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1148"></a><span>    </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1149"></a><span>    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;LHS must be of form (f e1 .. en) where f is not forall'd&quot;</span><span>
</span><a name="line-1150"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1151"></a><span>    </span><a name="local-6989586621682272368"><a href="#local-6989586621682272368"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272367"><span class="hs-identifier hs-var">bad_e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1152"></a><span>            </span><span class="hs-identifier hs-var">HsUnboundVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272369"><a href="#local-6989586621682272369"><span class="hs-identifier">uv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnUnbound.html#notInScopeErr"><span class="hs-identifier hs-var">notInScopeErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRdrUnqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unboundVarOcc</span><span> </span><a href="#local-6989586621682272369"><span class="hs-identifier hs-var">uv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1153"></a><span>            </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal expression:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272367"><span class="hs-identifier hs-var">bad_e</span></a><span>
</span><a name="line-1154"></a><span>
</span><a name="line-1155"></a><span class="hs-comment">{- **************************************************************
         *                                                      *
      Renaming type, class, instance and role declarations
*                                                               *
*****************************************************************

@rnTyDecl@ uses the `global name function' to create a new type
declaration in which local names have been replaced by their original
names, reporting any unknown names.

Renaming type variables is a pain. Because they now contain uniques,
it is necessary to pass in an association list which maps a parsed
tyvar to its @Name@ representation.
In some cases (type signatures of values),
it is even necessary to go over the type first
in order to get the set of tyvars used by it, make an assoc list,
and then go over it again to rename the tyvars!
However, we can also do some scoping checks at the same time.

Note [Dependency analysis of type, class, and instance decls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A TyClGroup represents a strongly connected components of
type/class/instance decls, together with the role annotations for the
type/class declarations.  The renamer uses strongly connected
comoponent analysis to build these groups.  We do this for a number of
reasons:

* Improve kind error messages. Consider

     data T f a = MkT f a
     data S f a = MkS f (T f a)

  This has a kind error, but the error message is better if you
  check T first, (fixing its kind) and *then* S.  If you do kind
  inference together, you might get an error reported in S, which
  is jolly confusing.  See Trac #4875


* Increase kind polymorphism.  See TcTyClsDecls
  Note [Grouping of type and class declarations]

Why do the instance declarations participate?  At least two reasons

* Consider (Trac #11348)

     type family F a
     type instance F Int = Bool

     data R = MkR (F Int)

     type Foo = 'MkR 'True

  For Foo to kind-check we need to know that (F Int) ~ Bool.  But we won't
  know that unless we've looked at the type instance declaration for F
  before kind-checking Foo.

* Another example is this (Trac #3990).

     data family Complex a
     data instance Complex Double = CD {-# UNPACK #-} !Double
                                       {-# UNPACK #-} !Double

     data T = T {-# UNPACK #-} !(Complex Double)

  Here, to generate the right kind of unpacked implementation for T,
  we must have access to the 'data instance' declaration.

* Things become more complicated when we introduce transitive
  dependencies through imported definitions, like in this scenario:

      A.hs
        type family Closed (t :: Type) :: Type where
          Closed t = Open t

        type family Open (t :: Type) :: Type

      B.hs
        data Q where
          Q :: Closed Bool -&gt; Q

        type instance Open Int = Bool

        type S = 'Q 'True

  Somehow, we must ensure that the instance Open Int = Bool is checked before
  the type synonym S. While we know that S depends upon 'Q depends upon Closed,
  we have no idea that Closed depends upon Open!

  To accomodate for these situations, we ensure that an instance is checked
  before every @TyClDecl@ on which it does not depend. That's to say, instances
  are checked as early as possible in @tcTyAndClassDecls@.

------------------------------------
So much for WHY.  What about HOW?  It's pretty easy:

(1) Rename the type/class, instance, and role declarations
    individually

(2) Do strongly-connected component analysis of the type/class decls,
    We'll make a TyClGroup for each SCC

    In this step we treat a reference to a (promoted) data constructor
    K as a dependency on its parent type.  Thus
        data T = K1 | K2
        data S = MkS (Proxy 'K1)
    Here S depends on 'K1 and hence on its parent T.

    In this step we ignore instances; see
    Note [No dependencies on data instances]

(3) Attach roles to the appropriate SCC

(4) Attach instances to the appropriate SCC.
    We add an instance decl to SCC when:
      all its free types/classes are bound in this SCC or earlier ones

(5) We make an initial TyClGroup, with empty group_tyclds, for any
    (orphan) instances that affect only imported types/classes

Steps (3) and (4) are done by the (mapAccumL mk_group) call.

Note [No dependencies on data instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
   data family D a
   data instance D Int = D1
   data S = MkS (Proxy 'D1)

Here the declaration of S depends on the /data instance/ declaration
for 'D Int'.  That makes things a lot more complicated, especially
if the data instance is an associated type of an enclosing class instance.
(And the class instance might have several associated type instances
with different dependency structure!)

Ugh.  For now we simply don't allow promotion of data constructors for
data instances.  See Note [AFamDataCon: not promoting data family
constructors] in TcEnv
-}</span><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span class="hs-identifier">rnTyClDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-1296"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1297"></a><span class="hs-comment">-- Rename the declarations and do dependency analysis on them</span><span>
</span><a name="line-1298"></a><a name="rnTyClDecls"><a href="RnSource.html#rnTyClDecls"><span class="hs-identifier">rnTyClDecls</span></a></a><span> </span><a name="local-6989586621682272370"><a href="#local-6989586621682272370"><span class="hs-identifier">tycl_ds</span></a></a><span>
</span><a name="line-1299"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Rename the type/class, instance, and role declaraations</span><span>
</span><a name="line-1300"></a><span>         </span><a name="local-6989586621682272382"><a href="#local-6989586621682272382"><span class="hs-identifier">tycls_w_fvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span> </span><a href="RnSource.html#rnTyClDecl"><span class="hs-identifier hs-var">rnTyClDecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1301"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyClGroupTyClDecls</span><span> </span><a href="#local-6989586621682272370"><span class="hs-identifier hs-var">tycl_ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1302"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272383"><a href="#local-6989586621682272383"><span class="hs-identifier">tc_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcdName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272382"><span class="hs-identifier hs-var">tycls_w_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1303"></a><span>
</span><a name="line-1304"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272384"><a href="#local-6989586621682272384"><span class="hs-identifier">instds_w_fvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span> </span><a href="RnSource.html#rnSrcInstDecl"><span class="hs-identifier hs-var">rnSrcInstDecl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyClGroupInstDecls</span><span> </span><a href="#local-6989586621682272370"><span class="hs-identifier hs-var">tycl_ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1305"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272385"><a href="#local-6989586621682272385"><span class="hs-identifier">role_annots</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnRoleAnnots"><span class="hs-identifier hs-var">rnRoleAnnots</span></a><span> </span><a href="#local-6989586621682272383"><span class="hs-identifier hs-var">tc_names</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyClGroupRoleDecls</span><span> </span><a href="#local-6989586621682272370"><span class="hs-identifier hs-var">tycl_ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1306"></a><span>
</span><a name="line-1307"></a><span>       </span><span class="hs-comment">-- Do SCC analysis on the type/class decls</span><span>
</span><a name="line-1308"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272386"><a href="#local-6989586621682272386"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-1309"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272387"><a href="#local-6989586621682272387"><span class="hs-identifier">tycl_sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#depAnalTyClDecls"><span class="hs-identifier hs-var">depAnalTyClDecls</span></a><span> </span><a href="#local-6989586621682272386"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682272382"><span class="hs-identifier hs-var">tycls_w_fvs</span></a><span>
</span><a name="line-1310"></a><span>             </span><a name="local-6989586621682272388"><a href="#local-6989586621682272388"><span class="hs-identifier">role_annot_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRoleAnnotEnv</span><span> </span><a href="#local-6989586621682272385"><span class="hs-identifier hs-var">role_annots</span></a><span>
</span><a name="line-1311"></a><span>
</span><a name="line-1312"></a><span>             </span><a name="local-6989586621682272389"><a href="#local-6989586621682272389"><span class="hs-identifier">inst_ds_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#mkInstDeclFreeVarsMap"><span class="hs-identifier hs-var">mkInstDeclFreeVarsMap</span></a><span> </span><a href="#local-6989586621682272386"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682272383"><span class="hs-identifier hs-var">tc_names</span></a><span> </span><a href="#local-6989586621682272384"><span class="hs-identifier hs-var">instds_w_fvs</span></a><span>
</span><a name="line-1313"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682272390"><a href="#local-6989586621682272390"><span class="hs-identifier">init_inst_ds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272391"><a href="#local-6989586621682272391"><span class="hs-identifier">rest_inst_ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#getInsts"><span class="hs-identifier hs-var">getInsts</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682272389"><span class="hs-identifier hs-var">inst_ds_map</span></a><span>
</span><a name="line-1314"></a><span>
</span><a name="line-1315"></a><span>             </span><a name="local-6989586621682272392"><a href="#local-6989586621682272392"><span class="hs-identifier">first_group</span></a></a><span>
</span><a name="line-1316"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682272390"><span class="hs-identifier hs-var">init_inst_ds</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1317"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TyClGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_ext</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-1318"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1319"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_roles</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1320"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_instds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272390"><span class="hs-identifier hs-var">init_inst_ds</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">]</span><span>
</span><a name="line-1321"></a><span>
</span><a name="line-1322"></a><span>             </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682272393"><a href="#local-6989586621682272393"><span class="hs-identifier">final_inst_ds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272394"><a href="#local-6989586621682272394"><span class="hs-identifier">orphan_roles</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272395"><a href="#local-6989586621682272395"><span class="hs-identifier">groups</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1323"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621682272371"><span class="hs-identifier hs-var">mk_group</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272391"><span class="hs-identifier hs-var">rest_inst_ds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272388"><span class="hs-identifier hs-var">role_annot_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272387"><span class="hs-identifier hs-var">tycl_sccs</span></a><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span>
</span><a name="line-1326"></a><span>             </span><a name="local-6989586621682272396"><a href="#local-6989586621682272396"><span class="hs-identifier">all_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusFV</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">plusFV</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span> </span><a href="#local-6989586621682272382"><span class="hs-identifier hs-var">tycls_w_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1327"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">plusFV</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span> </span><a href="#local-6989586621682272384"><span class="hs-identifier hs-var">instds_w_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1328"></a><span>
</span><a name="line-1329"></a><span>             </span><a name="local-6989586621682272397"><a href="#local-6989586621682272397"><span class="hs-identifier">all_groups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272392"><span class="hs-identifier hs-var">first_group</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272395"><span class="hs-identifier hs-var">groups</span></a><span>
</span><a name="line-1330"></a><span>
</span><a name="line-1331"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">final_inst_ds</span><span class="hs-special">,</span><span>  </span><a href="#local-6989586621682272393"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-identifier">instds_w_fvs</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">inst_ds_map</span><span>
</span><a name="line-1332"></a><span>                                       </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">flattenSCCs</span><span> </span><span class="hs-identifier">tycl_sccs</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">final_inst_ds</span><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-1333"></a><span>         </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="RnSource.html#orphanRoleAnnotErr"><span class="hs-identifier hs-var">orphanRoleAnnotErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameEnvElts</span><span> </span><a href="#local-6989586621682272394"><span class="hs-identifier hs-var">orphan_roles</span></a><span class="hs-special">)</span><span>
</span><a name="line-1334"></a><span>
</span><a name="line-1335"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnTycl dependency analysis made groups&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272397"><span class="hs-identifier hs-var">all_groups</span></a><span class="hs-special">)</span><span>
</span><a name="line-1336"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272397"><span class="hs-identifier hs-var">all_groups</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272396"><span class="hs-identifier hs-var">all_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1337"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1338"></a><span>    </span><span class="hs-identifier">mk_group</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="RnSource.html#InstDeclFreeVarsMap"><span class="hs-identifier hs-type">InstDeclFreeVarsMap</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RoleAnnotEnv</span><span class="hs-special">)</span><span>
</span><a name="line-1339"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LTyClDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="RnSource.html#InstDeclFreeVarsMap"><span class="hs-identifier hs-type">InstDeclFreeVarsMap</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RoleAnnotEnv</span><span class="hs-special">)</span><span>
</span><a name="line-1341"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1342"></a><span>    </span><a name="local-6989586621682272371"><a href="#local-6989586621682272371"><span class="hs-identifier">mk_group</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682272372"><a href="#local-6989586621682272372"><span class="hs-identifier">inst_map</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272373"><a href="#local-6989586621682272373"><span class="hs-identifier">role_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272374"><a href="#local-6989586621682272374"><span class="hs-identifier">scc</span></a></a><span>
</span><a name="line-1343"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682272378"><span class="hs-identifier hs-var">inst_map'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272380"><span class="hs-identifier hs-var">role_env'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272381"><span class="hs-identifier hs-var">group</span></a><span class="hs-special">)</span><span>
</span><a name="line-1344"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1345"></a><span>        </span><a name="local-6989586621682272375"><a href="#local-6989586621682272375"><span class="hs-identifier">tycl_ds</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flattenSCC</span><span> </span><a href="#local-6989586621682272374"><span class="hs-identifier hs-var">scc</span></a><span>
</span><a name="line-1346"></a><span>        </span><a name="local-6989586621682272376"><a href="#local-6989586621682272376"><span class="hs-identifier">bndrs</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcdName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272375"><span class="hs-identifier hs-var">tycl_ds</span></a><span>
</span><a name="line-1347"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682272377"><a href="#local-6989586621682272377"><span class="hs-identifier">inst_ds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272378"><a href="#local-6989586621682272378"><span class="hs-identifier">inst_map'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#getInsts"><span class="hs-identifier hs-var">getInsts</span></a><span>      </span><a href="#local-6989586621682272376"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621682272372"><span class="hs-identifier hs-var">inst_map</span></a><span>
</span><a name="line-1348"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682272379"><a href="#local-6989586621682272379"><span class="hs-identifier">roles</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682272380"><a href="#local-6989586621682272380"><span class="hs-identifier">role_env'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getRoleAnnots</span><span> </span><a href="#local-6989586621682272376"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621682272373"><span class="hs-identifier hs-var">role_env</span></a><span>
</span><a name="line-1349"></a><span>        </span><a name="local-6989586621682272381"><a href="#local-6989586621682272381"><span class="hs-identifier">group</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TyClGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_ext</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-1350"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272375"><span class="hs-identifier hs-var">tycl_ds</span></a><span>
</span><a name="line-1351"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_roles</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272379"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-1352"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_instds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272377"><span class="hs-identifier hs-var">inst_ds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1353"></a><span>
</span><a name="line-1354"></a><span>
</span><a name="line-1355"></a><span class="hs-identifier">depAnalTyClDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-1356"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LTyClDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1357"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LTyClDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1358"></a><span class="hs-comment">-- See Note [Dependency analysis of type, class, and instance decls]</span><span>
</span><a name="line-1359"></a><a name="depAnalTyClDecls"><a href="RnSource.html#depAnalTyClDecls"><span class="hs-identifier">depAnalTyClDecls</span></a></a><span> </span><a name="local-6989586621682272398"><a href="#local-6989586621682272398"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621682272399"><a href="#local-6989586621682272399"><span class="hs-identifier">ds_w_fvs</span></a></a><span>
</span><a name="line-1360"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniq</span><span> </span><a href="#local-6989586621682272400"><span class="hs-identifier hs-var">edges</span></a><span>
</span><a name="line-1361"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1362"></a><span>    </span><span class="hs-identifier">edges</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-type">Node</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LTyClDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1363"></a><span>    </span><a name="local-6989586621682272400"><a href="#local-6989586621682272400"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><a href="#local-6989586621682272401"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcdName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272401"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="RnSource.html#getParent"><span class="hs-identifier hs-var">getParent</span></a><span> </span><a href="#local-6989586621682272398"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><a href="#local-6989586621682272402"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1364"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272401"><a href="#local-6989586621682272401"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272402"><a href="#local-6989586621682272402"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272399"><span class="hs-identifier hs-var">ds_w_fvs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1365"></a><span>            </span><span class="hs-comment">-- It's OK to use nonDetEltsUFM here as</span><span>
</span><a name="line-1366"></a><span>            </span><span class="hs-comment">-- stronglyConnCompFromEdgedVertices is still deterministic</span><span>
</span><a name="line-1367"></a><span>            </span><span class="hs-comment">-- even if the edges are in nondeterministic order as explained</span><span>
</span><a name="line-1368"></a><span>            </span><span class="hs-comment">-- in Note [Deterministic SCC] in Digraph.</span><span>
</span><a name="line-1369"></a><span>
</span><a name="line-1370"></a><span class="hs-identifier">toParents</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-1371"></a><a name="toParents"><a href="RnSource.html#toParents"><span class="hs-identifier">toParents</span></a></a><span> </span><a name="local-6989586621682272403"><a href="#local-6989586621682272403"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621682272404"><a href="#local-6989586621682272404"><span class="hs-identifier">ns</span></a></a><span>
</span><a name="line-1372"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nonDetFoldUniqSet</span><span> </span><a href="#local-6989586621682272405"><span class="hs-identifier hs-var">add</span></a><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><a href="#local-6989586621682272404"><span class="hs-identifier hs-var">ns</span></a><span>
</span><a name="line-1373"></a><span>  </span><span class="hs-comment">-- It's OK to use nonDetFoldUFM because we immediately forget the</span><span>
</span><a name="line-1374"></a><span>  </span><span class="hs-comment">-- ordering by creating a set</span><span>
</span><a name="line-1375"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1376"></a><span>    </span><a name="local-6989586621682272405"><a href="#local-6989586621682272405"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621682272406"><a href="#local-6989586621682272406"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682272407"><a href="#local-6989586621682272407"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameSet</span><span> </span><a href="#local-6989586621682272407"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#getParent"><span class="hs-identifier hs-var">getParent</span></a><span> </span><a href="#local-6989586621682272403"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682272406"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1377"></a><span>
</span><a name="line-1378"></a><span class="hs-identifier">getParent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1379"></a><a name="getParent"><a href="RnSource.html#getParent"><span class="hs-identifier">getParent</span></a></a><span> </span><a name="local-6989586621682272408"><a href="#local-6989586621682272408"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621682272409"><a href="#local-6989586621682272409"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-1380"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupGRE_Name</span><span> </span><a href="#local-6989586621682272408"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682272409"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1381"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682272410"><a href="#local-6989586621682272410"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">gre_par</span><span> </span><a href="#local-6989586621682272410"><span class="hs-identifier hs-var">gre</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1382"></a><span>                    </span><span class="hs-identifier hs-var">ParentIs</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">par_is</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272411"><a href="#local-6989586621682272411"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272411"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1383"></a><span>                    </span><span class="hs-identifier hs-var">FldParent</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">par_is</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272412"><a href="#local-6989586621682272412"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272412"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1384"></a><span>                    </span><span class="hs-identifier">_</span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272409"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1385"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272409"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1386"></a><span>
</span><a name="line-1387"></a><span>
</span><a name="line-1388"></a><span class="hs-comment">{- ******************************************************
*                                                       *
       Role annotations
*                                                       *
****************************************************** -}</span><span>
</span><a name="line-1393"></a><span>
</span><a name="line-1394"></a><span class="hs-comment">-- | Renames role annotations, returning them as the values in a NameEnv</span><span>
</span><a name="line-1395"></a><span class="hs-comment">-- and checks for duplicate role annotations.</span><span>
</span><a name="line-1396"></a><span class="hs-comment">-- It is quite convenient to do both of these in the same place.</span><span>
</span><a name="line-1397"></a><span class="hs-comment">-- See also Note [Role annotations in the renamer]</span><span>
</span><a name="line-1398"></a><span class="hs-identifier">rnRoleAnnots</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-1399"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LRoleAnnotDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-1400"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LRoleAnnotDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1401"></a><a name="rnRoleAnnots"><a href="RnSource.html#rnRoleAnnots"><span class="hs-identifier">rnRoleAnnots</span></a></a><span> </span><a name="local-6989586621682272413"><a href="#local-6989586621682272413"><span class="hs-identifier">tc_names</span></a></a><span> </span><a name="local-6989586621682272414"><a href="#local-6989586621682272414"><span class="hs-identifier">role_annots</span></a></a><span>
</span><a name="line-1402"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Check for duplicates *before* renaming, to avoid</span><span>
</span><a name="line-1403"></a><span>          </span><span class="hs-comment">-- lumping together all the unboundNames</span><span>
</span><a name="line-1404"></a><span>         </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272419"><a href="#local-6989586621682272419"><span class="hs-identifier">no_dups</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272420"><a href="#local-6989586621682272420"><span class="hs-identifier">dup_annots</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">removeDups</span><span> </span><a href="#local-6989586621682272421"><span class="hs-identifier hs-var">role_annots_cmp</span></a><span> </span><a href="#local-6989586621682272414"><span class="hs-identifier hs-var">role_annots</span></a><span>
</span><a name="line-1405"></a><span>             </span><a name="local-6989586621682272421"><a href="#local-6989586621682272421"><span class="hs-identifier">role_annots_cmp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272422"><a href="#local-6989586621682272422"><span class="hs-identifier">annot1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272423"><a href="#local-6989586621682272423"><span class="hs-identifier">annot2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1406"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">roleAnnotDeclName</span><span> </span><a href="#local-6989586621682272422"><span class="hs-identifier hs-var">annot1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">roleAnnotDeclName</span><span> </span><a href="#local-6989586621682272423"><span class="hs-identifier hs-var">annot2</span></a><span>
</span><a name="line-1407"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="RnSource.html#dupRoleAnnotErr"><span class="hs-identifier hs-var">dupRoleAnnotErr</span></a><span> </span><a href="#local-6989586621682272420"><span class="hs-identifier hs-var">dup_annots</span></a><span>
</span><a name="line-1408"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="#local-6989586621682272415"><span class="hs-identifier hs-var">rn_role_annot1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272419"><span class="hs-identifier hs-var">no_dups</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1409"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1410"></a><span>    </span><a name="local-6989586621682272415"><a href="#local-6989586621682272415"><span class="hs-identifier">rn_role_annot1</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RoleAnnotDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272416"><a href="#local-6989586621682272416"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621682272417"><a href="#local-6989586621682272417"><span class="hs-identifier">roles</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1411"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- the name is an *occurrence*, but look it up only in the</span><span>
</span><a name="line-1412"></a><span>              </span><span class="hs-comment">-- decls defined in this group (see #10263)</span><span>
</span><a name="line-1413"></a><span>             </span><a name="local-6989586621682272418"><a href="#local-6989586621682272418"><span class="hs-identifier">tycon'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupSigCtxtOccRn"><span class="hs-identifier hs-var">lookupSigCtxtOccRn</span></a><span> </span><span class="hs-special">(</span><a href="RnEnv.html#RoleAnnotCtxt"><span class="hs-identifier hs-var">RoleAnnotCtxt</span></a><span> </span><a href="#local-6989586621682272413"><span class="hs-identifier hs-var">tc_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-1414"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;role annotation&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1415"></a><span>                                          </span><a href="#local-6989586621682272416"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1416"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">RoleAnnotDecl</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682272418"><span class="hs-identifier hs-var">tycon'</span></a><span> </span><a href="#local-6989586621682272417"><span class="hs-identifier hs-var">roles</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1417"></a><span>    </span><span class="hs-identifier">rn_role_annot1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XRoleAnnotDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnRoleAnnots&quot;</span><span>
</span><a name="line-1418"></a><span>
</span><a name="line-1419"></a><span class="hs-identifier">dupRoleAnnotErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NonEmpty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LRoleAnnotDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1420"></a><a name="dupRoleAnnotErr"><a href="RnSource.html#dupRoleAnnotErr"><span class="hs-identifier">dupRoleAnnotErr</span></a></a><span> </span><a name="local-6989586621682272424"><a href="#local-6989586621682272424"><span class="hs-identifier">list</span></a></a><span>
</span><a name="line-1421"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621682272426"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1422"></a><span>    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Duplicate role annotations for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1423"></a><span>          </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">roleAnnotDeclName</span><span> </span><a href="#local-6989586621682272427"><span class="hs-identifier hs-var">first_decl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-1424"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682272428"><span class="hs-identifier hs-var">pp_role_annot</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">NE.toList</span><span> </span><a href="#local-6989586621682272425"><span class="hs-identifier hs-var">sorted_list</span></a><span class="hs-special">)</span><span>
</span><a name="line-1425"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1426"></a><span>      </span><a name="local-6989586621682272425"><a href="#local-6989586621682272425"><span class="hs-identifier">sorted_list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NE.sortBy</span><span> </span><a href="#local-6989586621682272429"><span class="hs-identifier hs-var">cmp_annot</span></a><span> </span><a href="#local-6989586621682272424"><span class="hs-identifier hs-var">list</span></a><span>
</span><a name="line-1427"></a><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272426"><a href="#local-6989586621682272426"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272427"><a href="#local-6989586621682272427"><span class="hs-identifier">first_decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">:|</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272425"><span class="hs-identifier hs-var">sorted_list</span></a><span>
</span><a name="line-1428"></a><span>
</span><a name="line-1429"></a><span>      </span><a name="local-6989586621682272428"><a href="#local-6989586621682272428"><span class="hs-identifier">pp_role_annot</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272430"><a href="#local-6989586621682272430"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272431"><a href="#local-6989586621682272431"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272431"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1430"></a><span>                                      </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-- written at&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272430"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1431"></a><span>
</span><a name="line-1432"></a><span>      </span><a name="local-6989586621682272429"><a href="#local-6989586621682272429"><span class="hs-identifier">cmp_annot</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272432"><a href="#local-6989586621682272432"><span class="hs-identifier">loc1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272433"><a href="#local-6989586621682272433"><span class="hs-identifier">loc2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272432"><span class="hs-identifier hs-var">loc1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272433"><span class="hs-identifier hs-var">loc2</span></a><span>
</span><a name="line-1433"></a><span>
</span><a name="line-1434"></a><span class="hs-identifier">orphanRoleAnnotErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LRoleAnnotDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1435"></a><a name="orphanRoleAnnotErr"><a href="RnSource.html#orphanRoleAnnotErr"><span class="hs-identifier">orphanRoleAnnotErr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272434"><a href="#local-6989586621682272434"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272435"><a href="#local-6989586621682272435"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1436"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621682272434"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1437"></a><span>    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Role annotation for a type previously declared:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272435"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1439"></a><span>    </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The role annotation must be given where&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1440"></a><span>            </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">roleAnnotDeclName</span><span> </span><a href="#local-6989586621682272435"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1441"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is declared.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1442"></a><span>
</span><a name="line-1443"></a><span>
</span><a name="line-1444"></a><span class="hs-comment">{- Note [Role annotations in the renamer]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must ensure that a type's role annotation is put in the same group as the
proper type declaration. This is because role annotations are needed during
type-checking when creating the type's TyCon. So, rnRoleAnnots builds a
NameEnv (LRoleAnnotDecl Name) that maps a name to a role annotation for that
type, if any. Then, this map can be used to add the role annotations to the
groups after dependency analysis.

This process checks for duplicate role annotations, where we must be careful
to do the check *before* renaming to avoid calling all unbound names duplicates
of one another.

The renaming process, as usual, might identify and report errors for unbound
names. We exclude the annotations for unbound names in the annotation
environment to avoid spurious errors for orphaned annotations.

We then (in rnTyClDecls) do a check for orphan role annotations (role
annotations without an accompanying type decl). The check works by folding
over components (of type [[Either (TyClDecl Name) (InstDecl Name)]]), selecting
out the relevant role declarations for each group, as well as diminishing the
annotation environment. After the fold is complete, anything left over in the
name environment must be an orphan, and errors are generated.

An earlier version of this algorithm short-cut the orphan check by renaming
only with names declared in this module. But, this check is insufficient in
the case of staged module compilation (Template Haskell, GHCi).
See #8485. With the new lookup process (which includes types declared in other
modules), we get better error messages, too.
-}</span><span>
</span><a name="line-1474"></a><span>
</span><a name="line-1475"></a><span>
</span><a name="line-1476"></a><span class="hs-comment">{- ******************************************************
*                                                       *
       Dependency info for instances
*                                                       *
****************************************************** -}</span><span>
</span><a name="line-1481"></a><span>
</span><a name="line-1482"></a><span class="hs-comment">----------------------------------------------------------</span><span>
</span><a name="line-1483"></a><span class="hs-comment">-- | 'InstDeclFreeVarsMap is an association of an</span><span>
</span><a name="line-1484"></a><span class="hs-comment">--   @InstDecl@ with @FreeVars@. The @FreeVars@ are</span><span>
</span><a name="line-1485"></a><span class="hs-comment">--   the tycon names that are both</span><span>
</span><a name="line-1486"></a><span class="hs-comment">--     a) free in the instance declaration</span><span>
</span><a name="line-1487"></a><span class="hs-comment">--     b) bound by this group of type/class/instance decls</span><span>
</span><a name="line-1488"></a><span class="hs-keyword">type</span><span> </span><a name="InstDeclFreeVarsMap"><a href="RnSource.html#InstDeclFreeVarsMap"><span class="hs-identifier">InstDeclFreeVarsMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1489"></a><span>
</span><a name="line-1490"></a><span class="hs-comment">-- | Construct an @InstDeclFreeVarsMap@ by eliminating any @Name@s from the</span><span>
</span><a name="line-1491"></a><span class="hs-comment">--   @FreeVars@ which are *not* the binders of a @TyClDecl@.</span><span>
</span><a name="line-1492"></a><span class="hs-identifier">mkInstDeclFreeVarsMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-1493"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-1494"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1495"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnSource.html#InstDeclFreeVarsMap"><span class="hs-identifier hs-type">InstDeclFreeVarsMap</span></a><span>
</span><a name="line-1496"></a><a name="mkInstDeclFreeVarsMap"><a href="RnSource.html#mkInstDeclFreeVarsMap"><span class="hs-identifier">mkInstDeclFreeVarsMap</span></a></a><span> </span><a name="local-6989586621682272436"><a href="#local-6989586621682272436"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621682272437"><a href="#local-6989586621682272437"><span class="hs-identifier">tycl_bndrs</span></a></a><span> </span><a name="local-6989586621682272438"><a href="#local-6989586621682272438"><span class="hs-identifier">inst_ds_fvs</span></a></a><span>
</span><a name="line-1497"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272439"><span class="hs-identifier hs-var">inst_decl</span></a><span class="hs-special">,</span><span> </span><a href="RnSource.html#toParents"><span class="hs-identifier hs-var">toParents</span></a><span> </span><a href="#local-6989586621682272436"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682272440"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">intersectFVs</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272437"><span class="hs-identifier hs-var">tycl_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1498"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272439"><a href="#local-6989586621682272439"><span class="hs-identifier">inst_decl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272440"><a href="#local-6989586621682272440"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272438"><span class="hs-identifier hs-var">inst_ds_fvs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1499"></a><span>
</span><a name="line-1500"></a><span class="hs-comment">-- | Get the @LInstDecl@s which have empty @FreeVars@ sets, and the</span><span>
</span><a name="line-1501"></a><span class="hs-comment">--   @InstDeclFreeVarsMap@ with these entries removed.</span><span>
</span><a name="line-1502"></a><span class="hs-comment">-- We call (getInsts tcs instd_map) when we've completed the declarations</span><span>
</span><a name="line-1503"></a><span class="hs-comment">-- for 'tcs'.  The call returns (inst_decls, instd_map'), where</span><span>
</span><a name="line-1504"></a><span class="hs-comment">--   inst_decls are the instance declarations all of</span><span>
</span><a name="line-1505"></a><span class="hs-comment">--              whose free vars are now defined</span><span>
</span><a name="line-1506"></a><span class="hs-comment">--   instd_map' is the inst-decl map with 'tcs' removed from</span><span>
</span><a name="line-1507"></a><span class="hs-comment">--               the free-var set</span><span>
</span><a name="line-1508"></a><span class="hs-identifier">getInsts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnSource.html#InstDeclFreeVarsMap"><span class="hs-identifier hs-type">InstDeclFreeVarsMap</span></a><span>
</span><a name="line-1509"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="RnSource.html#InstDeclFreeVarsMap"><span class="hs-identifier hs-type">InstDeclFreeVarsMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-1510"></a><a name="getInsts"><a href="RnSource.html#getInsts"><span class="hs-identifier">getInsts</span></a></a><span> </span><a name="local-6989586621682272441"><a href="#local-6989586621682272441"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621682272442"><a href="#local-6989586621682272442"><span class="hs-identifier">inst_decl_map</span></a></a><span>
</span><a name="line-1511"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionWith</span><span> </span><a href="#local-6989586621682272443"><span class="hs-identifier hs-var">pick_me</span></a><span> </span><a href="#local-6989586621682272442"><span class="hs-identifier hs-var">inst_decl_map</span></a><span>
</span><a name="line-1512"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1513"></a><span>    </span><span class="hs-identifier">pick_me</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1514"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>    </span><a name="local-6989586621682272443"><a href="#local-6989586621682272443"><span class="hs-identifier">pick_me</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682272444"><a href="#local-6989586621682272444"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272445"><a href="#local-6989586621682272445"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1516"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyNameSet</span><span> </span><a href="#local-6989586621682272446"><span class="hs-identifier hs-var">depleted_fvs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621682272444"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-1517"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272444"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272446"><span class="hs-identifier hs-var">depleted_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1518"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1519"></a><span>        </span><a name="local-6989586621682272446"><a href="#local-6989586621682272446"><span class="hs-identifier">depleted_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">delFVs</span><span> </span><a href="#local-6989586621682272441"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621682272445"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-1520"></a><span>
</span><a name="line-1521"></a><span class="hs-comment">{- ******************************************************
*                                                       *
         Renaming a type or class declaration
*                                                       *
****************************************************** -}</span><span>
</span><a name="line-1526"></a><span>
</span><a name="line-1527"></a><span class="hs-identifier">rnTyClDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyClDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1528"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyClDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1529"></a><span>
</span><a name="line-1530"></a><span class="hs-comment">-- All flavours of type family declarations (&quot;type family&quot;, &quot;newtype family&quot;,</span><span>
</span><a name="line-1531"></a><span class="hs-comment">-- and &quot;data family&quot;), both top level and (for an associated type)</span><span>
</span><a name="line-1532"></a><span class="hs-comment">-- in a class decl</span><span>
</span><a name="line-1533"></a><a name="rnTyClDecl"><a href="RnSource.html#rnTyClDecl"><span class="hs-identifier">rnTyClDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdFam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272447"><a href="#local-6989586621682272447"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1534"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272448"><a href="#local-6989586621682272448"><span class="hs-identifier">decl'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272449"><a href="#local-6989586621682272449"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnFamDecl"><span class="hs-identifier hs-var">rnFamDecl</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272447"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-1535"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamDecl</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682272448"><span class="hs-identifier hs-var">decl'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272449"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1536"></a><span>
</span><a name="line-1537"></a><span class="hs-identifier">rnTyClDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SynDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272450"><a href="#local-6989586621682272450"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272451"><a href="#local-6989586621682272451"><span class="hs-identifier">tyvars</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1538"></a><span>                      </span><span class="hs-identifier">tcdFixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272452"><a href="#local-6989586621682272452"><span class="hs-identifier">fixity</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdRhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272453"><a href="#local-6989586621682272453"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1539"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272454"><a href="#local-6989586621682272454"><span class="hs-identifier">tycon'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocatedTopBndrRn"><span class="hs-identifier hs-var">lookupLocatedTopBndrRn</span></a><span> </span><a href="#local-6989586621682272450"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1540"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272455"><a href="#local-6989586621682272455"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractHsTyRdrTyVarsKindVars"><span class="hs-identifier hs-var">extractHsTyRdrTyVarsKindVars</span></a><span> </span><a href="#local-6989586621682272453"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1541"></a><span>             </span><a name="local-6989586621682272456"><a href="#local-6989586621682272456"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#TySynCtx"><span class="hs-identifier hs-var">TySynCtx</span></a><span> </span><a href="#local-6989586621682272450"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1542"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rntycl-ty&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272450"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272455"><span class="hs-identifier hs-var">kvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1543"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnTypes.html#bindHsQTyVars"><span class="hs-identifier hs-var">bindHsQTyVars</span></a><span> </span><a href="#local-6989586621682272456"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272455"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="#local-6989586621682272451"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272457"><a href="#local-6989586621682272457"><span class="hs-identifier">tyvars'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1544"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272458"><a href="#local-6989586621682272458"><span class="hs-identifier">rhs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272459"><a href="#local-6989586621682272459"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnTySyn"><span class="hs-identifier hs-var">rnTySyn</span></a><span> </span><a href="#local-6989586621682272456"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272453"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1545"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SynDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272454"><span class="hs-identifier hs-var">tycon'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272457"><span class="hs-identifier hs-var">tyvars'</span></a><span>
</span><a name="line-1546"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdFixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272452"><span class="hs-identifier hs-var">fixity</span></a><span>
</span><a name="line-1547"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdRhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272458"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdSExt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272459"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272459"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1548"></a><span>
</span><a name="line-1549"></a><span class="hs-comment">-- &quot;data&quot;, &quot;newtype&quot; declarations</span><span>
</span><a name="line-1550"></a><span class="hs-comment">-- both top level and (for an associated type) in an instance decl</span><span>
</span><a name="line-1551"></a><span class="hs-identifier">rnTyClDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272460"><a href="#local-6989586621682272460"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272461"><a href="#local-6989586621682272461"><span class="hs-identifier">tyvars</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1552"></a><span>                       </span><span class="hs-identifier">tcdFixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272462"><a href="#local-6989586621682272462"><span class="hs-identifier">fixity</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdDataDefn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272463"><a href="#local-6989586621682272463"><span class="hs-identifier">defn</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1553"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272464"><a href="#local-6989586621682272464"><span class="hs-identifier">tycon'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocatedTopBndrRn"><span class="hs-identifier hs-var">lookupLocatedTopBndrRn</span></a><span> </span><a href="#local-6989586621682272460"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1554"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272465"><a href="#local-6989586621682272465"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractDataDefnKindVars"><span class="hs-identifier hs-var">extractDataDefnKindVars</span></a><span> </span><a href="#local-6989586621682272463"><span class="hs-identifier hs-var">defn</span></a><span>
</span><a name="line-1555"></a><span>             </span><a name="local-6989586621682272466"><a href="#local-6989586621682272466"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#TyDataCtx"><span class="hs-identifier hs-var">TyDataCtx</span></a><span> </span><a href="#local-6989586621682272460"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1556"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rntycl-data&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272460"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272465"><span class="hs-identifier hs-var">kvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1557"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnTypes.html#bindHsQTyVars"><span class="hs-identifier hs-var">bindHsQTyVars</span></a><span> </span><a href="#local-6989586621682272466"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272465"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="#local-6989586621682272461"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272467"><a href="#local-6989586621682272467"><span class="hs-identifier">tyvars'</span></a></a><span> </span><a name="local-6989586621682272468"><a href="#local-6989586621682272468"><span class="hs-identifier">no_rhs_kvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1558"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272469"><a href="#local-6989586621682272469"><span class="hs-identifier">defn'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272470"><a href="#local-6989586621682272470"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnDataDefn"><span class="hs-identifier hs-var">rnDataDefn</span></a><span> </span><a href="#local-6989586621682272466"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272463"><span class="hs-identifier hs-var">defn</span></a><span>
</span><a name="line-1559"></a><span>          </span><span class="hs-comment">-- See Note [Complete user-supplied kind signatures] in HsDecls</span><span>
</span><a name="line-1560"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272471"><a href="#local-6989586621682272471"><span class="hs-identifier">cusk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsTvbAllKinded</span><span> </span><a href="#local-6989586621682272467"><span class="hs-identifier hs-var">tyvars'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682272468"><span class="hs-identifier hs-var">no_rhs_kvs</span></a><span>
</span><a name="line-1561"></a><span>             </span><a name="local-6989586621682272472"><a href="#local-6989586621682272472"><span class="hs-identifier">rn_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DataDeclRn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdDataCusk</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272471"><span class="hs-identifier hs-var">cusk</span></a><span>
</span><a name="line-1562"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdFVs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272470"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1563"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rndata&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272460"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272471"><span class="hs-identifier hs-var">cusk</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272468"><span class="hs-identifier hs-var">no_rhs_kvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1564"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272464"><span class="hs-identifier hs-var">tycon'</span></a><span>
</span><a name="line-1565"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdTyVars</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272467"><span class="hs-identifier hs-var">tyvars'</span></a><span>
</span><a name="line-1566"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdFixity</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272462"><span class="hs-identifier hs-var">fixity</span></a><span>
</span><a name="line-1567"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdDataDefn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272469"><span class="hs-identifier hs-var">defn'</span></a><span>
</span><a name="line-1568"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdDExt</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272472"><span class="hs-identifier hs-var">rn_info</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272470"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1569"></a><span>
</span><a name="line-1570"></a><span class="hs-identifier">rnTyClDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClassDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdCtxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272473"><a href="#local-6989586621682272473"><span class="hs-identifier">context</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272474"><a href="#local-6989586621682272474"><span class="hs-identifier">lcls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1571"></a><span>                        </span><span class="hs-identifier">tcdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272475"><a href="#local-6989586621682272475"><span class="hs-identifier">tyvars</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdFixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272476"><a href="#local-6989586621682272476"><span class="hs-identifier">fixity</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1572"></a><span>                        </span><span class="hs-identifier">tcdFDs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272477"><a href="#local-6989586621682272477"><span class="hs-identifier">fds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdSigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272478"><a href="#local-6989586621682272478"><span class="hs-identifier">sigs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1573"></a><span>                        </span><span class="hs-identifier">tcdMeths</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272479"><a href="#local-6989586621682272479"><span class="hs-identifier">mbinds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272480"><a href="#local-6989586621682272480"><span class="hs-identifier">ats</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATDefs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272481"><a href="#local-6989586621682272481"><span class="hs-identifier">at_defs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1574"></a><span>                        </span><span class="hs-identifier">tcdDocs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272482"><a href="#local-6989586621682272482"><span class="hs-identifier">docs</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1575"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272484"><a href="#local-6989586621682272484"><span class="hs-identifier">lcls'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocatedTopBndrRn"><span class="hs-identifier hs-var">lookupLocatedTopBndrRn</span></a><span> </span><a href="#local-6989586621682272474"><span class="hs-identifier hs-var">lcls</span></a><span>
</span><a name="line-1576"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272485"><a href="#local-6989586621682272485"><span class="hs-identifier">cls'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272484"><span class="hs-identifier hs-var">lcls'</span></a><span>
</span><a name="line-1577"></a><span>              </span><a name="local-6989586621682272486"><a href="#local-6989586621682272486"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- No scoped kind vars except those in</span><span>
</span><a name="line-1578"></a><span>                        </span><span class="hs-comment">-- kind signatures on the tyvars</span><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span>        </span><span class="hs-comment">-- Tyvars scope over superclass context and method signatures</span><span>
</span><a name="line-1581"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682272494"><a href="#local-6989586621682272494"><span class="hs-identifier">tyvars'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272495"><a href="#local-6989586621682272495"><span class="hs-identifier">context'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272496"><a href="#local-6989586621682272496"><span class="hs-identifier">fds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272497"><a href="#local-6989586621682272497"><span class="hs-identifier">ats'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272498"><a href="#local-6989586621682272498"><span class="hs-identifier">stuff_fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1582"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#bindHsQTyVars"><span class="hs-identifier hs-var">bindHsQTyVars</span></a><span> </span><a href="#local-6989586621682272483"><span class="hs-identifier hs-var">cls_doc</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272486"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="#local-6989586621682272475"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272487"><a href="#local-6989586621682272487"><span class="hs-identifier">tyvars'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1583"></a><span>                  </span><span class="hs-comment">-- Checks for distinct tyvars</span><span>
</span><a name="line-1584"></a><span>             </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272488"><a href="#local-6989586621682272488"><span class="hs-identifier">context'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272489"><a href="#local-6989586621682272489"><span class="hs-identifier">cxt_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnContext"><span class="hs-identifier hs-var">rnContext</span></a><span> </span><a href="#local-6989586621682272483"><span class="hs-identifier hs-var">cls_doc</span></a><span> </span><a href="#local-6989586621682272473"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-1585"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272490"><a href="#local-6989586621682272490"><span class="hs-identifier">fds'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnFds"><span class="hs-identifier hs-var">rnFds</span></a><span> </span><a href="#local-6989586621682272477"><span class="hs-identifier hs-var">fds</span></a><span>
</span><a name="line-1586"></a><span>                         </span><span class="hs-comment">-- The fundeps have no free variables</span><span>
</span><a name="line-1587"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272491"><a href="#local-6989586621682272491"><span class="hs-identifier">ats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272492"><a href="#local-6989586621682272492"><span class="hs-identifier">fv_ats</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnATDecls"><span class="hs-identifier hs-var">rnATDecls</span></a><span> </span><a href="#local-6989586621682272485"><span class="hs-identifier hs-var">cls'</span></a><span> </span><a href="#local-6989586621682272480"><span class="hs-identifier hs-var">ats</span></a><span>
</span><a name="line-1588"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272493"><a href="#local-6989586621682272493"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272489"><span class="hs-identifier hs-var">cxt_fvs</span></a><span>     </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span>
</span><a name="line-1589"></a><span>                         </span><a href="#local-6989586621682272492"><span class="hs-identifier hs-var">fv_ats</span></a><span>
</span><a name="line-1590"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682272487"><span class="hs-identifier hs-var">tyvars'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272488"><span class="hs-identifier hs-var">context'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272490"><span class="hs-identifier hs-var">fds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272491"><span class="hs-identifier hs-var">ats'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272493"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1591"></a><span>
</span><a name="line-1592"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272499"><a href="#local-6989586621682272499"><span class="hs-identifier">at_defs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272500"><a href="#local-6989586621682272500"><span class="hs-identifier">fv_at_defs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#rnTyFamDefltEqn"><span class="hs-identifier hs-var">rnTyFamDefltEqn</span></a><span> </span><a href="#local-6989586621682272485"><span class="hs-identifier hs-var">cls'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272481"><span class="hs-identifier hs-var">at_defs</span></a><span>
</span><a name="line-1593"></a><span>
</span><a name="line-1594"></a><span>        </span><span class="hs-comment">-- No need to check for duplicate associated type decls</span><span>
</span><a name="line-1595"></a><span>        </span><span class="hs-comment">-- since that is done by RnNames.extendGlobalRdrEnvRn</span><span>
</span><a name="line-1596"></a><span>
</span><a name="line-1597"></a><span>        </span><span class="hs-comment">-- Check the signatures</span><span>
</span><a name="line-1598"></a><span>        </span><span class="hs-comment">-- First process the class op sigs (op_sigs), then the fixity sigs (non_op_sigs).</span><span>
</span><a name="line-1599"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272501"><a href="#local-6989586621682272501"><span class="hs-identifier">sig_rdr_names_w_locs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1600"></a><span>                </span><span class="hs-special">[</span><a href="#local-6989586621682272503"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClassOpSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621682272502"><a href="#local-6989586621682272502"><span class="hs-identifier">ops</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272478"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-1601"></a><span>                    </span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272503"><a href="#local-6989586621682272503"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272502"><span class="hs-identifier hs-var">ops</span></a><span class="hs-special">]</span><span>
</span><a name="line-1602"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnUtils.html#checkDupRdrNames"><span class="hs-identifier hs-var">checkDupRdrNames</span></a><span> </span><a href="#local-6989586621682272501"><span class="hs-identifier hs-var">sig_rdr_names_w_locs</span></a><span>
</span><a name="line-1603"></a><span>                </span><span class="hs-comment">-- Typechecker is responsible for checking that we only</span><span>
</span><a name="line-1604"></a><span>                </span><span class="hs-comment">-- give default-method bindings for things in this class.</span><span>
</span><a name="line-1605"></a><span>                </span><span class="hs-comment">-- The renamer *could* check this for class decls, but can't</span><span>
</span><a name="line-1606"></a><span>                </span><span class="hs-comment">-- for instance decls.</span><span>
</span><a name="line-1607"></a><span>
</span><a name="line-1608"></a><span>        </span><span class="hs-comment">-- The newLocals call is tiresome: given a generic class decl</span><span>
</span><a name="line-1609"></a><span>        </span><span class="hs-comment">--      class C a where</span><span>
</span><a name="line-1610"></a><span>        </span><span class="hs-comment">--        op :: a -&gt; a</span><span>
</span><a name="line-1611"></a><span>        </span><span class="hs-comment">--        op {| x+y |} (Inl a) = ...</span><span>
</span><a name="line-1612"></a><span>        </span><span class="hs-comment">--        op {| x+y |} (Inr b) = ...</span><span>
</span><a name="line-1613"></a><span>        </span><span class="hs-comment">--        op {| a*b |} (a*b)   = ...</span><span>
</span><a name="line-1614"></a><span>        </span><span class="hs-comment">-- we want to name both &quot;x&quot; tyvars with the same unique, so that they are</span><span>
</span><a name="line-1615"></a><span>        </span><span class="hs-comment">-- easy to group together in the typechecker.</span><span>
</span><a name="line-1616"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272504"><a href="#local-6989586621682272504"><span class="hs-identifier">mbinds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272505"><a href="#local-6989586621682272505"><span class="hs-identifier">sigs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272506"><a href="#local-6989586621682272506"><span class="hs-identifier">meth_fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1617"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnBinds.html#rnMethodBinds"><span class="hs-identifier hs-var">rnMethodBinds</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682272485"><span class="hs-identifier hs-var">cls'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsAllLTyVarNames</span><span> </span><a href="#local-6989586621682272494"><span class="hs-identifier hs-var">tyvars'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272479"><span class="hs-identifier hs-var">mbinds</span></a><span> </span><a href="#local-6989586621682272478"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-1618"></a><span>                </span><span class="hs-comment">-- No need to check for duplicate method signatures</span><span>
</span><a name="line-1619"></a><span>                </span><span class="hs-comment">-- since that is done by RnNames.extendGlobalRdrEnvRn</span><span>
</span><a name="line-1620"></a><span>                </span><span class="hs-comment">-- and the methods are already in scope</span><span>
</span><a name="line-1621"></a><span>
</span><a name="line-1622"></a><span>  </span><span class="hs-comment">-- Haddock docs</span><span>
</span><a name="line-1623"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272507"><a href="#local-6989586621682272507"><span class="hs-identifier">docs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="RnSource.html#rnDocDecl"><span class="hs-identifier hs-var">rnDocDecl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272482"><span class="hs-identifier hs-var">docs</span></a><span>
</span><a name="line-1624"></a><span>
</span><a name="line-1625"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272508"><a href="#local-6989586621682272508"><span class="hs-identifier">all_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272506"><span class="hs-identifier hs-var">meth_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272498"><span class="hs-identifier hs-var">stuff_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272500"><span class="hs-identifier hs-var">fv_at_defs</span></a><span>
</span><a name="line-1626"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClassDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdCtxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272495"><span class="hs-identifier hs-var">context'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272484"><span class="hs-identifier hs-var">lcls'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1627"></a><span>                              </span><span class="hs-identifier">tcdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272494"><span class="hs-identifier hs-var">tyvars'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdFixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272476"><span class="hs-identifier hs-var">fixity</span></a><span class="hs-special">,</span><span>
</span><a name="line-1628"></a><span>                              </span><span class="hs-identifier">tcdFDs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272496"><span class="hs-identifier hs-var">fds'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdSigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272505"><span class="hs-identifier hs-var">sigs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1629"></a><span>                              </span><span class="hs-identifier">tcdMeths</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272504"><span class="hs-identifier hs-var">mbinds'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272497"><span class="hs-identifier hs-var">ats'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATDefs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272499"><span class="hs-identifier hs-var">at_defs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1630"></a><span>                              </span><span class="hs-identifier">tcdDocs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272507"><span class="hs-identifier hs-var">docs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdCExt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272508"><span class="hs-identifier hs-var">all_fvs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-1631"></a><span>                  </span><a href="#local-6989586621682272508"><span class="hs-identifier hs-var">all_fvs</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1632"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1633"></a><span>    </span><a name="local-6989586621682272483"><a href="#local-6989586621682272483"><span class="hs-identifier">cls_doc</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#ClassDeclCtx"><span class="hs-identifier hs-var">ClassDeclCtx</span></a><span> </span><a href="#local-6989586621682272474"><span class="hs-identifier hs-var">lcls</span></a><span>
</span><a name="line-1634"></a><span>
</span><a name="line-1635"></a><span class="hs-identifier">rnTyClDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTyClDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnTyClDecl&quot;</span><span>
</span><a name="line-1636"></a><span>
</span><a name="line-1637"></a><span class="hs-comment">-- &quot;type&quot; and &quot;type instance&quot; declarations</span><span>
</span><a name="line-1638"></a><span class="hs-identifier">rnTySyn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1639"></a><a name="rnTySyn"><a href="RnSource.html#rnTySyn"><span class="hs-identifier">rnTySyn</span></a></a><span> </span><a name="local-6989586621682272509"><a href="#local-6989586621682272509"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621682272510"><a href="#local-6989586621682272510"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><a href="#local-6989586621682272509"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272510"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1640"></a><span>
</span><a name="line-1641"></a><span class="hs-identifier">rnDataDefn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsDataDefn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1642"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsDataDefn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1643"></a><a name="rnDataDefn"><a href="RnSource.html#rnDataDefn"><span class="hs-identifier">rnDataDefn</span></a></a><span> </span><a name="local-6989586621682272511"><a href="#local-6989586621682272511"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDataDefn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_ND</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272512"><a href="#local-6989586621682272512"><span class="hs-identifier">new_or_data</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_cType</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272513"><a href="#local-6989586621682272513"><span class="hs-identifier">cType</span></a></a><span>
</span><a name="line-1644"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272514"><a href="#local-6989586621682272514"><span class="hs-identifier">context</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272515"><a href="#local-6989586621682272515"><span class="hs-identifier">condecls</span></a></a><span>
</span><a name="line-1645"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_kindSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272516"><a href="#local-6989586621682272516"><span class="hs-identifier">m_sig</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_derivs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272517"><a href="#local-6989586621682272517"><span class="hs-identifier">derivs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1646"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272518"><span class="hs-identifier hs-var">h98_style</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272514"><span class="hs-identifier hs-var">context</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1647"></a><span>                  </span><span class="hs-special">(</span><a href="RnSource.html#badGadtStupidTheta"><span class="hs-identifier hs-var">badGadtStupidTheta</span></a><span> </span><a href="#local-6989586621682272511"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1648"></a><span>
</span><a name="line-1649"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272526"><a href="#local-6989586621682272526"><span class="hs-identifier">m_sig'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272527"><a href="#local-6989586621682272527"><span class="hs-identifier">sig_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272516"><span class="hs-identifier hs-var">m_sig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1650"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682272525"><a href="#local-6989586621682272525"><span class="hs-identifier">sig</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="RnTypes.html#rnLHsKind"><span class="hs-identifier hs-var">rnLHsKind</span></a><span> </span><a href="#local-6989586621682272511"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272525"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1651"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1652"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272528"><a href="#local-6989586621682272528"><span class="hs-identifier">context'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272529"><a href="#local-6989586621682272529"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnContext"><span class="hs-identifier hs-var">rnContext</span></a><span> </span><a href="#local-6989586621682272511"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272514"><span class="hs-identifier hs-var">context</span></a><span>
</span><a name="line-1653"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272530"><a href="#local-6989586621682272530"><span class="hs-identifier">derivs'</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621682272531"><a href="#local-6989586621682272531"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272519"><span class="hs-identifier hs-var">rn_derivs</span></a><span> </span><a href="#local-6989586621682272517"><span class="hs-identifier hs-var">derivs</span></a><span>
</span><a name="line-1654"></a><span>
</span><a name="line-1655"></a><span>        </span><span class="hs-comment">-- For the constructor declarations, drop the LocalRdrEnv</span><span>
</span><a name="line-1656"></a><span>        </span><span class="hs-comment">-- in the GADT case, where the type variables in the declaration</span><span>
</span><a name="line-1657"></a><span>        </span><span class="hs-comment">-- do not scope over the constructor signatures</span><span>
</span><a name="line-1658"></a><span>        </span><span class="hs-comment">-- data T a where { T1 :: forall b. b-&gt; b }</span><span>
</span><a name="line-1659"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272532"><a href="#local-6989586621682272532"><span class="hs-identifier">zap_lcl_env</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682272518"><span class="hs-identifier hs-var">h98_style</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272533"><a href="#local-6989586621682272533"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272533"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1660"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setLocalRdrEnv"><span class="hs-identifier hs-var">setLocalRdrEnv</span></a><span> </span><span class="hs-identifier hs-var">emptyLocalRdrEnv</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1661"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272534"><a href="#local-6989586621682272534"><span class="hs-identifier">condecls'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272535"><a href="#local-6989586621682272535"><span class="hs-identifier">con_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272532"><span class="hs-identifier hs-var">zap_lcl_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnSource.html#rnConDecls"><span class="hs-identifier hs-var">rnConDecls</span></a><span> </span><a href="#local-6989586621682272515"><span class="hs-identifier hs-var">condecls</span></a><span>
</span><a name="line-1662"></a><span>           </span><span class="hs-comment">-- No need to check for duplicate constructor decls</span><span>
</span><a name="line-1663"></a><span>           </span><span class="hs-comment">-- since that is done by RnNames.extendGlobalRdrEnvRn</span><span>
</span><a name="line-1664"></a><span>
</span><a name="line-1665"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272536"><a href="#local-6989586621682272536"><span class="hs-identifier">all_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272529"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272531"><span class="hs-identifier hs-var">fvs3</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span>
</span><a name="line-1666"></a><span>                        </span><a href="#local-6989586621682272535"><span class="hs-identifier hs-var">con_fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272527"><span class="hs-identifier hs-var">sig_fvs</span></a><span>
</span><a name="line-1667"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">HsDataDefn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-1668"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_ND</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272512"><span class="hs-identifier hs-var">new_or_data</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_cType</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272513"><span class="hs-identifier hs-var">cType</span></a><span>
</span><a name="line-1669"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272528"><span class="hs-identifier hs-var">context'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_kindSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272526"><span class="hs-identifier hs-var">m_sig'</span></a><span>
</span><a name="line-1670"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272534"><span class="hs-identifier hs-var">condecls'</span></a><span>
</span><a name="line-1671"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_derivs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272530"><span class="hs-identifier hs-var">derivs'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1672"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272536"><span class="hs-identifier hs-var">all_fvs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1673"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-1674"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1675"></a><span>    </span><a name="local-6989586621682272518"><a href="#local-6989586621682272518"><span class="hs-identifier">h98_style</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272515"><span class="hs-identifier hs-var">condecls</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Note [Stupid theta]</span><span>
</span><a name="line-1676"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConDeclGADT</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1677"></a><span>                     </span><span class="hs-identifier">_</span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1678"></a><span>
</span><a name="line-1679"></a><span>    </span><a name="local-6989586621682272519"><a href="#local-6989586621682272519"><span class="hs-identifier">rn_derivs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272520"><a href="#local-6989586621682272520"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272521"><a href="#local-6989586621682272521"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1680"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272522"><a href="#local-6989586621682272522"><span class="hs-identifier">deriv_strats_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DerivingStrategies</span><span>
</span><a name="line-1681"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failIfTc"><span class="hs-identifier hs-var">failIfTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lengthExceeds</span><span> </span><a href="#local-6989586621682272521"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682272522"><span class="hs-identifier hs-var">deriv_strats_ok</span></a><span class="hs-special">)</span><span>
</span><a name="line-1682"></a><span>               </span><a href="RnSource.html#multipleDerivClausesErr"><span class="hs-identifier hs-var">multipleDerivClausesErr</span></a><span>
</span><a name="line-1683"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272523"><a href="#local-6989586621682272523"><span class="hs-identifier">ds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272524"><a href="#local-6989586621682272524"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#mapFvRn"><span class="hs-identifier hs-var">mapFvRn</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#rnLHsDerivingClause"><span class="hs-identifier hs-var">rnLHsDerivingClause</span></a><span> </span><a href="#local-6989586621682272511"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272521"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-1684"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272520"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682272523"><span class="hs-identifier hs-var">ds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272524"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1685"></a><span class="hs-identifier">rnDataDefn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsDataDefn</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnDataDefn&quot;</span><span>
</span><a name="line-1686"></a><span>
</span><a name="line-1687"></a><span class="hs-identifier">warnNoDerivStrat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LDerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1688"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-1689"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1690"></a><a name="warnNoDerivStrat"><a href="RnSource.html#warnNoDerivStrat"><span class="hs-identifier">warnNoDerivStrat</span></a></a><span> </span><a name="local-6989586621682272537"><a href="#local-6989586621682272537"><span class="hs-identifier">mds</span></a></a><span> </span><a name="local-6989586621682272538"><a href="#local-6989586621682272538"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-1691"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272541"><a href="#local-6989586621682272541"><span class="hs-identifier">dyn_flags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1692"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wopt</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingDerivingStrategies</span><span> </span><a href="#local-6989586621682272541"><span class="hs-identifier hs-var">dyn_flags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1693"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272537"><span class="hs-identifier hs-var">mds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1694"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier hs-var">addWarnAt</span></a><span>
</span><a name="line-1695"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnMissingDerivingStrategies</span><span class="hs-special">)</span><span>
</span><a name="line-1696"></a><span>               </span><a href="#local-6989586621682272538"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1697"></a><span>               </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.DerivingStrategies</span><span> </span><a href="#local-6989586621682272541"><span class="hs-identifier hs-var">dyn_flags</span></a><span>
</span><a name="line-1698"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682272539"><span class="hs-identifier hs-var">no_strat_warning</span></a><span>
</span><a name="line-1699"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621682272539"><span class="hs-identifier hs-var">no_strat_warning</span></a><span> </span><span class="hs-operator hs-var">$+$</span><span> </span><a href="#local-6989586621682272540"><span class="hs-identifier hs-var">deriv_strat_nenabled</span></a><span>
</span><a name="line-1700"></a><span>               </span><span class="hs-special">)</span><span>
</span><a name="line-1701"></a><span>             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1702"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1703"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1704"></a><span>    </span><span class="hs-identifier">no_strat_warning</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1705"></a><span>    </span><a name="local-6989586621682272539"><a href="#local-6989586621682272539"><span class="hs-identifier">no_strat_warning</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;No deriving strategy specified. Did you want stock&quot;</span><span>
</span><a name="line-1706"></a><span>                       </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, newtype, or anyclass?&quot;</span><span>
</span><a name="line-1707"></a><span>    </span><span class="hs-identifier">deriv_strat_nenabled</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1708"></a><span>    </span><a name="local-6989586621682272540"><a href="#local-6989586621682272540"><span class="hs-identifier">deriv_strat_nenabled</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use DerivingStrategies to specify a strategy.&quot;</span><span>
</span><a name="line-1709"></a><span>
</span><a name="line-1710"></a><span class="hs-identifier">rnLHsDerivingClause</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsDerivingClause</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1711"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsDerivingClause</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1712"></a><a name="rnLHsDerivingClause"><a href="RnSource.html#rnLHsDerivingClause"><span class="hs-identifier">rnLHsDerivingClause</span></a></a><span> </span><a name="local-6989586621682272542"><a href="#local-6989586621682272542"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-1713"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272543"><a href="#local-6989586621682272543"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDerivingClause</span><span>
</span><a name="line-1714"></a><span>                              </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">deriv_clause_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272544"><a href="#local-6989586621682272544"><span class="hs-identifier">noExt</span></a></a><span>
</span><a name="line-1715"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">deriv_clause_strategy</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272545"><a href="#local-6989586621682272545"><span class="hs-identifier">dcs</span></a></a><span>
</span><a name="line-1716"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">deriv_clause_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272546"><a href="#local-6989586621682272546"><span class="hs-identifier">loc'</span></a></a><span> </span><a name="local-6989586621682272547"><a href="#local-6989586621682272547"><span class="hs-identifier">dct</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1717"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272555"><a href="#local-6989586621682272555"><span class="hs-identifier">dcs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272556"><a href="#local-6989586621682272556"><span class="hs-identifier">dct'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272557"><a href="#local-6989586621682272557"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1718"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnLDerivStrategy"><span class="hs-identifier hs-var">rnLDerivStrategy</span></a><span> </span><a href="#local-6989586621682272542"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272545"><span class="hs-identifier hs-var">dcs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682272553"><a href="#local-6989586621682272553"><span class="hs-identifier">strat_tvs</span></a></a><span> </span><a name="local-6989586621682272554"><a href="#local-6989586621682272554"><span class="hs-identifier">ppr_via_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1719"></a><span>              </span><a href="RnUtils.html#mapFvRn"><span class="hs-identifier hs-var">mapFvRn</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272548"><span class="hs-identifier hs-var">rn_deriv_ty</span></a><span> </span><a href="#local-6989586621682272553"><span class="hs-identifier hs-var">strat_tvs</span></a><span> </span><a href="#local-6989586621682272554"><span class="hs-identifier hs-var">ppr_via_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272547"><span class="hs-identifier hs-var">dct</span></a><span>
</span><a name="line-1720"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnSource.html#warnNoDerivStrat"><span class="hs-identifier hs-var">warnNoDerivStrat</span></a><span> </span><a href="#local-6989586621682272555"><span class="hs-identifier hs-var">dcs'</span></a><span> </span><a href="#local-6989586621682272543"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-1721"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272543"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDerivingClause</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">deriv_clause_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272544"><span class="hs-identifier hs-var">noExt</span></a><span>
</span><a name="line-1722"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">deriv_clause_strategy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272555"><span class="hs-identifier hs-var">dcs'</span></a><span>
</span><a name="line-1723"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">deriv_clause_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272546"><span class="hs-identifier hs-var">loc'</span></a><span> </span><a href="#local-6989586621682272556"><span class="hs-identifier hs-var">dct'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1724"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272557"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1725"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1726"></a><span>    </span><span class="hs-identifier">rn_deriv_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1727"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1728"></a><span>    </span><a name="local-6989586621682272548"><a href="#local-6989586621682272548"><span class="hs-identifier">rn_deriv_ty</span></a></a><span> </span><a name="local-6989586621682272549"><a href="#local-6989586621682272549"><span class="hs-identifier">strat_tvs</span></a></a><span> </span><a name="local-6989586621682272550"><a href="#local-6989586621682272550"><span class="hs-identifier">ppr_via_ty</span></a></a><span> </span><a name="local-6989586621682272551"><a href="#local-6989586621682272551"><span class="hs-identifier">deriv_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272552"><a href="#local-6989586621682272552"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1729"></a><span>      </span><a href="RnSource.html#rnAndReportFloatingViaTvs"><span class="hs-identifier hs-var">rnAndReportFloatingViaTvs</span></a><span> </span><a href="#local-6989586621682272549"><span class="hs-identifier hs-var">strat_tvs</span></a><span> </span><a href="#local-6989586621682272552"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682272550"><span class="hs-identifier hs-var">ppr_via_ty</span></a><span> </span><span class="hs-string">&quot;class&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1730"></a><span>      </span><a href="RnTypes.html#rnHsSigType"><span class="hs-identifier hs-var">rnHsSigType</span></a><span> </span><a href="#local-6989586621682272542"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272551"><span class="hs-identifier hs-var">deriv_ty</span></a><span>
</span><a name="line-1731"></a><span>    </span><span class="hs-identifier">rn_deriv_ty</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rn_deriv_ty&quot;</span><span>
</span><a name="line-1732"></a><span class="hs-identifier">rnLHsDerivingClause</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsDerivingClause</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnLHsDerivingClause&quot;</span><span>
</span><a name="line-1734"></a><span class="hs-identifier">rnLHsDerivingClause</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnLHsDerivingClause: Impossible Match&quot;</span><span>
</span><a name="line-1735"></a><span>                                </span><span class="hs-comment">-- due to #15884</span><span>
</span><a name="line-1736"></a><span>
</span><a name="line-1737"></a><span class="hs-identifier">rnLDerivStrategy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621682271990"><a href="#local-6989586621682271990"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-1738"></a><span>                    </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span>
</span><a name="line-1739"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LDerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-1740"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- The tyvars bound by the via type</span><span>
</span><a name="line-1741"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-comment">-- The pretty-printed via type (used for</span><span>
</span><a name="line-1742"></a><span>                              </span><span class="hs-comment">-- error message reporting)</span><span>
</span><a name="line-1743"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271990"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1744"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LDerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682271990"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1745"></a><a name="rnLDerivStrategy"><a href="RnSource.html#rnLDerivStrategy"><span class="hs-identifier">rnLDerivStrategy</span></a></a><span> </span><a name="local-6989586621682272558"><a href="#local-6989586621682272558"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621682272559"><a href="#local-6989586621682272559"><span class="hs-identifier">mds</span></a></a><span> </span><a name="local-6989586621682272560"><a href="#local-6989586621682272560"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1746"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272559"><span class="hs-identifier hs-var">mds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1747"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272562"><span class="hs-identifier hs-var">boring_case</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1748"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682272580"><a href="#local-6989586621682272580"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272581"><a href="#local-6989586621682272581"><span class="hs-identifier">ds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272582"><a href="#local-6989586621682272582"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272583"><a href="#local-6989586621682272583"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272561"><span class="hs-identifier hs-var">rn_deriv_strat</span></a><span> </span><a href="#local-6989586621682272580"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-1749"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272581"><span class="hs-identifier hs-var">ds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272582"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272583"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1750"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1751"></a><span>    </span><span class="hs-identifier">rn_deriv_strat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LDerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1752"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LDerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682271990"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1753"></a><span>    </span><a name="local-6989586621682272561"><a href="#local-6989586621682272561"><span class="hs-identifier">rn_deriv_strat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272564"><a href="#local-6989586621682272564"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272565"><a href="#local-6989586621682272565"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1754"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">extNeeded</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LangExt.Extension</span><span>
</span><a name="line-1755"></a><span>          </span><a name="local-6989586621682272566"><a href="#local-6989586621682272566"><span class="hs-identifier">extNeeded</span></a></a><span>
</span><a name="line-1756"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ViaStrategy</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272565"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-1757"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LangExt.DerivingVia</span><span>
</span><a name="line-1758"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1759"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LangExt.DerivingStrategies</span><span>
</span><a name="line-1760"></a><span>
</span><a name="line-1761"></a><span>      </span><a href="TcRnMonad.html#unlessXOptM"><span class="hs-identifier hs-var">unlessXOptM</span></a><span> </span><a href="#local-6989586621682272566"><span class="hs-identifier hs-var">extNeeded</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1762"></a><span>        </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnSource.html#illegalDerivStrategyErr"><span class="hs-identifier hs-var">illegalDerivStrategyErr</span></a><span> </span><a href="#local-6989586621682272565"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-1763"></a><span>
</span><a name="line-1764"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272565"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1765"></a><span>        </span><span class="hs-identifier hs-var">StockStrategy</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272562"><span class="hs-identifier hs-var">boring_case</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272564"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-identifier hs-var">StockStrategy</span><span class="hs-special">)</span><span>
</span><a name="line-1766"></a><span>        </span><span class="hs-identifier hs-var">AnyclassStrategy</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272562"><span class="hs-identifier hs-var">boring_case</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272564"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-identifier hs-var">AnyclassStrategy</span><span class="hs-special">)</span><span>
</span><a name="line-1767"></a><span>        </span><span class="hs-identifier hs-var">NewtypeStrategy</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682272562"><span class="hs-identifier hs-var">boring_case</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272564"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-identifier hs-var">NewtypeStrategy</span><span class="hs-special">)</span><span>
</span><a name="line-1768"></a><span>        </span><span class="hs-identifier hs-var">ViaStrategy</span><span> </span><a name="local-6989586621682272567"><a href="#local-6989586621682272567"><span class="hs-identifier">via_ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1769"></a><span>          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272568"><a href="#local-6989586621682272568"><span class="hs-identifier">via_ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272569"><a href="#local-6989586621682272569"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnHsSigType"><span class="hs-identifier hs-var">rnHsSigType</span></a><span> </span><a href="#local-6989586621682272558"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272567"><span class="hs-identifier hs-var">via_ty</span></a><span>
</span><a name="line-1770"></a><span>             </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_ext</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272570"><a href="#local-6989586621682272570"><span class="hs-identifier">via_imp_tvs</span></a></a><span>
</span><a name="line-1771"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272571"><a href="#local-6989586621682272571"><span class="hs-identifier">via_body</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272568"><span class="hs-identifier hs-var">via_ty'</span></a><span>
</span><a name="line-1772"></a><span>                 </span><span class="hs-special">(</span><a name="local-6989586621682272572"><a href="#local-6989586621682272572"><span class="hs-identifier">via_exp_tv_bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitLHsSigmaTy</span><span> </span><a href="#local-6989586621682272571"><span class="hs-identifier hs-var">via_body</span></a><span>
</span><a name="line-1773"></a><span>                 </span><a name="local-6989586621682272573"><a href="#local-6989586621682272573"><span class="hs-identifier">via_exp_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">hsLTyVarName</span><span> </span><a href="#local-6989586621682272572"><span class="hs-identifier hs-var">via_exp_tv_bndrs</span></a><span>
</span><a name="line-1774"></a><span>                 </span><a name="local-6989586621682272574"><a href="#local-6989586621682272574"><span class="hs-identifier">via_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272570"><span class="hs-identifier hs-var">via_imp_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272573"><span class="hs-identifier hs-var">via_exp_tvs</span></a><span>
</span><a name="line-1775"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682272575"><a href="#local-6989586621682272575"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272576"><a href="#local-6989586621682272576"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnUtils.html#extendTyVarEnvFVRn"><span class="hs-identifier hs-var">extendTyVarEnvFVRn</span></a><span> </span><a href="#local-6989586621682272574"><span class="hs-identifier hs-var">via_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1776"></a><span>                              </span><a href="#local-6989586621682272560"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621682272574"><span class="hs-identifier hs-var">via_tvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272568"><span class="hs-identifier hs-var">via_ty'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1777"></a><span>             </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272564"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ViaStrategy</span><span> </span><a href="#local-6989586621682272568"><span class="hs-identifier hs-var">via_ty'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272575"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272569"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272576"><span class="hs-identifier hs-var">fvs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1778"></a><span>
</span><a name="line-1779"></a><span>    </span><span class="hs-identifier">boring_case</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621682272563"><span class="hs-identifier hs-type">mds</span></a><span>
</span><a name="line-1780"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272563"><span class="hs-identifier hs-type">mds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682271990"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1781"></a><span>    </span><a name="local-6989586621682272562"><a href="#local-6989586621682272562"><span class="hs-identifier">boring_case</span></a></a><span> </span><a name="local-6989586621682272577"><a href="#local-6989586621682272577"><span class="hs-identifier">mds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1782"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621682272578"><a href="#local-6989586621682272578"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272579"><a href="#local-6989586621682272579"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272560"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1783"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272577"><span class="hs-identifier hs-var">mds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272578"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272579"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1784"></a><span>
</span><a name="line-1785"></a><span class="hs-comment">-- | Errors if a @via@ type binds any floating type variables.</span><span>
</span><a name="line-1786"></a><span class="hs-comment">-- See @Note [Floating `via` type variables]@</span><span>
</span><a name="line-1787"></a><span class="hs-identifier">rnAndReportFloatingViaTvs</span><span>
</span><a name="line-1788"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621682271989"><a href="#local-6989586621682271989"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621682271989"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1789"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ The bound type variables from a @via@ type.</span><span>
</span><a name="line-1790"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-comment">-- ^ The source span (for error reporting only).</span><span>
</span><a name="line-1791"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>    </span><span class="hs-comment">-- ^ The pretty-printed @via@ type (for error reporting only).</span><span>
</span><a name="line-1792"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>  </span><span class="hs-comment">-- ^ A description of what the @via@ type scopes over</span><span>
</span><a name="line-1793"></a><span>             </span><span class="hs-comment">--   (for error reporting only).</span><span>
</span><a name="line-1794"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271989"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The thing the @via@ type scopes over.</span><span>
</span><a name="line-1795"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682271989"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1796"></a><a name="rnAndReportFloatingViaTvs"><a href="RnSource.html#rnAndReportFloatingViaTvs"><span class="hs-identifier">rnAndReportFloatingViaTvs</span></a></a><span> </span><a name="local-6989586621682272584"><a href="#local-6989586621682272584"><span class="hs-identifier">tv_names</span></a></a><span> </span><a name="local-6989586621682272585"><a href="#local-6989586621682272585"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682272586"><a href="#local-6989586621682272586"><span class="hs-identifier">ppr_via_ty</span></a></a><span> </span><a name="local-6989586621682272587"><a href="#local-6989586621682272587"><span class="hs-identifier">via_scope_desc</span></a></a><span> </span><a name="local-6989586621682272588"><a href="#local-6989586621682272588"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1797"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272593"><a href="#local-6989586621682272593"><span class="hs-identifier">thing</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272594"><a href="#local-6989586621682272594"><span class="hs-identifier">thing_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272588"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1798"></a><span>       </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682272585"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272589"><span class="hs-identifier hs-var">report_floating_via_tv</span></a><span> </span><a href="#local-6989586621682272593"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-6989586621682272594"><span class="hs-identifier hs-var">thing_fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272584"><span class="hs-identifier hs-var">tv_names</span></a><span>
</span><a name="line-1799"></a><span>       </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272593"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272594"><span class="hs-identifier hs-var">thing_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1800"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1801"></a><span>    </span><span class="hs-identifier">report_floating_via_tv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621682271989"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1802"></a><span>    </span><a name="local-6989586621682272589"><a href="#local-6989586621682272589"><span class="hs-identifier">report_floating_via_tv</span></a></a><span> </span><a name="local-6989586621682272590"><a href="#local-6989586621682272590"><span class="hs-identifier">thing</span></a></a><span> </span><a name="local-6989586621682272591"><a href="#local-6989586621682272591"><span class="hs-identifier">used_names</span></a></a><span> </span><a name="local-6989586621682272592"><a href="#local-6989586621682272592"><span class="hs-identifier">tv_name</span></a></a><span>
</span><a name="line-1803"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272592"><span class="hs-identifier hs-var">tv_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272591"><span class="hs-identifier hs-var">used_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-1804"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Type variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272592"><span class="hs-identifier hs-var">tv_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1805"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is bound in the&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;via&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1806"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><a href="#local-6989586621682272586"><span class="hs-identifier hs-var">ppr_via_ty</span></a><span>
</span><a name="line-1807"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but is not mentioned in the derived&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1808"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682272587"><span class="hs-identifier hs-var">via_scope_desc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272590"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-1809"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, which is illegal&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1810"></a><span>
</span><a name="line-1811"></a><span class="hs-comment">{-
Note [Floating `via` type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Imagine the following `deriving via` clause:

    data Quux
      deriving Eq via (Const a Quux)

This should be rejected. Why? Because it would generate the following instance:

    instance Eq Quux where
      (==) = coerce @(Quux         -&gt; Quux         -&gt; Bool)
                    @(Const a Quux -&gt; Const a Quux -&gt; Bool)
                    (==) :: Const a Quux -&gt; Const a Quux -&gt; Bool

This instance is ill-formed, as the `a` in `Const a Quux` is unbound. The
problem is that `a` is never used anywhere in the derived class `Eq`. Since
`a` is bound but has no use sites, we refer to it as &quot;floating&quot;.

We use the rnAndReportFloatingViaTvs function to check that any type renamed
within the context of the `via` deriving strategy actually uses all bound
`via` type variables, and if it doesn't, it throws an error.
-}</span><span>
</span><a name="line-1834"></a><span>
</span><a name="line-1835"></a><span class="hs-identifier">badGadtStupidTheta</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1836"></a><a name="badGadtStupidTheta"><a href="RnSource.html#badGadtStupidTheta"><span class="hs-identifier">badGadtStupidTheta</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1837"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;No context is allowed on a GADT-style data declaration&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1838"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(You can put a context on each constructor, though.)&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1839"></a><span>
</span><a name="line-1840"></a><span class="hs-identifier">illegalDerivStrategyErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1841"></a><a name="illegalDerivStrategyErr"><a href="RnSource.html#illegalDerivStrategyErr"><span class="hs-identifier">illegalDerivStrategyErr</span></a></a><span> </span><a name="local-6989586621682272595"><a href="#local-6989586621682272595"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-1842"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal deriving strategy&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">derivStrategyName</span><span> </span><a href="#local-6989586621682272595"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-1843"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682272596"><span class="hs-identifier hs-var">enableStrategy</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1844"></a><span>
</span><a name="line-1845"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1846"></a><span>    </span><span class="hs-identifier">enableStrategy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1847"></a><span>    </span><a name="local-6989586621682272596"><a href="#local-6989586621682272596"><span class="hs-identifier">enableStrategy</span></a></a><span>
</span><a name="line-1848"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ViaStrategy</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272595"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-1849"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Use DerivingVia to enable this extension&quot;</span><span>
</span><a name="line-1850"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1851"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Use DerivingStrategies to enable this extension&quot;</span><span>
</span><a name="line-1852"></a><span>
</span><a name="line-1853"></a><span class="hs-identifier">multipleDerivClausesErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1854"></a><a name="multipleDerivClausesErr"><a href="RnSource.html#multipleDerivClausesErr"><span class="hs-identifier">multipleDerivClausesErr</span></a></a><span>
</span><a name="line-1855"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal use of multiple, consecutive deriving clauses&quot;</span><span>
</span><a name="line-1856"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use DerivingStrategies to allow this&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1857"></a><span>
</span><a name="line-1858"></a><span class="hs-identifier">rnFamDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-comment">-- Just cls =&gt; this FamilyDecl is nested</span><span>
</span><a name="line-1859"></a><span>                        </span><span class="hs-comment">--             inside an *class decl* for cls</span><span>
</span><a name="line-1860"></a><span>                        </span><span class="hs-comment">--             used for associated types</span><span>
</span><a name="line-1861"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamilyDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1862"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FamilyDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1863"></a><a name="rnFamDecl"><a href="RnSource.html#rnFamDecl"><span class="hs-identifier">rnFamDecl</span></a></a><span> </span><a name="local-6989586621682272597"><a href="#local-6989586621682272597"><span class="hs-identifier">mb_cls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamilyDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272598"><a href="#local-6989586621682272598"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272599"><a href="#local-6989586621682272599"><span class="hs-identifier">tyvars</span></a></a><span>
</span><a name="line-1864"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdFixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272600"><a href="#local-6989586621682272600"><span class="hs-identifier">fixity</span></a></a><span>
</span><a name="line-1865"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272601"><a href="#local-6989586621682272601"><span class="hs-identifier">info</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdResultSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272602"><a href="#local-6989586621682272602"><span class="hs-identifier">res_sig</span></a></a><span>
</span><a name="line-1866"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdInjectivityAnn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272603"><a href="#local-6989586621682272603"><span class="hs-identifier">injectivity</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1867"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272611"><a href="#local-6989586621682272611"><span class="hs-identifier">tycon'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocatedTopBndrRn"><span class="hs-identifier hs-var">lookupLocatedTopBndrRn</span></a><span> </span><a href="#local-6989586621682272598"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1868"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682272617"><a href="#local-6989586621682272617"><span class="hs-identifier">tyvars'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272618"><a href="#local-6989586621682272618"><span class="hs-identifier">res_sig'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272619"><a href="#local-6989586621682272619"><span class="hs-identifier">injectivity'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272620"><a href="#local-6989586621682272620"><span class="hs-identifier">fv1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1869"></a><span>            </span><a href="RnTypes.html#bindHsQTyVars"><span class="hs-identifier hs-var">bindHsQTyVars</span></a><span> </span><a href="#local-6989586621682272604"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272597"><span class="hs-identifier hs-var">mb_cls</span></a><span> </span><a href="#local-6989586621682272605"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="#local-6989586621682272599"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272612"><a href="#local-6989586621682272612"><span class="hs-identifier">tyvars'</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1870"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272613"><a href="#local-6989586621682272613"><span class="hs-identifier">rn_sig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#rnFamResultSig"><span class="hs-identifier hs-var">rnFamResultSig</span></a><span> </span><a href="#local-6989586621682272604"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-1871"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272614"><a href="#local-6989586621682272614"><span class="hs-identifier">res_sig'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272615"><a href="#local-6989586621682272615"><span class="hs-identifier">fv_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span> </span><a href="#local-6989586621682272613"><span class="hs-identifier hs-var">rn_sig</span></a><span> </span><a href="#local-6989586621682272602"><span class="hs-identifier hs-var">res_sig</span></a><span>
</span><a name="line-1872"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272616"><a href="#local-6989586621682272616"><span class="hs-identifier">injectivity'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><a href="RnSource.html#rnInjectivityAnn"><span class="hs-identifier hs-var">rnInjectivityAnn</span></a><span> </span><a href="#local-6989586621682272612"><span class="hs-identifier hs-var">tyvars'</span></a><span> </span><a href="#local-6989586621682272614"><span class="hs-identifier hs-var">res_sig'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1873"></a><span>                                          </span><a href="#local-6989586621682272603"><span class="hs-identifier hs-var">injectivity</span></a><span>
</span><a name="line-1874"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272612"><span class="hs-identifier hs-var">tyvars'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272614"><span class="hs-identifier hs-var">res_sig'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272616"><span class="hs-identifier hs-var">injectivity'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272615"><span class="hs-identifier hs-var">fv_kind</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1875"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272621"><a href="#local-6989586621682272621"><span class="hs-identifier">info'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272622"><a href="#local-6989586621682272622"><span class="hs-identifier">fv2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272606"><span class="hs-identifier hs-var">rn_info</span></a><span> </span><a href="#local-6989586621682272611"><span class="hs-identifier hs-var">tycon'</span></a><span> </span><a href="#local-6989586621682272601"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-1876"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamilyDecl</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdExt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-1877"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272611"><span class="hs-identifier hs-var">tycon'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272617"><span class="hs-identifier hs-var">tyvars'</span></a><span>
</span><a name="line-1878"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdFixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272600"><span class="hs-identifier hs-var">fixity</span></a><span>
</span><a name="line-1879"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272621"><span class="hs-identifier hs-var">info'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdResultSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272618"><span class="hs-identifier hs-var">res_sig'</span></a><span>
</span><a name="line-1880"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdInjectivityAnn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272619"><span class="hs-identifier hs-var">injectivity'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1881"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272620"><span class="hs-identifier hs-var">fv1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272622"><span class="hs-identifier hs-var">fv2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1882"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1883"></a><span>     </span><a name="local-6989586621682272604"><a href="#local-6989586621682272604"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#TyFamilyCtx"><span class="hs-identifier hs-var">TyFamilyCtx</span></a><span> </span><a href="#local-6989586621682272598"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1884"></a><span>     </span><a name="local-6989586621682272605"><a href="#local-6989586621682272605"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractRdrKindSigVars"><span class="hs-identifier hs-var">extractRdrKindSigVars</span></a><span> </span><a href="#local-6989586621682272602"><span class="hs-identifier hs-var">res_sig</span></a><span>
</span><a name="line-1885"></a><span>
</span><a name="line-1886"></a><span>     </span><span class="hs-comment">----------------------</span><span>
</span><a name="line-1887"></a><span>     </span><span class="hs-identifier">rn_info</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1888"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamilyInfo</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FamilyInfo</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1889"></a><span>     </span><a name="local-6989586621682272606"><a href="#local-6989586621682272606"><span class="hs-identifier">rn_info</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272607"><a href="#local-6989586621682272607"><span class="hs-identifier">fam_name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedTypeFamily</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682272608"><a href="#local-6989586621682272608"><span class="hs-identifier">eqns</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1890"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272609"><a href="#local-6989586621682272609"><span class="hs-identifier">eqns'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272610"><a href="#local-6989586621682272610"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1891"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnList"><span class="hs-identifier hs-var">rnList</span></a><span> </span><span class="hs-special">(</span><a href="RnSource.html#rnTyFamInstEqn"><span class="hs-identifier hs-var">rnTyFamInstEqn</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><a href="RnSource.html#ClosedTyFam"><span class="hs-identifier hs-var">ClosedTyFam</span></a><span> </span><a href="#local-6989586621682272598"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621682272607"><span class="hs-identifier hs-var">fam_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1892"></a><span>                                          </span><span class="hs-comment">-- no class context</span><span>
</span><a name="line-1893"></a><span>                          </span><a href="#local-6989586621682272608"><span class="hs-identifier hs-var">eqns</span></a><span>
</span><a name="line-1894"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedTypeFamily</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272609"><span class="hs-identifier hs-var">eqns'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272610"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1895"></a><span>     </span><span class="hs-identifier">rn_info</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedTypeFamily</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-1896"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedTypeFamily</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1897"></a><span>     </span><span class="hs-identifier">rn_info</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">OpenTypeFamily</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpenTypeFamily</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1898"></a><span>     </span><span class="hs-identifier">rn_info</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">DataFamily</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamily</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1899"></a><span class="hs-identifier">rnFamDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFamilyDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnFamDecl&quot;</span><span>
</span><a name="line-1900"></a><span>
</span><a name="line-1901"></a><span class="hs-identifier">rnFamResultSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span>
</span><a name="line-1902"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FamilyResultSig</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1903"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FamilyResultSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-1904"></a><a name="rnFamResultSig"><a href="RnSource.html#rnFamResultSig"><span class="hs-identifier">rnFamResultSig</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NoSig</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1905"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NoSig</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-1906"></a><span class="hs-identifier">rnFamResultSig</span><span> </span><a name="local-6989586621682272623"><a href="#local-6989586621682272623"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">KindSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272624"><a href="#local-6989586621682272624"><span class="hs-identifier">kind</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1907"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272625"><a href="#local-6989586621682272625"><span class="hs-identifier">rndKind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272626"><a href="#local-6989586621682272626"><span class="hs-identifier">ftvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsKind"><span class="hs-identifier hs-var">rnLHsKind</span></a><span> </span><a href="#local-6989586621682272623"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272624"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-1908"></a><span>        </span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">KindSig</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682272625"><span class="hs-identifier hs-var">rndKind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272626"><span class="hs-identifier hs-var">ftvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1909"></a><span class="hs-identifier">rnFamResultSig</span><span> </span><a name="local-6989586621682272627"><a href="#local-6989586621682272627"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272628"><a href="#local-6989586621682272628"><span class="hs-identifier">tvbndr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1910"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- `TyVarSig` tells us that user named the result of a type family by</span><span>
</span><a name="line-1911"></a><span>          </span><span class="hs-comment">-- writing `= tyvar` or `= (tyvar :: kind)`. In such case we want to</span><span>
</span><a name="line-1912"></a><span>          </span><span class="hs-comment">-- be sure that the supplied result name is not identical to an</span><span>
</span><a name="line-1913"></a><span>          </span><span class="hs-comment">-- already in-scope type variable from an enclosing class.</span><span>
</span><a name="line-1914"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-1915"></a><span>          </span><span class="hs-comment">--  Example of disallowed declaration:</span><span>
</span><a name="line-1916"></a><span>          </span><span class="hs-comment">--         class C a b where</span><span>
</span><a name="line-1917"></a><span>          </span><span class="hs-comment">--            type F b = a | a -&gt; b</span><span>
</span><a name="line-1918"></a><span>          </span><a name="local-6989586621682272629"><a href="#local-6989586621682272629"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLocalRdrEnv"><span class="hs-identifier hs-var">getLocalRdrEnv</span></a><span>
</span><a name="line-1919"></a><span>       </span><span class="hs-special">;</span><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272630"><a href="#local-6989586621682272630"><span class="hs-identifier">resName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsLTyVarName</span><span> </span><a href="#local-6989586621682272628"><span class="hs-identifier hs-var">tvbndr</span></a><span>
</span><a name="line-1920"></a><span>       </span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272630"><span class="hs-identifier hs-var">resName</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemLocalRdrEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272629"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1921"></a><span>          </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621682272628"><span class="hs-identifier hs-var">tvbndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1922"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Type variable&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272630"><span class="hs-identifier hs-var">resName</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">comma</span><span>
</span><a name="line-1923"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;naming a type family result,&quot;</span><span>
</span><a name="line-1924"></a><span>                           </span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1925"></a><span>                      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;shadows an already bound type variable&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1926"></a><span>
</span><a name="line-1927"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnTypes.html#bindLHsTyVarBndr"><span class="hs-identifier hs-var">bindLHsTyVarBndr</span></a><span> </span><a href="#local-6989586621682272627"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- This might be a lie, but it's used for</span><span>
</span><a name="line-1928"></a><span>                                      </span><span class="hs-comment">-- scoping checks that are irrelevant here</span><span>
</span><a name="line-1929"></a><span>                          </span><a href="#local-6989586621682272628"><span class="hs-identifier hs-var">tvbndr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272631"><a href="#local-6989586621682272631"><span class="hs-identifier">tvbndr'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1930"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarSig</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621682272631"><span class="hs-identifier hs-var">tvbndr'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitFV</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsLTyVarName</span><span> </span><a href="#local-6989586621682272631"><span class="hs-identifier hs-var">tvbndr'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1931"></a><span class="hs-identifier">rnFamResultSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFamilyResultSig</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnFamResultSig&quot;</span><span>
</span><a name="line-1932"></a><span>
</span><a name="line-1933"></a><span class="hs-comment">-- Note [Renaming injectivity annotation]</span><span>
</span><a name="line-1934"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1935"></a><span class="hs-comment">--</span><span>
</span><a name="line-1936"></a><span class="hs-comment">-- During renaming of injectivity annotation we have to make several checks to</span><span>
</span><a name="line-1937"></a><span class="hs-comment">-- make sure that it is well-formed.  At the moment injectivity annotation</span><span>
</span><a name="line-1938"></a><span class="hs-comment">-- consists of a single injectivity condition, so the terms &quot;injectivity</span><span>
</span><a name="line-1939"></a><span class="hs-comment">-- annotation&quot; and &quot;injectivity condition&quot; might be used interchangeably.  See</span><span>
</span><a name="line-1940"></a><span class="hs-comment">-- Note [Injectivity annotation] for a detailed discussion of currently allowed</span><span>
</span><a name="line-1941"></a><span class="hs-comment">-- injectivity annotations.</span><span>
</span><a name="line-1942"></a><span class="hs-comment">--</span><span>
</span><a name="line-1943"></a><span class="hs-comment">-- Checking LHS is simple because the only type variable allowed on the LHS of</span><span>
</span><a name="line-1944"></a><span class="hs-comment">-- injectivity condition is the variable naming the result in type family head.</span><span>
</span><a name="line-1945"></a><span class="hs-comment">-- Example of disallowed annotation:</span><span>
</span><a name="line-1946"></a><span class="hs-comment">--</span><span>
</span><a name="line-1947"></a><span class="hs-comment">--     type family Foo a b = r | b -&gt; a</span><span>
</span><a name="line-1948"></a><span class="hs-comment">--</span><span>
</span><a name="line-1949"></a><span class="hs-comment">-- Verifying RHS of injectivity consists of checking that:</span><span>
</span><a name="line-1950"></a><span class="hs-comment">--</span><span>
</span><a name="line-1951"></a><span class="hs-comment">--  1. only variables defined in type family head appear on the RHS (kind</span><span>
</span><a name="line-1952"></a><span class="hs-comment">--     variables are also allowed).  Example of disallowed annotation:</span><span>
</span><a name="line-1953"></a><span class="hs-comment">--</span><span>
</span><a name="line-1954"></a><span class="hs-comment">--        type family Foo a = r | r -&gt; b</span><span>
</span><a name="line-1955"></a><span class="hs-comment">--</span><span>
</span><a name="line-1956"></a><span class="hs-comment">--  2. for associated types the result variable does not shadow any of type</span><span>
</span><a name="line-1957"></a><span class="hs-comment">--     class variables. Example of disallowed annotation:</span><span>
</span><a name="line-1958"></a><span class="hs-comment">--</span><span>
</span><a name="line-1959"></a><span class="hs-comment">--        class Foo a b where</span><span>
</span><a name="line-1960"></a><span class="hs-comment">--           type F a = b | b -&gt; a</span><span>
</span><a name="line-1961"></a><span class="hs-comment">--</span><span>
</span><a name="line-1962"></a><span class="hs-comment">-- Breaking any of these assumptions results in an error.</span><span>
</span><a name="line-1963"></a><span>
</span><a name="line-1964"></a><span class="hs-comment">-- | Rename injectivity annotation. Note that injectivity annotation is just the</span><span>
</span><a name="line-1965"></a><span class="hs-comment">-- part after the &quot;|&quot;.  Everything that appears before it is renamed in</span><span>
</span><a name="line-1966"></a><span class="hs-comment">-- rnFamDecl.</span><span>
</span><a name="line-1967"></a><span class="hs-identifier">rnInjectivityAnn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsQTyVars</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>           </span><span class="hs-comment">-- ^ Type variables declared in</span><span>
</span><a name="line-1968"></a><span>                                               </span><span class="hs-comment">--   type family head</span><span>
</span><a name="line-1969"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LFamilyResultSig</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>     </span><span class="hs-comment">-- ^ Result signature</span><span>
</span><a name="line-1970"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LInjectivityAnn</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>      </span><span class="hs-comment">-- ^ Injectivity annotation</span><span>
</span><a name="line-1971"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LInjectivityAnn</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1972"></a><a name="rnInjectivityAnn"><a href="RnSource.html#rnInjectivityAnn"><span class="hs-identifier">rnInjectivityAnn</span></a></a><span> </span><a name="local-6989586621682272632"><a href="#local-6989586621682272632"><span class="hs-identifier">tvBndrs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272633"><a href="#local-6989586621682272633"><span class="hs-identifier">resTv</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1973"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272634"><a href="#local-6989586621682272634"><span class="hs-identifier">srcSpan</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InjectivityAnn</span><span> </span><a name="local-6989586621682272635"><a href="#local-6989586621682272635"><span class="hs-identifier">injFrom</span></a></a><span> </span><a name="local-6989586621682272636"><a href="#local-6989586621682272636"><span class="hs-identifier">injTo</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1974"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1975"></a><span>   </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272639"><a href="#local-6989586621682272639"><span class="hs-identifier">injDecl'</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InjectivityAnn</span><span> </span><a name="local-6989586621682272640"><a href="#local-6989586621682272640"><span class="hs-identifier">injFrom'</span></a></a><span> </span><a name="local-6989586621682272641"><a href="#local-6989586621682272641"><span class="hs-identifier">injTo'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682272642"><a href="#local-6989586621682272642"><span class="hs-identifier">noRnErrors</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1976"></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#askNoErrs"><span class="hs-identifier hs-var">askNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1977"></a><span>             </span><a href="RnUtils.html#bindLocalNames"><span class="hs-identifier hs-var">bindLocalNames</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">hsLTyVarName</span><span> </span><a href="#local-6989586621682272633"><span class="hs-identifier hs-var">resTv</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1978"></a><span>             </span><span class="hs-comment">-- The return type variable scopes over the injectivity annotation</span><span>
</span><a name="line-1979"></a><span>             </span><span class="hs-comment">-- e.g.   type family F a = (r::*) | r -&gt; a</span><span>
</span><a name="line-1980"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272637"><a href="#local-6989586621682272637"><span class="hs-identifier">injFrom'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLTyVar"><span class="hs-identifier hs-var">rnLTyVar</span></a><span> </span><a href="#local-6989586621682272635"><span class="hs-identifier hs-var">injFrom</span></a><span>
</span><a name="line-1981"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272638"><a href="#local-6989586621682272638"><span class="hs-identifier">injTo'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="RnTypes.html#rnLTyVar"><span class="hs-identifier hs-var">rnLTyVar</span></a><span> </span><a href="#local-6989586621682272636"><span class="hs-identifier hs-var">injTo</span></a><span>
</span><a name="line-1982"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272634"><span class="hs-identifier hs-var">srcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InjectivityAnn</span><span> </span><a href="#local-6989586621682272637"><span class="hs-identifier hs-var">injFrom'</span></a><span> </span><a href="#local-6989586621682272638"><span class="hs-identifier hs-var">injTo'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1983"></a><span>
</span><a name="line-1984"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272643"><a href="#local-6989586621682272643"><span class="hs-identifier">tvNames</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hsAllLTyVarNames</span><span> </span><a href="#local-6989586621682272632"><span class="hs-identifier hs-var">tvBndrs</span></a><span>
</span><a name="line-1985"></a><span>         </span><a name="local-6989586621682272644"><a href="#local-6989586621682272644"><span class="hs-identifier">resName</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsLTyVarName</span><span> </span><a href="#local-6989586621682272633"><span class="hs-identifier hs-var">resTv</span></a><span>
</span><a name="line-1986"></a><span>         </span><span class="hs-comment">-- See Note [Renaming injectivity annotation]</span><span>
</span><a name="line-1987"></a><span>         </span><a name="local-6989586621682272645"><a href="#local-6989586621682272645"><span class="hs-identifier">lhsValid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stableNameCmp</span><span> </span><a href="#local-6989586621682272644"><span class="hs-identifier hs-var">resName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272640"><span class="hs-identifier hs-var">injFrom'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1988"></a><span>         </span><a name="local-6989586621682272646"><a href="#local-6989586621682272646"><span class="hs-identifier">rhsValid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272641"><span class="hs-identifier hs-var">injTo'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.difference</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272643"><span class="hs-identifier hs-var">tvNames</span></a><span>
</span><a name="line-1989"></a><span>
</span><a name="line-1990"></a><span>   </span><span class="hs-comment">-- if renaming of type variables ended with errors (eg. there were</span><span>
</span><a name="line-1991"></a><span>   </span><span class="hs-comment">-- not-in-scope variables) don't check the validity of injectivity</span><span>
</span><a name="line-1992"></a><span>   </span><span class="hs-comment">-- annotation. This gives better error messages.</span><span>
</span><a name="line-1993"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272642"><span class="hs-identifier hs-var">noRnErrors</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682272645"><span class="hs-identifier hs-var">lhsValid</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1994"></a><span>        </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621682272635"><span class="hs-identifier hs-var">injFrom</span></a><span class="hs-special">)</span><span>
</span><a name="line-1995"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Incorrect type variable on the LHS of &quot;</span><span>
</span><a name="line-1996"></a><span>                           </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;injectivity condition&quot;</span><span>
</span><a name="line-1997"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1998"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Expected :&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272644"><span class="hs-identifier hs-var">resName</span></a><span>
</span><a name="line-1999"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Actual   :&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272635"><span class="hs-identifier hs-var">injFrom</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2000"></a><span>
</span><a name="line-2001"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272642"><span class="hs-identifier hs-var">noRnErrors</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.null</span><span> </span><a href="#local-6989586621682272646"><span class="hs-identifier hs-var">rhsValid</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2002"></a><span>      </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272647"><a href="#local-6989586621682272647"><span class="hs-identifier">errorVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621682272646"><span class="hs-identifier hs-var">rhsValid</span></a><span>
</span><a name="line-2003"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621682272634"><span class="hs-identifier hs-var">srcSpan</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">hsep</span><span>
</span><a name="line-2004"></a><span>                        </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unknown type variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">plural</span><span> </span><a href="#local-6989586621682272647"><span class="hs-identifier hs-var">errorVars</span></a><span>
</span><a name="line-2005"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;on the RHS of injectivity condition:&quot;</span><span>
</span><a name="line-2006"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">interpp'SP</span><span> </span><a href="#local-6989586621682272647"><span class="hs-identifier hs-var">errorVars</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2007"></a><span>
</span><a name="line-2008"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682272639"><span class="hs-identifier hs-var">injDecl'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2009"></a><span>
</span><a name="line-2010"></a><span class="hs-comment">-- We can only hit this case when the user writes injectivity annotation without</span><span>
</span><a name="line-2011"></a><span class="hs-comment">-- naming the result:</span><span>
</span><a name="line-2012"></a><span class="hs-comment">--</span><span>
</span><a name="line-2013"></a><span class="hs-comment">--   type family F a | result -&gt; a</span><span>
</span><a name="line-2014"></a><span class="hs-comment">--   type family F a :: * | result -&gt; a</span><span>
</span><a name="line-2015"></a><span class="hs-comment">--</span><span>
</span><a name="line-2016"></a><span class="hs-comment">-- So we rename injectivity annotation like we normally would except that</span><span>
</span><a name="line-2017"></a><span class="hs-comment">-- this time we expect &quot;result&quot; to be reported not in scope by rnLTyVar.</span><span>
</span><a name="line-2018"></a><span class="hs-identifier">rnInjectivityAnn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272648"><a href="#local-6989586621682272648"><span class="hs-identifier">srcSpan</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InjectivityAnn</span><span> </span><a name="local-6989586621682272649"><a href="#local-6989586621682272649"><span class="hs-identifier">injFrom</span></a></a><span> </span><a name="local-6989586621682272650"><a href="#local-6989586621682272650"><span class="hs-identifier">injTo</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2019"></a><span>   </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682272648"><span class="hs-identifier hs-var">srcSpan</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2020"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682272653"><a href="#local-6989586621682272653"><span class="hs-identifier">injDecl'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#askNoErrs"><span class="hs-identifier hs-var">askNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2021"></a><span>     </span><a name="local-6989586621682272651"><a href="#local-6989586621682272651"><span class="hs-identifier">injFrom'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLTyVar"><span class="hs-identifier hs-var">rnLTyVar</span></a><span> </span><a href="#local-6989586621682272649"><span class="hs-identifier hs-var">injFrom</span></a><span>
</span><a name="line-2022"></a><span>     </span><a name="local-6989586621682272652"><a href="#local-6989586621682272652"><span class="hs-identifier">injTo'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="RnTypes.html#rnLTyVar"><span class="hs-identifier hs-var">rnLTyVar</span></a><span> </span><a href="#local-6989586621682272650"><span class="hs-identifier hs-var">injTo</span></a><span>
</span><a name="line-2023"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272648"><span class="hs-identifier hs-var">srcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InjectivityAnn</span><span> </span><a href="#local-6989586621682272651"><span class="hs-identifier hs-var">injFrom'</span></a><span> </span><a href="#local-6989586621682272652"><span class="hs-identifier hs-var">injTo'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2024"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682272653"><span class="hs-identifier hs-var">injDecl'</span></a><span>
</span><a name="line-2025"></a><span>
</span><a name="line-2026"></a><span class="hs-comment">{-
Note [Stupid theta]
~~~~~~~~~~~~~~~~~~~
Trac #3850 complains about a regression wrt 6.10 for
     data Show a =&gt; T a
There is no reason not to allow the stupid theta if there are no data
constructors.  It's still stupid, but does no harm, and I don't want
to cause programs to break unnecessarily (notably HList).  So if there
are no data constructors we allow h98_style = True
-}</span><span>
</span><a name="line-2036"></a><span>
</span><a name="line-2037"></a><span>
</span><a name="line-2038"></a><span class="hs-comment">{- *****************************************************
*                                                      *
     Support code for type/data declarations
*                                                      *
***************************************************** -}</span><span>
</span><a name="line-2043"></a><span>
</span><a name="line-2044"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-2045"></a><span class="hs-identifier">wrongTyFamName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2046"></a><a name="wrongTyFamName"><a href="RnSource.html#wrongTyFamName"><span class="hs-identifier">wrongTyFamName</span></a></a><span> </span><a name="local-6989586621682272654"><a href="#local-6989586621682272654"><span class="hs-identifier">fam_tc_name</span></a></a><span> </span><a name="local-6989586621682272655"><a href="#local-6989586621682272655"><span class="hs-identifier">eqn_tc_name</span></a></a><span>
</span><a name="line-2047"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Mismatched type name in type family instance.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2048"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Expected:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272654"><span class="hs-identifier hs-var">fam_tc_name</span></a><span>
</span><a name="line-2049"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  Actual:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272655"><span class="hs-identifier hs-var">eqn_tc_name</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2050"></a><span>
</span><a name="line-2051"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-2052"></a><span class="hs-identifier">rnConDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LConDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LConDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-2053"></a><a name="rnConDecls"><a href="RnSource.html#rnConDecls"><span class="hs-identifier">rnConDecls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#mapFvRn"><span class="hs-identifier hs-var">mapFvRn</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span> </span><a href="RnSource.html#rnConDecl"><span class="hs-identifier hs-var">rnConDecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-2054"></a><span>
</span><a name="line-2055"></a><span class="hs-identifier">rnConDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ConDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-2056"></a><a name="rnConDecl"><a href="RnSource.html#rnConDecl"><span class="hs-identifier">rnConDecl</span></a></a><span> </span><a name="local-6989586621682272656"><a href="#local-6989586621682272656"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConDeclH98</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272657"><a href="#local-6989586621682272657"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_ex_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272658"><a href="#local-6989586621682272658"><span class="hs-identifier">ex_tvs</span></a></a><span>
</span><a name="line-2057"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272659"><a href="#local-6989586621682272659"><span class="hs-identifier">mcxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272660"><a href="#local-6989586621682272660"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2058"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_doc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272661"><a href="#local-6989586621682272661"><span class="hs-identifier">mb_doc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2059"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="RnNames.html#checkConName"><span class="hs-identifier hs-var">checkConName</span></a><span> </span><a href="#local-6989586621682272657"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2060"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272662"><a href="#local-6989586621682272662"><span class="hs-identifier">new_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupLocatedTopBndrRn"><span class="hs-identifier hs-var">lookupLocatedTopBndrRn</span></a><span> </span><a href="#local-6989586621682272657"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2061"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272663"><a href="#local-6989586621682272663"><span class="hs-identifier">mb_doc'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnHsDoc.html#rnMbLHsDoc"><span class="hs-identifier hs-var">rnMbLHsDoc</span></a><span> </span><a href="#local-6989586621682272661"><span class="hs-identifier hs-var">mb_doc</span></a><span>
</span><a name="line-2062"></a><span>
</span><a name="line-2063"></a><span>        </span><span class="hs-comment">-- We bind no implicit binders here; this is just like</span><span>
</span><a name="line-2064"></a><span>        </span><span class="hs-comment">-- a nested HsForAllTy.  E.g. consider</span><span>
</span><a name="line-2065"></a><span>        </span><span class="hs-comment">--         data T a = forall (b::k). MkT (...)</span><span>
</span><a name="line-2066"></a><span>        </span><span class="hs-comment">-- The 'k' will already be in scope from the bindHsQTyVars</span><span>
</span><a name="line-2067"></a><span>        </span><span class="hs-comment">-- for the data decl itself. So we'll get</span><span>
</span><a name="line-2068"></a><span>        </span><span class="hs-comment">--         data T {k} a = ...</span><span>
</span><a name="line-2069"></a><span>        </span><span class="hs-comment">-- And indeed we may later discover (a::k).  But that's the</span><span>
</span><a name="line-2070"></a><span>        </span><span class="hs-comment">-- scoping we get.  So no implicit binders at the existential forall</span><span>
</span><a name="line-2071"></a><span>
</span><a name="line-2072"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272664"><a href="#local-6989586621682272664"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#ConDeclCtx"><span class="hs-identifier hs-var">ConDeclCtx</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272662"><span class="hs-identifier hs-var">new_name</span></a><span class="hs-special">]</span><span>
</span><a name="line-2073"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnTypes.html#bindLHsTyVarBndrs"><span class="hs-identifier hs-var">bindLHsTyVarBndrs</span></a><span> </span><a href="#local-6989586621682272664"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="RnUtils.html#inHsDocContext"><span class="hs-identifier hs-var">inHsDocContext</span></a><span> </span><a href="#local-6989586621682272664"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2074"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272658"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272665"><a href="#local-6989586621682272665"><span class="hs-identifier">new_ex_tvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2075"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272666"><a href="#local-6989586621682272666"><span class="hs-identifier">new_context</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272667"><a href="#local-6989586621682272667"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnMbContext"><span class="hs-identifier hs-var">rnMbContext</span></a><span> </span><a href="#local-6989586621682272664"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682272659"><span class="hs-identifier hs-var">mcxt</span></a><span>
</span><a name="line-2076"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272668"><a href="#local-6989586621682272668"><span class="hs-identifier">new_args</span></a></a><span class="hs-special">,</span><span>    </span><a name="local-6989586621682272669"><a href="#local-6989586621682272669"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnConDeclDetails"><span class="hs-identifier hs-var">rnConDeclDetails</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621682272662"><span class="hs-identifier hs-var">new_name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272664"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682272660"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2077"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272670"><a href="#local-6989586621682272670"><span class="hs-identifier">all_fvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272667"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272669"><span class="hs-identifier hs-var">fvs2</span></a><span>
</span><a name="line-2078"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnConDecl&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272657"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-2079"></a><span>             </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ex_tvs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272658"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-2080"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;new_ex_dqtvs':&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272665"><span class="hs-identifier hs-var">new_ex_tvs</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2081"></a><span>
</span><a name="line-2082"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272656"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2083"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272662"><span class="hs-identifier hs-var">new_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_ex_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272665"><span class="hs-identifier hs-var">new_ex_tvs</span></a><span>
</span><a name="line-2084"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272666"><span class="hs-identifier hs-var">new_context</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272668"><span class="hs-identifier hs-var">new_args</span></a><span>
</span><a name="line-2085"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_doc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272663"><span class="hs-identifier hs-var">mb_doc'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-2086"></a><span>                  </span><a href="#local-6989586621682272670"><span class="hs-identifier hs-var">all_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-2087"></a><span>
</span><a name="line-2088"></a><span class="hs-identifier">rnConDecl</span><span> </span><a name="local-6989586621682272671"><a href="#local-6989586621682272671"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConDeclGADT</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_names</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272672"><a href="#local-6989586621682272672"><span class="hs-identifier">names</span></a></a><span>
</span><a name="line-2089"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_forall</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272673"><a href="#local-6989586621682272673"><span class="hs-identifier">explicit_forall</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2090"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_qvars</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272674"><a href="#local-6989586621682272674"><span class="hs-identifier">qtvs</span></a></a><span>
</span><a name="line-2091"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_mb_cxt</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272675"><a href="#local-6989586621682272675"><span class="hs-identifier">mcxt</span></a></a><span>
</span><a name="line-2092"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272676"><a href="#local-6989586621682272676"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2093"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_res_ty</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272677"><a href="#local-6989586621682272677"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-2094"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_doc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272678"><a href="#local-6989586621682272678"><span class="hs-identifier">mb_doc</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2095"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="RnNames.html#checkConName"><span class="hs-identifier hs-var">checkConName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272672"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-2096"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272679"><a href="#local-6989586621682272679"><span class="hs-identifier">new_names</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="RnEnv.html#lookupLocatedTopBndrRn"><span class="hs-identifier hs-var">lookupLocatedTopBndrRn</span></a><span> </span><a href="#local-6989586621682272672"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-2097"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272680"><a href="#local-6989586621682272680"><span class="hs-identifier">mb_doc'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnHsDoc.html#rnMbLHsDoc"><span class="hs-identifier hs-var">rnMbLHsDoc</span></a><span> </span><a href="#local-6989586621682272678"><span class="hs-identifier hs-var">mb_doc</span></a><span>
</span><a name="line-2098"></a><span>
</span><a name="line-2099"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272681"><a href="#local-6989586621682272681"><span class="hs-identifier">explicit_tkvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsQTvExplicit</span><span> </span><a href="#local-6989586621682272674"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-2100"></a><span>              </span><a name="local-6989586621682272682"><a href="#local-6989586621682272682"><span class="hs-identifier">theta</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsConDeclTheta</span><span> </span><a href="#local-6989586621682272675"><span class="hs-identifier hs-var">mcxt</span></a><span>
</span><a name="line-2101"></a><span>              </span><a name="local-6989586621682272683"><a href="#local-6989586621682272683"><span class="hs-identifier">arg_tys</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsConDeclArgTys</span><span> </span><a href="#local-6989586621682272676"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2102"></a><span>
</span><a name="line-2103"></a><span>          </span><span class="hs-comment">-- We must ensure that we extract the free tkvs in left-to-right</span><span>
</span><a name="line-2104"></a><span>          </span><span class="hs-comment">-- order of their appearance in the constructor type.</span><span>
</span><a name="line-2105"></a><span>          </span><span class="hs-comment">-- That order governs the order the implicitly-quantified type</span><span>
</span><a name="line-2106"></a><span>          </span><span class="hs-comment">-- variable, and hence the order needed for visible type application</span><span>
</span><a name="line-2107"></a><span>          </span><span class="hs-comment">-- See Trac #14808.</span><span>
</span><a name="line-2108"></a><span>              </span><a name="local-6989586621682272684"><a href="#local-6989586621682272684"><span class="hs-identifier">free_tkvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnTypes.html#extractHsTvBndrs"><span class="hs-identifier hs-var">extractHsTvBndrs</span></a><span> </span><a href="#local-6989586621682272681"><span class="hs-identifier hs-var">explicit_tkvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2109"></a><span>                          </span><a href="RnTypes.html#extractHsTysRdrTyVarsDups"><span class="hs-identifier hs-var">extractHsTysRdrTyVarsDups</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272682"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272683"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272677"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2110"></a><span>
</span><a name="line-2111"></a><span>              </span><a name="local-6989586621682272685"><a href="#local-6989586621682272685"><span class="hs-identifier">ctxt</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="RnUtils.html#ConDeclCtx"><span class="hs-identifier hs-var">ConDeclCtx</span></a><span> </span><a href="#local-6989586621682272679"><span class="hs-identifier hs-var">new_names</span></a><span>
</span><a name="line-2112"></a><span>              </span><a name="local-6989586621682272686"><a href="#local-6989586621682272686"><span class="hs-identifier">mb_ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="RnUtils.html#inHsDocContext"><span class="hs-identifier hs-var">inHsDocContext</span></a><span> </span><a href="#local-6989586621682272685"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-2113"></a><span>
</span><a name="line-2114"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnConDecl&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272672"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272684"><span class="hs-identifier hs-var">free_tkvs</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272673"><span class="hs-identifier hs-var">explicit_forall</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2115"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="RnTypes.html#rnImplicitBndrs"><span class="hs-identifier hs-var">rnImplicitBndrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682272673"><span class="hs-identifier hs-var">explicit_forall</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272684"><span class="hs-identifier hs-var">free_tkvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272687"><a href="#local-6989586621682272687"><span class="hs-identifier">implicit_tkvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2116"></a><span>          </span><a href="RnTypes.html#bindLHsTyVarBndrs"><span class="hs-identifier hs-var">bindLHsTyVarBndrs</span></a><span> </span><a href="#local-6989586621682272685"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682272686"><span class="hs-identifier hs-var">mb_ctxt</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621682272681"><span class="hs-identifier hs-var">explicit_tkvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682272688"><a href="#local-6989586621682272688"><span class="hs-identifier">explicit_tkvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2117"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272689"><a href="#local-6989586621682272689"><span class="hs-identifier">new_cxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272690"><a href="#local-6989586621682272690"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnMbContext"><span class="hs-identifier hs-var">rnMbContext</span></a><span> </span><a href="#local-6989586621682272685"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682272675"><span class="hs-identifier hs-var">mcxt</span></a><span>
</span><a name="line-2118"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272691"><a href="#local-6989586621682272691"><span class="hs-identifier">new_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272692"><a href="#local-6989586621682272692"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnConDeclDetails"><span class="hs-identifier hs-var">rnConDeclDetails</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621682272679"><span class="hs-identifier hs-var">new_names</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272685"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682272676"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2119"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272693"><a href="#local-6989586621682272693"><span class="hs-identifier">new_res_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272694"><a href="#local-6989586621682272694"><span class="hs-identifier">fvs3</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><a href="#local-6989586621682272685"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621682272677"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-2120"></a><span>
</span><a name="line-2121"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272695"><a href="#local-6989586621682272695"><span class="hs-identifier">all_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272690"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272692"><span class="hs-identifier hs-var">fvs2</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272694"><span class="hs-identifier hs-var">fvs3</span></a><span>
</span><a name="line-2122"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621682272696"><a href="#local-6989586621682272696"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272697"><a href="#local-6989586621682272697"><span class="hs-identifier">res_ty'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2123"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272676"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2124"></a><span>                      </span><span class="hs-identifier hs-var">InfixCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;rnConDecl&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272672"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-2125"></a><span>                      </span><span class="hs-identifier hs-var">RecCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272691"><span class="hs-identifier hs-var">new_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272693"><span class="hs-identifier hs-var">new_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2126"></a><span>                      </span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272700"><a href="#local-6989586621682272700"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272701"><a href="#local-6989586621682272701"><span class="hs-identifier">final_res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitHsFunType</span><span> </span><a href="#local-6989586621682272693"><span class="hs-identifier hs-var">new_res_ty</span></a><span>
</span><a name="line-2127"></a><span>                                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2128"></a><span>                                      </span><span class="hs-comment">-- See Note [GADT abstract syntax] in HsDecls</span><span>
</span><a name="line-2129"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><a href="#local-6989586621682272700"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272701"><span class="hs-identifier hs-var">final_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2130"></a><span>
</span><a name="line-2131"></a><span>              </span><a name="local-6989586621682272698"><a href="#local-6989586621682272698"><span class="hs-identifier">new_qtvs</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">HsQTvs</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsQTvsRn</span><span>
</span><a name="line-2132"></a><span>                                     </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_implicit</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272687"><span class="hs-identifier hs-var">implicit_tkvs</span></a><span>
</span><a name="line-2133"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_dependent</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2134"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_explicit</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272688"><span class="hs-identifier hs-var">explicit_tkvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2135"></a><span>
</span><a name="line-2136"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rnConDecl2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272672"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272687"><span class="hs-identifier hs-var">implicit_tkvs</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682272688"><span class="hs-identifier hs-var">explicit_tkvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2137"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272671"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_g_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_names</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272679"><span class="hs-identifier hs-var">new_names</span></a><span>
</span><a name="line-2138"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_qvars</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272698"><span class="hs-identifier hs-var">new_qtvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272689"><span class="hs-identifier hs-var">new_cxt</span></a><span>
</span><a name="line-2139"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272696"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_res_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272697"><span class="hs-identifier hs-var">res_ty'</span></a><span>
</span><a name="line-2140"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_doc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272680"><span class="hs-identifier hs-var">mb_doc'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-2141"></a><span>                  </span><a href="#local-6989586621682272695"><span class="hs-identifier hs-var">all_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2142"></a><span>
</span><a name="line-2143"></a><span class="hs-identifier">rnConDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XConDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;rnConDecl&quot;</span><span>
</span><a name="line-2144"></a><span>
</span><a name="line-2145"></a><span>
</span><a name="line-2146"></a><span class="hs-identifier">rnMbContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsContext</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-2147"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsContext</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-2148"></a><a name="rnMbContext"><a href="RnSource.html#rnMbContext"><span class="hs-identifier">rnMbContext</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-2149"></a><span class="hs-identifier">rnMbContext</span><span> </span><a name="local-6989586621682272702"><a href="#local-6989586621682272702"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682272703"><a href="#local-6989586621682272703"><span class="hs-identifier">cxt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272704"><a href="#local-6989586621682272704"><span class="hs-identifier">ctx'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682272705"><a href="#local-6989586621682272705"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnContext"><span class="hs-identifier hs-var">rnContext</span></a><span> </span><a href="#local-6989586621682272702"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272703"><span class="hs-identifier hs-var">cxt</span></a><span>
</span><a name="line-2150"></a><span>                                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682272704"><span class="hs-identifier hs-var">ctx'</span></a><span class="hs-special">,</span><a href="#local-6989586621682272705"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2151"></a><span>
</span><a name="line-2152"></a><span class="hs-identifier">rnConDeclDetails</span><span>
</span><a name="line-2153"></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-2154"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span>
</span><a name="line-2155"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsConDetails</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LConDeclField</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2156"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsConDetails</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LConDeclField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-2157"></a><span>           </span><span class="hs-identifier hs-type">FreeVars</span><span class="hs-special">)</span><span>
</span><a name="line-2158"></a><a name="rnConDeclDetails"><a href="RnSource.html#rnConDeclDetails"><span class="hs-identifier">rnConDeclDetails</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272706"><a href="#local-6989586621682272706"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><a name="local-6989586621682272707"><a href="#local-6989586621682272707"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2159"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272708"><a href="#local-6989586621682272708"><span class="hs-identifier">new_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272709"><a href="#local-6989586621682272709"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsTypes"><span class="hs-identifier hs-var">rnLHsTypes</span></a><span> </span><a href="#local-6989586621682272706"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272707"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2160"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><a href="#local-6989586621682272708"><span class="hs-identifier hs-var">new_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272709"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2161"></a><span>
</span><a name="line-2162"></a><span class="hs-identifier">rnConDeclDetails</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272710"><a href="#local-6989586621682272710"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InfixCon</span><span> </span><a name="local-6989586621682272711"><a href="#local-6989586621682272711"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682272712"><a href="#local-6989586621682272712"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2163"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272713"><a href="#local-6989586621682272713"><span class="hs-identifier">new_ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272714"><a href="#local-6989586621682272714"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><a href="#local-6989586621682272710"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272711"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-2164"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272715"><a href="#local-6989586621682272715"><span class="hs-identifier">new_ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272716"><a href="#local-6989586621682272716"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnLHsType"><span class="hs-identifier hs-var">rnLHsType</span></a><span> </span><a href="#local-6989586621682272710"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272712"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2165"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InfixCon</span><span> </span><a href="#local-6989586621682272713"><span class="hs-identifier hs-var">new_ty1</span></a><span> </span><a href="#local-6989586621682272715"><span class="hs-identifier hs-var">new_ty2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272714"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusFV</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272716"><span class="hs-identifier hs-var">fvs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2166"></a><span>
</span><a name="line-2167"></a><span class="hs-identifier">rnConDeclDetails</span><span> </span><a name="local-6989586621682272717"><a href="#local-6989586621682272717"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621682272718"><a href="#local-6989586621682272718"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272719"><a href="#local-6989586621682272719"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682272720"><a href="#local-6989586621682272720"><span class="hs-identifier">fields</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2168"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272721"><a href="#local-6989586621682272721"><span class="hs-identifier">fls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupConstructorFields"><span class="hs-identifier hs-var">lookupConstructorFields</span></a><span> </span><a href="#local-6989586621682272717"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2169"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272722"><a href="#local-6989586621682272722"><span class="hs-identifier">new_fields</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272723"><a href="#local-6989586621682272723"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnConDeclFields"><span class="hs-identifier hs-var">rnConDeclFields</span></a><span> </span><a href="#local-6989586621682272718"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682272721"><span class="hs-identifier hs-var">fls</span></a><span> </span><a href="#local-6989586621682272720"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-2170"></a><span>                </span><span class="hs-comment">-- No need to check for duplicate fields</span><span>
</span><a name="line-2171"></a><span>                </span><span class="hs-comment">-- since that is done by RnNames.extendGlobalRdrEnvRn</span><span>
</span><a name="line-2172"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272719"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272722"><span class="hs-identifier hs-var">new_fields</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272723"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2173"></a><span>
</span><a name="line-2174"></a><span class="hs-comment">-------------------------------------------------</span><span>
</span><a name="line-2175"></a><span>
</span><a name="line-2176"></a><span class="hs-comment">-- | Brings pattern synonym names and also pattern synonym selectors</span><span>
</span><a name="line-2177"></a><span class="hs-comment">-- from record pattern synonyms into scope.</span><span>
</span><a name="line-2178"></a><span class="hs-identifier">extendPatSynEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsValBinds</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="RnFixity.html#MiniFixityEnv"><span class="hs-identifier hs-type">MiniFixityEnv</span></a><span>
</span><a name="line-2179"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span> </span><a href="#local-6989586621682271988"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682271988"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2180"></a><a name="extendPatSynEnv"><a href="RnSource.html#extendPatSynEnv"><span class="hs-identifier">extendPatSynEnv</span></a></a><span> </span><a name="local-6989586621682272724"><a href="#local-6989586621682272724"><span class="hs-identifier">val_decls</span></a></a><span> </span><a name="local-6989586621682272725"><a href="#local-6989586621682272725"><span class="hs-identifier">local_fix_env</span></a></a><span> </span><a name="local-6989586621682272726"><a href="#local-6989586621682272726"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-2181"></a><span>     </span><a name="local-6989586621682272745"><a href="#local-6989586621682272745"><span class="hs-identifier">names_with_fls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272727"><span class="hs-identifier hs-var">new_ps</span></a><span> </span><a href="#local-6989586621682272724"><span class="hs-identifier hs-var">val_decls</span></a><span>
</span><a name="line-2182"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272746"><a href="#local-6989586621682272746"><span class="hs-identifier">pat_syn_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682272747"><span class="hs-identifier hs-var">name</span></a><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621682272748"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-2183"></a><span>                                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272747"><a href="#local-6989586621682272747"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272748"><a href="#local-6989586621682272748"><span class="hs-identifier">fields</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272745"><span class="hs-identifier hs-var">names_with_fls</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2184"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272749"><a href="#local-6989586621682272749"><span class="hs-identifier">avails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">avail</span><span> </span><a href="#local-6989586621682272746"><span class="hs-identifier hs-var">pat_syn_bndrs</span></a><span>
</span><a name="line-2185"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272750"><a href="#local-6989586621682272750"><span class="hs-identifier">gbl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272751"><a href="#local-6989586621682272751"><span class="hs-identifier">lcl_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#extendGlobalRdrEnvRn"><span class="hs-identifier hs-var">extendGlobalRdrEnvRn</span></a><span> </span><a href="#local-6989586621682272749"><span class="hs-identifier hs-var">avails</span></a><span> </span><a href="#local-6989586621682272725"><span class="hs-identifier hs-var">local_fix_env</span></a><span>
</span><a name="line-2186"></a><span>
</span><a name="line-2187"></a><span>   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272752"><a href="#local-6989586621682272752"><span class="hs-identifier">field_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_field_env</span><span> </span><a href="#local-6989586621682272750"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272745"><span class="hs-identifier hs-var">names_with_fls</span></a><span>
</span><a name="line-2188"></a><span>         </span><a name="local-6989586621682272753"><a href="#local-6989586621682272753"><span class="hs-identifier">final_gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272750"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_field_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272752"><span class="hs-identifier hs-var">field_env'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2189"></a><span>   </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272753"><span class="hs-identifier hs-var">final_gbl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272751"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272726"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-6989586621682272746"><span class="hs-identifier hs-var">pat_syn_bndrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2190"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2191"></a><span>    </span><span class="hs-identifier">new_ps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsValBinds</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2192"></a><span>    </span><a name="local-6989586621682272727"><a href="#local-6989586621682272727"><span class="hs-identifier">new_ps</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ValBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272729"><a href="#local-6989586621682272729"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBagM</span><span> </span><a href="#local-6989586621682272728"><span class="hs-identifier hs-var">new_ps'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682272729"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-2193"></a><span>    </span><span class="hs-identifier">new_ps</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;new_ps&quot;</span><span>
</span><a name="line-2194"></a><span>
</span><a name="line-2195"></a><span>    </span><span class="hs-identifier">new_ps'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsBindLR</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-2196"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2197"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2198"></a><span>    </span><a name="local-6989586621682272728"><a href="#local-6989586621682272728"><span class="hs-identifier">new_ps'</span></a></a><span> </span><a name="local-6989586621682272730"><a href="#local-6989586621682272730"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621682272731"><a href="#local-6989586621682272731"><span class="hs-identifier">names</span></a></a><span>
</span><a name="line-2199"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272732"><a href="#local-6989586621682272732"><span class="hs-identifier">bind_loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynBind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PSB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psb_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272733"><a href="#local-6989586621682272733"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2200"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">psb_args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecCon</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272730"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-2201"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2202"></a><span>          </span><a name="local-6989586621682272735"><a href="#local-6989586621682272735"><span class="hs-identifier">bnd_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#newTopSrcBinder"><span class="hs-identifier hs-var">newTopSrcBinder</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272732"><span class="hs-identifier hs-var">bind_loc</span></a><span> </span><a href="#local-6989586621682272733"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-2203"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272736"><a href="#local-6989586621682272736"><span class="hs-identifier">rnames</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">recordPatSynSelectorId</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-2204"></a><span>              </span><span class="hs-identifier">mkFieldOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LFieldOcc</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-2205"></a><span>              </span><a name="local-6989586621682272737"><a href="#local-6989586621682272737"><span class="hs-identifier">mkFieldOcc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272739"><a href="#local-6989586621682272739"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682272740"><a href="#local-6989586621682272740"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272739"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272739"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272740"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2206"></a><span>              </span><a name="local-6989586621682272738"><a href="#local-6989586621682272738"><span class="hs-identifier">field_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682272737"><span class="hs-identifier hs-var">mkFieldOcc</span></a><span> </span><a href="#local-6989586621682272736"><span class="hs-identifier hs-var">rnames</span></a><span>
</span><a name="line-2207"></a><span>          </span><a name="local-6989586621682272741"><a href="#local-6989586621682272741"><span class="hs-identifier">flds</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RnNames.html#newRecordSelector"><span class="hs-identifier hs-var">newRecordSelector</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272735"><span class="hs-identifier hs-var">bnd_name</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272738"><span class="hs-identifier hs-var">field_occs</span></a><span>
</span><a name="line-2208"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682272735"><span class="hs-identifier hs-var">bnd_name</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272741"><span class="hs-identifier hs-var">flds</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272731"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-2209"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272742"><a href="#local-6989586621682272742"><span class="hs-identifier">bind_loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynBind</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-2210"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PSB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">psb_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272743"><a href="#local-6989586621682272743"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682272730"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-2211"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2212"></a><span>        </span><a name="local-6989586621682272744"><a href="#local-6989586621682272744"><span class="hs-identifier">bnd_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#newTopSrcBinder"><span class="hs-identifier hs-var">newTopSrcBinder</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272742"><span class="hs-identifier hs-var">bind_loc</span></a><span> </span><a href="#local-6989586621682272743"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-2213"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682272744"><span class="hs-identifier hs-var">bnd_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272731"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-2214"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2215"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682272731"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-2216"></a><span>
</span><a name="line-2217"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
\subsection{Support code to rename types}
*                                                      *
*********************************************************
-}</span><span>
</span><a name="line-2224"></a><span>
</span><a name="line-2225"></a><span class="hs-identifier">rnFds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsFunDep</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsFunDep</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-2226"></a><a name="rnFds"><a href="RnSource.html#rnFds"><span class="hs-identifier">rnFds</span></a></a><span> </span><a name="local-6989586621682272754"><a href="#local-6989586621682272754"><span class="hs-identifier">fds</span></a></a><span>
</span><a name="line-2227"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="#local-6989586621682272755"><span class="hs-identifier hs-var">rn_fds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272754"><span class="hs-identifier hs-var">fds</span></a><span>
</span><a name="line-2228"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2229"></a><span>    </span><a name="local-6989586621682272755"><a href="#local-6989586621682272755"><span class="hs-identifier">rn_fds</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682272756"><a href="#local-6989586621682272756"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682272757"><a href="#local-6989586621682272757"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2230"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272758"><a href="#local-6989586621682272758"><span class="hs-identifier">tys1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnHsTyVars"><span class="hs-identifier hs-var">rnHsTyVars</span></a><span> </span><a href="#local-6989586621682272756"><span class="hs-identifier hs-var">tys1</span></a><span>
</span><a name="line-2231"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682272759"><a href="#local-6989586621682272759"><span class="hs-identifier">tys2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#rnHsTyVars"><span class="hs-identifier hs-var">rnHsTyVars</span></a><span> </span><a href="#local-6989586621682272757"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-2232"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272758"><span class="hs-identifier hs-var">tys1'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272759"><span class="hs-identifier hs-var">tys2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2233"></a><span>
</span><a name="line-2234"></a><span class="hs-identifier">rnHsTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-2235"></a><a name="rnHsTyVars"><a href="RnSource.html#rnHsTyVars"><span class="hs-identifier">rnHsTyVars</span></a></a><span> </span><a name="local-6989586621682272760"><a href="#local-6989586621682272760"><span class="hs-identifier">tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="RnSource.html#rnHsTyVar"><span class="hs-identifier hs-var">rnHsTyVar</span></a><span> </span><a href="#local-6989586621682272760"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-2236"></a><span>
</span><a name="line-2237"></a><span class="hs-identifier">rnHsTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-2238"></a><a name="rnHsTyVar"><a href="RnSource.html#rnHsTyVar"><span class="hs-identifier">rnHsTyVar</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272761"><a href="#local-6989586621682272761"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682272762"><a href="#local-6989586621682272762"><span class="hs-identifier">tyvar</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2239"></a><span>  </span><a name="local-6989586621682272763"><a href="#local-6989586621682272763"><span class="hs-identifier">tyvar'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupOccRn"><span class="hs-identifier hs-var">lookupOccRn</span></a><span> </span><a href="#local-6989586621682272762"><span class="hs-identifier hs-var">tyvar</span></a><span>
</span><a name="line-2240"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272761"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272763"><span class="hs-identifier hs-var">tyvar'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2241"></a><span>
</span><a name="line-2242"></a><span class="hs-comment">{-
*********************************************************
*                                                      *
        findSplice
*                                                      *
*********************************************************

This code marches down the declarations, looking for the first
Template Haskell splice.  As it does so it
        a) groups the declarations into a HsGroup
        b) runs any top-level quasi-quotes
-}</span><span>
</span><a name="line-2254"></a><span>
</span><a name="line-2255"></a><span class="hs-identifier">findSplice</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-2256"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SpliceDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2257"></a><a name="findSplice"><a href="RnSource.html#findSplice"><span class="hs-identifier">findSplice</span></a></a><span> </span><a name="local-6989586621682272764"><a href="#local-6989586621682272764"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-identifier hs-var">emptyRdrGroup</span><span> </span><a href="#local-6989586621682272764"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2258"></a><span>
</span><a name="line-2259"></a><span class="hs-identifier">addl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-2260"></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SpliceDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2261"></a><span class="hs-comment">-- This stuff reverses the declarations (again) but it doesn't matter</span><span>
</span><a name="line-2262"></a><a name="addl"><a href="RnSource.html#addl"><span class="hs-identifier">addl</span></a></a><span> </span><a name="local-6989586621682272765"><a href="#local-6989586621682272765"><span class="hs-identifier">gp</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272765"><span class="hs-identifier hs-var">gp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-2263"></a><span class="hs-identifier">addl</span><span> </span><a name="local-6989586621682272766"><a href="#local-6989586621682272766"><span class="hs-identifier">gp</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272767"><a href="#local-6989586621682272767"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621682272768"><a href="#local-6989586621682272768"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682272769"><a href="#local-6989586621682272769"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#add"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621682272766"><span class="hs-identifier hs-var">gp</span></a><span> </span><a href="#local-6989586621682272767"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272768"><span class="hs-identifier hs-var">d</span></a><span> </span><a href="#local-6989586621682272769"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2264"></a><span>
</span><a name="line-2265"></a><span>
</span><a name="line-2266"></a><span class="hs-identifier">add</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-2267"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SpliceDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2268"></a><span>
</span><a name="line-2269"></a><span class="hs-comment">-- #10047: Declaration QuasiQuoters are expanded immediately, without</span><span>
</span><a name="line-2270"></a><span class="hs-comment">--         causing a group split</span><span>
</span><a name="line-2271"></a><a name="add"><a href="RnSource.html#add"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621682272770"><a href="#local-6989586621682272770"><span class="hs-identifier">gp</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272771"><a href="#local-6989586621682272771"><span class="hs-identifier">qq</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">HsQuasiQuote</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272772"><a href="#local-6989586621682272772"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2272"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682272773"><a href="#local-6989586621682272773"><span class="hs-identifier">ds'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSplice.html#rnTopSpliceDecls"><span class="hs-identifier hs-var">rnTopSpliceDecls</span></a><span> </span><a href="#local-6989586621682272771"><span class="hs-identifier hs-var">qq</span></a><span>
</span><a name="line-2273"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><a href="#local-6989586621682272770"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272773"><span class="hs-identifier hs-var">ds'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272772"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-2274"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-2275"></a><span>
</span><a name="line-2276"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272774"><a href="#local-6989586621682272774"><span class="hs-identifier">gp</span></a></a><span> </span><a name="local-6989586621682272775"><a href="#local-6989586621682272775"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272776"><a href="#local-6989586621682272776"><span class="hs-identifier">splice</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272777"><a href="#local-6989586621682272777"><span class="hs-identifier">flag</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272778"><a href="#local-6989586621682272778"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2277"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- We've found a top-level splice.  If it is an *implicit* one</span><span>
</span><a name="line-2278"></a><span>         </span><span class="hs-comment">-- (i.e. a naked top level expression)</span><span>
</span><a name="line-2279"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682272777"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2280"></a><span>           </span><span class="hs-identifier hs-var">ExplicitSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2281"></a><span>           </span><span class="hs-identifier hs-var">ImplicitSplice</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682272780"><a href="#local-6989586621682272780"><span class="hs-identifier">th_on</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.TemplateHaskell</span><span>
</span><a name="line-2282"></a><span>                                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621682272780"><span class="hs-identifier hs-var">th_on</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621682272775"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2283"></a><span>                                  </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><a href="#local-6989586621682272779"><span class="hs-identifier hs-var">badImplicitSplice</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2284"></a><span>
</span><a name="line-2285"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272774"><span class="hs-identifier hs-var">gp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272776"><span class="hs-identifier hs-var">splice</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682272778"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2286"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2287"></a><span>    </span><a name="local-6989586621682272779"><a href="#local-6989586621682272779"><span class="hs-identifier">badImplicitSplice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Parse error: module header, import declaration&quot;</span><span>
</span><a name="line-2288"></a><span>                     </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;or top-level declaration expected.&quot;</span><span>
</span><a name="line-2289"></a><span>                     </span><span class="hs-comment">-- The compiler should suggest the above, and not using</span><span>
</span><a name="line-2290"></a><span>                     </span><span class="hs-comment">-- TemplateHaskell since the former suggestion is more</span><span>
</span><a name="line-2291"></a><span>                     </span><span class="hs-comment">-- relevant to the larger base of users.</span><span>
</span><a name="line-2292"></a><span>                     </span><span class="hs-comment">-- See Trac #12146 for discussion.</span><span>
</span><a name="line-2293"></a><span>
</span><a name="line-2294"></a><span class="hs-comment">-- Class declarations: pull out the fixity signatures to the top</span><span>
</span><a name="line-2295"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272781"><a href="#local-6989586621682272781"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272782"><a href="#local-6989586621682272782"><span class="hs-identifier">ts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hs_fixds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272783"><a href="#local-6989586621682272783"><span class="hs-identifier">fs</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272784"><a href="#local-6989586621682272784"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyClD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272785"><a href="#local-6989586621682272785"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272786"><a href="#local-6989586621682272786"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2296"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isClassDecl</span><span> </span><a href="#local-6989586621682272785"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-2297"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682272787"><a href="#local-6989586621682272787"><span class="hs-identifier">fsigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272788"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272789"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-2298"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621682272788"><a href="#local-6989586621682272788"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FixSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272789"><a href="#local-6989586621682272789"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">tcdSigs</span><span> </span><a href="#local-6989586621682272785"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-2299"></a><span>    </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272781"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#add_tycld"><span class="hs-identifier hs-var">add_tycld</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272784"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272785"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272782"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hs_fixds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272787"><span class="hs-identifier hs-var">fsigs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682272783"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272786"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2300"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2301"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272781"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#add_tycld"><span class="hs-identifier hs-var">add_tycld</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272784"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272785"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272782"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272786"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2302"></a><span>
</span><a name="line-2303"></a><span class="hs-comment">-- Signatures: fixity sigs go a different place than all others</span><span>
</span><a name="line-2304"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272790"><a href="#local-6989586621682272790"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_fixds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272791"><a href="#local-6989586621682272791"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272792"><a href="#local-6989586621682272792"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FixSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272793"><a href="#local-6989586621682272793"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272794"><a href="#local-6989586621682272794"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2305"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272790"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_fixds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272792"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272793"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272791"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272794"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2306"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272795"><a href="#local-6989586621682272795"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_valds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272796"><a href="#local-6989586621682272796"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272797"><a href="#local-6989586621682272797"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272798"><a href="#local-6989586621682272798"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272799"><a href="#local-6989586621682272799"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2307"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272795"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_valds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#add_sig"><span class="hs-identifier hs-var">add_sig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272797"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272798"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272796"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272799"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2308"></a><span>
</span><a name="line-2309"></a><span class="hs-comment">-- Value declarations: use add_bind</span><span>
</span><a name="line-2310"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272800"><a href="#local-6989586621682272800"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_valds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272801"><a href="#local-6989586621682272801"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272802"><a href="#local-6989586621682272802"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ValD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272803"><a href="#local-6989586621682272803"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272804"><a href="#local-6989586621682272804"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2311"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272800"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_valds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#add_bind"><span class="hs-identifier hs-var">add_bind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272802"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272803"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272801"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272804"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2312"></a><span>
</span><a name="line-2313"></a><span class="hs-comment">-- Role annotations: added to the TyClGroup</span><span>
</span><a name="line-2314"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272805"><a href="#local-6989586621682272805"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272806"><a href="#local-6989586621682272806"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272807"><a href="#local-6989586621682272807"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RoleAnnotD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272808"><a href="#local-6989586621682272808"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272809"><a href="#local-6989586621682272809"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2315"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272805"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#add_role_annot"><span class="hs-identifier hs-var">add_role_annot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272807"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272808"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272806"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272809"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2316"></a><span>
</span><a name="line-2317"></a><span class="hs-comment">-- NB instance declarations go into TyClGroups. We throw them into the first</span><span>
</span><a name="line-2318"></a><span class="hs-comment">-- group, just as we do for the TyClD case. The renamer will go on to group</span><span>
</span><a name="line-2319"></a><span class="hs-comment">-- and order them later.</span><span>
</span><a name="line-2320"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272810"><a href="#local-6989586621682272810"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272811"><a href="#local-6989586621682272811"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><a name="local-6989586621682272812"><a href="#local-6989586621682272812"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272813"><a href="#local-6989586621682272813"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272814"><a href="#local-6989586621682272814"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2321"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272810"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#add_instd"><span class="hs-identifier hs-var">add_instd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272812"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272813"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272811"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272814"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2322"></a><span>
</span><a name="line-2323"></a><span class="hs-comment">-- The rest are routine</span><span>
</span><a name="line-2324"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272815"><a href="#local-6989586621682272815"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_derivds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272816"><a href="#local-6989586621682272816"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><a name="local-6989586621682272817"><a href="#local-6989586621682272817"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DerivD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272818"><a href="#local-6989586621682272818"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272819"><a href="#local-6989586621682272819"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2325"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272815"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_derivds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272817"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272818"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272816"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272819"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2326"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272820"><a href="#local-6989586621682272820"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_defds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272821"><a href="#local-6989586621682272821"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><a name="local-6989586621682272822"><a href="#local-6989586621682272822"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DefD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272823"><a href="#local-6989586621682272823"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272824"><a href="#local-6989586621682272824"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2327"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272820"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_defds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272822"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272823"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272821"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272824"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2328"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272825"><a href="#local-6989586621682272825"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_fords</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272826"><a href="#local-6989586621682272826"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272827"><a href="#local-6989586621682272827"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272828"><a href="#local-6989586621682272828"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272829"><a href="#local-6989586621682272829"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2329"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272825"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_fords</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272827"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272828"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272826"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272829"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2330"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272830"><a href="#local-6989586621682272830"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_warnds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272831"><a href="#local-6989586621682272831"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><a name="local-6989586621682272832"><a href="#local-6989586621682272832"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WarningD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272833"><a href="#local-6989586621682272833"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272834"><a href="#local-6989586621682272834"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2331"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272830"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_warnds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272832"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272833"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272831"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272834"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2332"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272835"><a href="#local-6989586621682272835"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_annds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272836"><a href="#local-6989586621682272836"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272837"><a href="#local-6989586621682272837"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnnD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272838"><a href="#local-6989586621682272838"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272839"><a href="#local-6989586621682272839"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2333"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272835"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_annds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272837"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272838"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272836"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272839"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2334"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272840"><a href="#local-6989586621682272840"><span class="hs-identifier">gp</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hs_ruleds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272841"><a href="#local-6989586621682272841"><span class="hs-identifier">ts</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682272842"><a href="#local-6989586621682272842"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RuleD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272843"><a href="#local-6989586621682272843"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272844"><a href="#local-6989586621682272844"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2335"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272840"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_ruleds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272842"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272843"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272841"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272844"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2336"></a><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682272845"><a href="#local-6989586621682272845"><span class="hs-identifier">gp</span></a></a><span> </span><a name="local-6989586621682272846"><a href="#local-6989586621682272846"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DocD</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682272847"><a href="#local-6989586621682272847"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682272848"><a href="#local-6989586621682272848"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-2337"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="RnSource.html#addl"><span class="hs-identifier hs-var">addl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272845"><span class="hs-identifier hs-var">gp</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_docs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621682272846"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621682272847"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hs_docs</span><span> </span><a href="#local-6989586621682272845"><span class="hs-identifier hs-var">gp</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><a href="#local-6989586621682272848"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2338"></a><span class="hs-identifier">add</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XSpliceDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;RnSource.add&quot;</span><span>
</span><a name="line-2339"></a><span class="hs-identifier">add</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                 </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;RnSource.add&quot;</span><span>
</span><a name="line-2340"></a><span class="hs-identifier">add</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsGroup</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>                           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;RnSource.add&quot;</span><span>
</span><a name="line-2341"></a><span>
</span><a name="line-2342"></a><span class="hs-identifier">add_tycld</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LTyClDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271987"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271987"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2343"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271987"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2344"></a><a name="add_tycld"><a href="RnSource.html#add_tycld"><span class="hs-identifier">add_tycld</span></a></a><span> </span><a name="local-6989586621682272849"><a href="#local-6989586621682272849"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TyClGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_ext</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2345"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272849"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">]</span><span>
</span><a name="line-2346"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_roles</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2347"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_instds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2348"></a><span>                                  </span><span class="hs-special">}</span><span>
</span><a name="line-2349"></a><span>                       </span><span class="hs-special">]</span><span>
</span><a name="line-2350"></a><span class="hs-identifier">add_tycld</span><span> </span><a name="local-6989586621682272850"><a href="#local-6989586621682272850"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682272851"><a href="#local-6989586621682272851"><span class="hs-identifier">ds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyClGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272852"><a href="#local-6989586621682272852"><span class="hs-identifier">tyclds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621682272853"><a href="#local-6989586621682272853"><span class="hs-identifier">dss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2351"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272851"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272850"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272852"><span class="hs-identifier hs-var">tyclds</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272853"><span class="hs-identifier hs-var">dss</span></a><span>
</span><a name="line-2352"></a><span class="hs-identifier">add_tycld</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTyClGroup</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;add_tycld&quot;</span><span>
</span><a name="line-2353"></a><span>
</span><a name="line-2354"></a><span class="hs-identifier">add_instd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LInstDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271986"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271986"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2355"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271986"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2356"></a><a name="add_instd"><a href="RnSource.html#add_instd"><span class="hs-identifier">add_instd</span></a></a><span> </span><a name="local-6989586621682272854"><a href="#local-6989586621682272854"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TyClGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_ext</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2357"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2358"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_roles</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2359"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_instds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272854"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">]</span><span>
</span><a name="line-2360"></a><span>                                  </span><span class="hs-special">}</span><span>
</span><a name="line-2361"></a><span>                       </span><span class="hs-special">]</span><span>
</span><a name="line-2362"></a><span class="hs-identifier">add_instd</span><span> </span><a name="local-6989586621682272855"><a href="#local-6989586621682272855"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682272856"><a href="#local-6989586621682272856"><span class="hs-identifier">ds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyClGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_instds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272857"><a href="#local-6989586621682272857"><span class="hs-identifier">instds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621682272858"><a href="#local-6989586621682272858"><span class="hs-identifier">dss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2363"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272856"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_instds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272855"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272857"><span class="hs-identifier hs-var">instds</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272858"><span class="hs-identifier hs-var">dss</span></a><span>
</span><a name="line-2364"></a><span class="hs-identifier">add_instd</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTyClGroup</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;add_instd&quot;</span><span>
</span><a name="line-2365"></a><span>
</span><a name="line-2366"></a><span class="hs-identifier">add_role_annot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LRoleAnnotDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271985"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271985"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2367"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271985"><span class="hs-identifier hs-type">p</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2368"></a><a name="add_role_annot"><a href="RnSource.html#add_role_annot"><span class="hs-identifier">add_role_annot</span></a></a><span> </span><a name="local-6989586621682272859"><a href="#local-6989586621682272859"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">TyClGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_ext</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2369"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2370"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_roles</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682272859"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">]</span><span>
</span><a name="line-2371"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_instds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2372"></a><span>                                 </span><span class="hs-special">}</span><span>
</span><a name="line-2373"></a><span>                      </span><span class="hs-special">]</span><span>
</span><a name="line-2374"></a><span class="hs-identifier">add_role_annot</span><span> </span><a name="local-6989586621682272860"><a href="#local-6989586621682272860"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682272861"><a href="#local-6989586621682272861"><span class="hs-identifier">tycls</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyClGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_roles</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682272862"><a href="#local-6989586621682272862"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682272863"><a href="#local-6989586621682272863"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2375"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272861"><span class="hs-identifier hs-var">tycls</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_roles</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682272860"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272862"><span class="hs-identifier hs-var">roles</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682272863"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-2376"></a><span class="hs-identifier">add_role_annot</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTyClGroup</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;add_role_annot&quot;</span><span>
</span><a name="line-2377"></a><span>
</span><a name="line-2378"></a><span class="hs-identifier">add_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsBind</span><span> </span><a href="#local-6989586621682271984"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsValBinds</span><span> </span><a href="#local-6989586621682271984"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsValBinds</span><span> </span><a href="#local-6989586621682271984"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2379"></a><a name="add_bind"><a href="RnSource.html#add_bind"><span class="hs-identifier">add_bind</span></a></a><span> </span><a name="local-6989586621682272864"><a href="#local-6989586621682272864"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ValBinds</span><span> </span><a name="local-6989586621682272865"><a href="#local-6989586621682272865"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682272866"><a href="#local-6989586621682272866"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621682272867"><a href="#local-6989586621682272867"><span class="hs-identifier">sigs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValBinds</span><span> </span><a href="#local-6989586621682272865"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272866"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682272864"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682272867"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-2380"></a><span class="hs-identifier">add_bind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XValBindsLR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;RdrHsSyn:add_bind&quot;</span><span>
</span><a name="line-2381"></a><span>
</span><a name="line-2382"></a><span class="hs-identifier">add_sig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271983"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsValBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271983"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsValBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GhcPass</span><span> </span><a href="#local-6989586621682271983"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2383"></a><a name="add_sig"><a href="RnSource.html#add_sig"><span class="hs-identifier">add_sig</span></a></a><span> </span><a name="local-6989586621682272868"><a href="#local-6989586621682272868"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ValBinds</span><span> </span><a name="local-6989586621682272869"><a href="#local-6989586621682272869"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682272870"><a href="#local-6989586621682272870"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621682272871"><a href="#local-6989586621682272871"><span class="hs-identifier">sigs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ValBinds</span><span> </span><a href="#local-6989586621682272869"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682272870"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682272868"><span class="hs-identifier hs-var">s</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682272871"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2384"></a><span class="hs-identifier">add_sig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XValBindsLR</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;RdrHsSyn:add_sig&quot;</span><span>
</span><a name="line-2385"></a></pre></body></html>