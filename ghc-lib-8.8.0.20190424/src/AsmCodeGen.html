<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">--</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- (c) The University of Glasgow 1993-2004</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- This is the top-level module in the native code generator.</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, GADTs, ScopedTypeVariables, UnboxedTuples #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">AsmCodeGen</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>                    </span><span class="hs-comment">-- * Module entry point</span><span>
</span><a name="line-13"></a><span>                    </span><a href="AsmCodeGen.html#nativeCodeGen"><span class="hs-identifier hs-var">nativeCodeGen</span></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>                    </span><span class="hs-comment">-- * Test-only exports: see trac #12744</span><span>
</span><a name="line-16"></a><span>                    </span><span class="hs-comment">-- used by testGraphNoSpills, which needs to access</span><span>
</span><a name="line-17"></a><span>                    </span><span class="hs-comment">-- the register allocator intermediate data structures</span><span>
</span><a name="line-18"></a><span>                    </span><span class="hs-comment">-- cmmNativeGen emits</span><span>
</span><a name="line-19"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="AsmCodeGen.html#cmmNativeGen"><span class="hs-identifier hs-var">cmmNativeGen</span></a><span>
</span><a name="line-20"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="AsmCodeGen.html#x86NcgImpl"><span class="hs-identifier hs-var">x86NcgImpl</span></a><span>
</span><a name="line-22"></a><span>                  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
#include &quot;nativeGen/NCG.h&quot;
</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="X86.CodeGen.html"><span class="hs-identifier">X86.CodeGen</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="X86.Regs.html"><span class="hs-identifier">X86.Regs</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="X86.Instr.html"><span class="hs-identifier">X86.Instr</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="X86.Ppr.html"><span class="hs-identifier">X86.Ppr</span></a><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="SPARC.CodeGen.html"><span class="hs-identifier">SPARC.CodeGen</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="SPARC.Regs.html"><span class="hs-identifier">SPARC.Regs</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="SPARC.Instr.html"><span class="hs-identifier">SPARC.Instr</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="SPARC.Ppr.html"><span class="hs-identifier">SPARC.Ppr</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="SPARC.ShortcutJump.html"><span class="hs-identifier">SPARC.ShortcutJump</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="SPARC.CodeGen.Expand.html"><span class="hs-identifier">SPARC.CodeGen.Expand</span></a><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="PPC.CodeGen.html"><span class="hs-identifier">PPC.CodeGen</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="PPC.Regs.html"><span class="hs-identifier">PPC.Regs</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="PPC.RegInfo.html"><span class="hs-identifier">PPC.RegInfo</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="PPC.Instr.html"><span class="hs-identifier">PPC.Instr</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="PPC.Ppr.html"><span class="hs-identifier">PPC.Ppr</span></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="RegAlloc.Liveness.html"><span class="hs-identifier">RegAlloc.Liveness</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RegAlloc.Linear.Main.html"><span class="hs-identifier">RegAlloc.Linear.Main</span></a><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Linear</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="GraphColor.html"><span class="hs-identifier">GraphColor</span></a><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Color</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RegAlloc.Graph.Main.html"><span class="hs-identifier">RegAlloc.Graph.Main</span></a><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Color</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RegAlloc.Graph.Stats.html"><span class="hs-identifier">RegAlloc.Graph.Stats</span></a><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Color</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RegAlloc.Graph.TrivColorable.html"><span class="hs-identifier">RegAlloc.Graph.TrivColorable</span></a><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Color</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="AsmUtils.html"><span class="hs-identifier">AsmUtils</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="TargetReg.html"><span class="hs-identifier">TargetReg</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="BlockLayout.html"><span class="hs-identifier">BlockLayout</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Config</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="Instruction.html"><span class="hs-identifier">Instruction</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="PIC.html"><span class="hs-identifier">PIC</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Reg.html"><span class="hs-identifier">Reg</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="NCGMonad.html"><span class="hs-identifier">NCGMonad</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="CFG.html"><span class="hs-identifier">CFG</span></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Dwarf.html"><span class="hs-identifier">Dwarf</span></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="Debug.html"><span class="hs-identifier">Debug</span></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="CgUtils.html"><span class="hs-identifier">CgUtils</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="CgUtils.html#fixStgRegisters"><span class="hs-identifier hs-var">fixStgRegisters</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Block.html"><span class="hs-identifier">Hoopl.Block</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="CmmOpt.html"><span class="hs-identifier">CmmOpt</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="CmmOpt.html#cmmMachOpFold"><span class="hs-identifier hs-var">cmmMachOpFold</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="PprCmm.html"><span class="hs-identifier">PprCmm</span></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Alignment</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Pretty</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BufWrite</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><a href="Stream.html"><span class="hs-identifier">Stream</span></a><span> </span><span class="hs-special">(</span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Stream.html"><span class="hs-identifier">Stream</span></a><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span class="hs-comment">-- DEBUGGING ONLY</span><span>
</span><a name="line-97"></a><span class="hs-comment">--import OrdList</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-comment">{-
The native-code generator has machine-independent and
machine-dependent modules.

This module (&quot;AsmCodeGen&quot;) is the top-level machine-independent
module.  Before entering machine-dependent land, we do some
machine-independent optimisations (defined below) on the
'CmmStmts's.

We convert to the machine-specific 'Instr' datatype with
'cmmCodeGen', assuming an infinite supply of registers.  We then use
a machine-independent register allocator ('regAlloc') to rejoin
reality.  Obviously, 'regAlloc' has machine-specific helper
functions (see about &quot;RegAllocInfo&quot; below).

Finally, we order the basic blocks of the function so as to minimise
the number of jumps between blocks, by utilising fallthrough wherever
possible.

The machine-dependent bits break down as follows:

  * [&quot;MachRegs&quot;]  Everything about the target platform's machine
    registers (and immediate operands, and addresses, which tend to
    intermingle/interact with registers).

  * [&quot;MachInstrs&quot;]  Includes the 'Instr' datatype (possibly should
    have a module of its own), plus a miscellany of other things
    (e.g., 'targetDoubleSize', 'smStablePtrTable', ...)

  * [&quot;MachCodeGen&quot;]  is where 'Cmm' stuff turns into
    machine instructions.

  * [&quot;PprMach&quot;] 'pprInstr' turns an 'Instr' into text (well, really
    a 'SDoc').

  * [&quot;RegAllocInfo&quot;] In the register allocator, we manipulate
    'MRegsState's, which are 'BitSet's, one bit per machine register.
    When we want to say something about a specific machine register
    (e.g., ``it gets clobbered by this instruction''), we set/unset
    its bit.  Obviously, we do this 'BitSet' thing for efficiency
    reasons.

    The 'RegAllocInfo' module collects together the machine-specific
    info needed to do register allocation.

   * [&quot;RegisterAlloc&quot;] The (machine-independent) register allocator.
-}</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-155"></a><span class="hs-identifier">nativeCodeGen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-156"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Cmm.html#RawCmmGroup"><span class="hs-identifier hs-type">RawCmmGroup</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-158"></a><a name="nativeCodeGen"><a href="AsmCodeGen.html#nativeCodeGen"><span class="hs-identifier">nativeCodeGen</span></a></a><span> </span><a name="local-6989586621684958287"><a href="#local-6989586621684958287"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958288"><a href="#local-6989586621684958288"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684958289"><a href="#local-6989586621684958289"><span class="hs-identifier">modLoc</span></a></a><span> </span><a name="local-6989586621684958290"><a href="#local-6989586621684958290"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621684958291"><a href="#local-6989586621684958291"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684958292"><a href="#local-6989586621684958292"><span class="hs-identifier">cmms</span></a></a><span>
</span><a name="line-159"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958293"><a href="#local-6989586621684958293"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684958287"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-160"></a><span>       </span><span class="hs-identifier">nCG'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958295"><span class="hs-identifier hs-type">statics</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958296"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-161"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958297"><span class="hs-identifier hs-type">jumpDest</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684958296"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958295"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958296"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958297"><span class="hs-identifier hs-type">jumpDest</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-163"></a><span>       </span><a name="local-6989586621684958294"><a href="#local-6989586621684958294"><span class="hs-identifier">nCG'</span></a></a><span> </span><a name="local-6989586621684958298"><a href="#local-6989586621684958298"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#nativeCodeGen%27"><span class="hs-identifier hs-var">nativeCodeGen'</span></a><span> </span><a href="#local-6989586621684958287"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958288"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958289"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958298"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958290"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621684958291"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684958292"><span class="hs-identifier hs-var">cmms</span></a><span>
</span><a name="line-164"></a><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621684958293"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-165"></a><span>      </span><span class="hs-identifier hs-var">ArchX86</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684958294"><span class="hs-identifier hs-var">nCG'</span></a><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#x86NcgImpl"><span class="hs-identifier hs-var">x86NcgImpl</span></a><span>    </span><a href="#local-6989586621684958287"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>      </span><span class="hs-identifier hs-var">ArchX86_64</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684958294"><span class="hs-identifier hs-var">nCG'</span></a><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#x86_64NcgImpl"><span class="hs-identifier hs-var">x86_64NcgImpl</span></a><span> </span><a href="#local-6989586621684958287"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>      </span><span class="hs-identifier hs-var">ArchPPC</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684958294"><span class="hs-identifier hs-var">nCG'</span></a><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#ppcNcgImpl"><span class="hs-identifier hs-var">ppcNcgImpl</span></a><span>    </span><a href="#local-6989586621684958287"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>      </span><span class="hs-identifier hs-var">ArchSPARC</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684958294"><span class="hs-identifier hs-var">nCG'</span></a><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#sparcNcgImpl"><span class="hs-identifier hs-var">sparcNcgImpl</span></a><span>  </span><a href="#local-6989586621684958287"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>      </span><span class="hs-identifier hs-var">ArchSPARC64</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;nativeCodeGen: No NCG for SPARC64&quot;</span><span>
</span><a name="line-170"></a><span>      </span><span class="hs-identifier hs-var">ArchARM</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;nativeCodeGen: No NCG for ARM&quot;</span><span>
</span><a name="line-171"></a><span>      </span><span class="hs-identifier hs-var">ArchARM64</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;nativeCodeGen: No NCG for ARM64&quot;</span><span>
</span><a name="line-172"></a><span>      </span><span class="hs-identifier hs-var">ArchPPC_64</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684958294"><span class="hs-identifier hs-var">nCG'</span></a><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#ppcNcgImpl"><span class="hs-identifier hs-var">ppcNcgImpl</span></a><span>    </span><a href="#local-6989586621684958287"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>      </span><span class="hs-identifier hs-var">ArchAlpha</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;nativeCodeGen: No NCG for Alpha&quot;</span><span>
</span><a name="line-174"></a><span>      </span><span class="hs-identifier hs-var">ArchMipseb</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;nativeCodeGen: No NCG for mipseb&quot;</span><span>
</span><a name="line-175"></a><span>      </span><span class="hs-identifier hs-var">ArchMipsel</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;nativeCodeGen: No NCG for mipsel&quot;</span><span>
</span><a name="line-176"></a><span>      </span><span class="hs-identifier hs-var">ArchUnknown</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;nativeCodeGen: No NCG for unknown arch&quot;</span><span>
</span><a name="line-177"></a><span>      </span><span class="hs-identifier hs-var">ArchJavaScript</span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;nativeCodeGen: No NCG for JavaScript&quot;</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-identifier">x86NcgImpl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alignment</span><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>                                  </span><a href="X86.Instr.html#Instr"><span class="hs-identifier hs-type">X86.Instr.Instr</span></a><span> </span><a href="X86.Instr.html#JumpDest"><span class="hs-identifier hs-type">X86.Instr.JumpDest</span></a><span>
</span><a name="line-181"></a><a name="x86NcgImpl"><a href="AsmCodeGen.html#x86NcgImpl"><span class="hs-identifier">x86NcgImpl</span></a></a><span> </span><a name="local-6989586621684958299"><a href="#local-6989586621684958299"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-182"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#x86_64NcgImpl"><span class="hs-identifier hs-var">x86_64NcgImpl</span></a><span> </span><a href="#local-6989586621684958299"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ncg_x86fp_kludge</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="AsmCodeGen.html#x86fp_kludge"><span class="hs-identifier hs-var">x86fp_kludge</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">x86_64NcgImpl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alignment</span><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>                                  </span><a href="X86.Instr.html#Instr"><span class="hs-identifier hs-type">X86.Instr.Instr</span></a><span> </span><a href="X86.Instr.html#JumpDest"><span class="hs-identifier hs-type">X86.Instr.JumpDest</span></a><span>
</span><a name="line-186"></a><a name="x86_64NcgImpl"><a href="AsmCodeGen.html#x86_64NcgImpl"><span class="hs-identifier">x86_64NcgImpl</span></a></a><span> </span><a name="local-6989586621684958300"><a href="#local-6989586621684958300"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-187"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-var">NcgImpl</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-188"></a><span>        </span><span class="hs-identifier">cmmTopCodeGen</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="X86.CodeGen.html#cmmTopCodeGen"><span class="hs-identifier hs-var">X86.CodeGen.cmmTopCodeGen</span></a><span>
</span><a name="line-189"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">generateJumpTableForInstr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="X86.CodeGen.html#generateJumpTableForInstr"><span class="hs-identifier hs-var">X86.CodeGen.generateJumpTableForInstr</span></a><span> </span><a href="#local-6989586621684958300"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-190"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">getJumpDestBlockId</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="X86.Instr.html#getJumpDestBlockId"><span class="hs-identifier hs-var">X86.Instr.getJumpDestBlockId</span></a><span>
</span><a name="line-191"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">canShortcut</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="X86.Instr.html#canShortcut"><span class="hs-identifier hs-var">X86.Instr.canShortcut</span></a><span>
</span><a name="line-192"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">shortcutStatics</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="X86.Instr.html#shortcutStatics"><span class="hs-identifier hs-var">X86.Instr.shortcutStatics</span></a><span>
</span><a name="line-193"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">shortcutJump</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="X86.Instr.html#shortcutJump"><span class="hs-identifier hs-var">X86.Instr.shortcutJump</span></a><span>
</span><a name="line-194"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">pprNatCmmDecl</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="X86.Ppr.html#pprNatCmmDecl"><span class="hs-identifier hs-var">X86.Ppr.pprNatCmmDecl</span></a><span>
</span><a name="line-195"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">maxSpillSlots</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="X86.Instr.html#maxSpillSlots"><span class="hs-identifier hs-var">X86.Instr.maxSpillSlots</span></a><span> </span><a href="#local-6989586621684958300"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-196"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">allocatableRegs</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="X86.Regs.html#allocatableRegs"><span class="hs-identifier hs-var">X86.Regs.allocatableRegs</span></a><span> </span><a href="#local-6989586621684958301"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-197"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncg_x86fp_kludge</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-198"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgAllocMoreStack</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="X86.Instr.html#allocMoreStack"><span class="hs-identifier hs-var">X86.Instr.allocMoreStack</span></a><span> </span><a href="#local-6989586621684958301"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-199"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgExpandTop</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-200"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgMakeFarBranches</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-201"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">extractUnwindPoints</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="X86.CodeGen.html#extractUnwindPoints"><span class="hs-identifier hs-var">X86.CodeGen.extractUnwindPoints</span></a><span>
</span><a name="line-202"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">invertCondBranches</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="X86.CodeGen.html#invertCondBranches"><span class="hs-identifier hs-var">X86.CodeGen.invertCondBranches</span></a><span>
</span><a name="line-203"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684958301"><a href="#local-6989586621684958301"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684958300"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span class="hs-identifier">ppcNcgImpl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span> </span><a href="PPC.Instr.html#Instr"><span class="hs-identifier hs-type">PPC.Instr.Instr</span></a><span> </span><a href="PPC.RegInfo.html#JumpDest"><span class="hs-identifier hs-type">PPC.RegInfo.JumpDest</span></a><span>
</span><a name="line-207"></a><a name="ppcNcgImpl"><a href="AsmCodeGen.html#ppcNcgImpl"><span class="hs-identifier">ppcNcgImpl</span></a></a><span> </span><a name="local-6989586621684958302"><a href="#local-6989586621684958302"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-208"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-var">NcgImpl</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-209"></a><span>        </span><span class="hs-identifier">cmmTopCodeGen</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="PPC.CodeGen.html#cmmTopCodeGen"><span class="hs-identifier hs-var">PPC.CodeGen.cmmTopCodeGen</span></a><span>
</span><a name="line-210"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">generateJumpTableForInstr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="PPC.CodeGen.html#generateJumpTableForInstr"><span class="hs-identifier hs-var">PPC.CodeGen.generateJumpTableForInstr</span></a><span> </span><a href="#local-6989586621684958302"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-211"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">getJumpDestBlockId</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PPC.RegInfo.html#getJumpDestBlockId"><span class="hs-identifier hs-var">PPC.RegInfo.getJumpDestBlockId</span></a><span>
</span><a name="line-212"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">canShortcut</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="PPC.RegInfo.html#canShortcut"><span class="hs-identifier hs-var">PPC.RegInfo.canShortcut</span></a><span>
</span><a name="line-213"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">shortcutStatics</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="PPC.RegInfo.html#shortcutStatics"><span class="hs-identifier hs-var">PPC.RegInfo.shortcutStatics</span></a><span>
</span><a name="line-214"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">shortcutJump</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="PPC.RegInfo.html#shortcutJump"><span class="hs-identifier hs-var">PPC.RegInfo.shortcutJump</span></a><span>
</span><a name="line-215"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">pprNatCmmDecl</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="PPC.Ppr.html#pprNatCmmDecl"><span class="hs-identifier hs-var">PPC.Ppr.pprNatCmmDecl</span></a><span>
</span><a name="line-216"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">maxSpillSlots</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="PPC.Instr.html#maxSpillSlots"><span class="hs-identifier hs-var">PPC.Instr.maxSpillSlots</span></a><span> </span><a href="#local-6989586621684958302"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-217"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">allocatableRegs</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="PPC.Regs.html#allocatableRegs"><span class="hs-identifier hs-var">PPC.Regs.allocatableRegs</span></a><span> </span><a href="#local-6989586621684958303"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-218"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncg_x86fp_kludge</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-219"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgAllocMoreStack</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="PPC.Instr.html#allocMoreStack"><span class="hs-identifier hs-var">PPC.Instr.allocMoreStack</span></a><span> </span><a href="#local-6989586621684958303"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-220"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgExpandTop</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-221"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgMakeFarBranches</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="PPC.Instr.html#makeFarBranches"><span class="hs-identifier hs-var">PPC.Instr.makeFarBranches</span></a><span>
</span><a name="line-222"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">extractUnwindPoints</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-223"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">invertCondBranches</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-224"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684958303"><a href="#local-6989586621684958303"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684958302"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-identifier">sparcNcgImpl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span> </span><a href="SPARC.Instr.html#Instr"><span class="hs-identifier hs-type">SPARC.Instr.Instr</span></a><span> </span><a href="SPARC.ShortcutJump.html#JumpDest"><span class="hs-identifier hs-type">SPARC.ShortcutJump.JumpDest</span></a><span>
</span><a name="line-228"></a><a name="sparcNcgImpl"><a href="AsmCodeGen.html#sparcNcgImpl"><span class="hs-identifier">sparcNcgImpl</span></a></a><span> </span><a name="local-6989586621684958304"><a href="#local-6989586621684958304"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-229"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-var">NcgImpl</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-230"></a><span>        </span><span class="hs-identifier">cmmTopCodeGen</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.CodeGen.html#cmmTopCodeGen"><span class="hs-identifier hs-var">SPARC.CodeGen.cmmTopCodeGen</span></a><span>
</span><a name="line-231"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">generateJumpTableForInstr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.CodeGen.html#generateJumpTableForInstr"><span class="hs-identifier hs-var">SPARC.CodeGen.generateJumpTableForInstr</span></a><span> </span><a href="#local-6989586621684958304"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-232"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">getJumpDestBlockId</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.ShortcutJump.html#getJumpDestBlockId"><span class="hs-identifier hs-var">SPARC.ShortcutJump.getJumpDestBlockId</span></a><span>
</span><a name="line-233"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">canShortcut</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.ShortcutJump.html#canShortcut"><span class="hs-identifier hs-var">SPARC.ShortcutJump.canShortcut</span></a><span>
</span><a name="line-234"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">shortcutStatics</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.ShortcutJump.html#shortcutStatics"><span class="hs-identifier hs-var">SPARC.ShortcutJump.shortcutStatics</span></a><span>
</span><a name="line-235"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">shortcutJump</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.ShortcutJump.html#shortcutJump"><span class="hs-identifier hs-var">SPARC.ShortcutJump.shortcutJump</span></a><span>
</span><a name="line-236"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">pprNatCmmDecl</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.Ppr.html#pprNatCmmDecl"><span class="hs-identifier hs-var">SPARC.Ppr.pprNatCmmDecl</span></a><span>
</span><a name="line-237"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">maxSpillSlots</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.Stack.html#maxSpillSlots"><span class="hs-identifier hs-var">SPARC.Instr.maxSpillSlots</span></a><span> </span><a href="#local-6989586621684958304"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-238"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">allocatableRegs</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="SPARC.Regs.html#allocatableRegs"><span class="hs-identifier hs-var">SPARC.Regs.allocatableRegs</span></a><span>
</span><a name="line-239"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncg_x86fp_kludge</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-240"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgAllocMoreStack</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#noAllocMoreStack"><span class="hs-identifier hs-var">noAllocMoreStack</span></a><span>
</span><a name="line-241"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgExpandTop</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="SPARC.CodeGen.Expand.html#expandTop"><span class="hs-identifier hs-var">SPARC.CodeGen.Expand.expandTop</span></a><span>
</span><a name="line-242"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">ncgMakeFarBranches</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-243"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">extractUnwindPoints</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-244"></a><span>       </span><span class="hs-special">,</span><span class="hs-identifier">invertCondBranches</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-245"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-comment">--</span><span>
</span><a name="line-248"></a><span class="hs-comment">-- Allocating more stack space for spilling is currently only</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- supported for the linear register allocator on x86/x86_64, the rest</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- default to the panic below.  To support allocating extra stack on</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- more platforms provide a definition of ncgAllocMoreStack.</span><span>
</span><a name="line-252"></a><span class="hs-comment">--</span><span>
</span><a name="line-253"></a><span class="hs-identifier">noAllocMoreStack</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958285"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958286"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-254"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span> </span><span class="hs-special">(</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958285"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958286"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><a name="noAllocMoreStack"><a href="AsmCodeGen.html#noAllocMoreStack"><span class="hs-identifier">noAllocMoreStack</span></a></a><span> </span><a name="local-6989586621684958305"><a href="#local-6989586621684958305"><span class="hs-identifier">amount</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-256"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-string">&quot;Register allocator: out of stack slots (need &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621684958305"><span class="hs-identifier hs-var">amount</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;)\n&quot;</span><span>
</span><a name="line-257"></a><span>        </span><span class="hs-operator hs-var">++</span><span>  </span><span class="hs-string">&quot;   If you are trying to compile SHA1.hs from the crypto library then this\n&quot;</span><span>
</span><a name="line-258"></a><span>        </span><span class="hs-operator hs-var">++</span><span>  </span><span class="hs-string">&quot;   is a known limitation in the linear allocator.\n&quot;</span><span>
</span><a name="line-259"></a><span>        </span><span class="hs-operator hs-var">++</span><span>  </span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-260"></a><span>        </span><span class="hs-operator hs-var">++</span><span>  </span><span class="hs-string">&quot;   Try enabling the graph colouring allocator with -fregs-graph instead.&quot;</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-operator hs-var">++</span><span>  </span><span class="hs-string">&quot;   You can still file a bug report if you like.\n&quot;</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-comment">-- | Data accumulated during code generation. Mostly about statistics,</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- but also collects debug data for DWARF generation.</span><span>
</span><a name="line-266"></a><span class="hs-keyword">data</span><span> </span><a name="NativeGenAcc"><a href="AsmCodeGen.html#NativeGenAcc"><span class="hs-identifier">NativeGenAcc</span></a></a><span> </span><a name="local-6989586621684958230"><a href="#local-6989586621684958230"><span class="hs-identifier">statics</span></a></a><span> </span><a name="local-6989586621684958231"><a href="#local-6989586621684958231"><span class="hs-identifier">instr</span></a></a><span>
</span><a name="line-267"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NGS"><a href="AsmCodeGen.html#NGS"><span class="hs-identifier">NGS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ngs_imports"><a href="AsmCodeGen.html#ngs_imports"><span class="hs-identifier">ngs_imports</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-268"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="ngs_natives"><a href="AsmCodeGen.html#ngs_natives"><span class="hs-identifier">ngs_natives</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958230"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958231"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-269"></a><span>             </span><span class="hs-comment">-- ^ Native code generated, for statistics. This might</span><span>
</span><a name="line-270"></a><span>             </span><span class="hs-comment">-- hold a lot of data, so it is important to clear this</span><span>
</span><a name="line-271"></a><span>             </span><span class="hs-comment">-- field as early as possible if it isn't actually</span><span>
</span><a name="line-272"></a><span>             </span><span class="hs-comment">-- required.</span><span>
</span><a name="line-273"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="ngs_colorStats"><a href="AsmCodeGen.html#ngs_colorStats"><span class="hs-identifier">ngs_colorStats</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="hs-special">[</span><a href="RegAlloc.Graph.Stats.html#RegAllocStats"><span class="hs-identifier hs-type">Color.RegAllocStats</span></a><span> </span><a href="#local-6989586621684958230"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958231"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-274"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="ngs_linearStats"><a href="AsmCodeGen.html#ngs_linearStats"><span class="hs-identifier">ngs_linearStats</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="hs-special">[</span><a href="RegAlloc.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">Linear.RegAllocStats</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-275"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="ngs_labels"><a href="AsmCodeGen.html#ngs_labels"><span class="hs-identifier">ngs_labels</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span class="hs-special">]</span><span>
</span><a name="line-276"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="ngs_debug"><a href="AsmCodeGen.html#ngs_debug"><span class="hs-identifier">ngs_debug</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-277"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="ngs_dwarfFiles"><a href="AsmCodeGen.html#ngs_dwarfFiles"><span class="hs-identifier">ngs_dwarfFiles</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="NCGMonad.html#DwarfFiles"><span class="hs-identifier hs-type">DwarfFiles</span></a><span>
</span><a name="line-278"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="ngs_unwinds"><a href="AsmCodeGen.html#ngs_unwinds"><span class="hs-identifier">ngs_unwinds</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>             </span><span class="hs-comment">-- ^ see Note [Unwinding information in the NCG]</span><span>
</span><a name="line-280"></a><span>             </span><span class="hs-comment">-- and Note [What is this unwinding business?] in Debug.</span><span>
</span><a name="line-281"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-comment">{-
Note [Unwinding information in the NCG]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Unwind information is a type of metadata which allows a debugging tool
to reconstruct the values of machine registers at the time a procedure was
entered. For the most part, the production of unwind information is handled by
the Cmm stage, where it is represented by CmmUnwind nodes.

Unfortunately, the Cmm stage doesn't know everything necessary to produce
accurate unwinding information. For instance, the x86-64 calling convention
requires that the stack pointer be aligned to 16 bytes, which in turn means that
GHC must sometimes add padding to $sp prior to performing a foreign call. When
this happens unwind information must be updated accordingly.
For this reason, we make the NCG backends responsible for producing
unwinding tables (with the extractUnwindPoints function in NcgImpl).

We accumulate the produced unwind tables over CmmGroups in the ngs_unwinds
field of NativeGenAcc. This is a label map which contains an entry for each
procedure, containing a list of unwinding points (e.g. a label and an associated
unwinding table).

See also Note [What is this unwinding business?] in Debug.
-}</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-identifier">nativeCodeGen'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958282"><span class="hs-identifier hs-type">statics</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958283"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958284"><span class="hs-identifier hs-type">jumpDest</span></a><span class="hs-special">,</span><span>
</span><a name="line-309"></a><span>                   </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684958283"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-311"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>
</span><a name="line-312"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958282"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958283"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958284"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-313"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Handle</span><span>
</span><a name="line-314"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-315"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Cmm.html#RawCmmGroup"><span class="hs-identifier hs-type">RawCmmGroup</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-317"></a><a name="nativeCodeGen%27"><a href="AsmCodeGen.html#nativeCodeGen%27"><span class="hs-identifier">nativeCodeGen'</span></a></a><span> </span><a name="local-6989586621684958306"><a href="#local-6989586621684958306"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958307"><a href="#local-6989586621684958307"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684958308"><a href="#local-6989586621684958308"><span class="hs-identifier">modLoc</span></a></a><span> </span><a name="local-6989586621684958309"><a href="#local-6989586621684958309"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684958310"><a href="#local-6989586621684958310"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621684958311"><a href="#local-6989586621684958311"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684958312"><a href="#local-6989586621684958312"><span class="hs-identifier">cmms</span></a></a><span>
</span><a name="line-318"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-319"></a><span>        </span><span class="hs-comment">-- BufHandle is a performance hack.  We could hide it inside</span><span>
</span><a name="line-320"></a><span>        </span><span class="hs-comment">-- Pretty if it weren't for the fact that we do lots of little</span><span>
</span><a name="line-321"></a><span>        </span><span class="hs-comment">-- printDocs here (in order to do codegen in constant space).</span><span>
</span><a name="line-322"></a><span>        </span><a name="local-6989586621684958313"><a href="#local-6989586621684958313"><span class="hs-identifier">bufh</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newBufHandle</span><span> </span><a href="#local-6989586621684958310"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-323"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958314"><a href="#local-6989586621684958314"><span class="hs-identifier">ngs0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#NGS"><span class="hs-identifier hs-var">NGS</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">emptyUFM</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-324"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684958315"><a href="#local-6989586621684958315"><span class="hs-identifier">ngs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958316"><a href="#local-6989586621684958316"><span class="hs-identifier">us'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmNativeGenStream"><span class="hs-identifier hs-var">cmmNativeGenStream</span></a><span> </span><a href="#local-6989586621684958306"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958307"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958308"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958309"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958313"><span class="hs-identifier hs-var">bufh</span></a><span> </span><a href="#local-6989586621684958311"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-325"></a><span>                                         </span><a href="#local-6989586621684958312"><span class="hs-identifier hs-var">cmms</span></a><span> </span><a href="#local-6989586621684958314"><span class="hs-identifier hs-var">ngs0</span></a><span>
</span><a name="line-326"></a><span>        </span><a href="AsmCodeGen.html#finishNativeGen"><span class="hs-identifier hs-var">finishNativeGen</span></a><span> </span><a href="#local-6989586621684958306"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958308"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958313"><span class="hs-identifier hs-var">bufh</span></a><span> </span><a href="#local-6989586621684958316"><span class="hs-identifier hs-var">us'</span></a><span> </span><a href="#local-6989586621684958315"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-identifier">finishNativeGen</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684958280"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-329"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-330"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>
</span><a name="line-331"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BufHandle</span><span>
</span><a name="line-332"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-333"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#NativeGenAcc"><span class="hs-identifier hs-type">NativeGenAcc</span></a><span> </span><a href="#local-6989586621684958281"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958280"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-334"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-335"></a><a name="finishNativeGen"><a href="AsmCodeGen.html#finishNativeGen"><span class="hs-identifier">finishNativeGen</span></a></a><span> </span><a name="local-6989586621684958317"><a href="#local-6989586621684958317"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958318"><a href="#local-6989586621684958318"><span class="hs-identifier">modLoc</span></a></a><span> </span><a name="local-6989586621684958319"><a href="#local-6989586621684958319"><span class="hs-identifier">bufh</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">BufHandle</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958320"><a href="#local-6989586621684958320"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684958321"><a href="#local-6989586621684958321"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684958322"><a href="#local-6989586621684958322"><span class="hs-identifier">ngs</span></a></a><span>
</span><a name="line-336"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-337"></a><span>        </span><span class="hs-comment">-- Write debug data and finish</span><span>
</span><a name="line-338"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958324"><a href="#local-6989586621684958324"><span class="hs-identifier">emitDw</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitObjs</span><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>        </span><a name="local-6989586621684958327"><a href="#local-6989586621684958327"><span class="hs-identifier">us'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684958324"><span class="hs-identifier hs-var">emitDw</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684958321"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-340"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684958325"><a href="#local-6989586621684958325"><span class="hs-identifier">dwarf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958326"><a href="#local-6989586621684958326"><span class="hs-identifier">us'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Dwarf.html#dwarfGen"><span class="hs-identifier hs-var">dwarfGen</span></a><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958318"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958321"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ngs_debug</span><span> </span><a href="#local-6989586621684958322"><span class="hs-identifier hs-var">ngs</span></a><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span>          </span><a href="AsmCodeGen.html#emitNativeCode"><span class="hs-identifier hs-var">emitNativeCode</span></a><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958319"><span class="hs-identifier hs-var">bufh</span></a><span> </span><a href="#local-6989586621684958325"><span class="hs-identifier hs-var">dwarf</span></a><span>
</span><a name="line-342"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684958326"><span class="hs-identifier hs-var">us'</span></a><span>
</span><a name="line-343"></a><span>        </span><span class="hs-identifier hs-var">bFlush</span><span> </span><a href="#local-6989586621684958319"><span class="hs-identifier hs-var">bufh</span></a><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span>        </span><span class="hs-comment">-- dump global NCG stats for graph coloring allocator</span><span>
</span><a name="line-346"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958328"><a href="#local-6989586621684958328"><span class="hs-identifier">stats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ngs_colorStats</span><span> </span><a href="#local-6989586621684958322"><span class="hs-identifier hs-var">ngs</span></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684958328"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>          </span><span class="hs-comment">-- build the global register conflict graph</span><span>
</span><a name="line-350"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958329"><a href="#local-6989586621684958329"><span class="hs-identifier">graphGlobal</span></a></a><span>
</span><a name="line-351"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="GraphOps.html#union"><span class="hs-identifier hs-var">Color.union</span></a><span> </span><a href="GraphBase.html#initGraph"><span class="hs-identifier hs-var">Color.initGraph</span></a><span>
</span><a name="line-352"></a><span>                  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">Color.raGraph</span><span> </span><a href="#local-6989586621684958330"><span class="hs-identifier hs-var">stat</span></a><span>
</span><a name="line-353"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684958330"><a href="#local-6989586621684958330"><span class="hs-identifier">stat</span></a></a><span class="hs-glyph">@</span><a href="RegAlloc.Graph.Stats.html#RegAllocStatsStart"><span class="hs-identifier hs-var">Color.RegAllocStatsStart</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684958328"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">]</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>          </span><a href="#local-6989586621684958323"><span class="hs-identifier hs-var">dump_stats</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Graph.Stats.html#pprStats"><span class="hs-identifier hs-var">Color.pprStats</span></a><span> </span><a href="#local-6989586621684958328"><span class="hs-identifier hs-var">stats</span></a><span> </span><a href="#local-6989586621684958329"><span class="hs-identifier hs-var">graphGlobal</span></a><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>
</span><a name="line-357"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958331"><a href="#local-6989586621684958331"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-358"></a><span>          </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-359"></a><span>                  </span><span class="hs-identifier hs-var">Opt_D_dump_asm_conflicts</span><span> </span><span class="hs-string">&quot;Register conflict graph&quot;</span><span>
</span><a name="line-360"></a><span>                  </span><span class="hs-operator hs-var">$</span><span> </span><a href="GraphPpr.html#dotGraph"><span class="hs-identifier hs-var">Color.dotGraph</span></a><span>
</span><a name="line-361"></a><span>                          </span><span class="hs-special">(</span><a href="TargetReg.html#targetRegDotColor"><span class="hs-identifier hs-var">targetRegDotColor</span></a><span> </span><a href="#local-6989586621684958331"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>                          </span><span class="hs-special">(</span><a href="RegAlloc.Graph.TrivColorable.html#trivColorable"><span class="hs-identifier hs-var">Color.trivColorable</span></a><span> </span><a href="#local-6989586621684958331"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-363"></a><span>                                  </span><span class="hs-special">(</span><a href="TargetReg.html#targetVirtualRegSqueeze"><span class="hs-identifier hs-var">targetVirtualRegSqueeze</span></a><span> </span><a href="#local-6989586621684958331"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>                                  </span><span class="hs-special">(</span><a href="TargetReg.html#targetRealRegSqueeze"><span class="hs-identifier hs-var">targetRealRegSqueeze</span></a><span> </span><a href="#local-6989586621684958331"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>                  </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684958329"><span class="hs-identifier hs-var">graphGlobal</span></a><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span>        </span><span class="hs-comment">-- dump global NCG stats for linear allocator</span><span>
</span><a name="line-369"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958332"><a href="#local-6989586621684958332"><span class="hs-identifier">linearStats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ngs_linearStats</span><span> </span><a href="#local-6989586621684958322"><span class="hs-identifier hs-var">ngs</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684958332"><span class="hs-identifier hs-var">linearStats</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-371"></a><span>          </span><a href="#local-6989586621684958323"><span class="hs-identifier hs-var">dump_stats</span></a><span> </span><span class="hs-special">(</span><a href="RegAlloc.Linear.Stats.html#pprStats"><span class="hs-identifier hs-var">Linear.pprStats</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ngs_natives</span><span> </span><a href="#local-6989586621684958322"><span class="hs-identifier hs-var">ngs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958332"><span class="hs-identifier hs-var">linearStats</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>        </span><span class="hs-comment">-- write out the imports</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-identifier hs-var">printSDocLn</span><span> </span><span class="hs-identifier hs-var">Pretty.LeftMode</span><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958320"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCodeStyle</span><span> </span><span class="hs-identifier hs-var">AsmStyle</span><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>                </span><span class="hs-operator hs-var">$</span><span> </span><a href="AsmCodeGen.html#makeImportsDoc"><span class="hs-identifier hs-var">makeImportsDoc</span></a><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ngs_imports</span><span> </span><a href="#local-6989586621684958322"><span class="hs-identifier hs-var">ngs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684958327"><span class="hs-identifier hs-var">us'</span></a><span>
</span><a name="line-377"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-378"></a><span>    </span><a name="local-6989586621684958323"><a href="#local-6989586621684958323"><span class="hs-identifier">dump_stats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dumpSDoc</span><span> </span><a href="#local-6989586621684958317"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">alwaysQualify</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_asm_stats</span><span> </span><span class="hs-string">&quot;NCG stats&quot;</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-identifier">cmmNativeGenStream</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958277"><span class="hs-identifier hs-type">statics</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958278"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-381"></a><span>                      </span><span class="hs-special">,</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958279"><span class="hs-identifier hs-type">jumpDest</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684958278"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-383"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>
</span><a name="line-384"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958277"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958278"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958279"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-385"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BufHandle</span><span>
</span><a name="line-386"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-387"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Stream.html#Stream"><span class="hs-identifier hs-type">Stream</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Cmm.html#RawCmmGroup"><span class="hs-identifier hs-type">RawCmmGroup</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#NativeGenAcc"><span class="hs-identifier hs-type">NativeGenAcc</span></a><span> </span><a href="#local-6989586621684958277"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958278"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-389"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#NativeGenAcc"><span class="hs-identifier hs-type">NativeGenAcc</span></a><span> </span><a href="#local-6989586621684958277"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958278"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>
</span><a name="line-391"></a><a name="cmmNativeGenStream"><a href="AsmCodeGen.html#cmmNativeGenStream"><span class="hs-identifier">cmmNativeGenStream</span></a></a><span> </span><a name="local-6989586621684958333"><a href="#local-6989586621684958333"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958334"><a href="#local-6989586621684958334"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684958335"><a href="#local-6989586621684958335"><span class="hs-identifier">modLoc</span></a></a><span> </span><a name="local-6989586621684958336"><a href="#local-6989586621684958336"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684958337"><a href="#local-6989586621684958337"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621684958338"><a href="#local-6989586621684958338"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684958339"><a href="#local-6989586621684958339"><span class="hs-identifier">cmm_stream</span></a></a><span> </span><a name="local-6989586621684958340"><a href="#local-6989586621684958340"><span class="hs-identifier">ngs</span></a></a><span>
</span><a name="line-392"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958341"><a href="#local-6989586621684958341"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">Stream.runStream</span><span> </span><a href="#local-6989586621684958339"><span class="hs-identifier hs-var">cmm_stream</span></a><span>
</span><a name="line-393"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958341"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-394"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-395"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958340"><span class="hs-identifier hs-var">ngs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ngs_imports</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ngs_imports</span><span> </span><a href="#local-6989586621684958340"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-396"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_natives</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ngs_natives</span><span> </span><a href="#local-6989586621684958340"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-397"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_colorStats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ngs_colorStats</span><span> </span><a href="#local-6989586621684958340"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-398"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_linearStats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ngs_linearStats</span><span> </span><a href="#local-6989586621684958340"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-399"></a><span>                      </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-400"></a><span>                  </span><a href="#local-6989586621684958338"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958342"><a href="#local-6989586621684958342"><span class="hs-identifier">cmms</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958343"><a href="#local-6989586621684958343"><span class="hs-identifier">cmm_stream'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-402"></a><span>
</span><a name="line-403"></a><span>          </span><span class="hs-comment">-- Generate debug information</span><span>
</span><a name="line-404"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958344"><a href="#local-6989586621684958344"><span class="hs-identifier">debugFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621684958333"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-405"></a><span>              </span><span class="hs-glyph">!</span><a name="local-6989586621684958345"><a href="#local-6989586621684958345"><span class="hs-identifier">ndbgs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684958344"><span class="hs-identifier hs-var">debugFlag</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Debug.html#cmmDebugGen"><span class="hs-identifier hs-var">cmmDebugGen</span></a><span> </span><a href="#local-6989586621684958335"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958342"><span class="hs-identifier hs-var">cmms</span></a><span>
</span><a name="line-406"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-407"></a><span>              </span><a name="local-6989586621684958346"><a href="#local-6989586621684958346"><span class="hs-identifier">dbgMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Debug.html#debugToMap"><span class="hs-identifier hs-var">debugToMap</span></a><span> </span><a href="#local-6989586621684958345"><span class="hs-identifier hs-var">ndbgs</span></a><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span>          </span><span class="hs-comment">-- Insert split marker, generate native code</span><span>
</span><a name="line-410"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958347"><a href="#local-6989586621684958347"><span class="hs-identifier">splitObjs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SplitObjs</span><span> </span><a href="#local-6989586621684958333"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-411"></a><span>              </span><a name="local-6989586621684958348"><a href="#local-6989586621684958348"><span class="hs-identifier">split_marker</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="CLabel.html#mkSplitMarkerLabel"><span class="hs-identifier hs-var">mkSplitMarkerLabel</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-412"></a><span>                             </span><a href="CmmUtils.html#ofBlockList"><span class="hs-identifier hs-var">ofBlockList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;split_marker_entry&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-413"></a><span>              </span><a name="local-6989586621684958349"><a href="#local-6989586621684958349"><span class="hs-identifier">cmms'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684958347"><span class="hs-identifier hs-var">splitObjs</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958348"><span class="hs-identifier hs-var">split_marker</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684958342"><span class="hs-identifier hs-var">cmms</span></a><span>
</span><a name="line-414"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958342"><span class="hs-identifier hs-var">cmms</span></a><span>
</span><a name="line-415"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684958350"><a href="#local-6989586621684958350"><span class="hs-identifier">ngs'</span></a></a><span class="hs-special">,</span><a name="local-6989586621684958351"><a href="#local-6989586621684958351"><span class="hs-identifier">us'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmNativeGens"><span class="hs-identifier hs-var">cmmNativeGens</span></a><span> </span><a href="#local-6989586621684958333"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958334"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958335"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958336"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958337"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-416"></a><span>                                             </span><a href="#local-6989586621684958346"><span class="hs-identifier hs-var">dbgMap</span></a><span> </span><a href="#local-6989586621684958338"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684958349"><span class="hs-identifier hs-var">cmms'</span></a><span> </span><a href="#local-6989586621684958340"><span class="hs-identifier hs-var">ngs</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>          </span><span class="hs-comment">-- Link native code information into debug blocks</span><span>
</span><a name="line-419"></a><span>          </span><span class="hs-comment">-- See Note [What is this unwinding business?] in Debug.</span><span>
</span><a name="line-420"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621684958352"><a href="#local-6989586621684958352"><span class="hs-identifier">ldbgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Debug.html#cmmDebugLink"><span class="hs-identifier hs-var">cmmDebugLink</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ngs_labels</span><span> </span><a href="#local-6989586621684958350"><span class="hs-identifier hs-var">ngs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ngs_unwinds</span><span> </span><a href="#local-6989586621684958350"><span class="hs-identifier hs-var">ngs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958345"><span class="hs-identifier hs-var">ndbgs</span></a><span>
</span><a name="line-421"></a><span>          </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958333"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_debug</span><span> </span><span class="hs-string">&quot;Debug Infos&quot;</span><span>
</span><a name="line-422"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684958352"><span class="hs-identifier hs-var">ldbgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span>          </span><span class="hs-comment">-- Emit &amp; clear DWARF information when generating split</span><span>
</span><a name="line-425"></a><span>          </span><span class="hs-comment">-- object files, as we need it to land in the same object file</span><span>
</span><a name="line-426"></a><span>          </span><span class="hs-comment">-- When using split sections, note that we do not split the debug</span><span>
</span><a name="line-427"></a><span>          </span><span class="hs-comment">-- info but emit all the info at once in finishNativeGen.</span><span>
</span><a name="line-428"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684958355"><a href="#local-6989586621684958355"><span class="hs-identifier">ngs''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958356"><a href="#local-6989586621684958356"><span class="hs-identifier">us''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-429"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684958344"><span class="hs-identifier hs-var">debugFlag</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684958347"><span class="hs-identifier hs-var">splitObjs</span></a><span>
</span><a name="line-430"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958353"><a href="#local-6989586621684958353"><span class="hs-identifier">dwarf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958354"><a href="#local-6989586621684958354"><span class="hs-identifier">us''</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Dwarf.html#dwarfGen"><span class="hs-identifier hs-var">dwarfGen</span></a><span> </span><a href="#local-6989586621684958333"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958335"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958338"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684958352"><span class="hs-identifier hs-var">ldbgs</span></a><span>
</span><a name="line-431"></a><span>                    </span><a href="AsmCodeGen.html#emitNativeCode"><span class="hs-identifier hs-var">emitNativeCode</span></a><span> </span><a href="#local-6989586621684958333"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958337"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621684958353"><span class="hs-identifier hs-var">dwarf</span></a><span>
</span><a name="line-432"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958350"><span class="hs-identifier hs-var">ngs'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ngs_debug</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-433"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_dwarfFiles</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyUFM</span><span>
</span><a name="line-434"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_labels</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-435"></a><span>                            </span><a href="#local-6989586621684958354"><span class="hs-identifier hs-var">us''</span></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958350"><span class="hs-identifier hs-var">ngs'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ngs_debug</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ngs_debug</span><span> </span><a href="#local-6989586621684958350"><span class="hs-identifier hs-var">ngs'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684958352"><span class="hs-identifier hs-var">ldbgs</span></a><span>
</span><a name="line-437"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_labels</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-438"></a><span>                         </span><a href="#local-6989586621684958351"><span class="hs-identifier hs-var">us'</span></a><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span>          </span><a href="AsmCodeGen.html#cmmNativeGenStream"><span class="hs-identifier hs-var">cmmNativeGenStream</span></a><span> </span><a href="#local-6989586621684958333"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958334"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958335"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958336"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958337"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621684958356"><span class="hs-identifier hs-var">us''</span></a><span>
</span><a name="line-441"></a><span>              </span><a href="#local-6989586621684958343"><span class="hs-identifier hs-var">cmm_stream'</span></a><span> </span><a href="#local-6989586621684958355"><span class="hs-identifier hs-var">ngs''</span></a><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-comment">-- | Do native code generation on all these cmms.</span><span>
</span><a name="line-444"></a><span class="hs-comment">--</span><span>
</span><a name="line-445"></a><span class="hs-identifier">cmmNativeGens</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621684958274"><a href="#local-6989586621684958274"><span class="hs-identifier">statics</span></a></a><span> </span><a name="local-6989586621684958275"><a href="#local-6989586621684958275"><span class="hs-identifier">instr</span></a></a><span> </span><a name="local-6989586621684958276"><a href="#local-6989586621684958276"><span class="hs-identifier">jumpDest</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-446"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958274"><span class="hs-identifier hs-type">statics</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958275"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-447"></a><span>                 </span><span class="hs-special">,</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958276"><span class="hs-identifier hs-type">jumpDest</span></a><span class="hs-special">,</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684958275"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-449"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>
</span><a name="line-450"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958274"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958275"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958276"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-451"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BufHandle</span><span>
</span><a name="line-452"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span>
</span><a name="line-453"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-454"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span class="hs-special">]</span><span>
</span><a name="line-455"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#NativeGenAcc"><span class="hs-identifier hs-type">NativeGenAcc</span></a><span> </span><a href="#local-6989586621684958274"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958275"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-456"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-457"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#NativeGenAcc"><span class="hs-identifier hs-type">NativeGenAcc</span></a><span> </span><a href="#local-6989586621684958274"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958275"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><a name="cmmNativeGens"><a href="AsmCodeGen.html#cmmNativeGens"><span class="hs-identifier">cmmNativeGens</span></a></a><span> </span><a name="local-6989586621684958357"><a href="#local-6989586621684958357"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958358"><a href="#local-6989586621684958358"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684958359"><a href="#local-6989586621684958359"><span class="hs-identifier">modLoc</span></a></a><span> </span><a name="local-6989586621684958360"><a href="#local-6989586621684958360"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684958361"><a href="#local-6989586621684958361"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621684958362"><a href="#local-6989586621684958362"><span class="hs-identifier">dbgMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958363"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-460"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-461"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span class="hs-special">]</span><span>
</span><a name="line-462"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#NativeGenAcc"><span class="hs-identifier hs-type">NativeGenAcc</span></a><span> </span><a href="#local-6989586621684958274"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958275"><span class="hs-identifier hs-type">instr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-463"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#NativeGenAcc"><span class="hs-identifier hs-type">NativeGenAcc</span></a><span> </span><a href="#local-6989586621684958274"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958275"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span>    </span><a name="local-6989586621684958363"><a href="#local-6989586621684958363"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684958365"><a href="#local-6989586621684958365"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684958366"><a href="#local-6989586621684958366"><span class="hs-identifier">ngs</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-466"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958366"><span class="hs-identifier hs-var">ngs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958365"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-467"></a><span>
</span><a name="line-468"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684958367"><a href="#local-6989586621684958367"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684958368"><a href="#local-6989586621684958368"><span class="hs-identifier">cmm</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684958369"><a href="#local-6989586621684958369"><span class="hs-identifier">cmms</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684958370"><a href="#local-6989586621684958370"><span class="hs-identifier">ngs</span></a></a><span> </span><a name="local-6989586621684958371"><a href="#local-6989586621684958371"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-469"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958372"><a href="#local-6989586621684958372"><span class="hs-identifier">fileIds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ngs_dwarfFiles</span><span> </span><a href="#local-6989586621684958370"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-470"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684958373"><a href="#local-6989586621684958373"><span class="hs-identifier">us'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958374"><a href="#local-6989586621684958374"><span class="hs-identifier">fileIds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958375"><a href="#local-6989586621684958375"><span class="hs-identifier">native</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958376"><a href="#local-6989586621684958376"><span class="hs-identifier">imports</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958377"><a href="#local-6989586621684958377"><span class="hs-identifier">colorStats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958378"><a href="#local-6989586621684958378"><span class="hs-identifier">linearStats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958379"><a href="#local-6989586621684958379"><span class="hs-identifier">unwinds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;cmmNativeGen&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-472"></a><span>             </span><a href="AsmCodeGen.html#cmmNativeGen"><span class="hs-identifier hs-var">cmmNativeGen</span></a><span> </span><a href="#local-6989586621684958357"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958358"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958359"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958360"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958367"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621684958372"><span class="hs-identifier hs-var">fileIds</span></a><span> </span><a href="#local-6989586621684958362"><span class="hs-identifier hs-var">dbgMap</span></a><span>
</span><a name="line-473"></a><span>                          </span><a href="#local-6989586621684958368"><span class="hs-identifier hs-var">cmm</span></a><span> </span><a href="#local-6989586621684958371"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span>        </span><span class="hs-comment">-- Generate .file directives for every new file that has been</span><span>
</span><a name="line-476"></a><span>        </span><span class="hs-comment">-- used. Note that it is important that we generate these in</span><span>
</span><a name="line-477"></a><span>        </span><span class="hs-comment">-- ascending order, as Clang's 3.6 assembler complains.</span><span>
</span><a name="line-478"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958380"><a href="#local-6989586621684958380"><span class="hs-identifier">newFileIds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-479"></a><span>                         </span><span class="hs-identifier hs-var">nonDetEltsUFM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684958374"><span class="hs-identifier hs-var">fileIds'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusUFM</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684958372"><span class="hs-identifier hs-var">fileIds</span></a><span>
</span><a name="line-480"></a><span>            </span><span class="hs-comment">-- See Note [Unique Determinism and code generation]</span><span>
</span><a name="line-481"></a><span>            </span><a name="local-6989586621684958381"><a href="#local-6989586621684958381"><span class="hs-identifier">pprDecl</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684958382"><a href="#local-6989586621684958382"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><a name="local-6989586621684958383"><a href="#local-6989586621684958383"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;\t.file &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684958383"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-482"></a><span>                            </span><span class="hs-identifier hs-var">doubleQuotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ftext</span><span> </span><a href="#local-6989586621684958382"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span>        </span><a href="AsmCodeGen.html#emitNativeCode"><span class="hs-identifier hs-var">emitNativeCode</span></a><span> </span><a href="#local-6989586621684958357"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958361"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-485"></a><span>          </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684958381"><span class="hs-identifier hs-var">pprDecl</span></a><span> </span><a href="#local-6989586621684958380"><span class="hs-identifier hs-var">newFileIds</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-486"></a><span>          </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pprNatCmmDecl</span><span> </span><a href="#local-6989586621684958360"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958375"><span class="hs-identifier hs-var">native</span></a><span>
</span><a name="line-487"></a><span>
</span><a name="line-488"></a><span>        </span><span class="hs-comment">-- force evaluation all this stuff to avoid space leaks</span><span>
</span><a name="line-489"></a><span>        </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;seqString&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-identifier hs-var">evaluate</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684958364"><span class="hs-identifier hs-var">seqString</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621684958357"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684958376"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621684958384"><a href="#local-6989586621684958384"><span class="hs-identifier">labels'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621684958357"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-492"></a><span>                       </span><span class="hs-keyword">then</span><span> </span><a href="Debug.html#cmmDebugLabels"><span class="hs-identifier hs-var">cmmDebugLabels</span></a><span> </span><a href="Instruction.html#isMetaInstr"><span class="hs-identifier hs-var">isMetaInstr</span></a><span> </span><a href="#local-6989586621684958375"><span class="hs-identifier hs-var">native</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-493"></a><span>            </span><span class="hs-glyph">!</span><a name="local-6989586621684958385"><a href="#local-6989586621684958385"><span class="hs-identifier">natives'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_asm_stats</span><span> </span><a href="#local-6989586621684958357"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-494"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621684958375"><span class="hs-identifier hs-var">native</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ngs_natives</span><span> </span><a href="#local-6989586621684958370"><span class="hs-identifier hs-var">ngs</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span>            </span><a name="local-6989586621684958386"><a href="#local-6989586621684958386"><span class="hs-identifier">mCon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-497"></a><span>            </span><a name="local-6989586621684958387"><a href="#local-6989586621684958387"><span class="hs-identifier">ngs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958370"><span class="hs-identifier hs-var">ngs</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">ngs_imports</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958376"><span class="hs-identifier hs-var">imports</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ngs_imports</span><span> </span><a href="#local-6989586621684958370"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-498"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_natives</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958385"><span class="hs-identifier hs-var">natives'</span></a><span>
</span><a name="line-499"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_colorStats</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958377"><span class="hs-identifier hs-var">colorStats</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621684958386"><span class="hs-identifier hs-var">mCon</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">ngs_colorStats</span><span> </span><a href="#local-6989586621684958370"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-500"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_linearStats</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958378"><span class="hs-identifier hs-var">linearStats</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621684958386"><span class="hs-identifier hs-var">mCon</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">ngs_linearStats</span><span> </span><a href="#local-6989586621684958370"><span class="hs-identifier hs-var">ngs</span></a><span>
</span><a name="line-501"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_labels</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ngs_labels</span><span> </span><a href="#local-6989586621684958370"><span class="hs-identifier hs-var">ngs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684958384"><span class="hs-identifier hs-var">labels'</span></a><span>
</span><a name="line-502"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_dwarfFiles</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958374"><span class="hs-identifier hs-var">fileIds'</span></a><span>
</span><a name="line-503"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ngs_unwinds</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ngs_unwinds</span><span> </span><a href="#local-6989586621684958370"><span class="hs-identifier hs-var">ngs</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#mapUnion"><span class="hs-identifier hs-var">mapUnion</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684958379"><span class="hs-identifier hs-var">unwinds</span></a><span>
</span><a name="line-504"></a><span>                      </span><span class="hs-special">}</span><span>
</span><a name="line-505"></a><span>        </span><a href="#local-6989586621684958363"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684958373"><span class="hs-identifier hs-var">us'</span></a><span> </span><a href="#local-6989586621684958369"><span class="hs-identifier hs-var">cmms</span></a><span> </span><a href="#local-6989586621684958387"><span class="hs-identifier hs-var">ngs'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958371"><span class="hs-identifier hs-var">count</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span>    </span><a name="local-6989586621684958364"><a href="#local-6989586621684958364"><span class="hs-identifier">seqString</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span>    </span><span class="hs-identifier">seqString</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958388"><a href="#local-6989586621684958388"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684958389"><a href="#local-6989586621684958389"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958388"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684958364"><span class="hs-identifier hs-var">seqString</span></a><span> </span><a href="#local-6989586621684958389"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-identifier">emitNativeCode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BufHandle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-512"></a><a name="emitNativeCode"><a href="AsmCodeGen.html#emitNativeCode"><span class="hs-identifier">emitNativeCode</span></a></a><span> </span><a name="local-6989586621684958390"><a href="#local-6989586621684958390"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958391"><a href="#local-6989586621684958391"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621684958392"><a href="#local-6989586621684958392"><span class="hs-identifier">sdoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span>        </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;pprNativeCode&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-identifier hs-var">bufLeftRenderSDoc</span><span> </span><a href="#local-6989586621684958390"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958391"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-515"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCodeStyle</span><span> </span><span class="hs-identifier hs-var">AsmStyle</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958392"><span class="hs-identifier hs-var">sdoc</span></a><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span>        </span><span class="hs-comment">-- dump native code</span><span>
</span><a name="line-518"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958390"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-519"></a><span>                </span><span class="hs-identifier hs-var">Opt_D_dump_asm</span><span> </span><span class="hs-string">&quot;Asm code&quot;</span><span>
</span><a name="line-520"></a><span>                </span><a href="#local-6989586621684958392"><span class="hs-identifier hs-var">sdoc</span></a><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span class="hs-comment">-- | Complete native code generation phase for a single top-level chunk of Cmm.</span><span>
</span><a name="line-523"></a><span class="hs-comment">--      Dumping the output of each stage along the way.</span><span>
</span><a name="line-524"></a><span class="hs-comment">--      Global conflict graph and NGC stats</span><span>
</span><a name="line-525"></a><span class="hs-identifier">cmmNativeGen</span><span>
</span><a name="line-526"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621684958271"><a href="#local-6989586621684958271"><span class="hs-identifier">statics</span></a></a><span> </span><a name="local-6989586621684958272"><a href="#local-6989586621684958272"><span class="hs-identifier">instr</span></a></a><span> </span><a name="local-6989586621684958273"><a href="#local-6989586621684958273"><span class="hs-identifier">jumpDest</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684958272"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span>
</span><a name="line-527"></a><span>        </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958271"><span class="hs-identifier hs-type">statics</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958272"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958273"><span class="hs-identifier hs-type">jumpDest</span></a><span class="hs-special">)</span><span>
</span><a name="line-528"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-529"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>
</span><a name="line-530"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958271"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958272"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958273"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-531"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-532"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#DwarfFiles"><span class="hs-identifier hs-type">DwarfFiles</span></a><span>
</span><a name="line-533"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span>
</span><a name="line-534"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span>                                   </span><span class="hs-comment">-- ^ the cmm to generate code for</span><span>
</span><a name="line-535"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>                                          </span><span class="hs-comment">-- ^ sequence number of this top thing</span><span>
</span><a name="line-536"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span>   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-537"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="NCGMonad.html#DwarfFiles"><span class="hs-identifier hs-type">DwarfFiles</span></a><span>
</span><a name="line-538"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958271"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958272"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- native code</span><span>
</span><a name="line-539"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span>                                  </span><span class="hs-comment">-- things imported by this cmm</span><span>
</span><a name="line-540"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="RegAlloc.Graph.Stats.html#RegAllocStats"><span class="hs-identifier hs-type">Color.RegAllocStats</span></a><span> </span><a href="#local-6989586621684958271"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958272"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- stats for the coloring register allocator</span><span>
</span><a name="line-541"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="RegAlloc.Linear.Base.html#RegAllocStats"><span class="hs-identifier hs-type">Linear.RegAllocStats</span></a><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- stats for the linear register allocators</span><span>
</span><a name="line-542"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- unwinding information for blocks</span><span>
</span><a name="line-543"></a><span>                </span><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><a name="cmmNativeGen"><a href="AsmCodeGen.html#cmmNativeGen"><span class="hs-identifier">cmmNativeGen</span></a></a><span> </span><a name="local-6989586621684958393"><a href="#local-6989586621684958393"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958394"><a href="#local-6989586621684958394"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684958395"><a href="#local-6989586621684958395"><span class="hs-identifier">modLoc</span></a></a><span> </span><a name="local-6989586621684958396"><a href="#local-6989586621684958396"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684958397"><a href="#local-6989586621684958397"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684958398"><a href="#local-6989586621684958398"><span class="hs-identifier">fileIds</span></a></a><span> </span><a name="local-6989586621684958399"><a href="#local-6989586621684958399"><span class="hs-identifier">dbgMap</span></a></a><span> </span><a name="local-6989586621684958400"><a href="#local-6989586621684958400"><span class="hs-identifier">cmm</span></a></a><span> </span><a name="local-6989586621684958401"><a href="#local-6989586621684958401"><span class="hs-identifier">count</span></a></a><span>
</span><a name="line-546"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-547"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958402"><a href="#local-6989586621684958402"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span>        </span><span class="hs-comment">-- rewrite assignments to global regs</span><span>
</span><a name="line-550"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958403"><a href="#local-6989586621684958403"><span class="hs-identifier">fixed_cmm</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-551"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;fixStgRegisters&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-552"></a><span>                </span><a href="CgUtils.html#fixStgRegisters"><span class="hs-identifier hs-var">fixStgRegisters</span></a><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958400"><span class="hs-identifier hs-var">cmm</span></a><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><span>        </span><span class="hs-comment">-- cmm to cmm optimisations</span><span>
</span><a name="line-555"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958404"><a href="#local-6989586621684958404"><span class="hs-identifier">opt_cmm</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958405"><a href="#local-6989586621684958405"><span class="hs-identifier">imports</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-556"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;cmmToCmm&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-557"></a><span>                </span><a href="AsmCodeGen.html#cmmToCmm"><span class="hs-identifier hs-var">cmmToCmm</span></a><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958394"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958403"><span class="hs-identifier hs-var">fixed_cmm</span></a><span>
</span><a name="line-558"></a><span>
</span><a name="line-559"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-560"></a><span>                </span><span class="hs-identifier hs-var">Opt_D_dump_opt_cmm</span><span> </span><span class="hs-string">&quot;Optimised Cmm&quot;</span><span>
</span><a name="line-561"></a><span>                </span><span class="hs-special">(</span><a href="PprCmmDecl.html#pprCmmGroup"><span class="hs-identifier hs-var">pprCmmGroup</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684958404"><span class="hs-identifier hs-var">opt_cmm</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958406"><a href="#local-6989586621684958406"><span class="hs-identifier">cmmCfg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;getCFG&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-564"></a><span>                     </span><a href="CFG.html#getCfgProc"><span class="hs-identifier hs-var">getCfgProc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cfgWeightInfo</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958404"><span class="hs-identifier hs-var">opt_cmm</span></a><span>
</span><a name="line-565"></a><span>
</span><a name="line-566"></a><span>        </span><span class="hs-comment">-- generate native code from cmm</span><span>
</span><a name="line-567"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684958407"><a href="#local-6989586621684958407"><span class="hs-identifier">native</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958408"><a href="#local-6989586621684958408"><span class="hs-identifier">lastMinuteImports</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958409"><a href="#local-6989586621684958409"><span class="hs-identifier">fileIds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958410"><a href="#local-6989586621684958410"><span class="hs-identifier">nativeCfgWeights</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684958411"><a href="#local-6989586621684958411"><span class="hs-identifier">usGen</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-568"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;genMachCode&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-569"></a><span>                </span><span class="hs-identifier hs-var">initUs</span><span> </span><a href="#local-6989586621684958397"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="AsmCodeGen.html#genMachCode"><span class="hs-identifier hs-var">genMachCode</span></a><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958394"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958395"><span class="hs-identifier hs-var">modLoc</span></a><span>
</span><a name="line-570"></a><span>                                        </span><span class="hs-special">(</span><span class="hs-identifier">cmmTopCodeGen</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span>
</span><a name="line-571"></a><span>                                        </span><a href="#local-6989586621684958398"><span class="hs-identifier hs-var">fileIds</span></a><span> </span><a href="#local-6989586621684958399"><span class="hs-identifier hs-var">dbgMap</span></a><span> </span><a href="#local-6989586621684958404"><span class="hs-identifier hs-var">opt_cmm</span></a><span> </span><a href="#local-6989586621684958406"><span class="hs-identifier hs-var">cmmCfg</span></a><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span>
</span><a name="line-574"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-575"></a><span>                </span><span class="hs-identifier hs-var">Opt_D_dump_asm_native</span><span> </span><span class="hs-string">&quot;Native code&quot;</span><span>
</span><a name="line-576"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pprNatCmmDecl</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958407"><span class="hs-identifier hs-var">native</span></a><span class="hs-special">)</span><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-579"></a><span>                </span><span class="hs-identifier hs-var">Opt_D_dump_cfg_weights</span><span> </span><span class="hs-string">&quot;CFG Weights&quot;</span><span>
</span><a name="line-580"></a><span>                </span><span class="hs-special">(</span><a href="CFG.html#pprEdgeWeights"><span class="hs-identifier hs-var">pprEdgeWeights</span></a><span> </span><a href="#local-6989586621684958410"><span class="hs-identifier hs-var">nativeCfgWeights</span></a><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span>        </span><span class="hs-comment">-- tag instructions with register liveness information</span><span>
</span><a name="line-583"></a><span>        </span><span class="hs-comment">-- also drops dead code</span><span>
</span><a name="line-584"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958412"><a href="#local-6989586621684958412"><span class="hs-identifier">livenessCfg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">backendMaintainsCfg</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-585"></a><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684958410"><span class="hs-identifier hs-var">nativeCfgWeights</span></a><span>
</span><a name="line-586"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-587"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958413"><a href="#local-6989586621684958413"><span class="hs-identifier">withLiveness</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958414"><a href="#local-6989586621684958414"><span class="hs-identifier">usLive</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-588"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;regLiveness&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-589"></a><span>                </span><span class="hs-identifier hs-var">initUs</span><span> </span><a href="#local-6989586621684958411"><span class="hs-identifier hs-var">usGen</span></a><span>
</span><a name="line-590"></a><span>                        </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#regLiveness"><span class="hs-identifier hs-var">regLiveness</span></a><span> </span><a href="#local-6989586621684958402"><span class="hs-identifier hs-var">platform</span></a><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span>                        </span><span class="hs-comment">-- TODO: Only use CFG for x86</span><span>
</span><a name="line-592"></a><span>                        </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="RegAlloc.Liveness.html#natCmmTopToLive"><span class="hs-identifier hs-var">natCmmTopToLive</span></a><span> </span><a href="#local-6989586621684958412"><span class="hs-identifier hs-var">livenessCfg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958407"><span class="hs-identifier hs-var">native</span></a><span>
</span><a name="line-593"></a><span>
</span><a name="line-594"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-595"></a><span>                </span><span class="hs-identifier hs-var">Opt_D_dump_asm_liveness</span><span> </span><span class="hs-string">&quot;Liveness annotations added&quot;</span><span>
</span><a name="line-596"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684958413"><span class="hs-identifier hs-var">withLiveness</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span>        </span><span class="hs-comment">-- allocate registers</span><span>
</span><a name="line-599"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684958443"><a href="#local-6989586621684958443"><span class="hs-identifier">alloced</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958444"><a href="#local-6989586621684958444"><span class="hs-identifier">usAlloc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958445"><a href="#local-6989586621684958445"><span class="hs-identifier">ppr_raStatsColor</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958446"><a href="#local-6989586621684958446"><span class="hs-identifier">ppr_raStatsLinear</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958447"><a href="#local-6989586621684958447"><span class="hs-identifier">raStats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958448"><a href="#local-6989586621684958448"><span class="hs-identifier">stack_updt_blks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-600"></a><span>         </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_RegsGraph</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-601"></a><span>           </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_RegsIterative</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-603"></a><span>                </span><span class="hs-comment">-- the regs usable for allocation</span><span>
</span><a name="line-604"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958415"><a href="#local-6989586621684958415"><span class="hs-identifier">alloc_regs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UniqFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">UniqSet</span><span> </span><a href="Reg.html#RealReg"><span class="hs-identifier hs-type">RealReg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684958416"><a href="#local-6989586621684958416"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">plusUFM_C</span><span> </span><span class="hs-identifier hs-var">unionUniqSets</span><span>
</span><a name="line-606"></a><span>                                        </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unitUFM</span><span> </span><span class="hs-special">(</span><a href="TargetReg.html#targetClassOfRealReg"><span class="hs-identifier hs-var">targetClassOfRealReg</span></a><span> </span><a href="#local-6989586621684958402"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684958416"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitUniqSet</span><span> </span><a href="#local-6989586621684958416"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>                                </span><span class="hs-identifier hs-var">emptyUFM</span><span>
</span><a name="line-608"></a><span>                        </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">allocatableRegs</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span>                </span><span class="hs-comment">-- do the graph coloring register allocation</span><span>
</span><a name="line-611"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684958417"><a href="#local-6989586621684958417"><span class="hs-identifier">alloced</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958418"><a href="#local-6989586621684958418"><span class="hs-identifier">maybe_more_stack</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958419"><a href="#local-6989586621684958419"><span class="hs-identifier">regAllocStats</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684958420"><a href="#local-6989586621684958420"><span class="hs-identifier">usAlloc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;RegAlloc-color&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-613"></a><span>                          </span><span class="hs-identifier hs-var">initUs</span><span> </span><a href="#local-6989586621684958414"><span class="hs-identifier hs-var">usLive</span></a><span>
</span><a name="line-614"></a><span>                          </span><span class="hs-operator hs-var">$</span><span> </span><a href="RegAlloc.Graph.Main.html#regAlloc"><span class="hs-identifier hs-var">Color.regAlloc</span></a><span>
</span><a name="line-615"></a><span>                                </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-616"></a><span>                                </span><a href="#local-6989586621684958415"><span class="hs-identifier hs-var">alloc_regs</span></a><span>
</span><a name="line-617"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUniqSet</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-identifier">maxSpillSlots</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-618"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier">maxSpillSlots</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>                                </span><a href="#local-6989586621684958413"><span class="hs-identifier hs-var">withLiveness</span></a><span>
</span><a name="line-620"></a><span>                                </span><a href="#local-6989586621684958412"><span class="hs-identifier hs-var">livenessCfg</span></a><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684958421"><a href="#local-6989586621684958421"><span class="hs-identifier">alloced'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958422"><a href="#local-6989586621684958422"><span class="hs-identifier">stack_updt_blks</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684958423"><a href="#local-6989586621684958423"><span class="hs-identifier">usAlloc'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-623"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">initUs</span><span> </span><a href="#local-6989586621684958420"><span class="hs-identifier hs-var">usAlloc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-624"></a><span>                                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958418"><span class="hs-identifier hs-var">maybe_more_stack</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-625"></a><span>                                </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958417"><span class="hs-identifier hs-var">alloced</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>                                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684958424"><a href="#local-6989586621684958424"><span class="hs-identifier">amount</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-627"></a><span>                                    </span><span class="hs-special">(</span><a name="local-6989586621684958425"><a href="#local-6989586621684958425"><span class="hs-identifier">alloced'</span></a></a><span class="hs-special">,</span><a name="local-6989586621684958426"><a href="#local-6989586621684958426"><span class="hs-identifier">stack_updt_blks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-628"></a><span>                                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">ncgAllocMoreStack</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958424"><span class="hs-identifier hs-var">amount</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958417"><span class="hs-identifier hs-var">alloced</span></a><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>                                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958425"><span class="hs-identifier hs-var">alloced'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621684958426"><span class="hs-identifier hs-var">stack_updt_blks</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span>                </span><span class="hs-comment">-- dump out what happened during register allocation</span><span>
</span><a name="line-633"></a><span>                </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-634"></a><span>                        </span><span class="hs-identifier hs-var">Opt_D_dump_asm_regalloc</span><span> </span><span class="hs-string">&quot;Registers allocated&quot;</span><span>
</span><a name="line-635"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pprNatCmmDecl</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958417"><span class="hs-identifier hs-var">alloced</span></a><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span>                </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-638"></a><span>                        </span><span class="hs-identifier hs-var">Opt_D_dump_asm_regalloc_stages</span><span> </span><span class="hs-string">&quot;Build/spill stages&quot;</span><span>
</span><a name="line-639"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684958427"><a href="#local-6989586621684958427"><span class="hs-identifier">stage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958428"><a href="#local-6989586621684958428"><span class="hs-identifier">stats</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>                                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;# --------------------------&quot;</span><span>
</span><a name="line-641"></a><span>                                        </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;#  cmm &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621684958401"><span class="hs-identifier hs-var">count</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; Stage &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621684958427"><span class="hs-identifier hs-var">stage</span></a><span>
</span><a name="line-642"></a><span>                                        </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684958428"><span class="hs-identifier hs-var">stats</span></a><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>                                </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684958419"><span class="hs-identifier hs-var">regAllocStats</span></a><span class="hs-special">)</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958429"><a href="#local-6989586621684958429"><span class="hs-identifier">mPprStats</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-646"></a><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_asm_stats</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-647"></a><span>                         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684958419"><span class="hs-identifier hs-var">regAllocStats</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-648"></a><span>
</span><a name="line-649"></a><span>                </span><span class="hs-comment">-- force evaluation of the Maybe to avoid space leak</span><span>
</span><a name="line-650"></a><span>                </span><a href="#local-6989586621684958429"><span class="hs-identifier hs-var">mPprStats</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span>                </span><span class="hs-identifier hs-var">return</span><span>  </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684958421"><span class="hs-identifier hs-var">alloced'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958423"><span class="hs-identifier hs-var">usAlloc'</span></a><span>
</span><a name="line-653"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958429"><span class="hs-identifier hs-var">mPprStats</span></a><span>
</span><a name="line-654"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-655"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958422"><span class="hs-identifier hs-var">stack_updt_blks</span></a><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-658"></a><span>                </span><span class="hs-comment">-- do linear register allocation</span><span>
</span><a name="line-659"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958430"><a href="#local-6989586621684958430"><span class="hs-identifier">reg_alloc</span></a></a><span> </span><a name="local-6989586621684958431"><a href="#local-6989586621684958431"><span class="hs-identifier">proc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-660"></a><span>                       </span><span class="hs-special">(</span><a name="local-6989586621684958432"><a href="#local-6989586621684958432"><span class="hs-identifier">alloced</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958433"><a href="#local-6989586621684958433"><span class="hs-identifier">maybe_more_stack</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958434"><a href="#local-6989586621684958434"><span class="hs-identifier">ra_stats</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-661"></a><span>                               </span><a href="RegAlloc.Linear.Main.html#regAlloc"><span class="hs-identifier hs-var">Linear.regAlloc</span></a><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958431"><span class="hs-identifier hs-var">proc</span></a><span>
</span><a name="line-662"></a><span>                       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958433"><span class="hs-identifier hs-var">maybe_more_stack</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-663"></a><span>                         </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684958432"><span class="hs-identifier hs-var">alloced</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958434"><span class="hs-identifier hs-var">ra_stats</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-664"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684958435"><a href="#local-6989586621684958435"><span class="hs-identifier">amount</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-665"></a><span>                           </span><span class="hs-special">(</span><a name="local-6989586621684958436"><a href="#local-6989586621684958436"><span class="hs-identifier">alloced'</span></a></a><span class="hs-special">,</span><a name="local-6989586621684958437"><a href="#local-6989586621684958437"><span class="hs-identifier">stack_updt_blks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-666"></a><span>                               </span><span class="hs-identifier">ncgAllocMoreStack</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958435"><span class="hs-identifier hs-var">amount</span></a><span> </span><a href="#local-6989586621684958432"><span class="hs-identifier hs-var">alloced</span></a><span>
</span><a name="line-667"></a><span>                           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958436"><span class="hs-identifier hs-var">alloced'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958434"><span class="hs-identifier hs-var">ra_stats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958437"><span class="hs-identifier hs-var">stack_updt_blks</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684958438"><a href="#local-6989586621684958438"><span class="hs-identifier">alloced</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958439"><a href="#local-6989586621684958439"><span class="hs-identifier">regAllocStats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958440"><a href="#local-6989586621684958440"><span class="hs-identifier">stack_updt_blks</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684958441"><a href="#local-6989586621684958441"><span class="hs-identifier">usAlloc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-670"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;RegAlloc-linear&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-671"></a><span>                          </span><span class="hs-identifier hs-var">initUs</span><span> </span><a href="#local-6989586621684958414"><span class="hs-identifier hs-var">usLive</span></a><span>
</span><a name="line-672"></a><span>                          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">unzip3</span><span>
</span><a name="line-673"></a><span>                          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684958430"><span class="hs-identifier hs-var">reg_alloc</span></a><span> </span><a href="#local-6989586621684958413"><span class="hs-identifier hs-var">withLiveness</span></a><span>
</span><a name="line-674"></a><span>
</span><a name="line-675"></a><span>                </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-676"></a><span>                        </span><span class="hs-identifier hs-var">Opt_D_dump_asm_regalloc</span><span> </span><span class="hs-string">&quot;Registers allocated&quot;</span><span>
</span><a name="line-677"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pprNatCmmDecl</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958438"><span class="hs-identifier hs-var">alloced</span></a><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958442"><a href="#local-6989586621684958442"><span class="hs-identifier">mPprStats</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-680"></a><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_asm_stats</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-681"></a><span>                         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621684958439"><span class="hs-identifier hs-var">regAllocStats</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span>                </span><span class="hs-comment">-- force evaluation of the Maybe to avoid space leak</span><span>
</span><a name="line-684"></a><span>                </span><a href="#local-6989586621684958442"><span class="hs-identifier hs-var">mPprStats</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span>                </span><span class="hs-identifier hs-var">return</span><span>  </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684958438"><span class="hs-identifier hs-var">alloced</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958441"><span class="hs-identifier hs-var">usAlloc</span></a><span>
</span><a name="line-687"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-688"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958442"><span class="hs-identifier hs-var">mPprStats</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621684958439"><span class="hs-identifier hs-var">regAllocStats</span></a><span class="hs-special">)</span><span>
</span><a name="line-689"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621684958440"><span class="hs-identifier hs-var">stack_updt_blks</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-690"></a><span>
</span><a name="line-691"></a><span>        </span><span class="hs-comment">-- Fixupblocks the register allocator inserted (from, regMoves, to)</span><span>
</span><a name="line-692"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">cfgRegAllocUpdates</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-693"></a><span>            </span><a name="local-6989586621684958449"><a href="#local-6989586621684958449"><span class="hs-identifier">cfgRegAllocUpdates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">Linear.ra_fixupList</span><span> </span><a href="#local-6989586621684958447"><span class="hs-identifier hs-var">raStats</span></a><span class="hs-special">)</span><span>
</span><a name="line-694"></a><span>
</span><a name="line-695"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958450"><a href="#local-6989586621684958450"><span class="hs-identifier">cfgWithFixupBlks</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-696"></a><span>                </span><a href="CFG.html#addNodesBetween"><span class="hs-identifier hs-var">addNodesBetween</span></a><span> </span><a href="#local-6989586621684958410"><span class="hs-identifier hs-var">nativeCfgWeights</span></a><span> </span><a href="#local-6989586621684958449"><span class="hs-identifier hs-var">cfgRegAllocUpdates</span></a><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span>        </span><span class="hs-comment">-- Insert stack update blocks</span><span>
</span><a name="line-699"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958451"><a href="#local-6989586621684958451"><span class="hs-identifier">postRegCFG</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-700"></a><span>                </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684958452"><a href="#local-6989586621684958452"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684958453"><a href="#local-6989586621684958453"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><a name="local-6989586621684958454"><a href="#local-6989586621684958454"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#addImmediateSuccessor"><span class="hs-identifier hs-var">addImmediateSuccessor</span></a><span> </span><a href="#local-6989586621684958453"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621684958454"><span class="hs-identifier hs-var">to</span></a><span> </span><a href="#local-6989586621684958452"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>                       </span><a href="#local-6989586621684958450"><span class="hs-identifier hs-var">cfgWithFixupBlks</span></a><span> </span><a href="#local-6989586621684958448"><span class="hs-identifier hs-var">stack_updt_blks</span></a><span>
</span><a name="line-702"></a><span>
</span><a name="line-703"></a><span>        </span><span class="hs-comment">---- x86fp_kludge.  This pass inserts ffree instructions to clear</span><span>
</span><a name="line-704"></a><span>        </span><span class="hs-comment">---- the FPU stack on x86.  The x86 ABI requires that the FPU stack</span><span>
</span><a name="line-705"></a><span>        </span><span class="hs-comment">---- is clear, and library functions can return odd results if it</span><span>
</span><a name="line-706"></a><span>        </span><span class="hs-comment">---- isn't.</span><span>
</span><a name="line-707"></a><span>        </span><span class="hs-comment">----</span><span>
</span><a name="line-708"></a><span>        </span><span class="hs-comment">---- NB. must happen before shortcutBranches, because that</span><span>
</span><a name="line-709"></a><span>        </span><span class="hs-comment">---- generates JXX_GBLs which we can't fix up in x86fp_kludge.</span><span>
</span><a name="line-710"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958455"><a href="#local-6989586621684958455"><span class="hs-identifier">kludged</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;x86fp_kludge&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-identifier">ncg_x86fp_kludge</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958443"><span class="hs-identifier hs-var">alloced</span></a><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span>        </span><span class="hs-comment">---- generate jump tables</span><span>
</span><a name="line-713"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958456"><a href="#local-6989586621684958456"><span class="hs-identifier">tabled</span></a></a><span>      </span><span class="hs-glyph">=</span><span>
</span><a name="line-714"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;generateJumpTables&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-715"></a><span>                </span><a href="AsmCodeGen.html#generateJumpTables"><span class="hs-identifier hs-var">generateJumpTables</span></a><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958455"><span class="hs-identifier hs-var">kludged</span></a><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-718"></a><span>                </span><span class="hs-identifier hs-var">Opt_D_dump_cfg_weights</span><span> </span><span class="hs-string">&quot;CFG Update information&quot;</span><span>
</span><a name="line-719"></a><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;stack:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684958448"><span class="hs-identifier hs-var">stack_updt_blks</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-720"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;linearAlloc:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684958449"><span class="hs-identifier hs-var">cfgRegAllocUpdates</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span>        </span><span class="hs-comment">---- shortcut branches</span><span>
</span><a name="line-723"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958457"><a href="#local-6989586621684958457"><span class="hs-identifier">shorted</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958458"><a href="#local-6989586621684958458"><span class="hs-identifier">postShortCFG</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span>
</span><a name="line-724"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;shortcutBranches&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-725"></a><span>                </span><a href="AsmCodeGen.html#shortcutBranches"><span class="hs-identifier hs-var">shortcutBranches</span></a><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958456"><span class="hs-identifier hs-var">tabled</span></a><span> </span><a href="#local-6989586621684958451"><span class="hs-identifier hs-var">postRegCFG</span></a><span>
</span><a name="line-726"></a><span>
</span><a name="line-727"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958459"><a href="#local-6989586621684958459"><span class="hs-identifier">optimizedCFG</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-728"></a><span>                </span><a href="CFG.html#optimizeCFG"><span class="hs-identifier hs-var">optimizeCFG</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cfgWeightInfo</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958400"><span class="hs-identifier hs-var">cmm</span></a><span> </span><a href="#local-6989586621684958458"><span class="hs-identifier hs-var">postShortCFG</span></a><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-731"></a><span>                </span><span class="hs-identifier hs-var">Opt_D_dump_cfg_weights</span><span> </span><span class="hs-string">&quot;CFG Final Weights&quot;</span><span>
</span><a name="line-732"></a><span>                </span><span class="hs-special">(</span><span> </span><a href="CFG.html#pprEdgeWeights"><span class="hs-identifier hs-var">pprEdgeWeights</span></a><span> </span><a href="#local-6989586621684958459"><span class="hs-identifier hs-var">optimizedCFG</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>
</span><a name="line-734"></a><span>        </span><span class="hs-comment">--TODO: Partially check validity of the cfg.</span><span>
</span><a name="line-735"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958460"><a href="#local-6989586621684958460"><span class="hs-identifier">getBlks</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684958461"><a href="#local-6989586621684958461"><span class="hs-identifier">_info</span></a></a><span> </span><a name="local-6989586621684958462"><a href="#local-6989586621684958462"><span class="hs-identifier">_lbl</span></a></a><span> </span><a name="local-6989586621684958463"><a href="#local-6989586621684958463"><span class="hs-identifier">_live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684958464"><a href="#local-6989586621684958464"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958464"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-736"></a><span>            </span><span class="hs-identifier">getBlks</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-737"></a><span>
</span><a name="line-738"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">backendMaintainsCfg</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-739"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_DoAsmLinting</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">debugIsOn</span><span> </span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-740"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958465"><a href="#local-6989586621684958465"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621684958460"><span class="hs-identifier hs-var">getBlks</span></a><span> </span><a href="#local-6989586621684958457"><span class="hs-identifier hs-var">shorted</span></a><span>
</span><a name="line-741"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958466"><a href="#local-6989586621684958466"><span class="hs-identifier">labels</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="Cmm.html#blockId"><span class="hs-identifier hs-var">blockId</span></a><span> </span><a href="#local-6989586621684958465"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-742"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">seq</span><span> </span><span class="hs-special">(</span><a href="CFG.html#sanityCheckCfg"><span class="hs-identifier hs-var">sanityCheckCfg</span></a><span> </span><a href="#local-6989586621684958459"><span class="hs-identifier hs-var">optimizedCFG</span></a><span> </span><a href="#local-6989586621684958466"><span class="hs-identifier hs-var">labels</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-743"></a><span>                                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cfg not in lockstep&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span>        </span><span class="hs-comment">---- sequence blocks</span><span>
</span><a name="line-746"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">sequenced</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958271"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958272"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-747"></a><span>            </span><a name="local-6989586621684958467"><a href="#local-6989586621684958467"><span class="hs-identifier">sequenced</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-748"></a><span>                </span><a href="AsmCodeGen.html#checkLayout"><span class="hs-identifier hs-var">checkLayout</span></a><span> </span><a href="#local-6989586621684958457"><span class="hs-identifier hs-var">shorted</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-749"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;sequenceBlocks&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-750"></a><span>                </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="BlockLayout.html#sequenceTop"><span class="hs-identifier hs-var">BlockLayout.sequenceTop</span></a><span>
</span><a name="line-751"></a><span>                        </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-752"></a><span>                        </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958459"><span class="hs-identifier hs-var">optimizedCFG</span></a><span class="hs-special">)</span><span>
</span><a name="line-753"></a><span>                    </span><a href="#local-6989586621684958457"><span class="hs-identifier hs-var">shorted</span></a><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">branchOpt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958271"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958272"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-756"></a><span>            </span><a name="local-6989586621684958468"><a href="#local-6989586621684958468"><span class="hs-identifier">branchOpt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-757"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;invertCondBranches&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-758"></a><span>                </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684958470"><span class="hs-identifier hs-var">invert</span></a><span> </span><a href="#local-6989586621684958467"><span class="hs-identifier hs-var">sequenced</span></a><span>
</span><a name="line-759"></a><span>              </span><span class="hs-keyword">where</span><span>
</span><a name="line-760"></a><span>                </span><a name="local-6989586621684958469"><a href="#local-6989586621684958469"><span class="hs-identifier">invertConds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">invertCondBranches</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958459"><span class="hs-identifier hs-var">optimizedCFG</span></a><span>
</span><a name="line-761"></a><span>                </span><a name="local-6989586621684958470"><a href="#local-6989586621684958470"><span class="hs-identifier">invert</span></a></a><span> </span><a name="local-6989586621684958471"><a href="#local-6989586621684958471"><span class="hs-identifier">top</span></a></a><span class="hs-glyph">@</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958471"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-762"></a><span>                </span><span class="hs-identifier">invert</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684958472"><a href="#local-6989586621684958472"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684958473"><a href="#local-6989586621684958473"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684958474"><a href="#local-6989586621684958474"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684958475"><a href="#local-6989586621684958475"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-763"></a><span>                    </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684958472"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684958473"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684958474"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684958469"><span class="hs-identifier hs-var">invertConds</span></a><span> </span><a href="#local-6989586621684958472"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684958475"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span>        </span><span class="hs-comment">---- expansion of SPARC synthetic instrs</span><span>
</span><a name="line-766"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958476"><a href="#local-6989586621684958476"><span class="hs-identifier">expanded</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-767"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;sparc_expand&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-768"></a><span>                </span><span class="hs-identifier">ncgExpandTop</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958468"><span class="hs-identifier hs-var">branchOpt</span></a><span>
</span><a name="line-769"></a><span>                </span><span class="hs-comment">--ncgExpandTop ncgImpl sequenced</span><span>
</span><a name="line-770"></a><span>
</span><a name="line-771"></a><span>        </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-772"></a><span>                </span><span class="hs-identifier hs-var">Opt_D_dump_asm_expanded</span><span> </span><span class="hs-string">&quot;Synthetic instructions expanded&quot;</span><span>
</span><a name="line-773"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pprNatCmmDecl</span><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958476"><span class="hs-identifier hs-var">expanded</span></a><span class="hs-special">)</span><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span>        </span><span class="hs-comment">-- generate unwinding information from cmm</span><span>
</span><a name="line-776"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">unwinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="RegAlloc.Liveness.html#BlockMap"><span class="hs-identifier hs-type">BlockMap</span></a><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span>
</span><a name="line-777"></a><span>            </span><a name="local-6989586621684958477"><a href="#local-6989586621684958477"><span class="hs-identifier">unwinds</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-778"></a><span>                </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;unwindingInfo&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-779"></a><span>                </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684958478"><span class="hs-identifier hs-var">addUnwind</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621684958476"><span class="hs-identifier hs-var">expanded</span></a><span>
</span><a name="line-780"></a><span>              </span><span class="hs-keyword">where</span><span>
</span><a name="line-781"></a><span>                </span><a name="local-6989586621684958478"><a href="#local-6989586621684958478"><span class="hs-identifier">addUnwind</span></a></a><span> </span><a name="local-6989586621684958479"><a href="#local-6989586621684958479"><span class="hs-identifier">acc</span></a></a><span> </span><a name="local-6989586621684958480"><a href="#local-6989586621684958480"><span class="hs-identifier">proc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-782"></a><span>                    </span><a href="#local-6989586621684958479"><span class="hs-identifier hs-var">acc</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#mapUnion"><span class="hs-identifier hs-var">mapUnion</span></a><span class="hs-special">`</span><span> </span><a href="AsmCodeGen.html#computeUnwinding"><span class="hs-identifier hs-var">computeUnwinding</span></a><span> </span><a href="#local-6989586621684958393"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958396"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958480"><span class="hs-identifier hs-var">proc</span></a><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span>        </span><span class="hs-identifier hs-var">return</span><span>  </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684958444"><span class="hs-identifier hs-var">usAlloc</span></a><span>
</span><a name="line-785"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958409"><span class="hs-identifier hs-var">fileIds'</span></a><span>
</span><a name="line-786"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958476"><span class="hs-identifier hs-var">expanded</span></a><span>
</span><a name="line-787"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958408"><span class="hs-identifier hs-var">lastMinuteImports</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684958405"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-788"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958445"><span class="hs-identifier hs-var">ppr_raStatsColor</span></a><span>
</span><a name="line-789"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958446"><span class="hs-identifier hs-var">ppr_raStatsLinear</span></a><span>
</span><a name="line-790"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958477"><span class="hs-identifier hs-var">unwinds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-791"></a><span>
</span><a name="line-792"></a><span class="hs-comment">-- | Make sure all blocks we want the layout algorithm to place have been placed.</span><span>
</span><a name="line-793"></a><span class="hs-identifier">checkLayout</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958269"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958270"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958269"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958270"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-794"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958269"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958270"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-795"></a><a name="checkLayout"><a href="AsmCodeGen.html#checkLayout"><span class="hs-identifier">checkLayout</span></a></a><span> </span><a name="local-6989586621684958481"><a href="#local-6989586621684958481"><span class="hs-identifier">procsUnsequenced</span></a></a><span> </span><a name="local-6989586621684958482"><a href="#local-6989586621684958482"><span class="hs-identifier">procsSequenced</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-796"></a><span>        </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span class="hs-identifier">setNull</span><span> </span><span class="hs-identifier">diff</span><span class="hs-special">,</span><span>
</span><a name="line-797"></a><span>                </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-string">&quot;Block sequencing dropped blocks:&quot;</span><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">diff</span><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span>        </span><a href="#local-6989586621684958482"><span class="hs-identifier hs-var">procsSequenced</span></a><span>
</span><a name="line-799"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-800"></a><span>        </span><a name="local-6989586621684958483"><a href="#local-6989586621684958483"><span class="hs-identifier">blocks1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setUnion"><span class="hs-identifier hs-var">setUnion</span></a><span class="hs-special">)</span><span> </span><a href="Hoopl.Collections.html#setEmpty"><span class="hs-identifier hs-var">setEmpty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-801"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684958486"><span class="hs-identifier hs-var">getBlockIds</span></a><span> </span><a href="#local-6989586621684958481"><span class="hs-identifier hs-var">procsUnsequenced</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-802"></a><span>        </span><a name="local-6989586621684958484"><a href="#local-6989586621684958484"><span class="hs-identifier">blocks2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setUnion"><span class="hs-identifier hs-var">setUnion</span></a><span class="hs-special">)</span><span> </span><a href="Hoopl.Collections.html#setEmpty"><span class="hs-identifier hs-var">setEmpty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-803"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684958486"><span class="hs-identifier hs-var">getBlockIds</span></a><span> </span><a href="#local-6989586621684958482"><span class="hs-identifier hs-var">procsSequenced</span></a><span>
</span><a name="line-804"></a><span>        </span><a name="local-6989586621684958485"><a href="#local-6989586621684958485"><span class="hs-identifier">diff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#setDifference"><span class="hs-identifier hs-var">setDifference</span></a><span> </span><a href="#local-6989586621684958483"><span class="hs-identifier hs-var">blocks1</span></a><span> </span><a href="#local-6989586621684958484"><span class="hs-identifier hs-var">blocks2</span></a><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span>        </span><a name="local-6989586621684958486"><a href="#local-6989586621684958486"><span class="hs-identifier">getBlockIds</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#setEmpty"><span class="hs-identifier hs-var">setEmpty</span></a><span>
</span><a name="line-807"></a><span>        </span><span class="hs-identifier">getBlockIds</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684958487"><a href="#local-6989586621684958487"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-808"></a><span>                </span><a href="Hoopl.Collections.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Cmm.html#blockId"><span class="hs-identifier hs-var">blockId</span></a><span> </span><a href="#local-6989586621684958487"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-809"></a><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-identifier">x86fp_kludge</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alignment</span><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span class="hs-special">)</span><span> </span><a href="X86.Instr.html#Instr"><span class="hs-identifier hs-type">X86.Instr.Instr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Alignment</span><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmStatics"><span class="hs-identifier hs-type">CmmStatics</span></a><span class="hs-special">)</span><span> </span><a href="X86.Instr.html#Instr"><span class="hs-identifier hs-type">X86.Instr.Instr</span></a><span>
</span><a name="line-812"></a><a name="x86fp_kludge"><a href="AsmCodeGen.html#x86fp_kludge"><span class="hs-identifier">x86fp_kludge</span></a></a><span> </span><a name="local-6989586621684958488"><a href="#local-6989586621684958488"><span class="hs-identifier">top</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958488"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-813"></a><span class="hs-identifier">x86fp_kludge</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684958489"><a href="#local-6989586621684958489"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684958490"><a href="#local-6989586621684958490"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684958491"><a href="#local-6989586621684958491"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684958492"><a href="#local-6989586621684958492"><span class="hs-identifier">code</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-814"></a><span>        </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684958489"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684958490"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684958491"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="X86.Instr.html#i386_insert_ffrees"><span class="hs-identifier hs-var">X86.Instr.i386_insert_ffrees</span></a><span> </span><a href="#local-6989586621684958492"><span class="hs-identifier hs-var">code</span></a><span class="hs-special">)</span><span>
</span><a name="line-815"></a><span>
</span><a name="line-816"></a><span class="hs-comment">-- | Compute unwinding tables for the blocks of a procedure</span><span>
</span><a name="line-817"></a><span class="hs-identifier">computeUnwinding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Instruction.html#Instruction"><span class="hs-identifier hs-type">Instruction</span></a><span> </span><a href="#local-6989586621684958266"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-818"></a><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958267"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958266"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958268"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-819"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958267"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958266"><span class="hs-identifier hs-type">instr</span></a><span>
</span><a name="line-820"></a><span>                    </span><span class="hs-comment">-- ^ the native code generated for the procedure</span><span>
</span><a name="line-821"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-special">[</span><a href="Debug.html#UnwindPoint"><span class="hs-identifier hs-type">UnwindPoint</span></a><span class="hs-special">]</span><span>
</span><a name="line-822"></a><span>                    </span><span class="hs-comment">-- ^ unwinding tables for all points of all blocks of the</span><span>
</span><a name="line-823"></a><span>                    </span><span class="hs-comment">-- procedure</span><span>
</span><a name="line-824"></a><a name="computeUnwinding"><a href="AsmCodeGen.html#computeUnwinding"><span class="hs-identifier">computeUnwinding</span></a></a><span> </span><a name="local-6989586621684958493"><a href="#local-6989586621684958493"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-825"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">debugLevel</span><span> </span><a href="#local-6989586621684958493"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-826"></a><span class="hs-identifier">computeUnwinding</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-827"></a><span class="hs-identifier">computeUnwinding</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958494"><a href="#local-6989586621684958494"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684958495"><a href="#local-6989586621684958495"><span class="hs-identifier">blks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-828"></a><span>    </span><span class="hs-comment">-- In general we would need to push unwinding information down the</span><span>
</span><a name="line-829"></a><span>    </span><span class="hs-comment">-- block-level call-graph to ensure that we fully account for all</span><span>
</span><a name="line-830"></a><span>    </span><span class="hs-comment">-- relevant register writes within a procedure.</span><span>
</span><a name="line-831"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-832"></a><span>    </span><span class="hs-comment">-- However, the only unwinding information that we care about in GHC is for</span><span>
</span><a name="line-833"></a><span>    </span><span class="hs-comment">-- Sp. The fact that CmmLayoutStack already ensures that we have unwind</span><span>
</span><a name="line-834"></a><span>    </span><span class="hs-comment">-- information at the beginning of every block means that there is no need</span><span>
</span><a name="line-835"></a><span>    </span><span class="hs-comment">-- to perform this sort of push-down.</span><span>
</span><a name="line-836"></a><span>    </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958496"><span class="hs-identifier hs-var">blk_lbl</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">extractUnwindPoints</span><span> </span><a href="#local-6989586621684958494"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958497"><span class="hs-identifier hs-var">instrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684958496"><a href="#local-6989586621684958496"><span class="hs-identifier">blk_lbl</span></a></a><span> </span><a name="local-6989586621684958497"><a href="#local-6989586621684958497"><span class="hs-identifier">instrs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684958495"><span class="hs-identifier hs-var">blks</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span class="hs-comment">-- | Build a doc for all the imports.</span><span>
</span><a name="line-840"></a><span class="hs-comment">--</span><span>
</span><a name="line-841"></a><span class="hs-identifier">makeImportsDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-842"></a><a name="makeImportsDoc"><a href="AsmCodeGen.html#makeImportsDoc"><span class="hs-identifier">makeImportsDoc</span></a></a><span> </span><a name="local-6989586621684958498"><a href="#local-6989586621684958498"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958499"><a href="#local-6989586621684958499"><span class="hs-identifier">imports</span></a></a><span>
</span><a name="line-843"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958503"><span class="hs-identifier hs-var">dyld_stubs</span></a><span> </span><a href="#local-6989586621684958499"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-844"></a><span>            </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-845"></a><span>            </span><span class="hs-comment">-- On recent versions of Darwin, the linker supports</span><span>
</span><a name="line-846"></a><span>            </span><span class="hs-comment">-- dead-stripping of code and data on a per-symbol basis.</span><span>
</span><a name="line-847"></a><span>            </span><span class="hs-comment">-- There's a hack to make this work in PprMach.pprNatCmmDecl.</span><span>
</span><a name="line-848"></a><span>            </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformHasSubsectionsViaSymbols</span><span> </span><a href="#local-6989586621684958500"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-849"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.subsections_via_symbols&quot;</span><span>
</span><a name="line-850"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">)</span><span>
</span><a name="line-851"></a><span>            </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-852"></a><span>                </span><span class="hs-comment">-- On recent GNU ELF systems one can mark an object file</span><span>
</span><a name="line-853"></a><span>                </span><span class="hs-comment">-- as not requiring an executable stack. If all objects</span><span>
</span><a name="line-854"></a><span>                </span><span class="hs-comment">-- linked into a program have this note then the program</span><span>
</span><a name="line-855"></a><span>                </span><span class="hs-comment">-- will not use an executable stack, which is good for</span><span>
</span><a name="line-856"></a><span>                </span><span class="hs-comment">-- security. GHC generated code does not need an executable</span><span>
</span><a name="line-857"></a><span>                </span><span class="hs-comment">-- stack so add the note in:</span><span>
</span><a name="line-858"></a><span>            </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformHasGnuNonexecStack</span><span> </span><a href="#local-6989586621684958500"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-859"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section .note.GNU-stack,\&quot;\&quot;,&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="AsmUtils.html#sectionType"><span class="hs-identifier hs-var">sectionType</span></a><span> </span><span class="hs-string">&quot;progbits&quot;</span><span>
</span><a name="line-860"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">)</span><span>
</span><a name="line-861"></a><span>            </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-862"></a><span>                </span><span class="hs-comment">-- And just because every other compiler does, let's stick in</span><span>
</span><a name="line-863"></a><span>                </span><span class="hs-comment">-- an identifier directive: .ident &quot;GHC x.y.z&quot;</span><span>
</span><a name="line-864"></a><span>            </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformHasIdentDirective</span><span> </span><a href="#local-6989586621684958500"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-865"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958512"><a href="#local-6989586621684958512"><span class="hs-identifier">compilerIdent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;GHC&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-identifier hs-var">cProjectVersion</span><span>
</span><a name="line-866"></a><span>                   </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.ident&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">doubleQuotes</span><span> </span><a href="#local-6989586621684958512"><span class="hs-identifier hs-var">compilerIdent</span></a><span>
</span><a name="line-867"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span class="hs-special">)</span><span>
</span><a name="line-868"></a><span>
</span><a name="line-869"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-870"></a><span>        </span><a name="local-6989586621684958500"><a href="#local-6989586621684958500"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684958498"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-871"></a><span>        </span><a name="local-6989586621684958501"><a href="#local-6989586621684958501"><span class="hs-identifier">arch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621684958500"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-872"></a><span>        </span><a name="local-6989586621684958502"><a href="#local-6989586621684958502"><span class="hs-identifier">os</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformOS</span><span>   </span><a href="#local-6989586621684958500"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-873"></a><span>
</span><a name="line-874"></a><span>        </span><span class="hs-comment">-- Generate &quot;symbol stubs&quot; for all external symbols that might</span><span>
</span><a name="line-875"></a><span>        </span><span class="hs-comment">-- come from a dynamic library.</span><span>
</span><a name="line-876"></a><span>        </span><span class="hs-identifier">dyld_stubs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-877"></a><span class="hs-comment">{-      dyld_stubs imps = vcat $ map pprDyldSymbolStub $
                                    map head $ group $ sort imps-}</span><span>
</span><a name="line-879"></a><span>        </span><span class="hs-comment">-- (Hack) sometimes two Labels pretty-print the same, but have</span><span>
</span><a name="line-880"></a><span>        </span><span class="hs-comment">-- different uniques; so we compare their text versions...</span><span>
</span><a name="line-881"></a><span>        </span><a name="local-6989586621684958503"><a href="#local-6989586621684958503"><span class="hs-identifier">dyld_stubs</span></a></a><span> </span><a name="local-6989586621684958506"><a href="#local-6989586621684958506"><span class="hs-identifier">imps</span></a></a><span>
</span><a name="line-882"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="PIC.html#needImportedSymbols"><span class="hs-identifier hs-var">needImportedSymbols</span></a><span> </span><a href="#local-6989586621684958498"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958501"><span class="hs-identifier hs-var">arch</span></a><span> </span><a href="#local-6989586621684958502"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-883"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-884"></a><span>                        </span><span class="hs-special">(</span><a href="PIC.html#pprGotDeclaration"><span class="hs-identifier hs-var">pprGotDeclaration</span></a><span> </span><a href="#local-6989586621684958498"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958501"><span class="hs-identifier hs-var">arch</span></a><span> </span><a href="#local-6989586621684958502"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-885"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span> </span><a href="PIC.html#pprImportedSymbol"><span class="hs-identifier hs-var">pprImportedSymbol</span></a><span> </span><a href="#local-6989586621684958498"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958500"><span class="hs-identifier hs-var">platform</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">head</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-886"></a><span>                        </span><span class="hs-identifier hs-var">groupBy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684958507"><a href="#local-6989586621684958507"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684958508"><a href="#local-6989586621684958508"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684958507"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684958508"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-887"></a><span>                        </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684958509"><a href="#local-6989586621684958509"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684958510"><a href="#local-6989586621684958510"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621684958509"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621684958510"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-888"></a><span>                        </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684958504"><span class="hs-identifier hs-var">doPpr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-889"></a><span>                        </span><a href="#local-6989586621684958506"><span class="hs-identifier hs-var">imps</span></a><span>
</span><a name="line-890"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-891"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span>        </span><a name="local-6989586621684958504"><a href="#local-6989586621684958504"><span class="hs-identifier">doPpr</span></a></a><span> </span><a name="local-6989586621684958511"><a href="#local-6989586621684958511"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958511"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">renderWithStyle</span><span> </span><a href="#local-6989586621684958498"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#pprCLabel"><span class="hs-identifier hs-var">pprCLabel</span></a><span> </span><a href="#local-6989586621684958500"><span class="hs-identifier hs-var">platform</span></a><span> </span><a href="#local-6989586621684958511"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958505"><span class="hs-identifier hs-var">astyle</span></a><span class="hs-special">)</span><span>
</span><a name="line-894"></a><span>        </span><a name="local-6989586621684958505"><a href="#local-6989586621684958505"><span class="hs-identifier">astyle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCodeStyle</span><span> </span><span class="hs-identifier hs-var">AsmStyle</span><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-897"></a><span class="hs-comment">-- Generate jump tables</span><span>
</span><a name="line-898"></a><span>
</span><a name="line-899"></a><span class="hs-comment">-- Analyzes all native code and generates data sections for all jump</span><span>
</span><a name="line-900"></a><span class="hs-comment">-- table instructions.</span><span>
</span><a name="line-901"></a><span class="hs-identifier">generateJumpTables</span><span>
</span><a name="line-902"></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958263"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958264"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958265"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-903"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958263"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958264"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958263"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958264"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-904"></a><a name="generateJumpTables"><a href="AsmCodeGen.html#generateJumpTables"><span class="hs-identifier">generateJumpTables</span></a></a><span> </span><a name="local-6989586621684958513"><a href="#local-6989586621684958513"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684958514"><a href="#local-6989586621684958514"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621684958515"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621684958514"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-905"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684958515"><a href="#local-6989586621684958515"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621684958517"><a href="#local-6989586621684958517"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684958518"><a href="#local-6989586621684958518"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958517"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621684958516"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621684958518"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-906"></a><span>          </span><span class="hs-identifier">f</span><span> </span><a name="local-6989586621684958519"><a href="#local-6989586621684958519"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684958519"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">]</span><span>
</span><a name="line-907"></a><span>          </span><a name="local-6989586621684958516"><a href="#local-6989586621684958516"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958520"><a href="#local-6989586621684958520"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">generateJumpTableForInstr</span><span> </span><a href="#local-6989586621684958513"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958520"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>
</span><a name="line-909"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-910"></a><span class="hs-comment">-- Shortcut branches</span><span>
</span><a name="line-911"></a><span>
</span><a name="line-912"></a><span class="hs-identifier">shortcutBranches</span><span>
</span><a name="line-913"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621684958260"><a href="#local-6989586621684958260"><span class="hs-identifier">statics</span></a></a><span> </span><a name="local-6989586621684958261"><a href="#local-6989586621684958261"><span class="hs-identifier">instr</span></a></a><span> </span><a name="local-6989586621684958262"><a href="#local-6989586621684958262"><span class="hs-identifier">jumpDest</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621684958262"><span class="hs-identifier hs-type">jumpDest</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-914"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958260"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958261"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958262"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-915"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958260"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958261"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-916"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-917"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958260"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958261"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span class="hs-special">)</span><span>
</span><a name="line-918"></a><span>
</span><a name="line-919"></a><a name="shortcutBranches"><a href="AsmCodeGen.html#shortcutBranches"><span class="hs-identifier">shortcutBranches</span></a></a><span> </span><a name="local-6989586621684958521"><a href="#local-6989586621684958521"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958522"><a href="#local-6989586621684958522"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684958523"><a href="#local-6989586621684958523"><span class="hs-identifier">tops</span></a></a><span> </span><a name="local-6989586621684958524"><a href="#local-6989586621684958524"><span class="hs-identifier">weights</span></a></a><span>
</span><a name="line-920"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_AsmShortcutting</span><span> </span><a href="#local-6989586621684958521"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-921"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#apply_mapping"><span class="hs-identifier hs-var">apply_mapping</span></a><span> </span><a href="#local-6989586621684958522"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958527"><span class="hs-identifier hs-var">mapping</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958525"><span class="hs-identifier hs-var">tops'</span></a><span>
</span><a name="line-922"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CFG.html#shortcutWeightMap"><span class="hs-identifier hs-var">shortcutWeightMap</span></a><span> </span><a href="#local-6989586621684958524"><span class="hs-identifier hs-var">weights</span></a><span> </span><a href="#local-6989586621684958528"><span class="hs-identifier hs-var">mappingBid</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-923"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-924"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958523"><span class="hs-identifier hs-var">tops</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958524"><span class="hs-identifier hs-var">weights</span></a><span class="hs-special">)</span><span>
</span><a name="line-925"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-926"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684958525"><a href="#local-6989586621684958525"><span class="hs-identifier">tops'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958526"><a href="#local-6989586621684958526"><span class="hs-identifier">mappings</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAndUnzip</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#build_mapping"><span class="hs-identifier hs-var">build_mapping</span></a><span> </span><a href="#local-6989586621684958522"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958523"><span class="hs-identifier hs-var">tops</span></a><span>
</span><a name="line-927"></a><span>    </span><a name="local-6989586621684958527"><a href="#local-6989586621684958527"><span class="hs-identifier">mapping</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapUnions"><span class="hs-identifier hs-var">mapUnions</span></a><span> </span><a href="#local-6989586621684958526"><span class="hs-identifier hs-var">mappings</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684958262"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-928"></a><span>    </span><a name="local-6989586621684958528"><a href="#local-6989586621684958528"><span class="hs-identifier">mappingBid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getJumpDestBlockId</span><span> </span><a href="#local-6989586621684958522"><span class="hs-identifier hs-var">ncgImpl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958527"><span class="hs-identifier hs-var">mapping</span></a><span>
</span><a name="line-929"></a><span>
</span><a name="line-930"></a><span class="hs-identifier">build_mapping</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621684958255"><a href="#local-6989586621684958255"><span class="hs-identifier">instr</span></a></a><span> </span><a name="local-6989586621684958256"><a href="#local-6989586621684958256"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684958257"><a href="#local-6989586621684958257"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621684958258"><a href="#local-6989586621684958258"><span class="hs-identifier">statics</span></a></a><span> </span><a name="local-6989586621684958259"><a href="#local-6989586621684958259"><span class="hs-identifier">jumpDest</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-931"></a><span>                 </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958258"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958255"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958259"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-932"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#GenCmmDecl"><span class="hs-identifier hs-type">GenCmmDecl</span></a><span> </span><a href="#local-6989586621684958257"><span class="hs-identifier hs-type">d</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684958256"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-type">ListGraph</span></a><span> </span><a href="#local-6989586621684958255"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#GenCmmDecl"><span class="hs-identifier hs-type">GenCmmDecl</span></a><span> </span><a href="#local-6989586621684958257"><span class="hs-identifier hs-type">d</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684958256"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-type">ListGraph</span></a><span> </span><a href="#local-6989586621684958255"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-934"></a><span>                 </span><span class="hs-special">,</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684958259"><span class="hs-identifier hs-type">jumpDest</span></a><span class="hs-special">)</span><span>
</span><a name="line-935"></a><a name="build_mapping"><a href="AsmCodeGen.html#build_mapping"><span class="hs-identifier">build_mapping</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958529"><a href="#local-6989586621684958529"><span class="hs-identifier">top</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958529"><span class="hs-identifier hs-var">top</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span class="hs-identifier">build_mapping</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684958530"><a href="#local-6989586621684958530"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684958531"><a href="#local-6989586621684958531"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684958532"><a href="#local-6989586621684958532"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-937"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684958530"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684958531"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684958532"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span class="hs-special">)</span><span>
</span><a name="line-938"></a><span class="hs-identifier">build_mapping</span><span> </span><a name="local-6989586621684958533"><a href="#local-6989586621684958533"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684958534"><a href="#local-6989586621684958534"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684958535"><a href="#local-6989586621684958535"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684958536"><a href="#local-6989586621684958536"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684958537"><a href="#local-6989586621684958537"><span class="hs-identifier">head</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684958538"><a href="#local-6989586621684958538"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-939"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684958534"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684958535"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684958536"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958537"><span class="hs-identifier hs-var">head</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684958540"><span class="hs-identifier hs-var">others</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958543"><span class="hs-identifier hs-var">mapping</span></a><span class="hs-special">)</span><span>
</span><a name="line-940"></a><span>        </span><span class="hs-comment">-- drop the shorted blocks, but don't ever drop the first one,</span><span>
</span><a name="line-941"></a><span>        </span><span class="hs-comment">-- because it is pointed to by a global label.</span><span>
</span><a name="line-942"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-943"></a><span>    </span><span class="hs-comment">-- find all the blocks that just consist of a jump that can be</span><span>
</span><a name="line-944"></a><span>    </span><span class="hs-comment">-- shorted.</span><span>
</span><a name="line-945"></a><span>    </span><span class="hs-comment">-- Don't completely eliminate loops here -- that can leave a dangling jump!</span><span>
</span><a name="line-946"></a><span>    </span><span class="hs-identifier">shortcut_blocks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958259"><span class="hs-identifier hs-type">jumpDest</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-947"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684958539"><a href="#local-6989586621684958539"><span class="hs-identifier">shortcut_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958540"><a href="#local-6989586621684958540"><span class="hs-identifier">others</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-948"></a><span>        </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684958541"><span class="hs-identifier hs-var">split</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setEmpty"><span class="hs-identifier hs-var">setEmpty</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958538"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-949"></a><span>    </span><a name="local-6989586621684958541"><a href="#local-6989586621684958541"><span class="hs-identifier">split</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684958544"><a href="#local-6989586621684958544"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958545"><a href="#local-6989586621684958545"><span class="hs-identifier">shortcut_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958546"><a href="#local-6989586621684958546"><span class="hs-identifier">others</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684958547"><a href="#local-6989586621684958547"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684958548"><a href="#local-6989586621684958548"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621684958549"><a href="#local-6989586621684958549"><span class="hs-identifier">insn</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-950"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684958550"><a href="#local-6989586621684958550"><span class="hs-identifier">jd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">canShortcut</span><span> </span><a href="#local-6989586621684958533"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958549"><span class="hs-identifier hs-var">insn</span></a><span>
</span><a name="line-951"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684958551"><a href="#local-6989586621684958551"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">getJumpDestBlockId</span><span> </span><a href="#local-6989586621684958533"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958550"><span class="hs-identifier hs-var">jd</span></a><span>
</span><a name="line-952"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958542"><span class="hs-identifier hs-var">has_info</span></a><span> </span><a href="#local-6989586621684958548"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-953"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span> </span><a href="#local-6989586621684958551"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-6989586621684958544"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684958551"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684958548"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-comment">-- loop checks</span><span>
</span><a name="line-954"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958544"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958545"><span class="hs-identifier hs-var">shortcut_blocks</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958547"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684958546"><span class="hs-identifier hs-var">others</span></a><span class="hs-special">)</span><span>
</span><a name="line-955"></a><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958552"><a href="#local-6989586621684958552"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958553"><a href="#local-6989586621684958553"><span class="hs-identifier">shortcut_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958554"><a href="#local-6989586621684958554"><span class="hs-identifier">others</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684958555"><a href="#local-6989586621684958555"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621684958556"><a href="#local-6989586621684958556"><span class="hs-identifier">insn</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684958557"><a href="#local-6989586621684958557"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">canShortcut</span><span> </span><a href="#local-6989586621684958533"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><a href="#local-6989586621684958556"><span class="hs-identifier hs-var">insn</span></a><span>
</span><a name="line-957"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958542"><span class="hs-identifier hs-var">has_info</span></a><span> </span><a href="#local-6989586621684958555"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-958"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#setInsert"><span class="hs-identifier hs-var">setInsert</span></a><span> </span><a href="#local-6989586621684958555"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684958552"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958555"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><a href="#local-6989586621684958557"><span class="hs-identifier hs-var">dest</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684958553"><span class="hs-identifier hs-var">shortcut_blocks</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958554"><span class="hs-identifier hs-var">others</span></a><span class="hs-special">)</span><span>
</span><a name="line-959"></a><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958558"><a href="#local-6989586621684958558"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958559"><a href="#local-6989586621684958559"><span class="hs-identifier">shortcut_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958560"><a href="#local-6989586621684958560"><span class="hs-identifier">others</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684958561"><a href="#local-6989586621684958561"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958558"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958559"><span class="hs-identifier hs-var">shortcut_blocks</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958561"><span class="hs-identifier hs-var">other</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684958560"><span class="hs-identifier hs-var">others</span></a><span class="hs-special">)</span><span>
</span><a name="line-960"></a><span>
</span><a name="line-961"></a><span>    </span><span class="hs-comment">-- do not eliminate blocks that have an info table</span><span>
</span><a name="line-962"></a><span>    </span><a name="local-6989586621684958542"><a href="#local-6989586621684958542"><span class="hs-identifier">has_info</span></a></a><span> </span><a name="local-6989586621684958562"><a href="#local-6989586621684958562"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapMember"><span class="hs-identifier hs-var">mapMember</span></a><span> </span><a href="#local-6989586621684958562"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621684958534"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-963"></a><span>
</span><a name="line-964"></a><span>    </span><span class="hs-comment">-- build a mapping from BlockId to JumpDest for shorting branches</span><span>
</span><a name="line-965"></a><span>    </span><a name="local-6989586621684958543"><a href="#local-6989586621684958543"><span class="hs-identifier">mapping</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><a href="#local-6989586621684958539"><span class="hs-identifier hs-var">shortcut_blocks</span></a><span>
</span><a name="line-966"></a><span>
</span><a name="line-967"></a><span class="hs-identifier">apply_mapping</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NCGMonad.html#NcgImpl"><span class="hs-identifier hs-type">NcgImpl</span></a><span> </span><a href="#local-6989586621684958251"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958252"><span class="hs-identifier hs-type">instr</span></a><span> </span><a href="#local-6989586621684958253"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-968"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="#local-6989586621684958253"><span class="hs-identifier hs-type">jumpDest</span></a><span>
</span><a name="line-969"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#GenCmmDecl"><span class="hs-identifier hs-type">GenCmmDecl</span></a><span> </span><a href="#local-6989586621684958251"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958254"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-type">ListGraph</span></a><span> </span><a href="#local-6989586621684958252"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-970"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#GenCmmDecl"><span class="hs-identifier hs-type">GenCmmDecl</span></a><span> </span><a href="#local-6989586621684958251"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958254"><span class="hs-identifier hs-type">h</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-type">ListGraph</span></a><span> </span><a href="#local-6989586621684958252"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">)</span><span>
</span><a name="line-971"></a><a name="apply_mapping"><a href="AsmCodeGen.html#apply_mapping"><span class="hs-identifier">apply_mapping</span></a></a><span> </span><a name="local-6989586621684958563"><a href="#local-6989586621684958563"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684958564"><a href="#local-6989586621684958564"><span class="hs-identifier">ufm</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><a name="local-6989586621684958565"><a href="#local-6989586621684958565"><span class="hs-identifier">sec</span></a></a><span> </span><a name="local-6989586621684958566"><a href="#local-6989586621684958566"><span class="hs-identifier">statics</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-972"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><a href="#local-6989586621684958565"><span class="hs-identifier hs-var">sec</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">shortcutStatics</span><span> </span><a href="#local-6989586621684958563"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684958567"><a href="#local-6989586621684958567"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684958567"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621684958564"><span class="hs-identifier hs-var">ufm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958566"><span class="hs-identifier hs-var">statics</span></a><span class="hs-special">)</span><span>
</span><a name="line-973"></a><span class="hs-identifier">apply_mapping</span><span> </span><a name="local-6989586621684958568"><a href="#local-6989586621684958568"><span class="hs-identifier">ncgImpl</span></a></a><span> </span><a name="local-6989586621684958569"><a href="#local-6989586621684958569"><span class="hs-identifier">ufm</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684958570"><a href="#local-6989586621684958570"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684958571"><a href="#local-6989586621684958571"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684958572"><a href="#local-6989586621684958572"><span class="hs-identifier">live</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><a name="local-6989586621684958573"><a href="#local-6989586621684958573"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684958570"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684958571"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684958572"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#ListGraph"><span class="hs-identifier hs-var">ListGraph</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684958574"><span class="hs-identifier hs-var">short_bb</span></a><span> </span><a href="#local-6989586621684958573"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-975"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-976"></a><span>    </span><a name="local-6989586621684958574"><a href="#local-6989586621684958574"><span class="hs-identifier">short_bb</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a name="local-6989586621684958576"><a href="#local-6989586621684958576"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684958577"><a href="#local-6989586621684958577"><span class="hs-identifier">insns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#BasicBlock"><span class="hs-identifier hs-var">BasicBlock</span></a><span> </span><a href="#local-6989586621684958576"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684958575"><span class="hs-identifier hs-var">short_insn</span></a><span> </span><a href="#local-6989586621684958577"><span class="hs-identifier hs-var">insns</span></a><span>
</span><a name="line-977"></a><span>    </span><a name="local-6989586621684958575"><a href="#local-6989586621684958575"><span class="hs-identifier">short_insn</span></a></a><span> </span><a name="local-6989586621684958578"><a href="#local-6989586621684958578"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">shortcutJump</span><span> </span><a href="#local-6989586621684958568"><span class="hs-identifier hs-var">ncgImpl</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684958579"><a href="#local-6989586621684958579"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621684958579"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621684958569"><span class="hs-identifier hs-var">ufm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958578"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-978"></a><span>                 </span><span class="hs-comment">-- shortcutJump should apply the mapping repeatedly,</span><span>
</span><a name="line-979"></a><span>                 </span><span class="hs-comment">-- just in case we can short multiple branches.</span><span>
</span><a name="line-980"></a><span>
</span><a name="line-981"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-982"></a><span class="hs-comment">-- Instruction selection</span><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span class="hs-comment">-- Native code instruction selection for a chunk of stix code.  For</span><span>
</span><a name="line-985"></a><span class="hs-comment">-- this part of the computation, we switch from the UniqSM monad to</span><span>
</span><a name="line-986"></a><span class="hs-comment">-- the NatM monad.  The latter carries not only a Unique, but also an</span><span>
</span><a name="line-987"></a><span class="hs-comment">-- Int denoting the current C stack pointer offset in the generated</span><span>
</span><a name="line-988"></a><span class="hs-comment">-- code; this is needed for creating correct spill offsets on</span><span>
</span><a name="line-989"></a><span class="hs-comment">-- architectures which don't offer, or for which it would be</span><span>
</span><a name="line-990"></a><span class="hs-comment">-- prohibitively expensive to employ, a frame pointer register.  Viz,</span><span>
</span><a name="line-991"></a><span class="hs-comment">-- x86.</span><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><span class="hs-comment">-- The offset is measured in bytes, and indicates the difference</span><span>
</span><a name="line-994"></a><span class="hs-comment">-- between the current (simulated) C stack-ptr and the value it was at</span><span>
</span><a name="line-995"></a><span class="hs-comment">-- the beginning of the block.  For stacks which grow down, this value</span><span>
</span><a name="line-996"></a><span class="hs-comment">-- should be either zero or negative.</span><span>
</span><a name="line-997"></a><span>
</span><a name="line-998"></a><span class="hs-comment">-- Along with the stack pointer offset, we also carry along a LabelMap of</span><span>
</span><a name="line-999"></a><span class="hs-comment">-- DebugBlocks, which we read to generate .location directives.</span><span>
</span><a name="line-1000"></a><span class="hs-comment">--</span><span>
</span><a name="line-1001"></a><span class="hs-comment">-- Switching between the two monads whilst carrying along the same</span><span>
</span><a name="line-1002"></a><span class="hs-comment">-- Unique supply breaks abstraction.  Is that bad?</span><span>
</span><a name="line-1003"></a><span>
</span><a name="line-1004"></a><span class="hs-identifier">genMachCode</span><span>
</span><a name="line-1005"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-1006"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModLocation</span><span>
</span><a name="line-1007"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#NatM"><span class="hs-identifier hs-type">NatM</span></a><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958249"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958250"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1008"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NCGMonad.html#DwarfFiles"><span class="hs-identifier hs-type">DwarfFiles</span></a><span>
</span><a name="line-1009"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Debug.html#DebugBlock"><span class="hs-identifier hs-type">DebugBlock</span></a><span>
</span><a name="line-1010"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span>
</span><a name="line-1011"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-1012"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UniqSM</span><span>
</span><a name="line-1013"></a><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="Instruction.html#NatCmmDecl"><span class="hs-identifier hs-type">NatCmmDecl</span></a><span> </span><a href="#local-6989586621684958249"><span class="hs-identifier hs-type">statics</span></a><span> </span><a href="#local-6989586621684958250"><span class="hs-identifier hs-type">instr</span></a><span class="hs-special">]</span><span>
</span><a name="line-1014"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span>
</span><a name="line-1015"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="NCGMonad.html#DwarfFiles"><span class="hs-identifier hs-type">DwarfFiles</span></a><span>
</span><a name="line-1016"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="CFG.html#CFG"><span class="hs-identifier hs-type">CFG</span></a><span>
</span><a name="line-1017"></a><span>                </span><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><a name="genMachCode"><a href="AsmCodeGen.html#genMachCode"><span class="hs-identifier">genMachCode</span></a></a><span> </span><a name="local-6989586621684958580"><a href="#local-6989586621684958580"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958581"><a href="#local-6989586621684958581"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684958582"><a href="#local-6989586621684958582"><span class="hs-identifier">modLoc</span></a></a><span> </span><a name="local-6989586621684958583"><a href="#local-6989586621684958583"><span class="hs-identifier">cmmTopCodeGen</span></a></a><span> </span><a name="local-6989586621684958584"><a href="#local-6989586621684958584"><span class="hs-identifier">fileIds</span></a></a><span> </span><a name="local-6989586621684958585"><a href="#local-6989586621684958585"><span class="hs-identifier">dbgMap</span></a></a><span> </span><a name="local-6989586621684958586"><a href="#local-6989586621684958586"><span class="hs-identifier">cmm_top</span></a></a><span> </span><a name="local-6989586621684958587"><a href="#local-6989586621684958587"><span class="hs-identifier">cmm_cfg</span></a></a><span>
</span><a name="line-1020"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684958588"><a href="#local-6989586621684958588"><span class="hs-identifier">initial_us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-1021"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958589"><a href="#local-6989586621684958589"><span class="hs-identifier">initial_st</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="NCGMonad.html#mkNatM_State"><span class="hs-identifier hs-var">mkNatM_State</span></a><span> </span><a href="#local-6989586621684958588"><span class="hs-identifier hs-var">initial_us</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684958580"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958581"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-1022"></a><span>                                                  </span><a href="#local-6989586621684958582"><span class="hs-identifier hs-var">modLoc</span></a><span> </span><a href="#local-6989586621684958584"><span class="hs-identifier hs-var">fileIds</span></a><span> </span><a href="#local-6989586621684958585"><span class="hs-identifier hs-var">dbgMap</span></a><span> </span><a href="#local-6989586621684958587"><span class="hs-identifier hs-var">cmm_cfg</span></a><span>
</span><a name="line-1023"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621684958590"><a href="#local-6989586621684958590"><span class="hs-identifier">new_tops</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958591"><a href="#local-6989586621684958591"><span class="hs-identifier">final_st</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="NCGMonad.html#initNat"><span class="hs-identifier hs-var">initNat</span></a><span> </span><a href="#local-6989586621684958589"><span class="hs-identifier hs-var">initial_st</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958583"><span class="hs-identifier hs-var">cmmTopCodeGen</span></a><span> </span><a href="#local-6989586621684958586"><span class="hs-identifier hs-var">cmm_top</span></a><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>              </span><a name="local-6989586621684958592"><a href="#local-6989586621684958592"><span class="hs-identifier">final_delta</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">natm_delta</span><span> </span><a href="#local-6989586621684958591"><span class="hs-identifier hs-var">final_st</span></a><span>
</span><a name="line-1025"></a><span>              </span><a name="local-6989586621684958593"><a href="#local-6989586621684958593"><span class="hs-identifier">final_imports</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">natm_imports</span><span> </span><a href="#local-6989586621684958591"><span class="hs-identifier hs-var">final_st</span></a><span>
</span><a name="line-1026"></a><span>              </span><a name="local-6989586621684958594"><a href="#local-6989586621684958594"><span class="hs-identifier">final_cfg</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">natm_cfg</span><span> </span><a href="#local-6989586621684958591"><span class="hs-identifier hs-var">final_st</span></a><span>
</span><a name="line-1027"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span>   </span><a href="#local-6989586621684958592"><span class="hs-identifier hs-var">final_delta</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1028"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958590"><span class="hs-identifier hs-var">new_tops</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958593"><span class="hs-identifier hs-var">final_imports</span></a><span>
</span><a name="line-1029"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">natm_fileid</span><span> </span><a href="#local-6989586621684958591"><span class="hs-identifier hs-var">final_st</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958594"><span class="hs-identifier hs-var">final_cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1030"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;genMachCode: nonzero final delta&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621684958592"><span class="hs-identifier hs-var">final_delta</span></a><span class="hs-special">)</span><span>
</span><a name="line-1031"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1032"></a><span>
</span><a name="line-1033"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1034"></a><span class="hs-comment">-- Generic Cmm optimiser</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span class="hs-comment">{-
Here we do:

  (a) Constant folding
  (c) Position independent code and dynamic linking
        (i)  introduce the appropriate indirections
             and position independent refs
        (ii) compile a list of imported symbols
  (d) Some arch-specific optimizations

(a) will be moving to the new Hoopl pipeline, however, (c) and
(d) are only needed by the native backend and will continue to live
here.

Ideas for other things we could do (put these in Hoopl please!):

  - shortcut jumps-to-jumps
  - simple CSE: if an expr is assigned to a temp, then replace later occs of
    that expr with the temp, until the expr is no longer valid (can push through
    temp assignments, and certain assigns to mem...)
-}</span><span>
</span><a name="line-1057"></a><span>
</span><a name="line-1058"></a><span class="hs-identifier">cmmToCmm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#RawCmmDecl"><span class="hs-identifier hs-type">RawCmmDecl</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1059"></a><a name="cmmToCmm"><a href="AsmCodeGen.html#cmmToCmm"><span class="hs-identifier">cmmToCmm</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958595"><a href="#local-6989586621684958595"><span class="hs-identifier">top</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958595"><span class="hs-identifier hs-var">top</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1060"></a><span class="hs-identifier">cmmToCmm</span><span> </span><a name="local-6989586621684958596"><a href="#local-6989586621684958596"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958597"><a href="#local-6989586621684958597"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621684958598"><a href="#local-6989586621684958598"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621684958599"><a href="#local-6989586621684958599"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684958600"><a href="#local-6989586621684958600"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621684958601"><a href="#local-6989586621684958601"><span class="hs-identifier">graph</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1061"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#runCmmOpt"><span class="hs-identifier hs-var">runCmmOpt</span></a><span> </span><a href="#local-6989586621684958596"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958597"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1062"></a><span>      </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958602"><a href="#local-6989586621684958602"><span class="hs-identifier">blocks'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="AsmCodeGen.html#cmmBlockConFold"><span class="hs-identifier hs-var">cmmBlockConFold</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#toBlockList"><span class="hs-identifier hs-var">toBlockList</span></a><span> </span><a href="#local-6989586621684958601"><span class="hs-identifier hs-var">graph</span></a><span class="hs-special">)</span><span>
</span><a name="line-1063"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621684958598"><span class="hs-identifier hs-var">info</span></a><span> </span><a href="#local-6989586621684958599"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621684958600"><span class="hs-identifier hs-var">live</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#ofBlockList"><span class="hs-identifier hs-var">ofBlockList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621684958601"><span class="hs-identifier hs-var">graph</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958602"><span class="hs-identifier hs-var">blocks'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1064"></a><span>
</span><a name="line-1065"></a><span class="hs-keyword">newtype</span><span> </span><a name="CmmOptM"><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier">CmmOptM</span></a></a><span> </span><a name="local-6989586621684958229"><a href="#local-6989586621684958229"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CmmOptM"><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier">CmmOptM</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621684958229"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">#)</span><span class="hs-special">)</span><span>
</span><a name="line-1066"></a><span>
</span><a name="line-1067"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1068"></a><span>    </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span>
</span><a name="line-1069"></a><span>
</span><a name="line-1070"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1071"></a><span>    </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621684958244"><a href="#local-6989586621684958244"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-var">CmmOptM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958245"><a href="#local-6989586621684958245"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621684958244"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958245"><span class="hs-identifier hs-var">imports</span></a><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-1072"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-1073"></a><span>
</span><a name="line-1074"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1075"></a><span>  </span><span class="hs-special">(</span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-var">CmmOptM</span></a><span> </span><a name="local-6989586621684958236"><a href="#local-6989586621684958236"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621684958237"><a href="#local-6989586621684958237"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1076"></a><span>    </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-var">CmmOptM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684958238"><a href="#local-6989586621684958238"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958239"><a href="#local-6989586621684958239"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684958240"><a href="#local-6989586621684958240"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1077"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958236"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621684958238"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958239"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958240"><span class="hs-identifier hs-var">imports</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1078"></a><span>                  </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621684958241"><a href="#local-6989586621684958241"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958242"><a href="#local-6989586621684958242"><span class="hs-identifier">imports'</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1079"></a><span>                    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958237"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621684958241"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1080"></a><span>                      </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-var">CmmOptM</span></a><span> </span><a name="local-6989586621684958243"><a href="#local-6989586621684958243"><span class="hs-identifier">g'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684958243"><span class="hs-identifier hs-var">g'</span></a><span> </span><a href="#local-6989586621684958238"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958239"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621684958242"><span class="hs-identifier hs-var">imports'</span></a><span>
</span><a name="line-1081"></a><span>
</span><a name="line-1082"></a><span class="hs-keyword">instance</span><span> </span><a href="PIC.html#CmmMakeDynamicReferenceM"><span class="hs-identifier hs-type">CmmMakeDynamicReferenceM</span></a><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1083"></a><span>    </span><a name="local-8214565720329417839"><a href="PIC.html#addImport"><span class="hs-identifier">addImport</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#addImportCmmOpt"><span class="hs-identifier hs-var">addImportCmmOpt</span></a><span>
</span><a name="line-1084"></a><span>    </span><a name="local-8214565720329417840"><a href="PIC.html#getThisModule"><span class="hs-identifier">getThisModule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-var">CmmOptM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958234"><a href="#local-6989586621684958234"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684958235"><a href="#local-6989586621684958235"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621684958234"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958235"><span class="hs-identifier hs-var">imports</span></a><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-1085"></a><span>
</span><a name="line-1086"></a><span class="hs-identifier">addImportCmmOpt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><a name="addImportCmmOpt"><a href="AsmCodeGen.html#addImportCmmOpt"><span class="hs-identifier">addImportCmmOpt</span></a></a><span> </span><a name="local-6989586621684958603"><a href="#local-6989586621684958603"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-var">CmmOptM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958604"><a href="#local-6989586621684958604"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958603"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684958604"><span class="hs-identifier hs-var">imports</span></a><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-1088"></a><span>
</span><a name="line-1089"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasDynFlags</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1090"></a><span>    </span><a name="local-8214565720323804398"><span class="hs-identifier">getDynFlags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-var">CmmOptM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684958232"><a href="#local-6989586621684958232"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958233"><a href="#local-6989586621684958233"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621684958232"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958233"><span class="hs-identifier hs-var">imports</span></a><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-1091"></a><span>
</span><a name="line-1092"></a><span class="hs-identifier">runCmmOpt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><a href="#local-6989586621684958248"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958248"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1093"></a><a name="runCmmOpt"><a href="AsmCodeGen.html#runCmmOpt"><span class="hs-identifier">runCmmOpt</span></a></a><span> </span><a name="local-6989586621684958605"><a href="#local-6989586621684958605"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684958606"><a href="#local-6989586621684958606"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-var">CmmOptM</span></a><span> </span><a name="local-6989586621684958607"><a href="#local-6989586621684958607"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958607"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621684958605"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958606"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1094"></a><span>                        </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621684958608"><a href="#local-6989586621684958608"><span class="hs-identifier">result</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958609"><a href="#local-6989586621684958609"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684958608"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684958609"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span>
</span><a name="line-1095"></a><span>
</span><a name="line-1096"></a><span class="hs-identifier">cmmBlockConFold</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span>
</span><a name="line-1097"></a><a name="cmmBlockConFold"><a href="AsmCodeGen.html#cmmBlockConFold"><span class="hs-identifier">cmmBlockConFold</span></a></a><span> </span><a name="local-6989586621684958610"><a href="#local-6989586621684958610"><span class="hs-identifier">block</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1098"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684958611"><a href="#local-6989586621684958611"><span class="hs-identifier">entry</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958612"><a href="#local-6989586621684958612"><span class="hs-identifier">middle</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684958613"><a href="#local-6989586621684958613"><span class="hs-identifier">last</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockSplit"><span class="hs-identifier hs-var">blockSplit</span></a><span> </span><a href="#local-6989586621684958610"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-1099"></a><span>      </span><a name="local-6989586621684958614"><a href="#local-6989586621684958614"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockToList"><span class="hs-identifier hs-var">blockToList</span></a><span> </span><a href="#local-6989586621684958612"><span class="hs-identifier hs-var">middle</span></a><span>
</span><a name="line-1100"></a><span>  </span><a name="local-6989586621684958615"><a href="#local-6989586621684958615"><span class="hs-identifier">stmts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="AsmCodeGen.html#cmmStmtConFold"><span class="hs-identifier hs-var">cmmStmtConFold</span></a><span> </span><a href="#local-6989586621684958614"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-1101"></a><span>  </span><a name="local-6989586621684958616"><a href="#local-6989586621684958616"><span class="hs-identifier">last'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmStmtConFold"><span class="hs-identifier hs-var">cmmStmtConFold</span></a><span> </span><a href="#local-6989586621684958613"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-1102"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Block.html#blockJoin"><span class="hs-identifier hs-var">blockJoin</span></a><span> </span><a href="#local-6989586621684958611"><span class="hs-identifier hs-var">entry</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Block.html#blockFromList"><span class="hs-identifier hs-var">blockFromList</span></a><span> </span><a href="#local-6989586621684958615"><span class="hs-identifier hs-var">stmts'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958616"><span class="hs-identifier hs-var">last'</span></a><span>
</span><a name="line-1103"></a><span>
</span><a name="line-1104"></a><span class="hs-comment">-- This does three optimizations, but they're very quick to check, so we don't</span><span>
</span><a name="line-1105"></a><span class="hs-comment">-- bother turning them off even when the Hoopl code is active.  Since</span><span>
</span><a name="line-1106"></a><span class="hs-comment">-- this is on the old Cmm representation, we can't reuse the code either:</span><span>
</span><a name="line-1107"></a><span class="hs-comment">--  * reg = reg      --&gt; nop</span><span>
</span><a name="line-1108"></a><span class="hs-comment">--  * if 0 then jump --&gt; nop</span><span>
</span><a name="line-1109"></a><span class="hs-comment">--  * if 1 then jump --&gt; jump</span><span>
</span><a name="line-1110"></a><span class="hs-comment">-- We might be tempted to skip this step entirely of not Opt_PIC, but</span><span>
</span><a name="line-1111"></a><span class="hs-comment">-- there is some PowerPC code for the non-PIC case, which would also</span><span>
</span><a name="line-1112"></a><span class="hs-comment">-- have to be separated.</span><span>
</span><a name="line-1113"></a><span class="hs-identifier">cmmStmtConFold</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621684958246"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621684958247"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621684958246"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621684958247"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1114"></a><a name="cmmStmtConFold"><a href="AsmCodeGen.html#cmmStmtConFold"><span class="hs-identifier">cmmStmtConFold</span></a></a><span> </span><a name="local-6989586621684958617"><a href="#local-6989586621684958617"><span class="hs-identifier">stmt</span></a></a><span>
</span><a name="line-1115"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958617"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1116"></a><span>        </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a name="local-6989586621684958618"><a href="#local-6989586621684958618"><span class="hs-identifier">reg</span></a></a><span> </span><a name="local-6989586621684958619"><a href="#local-6989586621684958619"><span class="hs-identifier">src</span></a></a><span>
</span><a name="line-1117"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958620"><a href="#local-6989586621684958620"><span class="hs-identifier">src'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier hs-var">cmmExprConFold</span></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><a href="#local-6989586621684958619"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-1118"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958620"><span class="hs-identifier hs-var">src'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1119"></a><span>                   </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a name="local-6989586621684958621"><a href="#local-6989586621684958621"><span class="hs-identifier">reg'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684958618"><span class="hs-identifier hs-var">reg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684958621"><span class="hs-identifier hs-var">reg'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmComment"><span class="hs-identifier hs-var">CmmComment</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;nop&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1120"></a><span>                   </span><a name="local-6989586621684958622"><a href="#local-6989586621684958622"><span class="hs-identifier">new_src</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmAssign"><span class="hs-identifier hs-var">CmmAssign</span></a><span> </span><a href="#local-6989586621684958618"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="#local-6989586621684958622"><span class="hs-identifier hs-var">new_src</span></a><span>
</span><a name="line-1121"></a><span>
</span><a name="line-1122"></a><span>        </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a name="local-6989586621684958623"><a href="#local-6989586621684958623"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621684958624"><a href="#local-6989586621684958624"><span class="hs-identifier">src</span></a></a><span>
</span><a name="line-1123"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958625"><a href="#local-6989586621684958625"><span class="hs-identifier">addr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier hs-var">cmmExprConFold</span></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><a href="#local-6989586621684958623"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-1124"></a><span>                 </span><a name="local-6989586621684958626"><a href="#local-6989586621684958626"><span class="hs-identifier">src'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier hs-var">cmmExprConFold</span></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><a href="#local-6989586621684958624"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-1125"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#CmmStore"><span class="hs-identifier hs-var">CmmStore</span></a><span> </span><a href="#local-6989586621684958625"><span class="hs-identifier hs-var">addr'</span></a><span> </span><a href="#local-6989586621684958626"><span class="hs-identifier hs-var">src'</span></a><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span>        </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_target</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684958627"><a href="#local-6989586621684958627"><span class="hs-identifier">addr</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1128"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958628"><a href="#local-6989586621684958628"><span class="hs-identifier">addr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier hs-var">cmmExprConFold</span></a><span> </span><a href="PIC.html#JumpReference"><span class="hs-identifier hs-var">JumpReference</span></a><span> </span><a href="#local-6989586621684958627"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-1129"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684958617"><span class="hs-identifier hs-var">stmt</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_target</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958628"><span class="hs-identifier hs-var">addr'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1130"></a><span>
</span><a name="line-1131"></a><span>        </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a name="local-6989586621684958629"><a href="#local-6989586621684958629"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621684958630"><a href="#local-6989586621684958630"><span class="hs-identifier">regs</span></a></a><span> </span><a name="local-6989586621684958631"><a href="#local-6989586621684958631"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1132"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958635"><a href="#local-6989586621684958635"><span class="hs-identifier">target'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958629"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1133"></a><span>                              </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a name="local-6989586621684958632"><a href="#local-6989586621684958632"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684958633"><a href="#local-6989586621684958633"><span class="hs-identifier">conv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1134"></a><span>                                </span><a name="local-6989586621684958634"><a href="#local-6989586621684958634"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier hs-var">cmmExprConFold</span></a><span> </span><a href="PIC.html#CallReference"><span class="hs-identifier hs-var">CallReference</span></a><span> </span><a href="#local-6989586621684958632"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1135"></a><span>                                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#ForeignTarget"><span class="hs-identifier hs-var">ForeignTarget</span></a><span> </span><a href="#local-6989586621684958634"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-6989586621684958633"><span class="hs-identifier hs-var">conv</span></a><span>
</span><a name="line-1136"></a><span>                              </span><a href="CmmNode.html#PrimTarget"><span class="hs-identifier hs-var">PrimTarget</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1137"></a><span>                                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684958629"><span class="hs-identifier hs-var">target</span></a><span>
</span><a name="line-1138"></a><span>                 </span><a name="local-6989586621684958636"><a href="#local-6989586621684958636"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier hs-var">cmmExprConFold</span></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958631"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1139"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#CmmUnsafeForeignCall"><span class="hs-identifier hs-var">CmmUnsafeForeignCall</span></a><span> </span><a href="#local-6989586621684958635"><span class="hs-identifier hs-var">target'</span></a><span> </span><a href="#local-6989586621684958630"><span class="hs-identifier hs-var">regs</span></a><span> </span><a href="#local-6989586621684958636"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-1140"></a><span>
</span><a name="line-1141"></a><span>        </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621684958637"><a href="#local-6989586621684958637"><span class="hs-identifier">test</span></a></a><span> </span><a name="local-6989586621684958638"><a href="#local-6989586621684958638"><span class="hs-identifier">true</span></a></a><span> </span><a name="local-6989586621684958639"><a href="#local-6989586621684958639"><span class="hs-identifier">false</span></a></a><span> </span><a name="local-6989586621684958640"><a href="#local-6989586621684958640"><span class="hs-identifier">likely</span></a></a><span>
</span><a name="line-1142"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958641"><a href="#local-6989586621684958641"><span class="hs-identifier">test'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier hs-var">cmmExprConFold</span></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><a href="#local-6989586621684958637"><span class="hs-identifier hs-var">test</span></a><span>
</span><a name="line-1143"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958641"><span class="hs-identifier hs-var">test'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1144"></a><span>                   </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmInt"><span class="hs-identifier hs-var">CmmInt</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a href="#local-6989586621684958639"><span class="hs-identifier hs-var">false</span></a><span>
</span><a name="line-1145"></a><span>                   </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmInt"><span class="hs-identifier hs-var">CmmInt</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a href="#local-6989586621684958638"><span class="hs-identifier hs-var">true</span></a><span>
</span><a name="line-1146"></a><span>                   </span><a name="local-6989586621684958642"><a href="#local-6989586621684958642"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a href="#local-6989586621684958641"><span class="hs-identifier hs-var">test'</span></a><span> </span><a href="#local-6989586621684958638"><span class="hs-identifier hs-var">true</span></a><span> </span><a href="#local-6989586621684958639"><span class="hs-identifier hs-var">false</span></a><span> </span><a href="#local-6989586621684958640"><span class="hs-identifier hs-var">likely</span></a><span>
</span><a name="line-1147"></a><span>
</span><a name="line-1148"></a><span>        </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621684958643"><a href="#local-6989586621684958643"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684958644"><a href="#local-6989586621684958644"><span class="hs-identifier">ids</span></a></a><span>
</span><a name="line-1149"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958645"><a href="#local-6989586621684958645"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier hs-var">cmmExprConFold</span></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><a href="#local-6989586621684958643"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1150"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a href="#local-6989586621684958645"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621684958644"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-1151"></a><span>
</span><a name="line-1152"></a><span>        </span><a name="local-6989586621684958646"><a href="#local-6989586621684958646"><span class="hs-identifier">other</span></a></a><span>
</span><a name="line-1153"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684958646"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-1154"></a><span>
</span><a name="line-1155"></a><span class="hs-identifier">cmmExprConFold</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="PIC.html#ReferenceKind"><span class="hs-identifier hs-type">ReferenceKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-1156"></a><a name="cmmExprConFold"><a href="AsmCodeGen.html#cmmExprConFold"><span class="hs-identifier">cmmExprConFold</span></a></a><span> </span><a name="local-6989586621684958647"><a href="#local-6989586621684958647"><span class="hs-identifier">referenceKind</span></a></a><span> </span><a name="local-6989586621684958648"><a href="#local-6989586621684958648"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1157"></a><span>    </span><a name="local-6989586621684958649"><a href="#local-6989586621684958649"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span>    </span><span class="hs-comment">-- With -O1 and greater, the cmmSink pass does constant-folding, so</span><span>
</span><a name="line-1160"></a><span>    </span><span class="hs-comment">-- we don't need to do it again here.</span><span>
</span><a name="line-1161"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958650"><a href="#local-6989586621684958650"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">optLevel</span><span> </span><a href="#local-6989586621684958649"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1162"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621684958648"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1163"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><a href="AsmCodeGen.html#cmmExprCon"><span class="hs-identifier hs-var">cmmExprCon</span></a><span> </span><a href="#local-6989586621684958649"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958648"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1164"></a><span>
</span><a name="line-1165"></a><span>    </span><a href="AsmCodeGen.html#cmmExprNative"><span class="hs-identifier hs-var">cmmExprNative</span></a><span> </span><a href="#local-6989586621684958647"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><a href="#local-6989586621684958650"><span class="hs-identifier hs-var">expr'</span></a><span>
</span><a name="line-1166"></a><span>
</span><a name="line-1167"></a><span class="hs-identifier">cmmExprCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-1168"></a><a name="cmmExprCon"><a href="AsmCodeGen.html#cmmExprCon"><span class="hs-identifier">cmmExprCon</span></a></a><span> </span><a name="local-6989586621684958651"><a href="#local-6989586621684958651"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a name="local-6989586621684958652"><a href="#local-6989586621684958652"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621684958653"><a href="#local-6989586621684958653"><span class="hs-identifier">rep</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#cmmExprCon"><span class="hs-identifier hs-var">cmmExprCon</span></a><span> </span><a href="#local-6989586621684958651"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958652"><span class="hs-identifier hs-var">addr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958653"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-1169"></a><span class="hs-identifier">cmmExprCon</span><span> </span><a name="local-6989586621684958654"><a href="#local-6989586621684958654"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><a name="local-6989586621684958655"><a href="#local-6989586621684958655"><span class="hs-identifier">mop</span></a></a><span> </span><a name="local-6989586621684958656"><a href="#local-6989586621684958656"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1170"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CmmOpt.html#cmmMachOpFold"><span class="hs-identifier hs-var">cmmMachOpFold</span></a><span> </span><a href="#local-6989586621684958654"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958655"><span class="hs-identifier hs-var">mop</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#cmmExprCon"><span class="hs-identifier hs-var">cmmExprCon</span></a><span> </span><a href="#local-6989586621684958654"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958656"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1171"></a><span class="hs-identifier">cmmExprCon</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684958657"><a href="#local-6989586621684958657"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684958657"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-1172"></a><span>
</span><a name="line-1173"></a><span class="hs-comment">-- handles both PIC and non-PIC cases... a very strange mixture</span><span>
</span><a name="line-1174"></a><span class="hs-comment">-- of things to do.</span><span>
</span><a name="line-1175"></a><span class="hs-identifier">cmmExprNative</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="PIC.html#ReferenceKind"><span class="hs-identifier hs-type">ReferenceKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#CmmOptM"><span class="hs-identifier hs-type">CmmOptM</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-1176"></a><a name="cmmExprNative"><a href="AsmCodeGen.html#cmmExprNative"><span class="hs-identifier">cmmExprNative</span></a></a><span> </span><a name="local-6989586621684958658"><a href="#local-6989586621684958658"><span class="hs-identifier">referenceKind</span></a></a><span> </span><a name="local-6989586621684958659"><a href="#local-6989586621684958659"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1177"></a><span>     </span><a name="local-6989586621684958660"><a href="#local-6989586621684958660"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1178"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684958661"><a href="#local-6989586621684958661"><span class="hs-identifier">platform</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1179"></a><span>         </span><a name="local-6989586621684958662"><a href="#local-6989586621684958662"><span class="hs-identifier">arch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">platformArch</span><span> </span><a href="#local-6989586621684958661"><span class="hs-identifier hs-var">platform</span></a><span>
</span><a name="line-1180"></a><span>     </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684958659"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1181"></a><span>        </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a name="local-6989586621684958663"><a href="#local-6989586621684958663"><span class="hs-identifier">addr</span></a></a><span> </span><a name="local-6989586621684958664"><a href="#local-6989586621684958664"><span class="hs-identifier">rep</span></a></a><span>
</span><a name="line-1182"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958665"><a href="#local-6989586621684958665"><span class="hs-identifier">addr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="AsmCodeGen.html#cmmExprNative"><span class="hs-identifier hs-var">cmmExprNative</span></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span> </span><a href="#local-6989586621684958663"><span class="hs-identifier hs-var">addr</span></a><span>
</span><a name="line-1183"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmLoad"><span class="hs-identifier hs-var">CmmLoad</span></a><span> </span><a href="#local-6989586621684958665"><span class="hs-identifier hs-var">addr'</span></a><span> </span><a href="#local-6989586621684958664"><span class="hs-identifier hs-var">rep</span></a><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span>        </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><a name="local-6989586621684958666"><a href="#local-6989586621684958666"><span class="hs-identifier">mop</span></a></a><span> </span><a name="local-6989586621684958667"><a href="#local-6989586621684958667"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1186"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684958668"><a href="#local-6989586621684958668"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="AsmCodeGen.html#cmmExprNative"><span class="hs-identifier hs-var">cmmExprNative</span></a><span> </span><a href="PIC.html#DataReference"><span class="hs-identifier hs-var">DataReference</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684958667"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1187"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><a href="#local-6989586621684958666"><span class="hs-identifier hs-var">mop</span></a><span> </span><a href="#local-6989586621684958668"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-1188"></a><span>
</span><a name="line-1189"></a><span>        </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmBlock"><span class="hs-identifier hs-var">CmmBlock</span></a><span> </span><a name="local-6989586621684958669"><a href="#local-6989586621684958669"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1190"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#cmmExprNative"><span class="hs-identifier hs-var">cmmExprNative</span></a><span> </span><a href="#local-6989586621684958658"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-special">(</span><a href="BlockId.html#infoTblLbl"><span class="hs-identifier hs-var">infoTblLbl</span></a><span> </span><a href="#local-6989586621684958669"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1191"></a><span>           </span><span class="hs-comment">-- we must convert block Ids to CLabels here, because we</span><span>
</span><a name="line-1192"></a><span>           </span><span class="hs-comment">-- might have to do the PIC transformation.  Hence we must</span><span>
</span><a name="line-1193"></a><span>           </span><span class="hs-comment">-- not modify BlockIds beyond this point.</span><span>
</span><a name="line-1194"></a><span>
</span><a name="line-1195"></a><span>        </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a name="local-6989586621684958670"><a href="#local-6989586621684958670"><span class="hs-identifier">lbl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1196"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1197"></a><span>                </span><a href="PIC.html#cmmMakeDynamicReference"><span class="hs-identifier hs-var">cmmMakeDynamicReference</span></a><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958658"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><a href="#local-6989586621684958670"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-1198"></a><span>        </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabelOff"><span class="hs-identifier hs-var">CmmLabelOff</span></a><span> </span><a name="local-6989586621684958671"><a href="#local-6989586621684958671"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621684958672"><a href="#local-6989586621684958672"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1199"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1200"></a><span>                 </span><a name="local-6989586621684958673"><a href="#local-6989586621684958673"><span class="hs-identifier">dynRef</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="PIC.html#cmmMakeDynamicReference"><span class="hs-identifier hs-var">cmmMakeDynamicReference</span></a><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684958658"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><a href="#local-6989586621684958671"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-1201"></a><span>                 </span><span class="hs-comment">-- need to optimize here, since it's late</span><span>
</span><a name="line-1202"></a><span>                 </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmOpt.html#cmmMachOpFold"><span class="hs-identifier hs-var">cmmMachOpFold</span></a><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Add"><span class="hs-identifier hs-var">MO_Add</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-1203"></a><span>                     </span><a href="#local-6989586621684958673"><span class="hs-identifier hs-var">dynRef</span></a><span class="hs-special">,</span><span>
</span><a name="line-1204"></a><span>                     </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmExpr.html#CmmInt"><span class="hs-identifier hs-var">CmmInt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621684958672"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1205"></a><span>                   </span><span class="hs-special">]</span><span>
</span><a name="line-1206"></a><span>
</span><a name="line-1207"></a><span>        </span><span class="hs-comment">-- On powerpc (non-PIC), it's easier to jump directly to a label than</span><span>
</span><a name="line-1208"></a><span>        </span><span class="hs-comment">-- to use the register table, so we replace these registers</span><span>
</span><a name="line-1209"></a><span>        </span><span class="hs-comment">-- with the corresponding labels:</span><span>
</span><a name="line-1210"></a><span>        </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#EagerBlackholeInfo"><span class="hs-identifier hs-var">EagerBlackholeInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-1211"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684958662"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchPPC</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1212"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#cmmExprNative"><span class="hs-identifier hs-var">cmmExprNative</span></a><span> </span><a href="#local-6989586621684958658"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1213"></a><span>             </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmCodeLabel"><span class="hs-identifier hs-var">mkCmmCodeLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;__stg_EAGER_BLACKHOLE_info&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1214"></a><span>        </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#GCEnter1"><span class="hs-identifier hs-var">GCEnter1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684958662"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchPPC</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1216"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#cmmExprNative"><span class="hs-identifier hs-var">cmmExprNative</span></a><span> </span><a href="#local-6989586621684958658"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1217"></a><span>             </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmCodeLabel"><span class="hs-identifier hs-var">mkCmmCodeLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;__stg_gc_enter_1&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1218"></a><span>        </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#GCFun"><span class="hs-identifier hs-var">GCFun</span></a><span class="hs-special">)</span><span>
</span><a name="line-1219"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684958662"><span class="hs-identifier hs-var">arch</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ArchPPC</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">positionIndependent</span><span> </span><a href="#local-6989586621684958660"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1220"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="AsmCodeGen.html#cmmExprNative"><span class="hs-identifier hs-var">cmmExprNative</span></a><span> </span><a href="#local-6989586621684958658"><span class="hs-identifier hs-var">referenceKind</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1221"></a><span>             </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmCodeLabel"><span class="hs-identifier hs-var">mkCmmCodeLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;__stg_gc_fun&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span>
</span><a name="line-1223"></a><span>        </span><a name="local-6989586621684958674"><a href="#local-6989586621684958674"><span class="hs-identifier">other</span></a></a><span>
</span><a name="line-1224"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684958674"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-1225"></a></pre></body></html>