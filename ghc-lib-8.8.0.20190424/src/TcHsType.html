<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[TcMonoType]{Typechecking user-specified @MonoTypes@}
-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE CPP, TupleSections, MultiWayIf, RankNTypes #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcHsType</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>        </span><span class="hs-comment">-- Type signatures</span><span>
</span><a name="line-14"></a><span>        </span><a href="TcHsType.html#kcHsSigType"><span class="hs-identifier hs-var">kcHsSigType</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcClassSigType"><span class="hs-identifier hs-var">tcClassSigType</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="TcHsType.html#tcHsSigType"><span class="hs-identifier hs-var">tcHsSigType</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcHsSigWcType"><span class="hs-identifier hs-var">tcHsSigWcType</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="TcHsType.html#tcHsPartialSigType"><span class="hs-identifier hs-var">tcHsPartialSigType</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="TcHsType.html#funsSigCtxt"><span class="hs-identifier hs-var">funsSigCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#addSigCtxt"><span class="hs-identifier hs-var">addSigCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#pprSigCtxt"><span class="hs-identifier hs-var">pprSigCtxt</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>        </span><a href="TcHsType.html#tcHsClsInstType"><span class="hs-identifier hs-var">tcHsClsInstType</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="TcHsType.html#tcHsDeriv"><span class="hs-identifier hs-var">tcHsDeriv</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcDerivStrategy"><span class="hs-identifier hs-var">tcDerivStrategy</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="TcHsType.html#tcHsTypeApp"><span class="hs-identifier hs-var">tcHsTypeApp</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="TcHsType.html#bindImplicitTKBndrs_Tv"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Tv</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#bindImplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Skol</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>            </span><a href="TcHsType.html#bindImplicitTKBndrs_Q_Tv"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Q_Tv</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#bindImplicitTKBndrs_Q_Skol"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Q_Skol</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="TcHsType.html#bindExplicitTKBndrs_Tv"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Tv</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#bindExplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Skol</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>            </span><a href="TcHsType.html#bindExplicitTKBndrs_Q_Tv"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Q_Tv</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#bindExplicitTKBndrs_Q_Skol"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Q_Skol</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="TcHsType.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span>                </span><span class="hs-comment">-- Type checking type and class decls</span><span>
</span><a name="line-30"></a><span>        </span><a href="TcHsType.html#kcLookupTcTyCon"><span class="hs-identifier hs-var">kcLookupTcTyCon</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#bindTyClTyVars"><span class="hs-identifier hs-var">bindTyClTyVars</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="TcHsType.html#etaExpandAlgTyCon"><span class="hs-identifier hs-var">etaExpandAlgTyCon</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcbVisibilities"><span class="hs-identifier hs-var">tcbVisibilities</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span>          </span><span class="hs-comment">-- tyvars</span><span>
</span><a name="line-34"></a><span>        </span><a href="TcHsType.html#zonkAndScopedSort"><span class="hs-identifier hs-var">zonkAndScopedSort</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span>        </span><span class="hs-comment">-- Kind-checking types</span><span>
</span><a name="line-37"></a><span>        </span><span class="hs-comment">-- No kind generalisation, no checkValidType</span><span>
</span><a name="line-38"></a><span>        </span><a href="TcHsType.html#kcLHsQTyVars"><span class="hs-identifier hs-var">kcLHsQTyVars</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="TcHsType.html#tcWildCardBinders"><span class="hs-identifier hs-var">tcWildCardBinders</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="TcHsType.html#tcHsLiftedType"><span class="hs-identifier hs-var">tcHsLiftedType</span></a><span class="hs-special">,</span><span>   </span><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier hs-var">tcHsOpenType</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="TcHsType.html#tcHsLiftedTypeNC"><span class="hs-identifier hs-var">tcHsLiftedTypeNC</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcHsOpenTypeNC"><span class="hs-identifier hs-var">tcHsOpenTypeNC</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><a href="TcHsType.html#tcLHsType"><span class="hs-identifier hs-var">tcLHsType</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcLHsTypeUnsaturated"><span class="hs-identifier hs-var">tcLHsTypeUnsaturated</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcCheckLHsType"><span class="hs-identifier hs-var">tcCheckLHsType</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>        </span><a href="TcHsType.html#tcHsMbContext"><span class="hs-identifier hs-var">tcHsMbContext</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcLHsPredType"><span class="hs-identifier hs-var">tcLHsPredType</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcInferApps"><span class="hs-identifier hs-var">tcInferApps</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>        </span><a href="TcHsType.html#failIfEmitsConstraints"><span class="hs-identifier hs-var">failIfEmitsConstraints</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>        </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- useful re-export</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span>        </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#kindLevelMode"><span class="hs-identifier hs-var">kindLevelMode</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span>        </span><a href="TcHsType.html#kindGeneralize"><span class="hs-identifier hs-var">kindGeneralize</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#checkExpectedKind"><span class="hs-identifier hs-var">checkExpectedKind</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#RequireSaturation"><span class="hs-identifier hs-type">RequireSaturation</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>        </span><a href="TcHsType.html#reportFloatingKvs"><span class="hs-identifier hs-var">reportFloatingKvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span>        </span><span class="hs-comment">-- Sort-checking kinds</span><span>
</span><a name="line-53"></a><span>        </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#badKindSig"><span class="hs-identifier hs-var">badKindSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span>        </span><span class="hs-comment">-- Zonking and promoting</span><span>
</span><a name="line-56"></a><span>        </span><a href="TcHsType.html#zonkPromoteType"><span class="hs-identifier hs-var">zonkPromoteType</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>        </span><span class="hs-comment">-- Pattern type signatures</span><span>
</span><a name="line-59"></a><span>        </span><a href="TcHsType.html#tcHsPatSigType"><span class="hs-identifier hs-var">tcHsPatSigType</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#tcPatSig"><span class="hs-identifier hs-var">tcPatSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span>        </span><span class="hs-comment">-- Error messages</span><span>
</span><a name="line-62"></a><span>        </span><a href="TcHsType.html#funAppCtxt"><span class="hs-identifier hs-var">funAppCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcHsType.html#addTyConFlavCtxt"><span class="hs-identifier hs-var">addTyConFlavCtxt</span></a><span>
</span><a name="line-63"></a><span>   </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="TcValidity.html"><span class="hs-identifier">TcValidity</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="TcIface.html"><span class="hs-identifier">TcIface</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><a href="TcErrors.html"><span class="hs-identifier">TcErrors</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcErrors.html#reportAllUnsolved"><span class="hs-identifier hs-var">reportAllUnsolved</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="Inst.html#tcInstTyBinders"><span class="hs-identifier hs-var">tcInstTyBinders</span></a><span class="hs-special">,</span><span> </span><a href="Inst.html#tcInstTyBinder"><span class="hs-identifier hs-var">tcInstTyBinder</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCoRep</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">TyCoBinder</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyBinder</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tyCoBinderArgFlag</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Used in etaExpandAlgTyCon</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">lookupLocalRdrOcc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Constants</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mAX_CTUPLE_SIZE</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">wildCardName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Opt_WarnPartialTypeSignatures</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">{-
        ----------------------------
                General notes
        ----------------------------

Unlike with expressions, type-checking types both does some checking and
desugars at the same time. This is necessary because we often want to perform
equality checks on the types right away, and it would be incredibly painful
to do this on un-desugared types. Luckily, desugared types are close enough
to HsTypes to make the error messages sane.

During type-checking, we perform as little validity checking as possible.
Generally, after type-checking, you will want to do validity checking, say
with TcValidity.checkValidType.

Validity checking
~~~~~~~~~~~~~~~~~
Some of the validity check could in principle be done by the kind checker,
but not all:

- During desugaring, we normalise by expanding type synonyms.  Only
  after this step can we check things like type-synonym saturation
  e.g.  type T k = k Int
        type S a = a
  Then (T S) is ok, because T is saturated; (T S) expands to (S Int);
  and then S is saturated.  This is a GHC extension.

- Similarly, also a GHC extension, we look through synonyms before complaining
  about the form of a class or instance declaration

- Ambiguity checks involve functional dependencies

Also, in a mutually recursive group of types, we can't look at the TyCon until we've
finished building the loop.  So to keep things simple, we postpone most validity
checking until step (3).

%************************************************************************
%*                                                                      *
              Check types AND do validity checking
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-identifier">funsSigCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span>
</span><a name="line-159"></a><span class="hs-comment">-- Returns FunSigCtxt, with no redundant-context-reporting,</span><span>
</span><a name="line-160"></a><span class="hs-comment">-- form a list of located names</span><span>
</span><a name="line-161"></a><a name="funsSigCtxt"><a href="TcHsType.html#funsSigCtxt"><span class="hs-identifier">funsSigCtxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132497"><a href="#local-6989586621683132497"><span class="hs-identifier">name1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><a href="#local-6989586621683132497"><span class="hs-identifier hs-var">name1</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-162"></a><span class="hs-identifier">funsSigCtxt</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;funSigCtxt&quot;</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-identifier">addSigCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132496"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132496"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-165"></a><a name="addSigCtxt"><a href="TcHsType.html#addSigCtxt"><span class="hs-identifier">addSigCtxt</span></a></a><span> </span><a name="local-6989586621683132498"><a href="#local-6989586621683132498"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683132499"><a href="#local-6989586621683132499"><span class="hs-identifier">hs_ty</span></a></a><span> </span><a name="local-6989586621683132500"><a href="#local-6989586621683132500"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-166"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621683132499"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-167"></a><span>    </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#pprSigCtxt"><span class="hs-identifier hs-var">pprSigCtxt</span></a><span> </span><a href="#local-6989586621683132498"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683132499"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-168"></a><span>    </span><a href="#local-6989586621683132500"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-identifier">pprSigCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- (pprSigCtxt ctxt &lt;extra&gt; &lt;type&gt;)</span><span>
</span><a name="line-172"></a><span class="hs-comment">-- prints    In the type signature for 'f':</span><span>
</span><a name="line-173"></a><span class="hs-comment">--              f :: &lt;type&gt;</span><span>
</span><a name="line-174"></a><span class="hs-comment">-- The &lt;extra&gt; is either empty or &quot;the ambiguity check for&quot;</span><span>
</span><a name="line-175"></a><a name="pprSigCtxt"><a href="TcHsType.html#pprSigCtxt"><span class="hs-identifier">pprSigCtxt</span></a></a><span> </span><a name="local-6989586621683132501"><a href="#local-6989586621683132501"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683132502"><a href="#local-6989586621683132502"><span class="hs-identifier">hs_ty</span></a></a><span>
</span><a name="line-176"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683132503"><a href="#local-6989586621683132503"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isSigMaybe</span><span> </span><a href="#local-6989586621683132501"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-177"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the type signature:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprPrefixOcc</span><span> </span><a href="#local-6989586621683132503"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132502"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-181"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprUserTypeCtxt</span><span> </span><a href="#local-6989586621683132501"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132502"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">tcHsSigWcType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- This one is used when we have a LHsSigWcType, but in</span><span>
</span><a name="line-186"></a><span class="hs-comment">-- a place where wildcards aren't allowed. The renamer has</span><span>
</span><a name="line-187"></a><span class="hs-comment">-- already checked this, so we can simply ignore it.</span><span>
</span><a name="line-188"></a><a name="tcHsSigWcType"><a href="TcHsType.html#tcHsSigWcType"><span class="hs-identifier">tcHsSigWcType</span></a></a><span> </span><a name="local-6989586621683132504"><a href="#local-6989586621683132504"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683132505"><a href="#local-6989586621683132505"><span class="hs-identifier">sig_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tcHsSigType"><span class="hs-identifier hs-var">tcHsSigType</span></a><span> </span><a href="#local-6989586621683132504"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dropWildCards</span><span> </span><a href="#local-6989586621683132505"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-identifier">kcHsSigType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-191"></a><a name="kcHsSigType"><a href="TcHsType.html#kcHsSigType"><span class="hs-identifier">kcHsSigType</span></a></a><span> </span><a name="local-6989586621683132506"><a href="#local-6989586621683132506"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132507"><a href="#local-6989586621683132507"><span class="hs-identifier">hs_ty</span></a></a><span>
</span><a name="line-192"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132508"><a href="#local-6989586621683132508"><span class="hs-identifier">sig_vars</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addSigCtxt"><span class="hs-identifier hs-var">addSigCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#funsSigCtxt"><span class="hs-identifier hs-var">funsSigCtxt</span></a><span> </span><a href="#local-6989586621683132506"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132507"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-194"></a><span>    </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-195"></a><span>    </span><a href="TcHsType.html#bindImplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Skol</span></a><span> </span><a href="#local-6989586621683132508"><span class="hs-identifier hs-var">sig_vars</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-196"></a><span>    </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621683132507"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-identifier">kcHsSigType</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;kcHsSigType&quot;</span><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-identifier">tcClassSigType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SkolemInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- Does not do validity checking</span><span>
</span><a name="line-202"></a><a name="tcClassSigType"><a href="TcHsType.html#tcClassSigType"><span class="hs-identifier">tcClassSigType</span></a></a><span> </span><a name="local-6989586621683132509"><a href="#local-6989586621683132509"><span class="hs-identifier">skol_info</span></a></a><span> </span><a name="local-6989586621683132510"><a href="#local-6989586621683132510"><span class="hs-identifier">names</span></a></a><span> </span><a name="local-6989586621683132511"><a href="#local-6989586621683132511"><span class="hs-identifier">sig_ty</span></a></a><span>
</span><a name="line-203"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addSigCtxt"><span class="hs-identifier hs-var">addSigCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#funsSigCtxt"><span class="hs-identifier hs-var">funsSigCtxt</span></a><span> </span><a href="#local-6989586621683132510"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsSigType</span><span> </span><a href="#local-6989586621683132511"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-204"></a><span>    </span><a href="TcHsType.html#tc_hs_sig_type"><span class="hs-identifier hs-var">tc_hs_sig_type</span></a><span> </span><a href="#local-6989586621683132509"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621683132511"><span class="hs-identifier hs-var">sig_ty</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>       </span><span class="hs-comment">-- Do not zonk-to-Type, nor perform a validity check</span><span>
</span><a name="line-206"></a><span>       </span><span class="hs-comment">-- We are in a knot with the class and associated types</span><span>
</span><a name="line-207"></a><span>       </span><span class="hs-comment">-- Zonking and validity checking is done by tcClassDecl</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-identifier">tcHsSigType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-210"></a><span class="hs-comment">-- Does validity checking</span><span>
</span><a name="line-211"></a><span class="hs-comment">-- See Note [Recipe for checking a signature]</span><span>
</span><a name="line-212"></a><a name="tcHsSigType"><a href="TcHsType.html#tcHsSigType"><span class="hs-identifier">tcHsSigType</span></a></a><span> </span><a name="local-6989586621683132512"><a href="#local-6989586621683132512"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683132513"><a href="#local-6989586621683132513"><span class="hs-identifier">sig_ty</span></a></a><span>
</span><a name="line-213"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addSigCtxt"><span class="hs-identifier hs-var">addSigCtxt</span></a><span> </span><a href="#local-6989586621683132512"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsSigType</span><span> </span><a href="#local-6989586621683132513"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-214"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcHsSigType {&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132513"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>          </span><span class="hs-comment">-- Generalise here: see Note [Kind generalisation]</span><span>
</span><a name="line-217"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132515"><a href="#local-6989586621683132515"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_hs_sig_type"><span class="hs-identifier hs-var">tc_hs_sig_type</span></a><span> </span><a href="#local-6989586621683132514"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621683132513"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-218"></a><span>                                      </span><span class="hs-special">(</span><a href="TcHsType.html#expectedKindInCtxt"><span class="hs-identifier hs-var">expectedKindInCtxt</span></a><span> </span><a href="#local-6989586621683132512"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132516"><a href="#local-6989586621683132516"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683132515"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621683132512"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683132516"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-222"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;end tcHsSigType }&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132516"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683132516"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-224"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-225"></a><span>    </span><a name="local-6989586621683132514"><a href="#local-6989586621683132514"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SigTypeSkol</span><span> </span><a href="#local-6989586621683132512"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-identifier">tc_hs_sig_type</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SkolemInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-228"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- Kind-checks/desugars an 'LHsSigType',</span><span>
</span><a name="line-230"></a><span class="hs-comment">--   solve equalities,</span><span>
</span><a name="line-231"></a><span class="hs-comment">--   and then kind-generalizes.</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- This will never emit constraints, as it uses solveEqualities interally.</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- No validity checking or zonking</span><span>
</span><a name="line-234"></a><a name="tc_hs_sig_type"><a href="TcHsType.html#tc_hs_sig_type"><span class="hs-identifier">tc_hs_sig_type</span></a></a><span> </span><a name="local-6989586621683132517"><a href="#local-6989586621683132517"><span class="hs-identifier">skol_info</span></a></a><span> </span><a name="local-6989586621683132518"><a href="#local-6989586621683132518"><span class="hs-identifier">hs_sig_type</span></a></a><span> </span><a name="local-6989586621683132519"><a href="#local-6989586621683132519"><span class="hs-identifier">ctxt_kind</span></a></a><span>
</span><a name="line-235"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132520"><a href="#local-6989586621683132520"><span class="hs-identifier">sig_vars</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132521"><a href="#local-6989586621683132521"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132518"><span class="hs-identifier hs-var">hs_sig_type</span></a><span>
</span><a name="line-236"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132523"><a href="#local-6989586621683132523"><span class="hs-identifier">tc_lvl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132524"><a href="#local-6989586621683132524"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132525"><a href="#local-6989586621683132525"><span class="hs-identifier">spec_tkvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132526"><a href="#local-6989586621683132526"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushTcLevelM"><span class="hs-identifier hs-var">pushTcLevelM</span></a><span>                           </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-238"></a><span>                 </span><a href="TcSimplify.html#solveLocalEqualitiesX"><span class="hs-identifier hs-var">solveLocalEqualitiesX</span></a><span> </span><span class="hs-string">&quot;tc_hs_sig_type&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-239"></a><span>                 </span><a href="TcHsType.html#bindImplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Skol</span></a><span> </span><a href="#local-6989586621683132520"><span class="hs-identifier hs-var">sig_vars</span></a><span>      </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-240"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132522"><a href="#local-6989586621683132522"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#newExpectedKind"><span class="hs-identifier hs-var">newExpectedKind</span></a><span> </span><a href="#local-6989586621683132519"><span class="hs-identifier hs-var">ctxt_kind</span></a><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621683132521"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621683132522"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-243"></a><span>       </span><span class="hs-comment">-- Any remaining variables (unsolved in the solveLocalEqualities)</span><span>
</span><a name="line-244"></a><span>       </span><span class="hs-comment">-- should be in the global tyvars, and therefore won't be quantified</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132527"><a href="#local-6989586621683132527"><span class="hs-identifier">spec_tkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkAndScopedSort"><span class="hs-identifier hs-var">zonkAndScopedSort</span></a><span> </span><a href="#local-6989586621683132525"><span class="hs-identifier hs-var">spec_tkvs</span></a><span>
</span><a name="line-247"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132528"><a href="#local-6989586621683132528"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><a href="#local-6989586621683132527"><span class="hs-identifier hs-var">spec_tkvs</span></a><span> </span><a href="#local-6989586621683132526"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-248"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132529"><a href="#local-6989586621683132529"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kindGeneralizeLocal"><span class="hs-identifier hs-var">kindGeneralizeLocal</span></a><span> </span><a href="#local-6989586621683132524"><span class="hs-identifier hs-var">wanted</span></a><span> </span><a href="#local-6989586621683132528"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-249"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#emitResidualTvConstraint"><span class="hs-identifier hs-var">emitResidualTvConstraint</span></a><span> </span><a href="#local-6989586621683132517"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132529"><span class="hs-identifier hs-var">kvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683132527"><span class="hs-identifier hs-var">spec_tkvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>                                  </span><a href="#local-6989586621683132523"><span class="hs-identifier hs-var">tc_lvl</span></a><span> </span><a href="#local-6989586621683132524"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInvForAllTys</span><span> </span><a href="#local-6989586621683132529"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="#local-6989586621683132528"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span class="hs-identifier">tc_hs_sig_type</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_hs_sig_type_and_gen&quot;</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-identifier">tcTopLHsType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-257"></a><span class="hs-comment">-- tcTopLHsType is used for kind-checking top-level HsType where</span><span>
</span><a name="line-258"></a><span class="hs-comment">--   we want to fully solve /all/ equalities, and report errors</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- Does zonking, but not validity checking because it's used</span><span>
</span><a name="line-260"></a><span class="hs-comment">--   for things (like deriving and instances) that aren't</span><span>
</span><a name="line-261"></a><span class="hs-comment">--   ordinary types</span><span>
</span><a name="line-262"></a><a name="tcTopLHsType"><a href="TcHsType.html#tcTopLHsType"><span class="hs-identifier">tcTopLHsType</span></a></a><span> </span><a name="local-6989586621683132530"><a href="#local-6989586621683132530"><span class="hs-identifier">hs_sig_type</span></a></a><span> </span><a name="local-6989586621683132531"><a href="#local-6989586621683132531"><span class="hs-identifier">ctxt_kind</span></a></a><span>
</span><a name="line-263"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132532"><a href="#local-6989586621683132532"><span class="hs-identifier">sig_vars</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132533"><a href="#local-6989586621683132533"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132530"><span class="hs-identifier hs-var">hs_sig_type</span></a><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcTopLHsType {&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132533"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-265"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132535"><a href="#local-6989586621683132535"><span class="hs-identifier">spec_tkvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132536"><a href="#local-6989586621683132536"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushTcLevelM_"><span class="hs-identifier hs-var">pushTcLevelM_</span></a><span>                     </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-267"></a><span>                 </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span>                   </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-268"></a><span>                 </span><a href="TcHsType.html#bindImplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Skol</span></a><span> </span><a href="#local-6989586621683132532"><span class="hs-identifier hs-var">sig_vars</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-269"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132534"><a href="#local-6989586621683132534"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#newExpectedKind"><span class="hs-identifier hs-var">newExpectedKind</span></a><span> </span><a href="#local-6989586621683132531"><span class="hs-identifier hs-var">ctxt_kind</span></a><span>
</span><a name="line-270"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621683132533"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621683132534"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132537"><a href="#local-6989586621683132537"><span class="hs-identifier">spec_tkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkAndScopedSort"><span class="hs-identifier hs-var">zonkAndScopedSort</span></a><span> </span><a href="#local-6989586621683132535"><span class="hs-identifier hs-var">spec_tkvs</span></a><span>
</span><a name="line-273"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132538"><a href="#local-6989586621683132538"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><a href="#local-6989586621683132537"><span class="hs-identifier hs-var">spec_tkvs</span></a><span> </span><a href="#local-6989586621683132536"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-274"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132539"><a href="#local-6989586621683132539"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kindGeneralize"><span class="hs-identifier hs-var">kindGeneralize</span></a><span> </span><a href="#local-6989586621683132538"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-275"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132540"><a href="#local-6989586621683132540"><span class="hs-identifier">final_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToType"><span class="hs-identifier hs-var">zonkTcTypeToType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInvForAllTys</span><span> </span><a href="#local-6989586621683132539"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="#local-6989586621683132538"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;End tcTopLHsType }&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132533"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132540"><span class="hs-identifier hs-var">final_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-277"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683132540"><span class="hs-identifier hs-var">final_ty</span></a><span class="hs-special">}</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-identifier">tcTopLHsType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcTopLHsType&quot;</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-282"></a><span class="hs-identifier">tcHsDeriv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Class</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span class="hs-comment">-- Like tcHsSigType, but for the ...deriving( C t1 ty2 ) clause</span><span>
</span><a name="line-284"></a><span class="hs-comment">-- Returns the C, [ty1, ty2, and the kinds of C's remaining arguments</span><span>
</span><a name="line-285"></a><span class="hs-comment">-- E.g.    class C (a::*) (b::k-&gt;k)</span><span>
</span><a name="line-286"></a><span class="hs-comment">--         data T a b = ... deriving( C Int )</span><span>
</span><a name="line-287"></a><span class="hs-comment">--    returns ([k], C, [k, Int], [k-&gt;k])</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- Return values are fully zonked</span><span>
</span><a name="line-289"></a><a name="tcHsDeriv"><a href="TcHsType.html#tcHsDeriv"><span class="hs-identifier">tcHsDeriv</span></a></a><span> </span><a name="local-6989586621683132541"><a href="#local-6989586621683132541"><span class="hs-identifier">hs_ty</span></a></a><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132542"><a href="#local-6989586621683132542"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- Avoid redundant error report</span><span>
</span><a name="line-291"></a><span>                              </span><span class="hs-comment">-- with &quot;illegal deriving&quot;, below</span><span>
</span><a name="line-292"></a><span>               </span><a href="TcHsType.html#tcTopLHsType"><span class="hs-identifier hs-var">tcTopLHsType</span></a><span> </span><a href="#local-6989586621683132541"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-293"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132543"><a href="#local-6989586621683132543"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132544"><a href="#local-6989586621683132544"><span class="hs-identifier">pred</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitForAllTys</span><span> </span><a href="#local-6989586621683132542"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-294"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621683132545"><a href="#local-6989586621683132545"><span class="hs-identifier">kind_args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitFunTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621683132544"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">getClassPredTys_maybe</span><span> </span><a href="#local-6989586621683132544"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-296"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132546"><a href="#local-6989586621683132546"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132547"><a href="#local-6989586621683132547"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132543"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132546"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132547"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132545"><span class="hs-identifier hs-var">kind_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal deriving item&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132541"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-comment">-- | Typecheck something within the context of a deriving strategy.</span><span>
</span><a name="line-300"></a><span class="hs-comment">-- This is of particular importance when the deriving strategy is @via@.</span><span>
</span><a name="line-301"></a><span class="hs-comment">-- For instance:</span><span>
</span><a name="line-302"></a><span class="hs-comment">--</span><span>
</span><a name="line-303"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-304"></a><span class="hs-comment">-- deriving via (S a) instance C (T a)</span><span>
</span><a name="line-305"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-306"></a><span class="hs-comment">--</span><span>
</span><a name="line-307"></a><span class="hs-comment">-- We need to typecheck @S a@, and moreover, we need to extend the tyvar</span><span>
</span><a name="line-308"></a><span class="hs-comment">-- environment with @a@ before typechecking @C (T a)@, since @S a@ quantified</span><span>
</span><a name="line-309"></a><span class="hs-comment">-- the type variable @a@.</span><span>
</span><a name="line-310"></a><span class="hs-identifier">tcDerivStrategy</span><span>
</span><a name="line-311"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621683132495"><a href="#local-6989586621683132495"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-312"></a><span>     </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The deriving strategy</span><span>
</span><a name="line-313"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132495"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The thing to typecheck within the context of the</span><span>
</span><a name="line-314"></a><span>                      </span><span class="hs-comment">-- deriving strategy, which might quantify some type</span><span>
</span><a name="line-315"></a><span>                      </span><span class="hs-comment">-- variables of its own.</span><span>
</span><a name="line-316"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132495"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>     </span><span class="hs-comment">-- ^ The typechecked deriving strategy, all quantified tyvars, and</span><span>
</span><a name="line-318"></a><span>     </span><span class="hs-comment">-- the payload of the typechecked thing.</span><span>
</span><a name="line-319"></a><a name="tcDerivStrategy"><a href="TcHsType.html#tcDerivStrategy"><span class="hs-identifier">tcDerivStrategy</span></a></a><span> </span><a name="local-6989586621683132548"><a href="#local-6989586621683132548"><span class="hs-identifier">mds</span></a></a><span> </span><a name="local-6989586621683132549"><a href="#local-6989586621683132549"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-320"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132548"><span class="hs-identifier hs-var">mds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-321"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132551"><span class="hs-identifier hs-var">boring_case</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-322"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683132562"><a href="#local-6989586621683132562"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132563"><a href="#local-6989586621683132563"><span class="hs-identifier">ds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132564"><a href="#local-6989586621683132564"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132565"><a href="#local-6989586621683132565"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132550"><span class="hs-identifier hs-var">tc_deriv_strategy</span></a><span> </span><a href="#local-6989586621683132562"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-323"></a><span>                    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683132563"><span class="hs-identifier hs-var">ds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132564"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132565"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-325"></a><span>    </span><span class="hs-identifier">tc_deriv_strategy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-326"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132495"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>    </span><a name="local-6989586621683132550"><a href="#local-6989586621683132550"><span class="hs-identifier">tc_deriv_strategy</span></a></a><span> </span><span class="hs-identifier hs-var">StockStrategy</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132551"><span class="hs-identifier hs-var">boring_case</span></a><span> </span><span class="hs-identifier hs-var">StockStrategy</span><span>
</span><a name="line-328"></a><span>    </span><span class="hs-identifier">tc_deriv_strategy</span><span> </span><span class="hs-identifier hs-var">AnyclassStrategy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132551"><span class="hs-identifier hs-var">boring_case</span></a><span> </span><span class="hs-identifier hs-var">AnyclassStrategy</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-identifier">tc_deriv_strategy</span><span> </span><span class="hs-identifier hs-var">NewtypeStrategy</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132551"><span class="hs-identifier hs-var">boring_case</span></a><span> </span><span class="hs-identifier hs-var">NewtypeStrategy</span><span>
</span><a name="line-330"></a><span>    </span><span class="hs-identifier">tc_deriv_strategy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ViaStrategy</span><span> </span><a name="local-6989586621683132553"><a href="#local-6989586621683132553"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-331"></a><span>      </span><a name="local-6989586621683132554"><a href="#local-6989586621683132554"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-332"></a><span>             </span><a href="TcHsType.html#tcTopLHsType"><span class="hs-identifier hs-var">tcTopLHsType</span></a><span> </span><a href="#local-6989586621683132553"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-333"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132555"><a href="#local-6989586621683132555"><span class="hs-identifier">via_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132556"><a href="#local-6989586621683132556"><span class="hs-identifier">via_pred</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitForAllTys</span><span> </span><a href="#local-6989586621683132554"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-334"></a><span>      </span><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier hs-var">tcExtendTyVarEnv</span></a><span> </span><a href="#local-6989586621683132555"><span class="hs-identifier hs-var">via_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-335"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683132557"><a href="#local-6989586621683132557"><span class="hs-identifier">thing_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132558"><a href="#local-6989586621683132558"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132549"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-336"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ViaStrategy</span><span> </span><a href="#local-6989586621683132556"><span class="hs-identifier hs-var">via_pred</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132555"><span class="hs-identifier hs-var">via_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683132557"><span class="hs-identifier hs-var">thing_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132558"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>    </span><span class="hs-identifier">boring_case</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621683132552"><span class="hs-identifier hs-type">mds</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132552"><span class="hs-identifier hs-type">mds</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132495"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>    </span><a name="local-6989586621683132551"><a href="#local-6989586621683132551"><span class="hs-identifier">boring_case</span></a></a><span> </span><a name="local-6989586621683132559"><a href="#local-6989586621683132559"><span class="hs-identifier">mds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-340"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621683132560"><a href="#local-6989586621683132560"><span class="hs-identifier">thing_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132561"><a href="#local-6989586621683132561"><span class="hs-identifier">thing</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132549"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-341"></a><span>      </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132559"><span class="hs-identifier hs-var">mds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132560"><span class="hs-identifier hs-var">thing_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132561"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-identifier">tcHsClsInstType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span>    </span><span class="hs-comment">-- InstDeclCtxt or SpecInstCtxt</span><span>
</span><a name="line-344"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-345"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-346"></a><span class="hs-comment">-- Like tcHsSigType, but for a class instance declaration</span><span>
</span><a name="line-347"></a><a name="tcHsClsInstType"><a href="TcHsType.html#tcHsClsInstType"><span class="hs-identifier">tcHsClsInstType</span></a></a><span> </span><a name="local-6989586621683132566"><a href="#local-6989586621683132566"><span class="hs-identifier">user_ctxt</span></a></a><span> </span><a name="local-6989586621683132567"><a href="#local-6989586621683132567"><span class="hs-identifier">hs_inst_ty</span></a></a><span>
</span><a name="line-348"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsSigType</span><span> </span><a href="#local-6989586621683132567"><span class="hs-identifier hs-var">hs_inst_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-349"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Fail eagerly if tcTopLHsType fails.  We are at top level so</span><span>
</span><a name="line-350"></a><span>         </span><span class="hs-comment">-- these constraints will never be solved later. And failing</span><span>
</span><a name="line-351"></a><span>         </span><span class="hs-comment">-- eagerly avoids follow-on errors when checkValidInstance</span><span>
</span><a name="line-352"></a><span>         </span><span class="hs-comment">-- sees an unsolved coercion hole</span><span>
</span><a name="line-353"></a><span>         </span><a name="local-6989586621683132568"><a href="#local-6989586621683132568"><span class="hs-identifier">inst_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-354"></a><span>                    </span><a href="TcHsType.html#tcTopLHsType"><span class="hs-identifier hs-var">tcTopLHsType</span></a><span> </span><a href="#local-6989586621683132567"><span class="hs-identifier hs-var">hs_inst_ty</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><span class="hs-identifier hs-var">constraintKind</span><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidInstance"><span class="hs-identifier hs-var">checkValidInstance</span></a><span> </span><a href="#local-6989586621683132566"><span class="hs-identifier hs-var">user_ctxt</span></a><span> </span><a href="#local-6989586621683132567"><span class="hs-identifier hs-var">hs_inst_ty</span></a><span> </span><a href="#local-6989586621683132568"><span class="hs-identifier hs-var">inst_ty</span></a><span>
</span><a name="line-356"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683132568"><span class="hs-identifier hs-var">inst_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span class="hs-comment">----------------------------------------------</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- | Type-check a visible type application</span><span>
</span><a name="line-360"></a><span class="hs-identifier">tcHsTypeApp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- See Note [Recipe for checking a signature] in TcHsType</span><span>
</span><a name="line-362"></a><a name="tcHsTypeApp"><a href="TcHsType.html#tcHsTypeApp"><span class="hs-identifier">tcHsTypeApp</span></a></a><span> </span><a name="local-6989586621683132569"><a href="#local-6989586621683132569"><span class="hs-identifier">wc_ty</span></a></a><span> </span><a name="local-6989586621683132570"><a href="#local-6989586621683132570"><span class="hs-identifier">kind</span></a></a><span>
</span><a name="line-363"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hswc_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132571"><a href="#local-6989586621683132571"><span class="hs-identifier">sig_wcs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hswc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132572"><a href="#local-6989586621683132572"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132569"><span class="hs-identifier hs-var">wc_ty</span></a><span>
</span><a name="line-364"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132573"><a href="#local-6989586621683132573"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveLocalEqualities"><span class="hs-identifier hs-var">solveLocalEqualities</span></a><span> </span><span class="hs-string">&quot;tcHsTypeApp&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-365"></a><span>               </span><span class="hs-comment">-- We are looking at a user-written type, very like a</span><span>
</span><a name="line-366"></a><span>               </span><span class="hs-comment">-- signature so we want to solve its equalities right now</span><span>
</span><a name="line-367"></a><span>               </span><a href="TcRnMonad.html#unsetWOptM"><span class="hs-identifier hs-var">unsetWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnPartialTypeSignatures</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-368"></a><span>               </span><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier hs-var">setXOptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.PartialTypeSignatures</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-369"></a><span>               </span><span class="hs-comment">-- See Note [Wildcards in visible type application]</span><span>
</span><a name="line-370"></a><span>               </span><a href="TcHsType.html#tcWildCardBinders"><span class="hs-identifier hs-var">tcWildCardBinders</span></a><span> </span><a href="#local-6989586621683132571"><span class="hs-identifier hs-var">sig_wcs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-371"></a><span>               </span><a href="TcHsType.html#tcCheckLHsType"><span class="hs-identifier hs-var">tcCheckLHsType</span></a><span> </span><a href="#local-6989586621683132572"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621683132570"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-372"></a><span>       </span><span class="hs-comment">-- We must promote here. Ex:</span><span>
</span><a name="line-373"></a><span>       </span><span class="hs-comment">--   f :: forall a. a</span><span>
</span><a name="line-374"></a><span>       </span><span class="hs-comment">--   g = f @(forall b. Proxy b -&gt; ()) @Int ...</span><span>
</span><a name="line-375"></a><span>       </span><span class="hs-comment">-- After when processing the @Int, we'll have to check its kind</span><span>
</span><a name="line-376"></a><span>       </span><span class="hs-comment">-- against the as-yet-unknown kind of b. This check causes an assertion</span><span>
</span><a name="line-377"></a><span>       </span><span class="hs-comment">-- failure if we don't promote.</span><span>
</span><a name="line-378"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132574"><a href="#local-6989586621683132574"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkPromoteType"><span class="hs-identifier hs-var">zonkPromoteType</span></a><span> </span><a href="#local-6989586621683132573"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-379"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><span class="hs-identifier hs-var">TypeAppCtxt</span><span> </span><a href="#local-6989586621683132574"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-380"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683132574"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-381"></a><span class="hs-identifier">tcHsTypeApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsWildCardBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcHsTypeApp&quot;</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">{- Note [Wildcards in visible type application]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A HsWildCardBndrs's hswc_ext now only includes named wildcards, so any unnamed
wildcards stay unchanged in hswc_body and when called in tcHsTypeApp, tcCheckLHsType
will call emitWildCardHoleConstraints on them. However, this would trigger
error/warning when an unnamed wildcard is passed in as a visible type argument,
which we do not want because users should be able to write @_ to skip a instantiating
a type variable variable without fuss. The solution is to switch the
PartialTypeSignatures flags here to let the typechecker know that it's checking
a '@_' and do not emit hole constraints on it.
See related Note [Wildcards in visible kind application]
and Note [The wildcard story for types] in HsTypes.hs

-}</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
            The main kind checker: no validity checks here
*                                                                      *
************************************************************************

        First a couple of simple wrappers for kcHsType
-}</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-410"></a><span class="hs-identifier">tcHsOpenType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcHsLiftedType</span><span class="hs-special">,</span><span>
</span><a name="line-411"></a><span>  </span><span class="hs-identifier">tcHsOpenTypeNC</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcHsLiftedTypeNC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-412"></a><span class="hs-comment">-- Used for type signatures</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- Do not do validity checking</span><span>
</span><a name="line-414"></a><a name="tcHsOpenType"><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier">tcHsOpenType</span></a></a><span> </span><a name="local-6989586621683132575"><a href="#local-6989586621683132575"><span class="hs-identifier">ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addTypeCtxt"><span class="hs-identifier hs-var">addTypeCtxt</span></a><span> </span><a href="#local-6989586621683132575"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcHsType.html#tcHsOpenTypeNC"><span class="hs-identifier hs-var">tcHsOpenTypeNC</span></a><span> </span><a href="#local-6989586621683132575"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-415"></a><a name="tcHsLiftedType"><a href="TcHsType.html#tcHsLiftedType"><span class="hs-identifier">tcHsLiftedType</span></a></a><span> </span><a name="local-6989586621683132576"><a href="#local-6989586621683132576"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addTypeCtxt"><span class="hs-identifier hs-var">addTypeCtxt</span></a><span> </span><a href="#local-6989586621683132576"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcHsType.html#tcHsLiftedTypeNC"><span class="hs-identifier hs-var">tcHsLiftedTypeNC</span></a><span> </span><a href="#local-6989586621683132576"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><a name="tcHsOpenTypeNC"><a href="TcHsType.html#tcHsOpenTypeNC"><span class="hs-identifier">tcHsOpenTypeNC</span></a></a><span>   </span><a name="local-6989586621683132577"><a href="#local-6989586621683132577"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132578"><a href="#local-6989586621683132578"><span class="hs-identifier">ek</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenTypeKind"><span class="hs-identifier hs-var">newOpenTypeKind</span></a><span>
</span><a name="line-418"></a><span>                         </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621683132577"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132578"><span class="hs-identifier hs-var">ek</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-419"></a><a name="tcHsLiftedTypeNC"><a href="TcHsType.html#tcHsLiftedTypeNC"><span class="hs-identifier">tcHsLiftedTypeNC</span></a></a><span> </span><a name="local-6989586621683132579"><a href="#local-6989586621683132579"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621683132579"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-comment">-- Like tcHsType, but takes an expected kind</span><span>
</span><a name="line-422"></a><span class="hs-identifier">tcCheckLHsType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-423"></a><a name="tcCheckLHsType"><a href="TcHsType.html#tcCheckLHsType"><span class="hs-identifier">tcCheckLHsType</span></a></a><span> </span><a name="local-6989586621683132580"><a href="#local-6989586621683132580"><span class="hs-identifier">hs_ty</span></a></a><span> </span><a name="local-6989586621683132581"><a href="#local-6989586621683132581"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-424"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addTypeCtxt"><span class="hs-identifier hs-var">addTypeCtxt</span></a><span> </span><a href="#local-6989586621683132580"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-425"></a><span>    </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621683132580"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621683132581"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-identifier">tcLHsType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- Called from outside: set the context</span><span>
</span><a name="line-429"></a><a name="tcLHsType"><a href="TcHsType.html#tcLHsType"><span class="hs-identifier">tcLHsType</span></a></a><span> </span><a name="local-6989586621683132582"><a href="#local-6989586621683132582"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addTypeCtxt"><span class="hs-identifier hs-var">addTypeCtxt</span></a><span> </span><a href="#local-6989586621683132582"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tc_infer_lhs_type"><span class="hs-identifier hs-var">tc_infer_lhs_type</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621683132582"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">-- Like tcLHsType, but use it in a context where type synonyms and type families</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- do not need to be saturated, like in a GHCi :kind call</span><span>
</span><a name="line-433"></a><span class="hs-identifier">tcLHsTypeUnsaturated</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><a name="tcLHsTypeUnsaturated"><a href="TcHsType.html#tcLHsTypeUnsaturated"><span class="hs-identifier">tcLHsTypeUnsaturated</span></a></a><span> </span><a name="local-6989586621683132583"><a href="#local-6989586621683132583"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addTypeCtxt"><span class="hs-identifier hs-var">addTypeCtxt</span></a><span> </span><a href="#local-6989586621683132583"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tc_infer_lhs_type"><span class="hs-identifier hs-var">tc_infer_lhs_type</span></a><span> </span><a href="#local-6989586621683132584"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132583"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-436"></a><span>    </span><a name="local-6989586621683132584"><a href="#local-6989586621683132584"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#allowUnsaturated"><span class="hs-identifier hs-var">allowUnsaturated</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
      Type-checking modes
*                                                                      *
************************************************************************

The kind-checker is parameterised by a TcTyMode, which contains some
information about where we're checking a type.

The renamer issues errors about what it can. All errors issued here must
concern things that the renamer can't handle.

-}</span><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span class="hs-comment">-- | Do we require type families to be saturated?</span><span>
</span><a name="line-454"></a><span class="hs-keyword">data</span><span> </span><a name="RequireSaturation"><a href="TcHsType.html#RequireSaturation"><span class="hs-identifier">RequireSaturation</span></a></a><span>
</span><a name="line-455"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="YesSaturation"><a href="TcHsType.html#YesSaturation"><span class="hs-identifier">YesSaturation</span></a></a><span>
</span><a name="line-456"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NoSaturation"><a href="TcHsType.html#NoSaturation"><span class="hs-identifier">NoSaturation</span></a></a><span>   </span><span class="hs-comment">-- e.g. during a call to GHCi's :kind</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-comment">-- | Info about the context in which we're checking a type. Currently,</span><span>
</span><a name="line-459"></a><span class="hs-comment">-- differentiates only between types and kinds, but this will likely</span><span>
</span><a name="line-460"></a><span class="hs-comment">-- grow, at least to include the distinction between patterns and</span><span>
</span><a name="line-461"></a><span class="hs-comment">-- not-patterns.</span><span>
</span><a name="line-462"></a><span class="hs-keyword">data</span><span> </span><a name="TcTyMode"><a href="TcHsType.html#TcTyMode"><span class="hs-identifier">TcTyMode</span></a></a><span>
</span><a name="line-463"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="TcTyMode"><a href="TcHsType.html#TcTyMode"><span class="hs-identifier">TcTyMode</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="mode_level"><a href="TcHsType.html#mode_level"><span class="hs-identifier">mode_level</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TypeOrKind</span><span>
</span><a name="line-464"></a><span>             </span><span class="hs-special">,</span><span> </span><a name="mode_sat"><a href="TcHsType.html#mode_sat"><span class="hs-identifier">mode_sat</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#RequireSaturation"><span class="hs-identifier hs-type">RequireSaturation</span></a><span>
</span><a name="line-465"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-466"></a><span> </span><span class="hs-comment">-- The mode_unsat field is solely so that type families/synonyms can be unsaturated</span><span>
</span><a name="line-467"></a><span> </span><span class="hs-comment">-- in GHCi :kind calls</span><span>
</span><a name="line-468"></a><span>
</span><a name="line-469"></a><span class="hs-identifier">typeLevelMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span>
</span><a name="line-470"></a><a name="typeLevelMode"><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier">typeLevelMode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-var">TcTyMode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mode_level</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TypeLevel</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mode_sat</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#YesSaturation"><span class="hs-identifier hs-var">YesSaturation</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span class="hs-identifier">kindLevelMode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span>
</span><a name="line-473"></a><a name="kindLevelMode"><a href="TcHsType.html#kindLevelMode"><span class="hs-identifier">kindLevelMode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-var">TcTyMode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mode_level</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">KindLevel</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mode_sat</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#YesSaturation"><span class="hs-identifier hs-var">YesSaturation</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span class="hs-identifier">allowUnsaturated</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span>
</span><a name="line-476"></a><a name="allowUnsaturated"><a href="TcHsType.html#allowUnsaturated"><span class="hs-identifier">allowUnsaturated</span></a></a><span> </span><a name="local-6989586621683132585"><a href="#local-6989586621683132585"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132585"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mode_sat</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#NoSaturation"><span class="hs-identifier hs-var">NoSaturation</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span class="hs-comment">-- switch to kind level</span><span>
</span><a name="line-479"></a><span class="hs-identifier">kindLevel</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span>
</span><a name="line-480"></a><a name="kindLevel"><a href="TcHsType.html#kindLevel"><span class="hs-identifier">kindLevel</span></a></a><span> </span><a name="local-6989586621683132586"><a href="#local-6989586621683132586"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132586"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mode_level</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">KindLevel</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcHsType.html#RequireSaturation"><span class="hs-identifier hs-type">RequireSaturation</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-483"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="TcHsType.html#YesSaturation"><span class="hs-identifier hs-var">YesSaturation</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;YesSaturation&quot;</span><span>
</span><a name="line-484"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="TcHsType.html#NoSaturation"><span class="hs-identifier hs-var">NoSaturation</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;NoSaturation&quot;</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-487"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">mode_level</span><span>
</span><a name="line-488"></a><span>
</span><a name="line-489"></a><span class="hs-comment">{-
Note [Bidirectional type checking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In expressions, whenever we see a polymorphic identifier, say `id`, we are
free to instantiate it with metavariables, knowing that we can always
re-generalize with type-lambdas when necessary. For example:

  rank2 :: (forall a. a -&gt; a) -&gt; ()
  x = rank2 id

When checking the body of `x`, we can instantiate `id` with a metavariable.
Then, when we're checking the application of `rank2`, we notice that we really
need a polymorphic `id`, and then re-generalize over the unconstrained
metavariable.

In types, however, we're not so lucky, because *we cannot re-generalize*!
There is no lambda. So, we must be careful only to instantiate at the last
possible moment, when we're sure we're never going to want the lost polymorphism
again. This is done in calls to tcInstTyBinders.

To implement this behavior, we use bidirectional type checking, where we
explicitly think about whether we know the kind of the type we're checking
or not. Note that there is a difference between not knowing a kind and
knowing a metavariable kind: the metavariables are TauTvs, and cannot become
forall-quantified kinds. Previously (before dependent types), there were
no higher-rank kinds, and so we could instantiate early and be sure that
no types would have polymorphic kinds, and so we could always assume that
the kind of a type was a fresh metavariable. Not so anymore, thus the
need for two algorithms.

For HsType forms that can never be kind-polymorphic, we implement only the
&quot;down&quot; direction, where we safely assume a metavariable kind. For HsType forms
that *can* be kind-polymorphic, we implement just the &quot;up&quot; (functions with
&quot;infer&quot; in their name) version, as we gain nothing by also implementing the
&quot;down&quot; version.

Note [Future-proofing the type checker]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
As discussed in Note [Bidirectional type checking], each HsType form is
handled in *either* tc_infer_hs_type *or* tc_hs_type. These functions
are mutually recursive, so that either one can work for any type former.
But, we want to make sure that our pattern-matches are complete. So,
we have a bunch of repetitive code just so that we get warnings if we're
missing any patterns.

Note [The tcType invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
(IT1) If    tc_ty = tc_hs_type hs_ty exp_kind
      then  tcTypeKind tc_ty = exp_kind
without any zonking needed.  The reason for this is that in
tcInferApps we see (F ty), and we kind-check 'ty' with an
expected-kind coming from F.  Then, to make the resulting application
well kinded --- see Note [The well-kinded type invariant] in TcType ---
we need the kind-checked 'ty' to have exactly the kind that F expects,
with no funny zonking nonsense in between.

The tcType invariant also applies to checkExpectedKind:

(IT2) if
        (tc_ty, _, _) = checkExpectedKind ty act_ki exp_ki
      then
        tcTypeKind tc_ty = exp_ki

These other invariants are all necessary, too, as these functions
are used within tc_hs_type:

(IT3) If (ty, ki) &lt;- tc_infer_hs_type ..., then tcTypeKind ty == ki.

(IT4) If (ty, ki) &lt;- tc_infer_hs_type ..., then zonk ki == ki.
      (In other words, the result kind of tc_infer_hs_type is zonked.)

(IT5) If (ty, ki) &lt;- tcTyVar ..., then tcTypeKind ty == ki.

(IT6) If (ty, ki) &lt;- tcTyVar ..., then zonk ki == ki.
      (In other words, the result kind of tcTyVar is zonked.)

-}</span><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-568"></a><span class="hs-comment">-- | Check and desugar a type, returning the core type and its</span><span>
</span><a name="line-569"></a><span class="hs-comment">-- possibly-polymorphic kind. Much like 'tcInferRho' at the expression</span><span>
</span><a name="line-570"></a><span class="hs-comment">-- level.</span><span>
</span><a name="line-571"></a><span class="hs-identifier">tc_infer_lhs_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>
</span><a name="line-572"></a><a name="tc_infer_lhs_type"><a href="TcHsType.html#tc_infer_lhs_type"><span class="hs-identifier">tc_infer_lhs_type</span></a></a><span> </span><a name="local-6989586621683132587"><a href="#local-6989586621683132587"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683132588"><a href="#local-6989586621683132588"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621683132589"><a href="#local-6989586621683132589"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683132588"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-574"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132590"><a href="#local-6989586621683132590"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132591"><a href="#local-6989586621683132591"><span class="hs-identifier">kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_infer_hs_type"><span class="hs-identifier hs-var">tc_infer_hs_type</span></a><span> </span><a href="#local-6989586621683132587"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132589"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-575"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132590"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132591"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-comment">-- | Infer the kind of a type and desugar. This is the &quot;up&quot; type-checker,</span><span>
</span><a name="line-578"></a><span class="hs-comment">-- as described in Note [Bidirectional type checking]</span><span>
</span><a name="line-579"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>
</span><a name="line-580"></a><a name="tc_infer_hs_type"><a href="TcHsType.html#tc_infer_hs_type"><span class="hs-identifier">tc_infer_hs_type</span></a></a><span> </span><a name="local-6989586621683132592"><a href="#local-6989586621683132592"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsParTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132593"><a href="#local-6989586621683132593"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_lhs_type"><span class="hs-identifier hs-var">tc_infer_lhs_type</span></a><span> </span><a href="#local-6989586621683132592"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132593"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-581"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><a name="local-6989586621683132594"><a href="#local-6989586621683132594"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132595"><a href="#local-6989586621683132595"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tcTyVar"><span class="hs-identifier hs-var">tcTyVar</span></a><span> </span><a href="#local-6989586621683132594"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132595"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><a name="local-6989586621683132596"><a href="#local-6989586621683132596"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132597"><a href="#local-6989586621683132597"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tcTyApp"><span class="hs-identifier hs-var">tcTyApp</span></a><span> </span><a href="#local-6989586621683132596"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132597"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-584"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><a name="local-6989586621683132598"><a href="#local-6989586621683132598"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132599"><a href="#local-6989586621683132599"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppKindTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tcTyApp"><span class="hs-identifier hs-var">tcTyApp</span></a><span> </span><a href="#local-6989586621683132598"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132599"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><a name="local-6989586621683132600"><a href="#local-6989586621683132600"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOpTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132601"><a href="#local-6989586621683132601"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621683132602"><a href="#local-6989586621683132602"><span class="hs-identifier">lhs_op</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132603"><a href="#local-6989586621683132603"><span class="hs-identifier">hs_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132604"><a href="#local-6989586621683132604"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132603"><span class="hs-identifier hs-var">hs_op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">funTyConKey</span><span class="hs-special">)</span><span>
</span><a name="line-588"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132605"><a href="#local-6989586621683132605"><span class="hs-identifier">op</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132606"><a href="#local-6989586621683132606"><span class="hs-identifier">op_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcTyVar"><span class="hs-identifier hs-var">tcTyVar</span></a><span> </span><a href="#local-6989586621683132600"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132603"><span class="hs-identifier hs-var">hs_op</span></a><span>
</span><a name="line-589"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#tcTyApps"><span class="hs-identifier hs-var">tcTyApps</span></a><span> </span><a href="#local-6989586621683132600"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsTyVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-identifier hs-var">NotPromoted</span><span> </span><a href="#local-6989586621683132602"><span class="hs-identifier hs-var">lhs_op</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132605"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621683132606"><span class="hs-identifier hs-var">op_kind</span></a><span>
</span><a name="line-590"></a><span>                       </span><span class="hs-special">[</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a href="#local-6989586621683132601"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a href="#local-6989586621683132604"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><a name="local-6989586621683132607"><a href="#local-6989586621683132607"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsKindSig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132608"><a href="#local-6989586621683132608"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683132609"><a href="#local-6989586621683132609"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-593"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132610"><a href="#local-6989586621683132610"><span class="hs-identifier">sig'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span> </span><span class="hs-identifier hs-var">KindSigCtxt</span><span> </span><a href="#local-6989586621683132609"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-594"></a><span>                 </span><span class="hs-comment">-- We must typecheck the kind signature, and solve all</span><span>
</span><a name="line-595"></a><span>                 </span><span class="hs-comment">-- its equalities etc; from this point on we may do</span><span>
</span><a name="line-596"></a><span>                 </span><span class="hs-comment">-- things like instantiate its foralls, so it needs</span><span>
</span><a name="line-597"></a><span>                 </span><span class="hs-comment">-- to be fully determined (Trac #14904)</span><span>
</span><a name="line-598"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tc_infer_hs_type:sig&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132608"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132610"><span class="hs-identifier hs-var">sig'</span></a><span class="hs-special">)</span><span>
</span><a name="line-599"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132611"><a href="#local-6989586621683132611"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132607"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132608"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132610"><span class="hs-identifier hs-var">sig'</span></a><span>
</span><a name="line-600"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132611"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132610"><span class="hs-identifier hs-var">sig'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span class="hs-comment">-- HsSpliced is an annotation produced by 'RnSplice.rnSpliceType' to communicate</span><span>
</span><a name="line-603"></a><span class="hs-comment">-- the splice location to the typechecker. Here we skip over it in order to have</span><span>
</span><a name="line-604"></a><span class="hs-comment">-- the same kind inferred for a given expression whether it was produced from</span><span>
</span><a name="line-605"></a><span class="hs-comment">-- splices or not.</span><span>
</span><a name="line-606"></a><span class="hs-comment">--</span><span>
</span><a name="line-607"></a><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><a name="line-608"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><a name="local-6989586621683132612"><a href="#local-6989586621683132612"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSplicedTy</span><span> </span><a name="local-6989586621683132613"><a href="#local-6989586621683132613"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_hs_type"><span class="hs-identifier hs-var">tc_infer_hs_type</span></a><span> </span><a href="#local-6989586621683132612"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132613"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><a name="local-6989586621683132614"><a href="#local-6989586621683132614"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDocTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132615"><a href="#local-6989586621683132615"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_lhs_type"><span class="hs-identifier hs-var">tc_infer_lhs_type</span></a><span> </span><a href="#local-6989586621683132614"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132615"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-612"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NHsCoreTy</span><span> </span><a name="local-6989586621683132616"><a href="#local-6989586621683132616"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132617"><a href="#local-6989586621683132617"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683132616"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-comment">-- (IT3) and (IT4) of Note [The tcType invariant]</span><span>
</span><a name="line-614"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132617"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621683132617"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsExplicitListTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132618"><a href="#local-6989586621683132618"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683132618"><span class="hs-identifier hs-var">tys</span></a><span>  </span><span class="hs-comment">-- this is so that we can use visible kind application with '[]</span><span>
</span><a name="line-618"></a><span>              </span><span class="hs-comment">-- e.g ... '[] @Bool</span><span>
</span><a name="line-619"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><span class="hs-identifier hs-var">promotedNilDataCon</span><span class="hs-special">,</span><span>
</span><a name="line-620"></a><span>            </span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">alphaTyVar</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><span class="hs-identifier hs-var">alphaTy</span><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span class="hs-identifier">tc_infer_hs_type</span><span> </span><a name="local-6989586621683132619"><a href="#local-6989586621683132619"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132620"><a href="#local-6989586621683132620"><span class="hs-identifier">other_ty</span></a></a><span>
</span><a name="line-623"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132621"><a href="#local-6989586621683132621"><span class="hs-identifier">kv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-624"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132622"><a href="#local-6989586621683132622"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_hs_type"><span class="hs-identifier hs-var">tc_hs_type</span></a><span> </span><a href="#local-6989586621683132619"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132620"><span class="hs-identifier hs-var">other_ty</span></a><span> </span><a href="#local-6989586621683132621"><span class="hs-identifier hs-var">kv</span></a><span>
</span><a name="line-625"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132622"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132621"><span class="hs-identifier hs-var">kv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-628"></a><span class="hs-identifier">tc_lhs_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-629"></a><a name="tc_lhs_type"><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier">tc_lhs_type</span></a></a><span> </span><a name="local-6989586621683132623"><a href="#local-6989586621683132623"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683132624"><a href="#local-6989586621683132624"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621683132625"><a href="#local-6989586621683132625"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132626"><a href="#local-6989586621683132626"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-630"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683132624"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-631"></a><span>    </span><a href="TcHsType.html#tc_hs_type"><span class="hs-identifier hs-var">tc_hs_type</span></a><span> </span><a href="#local-6989586621683132623"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132625"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132626"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-632"></a><span>
</span><a name="line-633"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-634"></a><span class="hs-identifier">tc_fun_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>
</span><a name="line-635"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-636"></a><a name="tc_fun_type"><a href="TcHsType.html#tc_fun_type"><span class="hs-identifier">tc_fun_type</span></a></a><span> </span><a name="local-6989586621683132627"><a href="#local-6989586621683132627"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132628"><a href="#local-6989586621683132628"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621683132629"><a href="#local-6989586621683132629"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621683132630"><a href="#local-6989586621683132630"><span class="hs-identifier">exp_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">mode_level</span><span> </span><a href="#local-6989586621683132627"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-637"></a><span>  </span><span class="hs-identifier hs-var">TypeLevel</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-638"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132631"><a href="#local-6989586621683132631"><span class="hs-identifier">arg_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenTypeKind"><span class="hs-identifier hs-var">newOpenTypeKind</span></a><span>
</span><a name="line-639"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132632"><a href="#local-6989586621683132632"><span class="hs-identifier">res_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenTypeKind"><span class="hs-identifier hs-var">newOpenTypeKind</span></a><span>
</span><a name="line-640"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132633"><a href="#local-6989586621683132633"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132627"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132628"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621683132631"><span class="hs-identifier hs-var">arg_k</span></a><span>
</span><a name="line-641"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132634"><a href="#local-6989586621683132634"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132627"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132629"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621683132632"><span class="hs-identifier hs-var">res_k</span></a><span>
</span><a name="line-642"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132627"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsFunTy</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683132628"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621683132629"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621683132633"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621683132634"><span class="hs-identifier hs-var">ty2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>                           </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><a href="#local-6989586621683132630"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-644"></a><span>  </span><span class="hs-identifier hs-var">KindLevel</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-comment">-- no representation polymorphism in kinds. yet.</span><span>
</span><a name="line-645"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132635"><a href="#local-6989586621683132635"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132627"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132628"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-646"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132636"><a href="#local-6989586621683132636"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132627"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132629"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-647"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132627"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsFunTy</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621683132628"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621683132629"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFunTy</span><span> </span><a href="#local-6989586621683132635"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621683132636"><span class="hs-identifier hs-var">ty2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-648"></a><span>                           </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><a href="#local-6989586621683132630"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-651"></a><span class="hs-identifier">tc_hs_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-652"></a><span class="hs-comment">-- See Note [The tcType invariant]</span><span>
</span><a name="line-653"></a><span class="hs-comment">-- See Note [Bidirectional type checking]</span><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><a name="tc_hs_type"><a href="TcHsType.html#tc_hs_type"><span class="hs-identifier">tc_hs_type</span></a></a><span> </span><a name="local-6989586621683132637"><a href="#local-6989586621683132637"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsParTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132638"><a href="#local-6989586621683132638"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>   </span><a name="local-6989586621683132639"><a href="#local-6989586621683132639"><span class="hs-identifier">exp_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132637"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132638"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132639"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-656"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132640"><a href="#local-6989586621683132640"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDocTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132641"><a href="#local-6989586621683132641"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132642"><a href="#local-6989586621683132642"><span class="hs-identifier">exp_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132640"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132641"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132642"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-657"></a><span class="hs-identifier">tc_hs_type</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132643"><a href="#local-6989586621683132643"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsBangTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132644"><a href="#local-6989586621683132644"><span class="hs-identifier">bang</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-658"></a><span>    </span><span class="hs-comment">-- While top-level bangs at this point are eliminated (eg !(Maybe Int)),</span><span>
</span><a name="line-659"></a><span>    </span><span class="hs-comment">-- other kinds of bangs are not (eg ((!Maybe) Int)). These kinds of</span><span>
</span><a name="line-660"></a><span>    </span><span class="hs-comment">-- bangs are invalid, so fail. (#7210, #14761)</span><span>
</span><a name="line-661"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132645"><a href="#local-6989586621683132645"><span class="hs-identifier">bangError</span></a></a><span> </span><a name="local-6989586621683132646"><a href="#local-6989586621683132646"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-662"></a><span>                 </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unexpected&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683132646"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;annotation:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132643"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-663"></a><span>                 </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683132646"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;annotation cannot appear nested inside a type&quot;</span><span>
</span><a name="line-664"></a><span>         </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132644"><span class="hs-identifier hs-var">bang</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-665"></a><span>             </span><span class="hs-identifier hs-var">HsSrcBang</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">SrcUnpack</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132645"><span class="hs-identifier hs-var">bangError</span></a><span> </span><span class="hs-string">&quot;UNPACK&quot;</span><span>
</span><a name="line-666"></a><span>             </span><span class="hs-identifier hs-var">HsSrcBang</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">SrcNoUnpack</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132645"><span class="hs-identifier hs-var">bangError</span></a><span> </span><span class="hs-string">&quot;NOUNPACK&quot;</span><span>
</span><a name="line-667"></a><span>             </span><span class="hs-identifier hs-var">HsSrcBang</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">NoSrcUnpack</span><span> </span><span class="hs-identifier hs-var">SrcLazy</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132645"><span class="hs-identifier hs-var">bangError</span></a><span> </span><span class="hs-string">&quot;laziness&quot;</span><span>
</span><a name="line-668"></a><span>             </span><span class="hs-identifier hs-var">HsSrcBang</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132645"><span class="hs-identifier hs-var">bangError</span></a><span> </span><span class="hs-string">&quot;strictness&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-669"></a><span class="hs-identifier">tc_hs_type</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132647"><a href="#local-6989586621683132647"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-identifier">_</span><span>
</span><a name="line-670"></a><span>      </span><span class="hs-comment">-- Record types (which only show up temporarily in constructor</span><span>
</span><a name="line-671"></a><span>      </span><span class="hs-comment">-- signatures) should have been removed by now</span><span>
</span><a name="line-672"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Record syntax is illegal here:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132647"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span class="hs-comment">-- HsSpliced is an annotation produced by 'RnSplice.rnSpliceType'.</span><span>
</span><a name="line-675"></a><span class="hs-comment">-- Here we get rid of it and add the finalizers to the global environment</span><span>
</span><a name="line-676"></a><span class="hs-comment">-- while capturing the local environment.</span><span>
</span><a name="line-677"></a><span class="hs-comment">--</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices].</span><span>
</span><a name="line-679"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132648"><a href="#local-6989586621683132648"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132649"><a href="#local-6989586621683132649"><span class="hs-identifier">mod_finalizers</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSplicedTy</span><span> </span><a name="local-6989586621683132650"><a href="#local-6989586621683132650"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-680"></a><span>           </span><a name="local-6989586621683132651"><a href="#local-6989586621683132651"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-681"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#addModFinalizersWithLclEnv"><span class="hs-identifier hs-var">addModFinalizersWithLclEnv</span></a><span> </span><a href="#local-6989586621683132649"><span class="hs-identifier hs-var">mod_finalizers</span></a><span>
</span><a name="line-682"></a><span>       </span><a href="TcHsType.html#tc_hs_type"><span class="hs-identifier hs-var">tc_hs_type</span></a><span> </span><a href="#local-6989586621683132648"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132650"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132651"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span class="hs-comment">-- This should never happen; type splices are expanded by the renamer</span><span>
</span><a name="line-685"></a><span class="hs-identifier">tc_hs_type</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132652"><a href="#local-6989586621683132652"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132653"><a href="#local-6989586621683132653"><span class="hs-identifier">_exp_kind</span></a></a><span>
</span><a name="line-686"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unexpected type splice:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132652"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span class="hs-comment">---------- Functions and applications</span><span>
</span><a name="line-689"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132654"><a href="#local-6989586621683132654"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsFunTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132655"><a href="#local-6989586621683132655"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621683132656"><a href="#local-6989586621683132656"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132657"><a href="#local-6989586621683132657"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-690"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_fun_type"><span class="hs-identifier hs-var">tc_fun_type</span></a><span> </span><a href="#local-6989586621683132654"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132655"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621683132656"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621683132657"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132658"><a href="#local-6989586621683132658"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOpTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132659"><a href="#local-6989586621683132659"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132660"><a href="#local-6989586621683132660"><span class="hs-identifier">op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132661"><a href="#local-6989586621683132661"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132662"><a href="#local-6989586621683132662"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-693"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683132660"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">funTyConKey</span><span>
</span><a name="line-694"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_fun_type"><span class="hs-identifier hs-var">tc_fun_type</span></a><span> </span><a href="#local-6989586621683132658"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132659"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621683132661"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621683132662"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span class="hs-comment">--------- Foralls</span><span>
</span><a name="line-697"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132663"><a href="#local-6989586621683132663"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-keyword">forall</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsForAllTy</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hst_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132665"><a href="#local-6989586621683132665"><span class="hs-identifier">hs_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hst_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132666"><a href="#local-6989586621683132666"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132667"><a href="#local-6989586621683132667"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-698"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132668"><a href="#local-6989586621683132668"><span class="hs-identifier">tclvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132669"><a href="#local-6989586621683132669"><span class="hs-identifier">wanted</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132670"><a href="#local-6989586621683132670"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132671"><a href="#local-6989586621683132671"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-699"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier hs-var">pushLevelAndCaptureConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-700"></a><span>               </span><a href="TcHsType.html#bindExplicitTKBndrs_Skol"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Skol</span></a><span> </span><a href="#local-6989586621683132665"><span class="hs-identifier hs-var">hs_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-701"></a><span>               </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132663"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132666"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132667"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-702"></a><span>    </span><span class="hs-comment">-- Do not kind-generalise here!  See Note [Kind generalisation]</span><span>
</span><a name="line-703"></a><span>    </span><span class="hs-comment">-- Why exp_kind?  See Note [Body kind of HsForAllTy]</span><span>
</span><a name="line-704"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132672"><a href="#local-6989586621683132672"><span class="hs-identifier">bndrs</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarBinders</span><span> </span><span class="hs-identifier hs-var">Specified</span><span> </span><a href="#local-6989586621683132670"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-705"></a><span>             </span><a name="local-6989586621683132673"><a href="#local-6989586621683132673"><span class="hs-identifier">skol_info</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ForAllSkol</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-keyword">forall</span><span class="hs-special">)</span><span>
</span><a name="line-706"></a><span>             </span><a name="local-6989586621683132674"><a href="#local-6989586621683132674"><span class="hs-identifier">m_telescope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132665"><span class="hs-identifier hs-var">hs_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcUnify.html#emitResidualTvConstraint"><span class="hs-identifier hs-var">emitResidualTvConstraint</span></a><span> </span><a href="#local-6989586621683132673"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621683132674"><span class="hs-identifier hs-var">m_telescope</span></a><span> </span><a href="#local-6989586621683132670"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><a href="#local-6989586621683132668"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-6989586621683132669"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkForAllTys</span><span> </span><a href="#local-6989586621683132672"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621683132671"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132675"><a href="#local-6989586621683132675"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsQualTy</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hst_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132676"><a href="#local-6989586621683132676"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hst_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132677"><a href="#local-6989586621683132677"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132678"><a href="#local-6989586621683132678"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-713"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683132676"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-714"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132675"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132677"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132678"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-715"></a><span>
</span><a name="line-716"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-717"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132679"><a href="#local-6989586621683132679"><span class="hs-identifier">ctxt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_hs_context"><span class="hs-identifier hs-var">tc_hs_context</span></a><span> </span><a href="#local-6989586621683132675"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132676"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span>         </span><span class="hs-comment">-- See Note [Body kind of a HsQualTy]</span><span>
</span><a name="line-720"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132682"><a href="#local-6989586621683132682"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">tcIsConstraintKind</span><span> </span><a href="#local-6989586621683132678"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-721"></a><span>                </span><span class="hs-keyword">then</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132675"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132677"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">constraintKind</span><span>
</span><a name="line-722"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132680"><a href="#local-6989586621683132680"><span class="hs-identifier">ek</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newOpenTypeKind"><span class="hs-identifier hs-var">newOpenTypeKind</span></a><span>
</span><a name="line-723"></a><span>                                </span><span class="hs-comment">-- The body kind (result of the function)</span><span>
</span><a name="line-724"></a><span>                                </span><span class="hs-comment">-- can be TYPE r, for any r, hence newOpenTypeKind</span><span>
</span><a name="line-725"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132681"><a href="#local-6989586621683132681"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132675"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132677"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132680"><span class="hs-identifier hs-var">ek</span></a><span>
</span><a name="line-726"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132675"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132677"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132681"><span class="hs-identifier hs-var">ty'</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><a href="#local-6989586621683132678"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPhiTy</span><span> </span><a href="#local-6989586621683132679"><span class="hs-identifier hs-var">ctxt'</span></a><span> </span><a href="#local-6989586621683132682"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-comment">--------- Lists, arrays, and tuples</span><span>
</span><a name="line-731"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132683"><a href="#local-6989586621683132683"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132684"><a href="#local-6989586621683132684"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsListTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132685"><a href="#local-6989586621683132685"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132686"><a href="#local-6989586621683132686"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-732"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132687"><a href="#local-6989586621683132687"><span class="hs-identifier">tau_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132683"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132685"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-733"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="LoadIface.html#checkWiredInTyCon"><span class="hs-identifier hs-var">checkWiredInTyCon</span></a><span> </span><span class="hs-identifier hs-var">listTyCon</span><span>
</span><a name="line-734"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132683"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132684"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621683132687"><span class="hs-identifier hs-var">tau_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><a href="#local-6989586621683132686"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span class="hs-comment">-- See Note [Distinguishing tuple kinds] in HsTypes</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- See Note [Inferring tuple kinds]</span><span>
</span><a name="line-738"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132688"><a href="#local-6989586621683132688"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132689"><a href="#local-6989586621683132689"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTupleTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">HsBoxedOrConstraintTuple</span><span> </span><a name="local-6989586621683132690"><a href="#local-6989586621683132690"><span class="hs-identifier">hs_tys</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132691"><a href="#local-6989586621683132691"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-739"></a><span>     </span><span class="hs-comment">-- (NB: not zonking before looking at exp_k, to avoid left-right bias)</span><span>
</span><a name="line-740"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683132692"><a href="#local-6989586621683132692"><span class="hs-identifier">tup_sort</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tupKindSort_maybe"><span class="hs-identifier hs-var">tupKindSort_maybe</span></a><span> </span><a href="#local-6989586621683132691"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-741"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tc_hs_type tuple&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132690"><span class="hs-identifier hs-var">hs_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-742"></a><span>    </span><a href="TcHsType.html#tc_tuple"><span class="hs-identifier hs-var">tc_tuple</span></a><span> </span><a href="#local-6989586621683132689"><span class="hs-identifier hs-var">rn_ty</span></a><span> </span><a href="#local-6989586621683132688"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132692"><span class="hs-identifier hs-var">tup_sort</span></a><span> </span><a href="#local-6989586621683132690"><span class="hs-identifier hs-var">hs_tys</span></a><span> </span><a href="#local-6989586621683132691"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-743"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-744"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tc_hs_type tuple 2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132690"><span class="hs-identifier hs-var">hs_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-745"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132693"><a href="#local-6989586621683132693"><span class="hs-identifier">tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132694"><a href="#local-6989586621683132694"><span class="hs-identifier">kinds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapAndUnzipM</span><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tc_infer_lhs_type"><span class="hs-identifier hs-var">tc_infer_lhs_type</span></a><span> </span><a href="#local-6989586621683132688"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132690"><span class="hs-identifier hs-var">hs_tys</span></a><span>
</span><a name="line-746"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132695"><a href="#local-6989586621683132695"><span class="hs-identifier">kinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683132694"><span class="hs-identifier hs-var">kinds</span></a><span>
</span><a name="line-747"></a><span>           </span><span class="hs-comment">-- Infer each arg type separately, because errors can be</span><span>
</span><a name="line-748"></a><span>           </span><span class="hs-comment">-- confusing if we give them a shared kind.  Eg Trac #7410</span><span>
</span><a name="line-749"></a><span>           </span><span class="hs-comment">-- (Either Int, Int), we do not want to get an error saying</span><span>
</span><a name="line-750"></a><span>           </span><span class="hs-comment">-- &quot;the second argument of a tuple should have kind *-&gt;*&quot;</span><span>
</span><a name="line-751"></a><span>
</span><a name="line-752"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132696"><a href="#local-6989586621683132696"><span class="hs-identifier">arg_kind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132697"><a href="#local-6989586621683132697"><span class="hs-identifier">tup_sort</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-753"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132698"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621683132699"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683132698"><a href="#local-6989586621683132698"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132695"><span class="hs-identifier hs-var">kinds</span></a><span>
</span><a name="line-754"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683132699"><a href="#local-6989586621683132699"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><a href="TcHsType.html#tupKindSort_maybe"><span class="hs-identifier hs-var">tupKindSort_maybe</span></a><span> </span><a href="#local-6989586621683132698"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-755"></a><span>                    </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683132700"><a href="#local-6989586621683132700"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621683132701"><a href="#local-6989586621683132701"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132700"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621683132701"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>                    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">BoxedTuple</span><span class="hs-special">)</span><span>
</span><a name="line-757"></a><span>         </span><span class="hs-comment">-- In the [] case, it's not clear what the kind is, so guess *</span><span>
</span><a name="line-758"></a><span>
</span><a name="line-759"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132706"><a href="#local-6989586621683132706"><span class="hs-identifier">tys'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683132702"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-760"></a><span>                            </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132688"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132703"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132704"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132705"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621683132696"><span class="hs-identifier hs-var">arg_kind</span></a><span>
</span><a name="line-761"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683132702"><a href="#local-6989586621683132702"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683132703"><a href="#local-6989586621683132703"><span class="hs-identifier">hs_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><a name="local-6989586621683132704"><a href="#local-6989586621683132704"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><a name="local-6989586621683132705"><a href="#local-6989586621683132705"><span class="hs-identifier">kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip3</span><span> </span><a href="#local-6989586621683132690"><span class="hs-identifier hs-var">hs_tys</span></a><span> </span><a href="#local-6989586621683132693"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621683132695"><span class="hs-identifier hs-var">kinds</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#finish_tuple"><span class="hs-identifier hs-var">finish_tuple</span></a><span> </span><a href="#local-6989586621683132689"><span class="hs-identifier hs-var">rn_ty</span></a><span> </span><a href="#local-6989586621683132688"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132697"><span class="hs-identifier hs-var">tup_sort</span></a><span> </span><a href="#local-6989586621683132706"><span class="hs-identifier hs-var">tys'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621683132696"><span class="hs-identifier hs-var">arg_kind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132706"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132691"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132707"><a href="#local-6989586621683132707"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132708"><a href="#local-6989586621683132708"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTupleTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132709"><a href="#local-6989586621683132709"><span class="hs-identifier">hs_tup_sort</span></a></a><span> </span><a name="local-6989586621683132710"><a href="#local-6989586621683132710"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132711"><a href="#local-6989586621683132711"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-767"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_tuple"><span class="hs-identifier hs-var">tc_tuple</span></a><span> </span><a href="#local-6989586621683132708"><span class="hs-identifier hs-var">rn_ty</span></a><span> </span><a href="#local-6989586621683132707"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132712"><span class="hs-identifier hs-var">tup_sort</span></a><span> </span><a href="#local-6989586621683132710"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621683132711"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-768"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-769"></a><span>    </span><a name="local-6989586621683132712"><a href="#local-6989586621683132712"><span class="hs-identifier">tup_sort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132709"><span class="hs-identifier hs-var">hs_tup_sort</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Fourth case dealt with above</span><span>
</span><a name="line-770"></a><span>                  </span><span class="hs-identifier hs-var">HsUnboxedTuple</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">UnboxedTuple</span><span>
</span><a name="line-771"></a><span>                  </span><span class="hs-identifier hs-var">HsBoxedTuple</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">BoxedTuple</span><span>
</span><a name="line-772"></a><span>                  </span><span class="hs-identifier hs-var">HsConstraintTuple</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">ConstraintTuple</span><span>
</span><a name="line-773"></a><span>                  </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_hs_type HsTupleTy&quot;</span><span>
</span><a name="line-774"></a><span>
</span><a name="line-775"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132713"><a href="#local-6989586621683132713"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132714"><a href="#local-6989586621683132714"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSumTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132715"><a href="#local-6989586621683132715"><span class="hs-identifier">hs_tys</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132716"><a href="#local-6989586621683132716"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-776"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132717"><a href="#local-6989586621683132717"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683132715"><span class="hs-identifier hs-var">hs_tys</span></a><span>
</span><a name="line-777"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132718"><a href="#local-6989586621683132718"><span class="hs-identifier">arg_kinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#newOpenTypeKind"><span class="hs-identifier hs-var">newOpenTypeKind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132715"><span class="hs-identifier hs-var">hs_tys</span></a><span>
</span><a name="line-778"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132719"><a href="#local-6989586621683132719"><span class="hs-identifier">tau_tys</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132713"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132715"><span class="hs-identifier hs-var">hs_tys</span></a><span> </span><a href="#local-6989586621683132718"><span class="hs-identifier hs-var">arg_kinds</span></a><span>
</span><a name="line-779"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132720"><a href="#local-6989586621683132720"><span class="hs-identifier">arg_reps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">kindRep</span><span> </span><a href="#local-6989586621683132718"><span class="hs-identifier hs-var">arg_kinds</span></a><span>
</span><a name="line-780"></a><span>             </span><a name="local-6989586621683132721"><a href="#local-6989586621683132721"><span class="hs-identifier">arg_tys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132720"><span class="hs-identifier hs-var">arg_reps</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683132719"><span class="hs-identifier hs-var">tau_tys</span></a><span>
</span><a name="line-781"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132713"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132714"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sumTyCon</span><span> </span><a href="#local-6989586621683132717"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132721"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unboxedSumKind</span><span> </span><a href="#local-6989586621683132720"><span class="hs-identifier hs-var">arg_reps</span></a><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>                           </span><a href="#local-6989586621683132716"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-785"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-786"></a><span>
</span><a name="line-787"></a><span class="hs-comment">--------- Promoted lists and tuples</span><span>
</span><a name="line-788"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132722"><a href="#local-6989586621683132722"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132723"><a href="#local-6989586621683132723"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsExplicitListTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132724"><a href="#local-6989586621683132724"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132725"><a href="#local-6989586621683132725"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-789"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132732"><a href="#local-6989586621683132732"><span class="hs-identifier">tks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tc_infer_lhs_type"><span class="hs-identifier hs-var">tc_infer_lhs_type</span></a><span> </span><a href="#local-6989586621683132722"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132724"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-790"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132733"><a href="#local-6989586621683132733"><span class="hs-identifier">taus'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132734"><a href="#local-6989586621683132734"><span class="hs-identifier">kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#unifyKinds"><span class="hs-identifier hs-var">unifyKinds</span></a><span> </span><a href="#local-6989586621683132724"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621683132732"><span class="hs-identifier hs-var">tks</span></a><span>
</span><a name="line-791"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132735"><a href="#local-6989586621683132735"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132726"><span class="hs-identifier hs-var">mk_cons</span></a><span> </span><a href="#local-6989586621683132734"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132727"><span class="hs-identifier hs-var">mk_nil</span></a><span> </span><a href="#local-6989586621683132734"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132733"><span class="hs-identifier hs-var">taus'</span></a><span class="hs-special">)</span><span>
</span><a name="line-792"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132722"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132723"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132735"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkListTy</span><span> </span><a href="#local-6989586621683132734"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132725"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-793"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-794"></a><span>    </span><a name="local-6989586621683132726"><a href="#local-6989586621683132726"><span class="hs-identifier">mk_cons</span></a></a><span> </span><a name="local-6989586621683132728"><a href="#local-6989586621683132728"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621683132729"><a href="#local-6989586621683132729"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683132730"><a href="#local-6989586621683132730"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">promoteDataCon</span><span> </span><span class="hs-identifier hs-var">consDataCon</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683132728"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132729"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132730"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-795"></a><span>    </span><a name="local-6989586621683132727"><a href="#local-6989586621683132727"><span class="hs-identifier">mk_nil</span></a></a><span>  </span><a name="local-6989586621683132731"><a href="#local-6989586621683132731"><span class="hs-identifier">k</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">promoteDataCon</span><span> </span><span class="hs-identifier hs-var">nilDataCon</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683132731"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-796"></a><span>
</span><a name="line-797"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132736"><a href="#local-6989586621683132736"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132737"><a href="#local-6989586621683132737"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsExplicitTupleTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132738"><a href="#local-6989586621683132738"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132739"><a href="#local-6989586621683132739"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-798"></a><span>  </span><span class="hs-comment">-- using newMetaKindVar means that we force instantiations of any polykinded</span><span>
</span><a name="line-799"></a><span>  </span><span class="hs-comment">-- types. At first, I just used tc_infer_lhs_type, but that led to #11255.</span><span>
</span><a name="line-800"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132741"><a href="#local-6989586621683132741"><span class="hs-identifier">ks</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">replicateM</span><span> </span><a href="#local-6989586621683132740"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-801"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132742"><a href="#local-6989586621683132742"><span class="hs-identifier">taus</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132736"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132738"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621683132741"><span class="hs-identifier hs-var">ks</span></a><span>
</span><a name="line-802"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132743"><a href="#local-6989586621683132743"><span class="hs-identifier">kind_con</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tupleTyCon</span><span>           </span><span class="hs-identifier hs-var">Boxed</span><span> </span><a href="#local-6989586621683132740"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-803"></a><span>             </span><a name="local-6989586621683132744"><a href="#local-6989586621683132744"><span class="hs-identifier">ty_con</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">promotedTupleDataCon</span><span> </span><span class="hs-identifier hs-var">Boxed</span><span> </span><a href="#local-6989586621683132740"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-804"></a><span>             </span><a name="local-6989586621683132745"><a href="#local-6989586621683132745"><span class="hs-identifier">tup_k</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683132743"><span class="hs-identifier hs-var">kind_con</span></a><span> </span><a href="#local-6989586621683132741"><span class="hs-identifier hs-var">ks</span></a><span>
</span><a name="line-805"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132736"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132737"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683132744"><span class="hs-identifier hs-var">ty_con</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132741"><span class="hs-identifier hs-var">ks</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683132742"><span class="hs-identifier hs-var">taus</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132745"><span class="hs-identifier hs-var">tup_k</span></a><span> </span><a href="#local-6989586621683132739"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-806"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-807"></a><span>    </span><a name="local-6989586621683132740"><a href="#local-6989586621683132740"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683132738"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-808"></a><span>
</span><a name="line-809"></a><span class="hs-comment">--------- Constraint types</span><span>
</span><a name="line-810"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132746"><a href="#local-6989586621683132746"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132747"><a href="#local-6989586621683132747"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIParamTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132748"><a href="#local-6989586621683132748"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132749"><a href="#local-6989586621683132749"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132750"><a href="#local-6989586621683132750"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-811"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTypeLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mode_level</span><span> </span><span class="hs-identifier">mode</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132751"><a href="#local-6989586621683132751"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132746"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132749"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-813"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132752"><a href="#local-6989586621683132752"><span class="hs-identifier">n'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hsIPNameFS</span><span> </span><a href="#local-6989586621683132748"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-814"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132753"><a href="#local-6989586621683132753"><span class="hs-identifier">ipClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><span class="hs-identifier hs-var">ipClassName</span><span>
</span><a name="line-815"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132746"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132747"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621683132753"><span class="hs-identifier hs-var">ipClass</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683132752"><span class="hs-identifier hs-var">n'</span></a><span class="hs-special">,</span><a href="#local-6989586621683132751"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-816"></a><span>           </span><span class="hs-identifier hs-var">constraintKind</span><span> </span><a href="#local-6989586621683132750"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132754"><a href="#local-6989586621683132754"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132755"><a href="#local-6989586621683132755"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsStarTy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132756"><a href="#local-6989586621683132756"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-819"></a><span>  </span><span class="hs-comment">-- Desugaring 'HsStarTy' to 'Data.Kind.Type' here means that we don't have to</span><span>
</span><a name="line-820"></a><span>  </span><span class="hs-comment">-- handle it in 'coreView' and 'tcView'.</span><span>
</span><a name="line-821"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132754"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132755"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span> </span><a href="#local-6989586621683132756"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-822"></a><span>
</span><a name="line-823"></a><span class="hs-comment">--------- Literals</span><span>
</span><a name="line-824"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132757"><a href="#local-6989586621683132757"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132758"><a href="#local-6989586621683132758"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTyLit</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsNumTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132759"><a href="#local-6989586621683132759"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132760"><a href="#local-6989586621683132760"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-825"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="LoadIface.html#checkWiredInTyCon"><span class="hs-identifier hs-var">checkWiredInTyCon</span></a><span> </span><span class="hs-identifier hs-var">typeNatKindCon</span><span>
</span><a name="line-826"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132757"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132758"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNumLitTy</span><span> </span><a href="#local-6989586621683132759"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">typeNatKind</span><span> </span><a href="#local-6989586621683132760"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-827"></a><span>
</span><a name="line-828"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132761"><a href="#local-6989586621683132761"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132762"><a href="#local-6989586621683132762"><span class="hs-identifier">rn_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTyLit</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsStrTy</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132763"><a href="#local-6989586621683132763"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132764"><a href="#local-6989586621683132764"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-829"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="LoadIface.html#checkWiredInTyCon"><span class="hs-identifier hs-var">checkWiredInTyCon</span></a><span> </span><span class="hs-identifier hs-var">typeSymbolKindCon</span><span>
</span><a name="line-830"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132761"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132762"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><a href="#local-6989586621683132763"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">typeSymbolKind</span><span> </span><a href="#local-6989586621683132764"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-831"></a><span>
</span><a name="line-832"></a><span class="hs-comment">--------- Potentially kind-polymorphic types: call the &quot;up&quot; checker</span><span>
</span><a name="line-833"></a><span class="hs-comment">-- See Note [Future-proofing the type checker]</span><span>
</span><a name="line-834"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132765"><a href="#local-6989586621683132765"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132766"><a href="#local-6989586621683132766"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTyVar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><a name="local-6989586621683132767"><a href="#local-6989586621683132767"><span class="hs-identifier">ek</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_hs_type_ek"><span class="hs-identifier hs-var">tc_infer_hs_type_ek</span></a><span> </span><a href="#local-6989586621683132765"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132766"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132767"><span class="hs-identifier hs-var">ek</span></a><span>
</span><a name="line-835"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132768"><a href="#local-6989586621683132768"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132769"><a href="#local-6989586621683132769"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><a name="local-6989586621683132770"><a href="#local-6989586621683132770"><span class="hs-identifier">ek</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_hs_type_ek"><span class="hs-identifier hs-var">tc_infer_hs_type_ek</span></a><span> </span><a href="#local-6989586621683132768"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132769"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132770"><span class="hs-identifier hs-var">ek</span></a><span>
</span><a name="line-836"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132771"><a href="#local-6989586621683132771"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132772"><a href="#local-6989586621683132772"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppKindTy</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132773"><a href="#local-6989586621683132773"><span class="hs-identifier">ek</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_hs_type_ek"><span class="hs-identifier hs-var">tc_infer_hs_type_ek</span></a><span> </span><a href="#local-6989586621683132771"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132772"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132773"><span class="hs-identifier hs-var">ek</span></a><span>
</span><a name="line-837"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132774"><a href="#local-6989586621683132774"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132775"><a href="#local-6989586621683132775"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOpTy</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><a name="local-6989586621683132776"><a href="#local-6989586621683132776"><span class="hs-identifier">ek</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_hs_type_ek"><span class="hs-identifier hs-var">tc_infer_hs_type_ek</span></a><span> </span><a href="#local-6989586621683132774"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132775"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132776"><span class="hs-identifier hs-var">ek</span></a><span>
</span><a name="line-838"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132777"><a href="#local-6989586621683132777"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132778"><a href="#local-6989586621683132778"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsKindSig</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132779"><a href="#local-6989586621683132779"><span class="hs-identifier">ek</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_hs_type_ek"><span class="hs-identifier hs-var">tc_infer_hs_type_ek</span></a><span> </span><a href="#local-6989586621683132777"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132778"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132779"><span class="hs-identifier hs-var">ek</span></a><span>
</span><a name="line-839"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132780"><a href="#local-6989586621683132780"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132781"><a href="#local-6989586621683132781"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NHsCoreTy</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132782"><a href="#local-6989586621683132782"><span class="hs-identifier">ek</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_infer_hs_type_ek"><span class="hs-identifier hs-var">tc_infer_hs_type_ek</span></a><span> </span><a href="#local-6989586621683132780"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132781"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132782"><span class="hs-identifier hs-var">ek</span></a><span>
</span><a name="line-840"></a><span>
</span><a name="line-841"></a><span class="hs-identifier">tc_hs_type</span><span> </span><a name="local-6989586621683132783"><a href="#local-6989586621683132783"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132784"><a href="#local-6989586621683132784"><span class="hs-identifier">wc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWildCardTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132785"><a href="#local-6989586621683132785"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-842"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132786"><a href="#local-6989586621683132786"><span class="hs-identifier">wc_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcWildCardOcc"><span class="hs-identifier hs-var">tcWildCardOcc</span></a><span> </span><a href="#local-6989586621683132783"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132784"><span class="hs-identifier hs-var">wc</span></a><span> </span><a href="#local-6989586621683132785"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-843"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNakedCastTy</span><span> </span><a href="#local-6989586621683132786"><span class="hs-identifier hs-var">wc_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcNomReflCo</span><span> </span><a href="#local-6989586621683132785"><span class="hs-identifier hs-var">exp_kind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-844"></a><span>         </span><span class="hs-comment">-- Take care here! Even though the coercion is Refl,</span><span>
</span><a name="line-845"></a><span>         </span><span class="hs-comment">-- we still need it to establish Note [The tcType invariant]</span><span>
</span><a name="line-846"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-847"></a><span>
</span><a name="line-848"></a><span class="hs-identifier">tcWildCardOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-849"></a><a name="tcWildCardOcc"><a href="TcHsType.html#tcWildCardOcc"><span class="hs-identifier">tcWildCardOcc</span></a></a><span> </span><a name="local-6989586621683132787"><a href="#local-6989586621683132787"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132788"><a href="#local-6989586621683132788"><span class="hs-identifier">wc</span></a></a><span> </span><a name="local-6989586621683132789"><a href="#local-6989586621683132789"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-850"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132790"><a href="#local-6989586621683132790"><span class="hs-identifier">wc_tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#newWildTyVar"><span class="hs-identifier hs-var">newWildTyVar</span></a><span>
</span><a name="line-851"></a><span>          </span><span class="hs-comment">-- The wildcard's kind should be an un-filled-in meta tyvar</span><span>
</span><a name="line-852"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132791"><a href="#local-6989586621683132791"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-853"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132792"><a href="#local-6989586621683132792"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-854"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132793"><a href="#local-6989586621683132793"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInternalName</span><span> </span><a href="#local-6989586621683132792"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarOcc</span><span> </span><span class="hs-string">&quot;_&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132791"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-855"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132794"><a href="#local-6989586621683132794"><span class="hs-identifier">part_tysig</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.PartialTypeSignatures</span><span>
</span><a name="line-856"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132795"><a href="#local-6989586621683132795"><span class="hs-identifier">warning</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnPartialTypeSignatures</span><span>
</span><a name="line-857"></a><span>       </span><span class="hs-comment">-- See Note [Wildcards in visible kind application]</span><span>
</span><a name="line-858"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132794"><span class="hs-identifier hs-var">part_tysig</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621683132795"><span class="hs-identifier hs-var">warning</span></a><span class="hs-special">)</span><span>
</span><a name="line-859"></a><span>             </span><span class="hs-special">(</span><a href="TcRnMonad.html#emitWildCardHoleConstraints"><span class="hs-identifier hs-var">emitWildCardHoleConstraints</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683132793"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><a href="#local-6989586621683132790"><span class="hs-identifier hs-var">wc_tv</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132787"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132788"><span class="hs-identifier hs-var">wc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621683132790"><span class="hs-identifier hs-var">wc_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-861"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683132790"><span class="hs-identifier hs-var">wc_tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132789"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-862"></a><span>
</span><a name="line-863"></a><span class="hs-comment">{- Note [Wildcards in visible kind application]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There are cases where users might want to pass in a wildcard as a visible kind
argument, for instance:

data T :: forall k1 k2. k1 &#8594; k2 &#8594; Type where
  MkT :: T a b
x :: T @_ @Nat False n
x = MkT

So we should allow '@_' without emitting any hole constraints, and
regardless of whether PartialTypeSignatures is enabled or not. But how would
the typechecker know which '_' is being used in VKA and which is not when it
calls emitWildCardHoleConstraints in tcHsPartialSigType on all HsWildCardBndrs?
The solution then is to neither rename nor include unnamed wildcards in HsWildCardBndrs,
but instead give every unnamed wildcard a fresh wild tyvar in tcWildCardOcc.
And whenever we see a '@', we automatically turn on PartialTypeSignatures and
turn off hole constraint warnings, and never call emitWildCardHoleConstraints
under these conditions.
See related Note [Wildcards in visible type application] here and
Note [The wildcard story for types] in HsTypes.hs

-}</span><span>
</span><a name="line-886"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- | Call 'tc_infer_hs_type' and check its result against an expected kind.</span><span>
</span><a name="line-888"></a><span class="hs-identifier">tc_infer_hs_type_ek</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasDebugCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-889"></a><a name="tc_infer_hs_type_ek"><a href="TcHsType.html#tc_infer_hs_type_ek"><span class="hs-identifier">tc_infer_hs_type_ek</span></a></a><span> </span><a name="local-6989586621683132796"><a href="#local-6989586621683132796"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132797"><a href="#local-6989586621683132797"><span class="hs-identifier">hs_ty</span></a></a><span> </span><a name="local-6989586621683132798"><a href="#local-6989586621683132798"><span class="hs-identifier">ek</span></a></a><span>
</span><a name="line-890"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132799"><a href="#local-6989586621683132799"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132800"><a href="#local-6989586621683132800"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_infer_hs_type"><span class="hs-identifier hs-var">tc_infer_hs_type</span></a><span> </span><a href="#local-6989586621683132796"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132797"><span class="hs-identifier hs-var">hs_ty</span></a><span>
</span><a name="line-891"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132796"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132797"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132799"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132800"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621683132798"><span class="hs-identifier hs-var">ek</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-894"></a><span class="hs-identifier">tupKindSort_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TupleSort</span><span>
</span><a name="line-895"></a><a name="tupKindSort_maybe"><a href="TcHsType.html#tupKindSort_maybe"><span class="hs-identifier">tupKindSort_maybe</span></a></a><span> </span><a name="local-6989586621683132801"><a href="#local-6989586621683132801"><span class="hs-identifier">k</span></a></a><span>
</span><a name="line-896"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132802"><a href="#local-6989586621683132802"><span class="hs-identifier">k'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitCastTy_maybe</span><span> </span><a href="#local-6989586621683132801"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tupKindSort_maybe"><span class="hs-identifier hs-var">tupKindSort_maybe</span></a><span> </span><a href="#local-6989586621683132802"><span class="hs-identifier hs-var">k'</span></a><span>
</span><a name="line-897"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683132803"><a href="#local-6989586621683132803"><span class="hs-identifier">k'</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcView</span><span> </span><a href="#local-6989586621683132801"><span class="hs-identifier hs-var">k</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tupKindSort_maybe"><span class="hs-identifier hs-var">tupKindSort_maybe</span></a><span> </span><a href="#local-6989586621683132803"><span class="hs-identifier hs-var">k'</span></a><span>
</span><a name="line-898"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tcIsConstraintKind</span><span> </span><a href="#local-6989586621683132801"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">ConstraintTuple</span><span>
</span><a name="line-899"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tcIsLiftedTypeKind</span><span> </span><a href="#local-6989586621683132801"><span class="hs-identifier hs-var">k</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">BoxedTuple</span><span>
</span><a name="line-900"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-901"></a><span>
</span><a name="line-902"></a><span class="hs-identifier">tc_tuple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TupleSort</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-903"></a><a name="tc_tuple"><a href="TcHsType.html#tc_tuple"><span class="hs-identifier">tc_tuple</span></a></a><span> </span><a name="local-6989586621683132804"><a href="#local-6989586621683132804"><span class="hs-identifier">rn_ty</span></a></a><span> </span><a name="local-6989586621683132805"><a href="#local-6989586621683132805"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132806"><a href="#local-6989586621683132806"><span class="hs-identifier">tup_sort</span></a></a><span> </span><a name="local-6989586621683132807"><a href="#local-6989586621683132807"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621683132808"><a href="#local-6989586621683132808"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-904"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132810"><a href="#local-6989586621683132810"><span class="hs-identifier">arg_kinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132806"><span class="hs-identifier hs-var">tup_sort</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-905"></a><span>           </span><span class="hs-identifier hs-var">BoxedTuple</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nOfThem</span><span> </span><a href="#local-6989586621683132809"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>           </span><span class="hs-identifier hs-var">UnboxedTuple</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#newOpenTypeKind"><span class="hs-identifier hs-var">newOpenTypeKind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132807"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-907"></a><span>           </span><span class="hs-identifier hs-var">ConstraintTuple</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nOfThem</span><span> </span><a href="#local-6989586621683132809"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-identifier hs-var">constraintKind</span><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132811"><a href="#local-6989586621683132811"><span class="hs-identifier">tau_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132805"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132807"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621683132810"><span class="hs-identifier hs-var">arg_kinds</span></a><span>
</span><a name="line-909"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#finish_tuple"><span class="hs-identifier hs-var">finish_tuple</span></a><span> </span><a href="#local-6989586621683132804"><span class="hs-identifier hs-var">rn_ty</span></a><span> </span><a href="#local-6989586621683132805"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132806"><span class="hs-identifier hs-var">tup_sort</span></a><span> </span><a href="#local-6989586621683132811"><span class="hs-identifier hs-var">tau_tys</span></a><span> </span><a href="#local-6989586621683132810"><span class="hs-identifier hs-var">arg_kinds</span></a><span> </span><a href="#local-6989586621683132808"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-910"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-911"></a><span>    </span><a name="local-6989586621683132809"><a href="#local-6989586621683132809"><span class="hs-identifier">arity</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683132807"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span class="hs-identifier">finish_tuple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-914"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span>
</span><a name="line-915"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TupleSort</span><span>
</span><a name="line-916"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- ^ argument types</span><span>
</span><a name="line-917"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- ^ of these kinds</span><span>
</span><a name="line-918"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>      </span><span class="hs-comment">-- ^ expected kind of the whole tuple</span><span>
</span><a name="line-919"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-920"></a><a name="finish_tuple"><a href="TcHsType.html#finish_tuple"><span class="hs-identifier">finish_tuple</span></a></a><span> </span><a name="local-6989586621683132812"><a href="#local-6989586621683132812"><span class="hs-identifier">rn_ty</span></a></a><span> </span><a name="local-6989586621683132813"><a href="#local-6989586621683132813"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132814"><a href="#local-6989586621683132814"><span class="hs-identifier">tup_sort</span></a></a><span> </span><a name="local-6989586621683132815"><a href="#local-6989586621683132815"><span class="hs-identifier">tau_tys</span></a></a><span> </span><a name="local-6989586621683132816"><a href="#local-6989586621683132816"><span class="hs-identifier">tau_kinds</span></a></a><span> </span><a name="local-6989586621683132817"><a href="#local-6989586621683132817"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-921"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;finish_tuple&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132820"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132816"><span class="hs-identifier hs-var">tau_kinds</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132817"><span class="hs-identifier hs-var">exp_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132821"><a href="#local-6989586621683132821"><span class="hs-identifier">arg_tys</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132814"><span class="hs-identifier hs-var">tup_sort</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-923"></a><span>                   </span><span class="hs-comment">-- See also Note [Unboxed tuple RuntimeRep vars] in TyCon</span><span>
</span><a name="line-924"></a><span>                 </span><span class="hs-identifier hs-var">UnboxedTuple</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132819"><span class="hs-identifier hs-var">tau_reps</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683132815"><span class="hs-identifier hs-var">tau_tys</span></a><span>
</span><a name="line-925"></a><span>                 </span><span class="hs-identifier hs-var">BoxedTuple</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132815"><span class="hs-identifier hs-var">tau_tys</span></a><span>
</span><a name="line-926"></a><span>                 </span><span class="hs-identifier hs-var">ConstraintTuple</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132815"><span class="hs-identifier hs-var">tau_tys</span></a><span>
</span><a name="line-927"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132823"><a href="#local-6989586621683132823"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132814"><span class="hs-identifier hs-var">tup_sort</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-928"></a><span>           </span><span class="hs-identifier hs-var">ConstraintTuple</span><span>
</span><a name="line-929"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683132818"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier hs-var">mAX_CTUPLE_SIZE</span><span>
</span><a name="line-930"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#bigConstraintTuple"><span class="hs-identifier hs-var">bigConstraintTuple</span></a><span> </span><a href="#local-6989586621683132818"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-931"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cTupleTyConName</span><span> </span><a href="#local-6989586621683132818"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-932"></a><span>           </span><span class="hs-identifier hs-var">BoxedTuple</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132822"><a href="#local-6989586621683132822"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tupleTyCon</span><span> </span><span class="hs-identifier hs-var">Boxed</span><span> </span><a href="#local-6989586621683132818"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-933"></a><span>                               </span><span class="hs-special">;</span><span> </span><a href="LoadIface.html#checkWiredInTyCon"><span class="hs-identifier hs-var">checkWiredInTyCon</span></a><span> </span><a href="#local-6989586621683132822"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-934"></a><span>                               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683132822"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-935"></a><span>           </span><span class="hs-identifier hs-var">UnboxedTuple</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleTyCon</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><a href="#local-6989586621683132818"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier hs-var">checkExpectedKindMode</span></a><span> </span><a href="#local-6989586621683132813"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132812"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683132823"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621683132821"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132820"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><a href="#local-6989586621683132817"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-937"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-938"></a><span>    </span><a name="local-6989586621683132818"><a href="#local-6989586621683132818"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683132815"><span class="hs-identifier hs-var">tau_tys</span></a><span>
</span><a name="line-939"></a><span>    </span><a name="local-6989586621683132819"><a href="#local-6989586621683132819"><span class="hs-identifier">tau_reps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">kindRep</span><span> </span><a href="#local-6989586621683132816"><span class="hs-identifier hs-var">tau_kinds</span></a><span>
</span><a name="line-940"></a><span>    </span><a name="local-6989586621683132820"><a href="#local-6989586621683132820"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132814"><span class="hs-identifier hs-var">tup_sort</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-941"></a><span>                 </span><span class="hs-identifier hs-var">UnboxedTuple</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">unboxedTupleKind</span><span> </span><a href="#local-6989586621683132819"><span class="hs-identifier hs-var">tau_reps</span></a><span>
</span><a name="line-942"></a><span>                 </span><span class="hs-identifier hs-var">BoxedTuple</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-943"></a><span>                 </span><span class="hs-identifier hs-var">ConstraintTuple</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">constraintKind</span><span>
</span><a name="line-944"></a><span>
</span><a name="line-945"></a><span class="hs-identifier">bigConstraintTuple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Arity</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span>
</span><a name="line-946"></a><a name="bigConstraintTuple"><a href="TcHsType.html#bigConstraintTuple"><span class="hs-identifier">bigConstraintTuple</span></a></a><span> </span><a name="local-6989586621683132824"><a href="#local-6989586621683132824"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-947"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Constraint tuple arity too large:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621683132824"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-948"></a><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;max arity =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><span class="hs-identifier hs-var">mAX_CTUPLE_SIZE</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-949"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Instead, use a nested tuple&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-950"></a><span>
</span><a name="line-951"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-952"></a><span class="hs-comment">-- | Apply a type of a given kind to a list of arguments. This instantiates</span><span>
</span><a name="line-953"></a><span class="hs-comment">-- invisible parameters as necessary. Always consumes all the arguments,</span><span>
</span><a name="line-954"></a><span class="hs-comment">-- using matchExpectedFunKind as necessary.</span><span>
</span><a name="line-955"></a><span class="hs-comment">-- This takes an optional @VarEnv Kind@ which maps kind variables to kinds.-</span><span>
</span><a name="line-956"></a><span class="hs-comment">-- These kinds should be used to instantiate invisible kind variables;</span><span>
</span><a name="line-957"></a><span class="hs-comment">-- they come from an enclosing class for an associated type/data family.</span><span>
</span><a name="line-958"></a><span class="hs-identifier">tcInferApps</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span>
</span><a name="line-959"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>        </span><span class="hs-comment">-- ^ Function (for printing only)</span><span>
</span><a name="line-960"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>               </span><span class="hs-comment">-- ^ Function</span><span>
</span><a name="line-961"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>               </span><span class="hs-comment">-- ^ Function kind (zonked)</span><span>
</span><a name="line-962"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTypeArg</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- ^ Args</span><span>
</span><a name="line-963"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ (f args, args, result kind)</span><span>
</span><a name="line-964"></a><span class="hs-comment">-- Precondition: tcTypeKind fun_ty = fun_ki</span><span>
</span><a name="line-965"></a><span class="hs-comment">--    Reason: we will return a type application like (fun_ty arg1 ... argn),</span><span>
</span><a name="line-966"></a><span class="hs-comment">--            and that type must be well-kinded</span><span>
</span><a name="line-967"></a><span class="hs-comment">--            See Note [The tcType invariant]</span><span>
</span><a name="line-968"></a><span class="hs-comment">-- Postcondition: Result kind is zonked.</span><span>
</span><a name="line-969"></a><a name="tcInferApps"><a href="TcHsType.html#tcInferApps"><span class="hs-identifier">tcInferApps</span></a></a><span> </span><a name="local-6989586621683132825"><a href="#local-6989586621683132825"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132826"><a href="#local-6989586621683132826"><span class="hs-identifier">orig_hs_ty</span></a></a><span> </span><a name="local-6989586621683132827"><a href="#local-6989586621683132827"><span class="hs-identifier">fun_ty</span></a></a><span> </span><a name="local-6989586621683132828"><a href="#local-6989586621683132828"><span class="hs-identifier">fun_ki</span></a></a><span> </span><a name="local-6989586621683132829"><a href="#local-6989586621683132829"><span class="hs-identifier">orig_hs_args</span></a></a><span>
</span><a name="line-970"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps {&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132826"><span class="hs-identifier hs-var">orig_hs_ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132829"><span class="hs-identifier hs-var">orig_hs_args</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132828"><span class="hs-identifier hs-var">fun_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132886"><a href="#local-6989586621683132886"><span class="hs-identifier">f_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132887"><a href="#local-6989586621683132887"><span class="hs-identifier">res_k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132833"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621683132830"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621683132827"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621683132831"><span class="hs-identifier hs-var">orig_ki_binders</span></a><span> </span><a href="#local-6989586621683132832"><span class="hs-identifier hs-var">orig_inner_ki</span></a><span> </span><a href="#local-6989586621683132829"><span class="hs-identifier hs-var">orig_hs_args</span></a><span>
</span><a name="line-972"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps }&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-973"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132888"><a href="#local-6989586621683132888"><span class="hs-identifier">res_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683132887"><span class="hs-identifier hs-var">res_k</span></a><span>  </span><span class="hs-comment">-- Uphold (IT4) of Note [The tcType invariant]</span><span>
</span><a name="line-974"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132886"><span class="hs-identifier hs-var">f_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132888"><span class="hs-identifier hs-var">res_k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-975"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-976"></a><span>    </span><a name="local-6989586621683132830"><a href="#local-6989586621683132830"><span class="hs-identifier">empty_subst</span></a></a><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-977"></a><span>                                       </span><span class="hs-identifier hs-var">tyCoVarsOfType</span><span> </span><a href="#local-6989586621683132828"><span class="hs-identifier hs-var">fun_ki</span></a><span>
</span><a name="line-978"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683132831"><a href="#local-6989586621683132831"><span class="hs-identifier">orig_ki_binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132832"><a href="#local-6989586621683132832"><span class="hs-identifier">orig_inner_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitPiTys</span><span> </span><a href="#local-6989586621683132828"><span class="hs-identifier hs-var">fun_ki</span></a><span>
</span><a name="line-979"></a><span>
</span><a name="line-980"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>             </span><span class="hs-comment">-- the # of the next argument</span><span>
</span><a name="line-981"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span>        </span><span class="hs-comment">-- instantiating substitution</span><span>
</span><a name="line-982"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>          </span><span class="hs-comment">-- function applied to some args</span><span>
</span><a name="line-983"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyBinder</span><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- binders in function kind (both vis. and invis.)</span><span>
</span><a name="line-984"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>          </span><span class="hs-comment">-- function kind body (not a Pi-type)</span><span>
</span><a name="line-985"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTypeArg</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- un-type-checked args</span><span>
</span><a name="line-986"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- same as overall return type</span><span>
</span><a name="line-987"></a><span>
</span><a name="line-988"></a><span>      </span><span class="hs-comment">-- no user-written args left. We're done!</span><span>
</span><a name="line-989"></a><span>    </span><a name="local-6989586621683132833"><a href="#local-6989586621683132833"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132835"><a href="#local-6989586621683132835"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621683132836"><a href="#local-6989586621683132836"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683132837"><a href="#local-6989586621683132837"><span class="hs-identifier">ki_binders</span></a></a><span> </span><a name="local-6989586621683132838"><a href="#local-6989586621683132838"><span class="hs-identifier">inner_ki</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-990"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621683132836"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-991"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nakedSubstTy</span><span> </span><a href="#local-6989586621683132835"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPiTys</span><span> </span><a href="#local-6989586621683132837"><span class="hs-identifier hs-var">ki_binders</span></a><span> </span><a href="#local-6989586621683132838"><span class="hs-identifier hs-var">inner_ki</span></a><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>                 </span><span class="hs-comment">-- nakedSubstTy: see Note [The well-kinded type invariant]</span><span>
</span><a name="line-993"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683132839"><a href="#local-6989586621683132839"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683132840"><a href="#local-6989586621683132840"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621683132841"><a href="#local-6989586621683132841"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683132842"><a href="#local-6989586621683132842"><span class="hs-identifier">all_kindbinder</span></a></a><span> </span><a name="local-6989586621683132843"><a href="#local-6989586621683132843"><span class="hs-identifier">inner_ki</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><a name="local-6989586621683132844"><a href="#local-6989586621683132844"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132833"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683132839"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683132840"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683132841"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683132842"><span class="hs-identifier hs-var">all_kindbinder</span></a><span> </span><a href="#local-6989586621683132843"><span class="hs-identifier hs-var">inner_ki</span></a><span> </span><a href="#local-6989586621683132844"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-995"></a><span>      </span><span class="hs-comment">-- The function's kind has a binder. Is it visible or invisible?</span><span>
</span><a name="line-996"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683132845"><a href="#local-6989586621683132845"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683132846"><a href="#local-6989586621683132846"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621683132847"><a href="#local-6989586621683132847"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683132848"><a href="#local-6989586621683132848"><span class="hs-identifier">all_kindbinder</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683132849"><a href="#local-6989586621683132849"><span class="hs-identifier">ki_binder</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683132850"><a href="#local-6989586621683132850"><span class="hs-identifier">ki_binders</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132851"><a href="#local-6989586621683132851"><span class="hs-identifier">inner_ki</span></a></a><span>
</span><a name="line-997"></a><span>       </span><a name="local-6989586621683132852"><a href="#local-6989586621683132852"><span class="hs-identifier">all_args</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683132853"><a href="#local-6989586621683132853"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683132854"><a href="#local-6989586621683132854"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Specified</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyCoBinderArgFlag</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span>
</span><a name="line-999"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132855"><a href="#local-6989586621683132855"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132853"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1000"></a><span>         </span><span class="hs-comment">-- Invisible and specified binder with visible kind argument</span><span>
</span><a name="line-1001"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps (vis kind app)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132855"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-1002"></a><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyBinderType</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span class="hs-special">)</span><span>
</span><a name="line-1003"></a><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoBinderArgFlag</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1004"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132856"><a href="#local-6989586621683132856"><span class="hs-identifier">exp_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nakedSubstTy</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tyBinderType</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span>
</span><a name="line-1005"></a><span>                    </span><span class="hs-comment">-- nakedSubstTy: see Note [The well-kinded type invariant]</span><span>
</span><a name="line-1006"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132857"><a href="#local-6989586621683132857"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#funAppCtxt"><span class="hs-identifier hs-var">funAppCtxt</span></a><span> </span><a href="#local-6989586621683132826"><span class="hs-identifier hs-var">orig_hs_ty</span></a><span> </span><a href="#local-6989586621683132855"><span class="hs-identifier hs-var">ki</span></a><span> </span><a href="#local-6989586621683132845"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1007"></a><span>                            </span><a href="TcRnMonad.html#unsetWOptM"><span class="hs-identifier hs-var">unsetWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnPartialTypeSignatures</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1008"></a><span>                            </span><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier hs-var">setXOptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.PartialTypeSignatures</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1009"></a><span>                            </span><span class="hs-comment">-- see Note [Wildcards in visible kind application]</span><span>
</span><a name="line-1010"></a><span>                            </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#kindLevel"><span class="hs-identifier hs-var">kindLevel</span></a><span> </span><a href="#local-6989586621683132825"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132855"><span class="hs-identifier hs-var">ki</span></a><span> </span><a href="#local-6989586621683132856"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-1011"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps (vis kind app)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132856"><span class="hs-identifier hs-var">exp_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1012"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132858"><a href="#local-6989586621683132858"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTvSubstBinderAndInScope</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span> </span><a href="#local-6989586621683132857"><span class="hs-identifier hs-var">arg'</span></a><span>
</span><a name="line-1013"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683132833"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132845"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132858"><span class="hs-identifier hs-var">subst'</span></a><span>
</span><a name="line-1014"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNakedAppTy</span><span> </span><a href="#local-6989586621683132847"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683132857"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1015"></a><span>                       </span><a href="#local-6989586621683132850"><span class="hs-identifier hs-var">ki_binders</span></a><span> </span><a href="#local-6989586621683132851"><span class="hs-identifier hs-var">inner_ki</span></a><span> </span><a href="#local-6989586621683132854"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isInvisibleBinder</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span>
</span><a name="line-1018"></a><span>          </span><span class="hs-comment">-- Instantiate if not specified or if there is no kind application</span><span>
</span><a name="line-1019"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps (invis normal app)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoBinderArgFlag</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132859"><a href="#local-6989586621683132859"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132860"><a href="#local-6989586621683132860"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#tcInstTyBinder"><span class="hs-identifier hs-var">tcInstTyBinder</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span>
</span><a name="line-1021"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683132833"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683132845"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683132859"><span class="hs-identifier hs-var">subst'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNakedAppTy</span><span> </span><a href="#local-6989586621683132847"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683132860"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1022"></a><span>                        </span><a href="#local-6989586621683132850"><span class="hs-identifier hs-var">ki_binders</span></a><span> </span><a href="#local-6989586621683132851"><span class="hs-identifier hs-var">inner_ki</span></a><span> </span><a href="#local-6989586621683132852"><span class="hs-identifier hs-var">all_args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1023"></a><span>
</span><a name="line-1024"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- if binder is visible</span><span>
</span><a name="line-1025"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132853"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1026"></a><span>             </span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a name="local-6989586621683132861"><a href="#local-6989586621683132861"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-comment">-- check the next argument</span><span>
</span><a name="line-1027"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps (vis normal app)&quot;</span><span>
</span><a name="line-1028"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span>
</span><a name="line-1029"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132861"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1030"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyBinderType</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span class="hs-special">)</span><span>
</span><a name="line-1031"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1032"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132862"><a href="#local-6989586621683132862"><span class="hs-identifier">exp_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nakedSubstTy</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tyBinderType</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span>
</span><a name="line-1033"></a><span>                     </span><span class="hs-comment">-- nakedSubstTy: see Note [The well-kinded type invariant]</span><span>
</span><a name="line-1034"></a><span>                     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132863"><a href="#local-6989586621683132863"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#funAppCtxt"><span class="hs-identifier hs-var">funAppCtxt</span></a><span> </span><a href="#local-6989586621683132826"><span class="hs-identifier hs-var">orig_hs_ty</span></a><span> </span><a href="#local-6989586621683132861"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132845"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1035"></a><span>                               </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132825"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132861"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683132862"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-1036"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps (vis normal app)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132862"><span class="hs-identifier hs-var">exp_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1037"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132864"><a href="#local-6989586621683132864"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTvSubstBinderAndInScope</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span> </span><a href="#local-6989586621683132863"><span class="hs-identifier hs-var">arg'</span></a><span>
</span><a name="line-1038"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683132833"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132845"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132864"><span class="hs-identifier hs-var">subst'</span></a><span>
</span><a name="line-1039"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNakedAppTy</span><span> </span><a href="#local-6989586621683132847"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683132863"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1040"></a><span>                          </span><a href="#local-6989586621683132850"><span class="hs-identifier hs-var">ki_binders</span></a><span> </span><a href="#local-6989586621683132851"><span class="hs-identifier hs-var">inner_ki</span></a><span> </span><a href="#local-6989586621683132854"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1041"></a><span>            </span><span class="hs-comment">-- error if the argument is a kind application</span><span>
</span><a name="line-1042"></a><span>             </span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132865"><a href="#local-6989586621683132865"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps (error)&quot;</span><span>
</span><a name="line-1043"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span>
</span><a name="line-1044"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132865"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-1045"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyBinderType</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span class="hs-special">)</span><span>
</span><a name="line-1046"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-1047"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isInvisibleBinder</span><span> </span><a href="#local-6989586621683132849"><span class="hs-identifier hs-var">ki_binder</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1048"></a><span>                                  </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683132834"><span class="hs-identifier hs-var">ty_app_err</span></a><span> </span><a href="#local-6989586621683132865"><span class="hs-identifier hs-var">ki</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nakedSubstTy</span><span> </span><a href="#local-6989586621683132846"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1049"></a><span>                                                  </span><span class="hs-identifier hs-var">mkPiTys</span><span> </span><a href="#local-6989586621683132848"><span class="hs-identifier hs-var">all_kindbinder</span></a><span> </span><a href="#local-6989586621683132851"><span class="hs-identifier hs-var">inner_ki</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1050"></a><span>
</span><a name="line-1051"></a><span>             </span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcInferApps&quot;</span><span>  </span><span class="hs-comment">-- handled in separate clause of &quot;go&quot;</span><span>
</span><a name="line-1052"></a><span>
</span><a name="line-1053"></a><span>       </span><span class="hs-comment">-- We've run out of known binders in the functions's kind.</span><span>
</span><a name="line-1054"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683132866"><a href="#local-6989586621683132866"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683132867"><a href="#local-6989586621683132867"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621683132868"><a href="#local-6989586621683132868"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621683132869"><a href="#local-6989586621683132869"><span class="hs-identifier">inner_ki</span></a></a><span> </span><a name="local-6989586621683132870"><a href="#local-6989586621683132870"><span class="hs-identifier">all_args</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683132871"><a href="#local-6989586621683132871"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683132872"><a href="#local-6989586621683132872"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1055"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683132874"><span class="hs-identifier hs-var">new_ki_binders</span></a><span class="hs-special">)</span><span>
</span><a name="line-1056"></a><span>         </span><span class="hs-comment">-- But, after substituting, we have more binders.</span><span>
</span><a name="line-1057"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132833"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683132866"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683132876"><span class="hs-identifier hs-var">zapped_subst</span></a><span> </span><a href="#local-6989586621683132868"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621683132874"><span class="hs-identifier hs-var">new_ki_binders</span></a><span> </span><a href="#local-6989586621683132875"><span class="hs-identifier hs-var">new_inner_ki</span></a><span> </span><a href="#local-6989586621683132870"><span class="hs-identifier hs-var">all_args</span></a><span>
</span><a name="line-1058"></a><span>
</span><a name="line-1059"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1060"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132871"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1061"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1062"></a><span>         </span><span class="hs-comment">-- Even after substituting, still no binders. Use matchExpectedFunKind</span><span>
</span><a name="line-1063"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInferApps (no binder)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132875"><span class="hs-identifier hs-var">new_inner_ki</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132876"><span class="hs-identifier hs-var">zapped_subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-1064"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132878"><a href="#local-6989586621683132878"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132879"><a href="#local-6989586621683132879"><span class="hs-identifier">arg_k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132880"><a href="#local-6989586621683132880"><span class="hs-identifier">res_k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedFunKind"><span class="hs-identifier hs-var">matchExpectedFunKind</span></a><span> </span><a href="#local-6989586621683132877"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621683132873"><span class="hs-identifier hs-var">substed_inner_ki</span></a><span>
</span><a name="line-1065"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132881"><a href="#local-6989586621683132881"><span class="hs-identifier">new_in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683132879"><span class="hs-identifier hs-var">arg_k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132880"><span class="hs-identifier hs-var">res_k</span></a><span class="hs-special">]</span><span>
</span><a name="line-1066"></a><span>                     </span><a name="local-6989586621683132882"><a href="#local-6989586621683132882"><span class="hs-identifier">subst'</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132876"><span class="hs-identifier hs-var">zapped_subst</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendTCvInScopeSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683132881"><span class="hs-identifier hs-var">new_in_scope</span></a><span>
</span><a name="line-1067"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683132833"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683132866"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683132882"><span class="hs-identifier hs-var">subst'</span></a><span>
</span><a name="line-1068"></a><span>                    </span><span class="hs-special">(</span><a href="#local-6989586621683132868"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkNakedCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683132878"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [The well-kinded type invariant]</span><span>
</span><a name="line-1069"></a><span>                    </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkAnonBinder</span><span> </span><a href="#local-6989586621683132879"><span class="hs-identifier hs-var">arg_k</span></a><span class="hs-special">]</span><span>
</span><a name="line-1070"></a><span>                    </span><a href="#local-6989586621683132880"><span class="hs-identifier hs-var">res_k</span></a><span> </span><a href="#local-6989586621683132870"><span class="hs-identifier hs-var">all_args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1071"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132883"><a href="#local-6989586621683132883"><span class="hs-identifier">ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132834"><span class="hs-identifier hs-var">ty_app_err</span></a><span> </span><a href="#local-6989586621683132883"><span class="hs-identifier hs-var">ki</span></a><span> </span><a href="#local-6989586621683132873"><span class="hs-identifier hs-var">substed_inner_ki</span></a><span>
</span><a name="line-1072"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132833"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683132866"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683132867"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683132868"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683132869"><span class="hs-identifier hs-var">inner_ki</span></a><span> </span><a href="#local-6989586621683132872"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1073"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1074"></a><span>        </span><a name="local-6989586621683132873"><a href="#local-6989586621683132873"><span class="hs-identifier">substed_inner_ki</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683132867"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683132869"><span class="hs-identifier hs-var">inner_ki</span></a><span>
</span><a name="line-1075"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683132874"><a href="#local-6989586621683132874"><span class="hs-identifier">new_ki_binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132875"><a href="#local-6989586621683132875"><span class="hs-identifier">new_inner_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitPiTys</span><span> </span><a href="#local-6989586621683132873"><span class="hs-identifier hs-var">substed_inner_ki</span></a><span>
</span><a name="line-1076"></a><span>        </span><a name="local-6989586621683132876"><a href="#local-6989586621683132876"><span class="hs-identifier">zapped_subst</span></a></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zapTCvSubst</span><span> </span><a href="#local-6989586621683132867"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-1077"></a><span>        </span><a name="local-6989586621683132877"><a href="#local-6989586621683132877"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#appTypeToArg"><span class="hs-identifier hs-var">appTypeToArg</span></a><span> </span><a href="#local-6989586621683132826"><span class="hs-identifier hs-var">orig_hs_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">take</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132866"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132829"><span class="hs-identifier hs-var">orig_hs_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1078"></a><span>
</span><a name="line-1079"></a><span>    </span><a name="local-6989586621683132834"><a href="#local-6989586621683132834"><span class="hs-identifier">ty_app_err</span></a></a><span> </span><a name="local-6989586621683132884"><a href="#local-6989586621683132884"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621683132885"><a href="#local-6989586621683132885"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cannot apply function of kind&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132885"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1080"></a><span>                           </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to visible kind argument&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132884"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1081"></a><span>
</span><a name="line-1082"></a><span class="hs-identifier">appTypeToArg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTypeArg</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-1083"></a><a name="appTypeToArg"><a href="TcHsType.html#appTypeToArg"><span class="hs-identifier">appTypeToArg</span></a></a><span> </span><a name="local-6989586621683132889"><a href="#local-6989586621683132889"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132889"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-1084"></a><span class="hs-identifier">appTypeToArg</span><span> </span><a name="local-6989586621683132890"><a href="#local-6989586621683132890"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValArg</span><span> </span><a name="local-6989586621683132891"><a href="#local-6989586621683132891"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683132892"><a href="#local-6989586621683132892"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#appTypeToArg"><span class="hs-identifier hs-var">appTypeToArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsAppTy</span><span> </span><a href="#local-6989586621683132890"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683132891"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132892"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1085"></a><span class="hs-identifier">appTypeToArg</span><span> </span><a name="local-6989586621683132893"><a href="#local-6989586621683132893"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTypeArg</span><span> </span><a name="local-6989586621683132894"><a href="#local-6989586621683132894"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683132895"><a href="#local-6989586621683132895"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683132896"><a href="#local-6989586621683132896"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1086"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#appTypeToArg"><span class="hs-identifier hs-var">appTypeToArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsAppKindTy</span><span> </span><a href="#local-6989586621683132894"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683132893"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683132895"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132896"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1087"></a><span class="hs-identifier">appTypeToArg</span><span> </span><a name="local-6989586621683132897"><a href="#local-6989586621683132897"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArgPar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683132898"><a href="#local-6989586621683132898"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#appTypeToArg"><span class="hs-identifier hs-var">appTypeToArg</span></a><span> </span><a href="#local-6989586621683132897"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621683132898"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1088"></a><span>
</span><a name="line-1089"></a><span class="hs-comment">-- | Applies a type to a list of arguments.</span><span>
</span><a name="line-1090"></a><span class="hs-comment">-- Always consumes all the arguments, using 'matchExpectedFunKind' as</span><span>
</span><a name="line-1091"></a><span class="hs-comment">-- necessary. If you wish to apply a type to a list of HsTypes, this is</span><span>
</span><a name="line-1092"></a><span class="hs-comment">-- your function.</span><span>
</span><a name="line-1093"></a><span class="hs-comment">-- Used for type-checking types only.</span><span>
</span><a name="line-1094"></a><span class="hs-identifier">tcTyApps</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span>
</span><a name="line-1095"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>        </span><span class="hs-comment">-- ^ Function (for printing only)</span><span>
</span><a name="line-1096"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>               </span><span class="hs-comment">-- ^ Function</span><span>
</span><a name="line-1097"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>               </span><span class="hs-comment">-- ^ Function kind (zonked)</span><span>
</span><a name="line-1098"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTypeArg</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- ^ Args</span><span>
</span><a name="line-1099"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ (f args, result kind)   result kind is zonked</span><span>
</span><a name="line-1100"></a><span class="hs-comment">-- Precondition: see precondition for tcInferApps</span><span>
</span><a name="line-1101"></a><a name="tcTyApps"><a href="TcHsType.html#tcTyApps"><span class="hs-identifier">tcTyApps</span></a></a><span> </span><a name="local-6989586621683132899"><a href="#local-6989586621683132899"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132900"><a href="#local-6989586621683132900"><span class="hs-identifier">orig_hs_ty</span></a></a><span> </span><a name="local-6989586621683132901"><a href="#local-6989586621683132901"><span class="hs-identifier">fun_ty</span></a></a><span> </span><a name="local-6989586621683132902"><a href="#local-6989586621683132902"><span class="hs-identifier">fun_ki</span></a></a><span> </span><a name="local-6989586621683132903"><a href="#local-6989586621683132903"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1102"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132904"><a href="#local-6989586621683132904"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132905"><a href="#local-6989586621683132905"><span class="hs-identifier">ki'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcInferApps"><span class="hs-identifier hs-var">tcInferApps</span></a><span> </span><a href="#local-6989586621683132899"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132900"><span class="hs-identifier hs-var">orig_hs_ty</span></a><span> </span><a href="#local-6989586621683132901"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621683132902"><span class="hs-identifier hs-var">fun_ki</span></a><span> </span><a href="#local-6989586621683132903"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1103"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132904"><span class="hs-identifier hs-var">ty'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkNakedCastTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkNomReflCo</span><span> </span><a href="#local-6989586621683132905"><span class="hs-identifier hs-var">ki'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132905"><span class="hs-identifier hs-var">ki'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1104"></a><span>          </span><span class="hs-comment">-- The mkNakedCastTy is for (IT3) of Note [The tcType invariant]</span><span>
</span><a name="line-1105"></a><span>
</span><a name="line-1106"></a><span class="hs-identifier">tcTyApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- only HsAppTy or HsAppKindTy</span><span>
</span><a name="line-1107"></a><a name="tcTyApp"><a href="TcHsType.html#tcTyApp"><span class="hs-identifier">tcTyApp</span></a></a><span> </span><a name="local-6989586621683132906"><a href="#local-6989586621683132906"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132907"><a href="#local-6989586621683132907"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-1108"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132908"><a href="#local-6989586621683132908"><span class="hs-identifier">hs_fun_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132909"><a href="#local-6989586621683132909"><span class="hs-identifier">hs_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitHsAppTys</span><span> </span><a href="#local-6989586621683132907"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1109"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132910"><a href="#local-6989586621683132910"><span class="hs-identifier">fun_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132911"><a href="#local-6989586621683132911"><span class="hs-identifier">fun_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tc_infer_lhs_type"><span class="hs-identifier hs-var">tc_infer_lhs_type</span></a><span> </span><a href="#local-6989586621683132906"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132908"><span class="hs-identifier hs-var">hs_fun_ty</span></a><span>
</span><a name="line-1110"></a><span>          </span><span class="hs-comment">-- NB: (IT4) of Note [The tcType invariant] ensures that fun_kind is zonked</span><span>
</span><a name="line-1111"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#tcTyApps"><span class="hs-identifier hs-var">tcTyApps</span></a><span> </span><a href="#local-6989586621683132906"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132908"><span class="hs-identifier hs-var">hs_fun_ty</span></a><span> </span><a href="#local-6989586621683132910"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621683132911"><span class="hs-identifier hs-var">fun_kind</span></a><span> </span><a href="#local-6989586621683132909"><span class="hs-identifier hs-var">hs_args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1112"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-1113"></a><span class="hs-comment">-- Internally-callable version of checkExpectedKind</span><span>
</span><a name="line-1114"></a><span class="hs-identifier">checkExpectedKindMode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasDebugCallStack</span><span>
</span><a name="line-1115"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span>
</span><a name="line-1116"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>        </span><span class="hs-comment">-- type we're checking</span><span>
</span><a name="line-1117"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>      </span><span class="hs-comment">-- type we're checking</span><span>
</span><a name="line-1118"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>      </span><span class="hs-comment">-- kind of that type</span><span>
</span><a name="line-1119"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>      </span><span class="hs-comment">-- expected kind</span><span>
</span><a name="line-1120"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-1121"></a><a name="checkExpectedKindMode"><a href="TcHsType.html#checkExpectedKindMode"><span class="hs-identifier">checkExpectedKindMode</span></a></a><span> </span><a name="local-6989586621683132912"><a href="#local-6989586621683132912"><span class="hs-identifier">mode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#checkExpectedKind"><span class="hs-identifier hs-var">checkExpectedKind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mode_sat</span><span> </span><a href="#local-6989586621683132912"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span>
</span><a name="line-1122"></a><span>
</span><a name="line-1123"></a><span class="hs-comment">-- | This instantiates invisible arguments for the type being checked if it must</span><span>
</span><a name="line-1124"></a><span class="hs-comment">-- be saturated and is not yet saturated. It then calls and uses the result</span><span>
</span><a name="line-1125"></a><span class="hs-comment">-- from checkExpectedKindX to build the final type</span><span>
</span><a name="line-1126"></a><span class="hs-comment">-- Obeys Note [The tcType invariant]</span><span>
</span><a name="line-1127"></a><span class="hs-identifier">checkExpectedKind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasDebugCallStack</span><span>
</span><a name="line-1128"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcHsType.html#RequireSaturation"><span class="hs-identifier hs-type">RequireSaturation</span></a><span>  </span><span class="hs-comment">-- ^ Do we require all type families to be saturated?</span><span>
</span><a name="line-1129"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>           </span><span class="hs-comment">-- ^ type we're checking (for printing)</span><span>
</span><a name="line-1130"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>         </span><span class="hs-comment">-- ^ type we're checking</span><span>
</span><a name="line-1131"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>         </span><span class="hs-comment">-- ^ the known kind of that type</span><span>
</span><a name="line-1132"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>         </span><span class="hs-comment">-- ^ the expected kind</span><span>
</span><a name="line-1133"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-1134"></a><a name="checkExpectedKind"><a href="TcHsType.html#checkExpectedKind"><span class="hs-identifier">checkExpectedKind</span></a></a><span> </span><a name="local-6989586621683132913"><a href="#local-6989586621683132913"><span class="hs-identifier">sat</span></a></a><span> </span><a name="local-6989586621683132914"><a href="#local-6989586621683132914"><span class="hs-identifier">hs_ty</span></a></a><span> </span><a name="local-6989586621683132915"><a href="#local-6989586621683132915"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683132916"><a href="#local-6989586621683132916"><span class="hs-identifier">act</span></a></a><span> </span><a name="local-6989586621683132917"><a href="#local-6989586621683132917"><span class="hs-identifier">exp</span></a></a><span>
</span><a name="line-1135"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132923"><a href="#local-6989586621683132923"><span class="hs-identifier">new_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132924"><a href="#local-6989586621683132924"><span class="hs-identifier">new_act</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitTyConApp_maybe</span><span> </span><a href="#local-6989586621683132915"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1136"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132918"><a href="#local-6989586621683132918"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132919"><a href="#local-6989586621683132919"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1137"></a><span>             </span><span class="hs-comment">-- if the family tycon must be saturated and is not yet satured</span><span>
</span><a name="line-1138"></a><span>             </span><span class="hs-comment">-- If we don't do this, we get #11246</span><span>
</span><a name="line-1139"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="TcHsType.html#YesSaturation"><span class="hs-identifier hs-var">YesSaturation</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683132913"><span class="hs-identifier hs-var">sat</span></a><span>
</span><a name="line-1140"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mightBeUnsaturatedTyCon</span><span> </span><a href="#local-6989586621683132918"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683132919"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621683132918"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1141"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1142"></a><span>                   </span><span class="hs-comment">-- we need to instantiate all invisible arguments up until saturation</span><span>
</span><a name="line-1143"></a><span>                   </span><span class="hs-special">(</span><a name="local-6989586621683132920"><a href="#local-6989586621683132920"><span class="hs-identifier">tc_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132921"><a href="#local-6989586621683132921"><span class="hs-identifier">kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#tcInstTyBinders"><span class="hs-identifier hs-var">tcInstTyBinders</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">splitPiTysInvisibleN</span><span>
</span><a name="line-1144"></a><span>                                                        </span><span class="hs-special">(</span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621683132918"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683132919"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1145"></a><span>                                                        </span><a href="#local-6989586621683132916"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>
</span><a name="line-1146"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132922"><a href="#local-6989586621683132922"><span class="hs-identifier">tc_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683132918"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683132919"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683132920"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-1147"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkExpectedKind:satTyFam&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132918"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132916"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-1148"></a><span>                                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132921"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1149"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132922"><span class="hs-identifier hs-var">tc_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132921"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1150"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132915"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132916"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>
</span><a name="line-1151"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132925"><a href="#local-6989586621683132925"><span class="hs-identifier">new_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132926"><a href="#local-6989586621683132926"><span class="hs-identifier">co_k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#checkExpectedKindX"><span class="hs-identifier hs-var">checkExpectedKindX</span></a><span> </span><a href="#local-6989586621683132914"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621683132924"><span class="hs-identifier hs-var">new_act</span></a><span> </span><a href="#local-6989586621683132917"><span class="hs-identifier hs-var">exp</span></a><span>
</span><a name="line-1152"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132923"><span class="hs-identifier hs-var">new_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkNakedAppTys</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683132925"><span class="hs-identifier hs-var">new_args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkNakedCastTy</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683132926"><span class="hs-identifier hs-var">co_k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1153"></a><span>
</span><a name="line-1154"></a><span class="hs-identifier">checkExpectedKindX</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasDebugCallStack</span><span>
</span><a name="line-1155"></a><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>                 </span><span class="hs-comment">-- HsType whose kind we're checking</span><span>
</span><a name="line-1156"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>               </span><span class="hs-comment">-- the known kind of that type, k</span><span>
</span><a name="line-1157"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span>               </span><span class="hs-comment">-- the expected kind, exp_kind</span><span>
</span><a name="line-1158"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcCoercionN</span><span class="hs-special">)</span><span>
</span><a name="line-1159"></a><span>    </span><span class="hs-comment">-- (the new args, the coercion)</span><span>
</span><a name="line-1160"></a><span class="hs-comment">-- Instantiate a kind (if necessary) and then call unifyType</span><span>
</span><a name="line-1161"></a><span class="hs-comment">--      (checkExpectedKind ty act_kind exp_kind)</span><span>
</span><a name="line-1162"></a><span class="hs-comment">-- checks that the actual kind act_kind is compatible</span><span>
</span><a name="line-1163"></a><span class="hs-comment">--      with the expected kind exp_kind</span><span>
</span><a name="line-1164"></a><a name="checkExpectedKindX"><a href="TcHsType.html#checkExpectedKindX"><span class="hs-identifier">checkExpectedKindX</span></a></a><span> </span><a name="local-6989586621683132927"><a href="#local-6989586621683132927"><span class="hs-identifier">pp_hs_ty</span></a></a><span> </span><a name="local-6989586621683132928"><a href="#local-6989586621683132928"><span class="hs-identifier">act_kind</span></a></a><span> </span><a name="local-6989586621683132929"><a href="#local-6989586621683132929"><span class="hs-identifier">exp_kind</span></a></a><span>
</span><a name="line-1165"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- We need to make sure that both kinds have the same number of implicit</span><span>
</span><a name="line-1166"></a><span>         </span><span class="hs-comment">-- foralls out front. If the actual kind has more, instantiate accordingly.</span><span>
</span><a name="line-1167"></a><span>         </span><span class="hs-comment">-- Otherwise, just pass the type &amp; kind through: the errors are caught</span><span>
</span><a name="line-1168"></a><span>         </span><span class="hs-comment">-- in unifyType.</span><span>
</span><a name="line-1169"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132930"><a href="#local-6989586621683132930"><span class="hs-identifier">n_exp_invis_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">invisibleTyBndrCount</span><span> </span><a href="#local-6989586621683132929"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-1170"></a><span>             </span><a name="local-6989586621683132931"><a href="#local-6989586621683132931"><span class="hs-identifier">n_act_invis_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">invisibleTyBndrCount</span><span> </span><a href="#local-6989586621683132928"><span class="hs-identifier hs-var">act_kind</span></a><span>
</span><a name="line-1171"></a><span>             </span><a name="local-6989586621683132932"><a href="#local-6989586621683132932"><span class="hs-identifier">n_to_inst</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132931"><span class="hs-identifier hs-var">n_act_invis_bndrs</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621683132930"><span class="hs-identifier hs-var">n_exp_invis_bndrs</span></a><span>
</span><a name="line-1172"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132933"><a href="#local-6989586621683132933"><span class="hs-identifier">new_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132934"><a href="#local-6989586621683132934"><span class="hs-identifier">act_kind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#tcInstTyBinders"><span class="hs-identifier hs-var">tcInstTyBinders</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">splitPiTysInvisibleN</span><span> </span><a href="#local-6989586621683132932"><span class="hs-identifier hs-var">n_to_inst</span></a><span> </span><a href="#local-6989586621683132928"><span class="hs-identifier hs-var">act_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1173"></a><span>
</span><a name="line-1174"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132935"><a href="#local-6989586621683132935"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TypeEqOrigin</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uo_actual</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132934"><span class="hs-identifier hs-var">act_kind'</span></a><span>
</span><a name="line-1175"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_expected</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132929"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-1176"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_thing</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683132927"><span class="hs-identifier hs-var">pp_hs_ty</span></a><span>
</span><a name="line-1177"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uo_visible</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- the hs_ty is visible</span><span>
</span><a name="line-1178"></a><span>
</span><a name="line-1179"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkExpectedKindX&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1180"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683132927"><span class="hs-identifier hs-var">pp_hs_ty</span></a><span>
</span><a name="line-1181"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;act_kind:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132928"><span class="hs-identifier hs-var">act_kind</span></a><span>
</span><a name="line-1182"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;act_kind':&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132934"><span class="hs-identifier hs-var">act_kind'</span></a><span>
</span><a name="line-1183"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;exp_kind:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132929"><span class="hs-identifier hs-var">exp_kind</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683132934"><span class="hs-identifier hs-var">act_kind'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">tcEqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683132929"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-1186"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132933"><span class="hs-identifier hs-var">new_args</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTcNomReflCo</span><span> </span><a href="#local-6989586621683132929"><span class="hs-identifier hs-var">exp_kind</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- This is very common</span><span>
</span><a name="line-1187"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132936"><a href="#local-6989586621683132936"><span class="hs-identifier">co_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#uType"><span class="hs-identifier hs-var">uType</span></a><span> </span><span class="hs-identifier hs-var">KindLevel</span><span> </span><a href="#local-6989586621683132935"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-6989586621683132934"><span class="hs-identifier hs-var">act_kind'</span></a><span> </span><a href="#local-6989586621683132929"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-1188"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkExpectedKind&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132928"><span class="hs-identifier hs-var">act_kind</span></a><span>
</span><a name="line-1189"></a><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132929"><span class="hs-identifier hs-var">exp_kind</span></a><span>
</span><a name="line-1190"></a><span>                                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132936"><span class="hs-identifier hs-var">co_k</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1191"></a><span>                      </span><span class="hs-comment">-- See Note [The tcType invariant]</span><span>
</span><a name="line-1192"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132933"><span class="hs-identifier hs-var">new_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132936"><span class="hs-identifier hs-var">co_k</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1193"></a><span>
</span><a name="line-1194"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-1195"></a><span class="hs-identifier">tcHsMbContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsContext</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PredType</span><span class="hs-special">]</span><span>
</span><a name="line-1196"></a><a name="tcHsMbContext"><a href="TcHsType.html#tcHsMbContext"><span class="hs-identifier">tcHsMbContext</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1197"></a><span class="hs-identifier">tcHsMbContext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683132937"><a href="#local-6989586621683132937"><span class="hs-identifier">cxt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span> </span><a href="#local-6989586621683132937"><span class="hs-identifier hs-var">cxt</span></a><span>
</span><a name="line-1198"></a><span>
</span><a name="line-1199"></a><span class="hs-identifier">tcHsContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsContext</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PredType</span><span class="hs-special">]</span><span>
</span><a name="line-1200"></a><a name="tcHsContext"><a href="TcHsType.html#tcHsContext"><span class="hs-identifier">tcHsContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_hs_context"><span class="hs-identifier hs-var">tc_hs_context</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span>
</span><a name="line-1201"></a><span>
</span><a name="line-1202"></a><span class="hs-identifier">tcLHsPredType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">PredType</span><span>
</span><a name="line-1203"></a><a name="tcLHsPredType"><a href="TcHsType.html#tcLHsPredType"><span class="hs-identifier">tcLHsPredType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_lhs_pred"><span class="hs-identifier hs-var">tc_lhs_pred</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span>
</span><a name="line-1204"></a><span>
</span><a name="line-1205"></a><span class="hs-identifier">tc_hs_context</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsContext</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PredType</span><span class="hs-special">]</span><span>
</span><a name="line-1206"></a><a name="tc_hs_context"><a href="TcHsType.html#tc_hs_context"><span class="hs-identifier">tc_hs_context</span></a></a><span> </span><a name="local-6989586621683132938"><a href="#local-6989586621683132938"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132939"><a href="#local-6989586621683132939"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tc_lhs_pred"><span class="hs-identifier hs-var">tc_lhs_pred</span></a><span> </span><a href="#local-6989586621683132938"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683132939"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1207"></a><span>
</span><a name="line-1208"></a><span class="hs-identifier">tc_lhs_pred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">PredType</span><span>
</span><a name="line-1209"></a><a name="tc_lhs_pred"><a href="TcHsType.html#tc_lhs_pred"><span class="hs-identifier">tc_lhs_pred</span></a></a><span> </span><a name="local-6989586621683132940"><a href="#local-6989586621683132940"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132941"><a href="#local-6989586621683132941"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><a href="#local-6989586621683132940"><span class="hs-identifier hs-var">mode</span></a><span> </span><a href="#local-6989586621683132941"><span class="hs-identifier hs-var">pred</span></a><span> </span><span class="hs-identifier hs-var">constraintKind</span><span>
</span><a name="line-1210"></a><span>
</span><a name="line-1211"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-1212"></a><span class="hs-identifier">tcTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>
</span><a name="line-1213"></a><span class="hs-comment">-- See Note [Type checking recursive type and class declarations]</span><span>
</span><a name="line-1214"></a><span class="hs-comment">-- in TcTyClsDecls</span><span>
</span><a name="line-1215"></a><a name="tcTyVar"><a href="TcHsType.html#tcTyVar"><span class="hs-identifier">tcTyVar</span></a></a><span> </span><a name="local-6989586621683132942"><a href="#local-6989586621683132942"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683132943"><a href="#local-6989586621683132943"><span class="hs-identifier">name</span></a></a><span>         </span><span class="hs-comment">-- Could be a tyvar, a tycon, or a datacon</span><span>
</span><a name="line-1216"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;lk1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1217"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132951"><a href="#local-6989586621683132951"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1218"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132951"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1219"></a><span>           </span><span class="hs-identifier hs-var">ATyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132952"><a href="#local-6989586621683132952"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Important: zonk before returning</span><span>
</span><a name="line-1220"></a><span>                          </span><span class="hs-comment">-- We may have the application ((a::kappa) b)</span><span>
</span><a name="line-1221"></a><span>                          </span><span class="hs-comment">-- where kappa is already unified to (k1 -&gt; k2)</span><span>
</span><a name="line-1222"></a><span>                          </span><span class="hs-comment">-- Then we want to see that arrow.  Best done</span><span>
</span><a name="line-1223"></a><span>                          </span><span class="hs-comment">-- here because we are also maintaining</span><span>
</span><a name="line-1224"></a><span>                          </span><span class="hs-comment">-- Note [The tcType invariant], so we don't just</span><span>
</span><a name="line-1225"></a><span>                          </span><span class="hs-comment">-- want to zonk the kind, leaving the TyVar</span><span>
</span><a name="line-1226"></a><span>                          </span><span class="hs-comment">-- un-zonked  (Trac #14873)</span><span>
</span><a name="line-1227"></a><span>                          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132953"><a href="#local-6989586621683132953"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTyVar"><span class="hs-identifier hs-var">zonkTcTyVar</span></a><span> </span><a href="#local-6989586621683132952"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1228"></a><span>                             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132953"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621683132953"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1229"></a><span>
</span><a name="line-1230"></a><span>           </span><span class="hs-identifier hs-var">ATcTyCon</span><span> </span><a name="local-6989586621683132954"><a href="#local-6989586621683132954"><span class="hs-identifier">tc_tc</span></a></a><span>
</span><a name="line-1231"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- See Note [GADT kind self-reference]</span><span>
</span><a name="line-1232"></a><span>                     </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTypeLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mode_level</span><span> </span><a href="#local-6989586621683132942"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1233"></a><span>                            </span><span class="hs-special">(</span><a href="TcHsType.html#promotionErr"><span class="hs-identifier hs-var">promotionErr</span></a><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">TyConPE</span><span class="hs-special">)</span><span>
</span><a name="line-1234"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683132944"><span class="hs-identifier hs-var">check_tc</span></a><span> </span><a href="#local-6989586621683132954"><span class="hs-identifier hs-var">tc_tc</span></a><span>
</span><a name="line-1235"></a><span>                   </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132955"><a href="#local-6989586621683132955"><span class="hs-identifier">tc_kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683132954"><span class="hs-identifier hs-var">tc_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1236"></a><span>                        </span><span class="hs-comment">-- (IT6) of Note [The tcType invariant]</span><span>
</span><a name="line-1237"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><a href="#local-6989586621683132954"><span class="hs-identifier hs-var">tc_tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkNakedCastTy</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkNomReflCo</span><span> </span><a href="#local-6989586621683132955"><span class="hs-identifier hs-var">tc_kind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132955"><span class="hs-identifier hs-var">tc_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1238"></a><span>                        </span><span class="hs-comment">-- the mkNakedCastTy ensures (IT5) of Note [The tcType invariant]</span><span>
</span><a name="line-1239"></a><span>
</span><a name="line-1240"></a><span>           </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621683132956"><a href="#local-6989586621683132956"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1241"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="#local-6989586621683132944"><span class="hs-identifier hs-var">check_tc</span></a><span> </span><a href="#local-6989586621683132956"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1242"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><a href="#local-6989586621683132956"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683132956"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1243"></a><span>
</span><a name="line-1244"></a><span>           </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621683132957"><a href="#local-6989586621683132957"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1245"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132958"><a href="#local-6989586621683132958"><span class="hs-identifier">data_kinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DataKinds</span><span>
</span><a name="line-1246"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132958"><span class="hs-identifier hs-var">data_kinds</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">specialPromotedDc</span><span> </span><a href="#local-6989586621683132957"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1247"></a><span>                       </span><a href="TcHsType.html#promotionErr"><span class="hs-identifier hs-var">promotionErr</span></a><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">NoDataKindsDC</span><span>
</span><a name="line-1248"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isFamInstTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621683132957"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1249"></a><span>                       </span><span class="hs-comment">-- see Trac #15245</span><span>
</span><a name="line-1250"></a><span>                       </span><a href="TcHsType.html#promotionErr"><span class="hs-identifier hs-var">promotionErr</span></a><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">FamDataConPE</span><span>
</span><a name="line-1251"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683132959"><a href="#local-6989586621683132959"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConFullSig</span><span> </span><a href="#local-6989586621683132957"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1252"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683132945"><span class="hs-identifier hs-var">dc_theta_illegal_constraint</span></a><span> </span><a href="#local-6989586621683132959"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1253"></a><span>                       </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683132960"><a href="#local-6989586621683132960"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#promotionErr"><span class="hs-identifier hs-var">promotionErr</span></a><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1254"></a><span>                                    </span><span class="hs-identifier hs-var">ConstrainedDataConPE</span><span> </span><a href="#local-6989586621683132960"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-1255"></a><span>                       </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1256"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132961"><a href="#local-6989586621683132961"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">promoteDataCon</span><span> </span><a href="#local-6989586621683132957"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1257"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683132961"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683132961"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1258"></a><span>
</span><a name="line-1259"></a><span>           </span><span class="hs-identifier hs-var">APromotionErr</span><span> </span><a name="local-6989586621683132962"><a href="#local-6989586621683132962"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#promotionErr"><span class="hs-identifier hs-var">promotionErr</span></a><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683132962"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1260"></a><span>
</span><a name="line-1261"></a><span>           </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#wrongThingErr"><span class="hs-identifier hs-var">wrongThingErr</span></a><span> </span><span class="hs-string">&quot;type&quot;</span><span> </span><a href="#local-6989586621683132951"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1262"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1263"></a><span>    </span><span class="hs-identifier">check_tc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1264"></a><span>    </span><a name="local-6989586621683132944"><a href="#local-6989586621683132944"><span class="hs-identifier">check_tc</span></a></a><span> </span><a name="local-6989586621683132946"><a href="#local-6989586621683132946"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132947"><a href="#local-6989586621683132947"><span class="hs-identifier">data_kinds</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DataKinds</span><span>
</span><a name="line-1265"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTypeLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mode_level</span><span> </span><a href="#local-6989586621683132942"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1266"></a><span>                               </span><a href="#local-6989586621683132947"><span class="hs-identifier hs-var">data_kinds</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1267"></a><span>                               </span><span class="hs-identifier hs-var">isKindTyCon</span><span> </span><a href="#local-6989586621683132946"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1268"></a><span>                       </span><a href="TcHsType.html#promotionErr"><span class="hs-identifier hs-var">promotionErr</span></a><span> </span><a href="#local-6989586621683132943"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">NoDataKindsTC</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1269"></a><span>
</span><a name="line-1270"></a><span>    </span><span class="hs-comment">-- We cannot promote a data constructor with a context that contains</span><span>
</span><a name="line-1271"></a><span>    </span><span class="hs-comment">-- constraints other than equalities, so error if we find one.</span><span>
</span><a name="line-1272"></a><span>    </span><span class="hs-comment">-- See Note [Constraints handled in types] in Inst.</span><span>
</span><a name="line-1273"></a><span>    </span><span class="hs-identifier">dc_theta_illegal_constraint</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">PredType</span><span>
</span><a name="line-1274"></a><span>    </span><a name="local-6989586621683132945"><a href="#local-6989586621683132945"><span class="hs-identifier">dc_theta_illegal_constraint</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">find</span><span> </span><a href="#local-6989586621683132948"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-1275"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1276"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1277"></a><span>        </span><a name="local-6989586621683132948"><a href="#local-6989586621683132948"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683132949"><a href="#local-6989586621683132949"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683132950"><a href="#local-6989586621683132950"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span><span> </span><a href="#local-6989586621683132949"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-1278"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span>  </span><a href="#local-6989586621683132950"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">eqTyConKey</span><span>
</span><a name="line-1279"></a><span>                      </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621683132950"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">heqTyConKey</span><span>
</span><a name="line-1280"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1281"></a><span>
</span><a name="line-1282"></a><span class="hs-comment">{-
Note [GADT kind self-reference]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

A promoted type cannot be used in the body of that type's declaration.
Trac #11554 shows this example, which made GHC loop:

  import Data.Kind
  data P (x :: k) = Q
  data A :: Type where
    B :: forall (a :: A). P a -&gt; A

In order to check the constructor B, we need to have the promoted type A, but in
order to get that promoted type, B must first be checked. To prevent looping, a
TyConPE promotion error is given when tcTyVar checks an ATcTyCon in kind mode.
Any ATcTyCon is a TyCon being defined in the current recursive group (see data
type decl for TcTyThing), and all such TyCons are illegal in kinds.

Trac #11962 proposes checking the head of a data declaration separately from
its constructors. This would allow the example above to pass.

Note [Body kind of a HsForAllTy]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The body of a forall is usually a type, but in principle
there's no reason to prohibit *unlifted* types.
In fact, GHC can itself construct a function with an
unboxed tuple inside a for-all (via CPR analysis; see
typecheck/should_compile/tc170).

Moreover in instance heads we get forall-types with
kind Constraint.

It's tempting to check that the body kind is either * or #. But this is
wrong. For example:

  class C a b
  newtype N = Mk Foo deriving (C a)

We're doing newtype-deriving for C. But notice how `a` isn't in scope in
the predicate `C a`. So we quantify, yielding `forall a. C a` even though
`C a` has kind `* -&gt; Constraint`. The `forall a. C a` is a bit cheeky, but
convenient. Bottom line: don't check for * or # here.

Note [Body kind of a HsQualTy]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If ctxt is non-empty, the HsQualTy really is a /function/, so the
kind of the result really is '*', and in that case the kind of the
body-type can be lifted or unlifted.

However, consider
    instance Eq a =&gt; Eq [a] where ...
or
    f :: (Eq a =&gt; Eq [a]) =&gt; blah
Here both body-kind of the HsQualTy is Constraint rather than *.
Rather crudely we tell the difference by looking at exp_kind. It's
very convenient to typecheck instance types like any other HsSigType.

Admittedly the '(Eq a =&gt; Eq [a]) =&gt; blah' case is erroneous, but it's
better to reject in checkValidType.  If we say that the body kind
should be '*' we risk getting TWO error messages, one saying that Eq
[a] doens't have kind '*', and one saying that we need a Constraint to
the left of the outer (=&gt;).

How do we figure out the right body kind?  Well, it's a bit of a
kludge: I just look at the expected kind.  If it's Constraint, we
must be in this instance situation context. It's a kludge because it
wouldn't work if any unification was involved to compute that result
kind -- but it isn't.  (The true way might be to use the 'mode'
parameter, but that seemed like a sledgehammer to crack a nut.)

Note [Inferring tuple kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Give a tuple type (a,b,c), which the parser labels as HsBoxedOrConstraintTuple,
we try to figure out whether it's a tuple of kind * or Constraint.
  Step 1: look at the expected kind
  Step 2: infer argument kinds

If after Step 2 it's not clear from the arguments that it's
Constraint, then it must be *.  Once having decided that we re-check
the Check the arguments again to give good error messages
in eg. `(Maybe, Maybe)`

Note that we will still fail to infer the correct kind in this case:

  type T a = ((a,a), D a)
  type family D :: Constraint -&gt; Constraint

While kind checking T, we do not yet know the kind of D, so we will default the
kind of T to * -&gt; *. It works if we annotate `a` with kind `Constraint`.

Note [Desugaring types]
~~~~~~~~~~~~~~~~~~~~~~~
The type desugarer is phase 2 of dealing with HsTypes.  Specifically:

  * It transforms from HsType to Type

  * It zonks any kinds.  The returned type should have no mutable kind
    or type variables (hence returning Type not TcType):
      - any unconstrained kind variables are defaulted to (Any *) just
        as in TcHsSyn.
      - there are no mutable type variables because we are
        kind-checking a type
    Reason: the returned type may be put in a TyCon or DataCon where
    it will never subsequently be zonked.

You might worry about nested scopes:
        ..a:kappa in scope..
            let f :: forall b. T '[a,b] -&gt; Int
In this case, f's type could have a mutable kind variable kappa in it;
and we might then default it to (Any *) when dealing with f's type
signature.  But we don't expect this to happen because we can't get a
lexically scoped type variable with a mutable kind variable in it.  A
delicate point, this.  If it becomes an issue we might need to
distinguish top-level from nested uses.

Moreover
  * it cannot fail,
  * it does no unifications
  * it does no validity checking, except for structural matters, such as
        (a) spurious ! annotations.
        (b) a class used as a type

Note [Kind of a type splice]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider these terms, each with TH type splice inside:
     [| e1 :: Maybe $(..blah..) |]
     [| e2 :: $(..blah..) |]
When kind-checking the type signature, we'll kind-check the splice
$(..blah..); we want to give it a kind that can fit in any context,
as if $(..blah..) :: forall k. k.

In the e1 example, the context of the splice fixes kappa to *.  But
in the e2 example, we'll desugar the type, zonking the kind unification
variables as we go.  When we encounter the unconstrained kappa, we
want to default it to '*', not to (Any *).

Help functions for type applications
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-}</span><span>
</span><a name="line-1421"></a><span>
</span><a name="line-1422"></a><span class="hs-identifier">addTypeCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132494"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132494"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1423"></a><span>        </span><span class="hs-comment">-- Wrap a context around only if we want to show that contexts.</span><span>
</span><a name="line-1424"></a><span>        </span><span class="hs-comment">-- Omit invisible ones and ones user's won't grok</span><span>
</span><a name="line-1425"></a><a name="addTypeCtxt"><a href="TcHsType.html#addTypeCtxt"><span class="hs-identifier">addTypeCtxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWildCardTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132963"><a href="#local-6989586621683132963"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132963"><span class="hs-identifier hs-var">thing</span></a><span>   </span><span class="hs-comment">-- &quot;In the type '_'&quot; just isn't helpful.</span><span>
</span><a name="line-1426"></a><span class="hs-identifier">addTypeCtxt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683132964"><a href="#local-6989586621683132964"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683132965"><a href="#local-6989586621683132965"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-1427"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><a href="#local-6989586621683132966"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621683132965"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1428"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1429"></a><span>    </span><a name="local-6989586621683132966"><a href="#local-6989586621683132966"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132964"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1430"></a><span>
</span><a name="line-1431"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Type-variable binders
%*                                                                      *
%************************************************************************

Note [Dependent LHsQTyVars]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We track (in the renamer) which explicitly bound variables in a
LHsQTyVars are manifestly dependent; only precisely these variables
may be used within the LHsQTyVars. We must do this so that kcLHsQTyVars
can produce the right TyConBinders, and tell Anon vs. Required.

Example   data T k1 (a:k1) (b:k2) c
               = MkT (Proxy a) (Proxy b) (Proxy c)

Here
  (a:k1),(b:k2),(c:k3)
       are Anon     (explicitly specified as a binder, not used
                     in the kind of any other binder
  k1   is Required  (explicitly specifed as a binder, but used
                     in the kind of another binder i.e. dependently)
  k2   is Specified (not explicitly bound, but used in the kind
                     of another binder)
  k3   in Inferred  (not lexically in scope at all, but inferred
                     by kind inference)
and
  T :: forall {k3} k1. forall k3 -&gt; k1 -&gt; k2 -&gt; k3 -&gt; *

See Note [VarBndrs, TyCoVarBinders, TyConBinders, and visibility]
in TyCoRep.

kcLHsQTyVars uses the hsq_dependent field to decide whether
k1, a, b, c should be Required or Anon.

Earlier, thought it would work simply to do a free-variable check
during kcLHsQTyVars, but this is bogus, because there may be
unsolved equalities about. And we don't want to eagerly solve the
equalities, because we may get further information after
kcLHsQTyVars is called.  (Recall that kcLHsQTyVars is called
only from getInitialKind.)
This is what implements the rule that all variables intended to be
dependent must be manifestly so.

Sidenote: It's quite possible that later, we'll consider (t -&gt; s)
as a degenerate case of some (pi (x :: t) -&gt; s) and then this will
all get more permissive.

Note [Keeping scoped variables in order: Explicit]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the user writes `forall a b c. blah`, we bring a, b, and c into
scope and then check blah. In the process of checking blah, we might
learn the kinds of a, b, and c, and these kinds might indicate that
b depends on c, and thus that we should reject the user-written type.

One approach to doing this would be to bring each of a, b, and c into
scope, one at a time, creating an implication constraint and
bumping the TcLevel for each one. This would work, because the kind
of, say, b would be untouchable when c is in scope (and the constraint
couldn't float out because c blocks it). However, it leads to terrible
error messages, complaining about skolem escape. While it is indeed
a problem of skolem escape, we can do better.

Instead, our approach is to bring the block of variables into scope
all at once, creating one implication constraint for the lot. The
user-written variables are skolems in the implication constraint. In
TcSimplify.setImplicationStatus, we check to make sure that the ordering
is correct, choosing ImplicationStatus IC_BadTelescope if they aren't.
Then, in TcErrors, we report if there is a bad telescope. This way,
we can report a suggested ordering to the user if there is a problem.

Note [Keeping scoped variables in order: Implicit]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the user implicitly quantifies over variables (say, in a type
signature), we need to come up with some ordering on these variables.
This is done by bumping the TcLevel, bringing the tyvars into scope,
and then type-checking the thing_inside. The constraints are all
wrapped in an implication, which is then solved. Finally, we can
zonk all the binders and then order them with scopedSort.

It's critical to solve before zonking and ordering in order to uncover
any unifications. You might worry that this eager solving could cause
trouble elsewhere. I don't think it will. Because it will solve only
in an increased TcLevel, it can't unify anything that was mentioned
elsewhere. Additionally, we require that the order of implicitly
quantified variables is manifest by the scope of these variables, so
we're not going to learn more information later that will help order
these variables.

Note [Recipe for checking a signature]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Checking a user-written signature requires several steps:

 1. Generate constraints.
 2. Solve constraints.
 3. Zonk.
 4. Promote tyvars and/or kind-generalize.
 5. Zonk.
 6. Check validity.

There may be some surprises in here:

Step 2 is necessary for two reasons: most signatures also bring
implicitly quantified variables into scope, and solving is necessary
to get these in the right order (see Note [Keeping scoped variables in
order: Implicit]). Additionally, solving is necessary in order to
kind-generalize correctly.

In Step 4, we have to deal with the fact that metatyvars generated
in the type may have a bumped TcLevel, because explicit foralls
raise the TcLevel. To avoid these variables from ever being visible
in the surrounding context, we must obey the following dictum:

  Every metavariable in a type must either be
    (A) promoted
    (B) generalized, or
    (C) zapped to Any

If a variable is generalized, then it becomes a skolem and no longer
has a proper TcLevel. (I'm ignoring the TcLevel on a skolem here, as
it's not really in play here.) On the other hand, if it is not
generalized (because we're not generalizing the construct -- e.g., pattern
sig -- or because the metavars are constrained -- see kindGeneralizeLocal)
we need to promote to maintain (MetaTvInv) of Note [TcLevel and untouchable type variables]
in TcType.

For more about (C), see Note [Naughty quantification candidates] in TcMType.

After promoting/generalizing, we need to zonk *again* because both
promoting and generalizing fill in metavariables.

To avoid the double-zonk, we do two things:
 1. When we're not generalizing:
    zonkPromoteType and friends zonk and promote at the same time.
    Accordingly, the function does steps 3-5 all at once, preventing
    the need for multiple traversals.

 2. When we are generalizing:
    kindGeneralize does not require a zonked type -- it zonks as it
    gathers free variables. So this way effectively sidesteps step 3.
-}</span><span>
</span><a name="line-1573"></a><span>
</span><a name="line-1574"></a><span class="hs-identifier">tcWildCardBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1575"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132493"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1576"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132493"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1577"></a><a name="tcWildCardBinders"><a href="TcHsType.html#tcWildCardBinders"><span class="hs-identifier">tcWildCardBinders</span></a></a><span> </span><a name="local-6989586621683132967"><a href="#local-6989586621683132967"><span class="hs-identifier">wc_names</span></a></a><span> </span><a name="local-6989586621683132968"><a href="#local-6989586621683132968"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1578"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132969"><a href="#local-6989586621683132969"><span class="hs-identifier">wcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="TcHsType.html#newWildTyVar"><span class="hs-identifier hs-var">newWildTyVar</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132967"><span class="hs-identifier hs-var">wc_names</span></a><span>
</span><a name="line-1579"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132970"><a href="#local-6989586621683132970"><span class="hs-identifier">wc_prs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132967"><span class="hs-identifier hs-var">wc_names</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683132969"><span class="hs-identifier hs-var">wcs</span></a><span>
</span><a name="line-1580"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><a href="#local-6989586621683132970"><span class="hs-identifier hs-var">wc_prs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1581"></a><span>         </span><a href="#local-6989586621683132968"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683132970"><span class="hs-identifier hs-var">wc_prs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1582"></a><span>
</span><a name="line-1583"></a><span class="hs-identifier">newWildTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>
</span><a name="line-1584"></a><span class="hs-comment">-- ^ New unification variable for a wildcard</span><span>
</span><a name="line-1585"></a><a name="newWildTyVar"><a href="TcHsType.html#newWildTyVar"><span class="hs-identifier">newWildTyVar</span></a></a><span>
</span><a name="line-1586"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683132971"><a href="#local-6989586621683132971"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-1587"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132972"><a href="#local-6989586621683132972"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-1588"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132973"><a href="#local-6989586621683132973"><span class="hs-identifier">details</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaDetails"><span class="hs-identifier hs-var">newMetaDetails</span></a><span> </span><span class="hs-identifier hs-var">TauTv</span><span>
</span><a name="line-1589"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132974"><a href="#local-6989586621683132974"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSysTvName</span><span> </span><a href="#local-6989586621683132972"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;_&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1590"></a><span>             </span><a name="local-6989586621683132975"><a href="#local-6989586621683132975"><span class="hs-identifier">tyvar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcTyVar</span><span> </span><a href="#local-6989586621683132974"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683132971"><span class="hs-identifier hs-var">kind</span></a><span> </span><a href="#local-6989586621683132973"><span class="hs-identifier hs-var">details</span></a><span class="hs-special">)</span><span>
</span><a name="line-1591"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;newWildTyVar&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132975"><span class="hs-identifier hs-var">tyvar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1592"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683132975"><span class="hs-identifier hs-var">tyvar</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1593"></a><span>
</span><a name="line-1594"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             Kind inference for type declarations
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1599"></a><span>
</span><a name="line-1600"></a><span class="hs-comment">{- Note [The initial kind of a type constructor]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kcLHsQTyVars is responsible for getting the initial kind of
a type constructor.

It has two cases:

 * The TyCon has a CUSK.  In that case, find the full, final,
   poly-kinded kind of the TyCon.  It's very like a term-level
   binding where we have a complete type signature for the
   function.

 * It does not have a CUSK.  Find a monomorphic kind, with
   unification variables in it; they will be generalised later.
   It's very like a term-level binding where we do not have
   a type signature (or, more accurately, where we have a
   partial type signature), so we infer the type and generalise.
-}</span><span>
</span><a name="line-1618"></a><span>
</span><a name="line-1619"></a><span>
</span><a name="line-1620"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1621"></a><span class="hs-comment">-- | Kind-check a 'LHsQTyVars'. If the decl under consideration has a complete,</span><span>
</span><a name="line-1622"></a><span class="hs-comment">-- user-supplied kind signature (CUSK), generalise the result.</span><span>
</span><a name="line-1623"></a><span class="hs-comment">-- Used in 'getInitialKind' (for tycon kinds and other kinds)</span><span>
</span><a name="line-1624"></a><span class="hs-comment">-- and in kind-checking (but not for tycon kinds, which are checked with</span><span>
</span><a name="line-1625"></a><span class="hs-comment">-- tcTyClDecls). See Note [CUSKs: complete user-supplied kind signatures]</span><span>
</span><a name="line-1626"></a><span class="hs-comment">-- in HsDecls.</span><span>
</span><a name="line-1627"></a><span class="hs-comment">--</span><span>
</span><a name="line-1628"></a><span class="hs-comment">-- This function does not do telescope checking.</span><span>
</span><a name="line-1629"></a><span class="hs-identifier">kcLHsQTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>              </span><span class="hs-comment">-- ^ of the thing being checked</span><span>
</span><a name="line-1630"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyConFlavour</span><span>      </span><span class="hs-comment">-- ^ What sort of 'TyCon' is being checked</span><span>
</span><a name="line-1631"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>              </span><span class="hs-comment">-- ^ True &lt;=&gt; the decl being checked has a CUSK</span><span>
</span><a name="line-1632"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsQTyVars</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-1633"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>          </span><span class="hs-comment">-- ^ The result kind</span><span>
</span><a name="line-1634"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyCon</span><span>       </span><span class="hs-comment">-- ^ A suitably-kinded TcTyCon</span><span>
</span><a name="line-1635"></a><a name="kcLHsQTyVars"><a href="TcHsType.html#kcLHsQTyVars"><span class="hs-identifier">kcLHsQTyVars</span></a></a><span> </span><a name="local-6989586621683132976"><a href="#local-6989586621683132976"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683132977"><a href="#local-6989586621683132977"><span class="hs-identifier">flav</span></a></a><span> </span><a name="local-6989586621683132978"><a href="#local-6989586621683132978"><span class="hs-identifier">cusk</span></a></a><span> </span><a name="local-6989586621683132979"><a href="#local-6989586621683132979"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621683132980"><a href="#local-6989586621683132980"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1636"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683132978"><span class="hs-identifier hs-var">cusk</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#kcLHsQTyVars_Cusk"><span class="hs-identifier hs-var">kcLHsQTyVars_Cusk</span></a><span>    </span><a href="#local-6989586621683132976"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683132977"><span class="hs-identifier hs-var">flav</span></a><span> </span><a href="#local-6989586621683132979"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621683132980"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1637"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#kcLHsQTyVars_NonCusk"><span class="hs-identifier hs-var">kcLHsQTyVars_NonCusk</span></a><span> </span><a href="#local-6989586621683132976"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683132977"><span class="hs-identifier hs-var">flav</span></a><span> </span><a href="#local-6989586621683132979"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621683132980"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1638"></a><span>
</span><a name="line-1639"></a><span>
</span><a name="line-1640"></a><span class="hs-identifier">kcLHsQTyVars_Cusk</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kcLHsQTyVars_NonCusk</span><span>
</span><a name="line-1641"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>              </span><span class="hs-comment">-- ^ of the thing being checked</span><span>
</span><a name="line-1642"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyConFlavour</span><span>      </span><span class="hs-comment">-- ^ What sort of 'TyCon' is being checked</span><span>
</span><a name="line-1643"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsQTyVars</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-1644"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>          </span><span class="hs-comment">-- ^ The result kind</span><span>
</span><a name="line-1645"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyCon</span><span>       </span><span class="hs-comment">-- ^ A suitably-kinded TcTyCon</span><span>
</span><a name="line-1646"></a><span>
</span><a name="line-1647"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1648"></a><a name="kcLHsQTyVars_Cusk"><a href="TcHsType.html#kcLHsQTyVars_Cusk"><span class="hs-identifier">kcLHsQTyVars_Cusk</span></a></a><span> </span><a name="local-6989586621683132981"><a href="#local-6989586621683132981"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683132982"><a href="#local-6989586621683132982"><span class="hs-identifier">flav</span></a></a><span>
</span><a name="line-1649"></a><span>  </span><a name="local-6989586621683132983"><a href="#local-6989586621683132983"><span class="hs-identifier">user_tyvars</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsQTvs</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsQTvsRn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132984"><a href="#local-6989586621683132984"><span class="hs-identifier">kv_ns</span></a></a><span>
</span><a name="line-1650"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_dependent</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132985"><a href="#local-6989586621683132985"><span class="hs-identifier">dep_names</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1651"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683132986"><a href="#local-6989586621683132986"><span class="hs-identifier">hs_tvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683132987"><a href="#local-6989586621683132987"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1652"></a><span>  </span><span class="hs-comment">-- CUSK case</span><span>
</span><a name="line-1653"></a><span>  </span><span class="hs-comment">-- See note [Required, Specified, and Inferred for types] in TcTyClsDecls</span><span>
</span><a name="line-1654"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addTyConFlavCtxt"><span class="hs-identifier hs-var">addTyConFlavCtxt</span></a><span> </span><a href="#local-6989586621683132981"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683132982"><span class="hs-identifier hs-var">flav</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1655"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132989"><a href="#local-6989586621683132989"><span class="hs-identifier">scoped_kvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683132990"><a href="#local-6989586621683132990"><span class="hs-identifier">tc_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683132991"><a href="#local-6989586621683132991"><span class="hs-identifier">res_kind</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1656"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushTcLevelM_"><span class="hs-identifier hs-var">pushTcLevelM_</span></a><span>                               </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1657"></a><span>              </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span>                             </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1658"></a><span>              </span><a href="TcHsType.html#bindImplicitTKBndrs_Q_Skol"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Q_Skol</span></a><span> </span><a href="#local-6989586621683132984"><span class="hs-identifier hs-var">kv_ns</span></a><span>            </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1659"></a><span>              </span><a href="TcHsType.html#bindExplicitTKBndrs_Q_Skol"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Q_Skol</span></a><span> </span><a href="#local-6989586621683132988"><span class="hs-identifier hs-var">ctxt_kind</span></a><span> </span><a href="#local-6989586621683132986"><span class="hs-identifier hs-var">hs_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1660"></a><span>              </span><a href="#local-6989586621683132987"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1661"></a><span>
</span><a name="line-1662"></a><span>           </span><span class="hs-comment">-- Now, because we're in a CUSK,</span><span>
</span><a name="line-1663"></a><span>           </span><span class="hs-comment">-- we quantify over the mentioned kind vars</span><span>
</span><a name="line-1664"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132992"><a href="#local-6989586621683132992"><span class="hs-identifier">spec_req_tkvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132989"><span class="hs-identifier hs-var">scoped_kvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683132990"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-1665"></a><span>             </span><a name="local-6989586621683132993"><a href="#local-6989586621683132993"><span class="hs-identifier">all_kinds</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132991"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683132992"><span class="hs-identifier hs-var">spec_req_tkvs</span></a><span>
</span><a name="line-1666"></a><span>
</span><a name="line-1667"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132994"><a href="#local-6989586621683132994"><span class="hs-identifier">candidates</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#candidateQTyVarsOfKinds"><span class="hs-identifier hs-var">candidateQTyVarsOfKinds</span></a><span> </span><a href="#local-6989586621683132993"><span class="hs-identifier hs-var">all_kinds</span></a><span>
</span><a name="line-1668"></a><span>             </span><span class="hs-comment">-- 'candidates' are all the variables that we are going to</span><span>
</span><a name="line-1669"></a><span>             </span><span class="hs-comment">-- skolemise and then quantify over.  We do not include spec_req_tvs</span><span>
</span><a name="line-1670"></a><span>             </span><span class="hs-comment">-- because they are /already/ skolems</span><span>
</span><a name="line-1671"></a><span>
</span><a name="line-1672"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683132995"><a href="#local-6989586621683132995"><span class="hs-identifier">inf_candidates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683132994"><span class="hs-identifier hs-var">candidates</span></a><span> </span><span class="hs-special">`</span><a href="TcMType.html#delCandidates"><span class="hs-identifier hs-var">delCandidates</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621683132992"><span class="hs-identifier hs-var">spec_req_tkvs</span></a><span>
</span><a name="line-1673"></a><span>
</span><a name="line-1674"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132996"><a href="#local-6989586621683132996"><span class="hs-identifier">inferred</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#quantifyTyVars"><span class="hs-identifier hs-var">quantifyTyVars</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span> </span><a href="#local-6989586621683132995"><span class="hs-identifier hs-var">inf_candidates</span></a><span>
</span><a name="line-1675"></a><span>                     </span><span class="hs-comment">-- NB: 'inferred' comes back sorted in dependency order</span><span>
</span><a name="line-1676"></a><span>
</span><a name="line-1677"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132997"><a href="#local-6989586621683132997"><span class="hs-identifier">scoped_kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTyCoVarKind"><span class="hs-identifier hs-var">zonkTyCoVarKind</span></a><span> </span><a href="#local-6989586621683132989"><span class="hs-identifier hs-var">scoped_kvs</span></a><span>
</span><a name="line-1678"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132998"><a href="#local-6989586621683132998"><span class="hs-identifier">tc_tvs</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTyCoVarKind"><span class="hs-identifier hs-var">zonkTyCoVarKind</span></a><span> </span><a href="#local-6989586621683132990"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-1679"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683132999"><a href="#local-6989586621683132999"><span class="hs-identifier">res_kind</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span>           </span><a href="#local-6989586621683132991"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1680"></a><span>
</span><a name="line-1681"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133000"><a href="#local-6989586621683133000"><span class="hs-identifier">mentioned_kv_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#candidateKindVars"><span class="hs-identifier hs-var">candidateKindVars</span></a><span> </span><a href="#local-6989586621683132994"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-1682"></a><span>             </span><a name="local-6989586621683133001"><a href="#local-6989586621683133001"><span class="hs-identifier">specified</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scopedSort</span><span> </span><a href="#local-6989586621683132997"><span class="hs-identifier hs-var">scoped_kvs</span></a><span>
</span><a name="line-1683"></a><span>                                </span><span class="hs-comment">-- NB: maintain the L-R order of scoped_kvs</span><span>
</span><a name="line-1684"></a><span>
</span><a name="line-1685"></a><span>             </span><a name="local-6989586621683133002"><a href="#local-6989586621683133002"><span class="hs-identifier">final_tc_binders</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">mkNamedTyConBinders</span><span> </span><span class="hs-identifier hs-var">Inferred</span><span>  </span><a href="#local-6989586621683132996"><span class="hs-identifier hs-var">inferred</span></a><span>
</span><a name="line-1686"></a><span>                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">mkNamedTyConBinders</span><span> </span><span class="hs-identifier hs-var">Specified</span><span> </span><a href="#local-6989586621683133001"><span class="hs-identifier hs-var">specified</span></a><span>
</span><a name="line-1687"></a><span>                              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRequiredTyConBinder</span><span> </span><a href="#local-6989586621683133000"><span class="hs-identifier hs-var">mentioned_kv_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683132998"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-1688"></a><span>
</span><a name="line-1689"></a><span>             </span><a name="local-6989586621683133003"><a href="#local-6989586621683133003"><span class="hs-identifier">all_tv_prs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarNamePairs</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683132997"><span class="hs-identifier hs-var">scoped_kvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683132998"><span class="hs-identifier hs-var">tc_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1690"></a><span>             </span><a name="local-6989586621683133004"><a href="#local-6989586621683133004"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcTyCon</span><span> </span><a href="#local-6989586621683132981"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132983"><span class="hs-identifier hs-var">user_tyvars</span></a><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>                               </span><a href="#local-6989586621683133002"><span class="hs-identifier hs-var">final_tc_binders</span></a><span>
</span><a name="line-1692"></a><span>                               </span><a href="#local-6989586621683132999"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1693"></a><span>                               </span><a href="#local-6989586621683133003"><span class="hs-identifier hs-var">all_tv_prs</span></a><span>
</span><a name="line-1694"></a><span>                               </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">{- it is generalised -}</span><span> </span><a href="#local-6989586621683132982"><span class="hs-identifier hs-var">flav</span></a><span>
</span><a name="line-1695"></a><span>         </span><span class="hs-comment">-- If the ordering from</span><span>
</span><a name="line-1696"></a><span>         </span><span class="hs-comment">-- Note [Required, Specified, and Inferred for types] in TcTyClsDecls</span><span>
</span><a name="line-1697"></a><span>         </span><span class="hs-comment">-- doesn't work, we catch it here, before an error cascade</span><span>
</span><a name="line-1698"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidTelescope"><span class="hs-identifier hs-var">checkValidTelescope</span></a><span> </span><a href="#local-6989586621683133004"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1699"></a><span>
</span><a name="line-1700"></a><span>          </span><span class="hs-comment">-- If any of the specified tyvars aren't actually mentioned in a binder's</span><span>
</span><a name="line-1701"></a><span>          </span><span class="hs-comment">-- kind (or the return kind), then we're in the CUSK case from</span><span>
</span><a name="line-1702"></a><span>          </span><span class="hs-comment">-- Note [Free-floating kind vars]</span><span>
</span><a name="line-1703"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133005"><a href="#local-6989586621683133005"><span class="hs-identifier">unmentioned_kvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683133000"><span class="hs-identifier hs-var">mentioned_kv_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133001"><span class="hs-identifier hs-var">specified</span></a><span>
</span><a name="line-1704"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#reportFloatingKvs"><span class="hs-identifier hs-var">reportFloatingKvs</span></a><span> </span><a href="#local-6989586621683132981"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683132982"><span class="hs-identifier hs-var">flav</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">binderVar</span><span> </span><a href="#local-6989586621683133002"><span class="hs-identifier hs-var">final_tc_binders</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133005"><span class="hs-identifier hs-var">unmentioned_kvs</span></a><span>
</span><a name="line-1705"></a><span>
</span><a name="line-1706"></a><span>
</span><a name="line-1707"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kcLHsQTyVars: cusk&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1708"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;name&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132981"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1709"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;kv_ns&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132984"><span class="hs-identifier hs-var">kv_ns</span></a><span>
</span><a name="line-1710"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hs_tvs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132986"><span class="hs-identifier hs-var">hs_tvs</span></a><span>
</span><a name="line-1711"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;dep_names&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132985"><span class="hs-identifier hs-var">dep_names</span></a><span>
</span><a name="line-1712"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;scoped_kvs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132997"><span class="hs-identifier hs-var">scoped_kvs</span></a><span>
</span><a name="line-1713"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;tc_tvs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132998"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-1714"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;res_kind&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132999"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1715"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;candidates&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132994"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-1716"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;inferred&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683132996"><span class="hs-identifier hs-var">inferred</span></a><span>
</span><a name="line-1717"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;specified&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133001"><span class="hs-identifier hs-var">specified</span></a><span>
</span><a name="line-1718"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;final_tc_binders&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133002"><span class="hs-identifier hs-var">final_tc_binders</span></a><span>
</span><a name="line-1719"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;mkTyConKind final_tc_bndrs res_kind&quot;</span><span>
</span><a name="line-1720"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConKind</span><span> </span><a href="#local-6989586621683133002"><span class="hs-identifier hs-var">final_tc_binders</span></a><span> </span><a href="#local-6989586621683132999"><span class="hs-identifier hs-var">res_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1721"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;all_tv_prs&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133003"><span class="hs-identifier hs-var">all_tv_prs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1722"></a><span>
</span><a name="line-1723"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683133004"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1724"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1725"></a><span>    </span><a name="local-6989586621683132988"><a href="#local-6989586621683132988"><span class="hs-identifier">ctxt_kind</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tcFlavourIsOpen</span><span> </span><a href="#local-6989586621683132982"><span class="hs-identifier hs-var">flav</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-1726"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-1727"></a><span>
</span><a name="line-1728"></a><span class="hs-identifier">kcLHsQTyVars_Cusk</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XLHsQTyVars</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;kcLHsQTyVars&quot;</span><span>
</span><a name="line-1729"></a><span>
</span><a name="line-1730"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-1731"></a><a name="kcLHsQTyVars_NonCusk"><a href="TcHsType.html#kcLHsQTyVars_NonCusk"><span class="hs-identifier">kcLHsQTyVars_NonCusk</span></a></a><span> </span><a name="local-6989586621683133006"><a href="#local-6989586621683133006"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683133007"><a href="#local-6989586621683133007"><span class="hs-identifier">flav</span></a></a><span>
</span><a name="line-1732"></a><span>  </span><a name="local-6989586621683133008"><a href="#local-6989586621683133008"><span class="hs-identifier">user_tyvars</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsQTvs</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsQTvsRn</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133009"><a href="#local-6989586621683133009"><span class="hs-identifier">kv_ns</span></a></a><span>
</span><a name="line-1733"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_dependent</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133010"><a href="#local-6989586621683133010"><span class="hs-identifier">dep_names</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1734"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133011"><a href="#local-6989586621683133011"><span class="hs-identifier">hs_tvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683133012"><a href="#local-6989586621683133012"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1735"></a><span>  </span><span class="hs-comment">-- Non_CUSK case</span><span>
</span><a name="line-1736"></a><span>  </span><span class="hs-comment">-- See note [Required, Specified, and Inferred for types] in TcTyClsDecls</span><span>
</span><a name="line-1737"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133017"><a href="#local-6989586621683133017"><span class="hs-identifier">scoped_kvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133018"><a href="#local-6989586621683133018"><span class="hs-identifier">tc_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133019"><a href="#local-6989586621683133019"><span class="hs-identifier">res_kind</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1738"></a><span>           </span><span class="hs-comment">-- Why bindImplicitTKBndrs_Q_Tv which uses newTyVarTyVar?</span><span>
</span><a name="line-1739"></a><span>           </span><span class="hs-comment">-- See Note [Inferring kinds for type declarations] in TcTyClsDecls</span><span>
</span><a name="line-1740"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#bindImplicitTKBndrs_Q_Tv"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Q_Tv</span></a><span> </span><a href="#local-6989586621683133009"><span class="hs-identifier hs-var">kv_ns</span></a><span>            </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1741"></a><span>              </span><a href="TcHsType.html#bindExplicitTKBndrs_Q_Tv"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Q_Tv</span></a><span> </span><a href="#local-6989586621683133013"><span class="hs-identifier hs-var">ctxt_kind</span></a><span> </span><a href="#local-6989586621683133011"><span class="hs-identifier hs-var">hs_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1742"></a><span>              </span><a href="#local-6989586621683133012"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1743"></a><span>              </span><span class="hs-comment">-- Why &quot;_Tv&quot; not &quot;_Skol&quot;? See third wrinkle in</span><span>
</span><a name="line-1744"></a><span>              </span><span class="hs-comment">-- Note [Inferring kinds for type declarations] in TcTyClsDecls,</span><span>
</span><a name="line-1745"></a><span>
</span><a name="line-1746"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><span class="hs-comment">-- NB: Don't add scoped_kvs to tyConTyVars, because they</span><span>
</span><a name="line-1747"></a><span>               </span><span class="hs-comment">-- might unify with kind vars in other types in a mutually</span><span>
</span><a name="line-1748"></a><span>               </span><span class="hs-comment">-- recursive group.</span><span>
</span><a name="line-1749"></a><span>               </span><span class="hs-comment">-- See Note [Inferring kinds for type declarations] in TcTyClsDecls</span><span>
</span><a name="line-1750"></a><span>             </span><a name="local-6989586621683133020"><a href="#local-6989586621683133020"><span class="hs-identifier">tc_binders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621683133014"><span class="hs-identifier hs-var">mk_tc_binder</span></a><span> </span><a href="#local-6989586621683133011"><span class="hs-identifier hs-var">hs_tvs</span></a><span> </span><a href="#local-6989586621683133018"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-1751"></a><span>               </span><span class="hs-comment">-- Also, note that tc_binders has the tyvars from only the</span><span>
</span><a name="line-1752"></a><span>               </span><span class="hs-comment">-- user-written tyvarbinders. See S1 in Note [How TcTyCons work]</span><span>
</span><a name="line-1753"></a><span>               </span><span class="hs-comment">-- in TcTyClsDecls</span><span>
</span><a name="line-1754"></a><span>             </span><a name="local-6989586621683133021"><a href="#local-6989586621683133021"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcTyCon</span><span> </span><a href="#local-6989586621683133006"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133008"><span class="hs-identifier hs-var">user_tyvars</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133020"><span class="hs-identifier hs-var">tc_binders</span></a><span> </span><a href="#local-6989586621683133019"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1755"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarNamePairs</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133017"><span class="hs-identifier hs-var">scoped_kvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683133018"><span class="hs-identifier hs-var">tc_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1756"></a><span>                               </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- not yet generalised</span><span>
</span><a name="line-1757"></a><span>                               </span><a href="#local-6989586621683133007"><span class="hs-identifier hs-var">flav</span></a><span>
</span><a name="line-1758"></a><span>
</span><a name="line-1759"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kcLHsQTyVars: not-cusk&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1760"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133006"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133009"><span class="hs-identifier hs-var">kv_ns</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133011"><span class="hs-identifier hs-var">hs_tvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133010"><span class="hs-identifier hs-var">dep_names</span></a><span>
</span><a name="line-1761"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133017"><span class="hs-identifier hs-var">scoped_kvs</span></a><span>
</span><a name="line-1762"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133018"><span class="hs-identifier hs-var">tc_tvs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConKind</span><span> </span><a href="#local-6989586621683133020"><span class="hs-identifier hs-var">tc_binders</span></a><span> </span><a href="#local-6989586621683133019"><span class="hs-identifier hs-var">res_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1763"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683133021"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1764"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1765"></a><span>    </span><a name="local-6989586621683133013"><a href="#local-6989586621683133013"><span class="hs-identifier">ctxt_kind</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">tcFlavourIsOpen</span><span> </span><a href="#local-6989586621683133007"><span class="hs-identifier hs-var">flav</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-1766"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-1767"></a><span>
</span><a name="line-1768"></a><span>    </span><span class="hs-identifier">mk_tc_binder</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyConBinder</span><span>
</span><a name="line-1769"></a><span>    </span><span class="hs-comment">-- See Note [Dependent LHsQTyVars]</span><span>
</span><a name="line-1770"></a><span>    </span><a name="local-6989586621683133014"><a href="#local-6989586621683133014"><span class="hs-identifier">mk_tc_binder</span></a></a><span> </span><a name="local-6989586621683133015"><a href="#local-6989586621683133015"><span class="hs-identifier">hs_tv</span></a></a><span> </span><a name="local-6989586621683133016"><a href="#local-6989586621683133016"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1771"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">hsLTyVarName</span><span> </span><a href="#local-6989586621683133015"><span class="hs-identifier hs-var">hs_tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683133010"><span class="hs-identifier hs-var">dep_names</span></a><span>
</span><a name="line-1772"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNamedTyConBinder</span><span> </span><span class="hs-identifier hs-var">Required</span><span> </span><a href="#local-6989586621683133016"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1773"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1774"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkAnonTyConBinder</span><span> </span><a href="#local-6989586621683133016"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1775"></a><span>
</span><a name="line-1776"></a><span class="hs-identifier">kcLHsQTyVars_NonCusk</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XLHsQTyVars</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;kcLHsQTyVars&quot;</span><span>
</span><a name="line-1777"></a><span>
</span><a name="line-1778"></a><span>
</span><a name="line-1779"></a><span class="hs-comment">{- Note [Kind-checking tyvar binders for associated types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When kind-checking the type-variable binders for associated
   data/newtype decls
   family decls
we behave specially for type variables that are already in scope;
that is, bound by the enclosing class decl.  This is done in
kcLHsQTyVarBndrs:
  * The use of tcImplicitQTKBndrs
  * The tcLookupLocal_maybe code in kc_hs_tv

See Note [Associated type tyvar names] in Class and
    Note [TyVar binders for associated decls] in HsDecls

We must do the same for family instance decls, where the in-scope
variables may be bound by the enclosing class instance decl.
Hence the use of tcImplicitQTKBndrs in tcFamTyPatsAndGen.

Note [Kind variable ordering for associated types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
What should be the kind of `T` in the following example? (#15591)

  class C (a :: Type) where
    type T (x :: f a)

As per Note [Ordering of implicit variables] in RnTypes, we want to quantify
the kind variables in left-to-right order of first occurrence in order to
support visible kind application. But we cannot perform this analysis on just
T alone, since its variable `a` actually occurs /before/ `f` if you consider
the fact that `a` was previously bound by the parent class `C`. That is to say,
the kind of `T` should end up being:

  T :: forall a f. f a -&gt; Type

(It wouldn't necessarily be /wrong/ if the kind ended up being, say,
forall f a. f a -&gt; Type, but that would not be as predictable for users of
visible kind application.)

In contrast, if `T` were redefined to be a top-level type family, like `T2`
below:

  type family T2 (x :: f (a :: Type))

Then `a` first appears /after/ `f`, so the kind of `T2` should be:

  T2 :: forall f a. f a -&gt; Type

In order to make this distinction, we need to know (in kcLHsQTyVars) which
type variables have been bound by the parent class (if there is one). With
the class-bound variables in hand, we can ensure that we always quantify
these first.
-}</span><span>
</span><a name="line-1831"></a><span>
</span><a name="line-1832"></a><span>
</span><a name="line-1833"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             Expected kinds
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1838"></a><span>
</span><a name="line-1839"></a><span class="hs-comment">-- | Describes the kind expected in a certain context.</span><span>
</span><a name="line-1840"></a><span class="hs-keyword">data</span><span> </span><a name="ContextKind"><a href="TcHsType.html#ContextKind"><span class="hs-identifier">ContextKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TheKind"><a href="TcHsType.html#TheKind"><span class="hs-identifier">TheKind</span></a></a><span> </span><span class="hs-identifier hs-type">Kind</span><span>   </span><span class="hs-comment">-- ^ a specific kind</span><span>
</span><a name="line-1841"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="AnyKind"><a href="TcHsType.html#AnyKind"><span class="hs-identifier">AnyKind</span></a></a><span>        </span><span class="hs-comment">-- ^ any kind will do</span><span>
</span><a name="line-1842"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="OpenKind"><a href="TcHsType.html#OpenKind"><span class="hs-identifier">OpenKind</span></a></a><span>       </span><span class="hs-comment">-- ^ something of the form @TYPE _@</span><span>
</span><a name="line-1843"></a><span>
</span><a name="line-1844"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1845"></a><span class="hs-identifier">newExpectedKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>
</span><a name="line-1846"></a><a name="newExpectedKind"><a href="TcHsType.html#newExpectedKind"><span class="hs-identifier">newExpectedKind</span></a></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><a name="local-6989586621683133022"><a href="#local-6989586621683133022"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683133022"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-1847"></a><span class="hs-identifier">newExpectedKind</span><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-1848"></a><span class="hs-identifier">newExpectedKind</span><span> </span><a href="TcHsType.html#OpenKind"><span class="hs-identifier hs-var">OpenKind</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcMType.html#newOpenTypeKind"><span class="hs-identifier hs-var">newOpenTypeKind</span></a><span>
</span><a name="line-1849"></a><span>
</span><a name="line-1850"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1851"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span>
</span><a name="line-1852"></a><span class="hs-comment">-- Depending on the context, we might accept any kind (for instance, in a TH</span><span>
</span><a name="line-1853"></a><span class="hs-comment">-- splice), or only certain kinds (like in type signatures).</span><span>
</span><a name="line-1854"></a><a name="expectedKindInCtxt"><a href="TcHsType.html#expectedKindInCtxt"><span class="hs-identifier">expectedKindInCtxt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TySynCtxt</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-1855"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-identifier hs-var">ThBrackCtxt</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-1856"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GhciCtxt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-1857"></a><span class="hs-comment">-- The types in a 'default' decl can have varying kinds</span><span>
</span><a name="line-1858"></a><span class="hs-comment">-- See Note [Extended defaults]&quot; in TcEnv</span><span>
</span><a name="line-1859"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-identifier hs-var">DefaultDeclCtxt</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-1860"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-identifier hs-var">TypeAppCtxt</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#AnyKind"><span class="hs-identifier hs-var">AnyKind</span></a><span>
</span><a name="line-1861"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ForSigCtxt</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-1862"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstDeclCtxt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><span class="hs-identifier hs-var">constraintKind</span><span>
</span><a name="line-1863"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-identifier hs-var">SpecInstCtxt</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#TheKind"><span class="hs-identifier hs-var">TheKind</span></a><span> </span><span class="hs-identifier hs-var">constraintKind</span><span>
</span><a name="line-1864"></a><span class="hs-identifier">expectedKindInCtxt</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#OpenKind"><span class="hs-identifier hs-var">OpenKind</span></a><span>
</span><a name="line-1865"></a><span>
</span><a name="line-1866"></a><span>
</span><a name="line-1867"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             Bringing type variables into scope
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1872"></a><span>
</span><a name="line-1873"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-1874"></a><span class="hs-comment">-- Implicit binders</span><span>
</span><a name="line-1875"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-1876"></a><span>
</span><a name="line-1877"></a><span class="hs-identifier">bindImplicitTKBndrs_Skol</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bindImplicitTKBndrs_Tv</span><span class="hs-special">,</span><span>
</span><a name="line-1878"></a><span>  </span><span class="hs-identifier">bindImplicitTKBndrs_Q_Skol</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bindImplicitTKBndrs_Q_Tv</span><span>
</span><a name="line-1879"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1880"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132492"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1881"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132492"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1882"></a><a name="bindImplicitTKBndrs_Skol"><a href="TcHsType.html#bindImplicitTKBndrs_Skol"><span class="hs-identifier">bindImplicitTKBndrs_Skol</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#bindImplicitTKBndrsX"><span class="hs-identifier hs-var">bindImplicitTKBndrsX</span></a><span> </span><a href="TcHsType.html#newFlexiKindedSkolemTyVar"><span class="hs-identifier hs-var">newFlexiKindedSkolemTyVar</span></a><span>
</span><a name="line-1883"></a><a name="bindImplicitTKBndrs_Tv"><a href="TcHsType.html#bindImplicitTKBndrs_Tv"><span class="hs-identifier">bindImplicitTKBndrs_Tv</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#bindImplicitTKBndrsX"><span class="hs-identifier hs-var">bindImplicitTKBndrsX</span></a><span> </span><a href="TcHsType.html#newFlexiKindedTyVarTyVar"><span class="hs-identifier hs-var">newFlexiKindedTyVarTyVar</span></a><span>
</span><a name="line-1884"></a><a name="bindImplicitTKBndrs_Q_Skol"><a href="TcHsType.html#bindImplicitTKBndrs_Q_Skol"><span class="hs-identifier">bindImplicitTKBndrs_Q_Skol</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#bindImplicitTKBndrsX"><span class="hs-identifier hs-var">bindImplicitTKBndrsX</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#newImplicitTyVarQ"><span class="hs-identifier hs-var">newImplicitTyVarQ</span></a><span> </span><a href="TcHsType.html#newFlexiKindedSkolemTyVar"><span class="hs-identifier hs-var">newFlexiKindedSkolemTyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1885"></a><a name="bindImplicitTKBndrs_Q_Tv"><a href="TcHsType.html#bindImplicitTKBndrs_Q_Tv"><span class="hs-identifier">bindImplicitTKBndrs_Q_Tv</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#bindImplicitTKBndrsX"><span class="hs-identifier hs-var">bindImplicitTKBndrsX</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#newImplicitTyVarQ"><span class="hs-identifier hs-var">newImplicitTyVarQ</span></a><span> </span><a href="TcHsType.html#newFlexiKindedTyVarTyVar"><span class="hs-identifier hs-var">newFlexiKindedTyVarTyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1886"></a><span>
</span><a name="line-1887"></a><span class="hs-identifier">bindImplicitTKBndrsX</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- new_tv function</span><span>
</span><a name="line-1888"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>
</span><a name="line-1889"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132491"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1890"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132491"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- these tyvars are dependency-ordered</span><span>
</span><a name="line-1891"></a><span class="hs-comment">-- * Guarantees to call solveLocalEqualities to unify</span><span>
</span><a name="line-1892"></a><span class="hs-comment">--   all constraints from thing_inside.</span><span>
</span><a name="line-1893"></a><span class="hs-comment">--</span><span>
</span><a name="line-1894"></a><span class="hs-comment">-- * Returned TcTyVars have the supplied HsTyVarBndrs,</span><span>
</span><a name="line-1895"></a><span class="hs-comment">--   but may be in different order to the original [Name]</span><span>
</span><a name="line-1896"></a><span class="hs-comment">--   (because of sorting to respect dependency)</span><span>
</span><a name="line-1897"></a><span class="hs-comment">--</span><span>
</span><a name="line-1898"></a><span class="hs-comment">-- * Returned TcTyVars have zonked kinds</span><span>
</span><a name="line-1899"></a><span class="hs-comment">--   See Note [Keeping scoped variables in order: Implicit]</span><span>
</span><a name="line-1900"></a><a name="bindImplicitTKBndrsX"><a href="TcHsType.html#bindImplicitTKBndrsX"><span class="hs-identifier">bindImplicitTKBndrsX</span></a></a><span> </span><a name="local-6989586621683133023"><a href="#local-6989586621683133023"><span class="hs-identifier">new_tv</span></a></a><span> </span><a name="local-6989586621683133024"><a href="#local-6989586621683133024"><span class="hs-identifier">tv_names</span></a></a><span> </span><a name="local-6989586621683133025"><a href="#local-6989586621683133025"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1901"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133026"><a href="#local-6989586621683133026"><span class="hs-identifier">tkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683133023"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621683133024"><span class="hs-identifier hs-var">tv_names</span></a><span>
</span><a name="line-1902"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133027"><a href="#local-6989586621683133027"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier hs-var">tcExtendTyVarEnv</span></a><span> </span><a href="#local-6989586621683133026"><span class="hs-identifier hs-var">tkvs</span></a><span> </span><a href="#local-6989586621683133025"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1903"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;bindImplicitTKBndrs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133024"><span class="hs-identifier hs-var">tv_names</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133026"><span class="hs-identifier hs-var">tkvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1904"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133026"><span class="hs-identifier hs-var">tkvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133027"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1905"></a><span>
</span><a name="line-1906"></a><span class="hs-identifier">newImplicitTyVarQ</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>
</span><a name="line-1907"></a><span class="hs-comment">-- Behave like new_tv, except that if the tyvar is in scope, use it</span><span>
</span><a name="line-1908"></a><a name="newImplicitTyVarQ"><a href="TcHsType.html#newImplicitTyVarQ"><span class="hs-identifier">newImplicitTyVarQ</span></a></a><span> </span><a name="local-6989586621683133028"><a href="#local-6989586621683133028"><span class="hs-identifier">new_tv</span></a></a><span> </span><a name="local-6989586621683133029"><a href="#local-6989586621683133029"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1909"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133030"><a href="#local-6989586621683133030"><span class="hs-identifier">mb_tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLcl_maybe"><span class="hs-identifier hs-var">tcLookupLcl_maybe</span></a><span> </span><a href="#local-6989586621683133029"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1910"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133030"><span class="hs-identifier hs-var">mb_tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1911"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133031"><a href="#local-6989586621683133031"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683133031"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1912"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683133028"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621683133029"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1913"></a><span>
</span><a name="line-1914"></a><span class="hs-identifier">newFlexiKindedTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span>
</span><a name="line-1915"></a><a name="newFlexiKindedTyVar"><a href="TcHsType.html#newFlexiKindedTyVar"><span class="hs-identifier">newFlexiKindedTyVar</span></a></a><span> </span><a name="local-6989586621683133032"><a href="#local-6989586621683133032"><span class="hs-identifier">new_tv</span></a></a><span> </span><a name="local-6989586621683133033"><a href="#local-6989586621683133033"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1916"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133034"><a href="#local-6989586621683133034"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-1917"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683133032"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621683133033"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683133034"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1918"></a><span>
</span><a name="line-1919"></a><span class="hs-identifier">newFlexiKindedSkolemTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span>
</span><a name="line-1920"></a><a name="newFlexiKindedSkolemTyVar"><a href="TcHsType.html#newFlexiKindedSkolemTyVar"><span class="hs-identifier">newFlexiKindedSkolemTyVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#newFlexiKindedTyVar"><span class="hs-identifier hs-var">newFlexiKindedTyVar</span></a><span> </span><a href="TcMType.html#newSkolemTyVar"><span class="hs-identifier hs-var">newSkolemTyVar</span></a><span>
</span><a name="line-1921"></a><span>
</span><a name="line-1922"></a><span class="hs-identifier">newFlexiKindedTyVarTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span>
</span><a name="line-1923"></a><a name="newFlexiKindedTyVarTyVar"><a href="TcHsType.html#newFlexiKindedTyVarTyVar"><span class="hs-identifier">newFlexiKindedTyVarTyVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#newFlexiKindedTyVar"><span class="hs-identifier hs-var">newFlexiKindedTyVar</span></a><span> </span><a href="TcMType.html#newTyVarTyVar"><span class="hs-identifier hs-var">newTyVarTyVar</span></a><span>
</span><a name="line-1924"></a><span>
</span><a name="line-1925"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-1926"></a><span class="hs-comment">-- Explicit binders</span><span>
</span><a name="line-1927"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-1928"></a><span>
</span><a name="line-1929"></a><span class="hs-identifier">bindExplicitTKBndrs_Skol</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bindExplicitTKBndrs_Tv</span><span>
</span><a name="line-1930"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1931"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132490"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1932"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132490"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1933"></a><span>
</span><a name="line-1934"></a><a name="bindExplicitTKBndrs_Skol"><a href="TcHsType.html#bindExplicitTKBndrs_Skol"><span class="hs-identifier">bindExplicitTKBndrs_Skol</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#bindExplicitTKBndrsX"><span class="hs-identifier hs-var">bindExplicitTKBndrsX</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tcHsTyVarBndr"><span class="hs-identifier hs-var">tcHsTyVarBndr</span></a><span> </span><a href="TcMType.html#newSkolemTyVar"><span class="hs-identifier hs-var">newSkolemTyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1935"></a><a name="bindExplicitTKBndrs_Tv"><a href="TcHsType.html#bindExplicitTKBndrs_Tv"><span class="hs-identifier">bindExplicitTKBndrs_Tv</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#bindExplicitTKBndrsX"><span class="hs-identifier hs-var">bindExplicitTKBndrsX</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tcHsTyVarBndr"><span class="hs-identifier hs-var">tcHsTyVarBndr</span></a><span> </span><a href="TcMType.html#newTyVarTyVar"><span class="hs-identifier hs-var">newTyVarTyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1936"></a><span>
</span><a name="line-1937"></a><span class="hs-identifier">bindExplicitTKBndrs_Q_Skol</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bindExplicitTKBndrs_Q_Tv</span><span>
</span><a name="line-1938"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span>
</span><a name="line-1939"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1940"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132489"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1941"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132489"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1942"></a><span>
</span><a name="line-1943"></a><a name="bindExplicitTKBndrs_Q_Skol"><a href="TcHsType.html#bindExplicitTKBndrs_Q_Skol"><span class="hs-identifier">bindExplicitTKBndrs_Q_Skol</span></a></a><span> </span><a name="local-6989586621683133035"><a href="#local-6989586621683133035"><span class="hs-identifier">ctxt_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#bindExplicitTKBndrsX"><span class="hs-identifier hs-var">bindExplicitTKBndrsX</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tcHsQTyVarBndr"><span class="hs-identifier hs-var">tcHsQTyVarBndr</span></a><span> </span><a href="#local-6989586621683133035"><span class="hs-identifier hs-var">ctxt_kind</span></a><span> </span><a href="TcMType.html#newSkolemTyVar"><span class="hs-identifier hs-var">newSkolemTyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1944"></a><a name="bindExplicitTKBndrs_Q_Tv"><a href="TcHsType.html#bindExplicitTKBndrs_Q_Tv"><span class="hs-identifier">bindExplicitTKBndrs_Q_Tv</span></a></a><span>   </span><a name="local-6989586621683133036"><a href="#local-6989586621683133036"><span class="hs-identifier">ctxt_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#bindExplicitTKBndrsX"><span class="hs-identifier hs-var">bindExplicitTKBndrsX</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tcHsQTyVarBndr"><span class="hs-identifier hs-var">tcHsQTyVarBndr</span></a><span> </span><a href="#local-6989586621683133036"><span class="hs-identifier hs-var">ctxt_kind</span></a><span> </span><a href="TcMType.html#newTyVarTyVar"><span class="hs-identifier hs-var">newTyVarTyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1945"></a><span>
</span><a name="line-1946"></a><span class="hs-comment">-- | Used during the &quot;kind-checking&quot; pass in TcTyClsDecls only,</span><span>
</span><a name="line-1947"></a><span class="hs-comment">-- and even then only for data-con declarations.</span><span>
</span><a name="line-1948"></a><span class="hs-identifier">bindExplicitTKBndrsX</span><span>
</span><a name="line-1949"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span>
</span><a name="line-1950"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1951"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132488"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1952"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683132488"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1953"></a><a name="bindExplicitTKBndrsX"><a href="TcHsType.html#bindExplicitTKBndrsX"><span class="hs-identifier">bindExplicitTKBndrsX</span></a></a><span> </span><a name="local-6989586621683133037"><a href="#local-6989586621683133037"><span class="hs-identifier">tc_tv</span></a></a><span> </span><a name="local-6989586621683133038"><a href="#local-6989586621683133038"><span class="hs-identifier">hs_tvs</span></a></a><span> </span><a name="local-6989586621683133039"><a href="#local-6989586621683133039"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1954"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;bindExplicTKBndrs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133038"><span class="hs-identifier hs-var">hs_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1955"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683133040"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683133038"><span class="hs-identifier hs-var">hs_tvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1956"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1957"></a><span>    </span><a name="local-6989586621683133040"><a href="#local-6989586621683133040"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133041"><a href="#local-6989586621683133041"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683133039"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1958"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133041"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1959"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133042"><a href="#local-6989586621683133042"><span class="hs-identifier">hs_tv</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683133043"><a href="#local-6989586621683133043"><span class="hs-identifier">hs_tvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1960"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133044"><a href="#local-6989586621683133044"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683133037"><span class="hs-identifier hs-var">tc_tv</span></a><span> </span><a href="#local-6989586621683133042"><span class="hs-identifier hs-var">hs_tv</span></a><span>
</span><a name="line-1961"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133045"><a href="#local-6989586621683133045"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133046"><a href="#local-6989586621683133046"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier hs-var">tcExtendTyVarEnv</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683133044"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133040"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683133043"><span class="hs-identifier hs-var">hs_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1962"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133044"><span class="hs-identifier hs-var">tv</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683133045"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133046"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1963"></a><span>
</span><a name="line-1964"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-1965"></a><span class="hs-identifier">tcHsTyVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">)</span><span>
</span><a name="line-1966"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>
</span><a name="line-1967"></a><span class="hs-comment">-- Returned TcTyVar has the same name; no cloning</span><span>
</span><a name="line-1968"></a><a name="tcHsTyVarBndr"><a href="TcHsType.html#tcHsTyVarBndr"><span class="hs-identifier">tcHsTyVarBndr</span></a></a><span> </span><a name="local-6989586621683133047"><a href="#local-6989586621683133047"><span class="hs-identifier">new_tv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UserTyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133048"><a href="#local-6989586621683133048"><span class="hs-identifier">tv_nm</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1969"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133049"><a href="#local-6989586621683133049"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-1970"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683133047"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621683133048"><span class="hs-identifier hs-var">tv_nm</span></a><span> </span><a href="#local-6989586621683133049"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1971"></a><span class="hs-identifier">tcHsTyVarBndr</span><span> </span><a name="local-6989586621683133050"><a href="#local-6989586621683133050"><span class="hs-identifier">new_tv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">KindedTyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133051"><a href="#local-6989586621683133051"><span class="hs-identifier">tv_nm</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683133052"><a href="#local-6989586621683133052"><span class="hs-identifier">lhs_kind</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1972"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133053"><a href="#local-6989586621683133053"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarBndrKindCtxt</span><span> </span><a href="#local-6989586621683133051"><span class="hs-identifier hs-var">tv_nm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133052"><span class="hs-identifier hs-var">lhs_kind</span></a><span>
</span><a name="line-1973"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683133050"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621683133051"><span class="hs-identifier hs-var">tv_nm</span></a><span> </span><a href="#local-6989586621683133053"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1974"></a><span class="hs-identifier">tcHsTyVarBndr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTyVarBndr</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcHsTyVarBndr&quot;</span><span>
</span><a name="line-1975"></a><span>
</span><a name="line-1976"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-1977"></a><span class="hs-identifier">tcHsQTyVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#ContextKind"><span class="hs-identifier hs-type">ContextKind</span></a><span>
</span><a name="line-1978"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">)</span><span>
</span><a name="line-1979"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsTyVarBndr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>
</span><a name="line-1980"></a><span class="hs-comment">-- Just like tcHsTyVarBndr, but also</span><span>
</span><a name="line-1981"></a><span class="hs-comment">--   - uses the in-scope TyVar from class, if it exists</span><span>
</span><a name="line-1982"></a><span class="hs-comment">--   - takes a ContextKind to use for the no-sig case</span><span>
</span><a name="line-1983"></a><a name="tcHsQTyVarBndr"><a href="TcHsType.html#tcHsQTyVarBndr"><span class="hs-identifier">tcHsQTyVarBndr</span></a></a><span> </span><a name="local-6989586621683133054"><a href="#local-6989586621683133054"><span class="hs-identifier">ctxt_kind</span></a></a><span> </span><a name="local-6989586621683133055"><a href="#local-6989586621683133055"><span class="hs-identifier">new_tv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UserTyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133056"><a href="#local-6989586621683133056"><span class="hs-identifier">tv_nm</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1984"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133057"><a href="#local-6989586621683133057"><span class="hs-identifier">mb_tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLcl_maybe"><span class="hs-identifier hs-var">tcLookupLcl_maybe</span></a><span> </span><a href="#local-6989586621683133056"><span class="hs-identifier hs-var">tv_nm</span></a><span>
</span><a name="line-1985"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133057"><span class="hs-identifier hs-var">mb_tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1986"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133058"><a href="#local-6989586621683133058"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683133058"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1987"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133059"><a href="#local-6989586621683133059"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#newExpectedKind"><span class="hs-identifier hs-var">newExpectedKind</span></a><span> </span><a href="#local-6989586621683133054"><span class="hs-identifier hs-var">ctxt_kind</span></a><span>
</span><a name="line-1988"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683133055"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621683133056"><span class="hs-identifier hs-var">tv_nm</span></a><span> </span><a href="#local-6989586621683133059"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1989"></a><span>
</span><a name="line-1990"></a><span class="hs-identifier">tcHsQTyVarBndr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133060"><a href="#local-6989586621683133060"><span class="hs-identifier">new_tv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">KindedTyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133061"><a href="#local-6989586621683133061"><span class="hs-identifier">tv_nm</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683133062"><a href="#local-6989586621683133062"><span class="hs-identifier">lhs_kind</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1991"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133064"><a href="#local-6989586621683133064"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TyVarBndrKindCtxt</span><span> </span><a href="#local-6989586621683133061"><span class="hs-identifier hs-var">tv_nm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133062"><span class="hs-identifier hs-var">lhs_kind</span></a><span>
</span><a name="line-1992"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133065"><a href="#local-6989586621683133065"><span class="hs-identifier">mb_tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupLcl_maybe"><span class="hs-identifier hs-var">tcLookupLcl_maybe</span></a><span> </span><a href="#local-6989586621683133061"><span class="hs-identifier hs-var">tv_nm</span></a><span>
</span><a name="line-1993"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133065"><span class="hs-identifier hs-var">mb_tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1994"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyVar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133066"><a href="#local-6989586621683133066"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1995"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcUnify.html#unifyKind"><span class="hs-identifier hs-var">unifyKind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683133063"><span class="hs-identifier hs-var">hs_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1996"></a><span>                                        </span><a href="#local-6989586621683133064"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683133066"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1997"></a><span>                       </span><span class="hs-comment">-- This unify rejects:</span><span>
</span><a name="line-1998"></a><span>                       </span><span class="hs-comment">--    class C (m :: * -&gt; *) where</span><span>
</span><a name="line-1999"></a><span>                       </span><span class="hs-comment">--      type F (m :: *) = ...</span><span>
</span><a name="line-2000"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683133066"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2001"></a><span>
</span><a name="line-2002"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683133060"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621683133061"><span class="hs-identifier hs-var">tv_nm</span></a><span> </span><a href="#local-6989586621683133064"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2003"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2004"></a><span>    </span><a name="local-6989586621683133063"><a href="#local-6989586621683133063"><span class="hs-identifier">hs_tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsTyVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-identifier hs-var">NotPromoted</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683133061"><span class="hs-identifier hs-var">tv_nm</span></a><span class="hs-special">)</span><span>
</span><a name="line-2005"></a><span>            </span><span class="hs-comment">-- Used for error messages only</span><span>
</span><a name="line-2006"></a><span>
</span><a name="line-2007"></a><span class="hs-identifier">tcHsQTyVarBndr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XTyVarBndr</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcHsTyVarBndr&quot;</span><span>
</span><a name="line-2008"></a><span>
</span><a name="line-2009"></a><span>
</span><a name="line-2010"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-2011"></a><span class="hs-comment">-- Binding type/class variables in the</span><span>
</span><a name="line-2012"></a><span class="hs-comment">-- kind-checking and typechecking phases</span><span>
</span><a name="line-2013"></a><span class="hs-comment">--------------------------------------</span><span>
</span><a name="line-2014"></a><span>
</span><a name="line-2015"></a><span class="hs-identifier">bindTyClTyVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-2016"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyConBinder</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132487"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132487"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2017"></a><span class="hs-comment">-- ^ Used for the type variables of a type or class decl</span><span>
</span><a name="line-2018"></a><span class="hs-comment">-- in the &quot;kind checking&quot; and &quot;type checking&quot; pass,</span><span>
</span><a name="line-2019"></a><span class="hs-comment">-- but not in the initial-kind run.</span><span>
</span><a name="line-2020"></a><a name="bindTyClTyVars"><a href="TcHsType.html#bindTyClTyVars"><span class="hs-identifier">bindTyClTyVars</span></a></a><span> </span><a name="local-6989586621683133067"><a href="#local-6989586621683133067"><span class="hs-identifier">tycon_name</span></a></a><span> </span><a name="local-6989586621683133068"><a href="#local-6989586621683133068"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-2021"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133069"><a href="#local-6989586621683133069"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kcLookupTcTyCon"><span class="hs-identifier hs-var">kcLookupTcTyCon</span></a><span> </span><a href="#local-6989586621683133067"><span class="hs-identifier hs-var">tycon_name</span></a><span>
</span><a name="line-2022"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133070"><a href="#local-6989586621683133070"><span class="hs-identifier">scoped_prs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcTyConScopedTyVars</span><span> </span><a href="#local-6989586621683133069"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-2023"></a><span>             </span><a name="local-6989586621683133071"><a href="#local-6989586621683133071"><span class="hs-identifier">res_kind</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConResKind</span><span> </span><a href="#local-6989586621683133069"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-2024"></a><span>             </span><a name="local-6989586621683133072"><a href="#local-6989586621683133072"><span class="hs-identifier">binders</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621683133069"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-2025"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;bindTyClTyVars&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133067"><span class="hs-identifier hs-var">tycon_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133072"><span class="hs-identifier hs-var">binders</span></a><span class="hs-special">)</span><span>
</span><a name="line-2026"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><a href="#local-6989586621683133070"><span class="hs-identifier hs-var">scoped_prs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2027"></a><span>         </span><a href="#local-6989586621683133068"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621683133072"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621683133071"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2028"></a><span>
</span><a name="line-2029"></a><span class="hs-comment">-- getInitialKind has made a suitably-shaped kind for the type or class</span><span>
</span><a name="line-2030"></a><span class="hs-comment">-- Look it up in the local environment. This is used only for tycons</span><span>
</span><a name="line-2031"></a><span class="hs-comment">-- that we're currently type-checking, so we're sure to find a TcTyCon.</span><span>
</span><a name="line-2032"></a><span class="hs-identifier">kcLookupTcTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTyCon</span><span>
</span><a name="line-2033"></a><a name="kcLookupTcTyCon"><a href="TcHsType.html#kcLookupTcTyCon"><span class="hs-identifier">kcLookupTcTyCon</span></a></a><span> </span><a name="local-6989586621683133073"><a href="#local-6989586621683133073"><span class="hs-identifier">nm</span></a></a><span>
</span><a name="line-2034"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133074"><a href="#local-6989586621683133074"><span class="hs-identifier">tc_ty_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span> </span><a href="#local-6989586621683133073"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-2035"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133074"><span class="hs-identifier hs-var">tc_ty_thing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2036"></a><span>           </span><span class="hs-identifier hs-var">ATcTyCon</span><span> </span><a name="local-6989586621683133075"><a href="#local-6989586621683133075"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683133075"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2037"></a><span>           </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;kcLookupTcTyCon&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133074"><span class="hs-identifier hs-var">tc_ty_thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2038"></a><span>
</span><a name="line-2039"></a><span>
</span><a name="line-2040"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             Kind generalisation
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-2045"></a><span>
</span><a name="line-2046"></a><span class="hs-identifier">zonkAndScopedSort</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span>
</span><a name="line-2047"></a><a name="zonkAndScopedSort"><a href="TcHsType.html#zonkAndScopedSort"><span class="hs-identifier">zonkAndScopedSort</span></a></a><span> </span><a name="local-6989586621683133076"><a href="#local-6989586621683133076"><span class="hs-identifier">spec_tkvs</span></a></a><span>
</span><a name="line-2048"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133077"><a href="#local-6989586621683133077"><span class="hs-identifier">spec_tkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTcTyCoVarBndr"><span class="hs-identifier hs-var">zonkTcTyCoVarBndr</span></a><span> </span><a href="#local-6989586621683133076"><span class="hs-identifier hs-var">spec_tkvs</span></a><span>
</span><a name="line-2049"></a><span>          </span><span class="hs-comment">-- Use zonkTcTyCoVarBndr because a skol_tv might be a TyVarTv</span><span>
</span><a name="line-2050"></a><span>
</span><a name="line-2051"></a><span>       </span><span class="hs-comment">-- Do a stable topological sort, following</span><span>
</span><a name="line-2052"></a><span>       </span><span class="hs-comment">-- Note [Ordering of implicit variables] in RnTypes</span><span>
</span><a name="line-2053"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">scopedSort</span><span> </span><a href="#local-6989586621683133077"><span class="hs-identifier hs-var">spec_tkvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2054"></a><span>
</span><a name="line-2055"></a><span class="hs-identifier">kindGeneralize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">KindVar</span><span class="hs-special">]</span><span>
</span><a name="line-2056"></a><span class="hs-comment">-- Quantify the free kind variables of a kind or type</span><span>
</span><a name="line-2057"></a><span class="hs-comment">-- In the latter case the type is closed, so it has no free</span><span>
</span><a name="line-2058"></a><span class="hs-comment">-- type variables.  So in both cases, all the free vars are kind vars</span><span>
</span><a name="line-2059"></a><span class="hs-comment">-- Input needn't be zonked.</span><span>
</span><a name="line-2060"></a><span class="hs-comment">-- NB: You must call solveEqualities or solveLocalEqualities before</span><span>
</span><a name="line-2061"></a><span class="hs-comment">-- kind generalization</span><span>
</span><a name="line-2062"></a><span class="hs-comment">--</span><span>
</span><a name="line-2063"></a><span class="hs-comment">-- NB: this function is just a specialised version of</span><span>
</span><a name="line-2064"></a><span class="hs-comment">--        kindGeneralizeLocal emptyWC kind_or_type</span><span>
</span><a name="line-2065"></a><span class="hs-comment">--</span><span>
</span><a name="line-2066"></a><a name="kindGeneralize"><a href="TcHsType.html#kindGeneralize"><span class="hs-identifier">kindGeneralize</span></a></a><span> </span><a name="local-6989586621683133078"><a href="#local-6989586621683133078"><span class="hs-identifier">kind_or_type</span></a></a><span>
</span><a name="line-2067"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133079"><a href="#local-6989586621683133079"><span class="hs-identifier">kt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683133078"><span class="hs-identifier hs-var">kind_or_type</span></a><span>
</span><a name="line-2068"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kindGeneralise1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133079"><span class="hs-identifier hs-var">kt</span></a><span class="hs-special">)</span><span>
</span><a name="line-2069"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133080"><a href="#local-6989586621683133080"><span class="hs-identifier">dvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#candidateQTyVarsOfKind"><span class="hs-identifier hs-var">candidateQTyVarsOfKind</span></a><span> </span><a href="#local-6989586621683133078"><span class="hs-identifier hs-var">kind_or_type</span></a><span>
</span><a name="line-2070"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133081"><a href="#local-6989586621683133081"><span class="hs-identifier">gbl_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcGetGlobalTyCoVars"><span class="hs-identifier hs-var">tcGetGlobalTyCoVars</span></a><span> </span><span class="hs-comment">-- Already zonked</span><span>
</span><a name="line-2071"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kindGeneralize&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133078"><span class="hs-identifier hs-var">kind_or_type</span></a><span>
</span><a name="line-2072"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133080"><span class="hs-identifier hs-var">dvs</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2073"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#quantifyTyVars"><span class="hs-identifier hs-var">quantifyTyVars</span></a><span> </span><a href="#local-6989586621683133081"><span class="hs-identifier hs-var">gbl_tvs</span></a><span> </span><a href="#local-6989586621683133080"><span class="hs-identifier hs-var">dvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2074"></a><span>
</span><a name="line-2075"></a><span class="hs-comment">-- | This variant of 'kindGeneralize' refuses to generalize over any</span><span>
</span><a name="line-2076"></a><span class="hs-comment">-- variables free in the given WantedConstraints. Instead, it promotes</span><span>
</span><a name="line-2077"></a><span class="hs-comment">-- these variables into an outer TcLevel. See also</span><span>
</span><a name="line-2078"></a><span class="hs-comment">-- Note [Promoting unification variables] in TcSimplify</span><span>
</span><a name="line-2079"></a><span class="hs-identifier">kindGeneralizeLocal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">KindVar</span><span class="hs-special">]</span><span>
</span><a name="line-2080"></a><a name="kindGeneralizeLocal"><a href="TcHsType.html#kindGeneralizeLocal"><span class="hs-identifier">kindGeneralizeLocal</span></a></a><span> </span><a name="local-6989586621683133082"><a href="#local-6989586621683133082"><span class="hs-identifier">wanted</span></a></a><span> </span><a name="local-6989586621683133083"><a href="#local-6989586621683133083"><span class="hs-identifier">kind_or_type</span></a></a><span>
</span><a name="line-2081"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-2082"></a><span>       </span><span class="hs-comment">-- This bit is very much like decideMonoTyVars in TcSimplify,</span><span>
</span><a name="line-2083"></a><span>       </span><span class="hs-comment">-- but constraints are so much simpler in kinds, it is much</span><span>
</span><a name="line-2084"></a><span>       </span><span class="hs-comment">-- easier here. (In particular, we never quantify over a</span><span>
</span><a name="line-2085"></a><span>       </span><span class="hs-comment">-- constraint in a type.)</span><span>
</span><a name="line-2086"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133084"><a href="#local-6989586621683133084"><span class="hs-identifier">constrained</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTyCoVarsAndFV"><span class="hs-identifier hs-var">zonkTyCoVarsAndFV</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfWC</span><span> </span><a href="#local-6989586621683133082"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">)</span><span>
</span><a name="line-2087"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683133085"><a href="#local-6989586621683133085"><span class="hs-identifier">constrained</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#promoteTyVarSet"><span class="hs-identifier hs-var">promoteTyVarSet</span></a><span> </span><a href="#local-6989586621683133084"><span class="hs-identifier hs-var">constrained</span></a><span>
</span><a name="line-2088"></a><span>
</span><a name="line-2089"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133086"><a href="#local-6989586621683133086"><span class="hs-identifier">gbl_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcGetGlobalTyCoVars"><span class="hs-identifier hs-var">tcGetGlobalTyCoVars</span></a><span> </span><span class="hs-comment">-- Already zonked</span><span>
</span><a name="line-2090"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133087"><a href="#local-6989586621683133087"><span class="hs-identifier">mono_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683133086"><span class="hs-identifier hs-var">gbl_tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683133085"><span class="hs-identifier hs-var">constrained</span></a><span>
</span><a name="line-2091"></a><span>
</span><a name="line-2092"></a><span>         </span><span class="hs-comment">-- use the &quot;Kind&quot; variant here, as any types we see</span><span>
</span><a name="line-2093"></a><span>         </span><span class="hs-comment">-- here will already have all type variables quantified;</span><span>
</span><a name="line-2094"></a><span>         </span><span class="hs-comment">-- thus, every free variable is really a kv, never a tv.</span><span>
</span><a name="line-2095"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133088"><a href="#local-6989586621683133088"><span class="hs-identifier">dvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#candidateQTyVarsOfKind"><span class="hs-identifier hs-var">candidateQTyVarsOfKind</span></a><span> </span><a href="#local-6989586621683133083"><span class="hs-identifier hs-var">kind_or_type</span></a><span>
</span><a name="line-2096"></a><span>
</span><a name="line-2097"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kindGeneralizeLocal&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2098"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Wanted:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133082"><span class="hs-identifier hs-var">wanted</span></a><span>
</span><a name="line-2099"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Kind or type:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133083"><span class="hs-identifier hs-var">kind_or_type</span></a><span>
</span><a name="line-2100"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;tcvs of wanted:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprTyVars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfWC</span><span> </span><a href="#local-6989586621683133082"><span class="hs-identifier hs-var">wanted</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2101"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;constrained:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprTyVars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><a href="#local-6989586621683133085"><span class="hs-identifier hs-var">constrained</span></a><span class="hs-special">)</span><span>
</span><a name="line-2102"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;mono_tvs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprTyVars</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span> </span><a href="#local-6989586621683133087"><span class="hs-identifier hs-var">mono_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2103"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;dvs:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133088"><span class="hs-identifier hs-var">dvs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2104"></a><span>
</span><a name="line-2105"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#quantifyTyVars"><span class="hs-identifier hs-var">quantifyTyVars</span></a><span> </span><a href="#local-6989586621683133087"><span class="hs-identifier hs-var">mono_tvs</span></a><span> </span><a href="#local-6989586621683133088"><span class="hs-identifier hs-var">dvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2106"></a><span>
</span><a name="line-2107"></a><span class="hs-comment">{- Note [Levels and generalisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f x = e
with no type signature. We are currently at level i.
We must
  * Push the level to level (i+1)
  * Allocate a fresh alpha[i+1] for the result type
  * Check that e :: alpha[i+1], gathering constraint WC
  * Solve WC as far as possible
  * Zonking the result type alpha[i+1], say to beta[i-1] -&gt; gamma[i]
  * Find the free variables with level &gt; i, in this case gamma[i]
  * Skolemise those free variables and quantify over them, giving
       f :: forall g. beta[i-1] -&gt; g
  * Emit the residiual constraint wrapped in an implication for g,
    thus   forall g. WC

All of this happens for types too.  Consider
  f :: Int -&gt; (forall a. Proxy a -&gt; Int)

Note [Kind generalisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~
We do kind generalisation only at the outer level of a type signature.
For example, consider
  T :: forall k. k -&gt; *
  f :: (forall a. T a -&gt; Int) -&gt; Int
When kind-checking f's type signature we generalise the kind at
the outermost level, thus:
  f1 :: forall k. (forall (a:k). T k a -&gt; Int) -&gt; Int  -- YES!
and *not* at the inner forall:
  f2 :: (forall k. forall (a:k). T k a -&gt; Int) -&gt; Int  -- NO!
Reason: same as for HM inference on value level declarations,
we want to infer the most general type.  The f2 type signature
would be *less applicable* than f1, because it requires a more
polymorphic argument.

NB: There are no explicit kind variables written in f's signature.
When there are, the renamer adds these kind variables to the list of
variables bound by the forall, so you can indeed have a type that's
higher-rank in its kind. But only by explicit request.

Note [Kinds of quantified type variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
tcTyVarBndrsGen quantifies over a specified list of type variables,
*and* over the kind variables mentioned in the kinds of those tyvars.

Note that we must zonk those kinds (obviously) but less obviously, we
must return type variables whose kinds are zonked too. Example
    (a :: k7)  where  k7 := k9 -&gt; k9
We must return
    [k9, a:k9-&gt;k9]
and NOT
    [k9, a:k7]
Reason: we're going to turn this into a for-all type,
   forall k9. forall (a:k7). blah
which the type checker will then instantiate, and instantiate does not
look through unification variables!

Hence using zonked_kinds when forming tvs'.

-}</span><span>
</span><a name="line-2168"></a><span>
</span><a name="line-2169"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-2170"></a><span class="hs-identifier">etaExpandAlgTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyConBinder</span><span class="hs-special">]</span><span>
</span><a name="line-2171"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>
</span><a name="line-2172"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyConBinder</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">)</span><span>
</span><a name="line-2173"></a><span class="hs-comment">-- GADT decls can have a (perhaps partial) kind signature</span><span>
</span><a name="line-2174"></a><span class="hs-comment">--      e.g.  data T a :: * -&gt; * -&gt; * where ...</span><span>
</span><a name="line-2175"></a><span class="hs-comment">-- This function makes up suitable (kinded) TyConBinders for the</span><span>
</span><a name="line-2176"></a><span class="hs-comment">-- argument kinds.  E.g. in this case it might return</span><span>
</span><a name="line-2177"></a><span class="hs-comment">--   ([b::*, c::*], *)</span><span>
</span><a name="line-2178"></a><span class="hs-comment">-- Never emits constraints.</span><span>
</span><a name="line-2179"></a><span class="hs-comment">-- It's a little trickier than you might think: see</span><span>
</span><a name="line-2180"></a><span class="hs-comment">-- Note [TyConBinders for the result kind signature of a data type]</span><span>
</span><a name="line-2181"></a><a name="etaExpandAlgTyCon"><a href="TcHsType.html#etaExpandAlgTyCon"><span class="hs-identifier">etaExpandAlgTyCon</span></a></a><span> </span><a name="local-6989586621683133089"><a href="#local-6989586621683133089"><span class="hs-identifier">tc_bndrs</span></a></a><span> </span><a name="local-6989586621683133090"><a href="#local-6989586621683133090"><span class="hs-identifier">kind</span></a></a><span>
</span><a name="line-2182"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133116"><a href="#local-6989586621683133116"><span class="hs-identifier">loc</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-2183"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133117"><a href="#local-6989586621683133117"><span class="hs-identifier">uniqs</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span>
</span><a name="line-2184"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133118"><a href="#local-6989586621683133118"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLocalRdrEnv"><span class="hs-identifier hs-var">getLocalRdrEnv</span></a><span>
</span><a name="line-2185"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133119"><a href="#local-6989586621683133119"><span class="hs-identifier">new_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683133123"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-2186"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683133122"><a href="#local-6989586621683133122"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">allNameStrings</span><span>
</span><a name="line-2187"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133123"><a href="#local-6989586621683133123"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkOccName</span><span> </span><span class="hs-identifier hs-var">tvName</span><span> </span><a href="#local-6989586621683133122"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-2188"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupLocalRdrOcc</span><span> </span><a href="#local-6989586621683133118"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621683133123"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-2189"></a><span>                         </span><span class="hs-comment">-- Note [Avoid name clashes for associated data types]</span><span>
</span><a name="line-2190"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133123"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683133092"><span class="hs-identifier hs-var">lhs_occs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2191"></a><span>              </span><a name="local-6989586621683133120"><a href="#local-6989586621683133120"><span class="hs-identifier">new_uniqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">uniqsFromSupply</span><span> </span><a href="#local-6989586621683133117"><span class="hs-identifier hs-var">uniqs</span></a><span>
</span><a name="line-2192"></a><span>              </span><a name="local-6989586621683133121"><a href="#local-6989586621683133121"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621683133091"><span class="hs-identifier hs-var">lhs_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2193"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133093"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683133116"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683133119"><span class="hs-identifier hs-var">new_occs</span></a><span> </span><a href="#local-6989586621683133120"><span class="hs-identifier hs-var">new_uniqs</span></a><span> </span><a href="#local-6989586621683133121"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683133090"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2194"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2195"></a><span>    </span><a name="local-6989586621683133091"><a href="#local-6989586621683133091"><span class="hs-identifier">lhs_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">binderVar</span><span> </span><a href="#local-6989586621683133089"><span class="hs-identifier hs-var">tc_bndrs</span></a><span>
</span><a name="line-2196"></a><span>    </span><a name="local-6989586621683133092"><a href="#local-6989586621683133092"><span class="hs-identifier">lhs_occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621683133091"><span class="hs-identifier hs-var">lhs_tvs</span></a><span>
</span><a name="line-2197"></a><span>
</span><a name="line-2198"></a><span>    </span><a name="local-6989586621683133093"><a href="#local-6989586621683133093"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683133094"><a href="#local-6989586621683133094"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683133095"><a href="#local-6989586621683133095"><span class="hs-identifier">occs</span></a></a><span> </span><a name="local-6989586621683133096"><a href="#local-6989586621683133096"><span class="hs-identifier">uniqs</span></a></a><span> </span><a name="local-6989586621683133097"><a href="#local-6989586621683133097"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621683133098"><a href="#local-6989586621683133098"><span class="hs-identifier">acc</span></a></a><span> </span><a name="local-6989586621683133099"><a href="#local-6989586621683133099"><span class="hs-identifier">kind</span></a></a><span>
</span><a name="line-2199"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitPiTy_maybe</span><span> </span><a href="#local-6989586621683133099"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2200"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621683133098"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683133097"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683133099"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-2201"></a><span>
</span><a name="line-2202"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Anon</span><span> </span><a name="local-6989586621683133100"><a href="#local-6989586621683133100"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133101"><a href="#local-6989586621683133101"><span class="hs-identifier">kind'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2203"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683133093"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683133094"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683133109"><span class="hs-identifier hs-var">occs'</span></a><span> </span><a href="#local-6989586621683133107"><span class="hs-identifier hs-var">uniqs'</span></a><span> </span><a href="#local-6989586621683133104"><span class="hs-identifier hs-var">subst'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133105"><span class="hs-identifier hs-var">tcb</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683133098"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133101"><span class="hs-identifier hs-var">kind'</span></a><span>
</span><a name="line-2204"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-2205"></a><span>              </span><a name="local-6989586621683133102"><a href="#local-6989586621683133102"><span class="hs-identifier">arg'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683133097"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683133100"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-2206"></a><span>              </span><a name="local-6989586621683133103"><a href="#local-6989586621683133103"><span class="hs-identifier">tv</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInternalName</span><span> </span><a href="#local-6989586621683133106"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621683133108"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="#local-6989586621683133094"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133102"><span class="hs-identifier hs-var">arg'</span></a><span>
</span><a name="line-2207"></a><span>              </span><a name="local-6989586621683133104"><a href="#local-6989586621683133104"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTCvInScope</span><span> </span><a href="#local-6989586621683133097"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683133103"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2208"></a><span>              </span><a name="local-6989586621683133105"><a href="#local-6989586621683133105"><span class="hs-identifier">tcb</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Bndr</span><span> </span><a href="#local-6989586621683133103"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-identifier hs-var">AnonTCB</span><span>
</span><a name="line-2209"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621683133106"><a href="#local-6989586621683133106"><span class="hs-identifier">uniq</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683133107"><a href="#local-6989586621683133107"><span class="hs-identifier">uniqs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683133096"><span class="hs-identifier hs-var">uniqs</span></a><span>
</span><a name="line-2210"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621683133108"><a href="#local-6989586621683133108"><span class="hs-identifier">occ</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683133109"><a href="#local-6989586621683133109"><span class="hs-identifier">occs'</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683133095"><span class="hs-identifier hs-var">occs</span></a><span>
</span><a name="line-2211"></a><span>
</span><a name="line-2212"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Named</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><a name="local-6989586621683133110"><a href="#local-6989586621683133110"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621683133111"><a href="#local-6989586621683133111"><span class="hs-identifier">vis</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683133112"><a href="#local-6989586621683133112"><span class="hs-identifier">kind'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2213"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683133093"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683133094"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683133095"><span class="hs-identifier hs-var">occs</span></a><span> </span><a href="#local-6989586621683133096"><span class="hs-identifier hs-var">uniqs</span></a><span> </span><a href="#local-6989586621683133113"><span class="hs-identifier hs-var">subst'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133115"><span class="hs-identifier hs-var">tcb</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683133098"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133112"><span class="hs-identifier hs-var">kind'</span></a><span>
</span><a name="line-2214"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-2215"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621683133113"><a href="#local-6989586621683133113"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133114"><a href="#local-6989586621683133114"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTyVarBndr</span><span> </span><a href="#local-6989586621683133097"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683133110"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2216"></a><span>              </span><a name="local-6989586621683133115"><a href="#local-6989586621683133115"><span class="hs-identifier">tcb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Bndr</span><span> </span><a href="#local-6989586621683133114"><span class="hs-identifier hs-var">tv'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NamedTCB</span><span> </span><a href="#local-6989586621683133111"><span class="hs-identifier hs-var">vis</span></a><span class="hs-special">)</span><span>
</span><a name="line-2217"></a><span>
</span><a name="line-2218"></a><span class="hs-identifier">badKindSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2219"></a><a name="badKindSig"><a href="TcHsType.html#badKindSig"><span class="hs-identifier">badKindSig</span></a></a><span> </span><a name="local-6989586621683133124"><a href="#local-6989586621683133124"><span class="hs-identifier">check_for_type</span></a></a><span> </span><a name="local-6989586621683133125"><a href="#local-6989586621683133125"><span class="hs-identifier">kind</span></a></a><span>
</span><a name="line-2220"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Kind signature on data type declaration has non-*&quot;</span><span>
</span><a name="line-2221"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683133124"><span class="hs-identifier hs-var">check_for_type</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;and non-variable&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2222"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;return kind&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2223"></a><span>        </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133125"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-2224"></a><span>
</span><a name="line-2225"></a><span class="hs-identifier">tcbVisibilities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyConBndrVis</span><span class="hs-special">]</span><span>
</span><a name="line-2226"></a><span class="hs-comment">-- Result is in 1-1 correpondence with orig_args</span><span>
</span><a name="line-2227"></a><a name="tcbVisibilities"><a href="TcHsType.html#tcbVisibilities"><span class="hs-identifier">tcbVisibilities</span></a></a><span> </span><a name="local-6989586621683133126"><a href="#local-6989586621683133126"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683133127"><a href="#local-6989586621683133127"><span class="hs-identifier">orig_args</span></a></a><span>
</span><a name="line-2228"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683133129"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683133126"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133128"><span class="hs-identifier hs-var">init_subst</span></a><span> </span><a href="#local-6989586621683133127"><span class="hs-identifier hs-var">orig_args</span></a><span>
</span><a name="line-2229"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2230"></a><span>    </span><a name="local-6989586621683133128"><a href="#local-6989586621683133128"><span class="hs-identifier">init_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyTCvSubst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621683133127"><span class="hs-identifier hs-var">orig_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2231"></a><span>    </span><a name="local-6989586621683133129"><a href="#local-6989586621683133129"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2232"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2233"></a><span>
</span><a name="line-2234"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683133130"><a href="#local-6989586621683133130"><span class="hs-identifier">fun_kind</span></a></a><span> </span><a name="local-6989586621683133131"><a href="#local-6989586621683133131"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621683133132"><a href="#local-6989586621683133132"><span class="hs-identifier">all_args</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683133133"><a href="#local-6989586621683133133"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683133134"><a href="#local-6989586621683133134"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2235"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133135"><a href="#local-6989586621683133135"><span class="hs-identifier">tcb</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133136"><a href="#local-6989586621683133136"><span class="hs-identifier">inner_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitPiTy_maybe</span><span> </span><a href="#local-6989586621683133130"><span class="hs-identifier hs-var">fun_kind</span></a><span>
</span><a name="line-2236"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133135"><span class="hs-identifier hs-var">tcb</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2237"></a><span>          </span><span class="hs-identifier hs-var">Anon</span><span> </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">AnonTCB</span><span>      </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683133129"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683133136"><span class="hs-identifier hs-var">inner_kind</span></a><span> </span><a href="#local-6989586621683133131"><span class="hs-identifier hs-var">subst</span></a><span>  </span><a href="#local-6989586621683133134"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2238"></a><span>          </span><span class="hs-identifier hs-var">Named</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><a name="local-6989586621683133137"><a href="#local-6989586621683133137"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621683133138"><a href="#local-6989586621683133138"><span class="hs-identifier">vis</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NamedTCB</span><span> </span><a href="#local-6989586621683133138"><span class="hs-identifier hs-var">vis</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683133129"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683133136"><span class="hs-identifier hs-var">inner_kind</span></a><span> </span><a href="#local-6989586621683133139"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621683133134"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2239"></a><span>                 </span><span class="hs-keyword">where</span><span>
</span><a name="line-2240"></a><span>                    </span><a name="local-6989586621683133139"><a href="#local-6989586621683133139"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTCvSubst</span><span> </span><a href="#local-6989586621683133131"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683133137"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621683133133"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-2241"></a><span>
</span><a name="line-2242"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyTCvSubst</span><span> </span><a href="#local-6989586621683133131"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-2243"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683133129"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683133131"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683133130"><span class="hs-identifier hs-var">fun_kind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133128"><span class="hs-identifier hs-var">init_subst</span></a><span> </span><a href="#local-6989586621683133132"><span class="hs-identifier hs-var">all_args</span></a><span>
</span><a name="line-2244"></a><span>
</span><a name="line-2245"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2246"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;addTcbVisibilities&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133126"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133127"><span class="hs-identifier hs-var">orig_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-2247"></a><span>
</span><a name="line-2248"></a><span>
</span><a name="line-2249"></a><span class="hs-comment">{- Note [TyConBinders for the result kind signature of a data type]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Given
  data T (a::*) :: * -&gt; forall k. k -&gt; *
we want to generate the extra TyConBinders for T, so we finally get
  (a::*) (b::*) (k::*) (c::k)
The function etaExpandAlgTyCon generates these extra TyConBinders from
the result kind signature.

We need to take care to give the TyConBinders
  (a) OccNames that are fresh (because the TyConBinders of a TyCon
      must have distinct OccNames

  (b) Uniques that are fresh (obviously)

For (a) we need to avoid clashes with the tyvars declared by
the user before the &quot;::&quot;; in the above example that is 'a'.
And also see Note [Avoid name clashes for associated data types].

For (b) suppose we have
   data T :: forall k. k -&gt; forall k. k -&gt; *
where the two k's are identical even up to their uniques.  Surprisingly,
this can happen: see Trac #14515.

It's reasonably easy to solve all this; just run down the list with a
substitution; hence the recursive 'go' function.  But it has to be
done.

Note [Avoid name clashes for associated data types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider    class C a b where
               data D b :: * -&gt; *
When typechecking the decl for D, we'll invent an extra type variable
for D, to fill out its kind.  Ideally we don't want this type variable
to be 'a', because when pretty printing we'll get
            class C a b where
               data D b a0
(NB: the tidying happens in the conversion to IfaceSyn, which happens
as part of pretty-printing a TyThing.)

That's why we look in the LocalRdrEnv to see what's in scope. This is
important only to get nice-looking output when doing &quot;:info C&quot; in GHCi.
It isn't essential for correctness.


************************************************************************
*                                                                      *
             Partial signatures
*                                                                      *
************************************************************************

-}</span><span>
</span><a name="line-2301"></a><span>
</span><a name="line-2302"></a><span class="hs-identifier">tcHsPartialSigType</span><span>
</span><a name="line-2303"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span>
</span><a name="line-2304"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>       </span><span class="hs-comment">-- The type signature</span><span>
</span><a name="line-2305"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Wildcards</span><span>
</span><a name="line-2306"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>       </span><span class="hs-comment">-- Extra-constraints wildcard</span><span>
</span><a name="line-2307"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Original tyvar names, in correspondence with ...</span><span>
</span><a name="line-2308"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- ... Implicitly and explicitly bound type variables</span><span>
</span><a name="line-2309"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcThetaType</span><span>        </span><span class="hs-comment">-- Theta part</span><span>
</span><a name="line-2310"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Tau part</span><span>
</span><a name="line-2311"></a><span class="hs-comment">-- See Note [Recipe for checking a signature]</span><span>
</span><a name="line-2312"></a><a name="tcHsPartialSigType"><a href="TcHsType.html#tcHsPartialSigType"><span class="hs-identifier">tcHsPartialSigType</span></a></a><span> </span><a name="local-6989586621683133140"><a href="#local-6989586621683133140"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683133141"><a href="#local-6989586621683133141"><span class="hs-identifier">sig_ty</span></a></a><span>
</span><a name="line-2313"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hswc_ext</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133142"><a href="#local-6989586621683133142"><span class="hs-identifier">sig_wcs</span></a></a><span class="hs-special">,</span><span>         </span><span class="hs-identifier">hswc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133143"><a href="#local-6989586621683133143"><span class="hs-identifier">ib_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683133141"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-2314"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133144"><a href="#local-6989586621683133144"><span class="hs-identifier">implicit_hs_tvs</span></a></a><span>
</span><a name="line-2315"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133145"><a href="#local-6989586621683133145"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683133143"><span class="hs-identifier hs-var">ib_ty</span></a><span>
</span><a name="line-2316"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133146"><a href="#local-6989586621683133146"><span class="hs-identifier">explicit_hs_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133147"><a href="#local-6989586621683133147"><span class="hs-identifier">hs_ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133148"><a href="#local-6989586621683133148"><span class="hs-identifier">hs_tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">splitLHsSigmaTy</span><span> </span><a href="#local-6989586621683133145"><span class="hs-identifier hs-var">hs_ty</span></a><span>
</span><a name="line-2317"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addSigCtxt"><span class="hs-identifier hs-var">addSigCtxt</span></a><span> </span><a href="#local-6989586621683133140"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683133145"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2318"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133153"><a href="#local-6989586621683133153"><span class="hs-identifier">implicit_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133154"><a href="#local-6989586621683133154"><span class="hs-identifier">explicit_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133155"><a href="#local-6989586621683133155"><span class="hs-identifier">wcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133156"><a href="#local-6989586621683133156"><span class="hs-identifier">wcx</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133157"><a href="#local-6989586621683133157"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133158"><a href="#local-6989586621683133158"><span class="hs-identifier">tau</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2319"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcWildCardBinders"><span class="hs-identifier hs-var">tcWildCardBinders</span></a><span> </span><a href="#local-6989586621683133142"><span class="hs-identifier hs-var">sig_wcs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683133149"><a href="#local-6989586621683133149"><span class="hs-identifier">wcs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2320"></a><span>               </span><a href="TcHsType.html#bindImplicitTKBndrs_Tv"><span class="hs-identifier hs-var">bindImplicitTKBndrs_Tv</span></a><span> </span><a href="#local-6989586621683133144"><span class="hs-identifier hs-var">implicit_hs_tvs</span></a><span>       </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2321"></a><span>               </span><a href="TcHsType.html#bindExplicitTKBndrs_Tv"><span class="hs-identifier hs-var">bindExplicitTKBndrs_Tv</span></a><span> </span><a href="#local-6989586621683133146"><span class="hs-identifier hs-var">explicit_hs_tvs</span></a><span>       </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2322"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- Instantiate the type-class context; but if there</span><span>
</span><a name="line-2323"></a><span>                      </span><span class="hs-comment">-- is an extra-constraints wildcard, just discard it here</span><span>
</span><a name="line-2324"></a><span>                    </span><span class="hs-special">(</span><a name="local-6989586621683133150"><a href="#local-6989586621683133150"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133151"><a href="#local-6989586621683133151"><span class="hs-identifier">wcx</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcPartialContext"><span class="hs-identifier hs-var">tcPartialContext</span></a><span> </span><a href="#local-6989586621683133147"><span class="hs-identifier hs-var">hs_ctxt</span></a><span>
</span><a name="line-2325"></a><span>
</span><a name="line-2326"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133152"><a href="#local-6989586621683133152"><span class="hs-identifier">tau</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier hs-var">tcHsOpenType</span></a><span> </span><a href="#local-6989586621683133148"><span class="hs-identifier hs-var">hs_tau</span></a><span>
</span><a name="line-2327"></a><span>
</span><a name="line-2328"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133149"><span class="hs-identifier hs-var">wcs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133151"><span class="hs-identifier hs-var">wcx</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133150"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133152"><span class="hs-identifier hs-var">tau</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2329"></a><span>
</span><a name="line-2330"></a><span>         </span><span class="hs-comment">-- We must return these separately, because all the zonking below</span><span>
</span><a name="line-2331"></a><span>         </span><span class="hs-comment">-- might change the name of a TyVarTv. This, in turn, causes trouble</span><span>
</span><a name="line-2332"></a><span>         </span><span class="hs-comment">-- in partial type signatures that bind scoped type variables, as</span><span>
</span><a name="line-2333"></a><span>         </span><span class="hs-comment">-- we bring the wrong name into scope in the function body.</span><span>
</span><a name="line-2334"></a><span>         </span><span class="hs-comment">-- Test case: partial-sigs/should_compile/LocalDefinitionBug</span><span>
</span><a name="line-2335"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133159"><a href="#local-6989586621683133159"><span class="hs-identifier">tv_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">tyVarName</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133153"><span class="hs-identifier hs-var">implicit_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683133154"><span class="hs-identifier hs-var">explicit_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2336"></a><span>
</span><a name="line-2337"></a><span>       </span><span class="hs-comment">-- Spit out the wildcards (including the extra-constraints one)</span><span>
</span><a name="line-2338"></a><span>       </span><span class="hs-comment">-- as &quot;hole&quot; constraints, so that they'll be reported if necessary</span><span>
</span><a name="line-2339"></a><span>       </span><span class="hs-comment">-- See Note [Extra-constraint holes in partial type signatures]</span><span>
</span><a name="line-2340"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitWildCardHoleConstraints"><span class="hs-identifier hs-var">emitWildCardHoleConstraints</span></a><span> </span><a href="#local-6989586621683133155"><span class="hs-identifier hs-var">wcs</span></a><span>
</span><a name="line-2341"></a><span>
</span><a name="line-2342"></a><span>         </span><span class="hs-comment">-- The TyVarTvs created above will sometimes have too high a TcLevel</span><span>
</span><a name="line-2343"></a><span>         </span><span class="hs-comment">-- (note that they are generated *after* bumping the level in</span><span>
</span><a name="line-2344"></a><span>         </span><span class="hs-comment">-- the tc{Im,Ex}plicitTKBndrsSig functions. Bumping the level</span><span>
</span><a name="line-2345"></a><span>         </span><span class="hs-comment">-- is still important here, because the kinds of these variables</span><span>
</span><a name="line-2346"></a><span>         </span><span class="hs-comment">-- do indeed need to have the higher level, so they can unify</span><span>
</span><a name="line-2347"></a><span>         </span><span class="hs-comment">-- with other local type variables. But, now that we've type-checked</span><span>
</span><a name="line-2348"></a><span>         </span><span class="hs-comment">-- everything (and solved equalities in the tcImplicit call)</span><span>
</span><a name="line-2349"></a><span>         </span><span class="hs-comment">-- we need to promote the TyVarTvs so we don't violate the TcLevel</span><span>
</span><a name="line-2350"></a><span>         </span><span class="hs-comment">-- invariant</span><span>
</span><a name="line-2351"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133160"><a href="#local-6989586621683133160"><span class="hs-identifier">implicit_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkAndScopedSort"><span class="hs-identifier hs-var">zonkAndScopedSort</span></a><span> </span><a href="#local-6989586621683133153"><span class="hs-identifier hs-var">implicit_tvs</span></a><span>
</span><a name="line-2352"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133161"><a href="#local-6989586621683133161"><span class="hs-identifier">explicit_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTcTyCoVarBndr"><span class="hs-identifier hs-var">zonkTcTyCoVarBndr</span></a><span> </span><a href="#local-6989586621683133154"><span class="hs-identifier hs-var">explicit_tvs</span></a><span>
</span><a name="line-2353"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133162"><a href="#local-6989586621683133162"><span class="hs-identifier">theta</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683133157"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-2354"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133163"><a href="#local-6989586621683133163"><span class="hs-identifier">tau</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683133158"><span class="hs-identifier hs-var">tau</span></a><span>
</span><a name="line-2355"></a><span>
</span><a name="line-2356"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133164"><a href="#local-6989586621683133164"><span class="hs-identifier">all_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683133160"><span class="hs-identifier hs-var">implicit_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683133161"><span class="hs-identifier hs-var">explicit_tvs</span></a><span>
</span><a name="line-2357"></a><span>
</span><a name="line-2358"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621683133140"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkSpecForAllTys</span><span> </span><a href="#local-6989586621683133164"><span class="hs-identifier hs-var">all_tvs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPhiTy</span><span> </span><a href="#local-6989586621683133162"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621683133163"><span class="hs-identifier hs-var">tau</span></a><span class="hs-special">)</span><span>
</span><a name="line-2359"></a><span>
</span><a name="line-2360"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcHsPartialSigType&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133164"><span class="hs-identifier hs-var">all_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2361"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133155"><span class="hs-identifier hs-var">wcs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133156"><span class="hs-identifier hs-var">wcx</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133159"><span class="hs-identifier hs-var">tv_names</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133164"><span class="hs-identifier hs-var">all_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133162"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133163"><span class="hs-identifier hs-var">tau</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2362"></a><span>
</span><a name="line-2363"></a><span class="hs-identifier">tcHsPartialSigType</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcHsPartialSigType&quot;</span><span>
</span><a name="line-2364"></a><span class="hs-identifier">tcHsPartialSigType</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsWildCardBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcHsPartialSigType&quot;</span><span>
</span><a name="line-2365"></a><span>
</span><a name="line-2366"></a><span class="hs-identifier">tcPartialContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsContext</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcThetaType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>
</span><a name="line-2367"></a><a name="tcPartialContext"><a href="TcHsType.html#tcPartialContext"><span class="hs-identifier">tcPartialContext</span></a></a><span> </span><a name="local-6989586621683133165"><a href="#local-6989586621683133165"><span class="hs-identifier">hs_theta</span></a></a><span>
</span><a name="line-2368"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133166"><a href="#local-6989586621683133166"><span class="hs-identifier">hs_theta1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133167"><a href="#local-6989586621683133167"><span class="hs-identifier">hs_ctxt_last</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">snocView</span><span> </span><a href="#local-6989586621683133165"><span class="hs-identifier hs-var">hs_theta</span></a><span>
</span><a name="line-2369"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683133168"><a href="#local-6989586621683133168"><span class="hs-identifier">wc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWildCardTy</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ignoreParens</span><span> </span><a href="#local-6989586621683133167"><span class="hs-identifier hs-var">hs_ctxt_last</span></a><span>
</span><a name="line-2370"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133169"><a href="#local-6989586621683133169"><span class="hs-identifier">wc_tv_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcWildCardOcc"><span class="hs-identifier hs-var">tcWildCardOcc</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621683133168"><span class="hs-identifier hs-var">wc</span></a><span> </span><span class="hs-identifier hs-var">constraintKind</span><span>
</span><a name="line-2371"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133170"><a href="#local-6989586621683133170"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcHsType.html#tcLHsPredType"><span class="hs-identifier hs-var">tcLHsPredType</span></a><span> </span><a href="#local-6989586621683133166"><span class="hs-identifier hs-var">hs_theta1</span></a><span>
</span><a name="line-2372"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133170"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683133169"><span class="hs-identifier hs-var">wc_tv_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2373"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2374"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133171"><a href="#local-6989586621683133171"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcHsType.html#tcLHsPredType"><span class="hs-identifier hs-var">tcLHsPredType</span></a><span> </span><a href="#local-6989586621683133165"><span class="hs-identifier hs-var">hs_theta</span></a><span>
</span><a name="line-2375"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133171"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2376"></a><span>
</span><a name="line-2377"></a><span class="hs-comment">{- Note [Extra-constraint holes in partial type signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  f :: (_) =&gt; a -&gt; a
  f x = ...

* The renamer leaves '_' untouched.

* Then, in tcHsPartialSigType, we make a new hole TcTyVar, in
  tcWildCardBinders.

* TcBinds.chooseInferredQuantifiers fills in that hole TcTyVar
  with the inferred constraints, e.g. (Eq a, Show a)

* TcErrors.mkHoleError finally reports the error.

An annoying difficulty happens if there are more than 62 inferred
constraints. Then we need to fill in the TcTyVar with (say) a 70-tuple.
Where do we find the TyCon?  For good reasons we only have constraint
tuples up to 62 (see Note [How tuples work] in TysWiredIn).  So how
can we make a 70-tuple?  This was the root cause of Trac #14217.

It's incredibly tiresome, because we only need this type to fill
in the hole, to communicate to the error reporting machinery.  Nothing
more.  So I use a HACK:

* I make an /ordinary/ tuple of the constraints, in
  TcBinds.chooseInferredQuantifiers. This is ill-kinded because
  ordinary tuples can't contain constraints, but it works fine. And for
  ordinary tuples we don't have the same limit as for constraint
  tuples (which need selectors and an assocated class).

* Because it is ill-kinded, it trips an assert in writeMetaTyVar,
  so now I disable the assertion if we are writing a type of
  kind Constraint.  (That seldom/never normally happens so we aren't
  losing much.)

Result works fine, but it may eventually bite us.


************************************************************************
*                                                                      *
      Pattern signatures (i.e signatures that occur in patterns)
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-2422"></a><span>
</span><a name="line-2423"></a><span class="hs-identifier">tcHsPatSigType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span>
</span><a name="line-2424"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>          </span><span class="hs-comment">-- The type signature</span><span>
</span><a name="line-2425"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Wildcards</span><span>
</span><a name="line-2426"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- The new bit of type environment, binding</span><span>
</span><a name="line-2427"></a><span>                                              </span><span class="hs-comment">-- the scoped type variables</span><span>
</span><a name="line-2428"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- The type</span><span>
</span><a name="line-2429"></a><span class="hs-comment">-- Used for type-checking type signatures in</span><span>
</span><a name="line-2430"></a><span class="hs-comment">-- (a) patterns           e.g  f (x::Int) = e</span><span>
</span><a name="line-2431"></a><span class="hs-comment">-- (b) RULE forall bndrs  e.g. forall (x::Int). f x = x</span><span>
</span><a name="line-2432"></a><span class="hs-comment">--</span><span>
</span><a name="line-2433"></a><span class="hs-comment">-- This may emit constraints</span><span>
</span><a name="line-2434"></a><span class="hs-comment">-- See Note [Recipe for checking a signature]</span><span>
</span><a name="line-2435"></a><a name="tcHsPatSigType"><a href="TcHsType.html#tcHsPatSigType"><span class="hs-identifier">tcHsPatSigType</span></a></a><span> </span><a name="local-6989586621683133172"><a href="#local-6989586621683133172"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683133173"><a href="#local-6989586621683133173"><span class="hs-identifier">sig_ty</span></a></a><span>
</span><a name="line-2436"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hswc_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133178"><a href="#local-6989586621683133178"><span class="hs-identifier">sig_wcs</span></a></a><span class="hs-special">,</span><span>   </span><span class="hs-identifier">hswc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133179"><a href="#local-6989586621683133179"><span class="hs-identifier">ib_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683133173"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-2437"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsIB</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133180"><a href="#local-6989586621683133180"><span class="hs-identifier">sig_vars</span></a></a><span>
</span><a name="line-2438"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683133181"><a href="#local-6989586621683133181"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683133179"><span class="hs-identifier hs-var">ib_ty</span></a><span>
</span><a name="line-2439"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#addSigCtxt"><span class="hs-identifier hs-var">addSigCtxt</span></a><span> </span><a href="#local-6989586621683133172"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683133181"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2440"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133182"><a href="#local-6989586621683133182"><span class="hs-identifier">sig_tkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683133174"><span class="hs-identifier hs-var">new_implicit_tv</span></a><span> </span><a href="#local-6989586621683133180"><span class="hs-identifier hs-var">sig_vars</span></a><span>
</span><a name="line-2441"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133185"><a href="#local-6989586621683133185"><span class="hs-identifier">wcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133186"><a href="#local-6989586621683133186"><span class="hs-identifier">sig_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2442"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveLocalEqualities"><span class="hs-identifier hs-var">solveLocalEqualities</span></a><span> </span><span class="hs-string">&quot;tcHsPatSigType&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2443"></a><span>                 </span><span class="hs-comment">-- Always solve local equalities if possible,</span><span>
</span><a name="line-2444"></a><span>                 </span><span class="hs-comment">-- else casts get in the way of deep skolemisation</span><span>
</span><a name="line-2445"></a><span>                 </span><span class="hs-comment">-- (Trac #16033)</span><span>
</span><a name="line-2446"></a><span>               </span><a href="TcHsType.html#tcWildCardBinders"><span class="hs-identifier hs-var">tcWildCardBinders</span></a><span> </span><a href="#local-6989586621683133178"><span class="hs-identifier hs-var">sig_wcs</span></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683133183"><a href="#local-6989586621683133183"><span class="hs-identifier">wcs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2447"></a><span>               </span><a href="TcEnv.html#tcExtendTyVarEnv"><span class="hs-identifier hs-var">tcExtendTyVarEnv</span></a><span> </span><a href="#local-6989586621683133182"><span class="hs-identifier hs-var">sig_tkvs</span></a><span>                           </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2448"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133184"><a href="#local-6989586621683133184"><span class="hs-identifier">sig_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier hs-var">tcHsOpenType</span></a><span> </span><a href="#local-6989586621683133181"><span class="hs-identifier hs-var">hs_ty</span></a><span>
</span><a name="line-2449"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133183"><span class="hs-identifier hs-var">wcs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133184"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2450"></a><span>
</span><a name="line-2451"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitWildCardHoleConstraints"><span class="hs-identifier hs-var">emitWildCardHoleConstraints</span></a><span> </span><a href="#local-6989586621683133185"><span class="hs-identifier hs-var">wcs</span></a><span>
</span><a name="line-2452"></a><span>
</span><a name="line-2453"></a><span>          </span><span class="hs-comment">-- sig_ty might have tyvars that are at a higher TcLevel (if hs_ty</span><span>
</span><a name="line-2454"></a><span>          </span><span class="hs-comment">-- contains a forall). Promote these.</span><span>
</span><a name="line-2455"></a><span>          </span><span class="hs-comment">-- Ex: f (x :: forall a. Proxy a -&gt; ()) = ... x ...</span><span>
</span><a name="line-2456"></a><span>          </span><span class="hs-comment">-- When we instantiate x, we have to compare the kind of the argument</span><span>
</span><a name="line-2457"></a><span>          </span><span class="hs-comment">-- to a's kind, which will be a metavariable.</span><span>
</span><a name="line-2458"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133187"><a href="#local-6989586621683133187"><span class="hs-identifier">sig_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkPromoteType"><span class="hs-identifier hs-var">zonkPromoteType</span></a><span> </span><a href="#local-6989586621683133186"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-2459"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621683133172"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683133187"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-2460"></a><span>
</span><a name="line-2461"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133188"><a href="#local-6989586621683133188"><span class="hs-identifier">tv_pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarNamePairs</span><span> </span><a href="#local-6989586621683133182"><span class="hs-identifier hs-var">sig_tkvs</span></a><span>
</span><a name="line-2462"></a><span>
</span><a name="line-2463"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcHsPatSigType&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133180"><span class="hs-identifier hs-var">sig_vars</span></a><span class="hs-special">)</span><span>
</span><a name="line-2464"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133185"><span class="hs-identifier hs-var">wcs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133188"><span class="hs-identifier hs-var">tv_pairs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133187"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2465"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2466"></a><span>    </span><a name="local-6989586621683133174"><a href="#local-6989586621683133174"><span class="hs-identifier">new_implicit_tv</span></a></a><span> </span><a name="local-6989586621683133176"><a href="#local-6989586621683133176"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133177"><a href="#local-6989586621683133177"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-2467"></a><span>                              </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683133175"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621683133176"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683133177"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2468"></a><span>
</span><a name="line-2469"></a><span>    </span><a name="local-6989586621683133175"><a href="#local-6989586621683133175"><span class="hs-identifier">new_tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133172"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2470"></a><span>               </span><span class="hs-identifier hs-var">RuleSigCtxt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#newSkolemTyVar"><span class="hs-identifier hs-var">newSkolemTyVar</span></a><span>
</span><a name="line-2471"></a><span>               </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#newTauTyVar"><span class="hs-identifier hs-var">newTauTyVar</span></a><span>
</span><a name="line-2472"></a><span>      </span><span class="hs-comment">-- See Note [Pattern signature binders]</span><span>
</span><a name="line-2473"></a><span>
</span><a name="line-2474"></a><span>
</span><a name="line-2475"></a><span class="hs-identifier">tcHsPatSigType</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsImplicitBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcHsPatSigType&quot;</span><span>
</span><a name="line-2476"></a><span class="hs-identifier">tcHsPatSigType</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsWildCardBndrs</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcHsPatSigType&quot;</span><span>
</span><a name="line-2477"></a><span>
</span><a name="line-2478"></a><span class="hs-identifier">tcPatSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>                    </span><span class="hs-comment">-- True &lt;=&gt; pattern binding</span><span>
</span><a name="line-2479"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsSigWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-2480"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>
</span><a name="line-2481"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- The type to use for &quot;inside&quot; the signature</span><span>
</span><a name="line-2482"></a><span>                 </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- The new bit of type environment, binding</span><span>
</span><a name="line-2483"></a><span>                                    </span><span class="hs-comment">-- the scoped type variables</span><span>
</span><a name="line-2484"></a><span>                 </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- The wildcards</span><span>
</span><a name="line-2485"></a><span>                 </span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Coercion due to unification with actual ty</span><span>
</span><a name="line-2486"></a><span>                                    </span><span class="hs-comment">-- Of shape:  res_ty ~ sig_ty</span><span>
</span><a name="line-2487"></a><a name="tcPatSig"><a href="TcHsType.html#tcPatSig"><span class="hs-identifier">tcPatSig</span></a></a><span> </span><a name="local-6989586621683133189"><a href="#local-6989586621683133189"><span class="hs-identifier">in_pat_bind</span></a></a><span> </span><a name="local-6989586621683133190"><a href="#local-6989586621683133190"><span class="hs-identifier">sig</span></a></a><span> </span><a name="local-6989586621683133191"><a href="#local-6989586621683133191"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-2488"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133201"><a href="#local-6989586621683133201"><span class="hs-identifier">sig_wcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133202"><a href="#local-6989586621683133202"><span class="hs-identifier">sig_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133203"><a href="#local-6989586621683133203"><span class="hs-identifier">sig_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsPatSigType"><span class="hs-identifier hs-var">tcHsPatSigType</span></a><span> </span><span class="hs-identifier hs-var">PatSigCtxt</span><span> </span><a href="#local-6989586621683133190"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-2489"></a><span>        </span><span class="hs-comment">-- sig_tvs are the type variables free in 'sig',</span><span>
</span><a name="line-2490"></a><span>        </span><span class="hs-comment">-- and not already in scope. These are the ones</span><span>
</span><a name="line-2491"></a><span>        </span><span class="hs-comment">-- that should be brought into scope</span><span>
</span><a name="line-2492"></a><span>
</span><a name="line-2493"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683133202"><span class="hs-identifier hs-var">sig_tvs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-2494"></a><span>                </span><span class="hs-comment">-- Just do the subsumption check and return</span><span>
</span><a name="line-2495"></a><span>                  </span><a name="local-6989586621683133204"><a href="#local-6989586621683133204"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133192"><span class="hs-identifier hs-var">mk_msg</span></a><span> </span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2496"></a><span>                          </span><a href="TcUnify.html#tcSubTypeET"><span class="hs-identifier hs-var">tcSubTypeET</span></a><span> </span><span class="hs-identifier hs-var">PatSigOrigin</span><span> </span><span class="hs-identifier hs-var">PatSigCtxt</span><span> </span><a href="#local-6989586621683133191"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-2497"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133201"><span class="hs-identifier hs-var">sig_wcs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133204"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span>
</span><a name="line-2498"></a><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2499"></a><span>                </span><span class="hs-comment">-- Type signature binds at least one scoped type variable</span><span>
</span><a name="line-2500"></a><span>
</span><a name="line-2501"></a><span>                </span><span class="hs-comment">-- A pattern binding cannot bind scoped type variables</span><span>
</span><a name="line-2502"></a><span>                </span><span class="hs-comment">-- It is more convenient to make the test here</span><span>
</span><a name="line-2503"></a><span>                </span><span class="hs-comment">-- than in the renamer</span><span>
</span><a name="line-2504"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621683133189"><span class="hs-identifier hs-var">in_pat_bind</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#patBindSigErr"><span class="hs-identifier hs-var">patBindSigErr</span></a><span> </span><a href="#local-6989586621683133202"><span class="hs-identifier hs-var">sig_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2505"></a><span>
</span><a name="line-2506"></a><span>                </span><span class="hs-comment">-- Check that all newly-in-scope tyvars are in fact</span><span>
</span><a name="line-2507"></a><span>                </span><span class="hs-comment">-- constrained by the pattern.  This catches tiresome</span><span>
</span><a name="line-2508"></a><span>                </span><span class="hs-comment">-- cases like</span><span>
</span><a name="line-2509"></a><span>                </span><span class="hs-comment">--      type T a = Int</span><span>
</span><a name="line-2510"></a><span>                </span><span class="hs-comment">--      f :: Int -&gt; Int</span><span>
</span><a name="line-2511"></a><span>                </span><span class="hs-comment">--      f (x :: T a) = ...</span><span>
</span><a name="line-2512"></a><span>                </span><span class="hs-comment">-- Here 'a' doesn't get a binding.  Sigh</span><span>
</span><a name="line-2513"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133205"><a href="#local-6989586621683133205"><span class="hs-identifier">bad_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">exactTyCoVarsOfType</span><span> </span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2514"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span><span> </span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2515"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683133205"><span class="hs-identifier hs-var">bad_tvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcHsType.html#badPatTyVarTvs"><span class="hs-identifier hs-var">badPatTyVarTvs</span></a><span> </span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span> </span><a href="#local-6989586621683133205"><span class="hs-identifier hs-var">bad_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2516"></a><span>
</span><a name="line-2517"></a><span>        </span><span class="hs-comment">-- Now do a subsumption check of the pattern signature against res_ty</span><span>
</span><a name="line-2518"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133206"><a href="#local-6989586621683133206"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133192"><span class="hs-identifier hs-var">mk_msg</span></a><span> </span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2519"></a><span>                  </span><a href="TcUnify.html#tcSubTypeET"><span class="hs-identifier hs-var">tcSubTypeET</span></a><span> </span><span class="hs-identifier hs-var">PatSigOrigin</span><span> </span><span class="hs-identifier hs-var">PatSigCtxt</span><span> </span><a href="#local-6989586621683133191"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-2520"></a><span>
</span><a name="line-2521"></a><span>        </span><span class="hs-comment">-- Phew!</span><span>
</span><a name="line-2522"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133203"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133202"><span class="hs-identifier hs-var">sig_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133201"><span class="hs-identifier hs-var">sig_wcs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133206"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span>
</span><a name="line-2523"></a><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2524"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2525"></a><span>    </span><a name="local-6989586621683133192"><a href="#local-6989586621683133192"><span class="hs-identifier">mk_msg</span></a></a><span> </span><a name="local-6989586621683133193"><a href="#local-6989586621683133193"><span class="hs-identifier">sig_ty</span></a></a><span> </span><a name="local-6989586621683133194"><a href="#local-6989586621683133194"><span class="hs-identifier">tidy_env</span></a></a><span>
</span><a name="line-2526"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133195"><a href="#local-6989586621683133195"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133196"><a href="#local-6989586621683133196"><span class="hs-identifier">sig_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-6989586621683133194"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621683133193"><span class="hs-identifier hs-var">sig_ty</span></a><span>
</span><a name="line-2527"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133197"><a href="#local-6989586621683133197"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683133191"><span class="hs-identifier hs-var">res_ty</span></a><span>   </span><span class="hs-comment">-- should be filled in by now</span><span>
</span><a name="line-2528"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133198"><a href="#local-6989586621683133198"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133199"><a href="#local-6989586621683133199"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTidyTcType"><span class="hs-identifier hs-var">zonkTidyTcType</span></a><span> </span><a href="#local-6989586621683133195"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621683133197"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-2529"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133200"><a href="#local-6989586621683133200"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When checking that the pattern signature:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2530"></a><span>                                  </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133196"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2531"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;fits the type of its context:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2532"></a><span>                                          </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133199"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2533"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133198"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133200"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2534"></a><span>
</span><a name="line-2535"></a><span class="hs-identifier">patBindSigErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2536"></a><a name="patBindSigErr"><a href="TcHsType.html#patBindSigErr"><span class="hs-identifier">patBindSigErr</span></a></a><span> </span><a name="local-6989586621683133207"><a href="#local-6989586621683133207"><span class="hs-identifier">sig_tvs</span></a></a><span>
</span><a name="line-2537"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;You cannot bind scoped type variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">plural</span><span> </span><a href="#local-6989586621683133207"><span class="hs-identifier hs-var">sig_tvs</span></a><span>
</span><a name="line-2538"></a><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprQuotedList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621683133207"><span class="hs-identifier hs-var">sig_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2539"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in a pattern binding signature&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2540"></a><span>
</span><a name="line-2541"></a><span class="hs-comment">{- Note [Pattern signature binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See also Note [Type variables in the type environment] in TcRnTypes.
Consider

  data T where
    MkT :: forall a. a -&gt; (a -&gt; Int) -&gt; T

  f :: T -&gt; ...
  f (MkT x (f :: b -&gt; c)) = &lt;blah&gt;

Here
 * The pattern (MkT p1 p2) creates a *skolem* type variable 'a_sk',
   It must be a skolem so that that it retains its identity, and
   TcErrors.getSkolemInfo can thereby find the binding site for the skolem.

 * The type signature pattern (f :: b -&gt; c) makes freshs meta-tyvars
   beta and gamma (TauTvs), and binds &quot;b&quot; :-&gt; beta, &quot;c&quot; :-&gt; gamma in the
   environment

 * Then unification makes beta := a_sk, gamma := Int
   That's why we must make beta and gamma a MetaTv,
   not a SkolemTv, so that it can unify to a_sk (or Int, respectively).

 * Finally, in '&lt;blah&gt;' we have the envt &quot;b&quot; :-&gt; beta, &quot;c&quot; :-&gt; gamma,
   so we return the pairs (&quot;b&quot; :-&gt; beta, &quot;c&quot; :-&gt; gamma) from tcHsPatSigType,

Another example (Trac #13881):
   fl :: forall (l :: [a]). Sing l -&gt; Sing l
   fl (SNil :: Sing (l :: [y])) = SNil
When we reach the pattern signature, 'l' is in scope from the
outer 'forall':
   &quot;a&quot; :-&gt; a_sk :: *
   &quot;l&quot; :-&gt; l_sk :: [a_sk]
We make up a fresh meta-TauTv, y_sig, for 'y', and kind-check
the pattern signature
   Sing (l :: [y])
That unifies y_sig := a_sk.  We return from tcHsPatSigType with
the pair (&quot;y&quot; :-&gt; y_sig).

For RULE binders, though, things are a bit different (yuk).
  RULE &quot;foo&quot; forall (x::a) (y::[a]).  f x y = ...
Here this really is the binding site of the type variable so we'd like
to use a skolem, so that we get a complaint if we unify two of them
together.  Hence the new_tv function in tcHsPatSigType.


************************************************************************
*                                                                      *
        Checking kinds
*                                                                      *
************************************************************************

-}</span><span>
</span><a name="line-2595"></a><span>
</span><a name="line-2596"></a><span class="hs-identifier">unifyKinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcKind</span><span class="hs-special">)</span><span>
</span><a name="line-2597"></a><a name="unifyKinds"><a href="TcHsType.html#unifyKinds"><span class="hs-identifier">unifyKinds</span></a></a><span> </span><a name="local-6989586621683133208"><a href="#local-6989586621683133208"><span class="hs-identifier">rn_tys</span></a></a><span> </span><a name="local-6989586621683133209"><a href="#local-6989586621683133209"><span class="hs-identifier">act_kinds</span></a></a><span>
</span><a name="line-2598"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133210"><a href="#local-6989586621683133210"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-2599"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133211"><a href="#local-6989586621683133211"><span class="hs-identifier">check</span></a></a><span> </span><a name="local-6989586621683133212"><a href="#local-6989586621683133212"><span class="hs-identifier">rn_ty</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683133213"><a href="#local-6989586621683133213"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133214"><a href="#local-6989586621683133214"><span class="hs-identifier">act_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#checkExpectedKind"><span class="hs-identifier hs-var">checkExpectedKind</span></a><span> </span><a href="TcHsType.html#YesSaturation"><span class="hs-identifier hs-var">YesSaturation</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683133212"><span class="hs-identifier hs-var">rn_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133213"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683133214"><span class="hs-identifier hs-var">act_kind</span></a><span> </span><a href="#local-6989586621683133210"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-2600"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133215"><a href="#local-6989586621683133215"><span class="hs-identifier">tys'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><a href="#local-6989586621683133211"><span class="hs-identifier hs-var">check</span></a><span> </span><a href="#local-6989586621683133208"><span class="hs-identifier hs-var">rn_tys</span></a><span> </span><a href="#local-6989586621683133209"><span class="hs-identifier hs-var">act_kinds</span></a><span>
</span><a name="line-2601"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133215"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683133210"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2602"></a><span>
</span><a name="line-2603"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
    Promotion
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2610"></a><span>
</span><a name="line-2611"></a><span class="hs-comment">-- | Whenever a type is about to be added to the environment, it's necessary</span><span>
</span><a name="line-2612"></a><span class="hs-comment">-- to make sure that any free meta-tyvars in the type are promoted to the</span><span>
</span><a name="line-2613"></a><span class="hs-comment">-- current TcLevel. (They might be at a higher level due to the level-bumping</span><span>
</span><a name="line-2614"></a><span class="hs-comment">-- in tcExplicitTKBndrs, for example.) This function both zonks *and*</span><span>
</span><a name="line-2615"></a><span class="hs-comment">-- promotes. Why at the same time? See Note [Recipe for checking a signature]</span><span>
</span><a name="line-2616"></a><span class="hs-identifier">zonkPromoteType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-2617"></a><a name="zonkPromoteType"><a href="TcHsType.html#zonkPromoteType"><span class="hs-identifier">zonkPromoteType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapType</span><span> </span><a href="TcHsType.html#zonkPromoteMapper"><span class="hs-identifier hs-var">zonkPromoteMapper</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2618"></a><span>
</span><a name="line-2619"></a><span class="hs-comment">-- cf. TcMType.zonkTcTypeMapper</span><span>
</span><a name="line-2620"></a><span class="hs-identifier">zonkPromoteMapper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCoMapper</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">TcM</span><span>
</span><a name="line-2621"></a><a name="zonkPromoteMapper"><a href="TcHsType.html#zonkPromoteMapper"><span class="hs-identifier">zonkPromoteMapper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TyCoMapper</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcm_smart</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2622"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcm_tyvar</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><a href="TcHsType.html#zonkPromoteTcTyVar"><span class="hs-identifier hs-var">zonkPromoteTcTyVar</span></a><span>
</span><a name="line-2623"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcm_covar</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621683133216"><span class="hs-identifier hs-var">covar</span></a><span>
</span><a name="line-2624"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcm_hole</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621683133217"><span class="hs-identifier hs-var">hole</span></a><span>
</span><a name="line-2625"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcm_tycobinder</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621683133218"><span class="hs-identifier hs-var">tybinder</span></a><span>
</span><a name="line-2626"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcm_tycon</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2627"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2628"></a><span>    </span><a name="local-6989586621683133216"><a href="#local-6989586621683133216"><span class="hs-identifier">covar</span></a></a><span> </span><a name="local-6989586621683133219"><a href="#local-6989586621683133219"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-2629"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCoVarCo</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcHsType.html#zonkPromoteTyCoVarKind"><span class="hs-identifier hs-var">zonkPromoteTyCoVarKind</span></a><span> </span><a href="#local-6989586621683133219"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-2630"></a><span>
</span><a name="line-2631"></a><span>    </span><span class="hs-identifier">hole</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoercionHole</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span>
</span><a name="line-2632"></a><span>    </span><a name="local-6989586621683133217"><a href="#local-6989586621683133217"><span class="hs-identifier">hole</span></a></a><span> </span><a name="local-6989586621683133220"><a href="#local-6989586621683133220"><span class="hs-identifier">h</span></a></a><span>
</span><a name="line-2633"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133222"><a href="#local-6989586621683133222"><span class="hs-identifier">contents</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#unpackCoercionHole_maybe"><span class="hs-identifier hs-var">unpackCoercionHole_maybe</span></a><span> </span><a href="#local-6989586621683133220"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-2634"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133222"><span class="hs-identifier hs-var">contents</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2635"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683133223"><a href="#local-6989586621683133223"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133224"><a href="#local-6989586621683133224"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkPromoteCoercion"><span class="hs-identifier hs-var">zonkPromoteCoercion</span></a><span> </span><a href="#local-6989586621683133223"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2636"></a><span>                             </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#checkCoercionHole"><span class="hs-identifier hs-var">checkCoercionHole</span></a><span> </span><a href="#local-6989586621683133221"><span class="hs-identifier hs-var">cv</span></a><span> </span><a href="#local-6989586621683133224"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2637"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133225"><a href="#local-6989586621683133225"><span class="hs-identifier">cv'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkPromoteTyCoVarKind"><span class="hs-identifier hs-var">zonkPromoteTyCoVarKind</span></a><span> </span><a href="#local-6989586621683133221"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-2638"></a><span>                             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHoleCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setCoHoleCoVar</span><span> </span><a href="#local-6989586621683133220"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621683133225"><span class="hs-identifier hs-var">cv'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2639"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2640"></a><span>        </span><a name="local-6989586621683133221"><a href="#local-6989586621683133221"><span class="hs-identifier">cv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coHoleCoVar</span><span> </span><a href="#local-6989586621683133220"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-2641"></a><span>
</span><a name="line-2642"></a><span>    </span><span class="hs-identifier">tybinder</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ArgFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">)</span><span>
</span><a name="line-2643"></a><span>    </span><a name="local-6989586621683133218"><a href="#local-6989586621683133218"><span class="hs-identifier">tybinder</span></a></a><span> </span><a name="local-6989586621683133226"><a href="#local-6989586621683133226"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621683133227"><a href="#local-6989586621683133227"><span class="hs-identifier">_flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcHsType.html#zonkPromoteTyCoVarKind"><span class="hs-identifier hs-var">zonkPromoteTyCoVarKind</span></a><span> </span><a href="#local-6989586621683133226"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2644"></a><span>
</span><a name="line-2645"></a><span class="hs-identifier">zonkPromoteTcTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCoVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-2646"></a><a name="zonkPromoteTcTyVar"><a href="TcHsType.html#zonkPromoteTcTyVar"><span class="hs-identifier">zonkPromoteTcTyVar</span></a></a><span> </span><a name="local-6989586621683133228"><a href="#local-6989586621683133228"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-2647"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isMetaTyVar</span><span> </span><a href="#local-6989586621683133228"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2648"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683133229"><a href="#local-6989586621683133229"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">metaTyVarRef</span><span> </span><a href="#local-6989586621683133228"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2649"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133230"><a href="#local-6989586621683133230"><span class="hs-identifier">contents</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621683133229"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-2650"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133230"><span class="hs-identifier hs-var">contents</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2651"></a><span>           </span><span class="hs-identifier hs-var">Flexi</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683133231"><a href="#local-6989586621683133231"><span class="hs-identifier">promoted_tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#promoteTyVar"><span class="hs-identifier hs-var">promoteTyVar</span></a><span> </span><a href="#local-6989586621683133228"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2652"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcHsType.html#zonkPromoteTyCoVarKind"><span class="hs-identifier hs-var">zonkPromoteTyCoVarKind</span></a><span> </span><a href="#local-6989586621683133231"><span class="hs-identifier hs-var">promoted_tv</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2653"></a><span>           </span><span class="hs-identifier hs-var">Indirect</span><span> </span><a name="local-6989586621683133232"><a href="#local-6989586621683133232"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#zonkPromoteType"><span class="hs-identifier hs-var">zonkPromoteType</span></a><span> </span><a href="#local-6989586621683133232"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2654"></a><span>
</span><a name="line-2655"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTcTyVar</span><span> </span><a href="#local-6989586621683133228"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isSkolemTyVar</span><span> </span><a href="#local-6989586621683133228"><span class="hs-identifier hs-var">tv</span></a><span>  </span><span class="hs-comment">-- NB: isSkolemTyVar says &quot;True&quot; to pure TyVars</span><span>
</span><a name="line-2656"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133233"><a href="#local-6989586621683133233"><span class="hs-identifier">tc_lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-2657"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcHsType.html#zonkPromoteTyCoVarKind"><span class="hs-identifier hs-var">zonkPromoteTyCoVarKind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">promoteSkolem</span><span> </span><a href="#local-6989586621683133233"><span class="hs-identifier hs-var">tc_lvl</span></a><span> </span><a href="#local-6989586621683133228"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2658"></a><span>
</span><a name="line-2659"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2660"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcHsType.html#zonkPromoteTyCoVarKind"><span class="hs-identifier hs-var">zonkPromoteTyCoVarKind</span></a><span> </span><a href="#local-6989586621683133228"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2661"></a><span>
</span><a name="line-2662"></a><span class="hs-identifier">zonkPromoteTyCoVarKind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCoVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyCoVar</span><span>
</span><a name="line-2663"></a><a name="zonkPromoteTyCoVarKind"><a href="TcHsType.html#zonkPromoteTyCoVarKind"><span class="hs-identifier">zonkPromoteTyCoVarKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updateTyVarKindM</span><span> </span><a href="TcHsType.html#zonkPromoteType"><span class="hs-identifier hs-var">zonkPromoteType</span></a><span>
</span><a name="line-2664"></a><span>
</span><a name="line-2665"></a><span class="hs-identifier">zonkPromoteCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Coercion</span><span>
</span><a name="line-2666"></a><a name="zonkPromoteCoercion"><a href="TcHsType.html#zonkPromoteCoercion"><span class="hs-identifier">zonkPromoteCoercion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapCoercion</span><span> </span><a href="TcHsType.html#zonkPromoteMapper"><span class="hs-identifier hs-var">zonkPromoteMapper</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2667"></a><span>
</span><a name="line-2668"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Sort checking kinds
*                                                                      *
************************************************************************

tcLHsKindSig converts a user-written kind to an internal, sort-checked kind.
It does sort checking and desugaring at the same time, in one single pass.
-}</span><span>
</span><a name="line-2678"></a><span>
</span><a name="line-2679"></a><span class="hs-identifier">tcLHsKindSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UserTypeCtxt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsKind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>
</span><a name="line-2680"></a><a name="tcLHsKindSig"><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier">tcLHsKindSig</span></a></a><span> </span><a name="local-6989586621683133234"><a href="#local-6989586621683133234"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683133235"><a href="#local-6989586621683133235"><span class="hs-identifier">hs_kind</span></a></a><span>
</span><a name="line-2681"></a><span class="hs-comment">-- See  Note [Recipe for checking a signature] in TcHsType</span><span>
</span><a name="line-2682"></a><span class="hs-comment">-- Result is zonked</span><span>
</span><a name="line-2683"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133236"><a href="#local-6989586621683133236"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveLocalEqualities"><span class="hs-identifier hs-var">solveLocalEqualities</span></a><span> </span><span class="hs-string">&quot;tcLHsKindSig&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2684"></a><span>                 </span><a href="TcHsType.html#tc_lhs_kind"><span class="hs-identifier hs-var">tc_lhs_kind</span></a><span> </span><a href="TcHsType.html#kindLevelMode"><span class="hs-identifier hs-var">kindLevelMode</span></a><span> </span><a href="#local-6989586621683133235"><span class="hs-identifier hs-var">hs_kind</span></a><span>
</span><a name="line-2685"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcLHsKindSig&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133235"><span class="hs-identifier hs-var">hs_kind</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133236"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-2686"></a><span>       </span><span class="hs-comment">-- No generalization, so we must promote</span><span>
</span><a name="line-2687"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133237"><a href="#local-6989586621683133237"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#zonkPromoteType"><span class="hs-identifier hs-var">zonkPromoteType</span></a><span> </span><a href="#local-6989586621683133236"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-2688"></a><span>         </span><span class="hs-comment">-- This zonk is very important in the case of higher rank kinds</span><span>
</span><a name="line-2689"></a><span>         </span><span class="hs-comment">-- E.g. Trac #13879    f :: forall (p :: forall z (y::z). &lt;blah&gt;).</span><span>
</span><a name="line-2690"></a><span>         </span><span class="hs-comment">--                          &lt;more blah&gt;</span><span>
</span><a name="line-2691"></a><span>         </span><span class="hs-comment">--      When instantiating p's kind at occurrences of p in &lt;more blah&gt;</span><span>
</span><a name="line-2692"></a><span>         </span><span class="hs-comment">--      it's crucial that the kind we instantiate is fully zonked,</span><span>
</span><a name="line-2693"></a><span>         </span><span class="hs-comment">--      else we may fail to substitute properly</span><span>
</span><a name="line-2694"></a><span>
</span><a name="line-2695"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621683133234"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621683133237"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-2696"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcLHsKindSig2&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133237"><span class="hs-identifier hs-var">kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-2697"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683133237"><span class="hs-identifier hs-var">kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2698"></a><span>
</span><a name="line-2699"></a><span class="hs-identifier">tc_lhs_kind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcHsType.html#TcTyMode"><span class="hs-identifier hs-type">TcTyMode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsKind</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>
</span><a name="line-2700"></a><a name="tc_lhs_kind"><a href="TcHsType.html#tc_lhs_kind"><span class="hs-identifier">tc_lhs_kind</span></a></a><span> </span><a name="local-6989586621683133238"><a href="#local-6989586621683133238"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683133239"><a href="#local-6989586621683133239"><span class="hs-identifier">k</span></a></a><span>
</span><a name="line-2701"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the kind&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133239"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2702"></a><span>    </span><a href="TcHsType.html#tc_lhs_type"><span class="hs-identifier hs-var">tc_lhs_type</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#kindLevel"><span class="hs-identifier hs-var">kindLevel</span></a><span> </span><a href="#local-6989586621683133238"><span class="hs-identifier hs-var">mode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133239"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-2703"></a><span>
</span><a name="line-2704"></a><span class="hs-identifier">promotionErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PromotionErr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132486"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2705"></a><a name="promotionErr"><a href="TcHsType.html#promotionErr"><span class="hs-identifier">promotionErr</span></a></a><span> </span><a name="local-6989586621683133240"><a href="#local-6989586621683133240"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683133241"><a href="#local-6989586621683133241"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-2706"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprPECategory</span><span> </span><a href="#local-6989586621683133241"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133240"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;cannot be used here&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2707"></a><span>                   </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parens</span><span> </span><a href="#local-6989586621683133242"><span class="hs-identifier hs-var">reason</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2708"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2709"></a><span>    </span><a name="local-6989586621683133242"><a href="#local-6989586621683133242"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683133241"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2710"></a><span>               </span><span class="hs-identifier hs-var">ConstrainedDataConPE</span><span> </span><a name="local-6989586621683133243"><a href="#local-6989586621683133243"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-2711"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;it has an unpromotable context&quot;</span><span>
</span><a name="line-2712"></a><span>                                 </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133243"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-2713"></a><span>               </span><span class="hs-identifier hs-var">FamDataConPE</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;it comes from a data family instance&quot;</span><span>
</span><a name="line-2714"></a><span>               </span><span class="hs-identifier hs-var">NoDataKindsTC</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;perhaps you intended to use DataKinds&quot;</span><span>
</span><a name="line-2715"></a><span>               </span><span class="hs-identifier hs-var">NoDataKindsDC</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;perhaps you intended to use DataKinds&quot;</span><span>
</span><a name="line-2716"></a><span>               </span><span class="hs-identifier hs-var">PatSynPE</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;pattern synonyms cannot be promoted&quot;</span><span>
</span><a name="line-2717"></a><span>               </span><span class="hs-identifier hs-var">PatSynExPE</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;the existential variables of a pattern synonym&quot;</span><span>
</span><a name="line-2718"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;signature do not scope over the pattern&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2719"></a><span>               </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;it is defined and used in the same recursive group&quot;</span><span>
</span><a name="line-2720"></a><span>
</span><a name="line-2721"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Scoped type variables
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2728"></a><span>
</span><a name="line-2729"></a><span class="hs-identifier">badPatTyVarTvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2730"></a><a name="badPatTyVarTvs"><a href="TcHsType.html#badPatTyVarTvs"><span class="hs-identifier">badPatTyVarTvs</span></a></a><span> </span><a name="local-6989586621683133244"><a href="#local-6989586621683133244"><span class="hs-identifier">sig_ty</span></a></a><span> </span><a name="local-6989586621683133245"><a href="#local-6989586621683133245"><span class="hs-identifier">bad_tvs</span></a></a><span>
</span><a name="line-2731"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">fsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The type variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">plural</span><span> </span><a href="#local-6989586621683133245"><span class="hs-identifier hs-var">bad_tvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-2732"></a><span>                 </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133245"><span class="hs-identifier hs-var">bad_tvs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-2733"></a><span>                 </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;should be bound by the pattern signature&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133244"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-2734"></a><span>                 </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but are actually discarded by a type synonym&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2735"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;To fix this, expand the type synonym&quot;</span><span>
</span><a name="line-2736"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;[Note: I hope to lift this restriction in due course]&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2737"></a><span>
</span><a name="line-2738"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
          Error messages and such
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2745"></a><span>
</span><a name="line-2746"></a><span>
</span><a name="line-2747"></a><span class="hs-comment">{- Note [Free-floating kind vars]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

  data S a = MkS (Proxy (a :: k))

According to the rules around implicitly-bound kind variables,
that k scopes over the whole declaration. The renamer grabs
it and adds it to the hsq_implicits field of the HsQTyVars of the
tycon.  So we get
   S :: forall {k}. k -&gt; Type

That's fine.  But consider this variant:
  data T = MkT (forall (a :: k). Proxy a)
  -- from test ghci/scripts/T7873

This is not an existential datatype, but a higher-rank one (the forall
to the right of MkT). Again, 'k' scopes over the whole declaration,
but we do not want to get
   T :: forall {k}. Type
Why not? Because the kind variable isn't fixed by anything. For
a variable like k to be implicit, it needs to be mentioned in the kind
of a tycon tyvar. But it isn't.

Rejecting T depends on whether or not the datatype has a CUSK.

Non-CUSK (handled in TcTyClsDecls.kcTyClGroup (generalise)):
   When generalising the TyCon we check that every Specified 'k'
   appears free in the kind of the TyCon; that is, in the kind of
   one of its Required arguments, or the result kind.

CUSK (handled in TcHsType.kcLHsQTyVars, the CUSK case):
   When we determine the tycon's final, never-to-be-changed kind
   in kcLHsQTyVars, we check to make sure all implicitly-bound kind
   vars are indeed mentioned in a kind somewhere. If not, error.

We also perform free-floating kind var analysis for type family instances
(see #13985). Here is an interesting example:

    type family   T :: k
    type instance T = (Nothing :: Maybe a)

Upon a cursory glance, it may appear that the kind variable `a` is
free-floating above, since there are no (visible) LHS patterns in `T`. However,
there is an *invisible* pattern due to the return kind, so inside of GHC, the
instance looks closer to this:

    type family T @k :: k
    type instance T @(Maybe a) = (Nothing :: Maybe a)

Here, we can see that `a` really is bound by a LHS type pattern, so `a` is in
fact not free-floating. Contrast that with this example:

    type instance T = Proxy (Nothing :: Maybe a)

This would looks like this inside of GHC:

    type instance T @(*) = Proxy (Nothing :: Maybe a)

So this time, `a` is neither bound by a visible nor invisible type pattern on
the LHS, so it would be reported as free-floating.

Finally, here's one more brain-teaser (from #9574). In the example below:

    class Funct f where
      type Codomain f :: *
    instance Funct ('KProxy :: KProxy o) where
      type Codomain 'KProxy = NatTr (Proxy :: o -&gt; *)

As it turns out, `o` is not free-floating in this example. That is because `o`
bound by the kind signature of the LHS type pattern 'KProxy. To make this more
obvious, one can also write the instance like so:

    instance Funct ('KProxy :: KProxy o) where
      type Codomain ('KProxy :: KProxy o) = NatTr (Proxy :: o -&gt; *)
-}</span><span>
</span><a name="line-2823"></a><span>
</span><a name="line-2824"></a><span class="hs-comment">-- See Note [Free-floating kind vars]</span><span>
</span><a name="line-2825"></a><span class="hs-identifier">reportFloatingKvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>         </span><span class="hs-comment">-- of the tycon</span><span>
</span><a name="line-2826"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyConFlavour</span><span> </span><span class="hs-comment">-- What sort of TyCon it is</span><span>
</span><a name="line-2827"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- all tyvars, not necessarily zonked</span><span>
</span><a name="line-2828"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- floating tyvars</span><span>
</span><a name="line-2829"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2830"></a><a name="reportFloatingKvs"><a href="TcHsType.html#reportFloatingKvs"><span class="hs-identifier">reportFloatingKvs</span></a></a><span> </span><a name="local-6989586621683133246"><a href="#local-6989586621683133246"><span class="hs-identifier">tycon_name</span></a></a><span> </span><a name="local-6989586621683133247"><a href="#local-6989586621683133247"><span class="hs-identifier">flav</span></a></a><span> </span><a name="local-6989586621683133248"><a href="#local-6989586621683133248"><span class="hs-identifier">all_tvs</span></a></a><span> </span><a name="local-6989586621683133249"><a href="#local-6989586621683133249"><span class="hs-identifier">bad_tvs</span></a></a><span>
</span><a name="line-2831"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683133249"><span class="hs-identifier hs-var">bad_tvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- don't bother zonking if there's no error</span><span>
</span><a name="line-2832"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683133257"><a href="#local-6989586621683133257"><span class="hs-identifier">all_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTcTyVarToTyVar"><span class="hs-identifier hs-var">zonkTcTyVarToTyVar</span></a><span> </span><a href="#local-6989586621683133248"><span class="hs-identifier hs-var">all_tvs</span></a><span>
</span><a name="line-2833"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683133258"><a href="#local-6989586621683133258"><span class="hs-identifier">bad_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcMType.html#zonkTcTyVarToTyVar"><span class="hs-identifier hs-var">zonkTcTyVarToTyVar</span></a><span> </span><a href="#local-6989586621683133249"><span class="hs-identifier hs-var">bad_tvs</span></a><span>
</span><a name="line-2834"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133259"><a href="#local-6989586621683133259"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133260"><a href="#local-6989586621683133260"><span class="hs-identifier">tidy_all_tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyOpenTyCoVars</span><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><a href="#local-6989586621683133257"><span class="hs-identifier hs-var">all_tvs</span></a><span>
</span><a name="line-2835"></a><span>             </span><a name="local-6989586621683133261"><a href="#local-6989586621683133261"><span class="hs-identifier">tidy_bad_tvs</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyTyCoVarOcc</span><span> </span><a href="#local-6989586621683133259"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133258"><span class="hs-identifier hs-var">bad_tvs</span></a><span>
</span><a name="line-2836"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133250"><span class="hs-identifier hs-var">report</span></a><span> </span><a href="#local-6989586621683133260"><span class="hs-identifier hs-var">tidy_all_tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683133261"><span class="hs-identifier hs-var">tidy_bad_tvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2837"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2838"></a><span>    </span><a name="local-6989586621683133250"><a href="#local-6989586621683133250"><span class="hs-identifier">report</span></a></a><span> </span><a name="local-6989586621683133253"><a href="#local-6989586621683133253"><span class="hs-identifier">tidy_all_tvs</span></a></a><span> </span><a name="local-6989586621683133254"><a href="#local-6989586621683133254"><span class="hs-identifier">tidy_bad_tv</span></a></a><span>
</span><a name="line-2839"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2840"></a><span>        </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Kind variable&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133254"><span class="hs-identifier hs-var">tidy_bad_tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2841"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is implicitly bound in&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133247"><span class="hs-identifier hs-var">flav</span></a><span>
</span><a name="line-2842"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133246"><span class="hs-identifier hs-var">tycon_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2843"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but does not appear as the kind of any&quot;</span><span>
</span><a name="line-2844"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;of its type variables. Perhaps you meant&quot;</span><span>
</span><a name="line-2845"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to bind it explicitly somewhere?&quot;</span><span>
</span><a name="line-2846"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppWhen</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683133253"><span class="hs-identifier hs-var">tidy_all_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2847"></a><span>                 </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Type variables with inferred kinds:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2848"></a><span>                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683133251"><span class="hs-identifier hs-var">ppr_tv_bndrs</span></a><span> </span><a href="#local-6989586621683133253"><span class="hs-identifier hs-var">tidy_all_tvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2849"></a><span>
</span><a name="line-2850"></a><span>    </span><a name="local-6989586621683133251"><a href="#local-6989586621683133251"><span class="hs-identifier">ppr_tv_bndrs</span></a></a><span> </span><a name="local-6989586621683133255"><a href="#local-6989586621683133255"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683133252"><span class="hs-identifier hs-var">pp_tv</span></a><span> </span><a href="#local-6989586621683133255"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2851"></a><span>    </span><a name="local-6989586621683133252"><a href="#local-6989586621683133252"><span class="hs-identifier">pp_tv</span></a></a><span> </span><a name="local-6989586621683133256"><a href="#local-6989586621683133256"><span class="hs-identifier">tv</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133256"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683133256"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2852"></a><span>
</span><a name="line-2853"></a><span class="hs-comment">-- | If the inner action emits constraints, report them as errors and fail;</span><span>
</span><a name="line-2854"></a><span class="hs-comment">-- otherwise, propagates the return value. Useful as a wrapper around</span><span>
</span><a name="line-2855"></a><span class="hs-comment">-- 'tcImplicitTKBndrs', which uses solveLocalEqualities, when there won't be</span><span>
</span><a name="line-2856"></a><span class="hs-comment">-- another chance to solve constraints</span><span>
</span><a name="line-2857"></a><span class="hs-identifier">failIfEmitsConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132485"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132485"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2858"></a><a name="failIfEmitsConstraints"><a href="TcHsType.html#failIfEmitsConstraints"><span class="hs-identifier">failIfEmitsConstraints</span></a></a><span> </span><a name="local-6989586621683133262"><a href="#local-6989586621683133262"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-2859"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- We say that we fail if there are constraints!</span><span>
</span><a name="line-2860"></a><span>                   </span><span class="hs-comment">-- c.f same checkNoErrs in solveEqualities</span><span>
</span><a name="line-2861"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683133263"><a href="#local-6989586621683133263"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683133264"><a href="#local-6989586621683133264"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="#local-6989586621683133262"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-2862"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcErrors.html#reportAllUnsolved"><span class="hs-identifier hs-var">reportAllUnsolved</span></a><span> </span><a href="#local-6989586621683133264"><span class="hs-identifier hs-var">lie</span></a><span>
</span><a name="line-2863"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683133263"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-2864"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-2865"></a><span>
</span><a name="line-2866"></a><span class="hs-comment">-- | Make an appropriate message for an error in a function argument.</span><span>
</span><a name="line-2867"></a><span class="hs-comment">-- Used for both expressions and types.</span><span>
</span><a name="line-2868"></a><span class="hs-identifier">funAppCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621683132483"><span class="hs-identifier hs-type">fun</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621683132484"><span class="hs-identifier hs-type">arg</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621683132483"><span class="hs-identifier hs-type">fun</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683132484"><span class="hs-identifier hs-type">arg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2869"></a><a name="funAppCtxt"><a href="TcHsType.html#funAppCtxt"><span class="hs-identifier">funAppCtxt</span></a></a><span> </span><a name="local-6989586621683133265"><a href="#local-6989586621683133265"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621683133266"><a href="#local-6989586621683133266"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621683133267"><a href="#local-6989586621683133267"><span class="hs-identifier">arg_no</span></a></a><span>
</span><a name="line-2870"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">speakNth</span><span> </span><a href="#local-6989586621683133267"><span class="hs-identifier hs-var">arg_no</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ptext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sLit</span><span> </span><span class="hs-string">&quot;argument of&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-2871"></a><span>                    </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133265"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, namely&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2872"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133266"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2873"></a><span>
</span><a name="line-2874"></a><span class="hs-comment">-- | Add a &quot;In the data declaration for T&quot; or some such.</span><span>
</span><a name="line-2875"></a><span class="hs-identifier">addTyConFlavCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyConFlavour</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132482"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683132482"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2876"></a><a name="addTyConFlavCtxt"><a href="TcHsType.html#addTyConFlavCtxt"><span class="hs-identifier">addTyConFlavCtxt</span></a></a><span> </span><a name="local-6989586621683133268"><a href="#local-6989586621683133268"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683133269"><a href="#local-6989586621683133269"><span class="hs-identifier">flav</span></a></a><span>
</span><a name="line-2877"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133269"><span class="hs-identifier hs-var">flav</span></a><span>
</span><a name="line-2878"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;declaration for&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683133268"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2879"></a></pre></body></html>