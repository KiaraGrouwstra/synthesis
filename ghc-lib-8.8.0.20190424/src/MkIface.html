<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006-2008
(c) The GRASP/AQUA Project, Glasgow University, 1993-1998
-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE CPP, NondecreasingIndentation #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-comment">-- | Module for constructing @ModIface@ values (interface files),</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- writing them to disk and comparing two versions to see if</span><span>
</span><a name="line-11"></a><span class="hs-comment">-- recompilation is required.</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">MkIface</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>        </span><a href="MkIface.html#mkIface"><span class="hs-identifier hs-var">mkIface</span></a><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- Build a ModIface from a ModGuts,</span><span>
</span><a name="line-14"></a><span>                        </span><span class="hs-comment">-- including computing version information</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span>        </span><a href="MkIface.html#mkIfaceTc"><span class="hs-identifier hs-var">mkIfaceTc</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>        </span><a href="MkIface.html#writeIfaceFile"><span class="hs-identifier hs-var">writeIfaceFile</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Write the interface file</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>        </span><a href="MkIface.html#checkOldIface"><span class="hs-identifier hs-var">checkOldIface</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- See if recompilation is required, by</span><span>
</span><a name="line-21"></a><span>                        </span><span class="hs-comment">-- comparing version information</span><span>
</span><a name="line-22"></a><span>        </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="MkIface.html#mkIfaceExports"><span class="hs-identifier hs-var">mkIfaceExports</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span>        </span><a href="MkIface.html#coAxiomToIfaceDecl"><span class="hs-identifier hs-var">coAxiomToIfaceDecl</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="MkIface.html#tyThingToIfaceDecl"><span class="hs-identifier hs-var">tyThingToIfaceDecl</span></a><span> </span><span class="hs-comment">-- Converting things to their Iface equivalents</span><span>
</span><a name="line-27"></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-comment">{-
  -----------------------------------------------
          Recompilation checking
  -----------------------------------------------

A complete description of how recompilation checking works can be
found in the wiki commentary:

 http://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/RecompilationAvoidance

Please read the above page for a top-down description of how this all
works.  Notes below cover specific issues related to the implementation.

Basic idea:

  * In the mi_usages information in an interface, we record the
    fingerprint of each free variable of the module

  * In mkIface, we compute the fingerprint of each exported thing A.f.
    For each external thing that A.f refers to, we include the fingerprint
    of the external reference when computing the fingerprint of A.f.  So
    if anything that A.f depends on changes, then A.f's fingerprint will
    change.
    Also record any dependent files added with
      * addDependentFile
      * #include
      * -optP-include

  * In checkOldIface we compare the mi_usages for the module with
    the actual fingerprint for all each thing recorded in mi_usages
-}</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IfaceSyn</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BinFingerprint</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ToIface</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="FlagChecker.html"><span class="hs-identifier">FlagChecker</span></a><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="DsUsage.html"><span class="hs-identifier">DsUsage</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="DsUsage.html#mkUsageInfo"><span class="hs-identifier hs-var">mkUsageInfo</span></a><span class="hs-special">,</span><span> </span><a href="DsUsage.html#mkUsedNames"><span class="hs-identifier hs-var">mkUsedNames</span></a><span class="hs-special">,</span><span> </span><a href="DsUsage.html#mkDependencies"><span class="hs-identifier hs-var">mkDependencies</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Annotations</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoAxiom</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><a href="Finder.html"><span class="hs-identifier">Finder</span></a><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Avail</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><a href="BinIface.html"><span class="hs-identifier">BinIface</span></a><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>       </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>             </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">eqListBy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Binary</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Fingerprint</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Exception</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Packages</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><a href="ExtractDocs.html"><span class="hs-identifier">ExtractDocs</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Plugins</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">PluginRecompile</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">PluginWithArgs</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LoadedPlugin</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-123"></a><span>                 </span><span class="hs-identifier hs-var">pluginRecompile'</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">plugins</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">--Qualified import so we can define a Semigroup instance</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- but it doesn't clash with Outputable.&lt;&gt;</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Semigroup</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Completing an interface}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-identifier">mkIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-138"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>    </span><span class="hs-comment">-- The old fingerprint, if we have it</span><span>
</span><a name="line-139"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span>           </span><span class="hs-comment">-- The trimmed, tidied interface</span><span>
</span><a name="line-140"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModGuts</span><span>              </span><span class="hs-comment">-- Usages, deprecations, etc</span><span>
</span><a name="line-141"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- The new one</span><span>
</span><a name="line-142"></a><span>               </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- True &lt;=&gt; there was an old Iface, and the</span><span>
</span><a name="line-143"></a><span>                         </span><span class="hs-comment">--          new one is identical, so no need</span><span>
</span><a name="line-144"></a><span>                         </span><span class="hs-comment">--          to write it</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><a name="mkIface"><a href="MkIface.html#mkIface"><span class="hs-identifier">mkIface</span></a></a><span> </span><a name="local-6989586621682533166"><a href="#local-6989586621682533166"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533167"><a href="#local-6989586621682533167"><span class="hs-identifier">maybe_old_fingerprint</span></a></a><span> </span><a name="local-6989586621682533168"><a href="#local-6989586621682533168"><span class="hs-identifier">mod_details</span></a></a><span>
</span><a name="line-147"></a><span>         </span><span class="hs-identifier hs-var">ModGuts</span><span class="hs-special">{</span><span>     </span><span class="hs-identifier">mg_module</span><span>       </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533169"><a href="#local-6989586621682533169"><span class="hs-identifier">this_mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-148"></a><span>                      </span><span class="hs-identifier">mg_hsc_src</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533170"><a href="#local-6989586621682533170"><span class="hs-identifier">hsc_src</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-149"></a><span>                      </span><span class="hs-identifier">mg_usages</span><span>       </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533171"><a href="#local-6989586621682533171"><span class="hs-identifier">usages</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-150"></a><span>                      </span><span class="hs-identifier">mg_used_th</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533172"><a href="#local-6989586621682533172"><span class="hs-identifier">used_th</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-151"></a><span>                      </span><span class="hs-identifier">mg_deps</span><span>         </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533173"><a href="#local-6989586621682533173"><span class="hs-identifier">deps</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-152"></a><span>                      </span><span class="hs-identifier">mg_rdr_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533174"><a href="#local-6989586621682533174"><span class="hs-identifier">rdr_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-153"></a><span>                      </span><span class="hs-identifier">mg_fix_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533175"><a href="#local-6989586621682533175"><span class="hs-identifier">fix_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-154"></a><span>                      </span><span class="hs-identifier">mg_warns</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533176"><a href="#local-6989586621682533176"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-155"></a><span>                      </span><span class="hs-identifier">mg_hpc_info</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533177"><a href="#local-6989586621682533177"><span class="hs-identifier">hpc_info</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-156"></a><span>                      </span><span class="hs-identifier">mg_safe_haskell</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533178"><a href="#local-6989586621682533178"><span class="hs-identifier">safe_mode</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-157"></a><span>                      </span><span class="hs-identifier">mg_trust_pkg</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533179"><a href="#local-6989586621682533179"><span class="hs-identifier">self_trust</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-158"></a><span>                      </span><span class="hs-identifier">mg_doc_hdr</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533180"><a href="#local-6989586621682533180"><span class="hs-identifier">doc_hdr</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-159"></a><span>                      </span><span class="hs-identifier">mg_decl_docs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533181"><a href="#local-6989586621682533181"><span class="hs-identifier">decl_docs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-160"></a><span>                      </span><span class="hs-identifier">mg_arg_docs</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533182"><a href="#local-6989586621682533182"><span class="hs-identifier">arg_docs</span></a></a><span>
</span><a name="line-161"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-162"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#mkIface_"><span class="hs-identifier hs-var">mkIface_</span></a><span> </span><a href="#local-6989586621682533166"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533167"><span class="hs-identifier hs-var">maybe_old_fingerprint</span></a><span>
</span><a name="line-163"></a><span>                   </span><a href="#local-6989586621682533169"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621682533170"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621682533172"><span class="hs-identifier hs-var">used_th</span></a><span> </span><a href="#local-6989586621682533173"><span class="hs-identifier hs-var">deps</span></a><span> </span><a href="#local-6989586621682533174"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><a href="#local-6989586621682533175"><span class="hs-identifier hs-var">fix_env</span></a><span>
</span><a name="line-164"></a><span>                   </span><a href="#local-6989586621682533176"><span class="hs-identifier hs-var">warns</span></a><span> </span><a href="#local-6989586621682533177"><span class="hs-identifier hs-var">hpc_info</span></a><span> </span><a href="#local-6989586621682533179"><span class="hs-identifier hs-var">self_trust</span></a><span>
</span><a name="line-165"></a><span>                   </span><a href="#local-6989586621682533178"><span class="hs-identifier hs-var">safe_mode</span></a><span> </span><a href="#local-6989586621682533171"><span class="hs-identifier hs-var">usages</span></a><span>
</span><a name="line-166"></a><span>                   </span><a href="#local-6989586621682533180"><span class="hs-identifier hs-var">doc_hdr</span></a><span> </span><a href="#local-6989586621682533181"><span class="hs-identifier hs-var">decl_docs</span></a><span> </span><a href="#local-6989586621682533182"><span class="hs-identifier hs-var">arg_docs</span></a><span>
</span><a name="line-167"></a><span>                   </span><a href="#local-6989586621682533168"><span class="hs-identifier hs-var">mod_details</span></a><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-comment">-- | make an interface from the results of typechecking only.  Useful</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- for non-optimising compilation, or where we aren't generating any</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- object code at all ('HscNothing').</span><span>
</span><a name="line-172"></a><span class="hs-identifier">mkIfaceTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-173"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>  </span><span class="hs-comment">-- The old fingerprint, if we have it</span><span>
</span><a name="line-174"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SafeHaskellMode</span><span>    </span><span class="hs-comment">-- The safe haskell mode</span><span>
</span><a name="line-175"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span>         </span><span class="hs-comment">-- gotten from mkBootModDetails, probably</span><span>
</span><a name="line-176"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>           </span><span class="hs-comment">-- Usages, deprecations, etc</span><span>
</span><a name="line-177"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><a name="mkIfaceTc"><a href="MkIface.html#mkIfaceTc"><span class="hs-identifier">mkIfaceTc</span></a></a><span> </span><a name="local-6989586621682533183"><a href="#local-6989586621682533183"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533184"><a href="#local-6989586621682533184"><span class="hs-identifier">maybe_old_fingerprint</span></a></a><span> </span><a name="local-6989586621682533185"><a href="#local-6989586621682533185"><span class="hs-identifier">safe_mode</span></a></a><span> </span><a name="local-6989586621682533186"><a href="#local-6989586621682533186"><span class="hs-identifier">mod_details</span></a></a><span>
</span><a name="line-179"></a><span>  </span><a name="local-6989586621682533187"><a href="#local-6989586621682533187"><span class="hs-identifier">tc_result</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">TcGblEnv</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533188"><a href="#local-6989586621682533188"><span class="hs-identifier">this_mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-180"></a><span>                      </span><span class="hs-identifier">tcg_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533189"><a href="#local-6989586621682533189"><span class="hs-identifier">hsc_src</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-181"></a><span>                      </span><span class="hs-identifier">tcg_imports</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533190"><a href="#local-6989586621682533190"><span class="hs-identifier">imports</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-182"></a><span>                      </span><span class="hs-identifier">tcg_rdr_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533191"><a href="#local-6989586621682533191"><span class="hs-identifier">rdr_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-183"></a><span>                      </span><span class="hs-identifier">tcg_fix_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533192"><a href="#local-6989586621682533192"><span class="hs-identifier">fix_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-184"></a><span>                      </span><span class="hs-identifier">tcg_merged</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533193"><a href="#local-6989586621682533193"><span class="hs-identifier">merged</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-185"></a><span>                      </span><span class="hs-identifier">tcg_warns</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533194"><a href="#local-6989586621682533194"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-186"></a><span>                      </span><span class="hs-identifier">tcg_hpc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533195"><a href="#local-6989586621682533195"><span class="hs-identifier">other_hpc_info</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-187"></a><span>                      </span><span class="hs-identifier">tcg_th_splice_used</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533196"><a href="#local-6989586621682533196"><span class="hs-identifier">tc_splice_used</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-188"></a><span>                      </span><span class="hs-identifier">tcg_dependent_files</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533197"><a href="#local-6989586621682533197"><span class="hs-identifier">dependent_files</span></a></a><span>
</span><a name="line-189"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-191"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533198"><a href="#local-6989586621682533198"><span class="hs-identifier">used_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUsage.html#mkUsedNames"><span class="hs-identifier hs-var">mkUsedNames</span></a><span> </span><a href="#local-6989586621682533187"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-192"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533199"><a href="#local-6989586621682533199"><span class="hs-identifier">pluginModules</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-193"></a><span>                </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">lpModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cachedPlugins</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533183"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>          </span><a name="local-6989586621682533200"><a href="#local-6989586621682533200"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUsage.html#mkDependencies"><span class="hs-identifier hs-var">mkDependencies</span></a><span>
</span><a name="line-195"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier">thisInstalledUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533183"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621682533199"><span class="hs-identifier hs-var">pluginModules</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533187"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-197"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533201"><a href="#local-6989586621682533201"><span class="hs-identifier">hpc_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyHpcInfo</span><span> </span><a href="#local-6989586621682533195"><span class="hs-identifier hs-var">other_hpc_info</span></a><span>
</span><a name="line-198"></a><span>          </span><a name="local-6989586621682533202"><a href="#local-6989586621682533202"><span class="hs-identifier">used_th</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621682533196"><span class="hs-identifier hs-var">tc_splice_used</span></a><span>
</span><a name="line-199"></a><span>          </span><a name="local-6989586621682533203"><a href="#local-6989586621682533203"><span class="hs-identifier">dep_files</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621682533197"><span class="hs-identifier hs-var">dependent_files</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>          </span><span class="hs-comment">-- Do NOT use semantic module here; this_mod in mkUsageInfo</span><span>
</span><a name="line-201"></a><span>          </span><span class="hs-comment">-- is used solely to decide if we should record a dependency</span><span>
</span><a name="line-202"></a><span>          </span><span class="hs-comment">-- or not.  When we instantiate a signature, the semantic</span><span>
</span><a name="line-203"></a><span>          </span><span class="hs-comment">-- module is something we want to record dependencies for,</span><span>
</span><a name="line-204"></a><span>          </span><span class="hs-comment">-- but if you pass that in here, we'll decide it's the local</span><span>
</span><a name="line-205"></a><span>          </span><span class="hs-comment">-- module and does not need to be recorded as a dependency.</span><span>
</span><a name="line-206"></a><span>          </span><span class="hs-comment">-- See Note [Identity versus semantic module]</span><span>
</span><a name="line-207"></a><span>          </span><a name="local-6989586621682533204"><a href="#local-6989586621682533204"><span class="hs-identifier">usages</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUsage.html#mkUsageInfo"><span class="hs-identifier hs-var">mkUsageInfo</span></a><span> </span><a href="#local-6989586621682533183"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533188"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_mods</span><span> </span><a href="#local-6989586621682533190"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533198"><span class="hs-identifier hs-var">used_names</span></a><span>
</span><a name="line-208"></a><span>                      </span><a href="#local-6989586621682533203"><span class="hs-identifier hs-var">dep_files</span></a><span> </span><a href="#local-6989586621682533193"><span class="hs-identifier hs-var">merged</span></a><span> </span><a href="#local-6989586621682533199"><span class="hs-identifier hs-var">pluginModules</span></a><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682533205"><a href="#local-6989586621682533205"><span class="hs-identifier">doc_hdr'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533206"><a href="#local-6989586621682533206"><span class="hs-identifier">doc_map</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533207"><a href="#local-6989586621682533207"><span class="hs-identifier">arg_map</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="ExtractDocs.html#extractDocs"><span class="hs-identifier hs-var">extractDocs</span></a><span> </span><a href="#local-6989586621682533187"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span>          </span><a href="MkIface.html#mkIface_"><span class="hs-identifier hs-var">mkIface_</span></a><span> </span><a href="#local-6989586621682533183"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533184"><span class="hs-identifier hs-var">maybe_old_fingerprint</span></a><span>
</span><a name="line-213"></a><span>                   </span><a href="#local-6989586621682533188"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621682533189"><span class="hs-identifier hs-var">hsc_src</span></a><span>
</span><a name="line-214"></a><span>                   </span><a href="#local-6989586621682533202"><span class="hs-identifier hs-var">used_th</span></a><span> </span><a href="#local-6989586621682533200"><span class="hs-identifier hs-var">deps</span></a><span> </span><a href="#local-6989586621682533191"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-215"></a><span>                   </span><a href="#local-6989586621682533192"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621682533194"><span class="hs-identifier hs-var">warns</span></a><span> </span><a href="#local-6989586621682533201"><span class="hs-identifier hs-var">hpc_info</span></a><span>
</span><a name="line-216"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier">imp_trust_own_pkg</span><span> </span><a href="#local-6989586621682533190"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533185"><span class="hs-identifier hs-var">safe_mode</span></a><span> </span><a href="#local-6989586621682533204"><span class="hs-identifier hs-var">usages</span></a><span>
</span><a name="line-217"></a><span>                   </span><a href="#local-6989586621682533205"><span class="hs-identifier hs-var">doc_hdr'</span></a><span> </span><a href="#local-6989586621682533206"><span class="hs-identifier hs-var">doc_map</span></a><span> </span><a href="#local-6989586621682533207"><span class="hs-identifier hs-var">arg_map</span></a><span>
</span><a name="line-218"></a><span>                   </span><a href="#local-6989586621682533186"><span class="hs-identifier hs-var">mod_details</span></a><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">mkIface_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span>
</span><a name="line-223"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Dependencies</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-224"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">FixItem</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Warnings</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HpcInfo</span><span>
</span><a name="line-225"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-226"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SafeHaskellMode</span><span>
</span><a name="line-227"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Usage</span><span class="hs-special">]</span><span>
</span><a name="line-228"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">HsDocString</span><span>
</span><a name="line-229"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DeclDocMap</span><span>
</span><a name="line-230"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ArgDocMap</span><span>
</span><a name="line-231"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span>
</span><a name="line-232"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-233"></a><a name="mkIface_"><a href="MkIface.html#mkIface_"><span class="hs-identifier">mkIface_</span></a></a><span> </span><a name="local-6989586621682533208"><a href="#local-6989586621682533208"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533209"><a href="#local-6989586621682533209"><span class="hs-identifier">maybe_old_fingerprint</span></a></a><span>
</span><a name="line-234"></a><span>         </span><a name="local-6989586621682533210"><a href="#local-6989586621682533210"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621682533211"><a href="#local-6989586621682533211"><span class="hs-identifier">hsc_src</span></a></a><span> </span><a name="local-6989586621682533212"><a href="#local-6989586621682533212"><span class="hs-identifier">used_th</span></a></a><span> </span><a name="local-6989586621682533213"><a href="#local-6989586621682533213"><span class="hs-identifier">deps</span></a></a><span> </span><a name="local-6989586621682533214"><a href="#local-6989586621682533214"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621682533215"><a href="#local-6989586621682533215"><span class="hs-identifier">fix_env</span></a></a><span> </span><a name="local-6989586621682533216"><a href="#local-6989586621682533216"><span class="hs-identifier">src_warns</span></a></a><span>
</span><a name="line-235"></a><span>         </span><a name="local-6989586621682533217"><a href="#local-6989586621682533217"><span class="hs-identifier">hpc_info</span></a></a><span> </span><a name="local-6989586621682533218"><a href="#local-6989586621682533218"><span class="hs-identifier">pkg_trust_req</span></a></a><span> </span><a name="local-6989586621682533219"><a href="#local-6989586621682533219"><span class="hs-identifier">safe_mode</span></a></a><span> </span><a name="local-6989586621682533220"><a href="#local-6989586621682533220"><span class="hs-identifier">usages</span></a></a><span>
</span><a name="line-236"></a><span>         </span><a name="local-6989586621682533221"><a href="#local-6989586621682533221"><span class="hs-identifier">doc_hdr</span></a></a><span> </span><a name="local-6989586621682533222"><a href="#local-6989586621682533222"><span class="hs-identifier">decl_docs</span></a></a><span> </span><a name="local-6989586621682533223"><a href="#local-6989586621682533223"><span class="hs-identifier">arg_docs</span></a></a><span>
</span><a name="line-237"></a><span>         </span><span class="hs-identifier hs-var">ModDetails</span><span class="hs-special">{</span><span>  </span><span class="hs-identifier">md_insts</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533224"><a href="#local-6989586621682533224"><span class="hs-identifier">insts</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-238"></a><span>                      </span><span class="hs-identifier">md_fam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533225"><a href="#local-6989586621682533225"><span class="hs-identifier">fam_insts</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-239"></a><span>                      </span><span class="hs-identifier">md_rules</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533226"><a href="#local-6989586621682533226"><span class="hs-identifier">rules</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-240"></a><span>                      </span><span class="hs-identifier">md_anns</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533227"><a href="#local-6989586621682533227"><span class="hs-identifier">anns</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-241"></a><span>                      </span><span class="hs-identifier">md_types</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533228"><a href="#local-6989586621682533228"><span class="hs-identifier">type_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-242"></a><span>                      </span><span class="hs-identifier">md_exports</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533229"><a href="#local-6989586621682533229"><span class="hs-identifier">exports</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-243"></a><span>                      </span><span class="hs-identifier">md_complete_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533230"><a href="#local-6989586621682533230"><span class="hs-identifier">complete_sigs</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- NB:  notice that mkIface does not look at the bindings</span><span>
</span><a name="line-245"></a><span class="hs-comment">--      only at the TypeEnv.  The previous Tidy phase has</span><span>
</span><a name="line-246"></a><span class="hs-comment">--      put exactly the info into the TypeEnv that we want</span><span>
</span><a name="line-247"></a><span class="hs-comment">--      to expose in the interface</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-250"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533241"><a href="#local-6989586621682533241"><span class="hs-identifier">semantic_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">canonicalizeHomeModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533208"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682533210"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>        </span><a name="local-6989586621682533242"><a href="#local-6989586621682533242"><span class="hs-identifier">entities</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeEnvElts</span><span> </span><a href="#local-6989586621682533228"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-252"></a><span>        </span><a name="local-6989586621682533243"><a href="#local-6989586621682533243"><span class="hs-identifier">decls</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="MkIface.html#tyThingToIfaceDecl"><span class="hs-identifier hs-var">tyThingToIfaceDecl</span></a><span> </span><a href="#local-6989586621682533253"><span class="hs-identifier hs-var">entity</span></a><span>
</span><a name="line-253"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682533253"><a href="#local-6989586621682533253"><span class="hs-identifier">entity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533242"><span class="hs-identifier hs-var">entities</span></a><span class="hs-special">,</span><span>
</span><a name="line-254"></a><span>                   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533254"><a href="#local-6989586621682533254"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533253"><span class="hs-identifier hs-var">entity</span></a><span class="hs-special">,</span><span>
</span><a name="line-255"></a><span>                   </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isImplicitTyThing</span><span> </span><a href="#local-6989586621682533253"><span class="hs-identifier hs-var">entity</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-256"></a><span>                      </span><span class="hs-comment">-- No implicit Ids and class tycons in the interface file</span><span>
</span><a name="line-257"></a><span>                   </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isWiredInName</span><span> </span><a href="#local-6989586621682533254"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-258"></a><span>                      </span><span class="hs-comment">-- Nor wired-in things; the compiler knows about them anyhow</span><span>
</span><a name="line-259"></a><span>                   </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621682533241"><span class="hs-identifier hs-var">semantic_mod</span></a><span> </span><a href="#local-6989586621682533254"><span class="hs-identifier hs-var">name</span></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-260"></a><span>                      </span><span class="hs-comment">-- Sigh: see Note [Root-main Id] in TcRnDriver</span><span>
</span><a name="line-261"></a><span>                      </span><span class="hs-comment">-- NB: ABSOLUTELY need to check against semantic_mod,</span><span>
</span><a name="line-262"></a><span>                      </span><span class="hs-comment">-- because all of the names in an hsig p[H=&lt;H&gt;]:H</span><span>
</span><a name="line-263"></a><span>                      </span><span class="hs-comment">-- are going to be for &lt;H&gt;, not the former id!</span><span>
</span><a name="line-264"></a><span>                      </span><span class="hs-comment">-- See Note [Identity versus semantic module]</span><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span>        </span><a name="local-6989586621682533244"><a href="#local-6989586621682533244"><span class="hs-identifier">fixities</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>          </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682533255"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">,</span><a href="#local-6989586621682533256"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">FixItem</span><span> </span><a name="local-6989586621682533255"><a href="#local-6989586621682533255"><span class="hs-identifier">occ</span></a></a><span> </span><a name="local-6989586621682533256"><a href="#local-6989586621682533256"><span class="hs-identifier">fix</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">nameEnvElts</span><span> </span><a href="#local-6989586621682533215"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">]</span><span>
</span><a name="line-268"></a><span>          </span><span class="hs-comment">-- The order of fixities returned from nameEnvElts is not</span><span>
</span><a name="line-269"></a><span>          </span><span class="hs-comment">-- deterministic, so we sort by OccName to canonicalize it.</span><span>
</span><a name="line-270"></a><span>          </span><span class="hs-comment">-- See Note [Deterministic UniqFM] in UniqDFM for more details.</span><span>
</span><a name="line-271"></a><span>        </span><a name="local-6989586621682533245"><a href="#local-6989586621682533245"><span class="hs-identifier">warns</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533216"><span class="hs-identifier hs-var">src_warns</span></a><span>
</span><a name="line-272"></a><span>        </span><a name="local-6989586621682533246"><a href="#local-6989586621682533246"><span class="hs-identifier">iface_rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#coreRuleToIfaceRule"><span class="hs-identifier hs-var">coreRuleToIfaceRule</span></a><span> </span><a href="#local-6989586621682533226"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-273"></a><span>        </span><a name="local-6989586621682533247"><a href="#local-6989586621682533247"><span class="hs-identifier">iface_insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#instanceToIfaceInst"><span class="hs-identifier hs-var">instanceToIfaceInst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#fixSafeInstances"><span class="hs-identifier hs-var">fixSafeInstances</span></a><span> </span><a href="#local-6989586621682533219"><span class="hs-identifier hs-var">safe_mode</span></a><span> </span><a href="#local-6989586621682533224"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-274"></a><span>        </span><a name="local-6989586621682533248"><a href="#local-6989586621682533248"><span class="hs-identifier">iface_fam_insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#famInstToIfaceFamInst"><span class="hs-identifier hs-var">famInstToIfaceFamInst</span></a><span> </span><a href="#local-6989586621682533225"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-275"></a><span>        </span><a name="local-6989586621682533249"><a href="#local-6989586621682533249"><span class="hs-identifier">trust_info</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setSafeMode</span><span> </span><a href="#local-6989586621682533219"><span class="hs-identifier hs-var">safe_mode</span></a><span>
</span><a name="line-276"></a><span>        </span><a name="local-6989586621682533250"><a href="#local-6989586621682533250"><span class="hs-identifier">annotations</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#mkIfaceAnnotation"><span class="hs-identifier hs-var">mkIfaceAnnotation</span></a><span> </span><a href="#local-6989586621682533227"><span class="hs-identifier hs-var">anns</span></a><span>
</span><a name="line-277"></a><span>        </span><a name="local-6989586621682533251"><a href="#local-6989586621682533251"><span class="hs-identifier">icomplete_sigs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#mkIfaceCompleteSig"><span class="hs-identifier hs-var">mkIfaceCompleteSig</span></a><span> </span><a href="#local-6989586621682533230"><span class="hs-identifier hs-var">complete_sigs</span></a><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span>        </span><a name="local-6989586621682533252"><a href="#local-6989586621682533252"><span class="hs-identifier">intermediate_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ModIface</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-280"></a><span>              </span><span class="hs-identifier">mi_module</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533210"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-281"></a><span>              </span><span class="hs-comment">-- Need to record this because it depends on the -instantiated-with flag</span><span>
</span><a name="line-282"></a><span>              </span><span class="hs-comment">-- which could change</span><span>
</span><a name="line-283"></a><span>              </span><span class="hs-identifier">mi_sig_of</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682533241"><span class="hs-identifier hs-var">semantic_mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533210"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-284"></a><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-285"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682533241"><span class="hs-identifier hs-var">semantic_mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-286"></a><span>              </span><span class="hs-identifier">mi_hsc_src</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533211"><span class="hs-identifier hs-var">hsc_src</span></a><span class="hs-special">,</span><span>
</span><a name="line-287"></a><span>              </span><span class="hs-identifier">mi_deps</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533213"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">,</span><span>
</span><a name="line-288"></a><span>              </span><span class="hs-identifier">mi_usages</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533220"><span class="hs-identifier hs-var">usages</span></a><span class="hs-special">,</span><span>
</span><a name="line-289"></a><span>              </span><span class="hs-identifier">mi_exports</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#mkIfaceExports"><span class="hs-identifier hs-var">mkIfaceExports</span></a><span> </span><a href="#local-6989586621682533229"><span class="hs-identifier hs-var">exports</span></a><span class="hs-special">,</span><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span>              </span><span class="hs-comment">-- Sort these lexicographically, so that</span><span>
</span><a name="line-292"></a><span>              </span><span class="hs-comment">-- the result is stable across compilations</span><span>
</span><a name="line-293"></a><span>              </span><span class="hs-identifier">mi_insts</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><a href="#local-6989586621682533232"><span class="hs-identifier hs-var">cmp_inst</span></a><span>     </span><a href="#local-6989586621682533247"><span class="hs-identifier hs-var">iface_insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-294"></a><span>              </span><span class="hs-identifier">mi_fam_insts</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><a href="#local-6989586621682533233"><span class="hs-identifier hs-var">cmp_fam_inst</span></a><span> </span><a href="#local-6989586621682533248"><span class="hs-identifier hs-var">iface_fam_insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-295"></a><span>              </span><span class="hs-identifier">mi_rules</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><a href="#local-6989586621682533231"><span class="hs-identifier hs-var">cmp_rule</span></a><span>     </span><a href="#local-6989586621682533246"><span class="hs-identifier hs-var">iface_rules</span></a><span class="hs-special">,</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span>              </span><span class="hs-identifier">mi_fixities</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533244"><span class="hs-identifier hs-var">fixities</span></a><span class="hs-special">,</span><span>
</span><a name="line-298"></a><span>              </span><span class="hs-identifier">mi_warns</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533245"><span class="hs-identifier hs-var">warns</span></a><span class="hs-special">,</span><span>
</span><a name="line-299"></a><span>              </span><span class="hs-identifier">mi_anns</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533250"><span class="hs-identifier hs-var">annotations</span></a><span class="hs-special">,</span><span>
</span><a name="line-300"></a><span>              </span><span class="hs-identifier">mi_globals</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533235"><span class="hs-identifier hs-var">maybeGlobalRdrEnv</span></a><span> </span><a href="#local-6989586621682533214"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span>              </span><span class="hs-comment">-- Left out deliberately: filled in by addFingerprints</span><span>
</span><a name="line-303"></a><span>              </span><span class="hs-identifier">mi_iface_hash</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-304"></a><span>              </span><span class="hs-identifier">mi_mod_hash</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-305"></a><span>              </span><span class="hs-identifier">mi_flag_hash</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-306"></a><span>              </span><span class="hs-identifier">mi_opt_hash</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-307"></a><span>              </span><span class="hs-identifier">mi_hpc_hash</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-308"></a><span>              </span><span class="hs-identifier">mi_exp_hash</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-309"></a><span>              </span><span class="hs-identifier">mi_plugin_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-310"></a><span>              </span><span class="hs-identifier">mi_used_th</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533212"><span class="hs-identifier hs-var">used_th</span></a><span class="hs-special">,</span><span>
</span><a name="line-311"></a><span>              </span><span class="hs-identifier">mi_orphan_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">,</span><span>
</span><a name="line-312"></a><span>              </span><span class="hs-identifier">mi_orphan</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Always set by addFingerprints, but</span><span>
</span><a name="line-313"></a><span>                                      </span><span class="hs-comment">-- it's a strict field, so we can't omit it.</span><span>
</span><a name="line-314"></a><span>              </span><span class="hs-identifier">mi_finsts</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Ditto</span><span>
</span><a name="line-315"></a><span>              </span><span class="hs-identifier">mi_decls</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533236"><span class="hs-identifier hs-var">deliberatelyOmitted</span></a><span> </span><span class="hs-string">&quot;decls&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-316"></a><span>              </span><span class="hs-identifier">mi_hash_fn</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533236"><span class="hs-identifier hs-var">deliberatelyOmitted</span></a><span> </span><span class="hs-string">&quot;hash_fn&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-317"></a><span>              </span><span class="hs-identifier">mi_hpc</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isHpcUsed</span><span> </span><a href="#local-6989586621682533217"><span class="hs-identifier hs-var">hpc_info</span></a><span class="hs-special">,</span><span>
</span><a name="line-318"></a><span>              </span><span class="hs-identifier">mi_trust</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533249"><span class="hs-identifier hs-var">trust_info</span></a><span class="hs-special">,</span><span>
</span><a name="line-319"></a><span>              </span><span class="hs-identifier">mi_trust_pkg</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533218"><span class="hs-identifier hs-var">pkg_trust_req</span></a><span class="hs-special">,</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>              </span><span class="hs-comment">-- And build the cached values</span><span>
</span><a name="line-322"></a><span>              </span><span class="hs-identifier">mi_warn_fn</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkIfaceWarnCache</span><span> </span><a href="#local-6989586621682533245"><span class="hs-identifier hs-var">warns</span></a><span class="hs-special">,</span><span>
</span><a name="line-323"></a><span>              </span><span class="hs-identifier">mi_fix_fn</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkIfaceFixCache</span><span> </span><a href="#local-6989586621682533244"><span class="hs-identifier hs-var">fixities</span></a><span class="hs-special">,</span><span>
</span><a name="line-324"></a><span>              </span><span class="hs-identifier">mi_complete_sigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533251"><span class="hs-identifier hs-var">icomplete_sigs</span></a><span class="hs-special">,</span><span>
</span><a name="line-325"></a><span>              </span><span class="hs-identifier">mi_doc_hdr</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533221"><span class="hs-identifier hs-var">doc_hdr</span></a><span class="hs-special">,</span><span>
</span><a name="line-326"></a><span>              </span><span class="hs-identifier">mi_decl_docs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533222"><span class="hs-identifier hs-var">decl_docs</span></a><span class="hs-special">,</span><span>
</span><a name="line-327"></a><span>              </span><span class="hs-identifier">mi_arg_docs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533223"><span class="hs-identifier hs-var">arg_docs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682533257"><a href="#local-6989586621682533257"><span class="hs-identifier">new_iface</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533258"><a href="#local-6989586621682533258"><span class="hs-identifier">no_change_at_all</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;versioninfo&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-331"></a><span>                   </span><a href="MkIface.html#addFingerprints"><span class="hs-identifier hs-var">addFingerprints</span></a><span> </span><a href="#local-6989586621682533208"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533209"><span class="hs-identifier hs-var">maybe_old_fingerprint</span></a><span>
</span><a name="line-332"></a><span>                                   </span><a href="#local-6989586621682533252"><span class="hs-identifier hs-var">intermediate_iface</span></a><span> </span><a href="#local-6989586621682533243"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span>    </span><span class="hs-comment">-- Debug printing</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-identifier hs-var">dumpIfSet_dyn</span><span> </span><a href="#local-6989586621682533234"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_hi</span><span> </span><span class="hs-string">&quot;FINAL INTERFACE&quot;</span><span>
</span><a name="line-336"></a><span>                  </span><span class="hs-special">(</span><a href="LoadIface.html#pprModIface"><span class="hs-identifier hs-var">pprModIface</span></a><span> </span><a href="#local-6989586621682533257"><span class="hs-identifier hs-var">new_iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>    </span><span class="hs-comment">-- bug #1617: on reload we weren't updating the PrintUnqualified</span><span>
</span><a name="line-339"></a><span>    </span><span class="hs-comment">-- correctly.  This stems from the fact that the interface had</span><span>
</span><a name="line-340"></a><span>    </span><span class="hs-comment">-- not changed, so addFingerprints returns the old ModIface</span><span>
</span><a name="line-341"></a><span>    </span><span class="hs-comment">-- with the old GlobalRdrEnv (mi_globals).</span><span>
</span><a name="line-342"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533259"><a href="#local-6989586621682533259"><span class="hs-identifier">final_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533257"><span class="hs-identifier hs-var">new_iface</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">mi_globals</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533235"><span class="hs-identifier hs-var">maybeGlobalRdrEnv</span></a><span> </span><a href="#local-6989586621682533214"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-343"></a><span>
</span><a name="line-344"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533259"><span class="hs-identifier hs-var">final_iface</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533258"><span class="hs-identifier hs-var">no_change_at_all</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-346"></a><span>     </span><a name="local-6989586621682533231"><a href="#local-6989586621682533231"><span class="hs-identifier">cmp_rule</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier">ifRuleName</span><span>
</span><a name="line-347"></a><span>     </span><span class="hs-comment">-- Compare these lexicographically by OccName, *not* by unique,</span><span>
</span><a name="line-348"></a><span>     </span><span class="hs-comment">-- because the latter is not stable across compilations:</span><span>
</span><a name="line-349"></a><span>     </span><a name="local-6989586621682533232"><a href="#local-6989586621682533232"><span class="hs-identifier">cmp_inst</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ifDFun</span><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>     </span><a name="local-6989586621682533233"><a href="#local-6989586621682533233"><span class="hs-identifier">cmp_fam_inst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682533237"><span class="hs-identifier hs-var">ifFamInstTcName</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span>     </span><a name="local-6989586621682533234"><a href="#local-6989586621682533234"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533208"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-353"></a><span>
</span><a name="line-354"></a><span>     </span><span class="hs-comment">-- We only fill in mi_globals if the module was compiled to byte</span><span>
</span><a name="line-355"></a><span>     </span><span class="hs-comment">-- code.  Otherwise, the compiler may not have retained all the</span><span>
</span><a name="line-356"></a><span>     </span><span class="hs-comment">-- top-level bindings and they won't be in the TypeEnv (see</span><span>
</span><a name="line-357"></a><span>     </span><span class="hs-comment">-- Desugar.addExportFlagsAndRules).  The mi_globals field is used</span><span>
</span><a name="line-358"></a><span>     </span><span class="hs-comment">-- by GHCi to decide whether the module has its full top-level</span><span>
</span><a name="line-359"></a><span>     </span><span class="hs-comment">-- scope available. (#5534)</span><span>
</span><a name="line-360"></a><span>     </span><span class="hs-identifier">maybeGlobalRdrEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-361"></a><span>     </span><a name="local-6989586621682533235"><a href="#local-6989586621682533235"><span class="hs-identifier">maybeGlobalRdrEnv</span></a></a><span> </span><a name="local-6989586621682533239"><a href="#local-6989586621682533239"><span class="hs-identifier">rdr_env</span></a></a><span>
</span><a name="line-362"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">targetRetainsAllBindings</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621682533234"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682533239"><span class="hs-identifier hs-var">rdr_env</span></a><span>
</span><a name="line-363"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span>     </span><span class="hs-identifier">deliberatelyOmitted</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682533238"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-366"></a><span>     </span><a name="local-6989586621682533236"><a href="#local-6989586621682533236"><span class="hs-identifier">deliberatelyOmitted</span></a></a><span> </span><a name="local-6989586621682533240"><a href="#local-6989586621682533240"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Deliberately omitted: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682533240"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span>     </span><a name="local-6989586621682533237"><a href="#local-6989586621682533237"><span class="hs-identifier">ifFamInstTcName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ifFamInstFam</span><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-comment">-----------------------------</span><span>
</span><a name="line-371"></a><span class="hs-identifier">writeIfaceFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><a name="writeIfaceFile"><a href="MkIface.html#writeIfaceFile"><span class="hs-identifier">writeIfaceFile</span></a></a><span> </span><a name="local-6989586621682533260"><a href="#local-6989586621682533260"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682533261"><a href="#local-6989586621682533261"><span class="hs-identifier">hi_file_path</span></a></a><span> </span><a name="local-6989586621682533262"><a href="#local-6989586621682533262"><span class="hs-identifier">new_iface</span></a></a><span>
</span><a name="line-373"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621682533261"><span class="hs-identifier hs-var">hi_file_path</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>         </span><a href="BinIface.html#writeBinIface"><span class="hs-identifier hs-var">writeBinIface</span></a><span> </span><a href="#local-6989586621682533260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682533261"><span class="hs-identifier hs-var">hi_file_path</span></a><span> </span><a href="#local-6989586621682533262"><span class="hs-identifier hs-var">new_iface</span></a><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- Look up parents and versions of Names</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-comment">-- This is like a global version of the mi_hash_fn field in each ModIface.</span><span>
</span><a name="line-381"></a><span class="hs-comment">-- Given a Name, it finds the ModIface, and then uses mi_hash_fn to get</span><span>
</span><a name="line-382"></a><span class="hs-comment">-- the parent and version info.</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span class="hs-identifier">mkHashFun</span><span>
</span><a name="line-385"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>                       </span><span class="hs-comment">-- needed to look up versions</span><span>
</span><a name="line-386"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExternalPackageState</span><span>         </span><span class="hs-comment">-- ditto</span><span>
</span><a name="line-387"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><a name="mkHashFun"><a href="MkIface.html#mkHashFun"><span class="hs-identifier">mkHashFun</span></a></a><span> </span><a name="local-6989586621682533263"><a href="#local-6989586621682533263"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533264"><a href="#local-6989586621682533264"><span class="hs-identifier">eps</span></a></a><span> </span><a name="local-6989586621682533265"><a href="#local-6989586621682533265"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-389"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isHoleModule</span><span> </span><a href="#local-6989586621682533270"><span class="hs-identifier hs-var">orig_mod</span></a><span>
</span><a name="line-390"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533271"><span class="hs-identifier hs-var">lookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621682533266"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682533270"><span class="hs-identifier hs-var">orig_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-392"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533271"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621682533270"><span class="hs-identifier hs-var">orig_mod</span></a><span>
</span><a name="line-393"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-394"></a><span>      </span><a name="local-6989586621682533266"><a href="#local-6989586621682533266"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533263"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-395"></a><span>      </span><a name="local-6989586621682533267"><a href="#local-6989586621682533267"><span class="hs-identifier">hpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621682533263"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-396"></a><span>      </span><a name="local-6989586621682533268"><a href="#local-6989586621682533268"><span class="hs-identifier">pit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621682533264"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-397"></a><span>      </span><a name="local-6989586621682533269"><a href="#local-6989586621682533269"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682533265"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-398"></a><span>      </span><a name="local-6989586621682533270"><a href="#local-6989586621682533270"><span class="hs-identifier">orig_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621682533265"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-399"></a><span>      </span><a name="local-6989586621682533271"><a href="#local-6989586621682533271"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621682533272"><a href="#local-6989586621682533272"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-400"></a><span>        </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>        </span><a name="local-6989586621682533275"><a href="#local-6989586621682533275"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupIfaceByModule</span><span> </span><a href="#local-6989586621682533266"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682533267"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-6989586621682533268"><span class="hs-identifier hs-var">pit</span></a><span> </span><a href="#local-6989586621682533272"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-402"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533273"><a href="#local-6989586621682533273"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682533273"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-403"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-404"></a><span>                      </span><span class="hs-comment">-- This can occur when we're writing out ifaces for</span><span>
</span><a name="line-405"></a><span>                      </span><span class="hs-comment">-- requirements; we didn't do any /real/ typechecking</span><span>
</span><a name="line-406"></a><span>                      </span><span class="hs-comment">-- so there's no guarantee everything is loaded.</span><span>
</span><a name="line-407"></a><span>                      </span><span class="hs-comment">-- Kind of a heinous hack.</span><span>
</span><a name="line-408"></a><span>                      </span><a name="local-6989586621682533274"><a href="#local-6989586621682533274"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initIfaceLoad"><span class="hs-identifier hs-var">initIfaceLoad</span></a><span> </span><a href="#local-6989586621682533263"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcRnMonad.html#withException"><span class="hs-identifier hs-var">withException</span></a><span>
</span><a name="line-409"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;lookupVers2&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533272"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-identifier hs-var">ImportBySystem</span><span>
</span><a name="line-410"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682533274"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-411"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_hash_fn</span><span> </span><a href="#local-6989586621682533275"><span class="hs-identifier hs-var">iface</span></a><span> </span><a href="#local-6989586621682533269"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span>
</span><a name="line-412"></a><span>                  </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;lookupVers1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533272"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533269"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- Compute fingerprints for the interface</span><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span class="hs-comment">{-
Note [Fingerprinting IfaceDecls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The general idea here is that we first examine the 'IfaceDecl's and determine
the recursive groups of them. We then walk these groups in dependency order,
serializing each contained 'IfaceDecl' to a &quot;Binary&quot; buffer which we then
hash using MD5 to produce a fingerprint for the group.

However, the serialization that we use is a bit funny: we override the @putName@
operation with our own which serializes the hash of a 'Name' instead of the
'Name' itself. This ensures that the fingerprint of a decl changes if anything
in its transitive closure changes. This trick is why we must be careful about
traversing in dependency order: we need to ensure that we have hashes for
everything referenced by the decl which we are fingerprinting.

Moreover, we need to be careful to distinguish between serialization of binding
Names (e.g. the ifName field of a IfaceDecl) and non-binding (e.g. the ifInstCls
field of a IfaceClsInst): only in the non-binding case should we include the
fingerprint; in the binding case we shouldn't since it is merely the name of the
thing that we are currently fingerprinting.
-}</span><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span class="hs-comment">-- | Add fingerprints for top-level declarations to a 'ModIface'.</span><span>
</span><a name="line-441"></a><span class="hs-comment">--</span><span>
</span><a name="line-442"></a><span class="hs-comment">-- See Note [Fingerprinting IfaceDecls]</span><span>
</span><a name="line-443"></a><span class="hs-identifier">addFingerprints</span><span>
</span><a name="line-444"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-445"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-comment">-- the old fingerprint, if any</span><span>
</span><a name="line-446"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>          </span><span class="hs-comment">-- The new interface (lacking decls)</span><span>
</span><a name="line-447"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- The new decls</span><span>
</span><a name="line-448"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Updated interface</span><span>
</span><a name="line-449"></a><span>               </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- True &lt;=&gt; no changes at all;</span><span>
</span><a name="line-450"></a><span>                             </span><span class="hs-comment">-- no need to write Iface</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><a name="addFingerprints"><a href="MkIface.html#addFingerprints"><span class="hs-identifier">addFingerprints</span></a></a><span> </span><a name="local-6989586621682533276"><a href="#local-6989586621682533276"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533277"><a href="#local-6989586621682533277"><span class="hs-identifier">mb_old_fingerprint</span></a></a><span> </span><a name="local-6989586621682533278"><a href="#local-6989586621682533278"><span class="hs-identifier">iface0</span></a></a><span> </span><a name="local-6989586621682533279"><a href="#local-6989586621682533279"><span class="hs-identifier">new_decls</span></a></a><span>
</span><a name="line-453"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-454"></a><span>   </span><a name="local-6989586621682533291"><a href="#local-6989586621682533291"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hscEPS</span><span> </span><a href="#local-6989586621682533276"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-455"></a><span>   </span><span class="hs-keyword">let</span><span>
</span><a name="line-456"></a><span>        </span><span class="hs-comment">-- The ABI of a declaration represents everything that is made</span><span>
</span><a name="line-457"></a><span>        </span><span class="hs-comment">-- visible about the declaration that a client can depend on.</span><span>
</span><a name="line-458"></a><span>        </span><span class="hs-comment">-- see IfaceDeclABI below.</span><span>
</span><a name="line-459"></a><span>       </span><span class="hs-identifier">declABI</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier hs-type">IfaceDeclABI</span></a><span>
</span><a name="line-460"></a><span>       </span><span class="hs-comment">-- TODO: I'm not sure if this should be semantic_mod or this_mod.</span><span>
</span><a name="line-461"></a><span>       </span><span class="hs-comment">-- See also Note [Identity versus semantic module]</span><span>
</span><a name="line-462"></a><span>       </span><a name="local-6989586621682533292"><a href="#local-6989586621682533292"><span class="hs-identifier">declABI</span></a></a><span> </span><a name="local-6989586621682533303"><a href="#local-6989586621682533303"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533280"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533303"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533304"><span class="hs-identifier hs-var">extras</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>        </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682533304"><a href="#local-6989586621682533304"><span class="hs-identifier">extras</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#declExtras"><span class="hs-identifier hs-var">declExtras</span></a><span> </span><a href="#local-6989586621682533289"><span class="hs-identifier hs-var">fix_fn</span></a><span> </span><a href="#local-6989586621682533290"><span class="hs-identifier hs-var">ann_fn</span></a><span> </span><a href="#local-6989586621682533285"><span class="hs-identifier hs-var">non_orph_rules</span></a><span> </span><a href="#local-6989586621682533283"><span class="hs-identifier hs-var">non_orph_insts</span></a><span>
</span><a name="line-464"></a><span>                                  </span><a href="#local-6989586621682533287"><span class="hs-identifier hs-var">non_orph_fis</span></a><span> </span><a href="#local-6989586621682533293"><span class="hs-identifier hs-var">top_lvl_name_env</span></a><span> </span><a href="#local-6989586621682533303"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span>       </span><span class="hs-comment">-- This is used for looking up the Name of a default method</span><span>
</span><a name="line-467"></a><span>       </span><span class="hs-comment">-- from its OccName. See Note [default method Name]</span><span>
</span><a name="line-468"></a><span>       </span><a name="local-6989586621682533293"><a href="#local-6989586621682533293"><span class="hs-identifier">top_lvl_name_env</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-469"></a><span>         </span><span class="hs-identifier hs-var">mkOccEnv</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682533305"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533305"><span class="hs-identifier hs-var">nm</span></a><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">IfaceId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533305"><a href="#local-6989586621682533305"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533279"><span class="hs-identifier hs-var">new_decls</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span>       </span><span class="hs-comment">-- Dependency edges between declarations in the current module.</span><span>
</span><a name="line-473"></a><span>       </span><span class="hs-comment">-- This is computed by finding the free external names of each</span><span>
</span><a name="line-474"></a><span>       </span><span class="hs-comment">-- declaration, including IfaceDeclExtras (things that a</span><span>
</span><a name="line-475"></a><span>       </span><span class="hs-comment">-- declaration implicitly depends on).</span><span>
</span><a name="line-476"></a><span>       </span><span class="hs-identifier">edges</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-type">Node</span><span> </span><span class="hs-identifier hs-type">Unique</span><span> </span><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier hs-type">IfaceDeclABI</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-477"></a><span>       </span><a name="local-6989586621682533294"><a href="#local-6989586621682533294"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">DigraphNode</span><span> </span><a href="#local-6989586621682533307"><span class="hs-identifier hs-var">abi</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621682533306"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533308"><span class="hs-identifier hs-var">out</span></a><span>
</span><a name="line-478"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682533306"><a href="#local-6989586621682533306"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533279"><span class="hs-identifier hs-var">new_decls</span></a><span>
</span><a name="line-479"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533307"><a href="#local-6989586621682533307"><span class="hs-identifier">abi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533292"><span class="hs-identifier hs-var">declABI</span></a><span> </span><a href="#local-6989586621682533306"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-480"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533308"><a href="#local-6989586621682533308"><span class="hs-identifier">out</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533296"><span class="hs-identifier hs-var">localOccs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="MkIface.html#freeNamesDeclABI"><span class="hs-identifier hs-var">freeNamesDeclABI</span></a><span> </span><a href="#local-6989586621682533307"><span class="hs-identifier hs-var">abi</span></a><span>
</span><a name="line-481"></a><span>               </span><span class="hs-special">]</span><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span>       </span><a name="local-6989586621682533295"><a href="#local-6989586621682533295"><span class="hs-identifier">name_module</span></a></a><span> </span><a name="local-6989586621682533309"><a href="#local-6989586621682533309"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">n</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier hs-var">n</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">nameModule</span><span> </span><span class="hs-identifier hs-var">n</span><span>
</span><a name="line-484"></a><span>       </span><a name="local-6989586621682533296"><a href="#local-6989586621682533296"><span class="hs-identifier">localOccs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-485"></a><span>         </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682533310"><span class="hs-identifier hs-var">getParent</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>                        </span><span class="hs-comment">-- NB: names always use semantic module, so</span><span>
</span><a name="line-487"></a><span>                        </span><span class="hs-comment">-- filtering must be on the semantic module!</span><span>
</span><a name="line-488"></a><span>                        </span><span class="hs-comment">-- See Note [Identity versus semantic module]</span><span>
</span><a name="line-489"></a><span>                        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533281"><span class="hs-identifier hs-var">semantic_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682533295"><span class="hs-identifier hs-var">name_module</span></a><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>                        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nonDetEltsUniqSet</span><span>
</span><a name="line-491"></a><span>                   </span><span class="hs-comment">-- It's OK to use nonDetEltsUFM as localOccs is only</span><span>
</span><a name="line-492"></a><span>                   </span><span class="hs-comment">-- used to construct the edges and</span><span>
</span><a name="line-493"></a><span>                   </span><span class="hs-comment">-- stronglyConnCompFromEdgedVertices is deterministic</span><span>
</span><a name="line-494"></a><span>                   </span><span class="hs-comment">-- even with non-deterministic order of edges as</span><span>
</span><a name="line-495"></a><span>                   </span><span class="hs-comment">-- explained in Note [Deterministic SCC] in Digraph.</span><span>
</span><a name="line-496"></a><span>          </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">getParent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span>
</span><a name="line-497"></a><span>                </span><a name="local-6989586621682533310"><a href="#local-6989586621682533310"><span class="hs-identifier">getParent</span></a></a><span> </span><a name="local-6989586621682533311"><a href="#local-6989586621682533311"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621682533297"><span class="hs-identifier hs-var">parent_map</span></a><span> </span><a href="#local-6989586621682533311"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682533311"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span>        </span><span class="hs-comment">-- maps OccNames to their parents in the current module.</span><span>
</span><a name="line-500"></a><span>        </span><span class="hs-comment">-- e.g. a reference to a constructor must be turned into a reference</span><span>
</span><a name="line-501"></a><span>        </span><span class="hs-comment">-- to the TyCon for the purposes of calculating dependencies.</span><span>
</span><a name="line-502"></a><span>       </span><span class="hs-identifier">parent_map</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-identifier hs-type">OccName</span><span>
</span><a name="line-503"></a><span>       </span><a name="local-6989586621682533297"><a href="#local-6989586621682533297"><span class="hs-identifier">parent_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621682533312"><span class="hs-identifier hs-var">extend</span></a><span> </span><span class="hs-identifier hs-var">emptyOccEnv</span><span> </span><a href="#local-6989586621682533279"><span class="hs-identifier hs-var">new_decls</span></a><span>
</span><a name="line-504"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682533312"><a href="#local-6989586621682533312"><span class="hs-identifier">extend</span></a></a><span> </span><a name="local-6989586621682533313"><a href="#local-6989586621682533313"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682533314"><a href="#local-6989586621682533314"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-505"></a><span>                  </span><span class="hs-identifier hs-var">extendOccEnvList</span><span> </span><a href="#local-6989586621682533313"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533316"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621682533315"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682533316"><a href="#local-6989586621682533316"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ifaceDeclImplicitBndrs</span><span> </span><a href="#local-6989586621682533314"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-506"></a><span>                  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682533315"><a href="#local-6989586621682533315"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621682533314"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span>        </span><span class="hs-comment">-- Strongly-connected groups of declarations, in dependency order</span><span>
</span><a name="line-509"></a><span>       </span><span class="hs-identifier">groups</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier hs-type">IfaceDeclABI</span></a><span class="hs-special">]</span><span>
</span><a name="line-510"></a><span>       </span><a name="local-6989586621682533298"><a href="#local-6989586621682533298"><span class="hs-identifier">groups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniq</span><span> </span><a href="#local-6989586621682533294"><span class="hs-identifier hs-var">edges</span></a><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span>       </span><a name="local-6989586621682533299"><a href="#local-6989586621682533299"><span class="hs-identifier">global_hash_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#mkHashFun"><span class="hs-identifier hs-var">mkHashFun</span></a><span> </span><a href="#local-6989586621682533276"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533291"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span>        </span><span class="hs-comment">-- How to output Names when generating the data to fingerprint.</span><span>
</span><a name="line-515"></a><span>        </span><span class="hs-comment">-- Here we want to output the fingerprint for each top-level</span><span>
</span><a name="line-516"></a><span>        </span><span class="hs-comment">-- Name, whether it comes from the current module or another</span><span>
</span><a name="line-517"></a><span>        </span><span class="hs-comment">-- module.  In this way, the fingerprint for a declaration will</span><span>
</span><a name="line-518"></a><span>        </span><span class="hs-comment">-- change if the fingerprint for anything it refers to (transitively)</span><span>
</span><a name="line-519"></a><span>        </span><span class="hs-comment">-- changes.</span><span>
</span><a name="line-520"></a><span>       </span><span class="hs-identifier">mk_put_name</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BinHandle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span>  </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>       </span><a name="local-6989586621682533300"><a href="#local-6989586621682533300"><span class="hs-identifier">mk_put_name</span></a></a><span> </span><a name="local-6989586621682533317"><a href="#local-6989586621682533317"><span class="hs-identifier">local_env</span></a></a><span> </span><a name="local-6989586621682533318"><a href="#local-6989586621682533318"><span class="hs-identifier">bh</span></a></a><span> </span><a name="local-6989586621682533319"><a href="#local-6989586621682533319"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-523"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWiredInName</span><span> </span><a href="#local-6989586621682533319"><span class="hs-identifier hs-var">name</span></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">putNameLiterally</span><span> </span><a href="#local-6989586621682533318"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533319"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-524"></a><span>           </span><span class="hs-comment">-- wired-in names don't have fingerprints</span><span>
</span><a name="line-525"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-526"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier hs-var">name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-527"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533320"><a href="#local-6989586621682533320"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621682533319"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621682533281"><span class="hs-identifier hs-var">semantic_mod</span></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621682533299"><span class="hs-identifier hs-var">global_hash_fn</span></a><span> </span><a href="#local-6989586621682533319"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-528"></a><span>                     </span><span class="hs-comment">-- Get it from the REAL interface!!</span><span>
</span><a name="line-529"></a><span>                     </span><span class="hs-comment">-- This will trigger when we compile an hsig file</span><span>
</span><a name="line-530"></a><span>                     </span><span class="hs-comment">-- and we know a backing impl for it.</span><span>
</span><a name="line-531"></a><span>                     </span><span class="hs-comment">-- See Note [Identity versus semantic module]</span><span>
</span><a name="line-532"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533281"><span class="hs-identifier hs-var">semantic_mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621682533280"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-533"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isHoleModule</span><span> </span><a href="#local-6989586621682533281"><span class="hs-identifier hs-var">semantic_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533299"><span class="hs-identifier hs-var">global_hash_fn</span></a><span> </span><a href="#local-6989586621682533319"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-534"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621682533317"><span class="hs-identifier hs-var">local_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621682533319"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>                           </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;urk! lookup local fingerprint&quot;</span><span>
</span><a name="line-536"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533319"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533317"><span class="hs-identifier hs-var">local_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>                </span><span class="hs-comment">-- This panic indicates that we got the dependency</span><span>
</span><a name="line-538"></a><span>                </span><span class="hs-comment">-- analysis wrong, because we needed a fingerprint for</span><span>
</span><a name="line-539"></a><span>                </span><span class="hs-comment">-- an entity that wasn't in the environment.  To debug</span><span>
</span><a name="line-540"></a><span>                </span><span class="hs-comment">-- it, turn the panic into a trace, uncomment the</span><span>
</span><a name="line-541"></a><span>                </span><span class="hs-comment">-- pprTraces below, run the compile again, and inspect</span><span>
</span><a name="line-542"></a><span>                </span><span class="hs-comment">-- the output and the generated .hi file with</span><span>
</span><a name="line-543"></a><span>                </span><span class="hs-comment">-- --show-iface.</span><span>
</span><a name="line-544"></a><span>            </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621682533320"><span class="hs-identifier hs-var">hash</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533318"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span>        </span><span class="hs-comment">-- take a strongly-connected group of declarations and compute</span><span>
</span><a name="line-547"></a><span>        </span><span class="hs-comment">-- its fingerprint.</span><span>
</span><a name="line-548"></a><span>
</span><a name="line-549"></a><span>       </span><span class="hs-identifier">fingerprint_group</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-550"></a><span>                             </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">,</span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SCC</span><span> </span><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier hs-type">IfaceDeclABI</span></a><span>
</span><a name="line-552"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-553"></a><span>                                </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">,</span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span>       </span><a name="local-6989586621682533301"><a href="#local-6989586621682533301"><span class="hs-identifier">fingerprint_group</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533321"><a href="#local-6989586621682533321"><span class="hs-identifier">local_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533322"><a href="#local-6989586621682533322"><span class="hs-identifier">decls_w_hashes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621682533323"><a href="#local-6989586621682533323"><span class="hs-identifier">abi</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-556"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533324"><a href="#local-6989586621682533324"><span class="hs-identifier">hash_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533300"><span class="hs-identifier hs-var">mk_put_name</span></a><span> </span><a href="#local-6989586621682533321"><span class="hs-identifier hs-var">local_env</span></a><span>
</span><a name="line-557"></a><span>                   </span><a name="local-6989586621682533325"><a href="#local-6989586621682533325"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#abiDecl"><span class="hs-identifier hs-var">abiDecl</span></a><span> </span><a href="#local-6989586621682533323"><span class="hs-identifier hs-var">abi</span></a><span>
</span><a name="line-558"></a><span>               </span><span class="hs-comment">--pprTrace &quot;fingerprinting&quot; (ppr (ifName decl) ) $ do</span><span>
</span><a name="line-559"></a><span>               </span><a name="local-6989586621682533326"><a href="#local-6989586621682533326"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">computeFingerprint</span><span> </span><a href="#local-6989586621682533324"><span class="hs-identifier hs-var">hash_fn</span></a><span> </span><a href="#local-6989586621682533323"><span class="hs-identifier hs-var">abi</span></a><span>
</span><a name="line-560"></a><span>               </span><a name="local-6989586621682533327"><a href="#local-6989586621682533327"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533302"><span class="hs-identifier hs-var">extend_hash_env</span></a><span> </span><a href="#local-6989586621682533321"><span class="hs-identifier hs-var">local_env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533326"><span class="hs-identifier hs-var">hash</span></a><span class="hs-special">,</span><a href="#local-6989586621682533325"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533327"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533326"><span class="hs-identifier hs-var">hash</span></a><span class="hs-special">,</span><a href="#local-6989586621682533325"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682533322"><span class="hs-identifier hs-var">decls_w_hashes</span></a><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span>       </span><span class="hs-identifier">fingerprint_group</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682533328"><a href="#local-6989586621682533328"><span class="hs-identifier">local_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533329"><a href="#local-6989586621682533329"><span class="hs-identifier">decls_w_hashes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621682533330"><a href="#local-6989586621682533330"><span class="hs-identifier">abis</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533331"><a href="#local-6989586621682533331"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#abiDecl"><span class="hs-identifier hs-var">abiDecl</span></a><span> </span><a href="#local-6989586621682533330"><span class="hs-identifier hs-var">abis</span></a><span>
</span><a name="line-565"></a><span>               </span><a name="local-6989586621682533332"><a href="#local-6989586621682533332"><span class="hs-identifier">local_env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621682533302"><span class="hs-identifier hs-var">extend_hash_env</span></a><span> </span><a href="#local-6989586621682533328"><span class="hs-identifier hs-var">local_env</span></a><span>
</span><a name="line-566"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">fingerprint0</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533331"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>               </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533333"><a href="#local-6989586621682533333"><span class="hs-identifier">hash_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533300"><span class="hs-identifier hs-var">mk_put_name</span></a><span> </span><a href="#local-6989586621682533332"><span class="hs-identifier hs-var">local_env1</span></a><span>
</span><a name="line-568"></a><span>               </span><span class="hs-comment">-- pprTrace &quot;fingerprinting&quot; (ppr (map ifName decls) ) $ do</span><span>
</span><a name="line-569"></a><span>               </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533334"><a href="#local-6989586621682533334"><span class="hs-identifier">stable_abis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><a href="MkIface.html#cmp_abiNames"><span class="hs-identifier hs-var">cmp_abiNames</span></a><span> </span><a href="#local-6989586621682533330"><span class="hs-identifier hs-var">abis</span></a><span>
</span><a name="line-570"></a><span>                </span><span class="hs-comment">-- put the cycle in a canonical order</span><span>
</span><a name="line-571"></a><span>               </span><a name="local-6989586621682533335"><a href="#local-6989586621682533335"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">computeFingerprint</span><span> </span><a href="#local-6989586621682533333"><span class="hs-identifier hs-var">hash_fn</span></a><span> </span><a href="#local-6989586621682533334"><span class="hs-identifier hs-var">stable_abis</span></a><span>
</span><a name="line-572"></a><span>               </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533336"><a href="#local-6989586621682533336"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="#local-6989586621682533335"><span class="hs-identifier hs-var">hash</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533331"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-573"></a><span>               </span><a name="local-6989586621682533337"><a href="#local-6989586621682533337"><span class="hs-identifier">local_env2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621682533302"><span class="hs-identifier hs-var">extend_hash_env</span></a><span> </span><a href="#local-6989586621682533328"><span class="hs-identifier hs-var">local_env</span></a><span> </span><a href="#local-6989586621682533336"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-574"></a><span>               </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533337"><span class="hs-identifier hs-var">local_env2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533336"><span class="hs-identifier hs-var">pairs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682533329"><span class="hs-identifier hs-var">decls_w_hashes</span></a><span class="hs-special">)</span><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span>       </span><span class="hs-comment">-- we have fingerprinted the whole declaration, but we now need</span><span>
</span><a name="line-577"></a><span>       </span><span class="hs-comment">-- to assign fingerprints to all the OccNames that it binds, to</span><span>
</span><a name="line-578"></a><span>       </span><span class="hs-comment">-- use when referencing those OccNames in later declarations.</span><span>
</span><a name="line-579"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-580"></a><span>       </span><span class="hs-identifier">extend_hash_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">,</span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>       </span><a name="local-6989586621682533302"><a href="#local-6989586621682533302"><span class="hs-identifier">extend_hash_env</span></a></a><span> </span><a name="local-6989586621682533338"><a href="#local-6989586621682533338"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533339"><a href="#local-6989586621682533339"><span class="hs-identifier">hash</span></a></a><span class="hs-special">,</span><a name="local-6989586621682533340"><a href="#local-6989586621682533340"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-584"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621682533341"><a href="#local-6989586621682533341"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621682533342"><a href="#local-6989586621682533342"><span class="hs-identifier">fp</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682533343"><a href="#local-6989586621682533343"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">extendOccEnv</span><span> </span><a href="#local-6989586621682533343"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682533341"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533341"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621682533342"><span class="hs-identifier hs-var">fp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533338"><span class="hs-identifier hs-var">env0</span></a><span>
</span><a name="line-585"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ifaceDeclFingerprints</span><span> </span><a href="#local-6989586621682533339"><span class="hs-identifier hs-var">hash</span></a><span> </span><a href="#local-6989586621682533340"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-588"></a><span>   </span><span class="hs-special">(</span><a name="local-6989586621682533344"><a href="#local-6989586621682533344"><span class="hs-identifier">local_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533345"><a href="#local-6989586621682533345"><span class="hs-identifier">decls_w_hashes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-589"></a><span>       </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621682533301"><span class="hs-identifier hs-var">fingerprint_group</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyOccEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533298"><span class="hs-identifier hs-var">groups</span></a><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span>   </span><span class="hs-comment">-- when calculating fingerprints, we always need to use canonical</span><span>
</span><a name="line-592"></a><span>   </span><span class="hs-comment">-- ordering for lists of things.  In particular, the mi_deps has various</span><span>
</span><a name="line-593"></a><span>   </span><span class="hs-comment">-- lists of modules and suchlike, so put these all in canonical order:</span><span>
</span><a name="line-594"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533346"><a href="#local-6989586621682533346"><span class="hs-identifier">sorted_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#sortDependencies"><span class="hs-identifier hs-var">sortDependencies</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span>   </span><span class="hs-comment">-- The export hash of a module depends on the orphan hashes of the</span><span>
</span><a name="line-597"></a><span>   </span><span class="hs-comment">-- orphan modules below us in the dependency tree.  This is the way</span><span>
</span><a name="line-598"></a><span>   </span><span class="hs-comment">-- that changes in orphans get propagated all the way up the</span><span>
</span><a name="line-599"></a><span>   </span><span class="hs-comment">-- dependency tree.</span><span>
</span><a name="line-600"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-601"></a><span>   </span><span class="hs-comment">-- Note [A bad dep_orphs optimization]</span><span>
</span><a name="line-602"></a><span>   </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-603"></a><span>   </span><span class="hs-comment">-- In a previous version of this code, we filtered out orphan modules which</span><span>
</span><a name="line-604"></a><span>   </span><span class="hs-comment">-- were not from the home package, justifying it by saying that &quot;we'd</span><span>
</span><a name="line-605"></a><span>   </span><span class="hs-comment">-- pick up the ABI hashes of the external module instead&quot;.  This is wrong.</span><span>
</span><a name="line-606"></a><span>   </span><span class="hs-comment">-- Suppose that we have:</span><span>
</span><a name="line-607"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-608"></a><span>   </span><span class="hs-comment">--       module External where</span><span>
</span><a name="line-609"></a><span>   </span><span class="hs-comment">--           instance Show (a -&gt; b)</span><span>
</span><a name="line-610"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-611"></a><span>   </span><span class="hs-comment">--       module Home1 where</span><span>
</span><a name="line-612"></a><span>   </span><span class="hs-comment">--           import External</span><span>
</span><a name="line-613"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-614"></a><span>   </span><span class="hs-comment">--       module Home2 where</span><span>
</span><a name="line-615"></a><span>   </span><span class="hs-comment">--           import Home1</span><span>
</span><a name="line-616"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-617"></a><span>   </span><span class="hs-comment">-- The export hash of Home1 needs to reflect the orphan instances of</span><span>
</span><a name="line-618"></a><span>   </span><span class="hs-comment">-- External. It's true that Home1 will get rebuilt if the orphans</span><span>
</span><a name="line-619"></a><span>   </span><span class="hs-comment">-- of External, but we also need to make sure Home2 gets rebuilt</span><span>
</span><a name="line-620"></a><span>   </span><span class="hs-comment">-- as well.  See #12733 for more details.</span><span>
</span><a name="line-621"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533347"><a href="#local-6989586621682533347"><span class="hs-identifier">orph_mods</span></a></a><span>
</span><a name="line-622"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621682533280"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Note [Do not update EPS with your own hi-boot]</span><span>
</span><a name="line-623"></a><span>        </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">dep_orphs</span><span> </span><a href="#local-6989586621682533346"><span class="hs-identifier hs-var">sorted_deps</span></a><span>
</span><a name="line-624"></a><span>   </span><a name="local-6989586621682533348"><a href="#local-6989586621682533348"><span class="hs-identifier">dep_orphan_hashes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#getOrphanHashes"><span class="hs-identifier hs-var">getOrphanHashes</span></a><span> </span><a href="#local-6989586621682533276"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533347"><span class="hs-identifier hs-var">orph_mods</span></a><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span>   </span><span class="hs-comment">-- Note [Do not update EPS with your own hi-boot]</span><span>
</span><a name="line-627"></a><span>   </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-628"></a><span>   </span><span class="hs-comment">-- (See also Trac #10182).  When your hs-boot file includes an orphan</span><span>
</span><a name="line-629"></a><span>   </span><span class="hs-comment">-- instance declaration, you may find that the dep_orphs of a module you</span><span>
</span><a name="line-630"></a><span>   </span><span class="hs-comment">-- import contains reference to yourself.  DO NOT actually load this module</span><span>
</span><a name="line-631"></a><span>   </span><span class="hs-comment">-- or add it to the orphan hashes: you're going to provide the orphan</span><span>
</span><a name="line-632"></a><span>   </span><span class="hs-comment">-- instances yourself, no need to consult hs-boot; if you do load the</span><span>
</span><a name="line-633"></a><span>   </span><span class="hs-comment">-- interface into EPS, you will see a duplicate orphan instance.</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span>   </span><a name="local-6989586621682533349"><a href="#local-6989586621682533349"><span class="hs-identifier">orphan_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">computeFingerprint</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533300"><span class="hs-identifier hs-var">mk_put_name</span></a><span> </span><a href="#local-6989586621682533344"><span class="hs-identifier hs-var">local_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ifDFun</span><span> </span><a href="#local-6989586621682533284"><span class="hs-identifier hs-var">orph_insts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533286"><span class="hs-identifier hs-var">orph_rules</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533288"><span class="hs-identifier hs-var">orph_fis</span></a><span class="hs-special">)</span><span>
</span><a name="line-637"></a><span>
</span><a name="line-638"></a><span>   </span><span class="hs-comment">-- the export list hash doesn't depend on the fingerprints of</span><span>
</span><a name="line-639"></a><span>   </span><span class="hs-comment">-- the Names it mentions, only the Names themselves, hence putNameLiterally.</span><span>
</span><a name="line-640"></a><span>   </span><a name="local-6989586621682533350"><a href="#local-6989586621682533350"><span class="hs-identifier">export_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">computeFingerprint</span><span> </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-641"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier">mi_exports</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">,</span><span>
</span><a name="line-642"></a><span>                       </span><a href="#local-6989586621682533349"><span class="hs-identifier hs-var">orphan_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-643"></a><span>                       </span><a href="#local-6989586621682533348"><span class="hs-identifier hs-var">dep_orphan_hashes</span></a><span class="hs-special">,</span><span>
</span><a name="line-644"></a><span>                       </span><span class="hs-identifier">dep_pkgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-645"></a><span>                       </span><span class="hs-comment">-- See Note [Export hash depends on non-orphan family instances]</span><span>
</span><a name="line-646"></a><span>                       </span><span class="hs-identifier">dep_finsts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-647"></a><span>                        </span><span class="hs-comment">-- dep_pkgs: see &quot;Package Version Changes&quot; on</span><span>
</span><a name="line-648"></a><span>                        </span><span class="hs-comment">-- wiki/Commentary/Compiler/RecompilationAvoidance</span><span>
</span><a name="line-649"></a><span>                       </span><span class="hs-identifier">mi_trust</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span>
</span><a name="line-650"></a><span>                        </span><span class="hs-comment">-- Make sure change of Safe Haskell mode causes recomp.</span><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span>   </span><span class="hs-comment">-- Note [Export hash depends on non-orphan family instances]</span><span>
</span><a name="line-653"></a><span>   </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-654"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-655"></a><span>   </span><span class="hs-comment">-- Suppose we have:</span><span>
</span><a name="line-656"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-657"></a><span>   </span><span class="hs-comment">--   module A where</span><span>
</span><a name="line-658"></a><span>   </span><span class="hs-comment">--       type instance F Int = Bool</span><span>
</span><a name="line-659"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-660"></a><span>   </span><span class="hs-comment">--   module B where</span><span>
</span><a name="line-661"></a><span>   </span><span class="hs-comment">--       import A</span><span>
</span><a name="line-662"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-663"></a><span>   </span><span class="hs-comment">--   module C where</span><span>
</span><a name="line-664"></a><span>   </span><span class="hs-comment">--       import B</span><span>
</span><a name="line-665"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-666"></a><span>   </span><span class="hs-comment">-- The family instance consistency check for C depends on the dep_finsts of</span><span>
</span><a name="line-667"></a><span>   </span><span class="hs-comment">-- B.  If we rename module A to A2, when the dep_finsts of B changes, we need</span><span>
</span><a name="line-668"></a><span>   </span><span class="hs-comment">-- to make sure that C gets rebuilt. Effectively, the dep_finsts are part of</span><span>
</span><a name="line-669"></a><span>   </span><span class="hs-comment">-- the exports of B, because C always considers them when checking</span><span>
</span><a name="line-670"></a><span>   </span><span class="hs-comment">-- consistency.</span><span>
</span><a name="line-671"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-672"></a><span>   </span><span class="hs-comment">-- A full discussion is in #12723.</span><span>
</span><a name="line-673"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-674"></a><span>   </span><span class="hs-comment">-- We do NOT need to hash dep_orphs, because this is implied by</span><span>
</span><a name="line-675"></a><span>   </span><span class="hs-comment">-- dep_orphan_hashes, and we do not need to hash ordinary class instances,</span><span>
</span><a name="line-676"></a><span>   </span><span class="hs-comment">-- because there is no eager consistency check as there is with type families</span><span>
</span><a name="line-677"></a><span>   </span><span class="hs-comment">-- (also we didn't store it anywhere!)</span><span>
</span><a name="line-678"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span>   </span><span class="hs-comment">-- put the declarations in a canonical order, sorted by OccName</span><span>
</span><a name="line-681"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533351"><a href="#local-6989586621682533351"><span class="hs-identifier">sorted_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.elems</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-682"></a><span>                          </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621682533353"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533352"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682533352"><a href="#local-6989586621682533352"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682533353"><a href="#local-6989586621682533353"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533345"><span class="hs-identifier hs-var">decls_w_hashes</span></a><span class="hs-special">]</span><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span>   </span><span class="hs-comment">-- the flag hash depends on:</span><span>
</span><a name="line-685"></a><span>   </span><span class="hs-comment">--   - (some of) dflags</span><span>
</span><a name="line-686"></a><span>   </span><span class="hs-comment">-- it returns two hashes, one that shouldn't change</span><span>
</span><a name="line-687"></a><span>   </span><span class="hs-comment">-- the abi hash and one that should</span><span>
</span><a name="line-688"></a><span>   </span><a name="local-6989586621682533354"><a href="#local-6989586621682533354"><span class="hs-identifier">flag_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FlagChecker.html#fingerprintDynFlags"><span class="hs-identifier hs-var">fingerprintDynFlags</span></a><span> </span><a href="#local-6989586621682533282"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682533280"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><span>   </span><a name="local-6989586621682533355"><a href="#local-6989586621682533355"><span class="hs-identifier">opt_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FlagChecker.html#fingerprintOptFlags"><span class="hs-identifier hs-var">fingerprintOptFlags</span></a><span> </span><a href="#local-6989586621682533282"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span>   </span><a name="local-6989586621682533356"><a href="#local-6989586621682533356"><span class="hs-identifier">hpc_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FlagChecker.html#fingerprintHpcFlags"><span class="hs-identifier hs-var">fingerprintHpcFlags</span></a><span> </span><a href="#local-6989586621682533282"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span>   </span><a name="local-6989586621682533357"><a href="#local-6989586621682533357"><span class="hs-identifier">plugin_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#fingerprintPlugins"><span class="hs-identifier hs-var">fingerprintPlugins</span></a><span> </span><a href="#local-6989586621682533276"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span>   </span><span class="hs-comment">-- the ABI hash depends on:</span><span>
</span><a name="line-697"></a><span>   </span><span class="hs-comment">--   - decls</span><span>
</span><a name="line-698"></a><span>   </span><span class="hs-comment">--   - export list</span><span>
</span><a name="line-699"></a><span>   </span><span class="hs-comment">--   - orphans</span><span>
</span><a name="line-700"></a><span>   </span><span class="hs-comment">--   - deprecations</span><span>
</span><a name="line-701"></a><span>   </span><span class="hs-comment">--   - flag abi hash</span><span>
</span><a name="line-702"></a><span>   </span><a name="local-6989586621682533358"><a href="#local-6989586621682533358"><span class="hs-identifier">mod_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">computeFingerprint</span><span> </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-703"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682533351"><span class="hs-identifier hs-var">sorted_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-704"></a><span>                       </span><a href="#local-6989586621682533350"><span class="hs-identifier hs-var">export_hash</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- includes orphan_hash</span><span>
</span><a name="line-705"></a><span>                       </span><span class="hs-identifier">mi_warns</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span>
</span><a name="line-706"></a><span>
</span><a name="line-707"></a><span>   </span><span class="hs-comment">-- The interface hash depends on:</span><span>
</span><a name="line-708"></a><span>   </span><span class="hs-comment">--   - the ABI hash, plus</span><span>
</span><a name="line-709"></a><span>   </span><span class="hs-comment">--   - the module level annotations,</span><span>
</span><a name="line-710"></a><span>   </span><span class="hs-comment">--   - usages</span><span>
</span><a name="line-711"></a><span>   </span><span class="hs-comment">--   - deps (home and external packages, dependent files)</span><span>
</span><a name="line-712"></a><span>   </span><span class="hs-comment">--   - hpc</span><span>
</span><a name="line-713"></a><span>   </span><a name="local-6989586621682533359"><a href="#local-6989586621682533359"><span class="hs-identifier">iface_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">computeFingerprint</span><span> </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-714"></a><span>                      </span><span class="hs-special">(</span><a href="#local-6989586621682533358"><span class="hs-identifier hs-var">mod_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-715"></a><span>                       </span><a href="#local-6989586621682533290"><span class="hs-identifier hs-var">ann_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarOcc</span><span> </span><span class="hs-string">&quot;module&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- See mkIfaceAnnCache</span><span>
</span><a name="line-716"></a><span>                       </span><span class="hs-identifier">mi_usages</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">,</span><span>
</span><a name="line-717"></a><span>                       </span><a href="#local-6989586621682533346"><span class="hs-identifier hs-var">sorted_deps</span></a><span class="hs-special">,</span><span>
</span><a name="line-718"></a><span>                       </span><span class="hs-identifier">mi_hpc</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span>   </span><span class="hs-keyword">let</span><span>
</span><a name="line-721"></a><span>    </span><a name="local-6989586621682533360"><a href="#local-6989586621682533360"><span class="hs-identifier">no_change_at_all</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682533359"><span class="hs-identifier hs-var">iface_hash</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533277"><span class="hs-identifier hs-var">mb_old_fingerprint</span></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span>    </span><a name="local-6989586621682533361"><a href="#local-6989586621682533361"><span class="hs-identifier">final_iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-724"></a><span>                </span><span class="hs-identifier">mi_mod_hash</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533358"><span class="hs-identifier hs-var">mod_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-725"></a><span>                </span><span class="hs-identifier">mi_iface_hash</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533359"><span class="hs-identifier hs-var">iface_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-726"></a><span>                </span><span class="hs-identifier">mi_exp_hash</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533350"><span class="hs-identifier hs-var">export_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-727"></a><span>                </span><span class="hs-identifier">mi_orphan_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533349"><span class="hs-identifier hs-var">orphan_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-728"></a><span>                </span><span class="hs-identifier">mi_flag_hash</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533354"><span class="hs-identifier hs-var">flag_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-729"></a><span>                </span><span class="hs-identifier">mi_opt_hash</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533355"><span class="hs-identifier hs-var">opt_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-730"></a><span>                </span><span class="hs-identifier">mi_hpc_hash</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533356"><span class="hs-identifier hs-var">hpc_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-731"></a><span>                </span><span class="hs-identifier">mi_plugin_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533357"><span class="hs-identifier hs-var">plugin_hash</span></a><span class="hs-special">,</span><span>
</span><a name="line-732"></a><span>                </span><span class="hs-identifier">mi_orphan</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span>   </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier">ifRuleAuto</span><span> </span><a href="#local-6989586621682533286"><span class="hs-identifier hs-var">orph_rules</span></a><span>
</span><a name="line-733"></a><span>                                           </span><span class="hs-comment">-- See Note [Orphans and auto-generated rules]</span><span>
</span><a name="line-734"></a><span>                                      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682533284"><span class="hs-identifier hs-var">orph_insts</span></a><span>
</span><a name="line-735"></a><span>                                      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682533288"><span class="hs-identifier hs-var">orph_fis</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-736"></a><span>                </span><span class="hs-identifier">mi_finsts</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">mi_fam_insts</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">,</span><span>
</span><a name="line-737"></a><span>                </span><span class="hs-identifier">mi_decls</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533351"><span class="hs-identifier hs-var">sorted_decls</span></a><span class="hs-special">,</span><span>
</span><a name="line-738"></a><span>                </span><span class="hs-identifier">mi_hash_fn</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621682533344"><span class="hs-identifier hs-var">local_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-739"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-740"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533361"><span class="hs-identifier hs-var">final_iface</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533360"><span class="hs-identifier hs-var">no_change_at_all</span></a><span class="hs-special">)</span><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-743"></a><span>    </span><a name="local-6989586621682533280"><a href="#local-6989586621682533280"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span>
</span><a name="line-744"></a><span>    </span><a name="local-6989586621682533281"><a href="#local-6989586621682533281"><span class="hs-identifier">semantic_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mi_semantic_module</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span>
</span><a name="line-745"></a><span>    </span><a name="local-6989586621682533282"><a href="#local-6989586621682533282"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533276"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-746"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682533283"><a href="#local-6989586621682533283"><span class="hs-identifier">non_orph_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533284"><a href="#local-6989586621682533284"><span class="hs-identifier">orph_insts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#mkOrphMap"><span class="hs-identifier hs-var">mkOrphMap</span></a><span> </span><span class="hs-identifier">ifInstOrph</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">mi_insts</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span>
</span><a name="line-747"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682533285"><a href="#local-6989586621682533285"><span class="hs-identifier">non_orph_rules</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533286"><a href="#local-6989586621682533286"><span class="hs-identifier">orph_rules</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#mkOrphMap"><span class="hs-identifier hs-var">mkOrphMap</span></a><span> </span><span class="hs-identifier">ifRuleOrph</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">mi_rules</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682533287"><a href="#local-6989586621682533287"><span class="hs-identifier">non_orph_fis</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682533288"><a href="#local-6989586621682533288"><span class="hs-identifier">orph_fis</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#mkOrphMap"><span class="hs-identifier hs-var">mkOrphMap</span></a><span> </span><span class="hs-identifier">ifFamInstOrph</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_fam_insts</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span>
</span><a name="line-749"></a><span>    </span><a name="local-6989586621682533289"><a href="#local-6989586621682533289"><span class="hs-identifier">fix_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_fix_fn</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span>
</span><a name="line-750"></a><span>    </span><a name="local-6989586621682533290"><a href="#local-6989586621682533290"><span class="hs-identifier">ann_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#mkIfaceAnnCache"><span class="hs-identifier hs-var">mkIfaceAnnCache</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_anns</span><span> </span><a href="#local-6989586621682533278"><span class="hs-identifier hs-var">iface0</span></a><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>
</span><a name="line-752"></a><span class="hs-comment">-- | Retrieve the orphan hashes 'mi_orphan_hash' for a list of modules</span><span>
</span><a name="line-753"></a><span class="hs-comment">-- (in particular, the orphan modules which are transitively imported by the</span><span>
</span><a name="line-754"></a><span class="hs-comment">-- current module).</span><span>
</span><a name="line-755"></a><span class="hs-comment">--</span><span>
</span><a name="line-756"></a><span class="hs-comment">-- Q: Why do we need the hash at all, doesn't the list of transitively</span><span>
</span><a name="line-757"></a><span class="hs-comment">-- imported orphan modules suffice?</span><span>
</span><a name="line-758"></a><span class="hs-comment">--</span><span>
</span><a name="line-759"></a><span class="hs-comment">-- A: If one of our transitive imports adds a new orphan instance, our</span><span>
</span><a name="line-760"></a><span class="hs-comment">-- export hash must change so that modules which import us rebuild.  If we just</span><span>
</span><a name="line-761"></a><span class="hs-comment">-- hashed the [Module], the hash would not change even when a new instance was</span><span>
</span><a name="line-762"></a><span class="hs-comment">-- added to a module that already had an orphan instance.</span><span>
</span><a name="line-763"></a><span class="hs-comment">--</span><span>
</span><a name="line-764"></a><span class="hs-comment">-- Q: Why don't we just hash the orphan hashes of our direct dependencies?</span><span>
</span><a name="line-765"></a><span class="hs-comment">-- Why the full transitive closure?</span><span>
</span><a name="line-766"></a><span class="hs-comment">--</span><span>
</span><a name="line-767"></a><span class="hs-comment">-- A: Suppose we have these modules:</span><span>
</span><a name="line-768"></a><span class="hs-comment">--</span><span>
</span><a name="line-769"></a><span class="hs-comment">--      module A where</span><span>
</span><a name="line-770"></a><span class="hs-comment">--          instance Show (a -&gt; b) where</span><span>
</span><a name="line-771"></a><span class="hs-comment">--      module B where</span><span>
</span><a name="line-772"></a><span class="hs-comment">--          import A -- **</span><span>
</span><a name="line-773"></a><span class="hs-comment">--      module C where</span><span>
</span><a name="line-774"></a><span class="hs-comment">--          import A</span><span>
</span><a name="line-775"></a><span class="hs-comment">--          import B</span><span>
</span><a name="line-776"></a><span class="hs-comment">--</span><span>
</span><a name="line-777"></a><span class="hs-comment">-- Whether or not we add or remove the import to A in B affects the</span><span>
</span><a name="line-778"></a><span class="hs-comment">-- orphan hash of B.  But it shouldn't really affect the orphan hash</span><span>
</span><a name="line-779"></a><span class="hs-comment">-- of C.  If we hashed only direct dependencies, there would be no</span><span>
</span><a name="line-780"></a><span class="hs-comment">-- way to tell that the net effect was a wash, and we'd be forced</span><span>
</span><a name="line-781"></a><span class="hs-comment">-- to recompile C and everything else.</span><span>
</span><a name="line-782"></a><span class="hs-identifier">getOrphanHashes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">]</span><span>
</span><a name="line-783"></a><a name="getOrphanHashes"><a href="MkIface.html#getOrphanHashes"><span class="hs-identifier">getOrphanHashes</span></a></a><span> </span><a name="local-6989586621682533362"><a href="#local-6989586621682533362"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533363"><a href="#local-6989586621682533363"><span class="hs-identifier">mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-784"></a><span>  </span><a name="local-6989586621682533364"><a href="#local-6989586621682533364"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">hscEPS</span><span> </span><a href="#local-6989586621682533362"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-785"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-786"></a><span>    </span><a name="local-6989586621682533365"><a href="#local-6989586621682533365"><span class="hs-identifier">hpt</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621682533362"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-787"></a><span>    </span><a name="local-6989586621682533366"><a href="#local-6989586621682533366"><span class="hs-identifier">pit</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">eps_PIT</span><span> </span><a href="#local-6989586621682533364"><span class="hs-identifier hs-var">eps</span></a><span>
</span><a name="line-788"></a><span>    </span><a name="local-6989586621682533367"><a href="#local-6989586621682533367"><span class="hs-identifier">dflags</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533362"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-789"></a><span>    </span><a name="local-6989586621682533368"><a href="#local-6989586621682533368"><span class="hs-identifier">get_orph_hash</span></a></a><span> </span><a name="local-6989586621682533369"><a href="#local-6989586621682533369"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-790"></a><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupIfaceByModule</span><span> </span><a href="#local-6989586621682533367"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682533365"><span class="hs-identifier hs-var">hpt</span></a><span> </span><a href="#local-6989586621682533366"><span class="hs-identifier hs-var">pit</span></a><span> </span><a href="#local-6989586621682533369"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-791"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533370"><a href="#local-6989586621682533370"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_orphan_hash</span><span> </span><a href="#local-6989586621682533370"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-792"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- similar to 'mkHashFun'</span><span>
</span><a name="line-793"></a><span>                </span><a name="local-6989586621682533371"><a href="#local-6989586621682533371"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initIfaceLoad"><span class="hs-identifier hs-var">initIfaceLoad</span></a><span> </span><a href="#local-6989586621682533362"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcRnMonad.html#withException"><span class="hs-identifier hs-var">withException</span></a><span>
</span><a name="line-794"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;getOrphanHashes&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533369"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-identifier hs-var">ImportBySystem</span><span>
</span><a name="line-795"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_orphan_hash</span><span> </span><a href="#local-6989586621682533371"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-796"></a><span>
</span><a name="line-797"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-798"></a><span>  </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621682533368"><span class="hs-identifier hs-var">get_orph_hash</span></a><span> </span><a href="#local-6989586621682533363"><span class="hs-identifier hs-var">mods</span></a><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span>
</span><a name="line-801"></a><span class="hs-identifier">sortDependencies</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Dependencies</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Dependencies</span><span>
</span><a name="line-802"></a><a name="sortDependencies"><a href="MkIface.html#sortDependencies"><span class="hs-identifier">sortDependencies</span></a></a><span> </span><a name="local-6989586621682533372"><a href="#local-6989586621682533372"><span class="hs-identifier">d</span></a></a><span>
</span><a name="line-803"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Deps</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dep_mods</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">moduleNameFS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_mods</span><span> </span><a href="#local-6989586621682533372"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-804"></a><span>          </span><span class="hs-identifier">dep_pkgs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_pkgs</span><span> </span><a href="#local-6989586621682533372"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-805"></a><span>          </span><span class="hs-identifier">dep_orphs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">stableModuleCmp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_orphs</span><span> </span><a href="#local-6989586621682533372"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-806"></a><span>          </span><span class="hs-identifier">dep_finsts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">stableModuleCmp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_finsts</span><span> </span><a href="#local-6989586621682533372"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-807"></a><span>          </span><span class="hs-identifier">dep_plgins</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">moduleNameFS</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_plgins</span><span> </span><a href="#local-6989586621682533372"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-808"></a><span>
</span><a name="line-809"></a><span class="hs-comment">-- | Creates cached lookup for the 'mi_anns' field of ModIface</span><span>
</span><a name="line-810"></a><span class="hs-comment">-- Hackily, we use &quot;module&quot; as the OccName for any module-level annotations</span><span>
</span><a name="line-811"></a><span class="hs-identifier">mkIfaceAnnCache</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfaceAnnotation</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnPayload</span><span class="hs-special">]</span><span>
</span><a name="line-812"></a><a name="mkIfaceAnnCache"><a href="MkIface.html#mkIfaceAnnCache"><span class="hs-identifier">mkIfaceAnnCache</span></a></a><span> </span><a name="local-6989586621682533373"><a href="#local-6989586621682533373"><span class="hs-identifier">anns</span></a></a><span>
</span><a name="line-813"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682533379"><a href="#local-6989586621682533379"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621682533375"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682533379"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-814"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-815"></a><span>    </span><a name="local-6989586621682533374"><a href="#local-6989586621682533374"><span class="hs-identifier">pair</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IfaceAnnotation</span><span> </span><a name="local-6989586621682533376"><a href="#local-6989586621682533376"><span class="hs-identifier">target</span></a></a><span> </span><a name="local-6989586621682533377"><a href="#local-6989586621682533377"><span class="hs-identifier">value</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-816"></a><span>      </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533376"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-817"></a><span>          </span><span class="hs-identifier hs-var">NamedTarget</span><span> </span><a name="local-6989586621682533378"><a href="#local-6989586621682533378"><span class="hs-identifier">occn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682533378"><span class="hs-identifier hs-var">occn</span></a><span>
</span><a name="line-818"></a><span>          </span><span class="hs-identifier hs-var">ModuleTarget</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkVarOcc</span><span> </span><span class="hs-string">&quot;module&quot;</span><span>
</span><a name="line-819"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682533377"><span class="hs-identifier hs-var">value</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>    </span><span class="hs-comment">-- flipping (++), so the first argument is always short</span><span>
</span><a name="line-821"></a><span>    </span><a name="local-6989586621682533375"><a href="#local-6989586621682533375"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkOccEnv_C</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533374"><span class="hs-identifier hs-var">pair</span></a><span> </span><a href="#local-6989586621682533373"><span class="hs-identifier hs-var">anns</span></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>
</span><a name="line-823"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
          The ABI of an IfaceDecl
*                                                                      *
************************************************************************

Note [The ABI of an IfaceDecl]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The ABI of a declaration consists of:

   (a) the full name of the identifier (inc. module and package,
       because these are used to construct the symbol name by which
       the identifier is known externally).

   (b) the declaration itself, as exposed to clients.  That is, the
       definition of an Id is included in the fingerprint only if
       it is made available as an unfolding in the interface.

   (c) the fixity of the identifier (if it exists)
   (d) for Ids: rules
   (e) for classes: instances, fixity &amp; rules for methods
   (f) for datatypes: instances, fixity &amp; rules for constrs

Items (c)-(f) are not stored in the IfaceDecl, but instead appear
elsewhere in the interface file.  But they are *fingerprinted* with
the declaration itself. This is done by grouping (c)-(f) in IfaceDeclExtras,
and fingerprinting that as part of the declaration.
-}</span><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span class="hs-keyword">type</span><span> </span><a name="IfaceDeclABI"><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier">IfaceDeclABI</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">,</span><span> </span><a href="MkIface.html#IfaceDeclExtras"><span class="hs-identifier hs-type">IfaceDeclExtras</span></a><span class="hs-special">)</span><span>
</span><a name="line-854"></a><span>
</span><a name="line-855"></a><span class="hs-keyword">data</span><span> </span><a name="IfaceDeclExtras"><a href="MkIface.html#IfaceDeclExtras"><span class="hs-identifier">IfaceDeclExtras</span></a></a><span>
</span><a name="line-856"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="IfaceIdExtras"><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier">IfaceIdExtras</span></a></a><span> </span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-type">IfaceIdExtras</span></a><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IfaceDataExtras"><a href="MkIface.html#IfaceDataExtras"><span class="hs-identifier">IfaceDataExtras</span></a></a><span>
</span><a name="line-859"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Fixity of the tycon itself (if it exists)</span><span>
</span><a name="line-860"></a><span>       </span><span class="hs-special">[</span><a href="MkIface.html#IfaceInstABI"><span class="hs-identifier hs-type">IfaceInstABI</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Local class and family instances of this tycon</span><span>
</span><a name="line-861"></a><span>                                </span><span class="hs-comment">-- See Note [Orphans] in InstEnv</span><span>
</span><a name="line-862"></a><span>       </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnPayload</span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Annotations of the type itself</span><span>
</span><a name="line-863"></a><span>       </span><span class="hs-special">[</span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-type">IfaceIdExtras</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- For each constructor: fixity, RULES and annotations</span><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IfaceClassExtras"><a href="MkIface.html#IfaceClassExtras"><span class="hs-identifier">IfaceClassExtras</span></a></a><span>
</span><a name="line-866"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Fixity of the class itself (if it exists)</span><span>
</span><a name="line-867"></a><span>       </span><span class="hs-special">[</span><a href="MkIface.html#IfaceInstABI"><span class="hs-identifier hs-type">IfaceInstABI</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Local instances of this class *or*</span><span>
</span><a name="line-868"></a><span>                                </span><span class="hs-comment">--   of its associated data types</span><span>
</span><a name="line-869"></a><span>                                </span><span class="hs-comment">-- See Note [Orphans] in InstEnv</span><span>
</span><a name="line-870"></a><span>       </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnPayload</span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Annotations of the type itself</span><span>
</span><a name="line-871"></a><span>       </span><span class="hs-special">[</span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-type">IfaceIdExtras</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- For each class method: fixity, RULES and annotations</span><span>
</span><a name="line-872"></a><span>       </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfExtName</span><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- Default methods. If a module</span><span>
</span><a name="line-873"></a><span>                                </span><span class="hs-comment">-- mentions a class, then it can</span><span>
</span><a name="line-874"></a><span>                                </span><span class="hs-comment">-- instantiate the class and thereby</span><span>
</span><a name="line-875"></a><span>                                </span><span class="hs-comment">-- use the default methods, so we must</span><span>
</span><a name="line-876"></a><span>                                </span><span class="hs-comment">-- include these in the fingerprint of</span><span>
</span><a name="line-877"></a><span>                                </span><span class="hs-comment">-- a class.</span><span>
</span><a name="line-878"></a><span>
</span><a name="line-879"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IfaceSynonymExtras"><a href="MkIface.html#IfaceSynonymExtras"><span class="hs-identifier">IfaceSynonymExtras</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnPayload</span><span class="hs-special">]</span><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IfaceFamilyExtras"><a href="MkIface.html#IfaceFamilyExtras"><span class="hs-identifier">IfaceFamilyExtras</span></a></a><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="MkIface.html#IfaceInstABI"><span class="hs-identifier hs-type">IfaceInstABI</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnPayload</span><span class="hs-special">]</span><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IfaceOtherDeclExtras"><a href="MkIface.html#IfaceOtherDeclExtras"><span class="hs-identifier">IfaceOtherDeclExtras</span></a></a><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span class="hs-keyword">data</span><span> </span><a name="IfaceIdExtras"><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier">IfaceIdExtras</span></a></a><span>
</span><a name="line-886"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="IdExtras"><a href="MkIface.html#IdExtras"><span class="hs-identifier">IdExtras</span></a></a><span>
</span><a name="line-887"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Fixity of the Id (if it exists)</span><span>
</span><a name="line-888"></a><span>       </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfaceRule</span><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- Rules for the Id</span><span>
</span><a name="line-889"></a><span>       </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnPayload</span><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Annotations for the Id</span><span>
</span><a name="line-890"></a><span>
</span><a name="line-891"></a><span class="hs-comment">-- When hashing a class or family instance, we hash only the</span><span>
</span><a name="line-892"></a><span class="hs-comment">-- DFunId or CoAxiom, because that depends on all the</span><span>
</span><a name="line-893"></a><span class="hs-comment">-- information about the instance.</span><span>
</span><a name="line-894"></a><span class="hs-comment">--</span><span>
</span><a name="line-895"></a><span class="hs-keyword">type</span><span> </span><a name="IfaceInstABI"><a href="MkIface.html#IfaceInstABI"><span class="hs-identifier">IfaceInstABI</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">IfExtName</span><span>   </span><span class="hs-comment">-- Name of DFunId or CoAxiom that is evidence for the instance</span><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span class="hs-identifier">abiDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier hs-type">IfaceDeclABI</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span>
</span><a name="line-898"></a><a name="abiDecl"><a href="MkIface.html#abiDecl"><span class="hs-identifier">abiDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682533380"><a href="#local-6989586621682533380"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533380"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-899"></a><span>
</span><a name="line-900"></a><span class="hs-identifier">cmp_abiNames</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier hs-type">IfaceDeclABI</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier hs-type">IfaceDeclABI</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-901"></a><a name="cmp_abiNames"><a href="MkIface.html#cmp_abiNames"><span class="hs-identifier">cmp_abiNames</span></a></a><span> </span><a name="local-6989586621682533381"><a href="#local-6989586621682533381"><span class="hs-identifier">abi1</span></a></a><span> </span><a name="local-6989586621682533382"><a href="#local-6989586621682533382"><span class="hs-identifier">abi2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#abiDecl"><span class="hs-identifier hs-var">abiDecl</span></a><span> </span><a href="#local-6989586621682533381"><span class="hs-identifier hs-var">abi1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span>
</span><a name="line-902"></a><span>                         </span><span class="hs-identifier hs-var">getOccName</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#abiDecl"><span class="hs-identifier hs-var">abiDecl</span></a><span> </span><a href="#local-6989586621682533382"><span class="hs-identifier hs-var">abi2</span></a><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span class="hs-identifier">freeNamesDeclABI</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkIface.html#IfaceDeclABI"><span class="hs-identifier hs-type">IfaceDeclABI</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-905"></a><a name="freeNamesDeclABI"><a href="MkIface.html#freeNamesDeclABI"><span class="hs-identifier">freeNamesDeclABI</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533383"><a href="#local-6989586621682533383"><span class="hs-identifier">_mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533384"><a href="#local-6989586621682533384"><span class="hs-identifier">decl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533385"><a href="#local-6989586621682533385"><span class="hs-identifier">extras</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-906"></a><span>  </span><span class="hs-identifier hs-var">freeNamesIfDecl</span><span> </span><a href="#local-6989586621682533384"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><a href="MkIface.html#freeNamesDeclExtras"><span class="hs-identifier hs-var">freeNamesDeclExtras</span></a><span> </span><a href="#local-6989586621682533385"><span class="hs-identifier hs-var">extras</span></a><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span class="hs-identifier">freeNamesDeclExtras</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkIface.html#IfaceDeclExtras"><span class="hs-identifier hs-type">IfaceDeclExtras</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-909"></a><a name="freeNamesDeclExtras"><a href="MkIface.html#freeNamesDeclExtras"><span class="hs-identifier">freeNamesDeclExtras</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-var">IfaceIdExtras</span></a><span> </span><a name="local-6989586621682533386"><a href="#local-6989586621682533386"><span class="hs-identifier">id_extras</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-910"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#freeNamesIdExtras"><span class="hs-identifier hs-var">freeNamesIdExtras</span></a><span> </span><a href="#local-6989586621682533386"><span class="hs-identifier hs-var">id_extras</span></a><span>
</span><a name="line-911"></a><span class="hs-identifier">freeNamesDeclExtras</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceDataExtras"><span class="hs-identifier hs-var">IfaceDataExtras</span></a><span>  </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682533387"><a href="#local-6989586621682533387"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682533388"><a href="#local-6989586621682533388"><span class="hs-identifier">subs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-912"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionNameSets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><a href="#local-6989586621682533387"><span class="hs-identifier hs-var">insts</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#freeNamesIdExtras"><span class="hs-identifier hs-var">freeNamesIdExtras</span></a><span> </span><a href="#local-6989586621682533388"><span class="hs-identifier hs-var">subs</span></a><span class="hs-special">)</span><span>
</span><a name="line-913"></a><span class="hs-identifier">freeNamesDeclExtras</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceClassExtras"><span class="hs-identifier hs-var">IfaceClassExtras</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682533389"><a href="#local-6989586621682533389"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682533390"><a href="#local-6989586621682533390"><span class="hs-identifier">subs</span></a></a><span> </span><a name="local-6989586621682533391"><a href="#local-6989586621682533391"><span class="hs-identifier">defms</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-914"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionNameSets</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-915"></a><span>      </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><a href="#local-6989586621682533389"><span class="hs-identifier hs-var">insts</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><a href="#local-6989586621682533391"><span class="hs-identifier hs-var">defms</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#freeNamesIdExtras"><span class="hs-identifier hs-var">freeNamesIdExtras</span></a><span> </span><a href="#local-6989586621682533390"><span class="hs-identifier hs-var">subs</span></a><span>
</span><a name="line-916"></a><span class="hs-identifier">freeNamesDeclExtras</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceSynonymExtras"><span class="hs-identifier hs-var">IfaceSynonymExtras</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-917"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span>
</span><a name="line-918"></a><span class="hs-identifier">freeNamesDeclExtras</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceFamilyExtras"><span class="hs-identifier hs-var">IfaceFamilyExtras</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682533392"><a href="#local-6989586621682533392"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><a href="#local-6989586621682533392"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-920"></a><span class="hs-identifier">freeNamesDeclExtras</span><span> </span><a href="MkIface.html#IfaceOtherDeclExtras"><span class="hs-identifier hs-var">IfaceOtherDeclExtras</span></a><span>
</span><a name="line-921"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span class="hs-identifier">freeNamesIdExtras</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-type">IfaceIdExtras</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameSet</span><span>
</span><a name="line-924"></a><a name="freeNamesIdExtras"><a href="MkIface.html#freeNamesIdExtras"><span class="hs-identifier">freeNamesIdExtras</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IdExtras"><span class="hs-identifier hs-var">IdExtras</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682533393"><a href="#local-6989586621682533393"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unionNameSets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">freeNamesIfRule</span><span> </span><a href="#local-6989586621682533393"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span>
</span><a name="line-925"></a><span>
</span><a name="line-926"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="MkIface.html#IfaceDeclExtras"><span class="hs-identifier hs-type">IfaceDeclExtras</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-927"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="MkIface.html#IfaceOtherDeclExtras"><span class="hs-identifier hs-var">IfaceOtherDeclExtras</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-928"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-var">IfaceIdExtras</span></a><span>  </span><a name="local-6989586621682533148"><a href="#local-6989586621682533148"><span class="hs-identifier">extras</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#ppr_id_extras"><span class="hs-identifier hs-var">ppr_id_extras</span></a><span> </span><a href="#local-6989586621682533148"><span class="hs-identifier hs-var">extras</span></a><span>
</span><a name="line-929"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceSynonymExtras"><span class="hs-identifier hs-var">IfaceSynonymExtras</span></a><span> </span><a name="local-6989586621682533149"><a href="#local-6989586621682533149"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533150"><a href="#local-6989586621682533150"><span class="hs-identifier">anns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533149"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533150"><span class="hs-identifier hs-var">anns</span></a><span class="hs-special">]</span><span>
</span><a name="line-930"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceFamilyExtras"><span class="hs-identifier hs-var">IfaceFamilyExtras</span></a><span> </span><a name="local-6989586621682533151"><a href="#local-6989586621682533151"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533152"><a href="#local-6989586621682533152"><span class="hs-identifier">finsts</span></a></a><span> </span><a name="local-6989586621682533153"><a href="#local-6989586621682533153"><span class="hs-identifier">anns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533151"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533152"><span class="hs-identifier hs-var">finsts</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533153"><span class="hs-identifier hs-var">anns</span></a><span class="hs-special">]</span><span>
</span><a name="line-931"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceDataExtras"><span class="hs-identifier hs-var">IfaceDataExtras</span></a><span> </span><a name="local-6989586621682533154"><a href="#local-6989586621682533154"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533155"><a href="#local-6989586621682533155"><span class="hs-identifier">insts</span></a></a><span> </span><a name="local-6989586621682533156"><a href="#local-6989586621682533156"><span class="hs-identifier">anns</span></a></a><span> </span><a name="local-6989586621682533157"><a href="#local-6989586621682533157"><span class="hs-identifier">stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533154"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">,</span><span> </span><a href="MkIface.html#ppr_insts"><span class="hs-identifier hs-var">ppr_insts</span></a><span> </span><a href="#local-6989586621682533155"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533156"><span class="hs-identifier hs-var">anns</span></a><span class="hs-special">,</span><span>
</span><a name="line-932"></a><span>                                                </span><a href="MkIface.html#ppr_id_extras_s"><span class="hs-identifier hs-var">ppr_id_extras_s</span></a><span> </span><a href="#local-6989586621682533157"><span class="hs-identifier hs-var">stuff</span></a><span class="hs-special">]</span><span>
</span><a name="line-933"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceClassExtras"><span class="hs-identifier hs-var">IfaceClassExtras</span></a><span> </span><a name="local-6989586621682533158"><a href="#local-6989586621682533158"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533159"><a href="#local-6989586621682533159"><span class="hs-identifier">insts</span></a></a><span> </span><a name="local-6989586621682533160"><a href="#local-6989586621682533160"><span class="hs-identifier">anns</span></a></a><span> </span><a name="local-6989586621682533161"><a href="#local-6989586621682533161"><span class="hs-identifier">stuff</span></a></a><span> </span><a name="local-6989586621682533162"><a href="#local-6989586621682533162"><span class="hs-identifier">defms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-934"></a><span>    </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533158"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">,</span><span> </span><a href="MkIface.html#ppr_insts"><span class="hs-identifier hs-var">ppr_insts</span></a><span> </span><a href="#local-6989586621682533159"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533160"><span class="hs-identifier hs-var">anns</span></a><span class="hs-special">,</span><span>
</span><a name="line-935"></a><span>          </span><a href="MkIface.html#ppr_id_extras_s"><span class="hs-identifier hs-var">ppr_id_extras_s</span></a><span> </span><a href="#local-6989586621682533161"><span class="hs-identifier hs-var">stuff</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533162"><span class="hs-identifier hs-var">defms</span></a><span class="hs-special">]</span><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span class="hs-identifier">ppr_insts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="MkIface.html#IfaceInstABI"><span class="hs-identifier hs-type">IfaceInstABI</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-938"></a><a name="ppr_insts"><a href="MkIface.html#ppr_insts"><span class="hs-identifier">ppr_insts</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;&lt;insts&gt;&quot;</span><span>
</span><a name="line-939"></a><span>
</span><a name="line-940"></a><span class="hs-identifier">ppr_id_extras_s</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-type">IfaceIdExtras</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-941"></a><a name="ppr_id_extras_s"><a href="MkIface.html#ppr_id_extras_s"><span class="hs-identifier">ppr_id_extras_s</span></a></a><span> </span><a name="local-6989586621682533394"><a href="#local-6989586621682533394"><span class="hs-identifier">stuff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="MkIface.html#ppr_id_extras"><span class="hs-identifier hs-var">ppr_id_extras</span></a><span> </span><a href="#local-6989586621682533394"><span class="hs-identifier hs-var">stuff</span></a><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span class="hs-identifier">ppr_id_extras</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-type">IfaceIdExtras</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-944"></a><a name="ppr_id_extras"><a href="MkIface.html#ppr_id_extras"><span class="hs-identifier">ppr_id_extras</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IdExtras"><span class="hs-identifier hs-var">IdExtras</span></a><span> </span><a name="local-6989586621682533395"><a href="#local-6989586621682533395"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533396"><a href="#local-6989586621682533396"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-6989586621682533397"><a href="#local-6989586621682533397"><span class="hs-identifier">anns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533395"><span class="hs-identifier hs-var">fix</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533396"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533397"><span class="hs-identifier hs-var">anns</span></a><span class="hs-special">)</span><span>
</span><a name="line-945"></a><span>
</span><a name="line-946"></a><span class="hs-comment">-- This instance is used only to compute fingerprints</span><span>
</span><a name="line-947"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="MkIface.html#IfaceDeclExtras"><span class="hs-identifier hs-type">IfaceDeclExtras</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-948"></a><span>  </span><a name="local-8214565720323805155"><span class="hs-identifier">get</span></a><span> </span><a name="local-6989586621682533126"><a href="#local-6989586621682533126"><span class="hs-identifier">_bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;no get for IfaceDeclExtras&quot;</span><span>
</span><a name="line-949"></a><span>  </span><a name="local-8214565720323805157"><span class="hs-identifier">put_</span></a><span> </span><a name="local-6989586621682533127"><a href="#local-6989586621682533127"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-var">IfaceIdExtras</span></a><span> </span><a name="local-6989586621682533128"><a href="#local-6989586621682533128"><span class="hs-identifier">extras</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-950"></a><span>   </span><span class="hs-identifier hs-var">putByte</span><span> </span><a href="#local-6989586621682533127"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533127"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533128"><span class="hs-identifier hs-var">extras</span></a><span>
</span><a name="line-951"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682533129"><a href="#local-6989586621682533129"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceDataExtras"><span class="hs-identifier hs-var">IfaceDataExtras</span></a><span> </span><a name="local-6989586621682533130"><a href="#local-6989586621682533130"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533131"><a href="#local-6989586621682533131"><span class="hs-identifier">insts</span></a></a><span> </span><a name="local-6989586621682533132"><a href="#local-6989586621682533132"><span class="hs-identifier">anns</span></a></a><span> </span><a name="local-6989586621682533133"><a href="#local-6989586621682533133"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-952"></a><span>   </span><span class="hs-identifier hs-var">putByte</span><span> </span><a href="#local-6989586621682533129"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533129"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533130"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533129"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533131"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533129"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533132"><span class="hs-identifier hs-var">anns</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533129"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533133"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-953"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682533134"><a href="#local-6989586621682533134"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceClassExtras"><span class="hs-identifier hs-var">IfaceClassExtras</span></a><span> </span><a name="local-6989586621682533135"><a href="#local-6989586621682533135"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533136"><a href="#local-6989586621682533136"><span class="hs-identifier">insts</span></a></a><span> </span><a name="local-6989586621682533137"><a href="#local-6989586621682533137"><span class="hs-identifier">anns</span></a></a><span> </span><a name="local-6989586621682533138"><a href="#local-6989586621682533138"><span class="hs-identifier">methods</span></a></a><span> </span><a name="local-6989586621682533139"><a href="#local-6989586621682533139"><span class="hs-identifier">defms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-954"></a><span>   </span><span class="hs-identifier hs-var">putByte</span><span> </span><a href="#local-6989586621682533134"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">3</span><span>
</span><a name="line-955"></a><span>   </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533134"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533135"><span class="hs-identifier hs-var">fix</span></a><span>
</span><a name="line-956"></a><span>   </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533134"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533136"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-957"></a><span>   </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533134"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533137"><span class="hs-identifier hs-var">anns</span></a><span>
</span><a name="line-958"></a><span>   </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533134"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533138"><span class="hs-identifier hs-var">methods</span></a><span>
</span><a name="line-959"></a><span>   </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533134"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533139"><span class="hs-identifier hs-var">defms</span></a><span>
</span><a name="line-960"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682533140"><a href="#local-6989586621682533140"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceSynonymExtras"><span class="hs-identifier hs-var">IfaceSynonymExtras</span></a><span> </span><a name="local-6989586621682533141"><a href="#local-6989586621682533141"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533142"><a href="#local-6989586621682533142"><span class="hs-identifier">anns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-961"></a><span>   </span><span class="hs-identifier hs-var">putByte</span><span> </span><a href="#local-6989586621682533140"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">4</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533140"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533141"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533140"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533142"><span class="hs-identifier hs-var">anns</span></a><span>
</span><a name="line-962"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682533143"><a href="#local-6989586621682533143"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IfaceFamilyExtras"><span class="hs-identifier hs-var">IfaceFamilyExtras</span></a><span> </span><a name="local-6989586621682533144"><a href="#local-6989586621682533144"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533145"><a href="#local-6989586621682533145"><span class="hs-identifier">finsts</span></a></a><span> </span><a name="local-6989586621682533146"><a href="#local-6989586621682533146"><span class="hs-identifier">anns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-963"></a><span>   </span><span class="hs-identifier hs-var">putByte</span><span> </span><a href="#local-6989586621682533143"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">5</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533143"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533144"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533143"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533145"><span class="hs-identifier hs-var">finsts</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533143"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533146"><span class="hs-identifier hs-var">anns</span></a><span>
</span><a name="line-964"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682533147"><a href="#local-6989586621682533147"><span class="hs-identifier">bh</span></a></a><span> </span><a href="MkIface.html#IfaceOtherDeclExtras"><span class="hs-identifier hs-var">IfaceOtherDeclExtras</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">putByte</span><span> </span><a href="#local-6989586621682533147"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">6</span><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Binary</span><span> </span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-type">IfaceIdExtras</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-967"></a><span>  </span><a name="local-8214565720323805155"><span class="hs-identifier">get</span></a><span> </span><a name="local-6989586621682533121"><a href="#local-6989586621682533121"><span class="hs-identifier">_bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;no get for IfaceIdExtras&quot;</span><span>
</span><a name="line-968"></a><span>  </span><a name="local-8214565720323805157"><span class="hs-identifier">put_</span></a><span> </span><a name="local-6989586621682533122"><a href="#local-6989586621682533122"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="MkIface.html#IdExtras"><span class="hs-identifier hs-var">IdExtras</span></a><span> </span><a name="local-6989586621682533123"><a href="#local-6989586621682533123"><span class="hs-identifier">fix</span></a></a><span> </span><a name="local-6989586621682533124"><a href="#local-6989586621682533124"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-6989586621682533125"><a href="#local-6989586621682533125"><span class="hs-identifier">anns</span></a></a><span class="hs-special">)</span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533122"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533123"><span class="hs-identifier hs-var">fix</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533122"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533124"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">put_</span><span> </span><a href="#local-6989586621682533122"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682533125"><span class="hs-identifier hs-var">anns</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span class="hs-identifier">declExtras</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AnnPayload</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-972"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfaceRule</span><span class="hs-special">]</span><span>
</span><a name="line-973"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfaceClsInst</span><span class="hs-special">]</span><span>
</span><a name="line-974"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfaceFamInst</span><span class="hs-special">]</span><span>
</span><a name="line-975"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-identifier hs-type">IfExtName</span><span>          </span><span class="hs-comment">-- lookup default method names</span><span>
</span><a name="line-976"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span>
</span><a name="line-977"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#IfaceDeclExtras"><span class="hs-identifier hs-type">IfaceDeclExtras</span></a><span>
</span><a name="line-978"></a><span>
</span><a name="line-979"></a><a name="declExtras"><a href="MkIface.html#declExtras"><span class="hs-identifier">declExtras</span></a></a><span> </span><a name="local-6989586621682533398"><a href="#local-6989586621682533398"><span class="hs-identifier">fix_fn</span></a></a><span> </span><a name="local-6989586621682533399"><a href="#local-6989586621682533399"><span class="hs-identifier">ann_fn</span></a></a><span> </span><a name="local-6989586621682533400"><a href="#local-6989586621682533400"><span class="hs-identifier">rule_env</span></a></a><span> </span><a name="local-6989586621682533401"><a href="#local-6989586621682533401"><span class="hs-identifier">inst_env</span></a></a><span> </span><a name="local-6989586621682533402"><a href="#local-6989586621682533402"><span class="hs-identifier">fi_env</span></a></a><span> </span><a name="local-6989586621682533403"><a href="#local-6989586621682533403"><span class="hs-identifier">dm_env</span></a></a><span> </span><a name="local-6989586621682533404"><a href="#local-6989586621682533404"><span class="hs-identifier">decl</span></a></a><span>
</span><a name="line-980"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533404"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-981"></a><span>      </span><span class="hs-identifier hs-var">IfaceId</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#IfaceIdExtras"><span class="hs-identifier hs-var">IfaceIdExtras</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533406"><span class="hs-identifier hs-var">id_extras</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>      </span><span class="hs-identifier hs-var">IfaceData</span><span class="hs-special">{</span><span class="hs-identifier">ifCons</span><span class="hs-glyph">=</span><a name="local-6989586621682533410"><a href="#local-6989586621682533410"><span class="hs-identifier">cons</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-983"></a><span>                     </span><a href="MkIface.html#IfaceDataExtras"><span class="hs-identifier hs-var">IfaceDataExtras</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533398"><span class="hs-identifier hs-var">fix_fn</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ifFamInstAxiom</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#lookupOccEnvL"><span class="hs-identifier hs-var">lookupOccEnvL</span></a><span> </span><a href="#local-6989586621682533402"><span class="hs-identifier hs-var">fi_env</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-985"></a><span>                         </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ifDFun</span><span>         </span><span class="hs-special">(</span><a href="MkIface.html#lookupOccEnvL"><span class="hs-identifier hs-var">lookupOccEnvL</span></a><span> </span><a href="#local-6989586621682533401"><span class="hs-identifier hs-var">inst_env</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-986"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621682533399"><span class="hs-identifier hs-var">ann_fn</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-987"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533406"><span class="hs-identifier hs-var">id_extras</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">occName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ifConName</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">visibleIfConDecls</span><span> </span><a href="#local-6989586621682533410"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>      </span><span class="hs-identifier hs-var">IfaceClass</span><span class="hs-special">{</span><span class="hs-identifier">ifBody</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfConcreteClass</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifSigs</span><span class="hs-glyph">=</span><a name="local-6989586621682533411"><a href="#local-6989586621682533411"><span class="hs-identifier">sigs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifATs</span><span class="hs-glyph">=</span><a name="local-6989586621682533412"><a href="#local-6989586621682533412"><span class="hs-identifier">ats</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-989"></a><span>                     </span><a href="MkIface.html#IfaceClassExtras"><span class="hs-identifier hs-var">IfaceClassExtras</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533398"><span class="hs-identifier hs-var">fix_fn</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533413"><span class="hs-identifier hs-var">insts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533399"><span class="hs-identifier hs-var">ann_fn</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533414"><span class="hs-identifier hs-var">meths</span></a><span> </span><a href="#local-6989586621682533415"><span class="hs-identifier hs-var">defms</span></a><span>
</span><a name="line-990"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-991"></a><span>            </span><a name="local-6989586621682533413"><a href="#local-6989586621682533413"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ifDFun</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621682533407"><span class="hs-identifier hs-var">at_extras</span></a><span> </span><a href="#local-6989586621682533412"><span class="hs-identifier hs-var">ats</span></a><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>                                    </span><span class="hs-operator hs-var">++</span><span> </span><a href="MkIface.html#lookupOccEnvL"><span class="hs-identifier hs-var">lookupOccEnvL</span></a><span> </span><a href="#local-6989586621682533401"><span class="hs-identifier hs-var">inst_env</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-993"></a><span>                           </span><span class="hs-comment">-- Include instances of the associated types</span><span>
</span><a name="line-994"></a><span>                           </span><span class="hs-comment">-- as well as instances of the class (Trac #5147)</span><span>
</span><a name="line-995"></a><span>            </span><a name="local-6989586621682533414"><a href="#local-6989586621682533414"><span class="hs-identifier">meths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682533406"><span class="hs-identifier hs-var">id_extras</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621682533416"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">IfaceClassOp</span><span> </span><a name="local-6989586621682533416"><a href="#local-6989586621682533416"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533411"><span class="hs-identifier hs-var">sigs</span></a><span class="hs-special">]</span><span>
</span><a name="line-996"></a><span>            </span><span class="hs-comment">-- Names of all the default methods (see Note [default method Name])</span><span>
</span><a name="line-997"></a><span>            </span><a name="local-6989586621682533415"><a href="#local-6989586621682533415"><span class="hs-identifier">defms</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682533419"><span class="hs-identifier hs-var">dmName</span></a><span>
</span><a name="line-998"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">IfaceClassOp</span><span> </span><a name="local-6989586621682533417"><a href="#local-6989586621682533417"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533411"><span class="hs-identifier hs-var">sigs</span></a><span>
</span><a name="line-999"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533418"><a href="#local-6989586621682533418"><span class="hs-identifier">dmOcc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkDefaultMethodOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682533417"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533419"><a href="#local-6989586621682533419"><span class="hs-identifier">dmName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621682533403"><span class="hs-identifier hs-var">dm_env</span></a><span> </span><a href="#local-6989586621682533418"><span class="hs-identifier hs-var">dmOcc</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1001"></a><span>      </span><span class="hs-identifier hs-var">IfaceSynonym</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#IfaceSynonymExtras"><span class="hs-identifier hs-var">IfaceSynonymExtras</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533398"><span class="hs-identifier hs-var">fix_fn</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><span>                                           </span><span class="hs-special">(</span><a href="#local-6989586621682533399"><span class="hs-identifier hs-var">ann_fn</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1003"></a><span>      </span><span class="hs-identifier hs-var">IfaceFamily</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#IfaceFamilyExtras"><span class="hs-identifier hs-var">IfaceFamilyExtras</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533398"><span class="hs-identifier hs-var">fix_fn</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1004"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ifFamInstAxiom</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#lookupOccEnvL"><span class="hs-identifier hs-var">lookupOccEnvL</span></a><span> </span><a href="#local-6989586621682533402"><span class="hs-identifier hs-var">fi_env</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1005"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621682533399"><span class="hs-identifier hs-var">ann_fn</span></a><span> </span><a href="#local-6989586621682533405"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1006"></a><span>      </span><a name="local-6989586621682533420"><a href="#local-6989586621682533420"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#IfaceOtherDeclExtras"><span class="hs-identifier hs-var">IfaceOtherDeclExtras</span></a><span>
</span><a name="line-1007"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1008"></a><span>        </span><a name="local-6989586621682533405"><a href="#local-6989586621682533405"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621682533404"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-1009"></a><span>        </span><a name="local-6989586621682533406"><a href="#local-6989586621682533406"><span class="hs-identifier">id_extras</span></a></a><span> </span><a name="local-6989586621682533408"><a href="#local-6989586621682533408"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#IdExtras"><span class="hs-identifier hs-var">IdExtras</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533398"><span class="hs-identifier hs-var">fix_fn</span></a><span> </span><a href="#local-6989586621682533408"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#lookupOccEnvL"><span class="hs-identifier hs-var">lookupOccEnvL</span></a><span> </span><a href="#local-6989586621682533400"><span class="hs-identifier hs-var">rule_env</span></a><span> </span><a href="#local-6989586621682533408"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533399"><span class="hs-identifier hs-var">ann_fn</span></a><span> </span><a href="#local-6989586621682533408"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><span>        </span><a name="local-6989586621682533407"><a href="#local-6989586621682533407"><span class="hs-identifier">at_extras</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IfaceAT</span><span> </span><a name="local-6989586621682533409"><a href="#local-6989586621682533409"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#lookupOccEnvL"><span class="hs-identifier hs-var">lookupOccEnvL</span></a><span> </span><a href="#local-6989586621682533401"><span class="hs-identifier hs-var">inst_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getOccName</span><span> </span><a href="#local-6989586621682533409"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1011"></a><span>
</span><a name="line-1012"></a><span>
</span><a name="line-1013"></a><span class="hs-comment">{- Note [default method Name] (see also #15970)

The Names for the default methods aren't available in the IfaceSyn.

* We originally start with a DefMethInfo from the class, contain a
  Name for the default method

* We turn that into IfaceSyn as a DefMethSpec which lacks a Name
  entirely. Why? Because the Name can be derived from the method name
  (in TcIface), so doesn't need to be serialised into the interface
  file.

But now we have to get the Name back, because the class declaration's
fingerprint needs to depend on it (this was the bug in #15970).  This
is done in a slightly convoluted way:

* Then, in addFingerprints we build a map that maps OccNames to Names

* We pass that map to declExtras which laboriously looks up in the map
  (using the derived occurrence name) to recover the Name we have just
  thrown away.
-}</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span class="hs-identifier">lookupOccEnvL</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682533165"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682533165"><span class="hs-identifier hs-type">v</span></a><span class="hs-special">]</span><span>
</span><a name="line-1037"></a><a name="lookupOccEnvL"><a href="MkIface.html#lookupOccEnvL"><span class="hs-identifier">lookupOccEnvL</span></a></a><span> </span><a name="local-6989586621682533421"><a href="#local-6989586621682533421"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682533422"><a href="#local-6989586621682533422"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621682533421"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682533422"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1038"></a><span>
</span><a name="line-1039"></a><span class="hs-comment">{-
-- for testing: use the md5sum command to generate fingerprints and
-- compare the results against our built-in version.
  fp' &lt;- oldMD5 dflags bh
  if fp /= fp' then pprPanic &quot;computeFingerprint&quot; (ppr fp &lt;+&gt; ppr fp')
               else return fp

oldMD5 dflags bh = do
  tmp &lt;- newTempName dflags CurrentModule &quot;bin&quot;
  writeBinMem bh tmp
  tmp2 &lt;- newTempName dflags CurrentModule &quot;md5&quot;
  let cmd = &quot;md5sum &quot; ++ tmp ++ &quot; &gt;&quot; ++ tmp2
  r &lt;- system cmd
  case r of
    ExitFailure _ -&gt; throwGhcExceptionIO (PhaseFailed cmd r)
    ExitSuccess -&gt; do
        hash_str &lt;- readFile tmp2
        return $! readHexFingerprint hash_str
-}</span><span>
</span><a name="line-1058"></a><span>
</span><a name="line-1059"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1060"></a><span class="hs-comment">-- mkOrphMap partitions instance decls or rules into</span><span>
</span><a name="line-1061"></a><span class="hs-comment">--      (a) an OccEnv for ones that are not orphans,</span><span>
</span><a name="line-1062"></a><span class="hs-comment">--          mapping the local OccName to a list of its decls</span><span>
</span><a name="line-1063"></a><span class="hs-comment">--      (b) a list of orphan decls</span><span>
</span><a name="line-1064"></a><span class="hs-identifier">mkOrphMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533164"><span class="hs-identifier hs-type">decl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IsOrphan</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Extract orphan status from decl</span><span>
</span><a name="line-1065"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682533164"><span class="hs-identifier hs-type">decl</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Sorted into canonical order</span><span>
</span><a name="line-1066"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccEnv</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682533164"><span class="hs-identifier hs-type">decl</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Non-orphan decls associated with their key;</span><span>
</span><a name="line-1067"></a><span>                                </span><span class="hs-comment">--      each sublist in canonical order</span><span>
</span><a name="line-1068"></a><span>              </span><span class="hs-special">[</span><a href="#local-6989586621682533164"><span class="hs-identifier hs-type">decl</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Orphan decls; in canonical order</span><span>
</span><a name="line-1069"></a><a name="mkOrphMap"><a href="MkIface.html#mkOrphMap"><span class="hs-identifier">mkOrphMap</span></a></a><span> </span><a name="local-6989586621682533423"><a href="#local-6989586621682533423"><span class="hs-identifier">get_key</span></a></a><span> </span><a name="local-6989586621682533424"><a href="#local-6989586621682533424"><span class="hs-identifier">decls</span></a></a><span>
</span><a name="line-1070"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621682533425"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyOccEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533424"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-1071"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1072"></a><span>    </span><a name="local-6989586621682533425"><a href="#local-6989586621682533425"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533426"><a href="#local-6989586621682533426"><span class="hs-identifier">non_orphs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533427"><a href="#local-6989586621682533427"><span class="hs-identifier">orphs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682533428"><a href="#local-6989586621682533428"><span class="hs-identifier">d</span></a></a><span>
</span><a name="line-1073"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">NotOrphan</span><span> </span><a name="local-6989586621682533429"><a href="#local-6989586621682533429"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533423"><span class="hs-identifier hs-var">get_key</span></a><span> </span><a href="#local-6989586621682533428"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-1074"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendOccEnv_Acc</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">singleton</span><span> </span><a href="#local-6989586621682533426"><span class="hs-identifier hs-var">non_orphs</span></a><span> </span><a href="#local-6989586621682533429"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="#local-6989586621682533428"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533427"><span class="hs-identifier hs-var">orphs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1075"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533426"><span class="hs-identifier hs-var">non_orphs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533428"><span class="hs-identifier hs-var">d</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682533427"><span class="hs-identifier hs-var">orphs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1076"></a><span>
</span><a name="line-1077"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
       COMPLETE Pragmas
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1084"></a><span>
</span><a name="line-1085"></a><span class="hs-identifier">mkIfaceCompleteSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CompleteMatch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceCompleteMatch</span><span>
</span><a name="line-1086"></a><a name="mkIfaceCompleteSig"><a href="MkIface.html#mkIfaceCompleteSig"><span class="hs-identifier">mkIfaceCompleteSig</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CompleteMatch</span><span> </span><a name="local-6989586621682533430"><a href="#local-6989586621682533430"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682533431"><a href="#local-6989586621682533431"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceCompleteMatch</span><span> </span><a href="#local-6989586621682533430"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682533431"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1087"></a><span>
</span><a name="line-1088"></a><span>
</span><a name="line-1089"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
       Keeping track of what we've slurped, and fingerprints
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1096"></a><span>
</span><a name="line-1097"></a><span>
</span><a name="line-1098"></a><span class="hs-identifier">mkIfaceAnnotation</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Annotation</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceAnnotation</span><span>
</span><a name="line-1099"></a><a name="mkIfaceAnnotation"><a href="MkIface.html#mkIfaceAnnotation"><span class="hs-identifier">mkIfaceAnnotation</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Annotation</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ann_target</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533432"><a href="#local-6989586621682533432"><span class="hs-identifier">target</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ann_value</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533433"><a href="#local-6989586621682533433"><span class="hs-identifier">payload</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1100"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceAnnotation</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1101"></a><span>        </span><span class="hs-identifier">ifAnnotatedTarget</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682533432"><span class="hs-identifier hs-var">target</span></a><span class="hs-special">,</span><span>
</span><a name="line-1102"></a><span>        </span><span class="hs-identifier">ifAnnotatedValue</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533433"><span class="hs-identifier hs-var">payload</span></a><span>
</span><a name="line-1103"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1104"></a><span>
</span><a name="line-1105"></a><span class="hs-identifier">mkIfaceExports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfaceExport</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Sort to make canonical</span><span>
</span><a name="line-1106"></a><a name="mkIfaceExports"><a href="MkIface.html#mkIfaceExports"><span class="hs-identifier">mkIfaceExports</span></a></a><span> </span><a name="local-6989586621682533434"><a href="#local-6989586621682533434"><span class="hs-identifier">exports</span></a></a><span>
</span><a name="line-1107"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">stableAvailCmp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533435"><span class="hs-identifier hs-var">sort_subs</span></a><span> </span><a href="#local-6989586621682533434"><span class="hs-identifier hs-var">exports</span></a><span class="hs-special">)</span><span>
</span><a name="line-1108"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1109"></a><span>    </span><span class="hs-identifier">sort_subs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span>
</span><a name="line-1110"></a><span>    </span><a name="local-6989586621682533435"><a href="#local-6989586621682533435"><span class="hs-identifier">sort_subs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Avail</span><span> </span><a name="local-6989586621682533437"><a href="#local-6989586621682533437"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Avail</span><span> </span><a href="#local-6989586621682533437"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1111"></a><span>    </span><span class="hs-identifier">sort_subs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621682533438"><a href="#local-6989586621682533438"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682533439"><a href="#local-6989586621682533439"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682533438"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533436"><span class="hs-identifier hs-var">sort_flds</span></a><span> </span><a href="#local-6989586621682533439"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1112"></a><span>    </span><span class="hs-identifier">sort_subs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a name="local-6989586621682533440"><a href="#local-6989586621682533440"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533441"><a href="#local-6989586621682533441"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682533442"><a href="#local-6989586621682533442"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682533443"><a href="#local-6989586621682533443"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1113"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533440"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">==</span><a href="#local-6989586621682533441"><span class="hs-identifier hs-var">m</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682533440"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533441"><span class="hs-identifier hs-var">m</span></a><span class="hs-glyph">:</span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">stableNameCmp</span><span> </span><a href="#local-6989586621682533442"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533436"><span class="hs-identifier hs-var">sort_flds</span></a><span> </span><a href="#local-6989586621682533443"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1114"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AvailTC</span><span> </span><a href="#local-6989586621682533440"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-identifier hs-var">stableNameCmp</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533441"><span class="hs-identifier hs-var">m</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682533442"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533436"><span class="hs-identifier hs-var">sort_flds</span></a><span> </span><a href="#local-6989586621682533443"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1115"></a><span>       </span><span class="hs-comment">-- Maintain the AvailTC Invariant</span><span>
</span><a name="line-1116"></a><span>
</span><a name="line-1117"></a><span>    </span><a name="local-6989586621682533436"><a href="#local-6989586621682533436"><span class="hs-identifier">sort_flds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stableNameCmp</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">flSelector</span><span class="hs-special">)</span><span>
</span><a name="line-1118"></a><span>
</span><a name="line-1119"></a><span class="hs-comment">{-
Note [Original module]
~~~~~~~~~~~~~~~~~~~~~
Consider this:
        module X where { data family T }
        module Y( T(..) ) where { import X; data instance T Int = MkT Int }
The exported Avail from Y will look like
        X.T{X.T, Y.MkT}
That is, in Y,
  - only MkT is brought into scope by the data instance;
  - but the parent (used for grouping and naming in T(..) exports) is X.T
  - and in this case we export X.T too

In the result of MkIfaceExports, the names are grouped by defining module,
so we may need to split up a single Avail into multiple ones.

Note [Internal used_names]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Most of the used_names are External Names, but we can have Internal
Names too: see Note [Binders in Template Haskell] in Convert, and
Trac #5362 for an example.  Such Names are always
  - Such Names are always for locally-defined things, for which we
    don't gather usage info, so we can just ignore them in ent_map
  - They are always System Names, hence the assert, just as a double check.


************************************************************************
*                                                                      *
        Load the old interface file for this module (unless
        we have it already), and check whether it is up to date
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span class="hs-keyword">data</span><span> </span><a name="RecompileRequired"><a href="MkIface.html#RecompileRequired"><span class="hs-identifier">RecompileRequired</span></a></a><span>
</span><a name="line-1154"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="UpToDate"><a href="MkIface.html#UpToDate"><span class="hs-identifier">UpToDate</span></a></a><span>
</span><a name="line-1155"></a><span>       </span><span class="hs-comment">-- ^ everything is up to date, recompilation is not required</span><span>
</span><a name="line-1156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="MustCompile"><a href="MkIface.html#MustCompile"><span class="hs-identifier">MustCompile</span></a></a><span>
</span><a name="line-1157"></a><span>       </span><span class="hs-comment">-- ^ The .hs file has been touched, or the .o/.hi file does not exist</span><span>
</span><a name="line-1158"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="RecompBecause"><a href="MkIface.html#RecompBecause"><span class="hs-identifier">RecompBecause</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1159"></a><span>       </span><span class="hs-comment">-- ^ The .o/.hi files are up to date, but something else has changed</span><span>
</span><a name="line-1160"></a><span>       </span><span class="hs-comment">-- to force recompilation; the String says what (one-line summary)</span><span>
</span><a name="line-1161"></a><span>   </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Eq</span><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1164"></a><span>  </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span> </span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span> </span><a name="local-6989586621682533119"><a href="#local-6989586621682533119"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533119"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1165"></a><span>  </span><a name="local-6989586621682533120"><a href="#local-6989586621682533120"><span class="hs-identifier">mc</span></a></a><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533120"><span class="hs-identifier hs-var">mc</span></a><span>
</span><a name="line-1166"></a><span>
</span><a name="line-1167"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1168"></a><span>  </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1169"></a><span>
</span><a name="line-1170"></a><span class="hs-identifier">recompileRequired</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1171"></a><a name="recompileRequired"><a href="MkIface.html#recompileRequired"><span class="hs-identifier">recompileRequired</span></a></a><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1172"></a><span class="hs-identifier">recompileRequired</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1173"></a><span>
</span><a name="line-1174"></a><span>
</span><a name="line-1175"></a><span>
</span><a name="line-1176"></a><span class="hs-comment">-- | Top level function to check if the version of an old interface file</span><span>
</span><a name="line-1177"></a><span class="hs-comment">-- is equivalent to the current source file the user asked us to compile.</span><span>
</span><a name="line-1178"></a><span class="hs-comment">-- If the same, we can avoid recompilation. We return a tuple where the</span><span>
</span><a name="line-1179"></a><span class="hs-comment">-- first element is a bool saying if we should recompile the object file</span><span>
</span><a name="line-1180"></a><span class="hs-comment">-- and the second is maybe the interface file, where Nothng means to</span><span>
</span><a name="line-1181"></a><span class="hs-comment">-- rebuild the interface file not use the exisitng one.</span><span>
</span><a name="line-1182"></a><span class="hs-identifier">checkOldIface</span><span>
</span><a name="line-1183"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1184"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1185"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SourceModified</span><span>
</span><a name="line-1186"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>         </span><span class="hs-comment">-- Old interface from compilation manager, if any</span><span>
</span><a name="line-1187"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-1188"></a><span>
</span><a name="line-1189"></a><a name="checkOldIface"><a href="MkIface.html#checkOldIface"><span class="hs-identifier">checkOldIface</span></a></a><span> </span><a name="local-6989586621682533444"><a href="#local-6989586621682533444"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533445"><a href="#local-6989586621682533445"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621682533446"><a href="#local-6989586621682533446"><span class="hs-identifier">source_modified</span></a></a><span> </span><a name="local-6989586621682533447"><a href="#local-6989586621682533447"><span class="hs-identifier">maybe_iface</span></a></a><span>
</span><a name="line-1190"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533448"><a href="#local-6989586621682533448"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533444"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1191"></a><span>        </span><span class="hs-identifier hs-var">showPass</span><span> </span><a href="#local-6989586621682533448"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1192"></a><span>            </span><span class="hs-string">&quot;Checking old interface for &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1193"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showPpr</span><span> </span><a href="#local-6989586621682533448"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621682533445"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1194"></a><span>              </span><span class="hs-string">&quot; (use -ddump-hi-diffs for more details)&quot;</span><span>
</span><a name="line-1195"></a><span>        </span><a href="TcRnMonad.html#initIfaceCheck"><span class="hs-identifier hs-var">initIfaceCheck</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;checkOldIface&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533444"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1196"></a><span>            </span><a href="MkIface.html#check_old_iface"><span class="hs-identifier hs-var">check_old_iface</span></a><span> </span><a href="#local-6989586621682533444"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533445"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621682533446"><span class="hs-identifier hs-var">source_modified</span></a><span> </span><a href="#local-6989586621682533447"><span class="hs-identifier hs-var">maybe_iface</span></a><span>
</span><a name="line-1197"></a><span>
</span><a name="line-1198"></a><span class="hs-identifier">check_old_iface</span><span>
</span><a name="line-1199"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1200"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1201"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SourceModified</span><span>
</span><a name="line-1202"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>
</span><a name="line-1203"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-1204"></a><span>
</span><a name="line-1205"></a><a name="check_old_iface"><a href="MkIface.html#check_old_iface"><span class="hs-identifier">check_old_iface</span></a></a><span> </span><a name="local-6989586621682533449"><a href="#local-6989586621682533449"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533450"><a href="#local-6989586621682533450"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621682533451"><a href="#local-6989586621682533451"><span class="hs-identifier">src_modified</span></a></a><span> </span><a name="local-6989586621682533452"><a href="#local-6989586621682533452"><span class="hs-identifier">maybe_iface</span></a></a><span>
</span><a name="line-1206"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533453"><a href="#local-6989586621682533453"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533449"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1207"></a><span>        </span><a name="local-6989586621682533454"><a href="#local-6989586621682533454"><span class="hs-identifier">getIface</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1208"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533452"><span class="hs-identifier hs-var">maybe_iface</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1209"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1210"></a><span>                    </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;We already have the old interface for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1211"></a><span>                      </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621682533450"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1212"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682533452"><span class="hs-identifier hs-var">maybe_iface</span></a><span>
</span><a name="line-1213"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682533455"><span class="hs-identifier hs-var">loadIface</span></a><span>
</span><a name="line-1214"></a><span>
</span><a name="line-1215"></a><span>        </span><a name="local-6989586621682533455"><a href="#local-6989586621682533455"><span class="hs-identifier">loadIface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1216"></a><span>             </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533457"><a href="#local-6989586621682533457"><span class="hs-identifier">iface_path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">msHiFilePath</span><span> </span><a href="#local-6989586621682533450"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-1217"></a><span>             </span><a name="local-6989586621682533458"><a href="#local-6989586621682533458"><span class="hs-identifier">read_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#readIface"><span class="hs-identifier hs-var">readIface</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621682533450"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533457"><span class="hs-identifier hs-var">iface_path</span></a><span>
</span><a name="line-1218"></a><span>             </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533458"><span class="hs-identifier hs-var">read_result</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1219"></a><span>                 </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621682533459"><a href="#local-6989586621682533459"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1220"></a><span>                     </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;FYI: cannot read old interface file:&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">4</span><span> </span><a href="#local-6989586621682533459"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-1221"></a><span>                     </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Old interface file was invalid:&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">4</span><span> </span><a href="#local-6989586621682533459"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1223"></a><span>                 </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621682533460"><a href="#local-6989586621682533460"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1224"></a><span>                     </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Read the interface file&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621682533457"><span class="hs-identifier hs-var">iface_path</span></a><span class="hs-special">)</span><span>
</span><a name="line-1225"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682533460"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1226"></a><span>
</span><a name="line-1227"></a><span>        </span><a name="local-6989586621682533456"><a href="#local-6989586621682533456"><span class="hs-identifier">src_changed</span></a></a><span>
</span><a name="line-1228"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_ForceRecomp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533449"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1229"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">SourceModified</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533451"><span class="hs-identifier hs-var">src_modified</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1230"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1231"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1232"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621682533456"><span class="hs-identifier hs-var">src_changed</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1233"></a><span>            </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Source file changed or recompilation check turned off&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533456"><span class="hs-identifier hs-var">src_changed</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1236"></a><span>            </span><span class="hs-comment">-- If the source has changed and we're in interactive mode,</span><span>
</span><a name="line-1237"></a><span>            </span><span class="hs-comment">-- avoid reading an interface; just return the one we might</span><span>
</span><a name="line-1238"></a><span>            </span><span class="hs-comment">-- have been supplied with.</span><span>
</span><a name="line-1239"></a><span>            </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isObjectTarget</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hscTarget</span><span> </span><a href="#local-6989586621682533453"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1240"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#MustCompile"><span class="hs-identifier hs-var">MustCompile</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533452"><span class="hs-identifier hs-var">maybe_iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1241"></a><span>
</span><a name="line-1242"></a><span>            </span><span class="hs-comment">-- Try and read the old interface for the current module</span><span>
</span><a name="line-1243"></a><span>            </span><span class="hs-comment">-- from the .hi file left from the last time we compiled it</span><span>
</span><a name="line-1244"></a><span>            </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1245"></a><span>                </span><a name="local-6989586621682533461"><a href="#local-6989586621682533461"><span class="hs-identifier">maybe_iface'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533454"><span class="hs-identifier hs-var">getIface</span></a><span>
</span><a name="line-1246"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#MustCompile"><span class="hs-identifier hs-var">MustCompile</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533461"><span class="hs-identifier hs-var">maybe_iface'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1247"></a><span>
</span><a name="line-1248"></a><span>            </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1249"></a><span>                </span><a name="local-6989586621682533462"><a href="#local-6989586621682533462"><span class="hs-identifier">maybe_iface'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533454"><span class="hs-identifier hs-var">getIface</span></a><span>
</span><a name="line-1250"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533462"><span class="hs-identifier hs-var">maybe_iface'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1251"></a><span>                    </span><span class="hs-comment">-- We can't retrieve the iface</span><span>
</span><a name="line-1252"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#MustCompile"><span class="hs-identifier hs-var">MustCompile</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-1253"></a><span>
</span><a name="line-1254"></a><span>                    </span><span class="hs-comment">-- We have got the old iface; check its versions</span><span>
</span><a name="line-1255"></a><span>                    </span><span class="hs-comment">-- even in the SourceUnmodifiedAndStable case we</span><span>
</span><a name="line-1256"></a><span>                    </span><span class="hs-comment">-- should check versions because some packages</span><span>
</span><a name="line-1257"></a><span>                    </span><span class="hs-comment">-- might have changed or gone away.</span><span>
</span><a name="line-1258"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533463"><a href="#local-6989586621682533463"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#checkVersions"><span class="hs-identifier hs-var">checkVersions</span></a><span> </span><a href="#local-6989586621682533449"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533450"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621682533463"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1259"></a><span>
</span><a name="line-1260"></a><span class="hs-comment">-- | Check if a module is still the same 'version'.</span><span>
</span><a name="line-1261"></a><span class="hs-comment">--</span><span>
</span><a name="line-1262"></a><span class="hs-comment">-- This function is called in the recompilation checker after we have</span><span>
</span><a name="line-1263"></a><span class="hs-comment">-- determined that the module M being checked hasn't had any changes</span><span>
</span><a name="line-1264"></a><span class="hs-comment">-- to its source file since we last compiled M. So at this point in general</span><span>
</span><a name="line-1265"></a><span class="hs-comment">-- two things may have changed that mean we should recompile M:</span><span>
</span><a name="line-1266"></a><span class="hs-comment">--   * The interface export by a dependency of M has changed.</span><span>
</span><a name="line-1267"></a><span class="hs-comment">--   * The compiler flags specified this time for M have changed</span><span>
</span><a name="line-1268"></a><span class="hs-comment">--     in a manner that is significant for recompilation.</span><span>
</span><a name="line-1269"></a><span class="hs-comment">-- We return not just if we should recompile the object file but also</span><span>
</span><a name="line-1270"></a><span class="hs-comment">-- if we should rebuild the interface file.</span><span>
</span><a name="line-1271"></a><span class="hs-identifier">checkVersions</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-1272"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-1273"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span>       </span><span class="hs-comment">-- Old interface</span><span>
</span><a name="line-1274"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-1275"></a><a name="checkVersions"><a href="MkIface.html#checkVersions"><span class="hs-identifier">checkVersions</span></a></a><span> </span><a name="local-6989586621682533464"><a href="#local-6989586621682533464"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533465"><a href="#local-6989586621682533465"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621682533466"><a href="#local-6989586621682533466"><span class="hs-identifier">iface</span></a></a><span>
</span><a name="line-1276"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Considering whether compilation is required for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1277"></a><span>                        </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-1278"></a><span>
</span><a name="line-1279"></a><span>       </span><span class="hs-comment">-- readIface will have verified that the InstalledUnitId matches,</span><span>
</span><a name="line-1280"></a><span>       </span><span class="hs-comment">-- but we ALSO must make sure the instantiation matches up.  See</span><span>
</span><a name="line-1281"></a><span>       </span><span class="hs-comment">-- test case bkpcabal04!</span><span>
</span><a name="line-1282"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533464"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1283"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-string">&quot;-this-unit-id changed&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1284"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533469"><a href="#local-6989586621682533469"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkFlagHash"><span class="hs-identifier hs-var">checkFlagHash</span></a><span> </span><a href="#local-6989586621682533464"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1285"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533469"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533469"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1286"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533470"><a href="#local-6989586621682533470"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkOptimHash"><span class="hs-identifier hs-var">checkOptimHash</span></a><span> </span><a href="#local-6989586621682533464"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1287"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533470"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533470"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1288"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533471"><a href="#local-6989586621682533471"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkHpcHash"><span class="hs-identifier hs-var">checkHpcHash</span></a><span> </span><a href="#local-6989586621682533464"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1289"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533471"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533471"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1290"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533472"><a href="#local-6989586621682533472"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkMergedSignatures"><span class="hs-identifier hs-var">checkMergedSignatures</span></a><span> </span><a href="#local-6989586621682533465"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1291"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533472"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533472"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1292"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533473"><a href="#local-6989586621682533473"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkHsig"><span class="hs-identifier hs-var">checkHsig</span></a><span> </span><a href="#local-6989586621682533465"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1293"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533473"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533473"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1294"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533474"><a href="#local-6989586621682533474"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkHie"><span class="hs-identifier hs-var">checkHie</span></a><span> </span><a href="#local-6989586621682533465"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-1295"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533474"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533474"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1296"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533475"><a href="#local-6989586621682533475"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkDependencies"><span class="hs-identifier hs-var">checkDependencies</span></a><span> </span><a href="#local-6989586621682533464"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533465"><span class="hs-identifier hs-var">mod_summary</span></a><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1297"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533475"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533475"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1298"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533476"><a href="#local-6989586621682533476"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkPlugins"><span class="hs-identifier hs-var">checkPlugins</span></a><span> </span><a href="#local-6989586621682533464"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1299"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533476"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533476"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1300"></a><span>
</span><a name="line-1301"></a><span>
</span><a name="line-1302"></a><span>       </span><span class="hs-comment">-- Source code unchanged and no errors yet... carry on</span><span>
</span><a name="line-1303"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-1304"></a><span>       </span><span class="hs-comment">-- First put the dependent-module info, read from the old</span><span>
</span><a name="line-1305"></a><span>       </span><span class="hs-comment">-- interface, into the envt, so that when we look for</span><span>
</span><a name="line-1306"></a><span>       </span><span class="hs-comment">-- interfaces we look for the right one (.hi or .hi-boot)</span><span>
</span><a name="line-1307"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-1308"></a><span>       </span><span class="hs-comment">-- It's just temporary because either the usage check will succeed</span><span>
</span><a name="line-1309"></a><span>       </span><span class="hs-comment">-- (in which case we are done with this module) or it'll fail (in which</span><span>
</span><a name="line-1310"></a><span>       </span><span class="hs-comment">-- case we'll compile the module from scratch anyhow).</span><span>
</span><a name="line-1311"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-1312"></a><span>       </span><span class="hs-comment">-- We do this regardless of compilation mode, although in --make mode</span><span>
</span><a name="line-1313"></a><span>       </span><span class="hs-comment">-- all the dependent modules should be in the HPT already, so it's</span><span>
</span><a name="line-1314"></a><span>       </span><span class="hs-comment">-- quite redundant</span><span>
</span><a name="line-1315"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updateEps_"><span class="hs-identifier hs-var">updateEps_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682533477"><a href="#local-6989586621682533477"><span class="hs-identifier">eps</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682533477"><span class="hs-identifier hs-var">eps</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eps_is_boot</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533468"><span class="hs-identifier hs-var">mod_deps</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1316"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682533479"><a href="#local-6989586621682533479"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkList"><span class="hs-identifier hs-var">checkList</span></a><span> </span><span class="hs-special">[</span><a href="MkIface.html#checkModUsage"><span class="hs-identifier hs-var">checkModUsage</span></a><span> </span><a href="#local-6989586621682533467"><span class="hs-identifier hs-var">this_pkg</span></a><span> </span><a href="#local-6989586621682533478"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682533478"><a href="#local-6989586621682533478"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mi_usages</span><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">]</span><span>
</span><a name="line-1317"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533479"><span class="hs-identifier hs-var">recomp</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1318"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1319"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1320"></a><span>    </span><a name="local-6989586621682533467"><a href="#local-6989586621682533467"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533464"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1321"></a><span>    </span><span class="hs-comment">-- This is a bit of a hack really</span><span>
</span><a name="line-1322"></a><span>    </span><span class="hs-identifier">mod_deps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IsBootInterface</span><span class="hs-special">)</span><span>
</span><a name="line-1323"></a><span>    </span><a name="local-6989586621682533468"><a href="#local-6989586621682533468"><span class="hs-identifier">mod_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModDeps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">dep_mods</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682533466"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span class="hs-comment">-- | Check if any plugins are requesting recompilation</span><span>
</span><a name="line-1326"></a><span class="hs-identifier">checkPlugins</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1327"></a><a name="checkPlugins"><a href="MkIface.html#checkPlugins"><span class="hs-identifier">checkPlugins</span></a></a><span> </span><a name="local-6989586621682533480"><a href="#local-6989586621682533480"><span class="hs-identifier">hsc</span></a></a><span> </span><a name="local-6989586621682533481"><a href="#local-6989586621682533481"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1328"></a><span>  </span><a name="local-6989586621682533482"><a href="#local-6989586621682533482"><span class="hs-identifier">new_fingerprint</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#fingerprintPlugins"><span class="hs-identifier hs-var">fingerprintPlugins</span></a><span> </span><a href="#local-6989586621682533480"><span class="hs-identifier hs-var">hsc</span></a><span>
</span><a name="line-1329"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533483"><a href="#local-6989586621682533483"><span class="hs-identifier">old_fingerprint</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_plugin_hash</span><span> </span><a href="#local-6989586621682533481"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1330"></a><span>  </span><a name="local-6989586621682533484"><a href="#local-6989586621682533484"><span class="hs-identifier">pr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">pluginRecompile'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">plugins</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533480"><span class="hs-identifier hs-var">hsc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1331"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1332"></a><span>    </span><a href="MkIface.html#pluginRecompileToRecompileRequired"><span class="hs-identifier hs-var">pluginRecompileToRecompileRequired</span></a><span> </span><a href="#local-6989586621682533483"><span class="hs-identifier hs-var">old_fingerprint</span></a><span> </span><a href="#local-6989586621682533482"><span class="hs-identifier hs-var">new_fingerprint</span></a><span> </span><a href="#local-6989586621682533484"><span class="hs-identifier hs-var">pr</span></a><span>
</span><a name="line-1333"></a><span>
</span><a name="line-1334"></a><span class="hs-identifier">fingerprintPlugins</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-1335"></a><a name="fingerprintPlugins"><a href="MkIface.html#fingerprintPlugins"><span class="hs-identifier">fingerprintPlugins</span></a></a><span> </span><a name="local-6989586621682533485"><a href="#local-6989586621682533485"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1336"></a><span>  </span><a href="MkIface.html#fingerprintPlugins%27"><span class="hs-identifier hs-var">fingerprintPlugins'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">plugins</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533485"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1337"></a><span>
</span><a name="line-1338"></a><span class="hs-identifier">fingerprintPlugins'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">PluginWithArgs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-1339"></a><a name="fingerprintPlugins%27"><a href="MkIface.html#fingerprintPlugins%27"><span class="hs-identifier">fingerprintPlugins'</span></a></a><span> </span><a name="local-6989586621682533486"><a href="#local-6989586621682533486"><span class="hs-identifier">plugins</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1340"></a><span>  </span><a name="local-6989586621682533487"><a href="#local-6989586621682533487"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mconcat</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-identifier hs-var">pluginRecompile'</span><span> </span><a href="#local-6989586621682533486"><span class="hs-identifier hs-var">plugins</span></a><span>
</span><a name="line-1341"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533487"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1342"></a><span>      </span><span class="hs-identifier hs-var">NoForceRecompile</span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-identifier hs-var">fingerprintString</span><span> </span><span class="hs-string">&quot;NoForceRecompile&quot;</span><span>
</span><a name="line-1343"></a><span>      </span><span class="hs-identifier hs-var">ForceRecompile</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fingerprintString</span><span> </span><span class="hs-string">&quot;ForceRecompile&quot;</span><span>
</span><a name="line-1344"></a><span>      </span><span class="hs-comment">-- is the chance of collision worth worrying about?</span><span>
</span><a name="line-1345"></a><span>      </span><span class="hs-comment">-- An alternative is to fingerprintFingerprints [fingerprintString</span><span>
</span><a name="line-1346"></a><span>      </span><span class="hs-comment">-- &quot;maybeRecompile&quot;, fp]</span><span>
</span><a name="line-1347"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MaybeRecompile</span><span> </span><a name="local-6989586621682533488"><a href="#local-6989586621682533488"><span class="hs-identifier">fp</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682533488"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-1348"></a><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span class="hs-identifier">pluginRecompileToRecompileRequired</span><span>
</span><a name="line-1351"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PluginRecompile</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1352"></a><a name="pluginRecompileToRecompileRequired"><a href="MkIface.html#pluginRecompileToRecompileRequired"><span class="hs-identifier">pluginRecompileToRecompileRequired</span></a></a><span> </span><a name="local-6989586621682533489"><a href="#local-6989586621682533489"><span class="hs-identifier">old_fp</span></a></a><span> </span><a name="local-6989586621682533490"><a href="#local-6989586621682533490"><span class="hs-identifier">new_fp</span></a></a><span> </span><a name="local-6989586621682533491"><a href="#local-6989586621682533491"><span class="hs-identifier">pr</span></a></a><span>
</span><a name="line-1353"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533489"><span class="hs-identifier hs-var">old_fp</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533490"><span class="hs-identifier hs-var">new_fp</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1354"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533491"><span class="hs-identifier hs-var">pr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1355"></a><span>      </span><span class="hs-identifier hs-var">NoForceRecompile</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1356"></a><span>
</span><a name="line-1357"></a><span>      </span><span class="hs-comment">-- we already checked the fingerprint above so a mismatch is not possible</span><span>
</span><a name="line-1358"></a><span>      </span><span class="hs-comment">-- here, remember that: `fingerprint (MaybeRecomp x) == x`.</span><span>
</span><a name="line-1359"></a><span>      </span><span class="hs-identifier hs-var">MaybeRecompile</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1360"></a><span>
</span><a name="line-1361"></a><span>      </span><span class="hs-comment">-- when we have an impure plugin in the stack we have to unconditionally</span><span>
</span><a name="line-1362"></a><span>      </span><span class="hs-comment">-- recompile since it might integrate all sorts of crazy IO results into</span><span>
</span><a name="line-1363"></a><span>      </span><span class="hs-comment">-- its compilation output.</span><span>
</span><a name="line-1364"></a><span>      </span><span class="hs-identifier hs-var">ForceRecompile</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-string">&quot;Impure plugin forced recompilation&quot;</span><span>
</span><a name="line-1365"></a><span>
</span><a name="line-1366"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533489"><span class="hs-identifier hs-var">old_fp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682533492"><span class="hs-identifier hs-var">magic_fingerprints</span></a><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-1367"></a><span>    </span><a href="#local-6989586621682533490"><span class="hs-identifier hs-var">new_fp</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682533492"><span class="hs-identifier hs-var">magic_fingerprints</span></a><span>
</span><a name="line-1368"></a><span>    </span><span class="hs-comment">-- The fingerprints do not match either the old or new one is a magic</span><span>
</span><a name="line-1369"></a><span>    </span><span class="hs-comment">-- fingerprint. This happens when non-pure plugins are added for the first</span><span>
</span><a name="line-1370"></a><span>    </span><span class="hs-comment">-- time or when we go from one recompilation strategy to another: (force -&gt;</span><span>
</span><a name="line-1371"></a><span>    </span><span class="hs-comment">-- no-force, maybe-recomp -&gt; no-force, no-force -&gt; maybe-recomp etc.)</span><span>
</span><a name="line-1372"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1373"></a><span>    </span><span class="hs-comment">-- For example when we go from from ForceRecomp to NoForceRecomp</span><span>
</span><a name="line-1374"></a><span>    </span><span class="hs-comment">-- recompilation is triggered since the old impure plugins could have</span><span>
</span><a name="line-1375"></a><span>    </span><span class="hs-comment">-- changed the build output which is now back to normal.</span><span>
</span><a name="line-1376"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-string">&quot;Plugins changed&quot;</span><span>
</span><a name="line-1377"></a><span>
</span><a name="line-1378"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1379"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533493"><a href="#local-6989586621682533493"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Plugin fingerprint changed&quot;</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1380"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533491"><span class="hs-identifier hs-var">pr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1381"></a><span>      </span><span class="hs-comment">-- even though a plugin is forcing recompilation the fingerprint changed</span><span>
</span><a name="line-1382"></a><span>      </span><span class="hs-comment">-- which would cause recompilation anyways so we report the fingerprint</span><span>
</span><a name="line-1383"></a><span>      </span><span class="hs-comment">-- change instead.</span><span>
</span><a name="line-1384"></a><span>      </span><span class="hs-identifier hs-var">ForceRecompile</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><a href="#local-6989586621682533493"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-1385"></a><span>
</span><a name="line-1386"></a><span>      </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><a href="#local-6989586621682533493"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-1387"></a><span>
</span><a name="line-1388"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1389"></a><span>   </span><a name="local-6989586621682533492"><a href="#local-6989586621682533492"><span class="hs-identifier">magic_fingerprints</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1390"></a><span>       </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">fingerprintString</span><span> </span><span class="hs-string">&quot;NoForceRecompile&quot;</span><span>
</span><a name="line-1391"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fingerprintString</span><span> </span><span class="hs-string">&quot;ForceRecompile&quot;</span><span>
</span><a name="line-1392"></a><span>       </span><span class="hs-special">]</span><span>
</span><a name="line-1393"></a><span>
</span><a name="line-1394"></a><span>
</span><a name="line-1395"></a><span class="hs-comment">-- | Check if an hsig file needs recompilation because its</span><span>
</span><a name="line-1396"></a><span class="hs-comment">-- implementing module has changed.</span><span>
</span><a name="line-1397"></a><span class="hs-identifier">checkHsig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1398"></a><a name="checkHsig"><a href="MkIface.html#checkHsig"><span class="hs-identifier">checkHsig</span></a></a><span> </span><a name="local-6989586621682533494"><a href="#local-6989586621682533494"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621682533495"><a href="#local-6989586621682533495"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1399"></a><span>    </span><a name="local-6989586621682533496"><a href="#local-6989586621682533496"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1400"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533497"><a href="#local-6989586621682533497"><span class="hs-identifier">outer_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_mod</span><span> </span><a href="#local-6989586621682533494"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-1401"></a><span>        </span><a name="local-6989586621682533498"><a href="#local-6989586621682533498"><span class="hs-identifier">inner_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">canonicalizeHomeModule</span><span> </span><a href="#local-6989586621682533496"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682533497"><span class="hs-identifier hs-var">outer_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1402"></a><span>    </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><span class="hs-identifier">outer_mod</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">thisPackage</span><span> </span><span class="hs-identifier">dflags</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1403"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533498"><span class="hs-identifier hs-var">inner_mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">mi_semantic_module</span><span> </span><a href="#local-6989586621682533495"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1404"></a><span>        </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;implementing module unchanged&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1405"></a><span>        </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-string">&quot;implementing module changed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1406"></a><span>
</span><a name="line-1407"></a><span class="hs-comment">-- | Check if @.hie@ file is out of date or missing.</span><span>
</span><a name="line-1408"></a><span class="hs-identifier">checkHie</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1409"></a><a name="checkHie"><a href="MkIface.html#checkHie"><span class="hs-identifier">checkHie</span></a></a><span> </span><a name="local-6989586621682533499"><a href="#local-6989586621682533499"><span class="hs-identifier">mod_summary</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1410"></a><span>    </span><a name="local-6989586621682533500"><a href="#local-6989586621682533500"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1411"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533501"><a href="#local-6989586621682533501"><span class="hs-identifier">hie_date_opt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hie_date</span><span> </span><a href="#local-6989586621682533499"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-1412"></a><span>        </span><a name="local-6989586621682533502"><a href="#local-6989586621682533502"><span class="hs-identifier">hs_date</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hs_date</span><span> </span><a href="#local-6989586621682533499"><span class="hs-identifier hs-var">mod_summary</span></a><span>
</span><a name="line-1413"></a><span>    </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WriteHie</span><span> </span><a href="#local-6989586621682533500"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1414"></a><span>               </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1415"></a><span>               </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533501"><span class="hs-identifier hs-var">hie_date_opt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1416"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-string">&quot;HIE file is missing&quot;</span><span>
</span><a name="line-1417"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533503"><a href="#local-6989586621682533503"><span class="hs-identifier">hie_date</span></a></a><span>
</span><a name="line-1418"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533503"><span class="hs-identifier hs-var">hie_date</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621682533502"><span class="hs-identifier hs-var">hs_date</span></a><span>
</span><a name="line-1419"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-string">&quot;HIE file is out of date&quot;</span><span>
</span><a name="line-1420"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1421"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1422"></a><span>
</span><a name="line-1423"></a><span class="hs-comment">-- | Check the flags haven't changed</span><span>
</span><a name="line-1424"></a><span class="hs-identifier">checkFlagHash</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1425"></a><a name="checkFlagHash"><a href="MkIface.html#checkFlagHash"><span class="hs-identifier">checkFlagHash</span></a></a><span> </span><a name="local-6989586621682533504"><a href="#local-6989586621682533504"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533505"><a href="#local-6989586621682533505"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1426"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533506"><a href="#local-6989586621682533506"><span class="hs-identifier">old_hash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_flag_hash</span><span> </span><a href="#local-6989586621682533505"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1427"></a><span>    </span><a name="local-6989586621682533507"><a href="#local-6989586621682533507"><span class="hs-identifier">new_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FlagChecker.html#fingerprintDynFlags"><span class="hs-identifier hs-var">fingerprintDynFlags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533504"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1428"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621682533505"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1429"></a><span>                                             </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-1430"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533506"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533507"><span class="hs-identifier hs-var">new_hash</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1431"></a><span>        </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module flags unchanged&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1432"></a><span>        </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#out_of_date_hash"><span class="hs-identifier hs-var">out_of_date_hash</span></a><span> </span><span class="hs-string">&quot;flags changed&quot;</span><span>
</span><a name="line-1433"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  Module flags have changed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1434"></a><span>                     </span><a href="#local-6989586621682533506"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><a href="#local-6989586621682533507"><span class="hs-identifier hs-var">new_hash</span></a><span>
</span><a name="line-1435"></a><span>
</span><a name="line-1436"></a><span class="hs-comment">-- | Check the optimisation flags haven't changed</span><span>
</span><a name="line-1437"></a><span class="hs-identifier">checkOptimHash</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1438"></a><a name="checkOptimHash"><a href="MkIface.html#checkOptimHash"><span class="hs-identifier">checkOptimHash</span></a></a><span> </span><a name="local-6989586621682533508"><a href="#local-6989586621682533508"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533509"><a href="#local-6989586621682533509"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1439"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533510"><a href="#local-6989586621682533510"><span class="hs-identifier">old_hash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_opt_hash</span><span> </span><a href="#local-6989586621682533509"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1440"></a><span>    </span><a name="local-6989586621682533511"><a href="#local-6989586621682533511"><span class="hs-identifier">new_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FlagChecker.html#fingerprintOptFlags"><span class="hs-identifier hs-var">fingerprintOptFlags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533508"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1441"></a><span>                                               </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-1442"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533510"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533511"><span class="hs-identifier hs-var">new_hash</span></a><span>
</span><a name="line-1443"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Optimisation flags unchanged&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1444"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_IgnoreOptimChanges</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533508"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1445"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Optimisation flags changed; ignoring&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1446"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1447"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#out_of_date_hash"><span class="hs-identifier hs-var">out_of_date_hash</span></a><span> </span><span class="hs-string">&quot;Optimisation flags changed&quot;</span><span>
</span><a name="line-1448"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  Optimisation flags have changed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1449"></a><span>                     </span><a href="#local-6989586621682533510"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><a href="#local-6989586621682533511"><span class="hs-identifier hs-var">new_hash</span></a><span>
</span><a name="line-1450"></a><span>
</span><a name="line-1451"></a><span class="hs-comment">-- | Check the HPC flags haven't changed</span><span>
</span><a name="line-1452"></a><span class="hs-identifier">checkHpcHash</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1453"></a><a name="checkHpcHash"><a href="MkIface.html#checkHpcHash"><span class="hs-identifier">checkHpcHash</span></a></a><span> </span><a name="local-6989586621682533512"><a href="#local-6989586621682533512"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533513"><a href="#local-6989586621682533513"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1454"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533514"><a href="#local-6989586621682533514"><span class="hs-identifier">old_hash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_hpc_hash</span><span> </span><a href="#local-6989586621682533513"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1455"></a><span>    </span><a name="local-6989586621682533515"><a href="#local-6989586621682533515"><span class="hs-identifier">new_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FlagChecker.html#fingerprintHpcFlags"><span class="hs-identifier hs-var">fingerprintHpcFlags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533512"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1456"></a><span>                                               </span><span class="hs-identifier hs-var">putNameLiterally</span><span>
</span><a name="line-1457"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533514"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533515"><span class="hs-identifier hs-var">new_hash</span></a><span>
</span><a name="line-1458"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;HPC flags unchanged&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1459"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_IgnoreHpcChanges</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533512"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1460"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;HPC flags changed; ignoring&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1461"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1462"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#out_of_date_hash"><span class="hs-identifier hs-var">out_of_date_hash</span></a><span> </span><span class="hs-string">&quot;HPC flags changed&quot;</span><span>
</span><a name="line-1463"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  HPC flags have changed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1464"></a><span>                     </span><a href="#local-6989586621682533514"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><a href="#local-6989586621682533515"><span class="hs-identifier hs-var">new_hash</span></a><span>
</span><a name="line-1465"></a><span>
</span><a name="line-1466"></a><span class="hs-comment">-- Check that the set of signatures we are merging in match.</span><span>
</span><a name="line-1467"></a><span class="hs-comment">-- If the -unit-id flags change, this can change too.</span><span>
</span><a name="line-1468"></a><span class="hs-identifier">checkMergedSignatures</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1469"></a><a name="checkMergedSignatures"><a href="MkIface.html#checkMergedSignatures"><span class="hs-identifier">checkMergedSignatures</span></a></a><span> </span><a name="local-6989586621682533516"><a href="#local-6989586621682533516"><span class="hs-identifier">mod_summary</span></a></a><span> </span><a name="local-6989586621682533517"><a href="#local-6989586621682533517"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1470"></a><span>    </span><a name="local-6989586621682533518"><a href="#local-6989586621682533518"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1471"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533519"><a href="#local-6989586621682533519"><span class="hs-identifier">old_merged</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621682533521"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">UsageMergedRequirement</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533521"><a href="#local-6989586621682533521"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mi_usages</span><span> </span><a href="#local-6989586621682533517"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1472"></a><span>        </span><a name="local-6989586621682533520"><a href="#local-6989586621682533520"><span class="hs-identifier">new_merged</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_mod_name</span><span> </span><a href="#local-6989586621682533516"><span class="hs-identifier hs-var">mod_summary</span></a><span class="hs-special">)</span><span>
</span><a name="line-1473"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier">requirementContext</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621682533518"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1474"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1475"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533522"><a href="#local-6989586621682533522"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">indefModuleToModule</span><span> </span><a href="#local-6989586621682533518"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533522"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1476"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682533519"><span class="hs-identifier hs-var">old_merged</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533520"><span class="hs-identifier hs-var">new_merged</span></a><span>
</span><a name="line-1477"></a><span>        </span><span class="hs-keyword">then</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;signatures to merge in unchanged&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533520"><span class="hs-identifier hs-var">new_merged</span></a><span class="hs-special">)</span><span>
</span><a name="line-1478"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-string">&quot;signatures to merge in changed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1479"></a><span>
</span><a name="line-1480"></a><span class="hs-comment">-- If the direct imports of this module are resolved to targets that</span><span>
</span><a name="line-1481"></a><span class="hs-comment">-- are not among the dependencies of the previous interface file,</span><span>
</span><a name="line-1482"></a><span class="hs-comment">-- then we definitely need to recompile.  This catches cases like</span><span>
</span><a name="line-1483"></a><span class="hs-comment">--   - an exposed package has been upgraded</span><span>
</span><a name="line-1484"></a><span class="hs-comment">--   - we are compiling with different package flags</span><span>
</span><a name="line-1485"></a><span class="hs-comment">--   - a home module that was shadowing a package module has been removed</span><span>
</span><a name="line-1486"></a><span class="hs-comment">--   - a new home module has been added that shadows a package module</span><span>
</span><a name="line-1487"></a><span class="hs-comment">-- See bug #1372.</span><span>
</span><a name="line-1488"></a><span class="hs-comment">--</span><span>
</span><a name="line-1489"></a><span class="hs-comment">-- Returns (RecompBecause &lt;textual reason&gt;) if recompilation is required.</span><span>
</span><a name="line-1490"></a><span class="hs-identifier">checkDependencies</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1491"></a><a name="checkDependencies"><a href="MkIface.html#checkDependencies"><span class="hs-identifier">checkDependencies</span></a></a><span> </span><a name="local-6989586621682533523"><a href="#local-6989586621682533523"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621682533524"><a href="#local-6989586621682533524"><span class="hs-identifier">summary</span></a></a><span> </span><a name="local-6989586621682533525"><a href="#local-6989586621682533525"><span class="hs-identifier">iface</span></a></a><span>
</span><a name="line-1492"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#checkList"><span class="hs-identifier hs-var">checkList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533530"><span class="hs-identifier hs-var">dep_missing</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ms_imps</span><span> </span><a href="#local-6989586621682533524"><span class="hs-identifier hs-var">summary</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">ms_srcimps</span><span> </span><a href="#local-6989586621682533524"><span class="hs-identifier hs-var">summary</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1493"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1494"></a><span>   </span><a name="local-6989586621682533526"><a href="#local-6989586621682533526"><span class="hs-identifier">prev_dep_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dep_mods</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682533525"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1495"></a><span>   </span><a name="local-6989586621682533527"><a href="#local-6989586621682533527"><span class="hs-identifier">prev_dep_plgn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dep_plgins</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682533525"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1496"></a><span>   </span><a name="local-6989586621682533528"><a href="#local-6989586621682533528"><span class="hs-identifier">prev_dep_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dep_pkgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621682533525"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1497"></a><span>
</span><a name="line-1498"></a><span>   </span><a name="local-6989586621682533529"><a href="#local-6989586621682533529"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621682533523"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1499"></a><span>
</span><a name="line-1500"></a><span>   </span><a name="local-6989586621682533530"><a href="#local-6989586621682533530"><span class="hs-identifier">dep_missing</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533531"><a href="#local-6989586621682533531"><span class="hs-identifier">mb_pkg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682533532"><a href="#local-6989586621682533532"><span class="hs-identifier">mod</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1501"></a><span>     </span><a name="local-6989586621682533533"><a href="#local-6989586621682533533"><span class="hs-identifier">find_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Finder.html#findImportedModule"><span class="hs-identifier hs-var">findImportedModule</span></a><span> </span><a href="#local-6989586621682533523"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621682533532"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533531"><span class="hs-identifier hs-var">mb_pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1502"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533534"><a href="#local-6989586621682533534"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><a href="#local-6989586621682533532"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; changed&quot;</span><span>
</span><a name="line-1503"></a><span>     </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533533"><span class="hs-identifier hs-var">find_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1504"></a><span>        </span><span class="hs-identifier hs-var">Found</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682533535"><a href="#local-6989586621682533535"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-1505"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533536"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533529"><span class="hs-identifier hs-var">this_pkg</span></a><span>
</span><a name="line-1506"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682533535"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682533526"><span class="hs-identifier hs-var">prev_dep_mods</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682533527"><span class="hs-identifier hs-var">prev_dep_plgn</span></a><span>
</span><a name="line-1507"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1508"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;imported module &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533535"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-1509"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; not among previous dependencies&quot;</span><span>
</span><a name="line-1510"></a><span>                         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><a href="#local-6989586621682533534"><span class="hs-identifier hs-var">reason</span></a><span class="hs-special">)</span><span>
</span><a name="line-1511"></a><span>                 </span><span class="hs-keyword">else</span><span>
</span><a name="line-1512"></a><span>                         </span><span class="hs-identifier hs-var">return</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1513"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1514"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">toInstalledUnitId</span><span> </span><a href="#local-6989586621682533536"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682533528"><span class="hs-identifier hs-var">prev_dep_pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1516"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;imported module &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533535"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-1517"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; is from package &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533536"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-1518"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, which is not among previous dependencies&quot;</span><span>
</span><a name="line-1519"></a><span>                         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><a href="#local-6989586621682533534"><span class="hs-identifier hs-var">reason</span></a><span class="hs-special">)</span><span>
</span><a name="line-1520"></a><span>                 </span><span class="hs-keyword">else</span><span>
</span><a name="line-1521"></a><span>                         </span><span class="hs-identifier hs-var">return</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1522"></a><span>           </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682533536"><a href="#local-6989586621682533536"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621682533535"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-1523"></a><span>        </span><a name="local-6989586621682533537"><a href="#local-6989586621682533537"><span class="hs-identifier">_otherwise</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><a href="#local-6989586621682533534"><span class="hs-identifier hs-var">reason</span></a><span class="hs-special">)</span><span>
</span><a name="line-1524"></a><span>
</span><a name="line-1525"></a><span class="hs-identifier">needInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModIface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span class="hs-special">)</span><span>
</span><a name="line-1526"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1527"></a><a name="needInterface"><a href="MkIface.html#needInterface"><span class="hs-identifier">needInterface</span></a></a><span> </span><a name="local-6989586621682533538"><a href="#local-6989586621682533538"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621682533539"><a href="#local-6989586621682533539"><span class="hs-identifier">continue</span></a></a><span>
</span><a name="line-1528"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-comment">-- Load the imported interface if possible</span><span>
</span><a name="line-1529"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533540"><a href="#local-6989586621682533540"><span class="hs-identifier">doc_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;need version info for&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533538"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">]</span><span>
</span><a name="line-1530"></a><span>    </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Checking usages for module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533538"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1531"></a><span>
</span><a name="line-1532"></a><span>    </span><a name="local-6989586621682533541"><a href="#local-6989586621682533541"><span class="hs-identifier">mb_iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadInterface"><span class="hs-identifier hs-var">loadInterface</span></a><span> </span><a href="#local-6989586621682533540"><span class="hs-identifier hs-var">doc_str</span></a><span> </span><a href="#local-6989586621682533538"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-identifier hs-var">ImportBySystem</span><span>
</span><a name="line-1533"></a><span>        </span><span class="hs-comment">-- Load the interface, but don't complain on failure;</span><span>
</span><a name="line-1534"></a><span>        </span><span class="hs-comment">-- Instead, get an Either back which we can test</span><span>
</span><a name="line-1535"></a><span>
</span><a name="line-1536"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533541"><span class="hs-identifier hs-var">mb_iface</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1537"></a><span>      </span><span class="hs-identifier hs-var">Failed</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1538"></a><span>        </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Couldn't load interface for module&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1539"></a><span>                           </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533538"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1540"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="MkIface.html#MustCompile"><span class="hs-identifier hs-var">MustCompile</span></a><span>
</span><a name="line-1541"></a><span>                  </span><span class="hs-comment">-- Couldn't find or parse a module mentioned in the</span><span>
</span><a name="line-1542"></a><span>                  </span><span class="hs-comment">-- old interface file.  Don't complain: it might</span><span>
</span><a name="line-1543"></a><span>                  </span><span class="hs-comment">-- just be that the current module doesn't need that</span><span>
</span><a name="line-1544"></a><span>                  </span><span class="hs-comment">-- import and it's been deleted</span><span>
</span><a name="line-1545"></a><span>      </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621682533542"><a href="#local-6989586621682533542"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682533539"><span class="hs-identifier hs-var">continue</span></a><span> </span><a href="#local-6989586621682533542"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1546"></a><span>
</span><a name="line-1547"></a><span class="hs-comment">-- | Given the usage information extracted from the old</span><span>
</span><a name="line-1548"></a><span class="hs-comment">-- M.hi file for the module being compiled, figure out</span><span>
</span><a name="line-1549"></a><span class="hs-comment">-- whether M needs to be recompiled.</span><span>
</span><a name="line-1550"></a><span class="hs-identifier">checkModUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UnitId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Usage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1551"></a><a name="checkModUsage"><a href="MkIface.html#checkModUsage"><span class="hs-identifier">checkModUsage</span></a></a><span> </span><a name="local-6989586621682533543"><a href="#local-6989586621682533543"><span class="hs-identifier">_this_pkg</span></a></a><span> </span><span class="hs-identifier hs-var">UsagePackageModule</span><span class="hs-special">{</span><span>
</span><a name="line-1552"></a><span>                                </span><span class="hs-identifier">usg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533544"><a href="#local-6989586621682533544"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1553"></a><span>                                </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533545"><a href="#local-6989586621682533545"><span class="hs-identifier">old_mod_hash</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1554"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#needInterface"><span class="hs-identifier hs-var">needInterface</span></a><span> </span><a href="#local-6989586621682533544"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682533546"><a href="#local-6989586621682533546"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1555"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533547"><a href="#local-6989586621682533547"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682533544"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; changed&quot;</span><span>
</span><a name="line-1556"></a><span>    </span><a href="MkIface.html#checkModuleFingerprint"><span class="hs-identifier hs-var">checkModuleFingerprint</span></a><span> </span><a href="#local-6989586621682533547"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621682533545"><span class="hs-identifier hs-var">old_mod_hash</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_mod_hash</span><span> </span><a href="#local-6989586621682533546"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1557"></a><span>        </span><span class="hs-comment">-- We only track the ABI hash of package modules, rather than</span><span>
</span><a name="line-1558"></a><span>        </span><span class="hs-comment">-- individual entity usages, so if the ABI hash changes we must</span><span>
</span><a name="line-1559"></a><span>        </span><span class="hs-comment">-- recompile.  This is safe but may entail more recompilation when</span><span>
</span><a name="line-1560"></a><span>        </span><span class="hs-comment">-- a dependent package has changed.</span><span>
</span><a name="line-1561"></a><span>
</span><a name="line-1562"></a><span class="hs-identifier">checkModUsage</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">UsageMergedRequirement</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_mod</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533548"><a href="#local-6989586621682533548"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533549"><a href="#local-6989586621682533549"><span class="hs-identifier">old_mod_hash</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1563"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#needInterface"><span class="hs-identifier hs-var">needInterface</span></a><span> </span><a href="#local-6989586621682533548"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682533550"><a href="#local-6989586621682533550"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1564"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533551"><a href="#local-6989586621682533551"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621682533548"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; changed (raw)&quot;</span><span>
</span><a name="line-1565"></a><span>    </span><a href="MkIface.html#checkModuleFingerprint"><span class="hs-identifier hs-var">checkModuleFingerprint</span></a><span> </span><a href="#local-6989586621682533551"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621682533549"><span class="hs-identifier hs-var">old_mod_hash</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_mod_hash</span><span> </span><a href="#local-6989586621682533550"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span>
</span><a name="line-1566"></a><span>
</span><a name="line-1567"></a><span class="hs-identifier">checkModUsage</span><span> </span><a name="local-6989586621682533552"><a href="#local-6989586621682533552"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-identifier hs-var">UsageHomeModule</span><span class="hs-special">{</span><span>
</span><a name="line-1568"></a><span>                                </span><span class="hs-identifier">usg_mod_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533553"><a href="#local-6989586621682533553"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1569"></a><span>                                </span><span class="hs-identifier">usg_mod_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533554"><a href="#local-6989586621682533554"><span class="hs-identifier">old_mod_hash</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1570"></a><span>                                </span><span class="hs-identifier">usg_exports</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533555"><a href="#local-6989586621682533555"><span class="hs-identifier">maybe_old_export_hash</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1571"></a><span>                                </span><span class="hs-identifier">usg_entities</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533556"><a href="#local-6989586621682533556"><span class="hs-identifier">old_decl_hash</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1572"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1573"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682533557"><a href="#local-6989586621682533557"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkModule</span><span> </span><a href="#local-6989586621682533552"><span class="hs-identifier hs-var">this_pkg</span></a><span> </span><a href="#local-6989586621682533553"><span class="hs-identifier hs-var">mod_name</span></a><span>
</span><a name="line-1574"></a><span>    </span><a href="MkIface.html#needInterface"><span class="hs-identifier hs-var">needInterface</span></a><span> </span><a href="#local-6989586621682533557"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682533558"><a href="#local-6989586621682533558"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1575"></a><span>
</span><a name="line-1576"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1577"></a><span>        </span><a name="local-6989586621682533559"><a href="#local-6989586621682533559"><span class="hs-identifier">new_mod_hash</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_mod_hash</span><span>    </span><a href="#local-6989586621682533558"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1578"></a><span>        </span><a name="local-6989586621682533560"><a href="#local-6989586621682533560"><span class="hs-identifier">new_decl_hash</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_hash_fn</span><span>     </span><a href="#local-6989586621682533558"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1579"></a><span>        </span><a name="local-6989586621682533561"><a href="#local-6989586621682533561"><span class="hs-identifier">new_export_hash</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mi_exp_hash</span><span>    </span><a href="#local-6989586621682533558"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1580"></a><span>
</span><a name="line-1581"></a><span>        </span><a name="local-6989586621682533562"><a href="#local-6989586621682533562"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleNameString</span><span> </span><a href="#local-6989586621682533553"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; changed&quot;</span><span>
</span><a name="line-1582"></a><span>
</span><a name="line-1583"></a><span>        </span><span class="hs-comment">-- CHECK MODULE</span><span>
</span><a name="line-1584"></a><span>    </span><a name="local-6989586621682533563"><a href="#local-6989586621682533563"><span class="hs-identifier">recompile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkModuleFingerprint"><span class="hs-identifier hs-var">checkModuleFingerprint</span></a><span> </span><a href="#local-6989586621682533562"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621682533554"><span class="hs-identifier hs-var">old_mod_hash</span></a><span> </span><a href="#local-6989586621682533559"><span class="hs-identifier hs-var">new_mod_hash</span></a><span>
</span><a name="line-1585"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533563"><span class="hs-identifier hs-var">recompile</span></a><span class="hs-special">)</span><span>
</span><a name="line-1586"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1587"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1588"></a><span>
</span><a name="line-1589"></a><span>        </span><span class="hs-comment">-- CHECK EXPORT LIST</span><span>
</span><a name="line-1590"></a><span>        </span><a href="MkIface.html#checkMaybeHash"><span class="hs-identifier hs-var">checkMaybeHash</span></a><span> </span><a href="#local-6989586621682533562"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621682533555"><span class="hs-identifier hs-var">maybe_old_export_hash</span></a><span> </span><a href="#local-6989586621682533561"><span class="hs-identifier hs-var">new_export_hash</span></a><span>
</span><a name="line-1591"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  Export list changed&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1592"></a><span>
</span><a name="line-1593"></a><span>        </span><span class="hs-comment">-- CHECK ITEMS ONE BY ONE</span><span>
</span><a name="line-1594"></a><span>        </span><a name="local-6989586621682533565"><a href="#local-6989586621682533565"><span class="hs-identifier">recompile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MkIface.html#checkList"><span class="hs-identifier hs-var">checkList</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="MkIface.html#checkEntityUsage"><span class="hs-identifier hs-var">checkEntityUsage</span></a><span> </span><a href="#local-6989586621682533562"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621682533560"><span class="hs-identifier hs-var">new_decl_hash</span></a><span> </span><a href="#local-6989586621682533564"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-1595"></a><span>                               </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682533564"><a href="#local-6989586621682533564"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533556"><span class="hs-identifier hs-var">old_decl_hash</span></a><span class="hs-special">]</span><span>
</span><a name="line-1596"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533565"><span class="hs-identifier hs-var">recompile</span></a><span>
</span><a name="line-1597"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682533565"><span class="hs-identifier hs-var">recompile</span></a><span>     </span><span class="hs-comment">-- This one failed, so just bail out now</span><span>
</span><a name="line-1598"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  Great!  The bits I use are up to date&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1599"></a><span>
</span><a name="line-1600"></a><span>
</span><a name="line-1601"></a><span class="hs-identifier">checkModUsage</span><span> </span><a name="local-6989586621682533566"><a href="#local-6989586621682533566"><span class="hs-identifier">_this_pkg</span></a></a><span> </span><span class="hs-identifier hs-var">UsageFile</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">usg_file_path</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533567"><a href="#local-6989586621682533567"><span class="hs-identifier">file</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1602"></a><span>                                   </span><span class="hs-identifier">usg_file_hash</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533568"><a href="#local-6989586621682533568"><span class="hs-identifier">old_hash</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1603"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1604"></a><span>    </span><span class="hs-identifier hs-var">handleIO</span><span> </span><a href="#local-6989586621682533570"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1605"></a><span>      </span><a name="local-6989586621682533571"><a href="#local-6989586621682533571"><span class="hs-identifier">new_hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getFileHash</span><span> </span><a href="#local-6989586621682533567"><span class="hs-identifier hs-var">file</span></a><span>
</span><a name="line-1606"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533568"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621682533571"><span class="hs-identifier hs-var">new_hash</span></a><span class="hs-special">)</span><span>
</span><a name="line-1607"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682533569"><span class="hs-identifier hs-var">recomp</span></a><span>
</span><a name="line-1608"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1609"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1610"></a><span>   </span><a name="local-6989586621682533569"><a href="#local-6989586621682533569"><span class="hs-identifier">recomp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533567"><span class="hs-identifier hs-var">file</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; changed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1611"></a><span>   </span><a name="local-6989586621682533570"><a href="#local-6989586621682533570"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1612"></a><span class="hs-cpp">#if defined(DEBUG)
</span><span>       </span><span class="hs-glyph">\</span><span class="hs-identifier">e</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pprTrace</span><span> </span><span class="hs-string">&quot;UsageFile&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">e</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">recomp</span><span>
</span><a name="line-1614"></a><span class="hs-cpp">#else
</span><span>       </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682533569"><span class="hs-identifier hs-var">recomp</span></a><span> </span><span class="hs-comment">-- if we can't find the file, just recompile, don't fail</span><span>
</span><a name="line-1616"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-1618"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1619"></a><span class="hs-identifier">checkModuleFingerprint</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span>
</span><a name="line-1620"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1621"></a><a name="checkModuleFingerprint"><a href="MkIface.html#checkModuleFingerprint"><span class="hs-identifier">checkModuleFingerprint</span></a></a><span> </span><a name="local-6989586621682533572"><a href="#local-6989586621682533572"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621682533573"><a href="#local-6989586621682533573"><span class="hs-identifier">old_mod_hash</span></a></a><span> </span><a name="local-6989586621682533574"><a href="#local-6989586621682533574"><span class="hs-identifier">new_mod_hash</span></a></a><span>
</span><a name="line-1622"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533574"><span class="hs-identifier hs-var">new_mod_hash</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533573"><span class="hs-identifier hs-var">old_mod_hash</span></a><span>
</span><a name="line-1623"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#up_to_date"><span class="hs-identifier hs-var">up_to_date</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module fingerprint unchanged&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1624"></a><span>
</span><a name="line-1625"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1626"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#out_of_date_hash"><span class="hs-identifier hs-var">out_of_date_hash</span></a><span> </span><a href="#local-6989586621682533572"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  Module fingerprint has changed&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1627"></a><span>                     </span><a href="#local-6989586621682533573"><span class="hs-identifier hs-var">old_mod_hash</span></a><span> </span><a href="#local-6989586621682533574"><span class="hs-identifier hs-var">new_mod_hash</span></a><span>
</span><a name="line-1628"></a><span>
</span><a name="line-1629"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1630"></a><span class="hs-identifier">checkMaybeHash</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1631"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1632"></a><a name="checkMaybeHash"><a href="MkIface.html#checkMaybeHash"><span class="hs-identifier">checkMaybeHash</span></a></a><span> </span><a name="local-6989586621682533575"><a href="#local-6989586621682533575"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621682533576"><a href="#local-6989586621682533576"><span class="hs-identifier">maybe_old_hash</span></a></a><span> </span><a name="local-6989586621682533577"><a href="#local-6989586621682533577"><span class="hs-identifier">new_hash</span></a></a><span> </span><a name="local-6989586621682533578"><a href="#local-6989586621682533578"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621682533579"><a href="#local-6989586621682533579"><span class="hs-identifier">continue</span></a></a><span>
</span><a name="line-1633"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533580"><a href="#local-6989586621682533580"><span class="hs-identifier">hash</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533576"><span class="hs-identifier hs-var">maybe_old_hash</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533580"><span class="hs-identifier hs-var">hash</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621682533577"><span class="hs-identifier hs-var">new_hash</span></a><span>
</span><a name="line-1634"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#out_of_date_hash"><span class="hs-identifier hs-var">out_of_date_hash</span></a><span> </span><a href="#local-6989586621682533575"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621682533578"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621682533580"><span class="hs-identifier hs-var">hash</span></a><span> </span><a href="#local-6989586621682533577"><span class="hs-identifier hs-var">new_hash</span></a><span>
</span><a name="line-1635"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1636"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533579"><span class="hs-identifier hs-var">continue</span></a><span>
</span><a name="line-1637"></a><span>
</span><a name="line-1638"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-1639"></a><span class="hs-identifier">checkEntityUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1640"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1641"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span class="hs-special">)</span><span>
</span><a name="line-1642"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1643"></a><a name="checkEntityUsage"><a href="MkIface.html#checkEntityUsage"><span class="hs-identifier">checkEntityUsage</span></a></a><span> </span><a name="local-6989586621682533581"><a href="#local-6989586621682533581"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621682533582"><a href="#local-6989586621682533582"><span class="hs-identifier">new_hash</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533583"><a href="#local-6989586621682533583"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><a name="local-6989586621682533584"><a href="#local-6989586621682533584"><span class="hs-identifier">old_hash</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1644"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533582"><span class="hs-identifier hs-var">new_hash</span></a><span> </span><a href="#local-6989586621682533583"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1645"></a><span>
</span><a name="line-1646"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span>        </span><span class="hs-comment">-- We used it before, but it ain't there now</span><span>
</span><a name="line-1647"></a><span>                          </span><a href="MkIface.html#out_of_date"><span class="hs-identifier hs-var">out_of_date</span></a><span> </span><a href="#local-6989586621682533581"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;No longer exported:&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533583"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1648"></a><span>
</span><a name="line-1649"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682533585"><a href="#local-6989586621682533585"><span class="hs-identifier">new_hash</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- It's there, but is it up to date?</span><span>
</span><a name="line-1650"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533585"><span class="hs-identifier hs-var">new_hash</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682533584"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  Up to date&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533583"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">parens</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533585"><span class="hs-identifier hs-var">new_hash</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1651"></a><span>                                       </span><span class="hs-identifier hs-var">return</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1652"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#out_of_date_hash"><span class="hs-identifier hs-var">out_of_date_hash</span></a><span> </span><a href="#local-6989586621682533581"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  Out of date:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533583"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1653"></a><span>                                                     </span><a href="#local-6989586621682533584"><span class="hs-identifier hs-var">old_hash</span></a><span> </span><a href="#local-6989586621682533585"><span class="hs-identifier hs-var">new_hash</span></a><span>
</span><a name="line-1654"></a><span>
</span><a name="line-1655"></a><span class="hs-identifier">up_to_date</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1656"></a><a name="up_to_date"><a href="MkIface.html#up_to_date"><span class="hs-identifier">up_to_date</span></a></a><span>  </span><a name="local-6989586621682533586"><a href="#local-6989586621682533586"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><a href="#local-6989586621682533586"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1657"></a><span>
</span><a name="line-1658"></a><span class="hs-identifier">out_of_date</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1659"></a><a name="out_of_date"><a href="MkIface.html#out_of_date"><span class="hs-identifier">out_of_date</span></a></a><span> </span><a name="local-6989586621682533587"><a href="#local-6989586621682533587"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621682533588"><a href="#local-6989586621682533588"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span> </span><a href="#local-6989586621682533588"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#RecompBecause"><span class="hs-identifier hs-var">RecompBecause</span></a><span> </span><a href="#local-6989586621682533587"><span class="hs-identifier hs-var">reason</span></a><span class="hs-special">)</span><span>
</span><a name="line-1660"></a><span>
</span><a name="line-1661"></a><span class="hs-identifier">out_of_date_hash</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fingerprint</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1662"></a><a name="out_of_date_hash"><a href="MkIface.html#out_of_date_hash"><span class="hs-identifier">out_of_date_hash</span></a></a><span> </span><a name="local-6989586621682533589"><a href="#local-6989586621682533589"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621682533590"><a href="#local-6989586621682533590"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621682533591"><a href="#local-6989586621682533591"><span class="hs-identifier">old_hash</span></a></a><span> </span><a name="local-6989586621682533592"><a href="#local-6989586621682533592"><span class="hs-identifier">new_hash</span></a></a><span>
</span><a name="line-1663"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#out_of_date"><span class="hs-identifier hs-var">out_of_date</span></a><span> </span><a href="#local-6989586621682533589"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682533590"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533591"><span class="hs-identifier hs-var">old_hash</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;-&gt;&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533592"><span class="hs-identifier hs-var">new_hash</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1664"></a><span>
</span><a name="line-1665"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-1666"></a><span class="hs-identifier">checkList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="MkIface.html#RecompileRequired"><span class="hs-identifier hs-type">RecompileRequired</span></a><span>
</span><a name="line-1667"></a><span class="hs-comment">-- This helper is used in two places</span><span>
</span><a name="line-1668"></a><a name="checkList"><a href="MkIface.html#checkList"><span class="hs-identifier">checkList</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="MkIface.html#UpToDate"><span class="hs-identifier hs-var">UpToDate</span></a><span>
</span><a name="line-1669"></a><span class="hs-identifier">checkList</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682533593"><a href="#local-6989586621682533593"><span class="hs-identifier">check</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682533594"><a href="#local-6989586621682533594"><span class="hs-identifier">checks</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682533595"><a href="#local-6989586621682533595"><span class="hs-identifier">recompile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682533593"><span class="hs-identifier hs-var">check</span></a><span>
</span><a name="line-1670"></a><span>                              </span><span class="hs-keyword">if</span><span> </span><a href="MkIface.html#recompileRequired"><span class="hs-identifier hs-var">recompileRequired</span></a><span> </span><a href="#local-6989586621682533595"><span class="hs-identifier hs-var">recompile</span></a><span>
</span><a name="line-1671"></a><span>                                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682533595"><span class="hs-identifier hs-var">recompile</span></a><span>
</span><a name="line-1672"></a><span>                                </span><span class="hs-keyword">else</span><span> </span><a href="MkIface.html#checkList"><span class="hs-identifier hs-var">checkList</span></a><span> </span><a href="#local-6989586621682533594"><span class="hs-identifier hs-var">checks</span></a><span>
</span><a name="line-1673"></a><span>
</span><a name="line-1674"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Converting things to their Iface equivalents
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1681"></a><span>
</span><a name="line-1682"></a><span class="hs-identifier">tyThingToIfaceDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span>
</span><a name="line-1683"></a><a name="tyThingToIfaceDecl"><a href="MkIface.html#tyThingToIfaceDecl"><span class="hs-identifier">tyThingToIfaceDecl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621682533596"><a href="#local-6989586621682533596"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#idToIfaceDecl"><span class="hs-identifier hs-var">idToIfaceDecl</span></a><span> </span><a href="#local-6989586621682533596"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1684"></a><span class="hs-identifier">tyThingToIfaceDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621682533597"><a href="#local-6989586621682533597"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#tyConToIfaceDecl"><span class="hs-identifier hs-var">tyConToIfaceDecl</span></a><span> </span><span class="hs-identifier hs-var">emptyTidyEnv</span><span> </span><a href="#local-6989586621682533597"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-1685"></a><span class="hs-identifier">tyThingToIfaceDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ACoAxiom</span><span> </span><a name="local-6989586621682533598"><a href="#local-6989586621682533598"><span class="hs-identifier">ax</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#coAxiomToIfaceDecl"><span class="hs-identifier hs-var">coAxiomToIfaceDecl</span></a><span> </span><a href="#local-6989586621682533598"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-1686"></a><span class="hs-identifier">tyThingToIfaceDecl</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><a name="local-6989586621682533599"><a href="#local-6989586621682533599"><span class="hs-identifier">cl</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682533599"><span class="hs-identifier hs-var">cl</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1687"></a><span>    </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621682533600"><a href="#local-6989586621682533600"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkIface.html#dataConToIfaceDecl"><span class="hs-identifier hs-var">dataConToIfaceDecl</span></a><span> </span><a href="#local-6989586621682533600"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-comment">-- for ppr purposes only</span><span>
</span><a name="line-1688"></a><span>    </span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621682533601"><a href="#local-6989586621682533601"><span class="hs-identifier">ps</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">patSynToIfaceDecl</span><span> </span><a href="#local-6989586621682533601"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-1689"></a><span>
</span><a name="line-1690"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-1691"></a><span class="hs-identifier">idToIfaceDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span>
</span><a name="line-1692"></a><span class="hs-comment">-- The Id is already tidied, so that locally-bound names</span><span>
</span><a name="line-1693"></a><span class="hs-comment">-- (lambdas, for-alls) already have non-clashing OccNames</span><span>
</span><a name="line-1694"></a><span class="hs-comment">-- We can't tidy it here, locally, because it may have</span><span>
</span><a name="line-1695"></a><span class="hs-comment">-- free variables in its type or IdInfo</span><span>
</span><a name="line-1696"></a><a name="idToIfaceDecl"><a href="MkIface.html#idToIfaceDecl"><span class="hs-identifier">idToIfaceDecl</span></a></a><span> </span><a name="local-6989586621682533602"><a href="#local-6989586621682533602"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1697"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533602"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span>
</span><a name="line-1698"></a><span>              </span><span class="hs-identifier">ifType</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682533602"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1699"></a><span>              </span><span class="hs-identifier">ifIdDetails</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceIdDetails</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idDetails</span><span> </span><a href="#local-6989586621682533602"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1700"></a><span>              </span><span class="hs-identifier">ifIdInfo</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceIdInfo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idInfo</span><span> </span><a href="#local-6989586621682533602"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1701"></a><span>
</span><a name="line-1702"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-1703"></a><span class="hs-identifier">dataConToIfaceDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span>
</span><a name="line-1704"></a><a name="dataConToIfaceDecl"><a href="MkIface.html#dataConToIfaceDecl"><span class="hs-identifier">dataConToIfaceDecl</span></a></a><span> </span><a name="local-6989586621682533603"><a href="#local-6989586621682533603"><span class="hs-identifier">dataCon</span></a></a><span>
</span><a name="line-1705"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533603"><span class="hs-identifier hs-var">dataCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1706"></a><span>              </span><span class="hs-identifier">ifType</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConUserType</span><span> </span><a href="#local-6989586621682533603"><span class="hs-identifier hs-var">dataCon</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1707"></a><span>              </span><span class="hs-identifier">ifIdDetails</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfVanillaId</span><span class="hs-special">,</span><span>
</span><a name="line-1708"></a><span>              </span><span class="hs-identifier">ifIdInfo</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoInfo</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1709"></a><span>
</span><a name="line-1710"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-1711"></a><span class="hs-identifier">coAxiomToIfaceDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoAxiom</span><span> </span><a href="#local-6989586621682533163"><span class="hs-identifier hs-type">br</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span>
</span><a name="line-1712"></a><span class="hs-comment">-- We *do* tidy Axioms, because they are not (and cannot</span><span>
</span><a name="line-1713"></a><span class="hs-comment">-- conveniently be) built in tidy form</span><span>
</span><a name="line-1714"></a><a name="coAxiomToIfaceDecl"><a href="MkIface.html#coAxiomToIfaceDecl"><span class="hs-identifier">coAxiomToIfaceDecl</span></a></a><span> </span><a name="local-6989586621682533604"><a href="#local-6989586621682533604"><span class="hs-identifier">ax</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxiom</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533605"><a href="#local-6989586621682533605"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533606"><a href="#local-6989586621682533606"><span class="hs-identifier">branches</span></a></a><span>
</span><a name="line-1715"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_role</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1716"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceAxiom</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533604"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-1717"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifTyCon</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceTyCon</span><span> </span><a href="#local-6989586621682533605"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1718"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifRole</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-1719"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifAxBranches</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#coAxBranchToIfaceBranch"><span class="hs-identifier hs-var">coAxBranchToIfaceBranch</span></a><span> </span><a href="#local-6989586621682533605"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1720"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">coAxBranchLHS</span><span> </span><a href="#local-6989586621682533608"><span class="hs-identifier hs-var">branch_list</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1721"></a><span>                                   </span><a href="#local-6989586621682533608"><span class="hs-identifier hs-var">branch_list</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1722"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1723"></a><span>   </span><a name="local-6989586621682533608"><a href="#local-6989586621682533608"><span class="hs-identifier">branch_list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromBranches</span><span> </span><a href="#local-6989586621682533606"><span class="hs-identifier hs-var">branches</span></a><span>
</span><a name="line-1724"></a><span>
</span><a name="line-1725"></a><span class="hs-comment">-- 2nd parameter is the list of branch LHSs, for conversion from incompatible branches</span><span>
</span><a name="line-1726"></a><span class="hs-comment">-- to incompatible indices</span><span>
</span><a name="line-1727"></a><span class="hs-comment">-- See Note [Storing compatibility] in CoAxiom</span><span>
</span><a name="line-1728"></a><span class="hs-identifier">coAxBranchToIfaceBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxBranch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceAxBranch</span><span>
</span><a name="line-1729"></a><a name="coAxBranchToIfaceBranch"><a href="MkIface.html#coAxBranchToIfaceBranch"><span class="hs-identifier">coAxBranchToIfaceBranch</span></a></a><span> </span><a name="local-6989586621682533609"><a href="#local-6989586621682533609"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682533610"><a href="#local-6989586621682533610"><span class="hs-identifier">lhs_s</span></a></a><span>
</span><a name="line-1730"></a><span>                        </span><a name="local-6989586621682533611"><a href="#local-6989586621682533611"><span class="hs-identifier">branch</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxBranch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_incomps</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533612"><a href="#local-6989586621682533612"><span class="hs-identifier">incomps</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1731"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#coAxBranchToIfaceBranch%27"><span class="hs-identifier hs-var">coAxBranchToIfaceBranch'</span></a><span> </span><a href="#local-6989586621682533609"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682533611"><span class="hs-identifier hs-var">branch</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifaxbIncomps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533613"><span class="hs-identifier hs-var">iface_incomps</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1732"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1733"></a><span>    </span><a name="local-6989586621682533613"><a href="#local-6989586621682533613"><span class="hs-identifier">iface_incomps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">expectJust</span><span> </span><span class="hs-string">&quot;iface_incomps&quot;</span><span>
</span><a name="line-1734"></a><span>                        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">findIndex</span><span> </span><a href="#local-6989586621682533610"><span class="hs-identifier hs-var">lhs_s</span></a><span>
</span><a name="line-1735"></a><span>                          </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">eqTypes</span><span class="hs-special">)</span><span>
</span><a name="line-1736"></a><span>                        </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">coAxBranchLHS</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533612"><span class="hs-identifier hs-var">incomps</span></a><span>
</span><a name="line-1737"></a><span>
</span><a name="line-1738"></a><span class="hs-comment">-- use this one for standalone branches without incompatibles</span><span>
</span><a name="line-1739"></a><span class="hs-identifier">coAxBranchToIfaceBranch'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoAxBranch</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceAxBranch</span><span>
</span><a name="line-1740"></a><a name="coAxBranchToIfaceBranch%27"><a href="MkIface.html#coAxBranchToIfaceBranch%27"><span class="hs-identifier">coAxBranchToIfaceBranch'</span></a></a><span> </span><a name="local-6989586621682533614"><a href="#local-6989586621682533614"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxBranch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533615"><a href="#local-6989586621682533615"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533616"><a href="#local-6989586621682533616"><span class="hs-identifier">cvs</span></a></a><span>
</span><a name="line-1741"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_eta_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533617"><a href="#local-6989586621682533617"><span class="hs-identifier">eta_tvs</span></a></a><span>
</span><a name="line-1742"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533618"><a href="#local-6989586621682533618"><span class="hs-identifier">lhs</span></a></a><span>
</span><a name="line-1743"></a><span>                                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_roles</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533619"><a href="#local-6989586621682533619"><span class="hs-identifier">roles</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533620"><a href="#local-6989586621682533620"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1744"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceAxBranch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifaxbTyVars</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceTvBndrs</span><span> </span><a href="#local-6989586621682533615"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1745"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifaxbCoVars</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toIfaceIdBndr</span><span> </span><a href="#local-6989586621682533616"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-1746"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifaxbEtaTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceTvBndrs</span><span> </span><a href="#local-6989586621682533617"><span class="hs-identifier hs-var">eta_tvs</span></a><span>
</span><a name="line-1747"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifaxbLHS</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceTcArgs</span><span> </span><a href="#local-6989586621682533614"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682533618"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-1748"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifaxbRoles</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533619"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-1749"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifaxbRHS</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceType</span><span> </span><a href="#local-6989586621682533620"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1750"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifaxbIncomps</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1751"></a><span>
</span><a name="line-1752"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-1753"></a><span class="hs-identifier">tyConToIfaceDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">)</span><span>
</span><a name="line-1754"></a><span class="hs-comment">-- We *do* tidy TyCons, because they are not (and cannot</span><span>
</span><a name="line-1755"></a><span class="hs-comment">-- conveniently be) built in tidy form</span><span>
</span><a name="line-1756"></a><span class="hs-comment">-- The returned TidyEnv is the one after tidying the tyConTyVars</span><span>
</span><a name="line-1757"></a><a name="tyConToIfaceDecl"><a href="MkIface.html#tyConToIfaceDecl"><span class="hs-identifier">tyConToIfaceDecl</span></a></a><span> </span><a name="local-6989586621682533621"><a href="#local-6989586621682533621"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682533622"><a href="#local-6989586621682533622"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-1758"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533664"><a href="#local-6989586621682533664"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1759"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#classToIfaceDecl"><span class="hs-identifier hs-var">classToIfaceDecl</span></a><span> </span><a href="#local-6989586621682533621"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682533664"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-1760"></a><span>
</span><a name="line-1761"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533665"><a href="#local-6989586621682533665"><span class="hs-identifier">syn_rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">synTyConRhs_maybe</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1762"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682533623"><span class="hs-identifier hs-var">tc_env1</span></a><span>
</span><a name="line-1763"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">IfaceSynonym</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1764"></a><span>                     </span><span class="hs-identifier">ifRoles</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1765"></a><span>                     </span><span class="hs-identifier">ifSynRhs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533628"><span class="hs-identifier hs-var">if_syn_type</span></a><span> </span><a href="#local-6989586621682533665"><span class="hs-identifier hs-var">syn_rhs</span></a><span class="hs-special">,</span><span>
</span><a name="line-1766"></a><span>                     </span><span class="hs-identifier">ifBinders</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533626"><span class="hs-identifier hs-var">if_binders</span></a><span class="hs-special">,</span><span>
</span><a name="line-1767"></a><span>                     </span><span class="hs-identifier">ifResKind</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533627"><span class="hs-identifier hs-var">if_res_kind</span></a><span>
</span><a name="line-1768"></a><span>                   </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1769"></a><span>
</span><a name="line-1770"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533666"><a href="#local-6989586621682533666"><span class="hs-identifier">fam_flav</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">famTyConFlav_maybe</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1771"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682533623"><span class="hs-identifier hs-var">tc_env1</span></a><span>
</span><a name="line-1772"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">IfaceFamily</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1773"></a><span>                    </span><span class="hs-identifier">ifResVar</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533629"><span class="hs-identifier hs-var">if_res_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-1774"></a><span>                    </span><span class="hs-identifier">ifFamFlav</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533631"><span class="hs-identifier hs-var">to_if_fam_flav</span></a><span> </span><a href="#local-6989586621682533666"><span class="hs-identifier hs-var">fam_flav</span></a><span class="hs-special">,</span><span>
</span><a name="line-1775"></a><span>                    </span><span class="hs-identifier">ifBinders</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533626"><span class="hs-identifier hs-var">if_binders</span></a><span class="hs-special">,</span><span>
</span><a name="line-1776"></a><span>                    </span><span class="hs-identifier">ifResKind</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533627"><span class="hs-identifier hs-var">if_res_kind</span></a><span class="hs-special">,</span><span>
</span><a name="line-1777"></a><span>                    </span><span class="hs-identifier">ifFamInj</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConInjectivityInfo</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1778"></a><span>                  </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1779"></a><span>
</span><a name="line-1780"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1781"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682533623"><span class="hs-identifier hs-var">tc_env1</span></a><span>
</span><a name="line-1782"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">IfaceData</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1783"></a><span>                  </span><span class="hs-identifier">ifBinders</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533626"><span class="hs-identifier hs-var">if_binders</span></a><span class="hs-special">,</span><span>
</span><a name="line-1784"></a><span>                  </span><span class="hs-identifier">ifResKind</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533627"><span class="hs-identifier hs-var">if_res_kind</span></a><span class="hs-special">,</span><span>
</span><a name="line-1785"></a><span>                  </span><span class="hs-identifier">ifCType</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConCType</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1786"></a><span>                  </span><span class="hs-identifier">ifRoles</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1787"></a><span>                  </span><span class="hs-identifier">ifCtxt</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyToIfaceContext</span><span> </span><a href="#local-6989586621682533623"><span class="hs-identifier hs-var">tc_env1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConStupidTheta</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1788"></a><span>                  </span><span class="hs-identifier">ifCons</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533632"><span class="hs-identifier hs-var">ifaceConDecls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">algTyConRhs</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1789"></a><span>                  </span><span class="hs-identifier">ifGadtSyntax</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isGadtSyntaxTyCon</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1790"></a><span>                  </span><span class="hs-identifier">ifParent</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533630"><span class="hs-identifier hs-var">parent</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1791"></a><span>
</span><a name="line-1792"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-comment">-- FunTyCon, PrimTyCon, promoted TyCon/DataCon</span><span>
</span><a name="line-1793"></a><span>  </span><span class="hs-comment">-- We only convert these TyCons to IfaceTyCons when we are</span><span>
</span><a name="line-1794"></a><span>  </span><span class="hs-comment">-- just about to pretty-print them, not because we are going</span><span>
</span><a name="line-1795"></a><span>  </span><span class="hs-comment">-- to put them into interface files</span><span>
</span><a name="line-1796"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682533621"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1797"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">IfaceData</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1798"></a><span>                  </span><span class="hs-identifier">ifBinders</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533626"><span class="hs-identifier hs-var">if_binders</span></a><span class="hs-special">,</span><span>
</span><a name="line-1799"></a><span>                  </span><span class="hs-identifier">ifResKind</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533627"><span class="hs-identifier hs-var">if_res_kind</span></a><span class="hs-special">,</span><span>
</span><a name="line-1800"></a><span>                  </span><span class="hs-identifier">ifCType</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-1801"></a><span>                  </span><span class="hs-identifier">ifRoles</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1802"></a><span>                  </span><span class="hs-identifier">ifCtxt</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1803"></a><span>                  </span><span class="hs-identifier">ifCons</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfDataTyCon</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1804"></a><span>                  </span><span class="hs-identifier">ifGadtSyntax</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span>
</span><a name="line-1805"></a><span>                  </span><span class="hs-identifier">ifParent</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfNoParent</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1806"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1807"></a><span>    </span><span class="hs-comment">-- NOTE: Not all TyCons have `tyConTyVars` field. Forcing this when `tycon`</span><span>
</span><a name="line-1808"></a><span>    </span><span class="hs-comment">-- is one of these TyCons (FunTyCon, PrimTyCon, PromotedDataCon) will cause</span><span>
</span><a name="line-1809"></a><span>    </span><span class="hs-comment">-- an error.</span><span>
</span><a name="line-1810"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682533623"><a href="#local-6989586621682533623"><span class="hs-identifier">tc_env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533624"><a href="#local-6989586621682533624"><span class="hs-identifier">tc_binders</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#tidyTyConBinders"><span class="hs-identifier hs-var">tidyTyConBinders</span></a><span> </span><a href="#local-6989586621682533621"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-1811"></a><span>    </span><a name="local-6989586621682533625"><a href="#local-6989586621682533625"><span class="hs-identifier">tc_tyvars</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">binderVars</span><span> </span><a href="#local-6989586621682533624"><span class="hs-identifier hs-var">tc_binders</span></a><span>
</span><a name="line-1812"></a><span>    </span><a name="local-6989586621682533626"><a href="#local-6989586621682533626"><span class="hs-identifier">if_binders</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceTyCoVarBinders</span><span> </span><a href="#local-6989586621682533624"><span class="hs-identifier hs-var">tc_binders</span></a><span>
</span><a name="line-1813"></a><span>                     </span><span class="hs-comment">-- No tidying of the binders; they are already tidy</span><span>
</span><a name="line-1814"></a><span>    </span><a name="local-6989586621682533627"><a href="#local-6989586621682533627"><span class="hs-identifier">if_res_kind</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyToIfaceType</span><span> </span><a href="#local-6989586621682533623"><span class="hs-identifier hs-var">tc_env1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConResKind</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-1815"></a><span>    </span><a name="local-6989586621682533628"><a href="#local-6989586621682533628"><span class="hs-identifier">if_syn_type</span></a></a><span> </span><a name="local-6989586621682533634"><a href="#local-6989586621682533634"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyToIfaceType</span><span> </span><a href="#local-6989586621682533623"><span class="hs-identifier hs-var">tc_env1</span></a><span> </span><a href="#local-6989586621682533634"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1816"></a><span>    </span><a name="local-6989586621682533629"><a href="#local-6989586621682533629"><span class="hs-identifier">if_res_var</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getOccFS</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tyConFamilyResVar_maybe</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-1817"></a><span>
</span><a name="line-1818"></a><span>    </span><a name="local-6989586621682533630"><a href="#local-6989586621682533630"><span class="hs-identifier">parent</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tyConFamInstSig_maybe</span><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1819"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682533635"><a href="#local-6989586621682533635"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533636"><a href="#local-6989586621682533636"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533637"><a href="#local-6989586621682533637"><span class="hs-identifier">ax</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IfDataInstance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coAxiomName</span><span> </span><a href="#local-6989586621682533637"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span>
</span><a name="line-1820"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toIfaceTyCon</span><span> </span><a href="#local-6989586621682533635"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1821"></a><span>                                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyToIfaceTcArgs</span><span> </span><a href="#local-6989586621682533623"><span class="hs-identifier hs-var">tc_env1</span></a><span> </span><a href="#local-6989586621682533635"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682533636"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1822"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IfNoParent</span><span>
</span><a name="line-1823"></a><span>
</span><a name="line-1824"></a><span>    </span><a name="local-6989586621682533631"><a href="#local-6989586621682533631"><span class="hs-identifier">to_if_fam_flav</span></a></a><span> </span><span class="hs-identifier hs-var">OpenSynFamilyTyCon</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceOpenSynFamilyTyCon</span><span>
</span><a name="line-1825"></a><span>    </span><span class="hs-identifier">to_if_fam_flav</span><span> </span><span class="hs-identifier hs-var">AbstractClosedSynFamilyTyCon</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceAbstractClosedSynFamilyTyCon</span><span>
</span><a name="line-1826"></a><span>    </span><span class="hs-identifier">to_if_fam_flav</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamilyTyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceDataFamilyTyCon</span><span>
</span><a name="line-1827"></a><span>    </span><span class="hs-identifier">to_if_fam_flav</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BuiltInSynFamTyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceBuiltInSynFamTyCon</span><span>
</span><a name="line-1828"></a><span>    </span><span class="hs-identifier">to_if_fam_flav</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceClosedSynFamilyTyCon</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1829"></a><span>    </span><span class="hs-identifier">to_if_fam_flav</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533638"><a href="#local-6989586621682533638"><span class="hs-identifier">ax</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1830"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceClosedSynFamilyTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533641"><span class="hs-identifier hs-var">axn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682533640"><span class="hs-identifier hs-var">ibr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1831"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682533639"><a href="#local-6989586621682533639"><span class="hs-identifier">defs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromBranches</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">coAxiomBranches</span><span> </span><a href="#local-6989586621682533638"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-1832"></a><span>            </span><a name="local-6989586621682533640"><a href="#local-6989586621682533640"><span class="hs-identifier">ibr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#coAxBranchToIfaceBranch%27"><span class="hs-identifier hs-var">coAxBranchToIfaceBranch'</span></a><span> </span><a href="#local-6989586621682533622"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533639"><span class="hs-identifier hs-var">defs</span></a><span>
</span><a name="line-1833"></a><span>            </span><a name="local-6989586621682533641"><a href="#local-6989586621682533641"><span class="hs-identifier">axn</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxiomName</span><span> </span><a href="#local-6989586621682533638"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-1834"></a><span>
</span><a name="line-1835"></a><span>    </span><a name="local-6989586621682533632"><a href="#local-6989586621682533632"><span class="hs-identifier">ifaceConDecls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NewTyCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">data_con</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533642"><a href="#local-6989586621682533642"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfNewTyCon</span><span>  </span><span class="hs-special">(</span><a href="#local-6989586621682533633"><span class="hs-identifier hs-var">ifaceConDecl</span></a><span> </span><a href="#local-6989586621682533642"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-1836"></a><span>    </span><span class="hs-identifier">ifaceConDecls</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataTyCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">data_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533643"><a href="#local-6989586621682533643"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfDataTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533633"><span class="hs-identifier hs-var">ifaceConDecl</span></a><span> </span><a href="#local-6989586621682533643"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-1837"></a><span>    </span><span class="hs-identifier">ifaceConDecls</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TupleTyCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">data_con</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533644"><a href="#local-6989586621682533644"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfDataTyCon</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682533633"><span class="hs-identifier hs-var">ifaceConDecl</span></a><span> </span><a href="#local-6989586621682533644"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">]</span><span>
</span><a name="line-1838"></a><span>    </span><span class="hs-identifier">ifaceConDecls</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SumTyCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">data_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533645"><a href="#local-6989586621682533645"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfDataTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533633"><span class="hs-identifier hs-var">ifaceConDecl</span></a><span> </span><a href="#local-6989586621682533645"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-1839"></a><span>    </span><span class="hs-identifier">ifaceConDecls</span><span> </span><span class="hs-identifier hs-var">AbstractTyCon</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfAbstractTyCon</span><span>
</span><a name="line-1840"></a><span>        </span><span class="hs-comment">-- The AbstractTyCon case happens when a TyCon has been trimmed</span><span>
</span><a name="line-1841"></a><span>        </span><span class="hs-comment">-- during tidying.</span><span>
</span><a name="line-1842"></a><span>        </span><span class="hs-comment">-- Furthermore, tyThingToIfaceDecl is also used in TcRnDriver</span><span>
</span><a name="line-1843"></a><span>        </span><span class="hs-comment">-- for GHCi, when browsing a module, in which case the</span><span>
</span><a name="line-1844"></a><span>        </span><span class="hs-comment">-- AbstractTyCon and TupleTyCon cases are perfectly sensible.</span><span>
</span><a name="line-1845"></a><span>        </span><span class="hs-comment">-- (Tuple declarations are not serialised into interface files.)</span><span>
</span><a name="line-1846"></a><span>
</span><a name="line-1847"></a><span>    </span><a name="local-6989586621682533633"><a href="#local-6989586621682533633"><span class="hs-identifier">ifaceConDecl</span></a></a><span> </span><a name="local-6989586621682533646"><a href="#local-6989586621682533646"><span class="hs-identifier">data_con</span></a></a><span>
</span><a name="line-1848"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfCon</span><span>   </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifConName</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621682533646"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">,</span><span>
</span><a name="line-1849"></a><span>                    </span><span class="hs-identifier">ifConInfix</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConIsInfix</span><span> </span><a href="#local-6989586621682533646"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">,</span><span>
</span><a name="line-1850"></a><span>                    </span><span class="hs-identifier">ifConWrapper</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWrapId_maybe</span><span> </span><a href="#local-6989586621682533646"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1851"></a><span>                    </span><span class="hs-identifier">ifConExTCvs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toIfaceBndr</span><span> </span><a href="#local-6989586621682533655"><span class="hs-identifier hs-var">ex_tvs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1852"></a><span>                    </span><span class="hs-identifier">ifConUserTvBinders</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toIfaceForAllBndr</span><span> </span><a href="#local-6989586621682533656"><span class="hs-identifier hs-var">user_bndrs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-1853"></a><span>                    </span><span class="hs-identifier">ifConEqSpec</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533657"><span class="hs-identifier hs-var">to_eq_spec</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">eqSpecPair</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533649"><span class="hs-identifier hs-var">eq_spec</span></a><span class="hs-special">,</span><span>
</span><a name="line-1854"></a><span>                    </span><span class="hs-identifier">ifConCtxt</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyToIfaceContext</span><span> </span><a href="#local-6989586621682533654"><span class="hs-identifier hs-var">con_env2</span></a><span> </span><a href="#local-6989586621682533650"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">,</span><span>
</span><a name="line-1855"></a><span>                    </span><span class="hs-identifier">ifConArgTys</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyToIfaceType</span><span> </span><a href="#local-6989586621682533654"><span class="hs-identifier hs-var">con_env2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533651"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span>
</span><a name="line-1856"></a><span>                    </span><span class="hs-identifier">ifConFields</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConFieldLabels</span><span> </span><a href="#local-6989586621682533646"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">,</span><span>
</span><a name="line-1857"></a><span>                    </span><span class="hs-identifier">ifConStricts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toIfaceBang</span><span> </span><a href="#local-6989586621682533654"><span class="hs-identifier hs-var">con_env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1858"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConImplBangs</span><span> </span><a href="#local-6989586621682533646"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1859"></a><span>                    </span><span class="hs-identifier">ifConSrcStricts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toIfaceSrcBang</span><span>
</span><a name="line-1860"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConSrcBangs</span><span> </span><a href="#local-6989586621682533646"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-1861"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1862"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621682533647"><a href="#local-6989586621682533647"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533648"><a href="#local-6989586621682533648"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533649"><a href="#local-6989586621682533649"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533650"><a href="#local-6989586621682533650"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533651"><a href="#local-6989586621682533651"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1863"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConFullSig</span><span> </span><a href="#local-6989586621682533646"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-1864"></a><span>          </span><a name="local-6989586621682533652"><a href="#local-6989586621682533652"><span class="hs-identifier">user_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConUserTyVarBinders</span><span> </span><a href="#local-6989586621682533646"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-1865"></a><span>
</span><a name="line-1866"></a><span>          </span><span class="hs-comment">-- Tidy the univ_tvs of the data constructor to be identical</span><span>
</span><a name="line-1867"></a><span>          </span><span class="hs-comment">-- to the tyConTyVars of the type constructor.  This means</span><span>
</span><a name="line-1868"></a><span>          </span><span class="hs-comment">-- (a) we don't need to redundantly put them into the interface file</span><span>
</span><a name="line-1869"></a><span>          </span><span class="hs-comment">-- (b) when pretty-printing an Iface data declaration in H98-style syntax,</span><span>
</span><a name="line-1870"></a><span>          </span><span class="hs-comment">--     we know that the type variables will line up</span><span>
</span><a name="line-1871"></a><span>          </span><span class="hs-comment">-- The latter (b) is important because we pretty-print type constructors</span><span>
</span><a name="line-1872"></a><span>          </span><span class="hs-comment">-- by converting to IfaceSyn and pretty-printing that</span><span>
</span><a name="line-1873"></a><span>          </span><a name="local-6989586621682533653"><a href="#local-6989586621682533653"><span class="hs-identifier">con_env1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682533623"><span class="hs-identifier hs-var">tc_env1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;ifaceConDecl&quot;</span><span> </span><a href="#local-6989586621682533647"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-6989586621682533625"><span class="hs-identifier hs-var">tc_tyvars</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1874"></a><span>                     </span><span class="hs-comment">-- A bit grimy, perhaps, but it's simple!</span><span>
</span><a name="line-1875"></a><span>
</span><a name="line-1876"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621682533654"><a href="#local-6989586621682533654"><span class="hs-identifier">con_env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533655"><a href="#local-6989586621682533655"><span class="hs-identifier">ex_tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyVarBndrs</span><span> </span><a href="#local-6989586621682533653"><span class="hs-identifier hs-var">con_env1</span></a><span> </span><a href="#local-6989586621682533648"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-1877"></a><span>          </span><a name="local-6989586621682533656"><a href="#local-6989586621682533656"><span class="hs-identifier">user_bndrs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533658"><span class="hs-identifier hs-var">tidyUserTyCoVarBinder</span></a><span> </span><a href="#local-6989586621682533654"><span class="hs-identifier hs-var">con_env2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533652"><span class="hs-identifier hs-var">user_bndrs</span></a><span>
</span><a name="line-1878"></a><span>          </span><a name="local-6989586621682533657"><a href="#local-6989586621682533657"><span class="hs-identifier">to_eq_spec</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533659"><a href="#local-6989586621682533659"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><a name="local-6989586621682533660"><a href="#local-6989586621682533660"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#tidyTyVar"><span class="hs-identifier hs-var">tidyTyVar</span></a><span> </span><a href="#local-6989586621682533654"><span class="hs-identifier hs-var">con_env2</span></a><span> </span><a href="#local-6989586621682533659"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tidyToIfaceType</span><span> </span><a href="#local-6989586621682533654"><span class="hs-identifier hs-var">con_env2</span></a><span> </span><a href="#local-6989586621682533660"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1879"></a><span>
</span><a name="line-1880"></a><span>          </span><span class="hs-comment">-- By this point, we have tidied every universal and existential</span><span>
</span><a name="line-1881"></a><span>          </span><span class="hs-comment">-- tyvar. Because of the dcUserTyCoVarBinders invariant</span><span>
</span><a name="line-1882"></a><span>          </span><span class="hs-comment">-- (see Note [DataCon user type variable binders]), *every*</span><span>
</span><a name="line-1883"></a><span>          </span><span class="hs-comment">-- user-written tyvar must be contained in the substitution that</span><span>
</span><a name="line-1884"></a><span>          </span><span class="hs-comment">-- tidying produced. Therefore, tidying the user-written tyvars is a</span><span>
</span><a name="line-1885"></a><span>          </span><span class="hs-comment">-- simple matter of looking up each variable in the substitution,</span><span>
</span><a name="line-1886"></a><span>          </span><span class="hs-comment">-- which tidyTyCoVarOcc accomplishes.</span><span>
</span><a name="line-1887"></a><span>          </span><span class="hs-identifier">tidyUserTyCoVarBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCoVarBinder</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCoVarBinder</span><span>
</span><a name="line-1888"></a><span>          </span><a name="local-6989586621682533658"><a href="#local-6989586621682533658"><span class="hs-identifier">tidyUserTyCoVarBinder</span></a></a><span> </span><a name="local-6989586621682533661"><a href="#local-6989586621682533661"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><a name="local-6989586621682533662"><a href="#local-6989586621682533662"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682533663"><a href="#local-6989586621682533663"><span class="hs-identifier">vis</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1889"></a><span>            </span><span class="hs-identifier hs-var">Bndr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyTyCoVarOcc</span><span> </span><a href="#local-6989586621682533661"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682533662"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533663"><span class="hs-identifier hs-var">vis</span></a><span>
</span><a name="line-1890"></a><span>
</span><a name="line-1891"></a><span class="hs-identifier">classToIfaceDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IfaceDecl</span><span class="hs-special">)</span><span>
</span><a name="line-1892"></a><a name="classToIfaceDecl"><a href="MkIface.html#classToIfaceDecl"><span class="hs-identifier">classToIfaceDecl</span></a></a><span> </span><a name="local-6989586621682533667"><a href="#local-6989586621682533667"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682533668"><a href="#local-6989586621682533668"><span class="hs-identifier">clas</span></a></a><span>
</span><a name="line-1893"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682533675"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-1894"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">IfaceClass</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifName</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533673"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">,</span><span>
</span><a name="line-1895"></a><span>                   </span><span class="hs-identifier">ifRoles</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621682533668"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1896"></a><span>                   </span><span class="hs-identifier">ifBinders</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceTyCoVarBinders</span><span> </span><a href="#local-6989586621682533676"><span class="hs-identifier hs-var">tc_binders</span></a><span class="hs-special">,</span><span>
</span><a name="line-1897"></a><span>                   </span><span class="hs-identifier">ifBody</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533674"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">,</span><span>
</span><a name="line-1898"></a><span>                   </span><span class="hs-identifier">ifFDs</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533680"><span class="hs-identifier hs-var">toIfaceFD</span></a><span> </span><a href="#local-6989586621682533669"><span class="hs-identifier hs-var">clas_fds</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1899"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1900"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682533669"><a href="#local-6989586621682533669"><span class="hs-identifier">clas_fds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533670"><a href="#local-6989586621682533670"><span class="hs-identifier">sc_theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682533671"><a href="#local-6989586621682533671"><span class="hs-identifier">clas_ats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533672"><a href="#local-6989586621682533672"><span class="hs-identifier">op_stuff</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1901"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">classExtraBigSig</span><span> </span><a href="#local-6989586621682533668"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-1902"></a><span>    </span><a name="local-6989586621682533673"><a href="#local-6989586621682533673"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621682533668"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-1903"></a><span>
</span><a name="line-1904"></a><span>    </span><a name="local-6989586621682533674"><a href="#local-6989586621682533674"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAbstractTyCon</span><span> </span><a href="#local-6989586621682533673"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfAbstractClass</span><span>
</span><a name="line-1905"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1906"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfConcreteClass</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1907"></a><span>                </span><span class="hs-identifier">ifClassCtxt</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tidyToIfaceContext</span><span> </span><a href="#local-6989586621682533675"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621682533670"><span class="hs-identifier hs-var">sc_theta</span></a><span class="hs-special">,</span><span>
</span><a name="line-1908"></a><span>                </span><span class="hs-identifier">ifATs</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533677"><span class="hs-identifier hs-var">toIfaceAT</span></a><span> </span><a href="#local-6989586621682533671"><span class="hs-identifier hs-var">clas_ats</span></a><span class="hs-special">,</span><span>
</span><a name="line-1909"></a><span>                </span><span class="hs-identifier">ifSigs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533678"><span class="hs-identifier hs-var">toIfaceClassOp</span></a><span> </span><a href="#local-6989586621682533672"><span class="hs-identifier hs-var">op_stuff</span></a><span class="hs-special">,</span><span>
</span><a name="line-1910"></a><span>                </span><span class="hs-identifier">ifMinDef</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">getOccFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">classMinimalDef</span><span> </span><a href="#local-6989586621682533668"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-1911"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-1912"></a><span>
</span><a name="line-1913"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682533675"><a href="#local-6989586621682533675"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533676"><a href="#local-6989586621682533676"><span class="hs-identifier">tc_binders</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#tidyTyConBinders"><span class="hs-identifier hs-var">tidyTyConBinders</span></a><span> </span><a href="#local-6989586621682533667"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621682533673"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-1914"></a><span>
</span><a name="line-1915"></a><span>    </span><span class="hs-identifier">toIfaceAT</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClassATItem</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceAT</span><span>
</span><a name="line-1916"></a><span>    </span><a name="local-6989586621682533677"><a href="#local-6989586621682533677"><span class="hs-identifier">toIfaceAT</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATI</span><span> </span><a name="local-6989586621682533681"><a href="#local-6989586621682533681"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682533682"><a href="#local-6989586621682533682"><span class="hs-identifier">def</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1917"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceAT</span><span> </span><a href="#local-6989586621682533684"><span class="hs-identifier hs-var">if_decl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyToIfaceType</span><span> </span><a href="#local-6989586621682533683"><span class="hs-identifier hs-var">env2</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533682"><span class="hs-identifier hs-var">def</span></a><span class="hs-special">)</span><span>
</span><a name="line-1918"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1919"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682533683"><a href="#local-6989586621682533683"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533684"><a href="#local-6989586621682533684"><span class="hs-identifier">if_decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkIface.html#tyConToIfaceDecl"><span class="hs-identifier hs-var">tyConToIfaceDecl</span></a><span> </span><a href="#local-6989586621682533675"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621682533681"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1920"></a><span>
</span><a name="line-1921"></a><span>    </span><a name="local-6989586621682533678"><a href="#local-6989586621682533678"><span class="hs-identifier">toIfaceClassOp</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533685"><a href="#local-6989586621682533685"><span class="hs-identifier">sel_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533686"><a href="#local-6989586621682533686"><span class="hs-identifier">def_meth</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1922"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">sel_tyvars</span><span> </span><span class="hs-operator">==</span><span> </span><a href="#local-6989586621682533687"><span class="hs-identifier hs-var">binderVars</span></a><span> </span><span class="hs-identifier">tc_binders</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1923"></a><span>          </span><span class="hs-identifier hs-var">IfaceClassOp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621682533685"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1924"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyToIfaceType</span><span> </span><a href="#local-6989586621682533675"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621682533689"><span class="hs-identifier hs-var">op_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1925"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621682533679"><span class="hs-identifier hs-var">toDmSpec</span></a><span> </span><a href="#local-6989586621682533686"><span class="hs-identifier hs-var">def_meth</span></a><span class="hs-special">)</span><span>
</span><a name="line-1926"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1927"></a><span>                </span><span class="hs-comment">-- Be careful when splitting the type, because of things</span><span>
</span><a name="line-1928"></a><span>                </span><span class="hs-comment">-- like         class Foo a where</span><span>
</span><a name="line-1929"></a><span>                </span><span class="hs-comment">--                op :: (?x :: String) =&gt; a -&gt; a</span><span>
</span><a name="line-1930"></a><span>                </span><span class="hs-comment">-- and          class Baz a where</span><span>
</span><a name="line-1931"></a><span>                </span><span class="hs-comment">--                op :: (Ord a) =&gt; a -&gt; a</span><span>
</span><a name="line-1932"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621682533687"><a href="#local-6989586621682533687"><span class="hs-identifier">sel_tyvars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533688"><a href="#local-6989586621682533688"><span class="hs-identifier">rho_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitForAllTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621682533685"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1933"></a><span>          </span><a name="local-6989586621682533689"><a href="#local-6989586621682533689"><span class="hs-identifier">op_ty</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">funResultTy</span><span> </span><a href="#local-6989586621682533688"><span class="hs-identifier hs-var">rho_ty</span></a><span>
</span><a name="line-1934"></a><span>
</span><a name="line-1935"></a><span>    </span><span class="hs-identifier">toDmSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DefMethSpec</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DefMethSpec</span><span> </span><span class="hs-identifier hs-type">IfaceType</span><span>
</span><a name="line-1936"></a><span>    </span><a name="local-6989586621682533679"><a href="#local-6989586621682533679"><span class="hs-identifier">toDmSpec</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span>
</span><a name="line-1937"></a><span>    </span><span class="hs-identifier">toDmSpec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621682533690"><a href="#local-6989586621682533690"><span class="hs-identifier">dm_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyToIfaceType</span><span> </span><a href="#local-6989586621682533675"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621682533690"><span class="hs-identifier hs-var">dm_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1938"></a><span>
</span><a name="line-1939"></a><span>    </span><a name="local-6989586621682533680"><a href="#local-6989586621682533680"><span class="hs-identifier">toIfaceFD</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682533691"><a href="#local-6989586621682533691"><span class="hs-identifier">tvs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682533692"><a href="#local-6989586621682533692"><span class="hs-identifier">tvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#tidyTyVar"><span class="hs-identifier hs-var">tidyTyVar</span></a><span> </span><a href="#local-6989586621682533675"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533691"><span class="hs-identifier hs-var">tvs1</span></a><span>
</span><a name="line-1940"></a><span>                             </span><span class="hs-special">,</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#tidyTyVar"><span class="hs-identifier hs-var">tidyTyVar</span></a><span> </span><a href="#local-6989586621682533675"><span class="hs-identifier hs-var">env1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682533692"><span class="hs-identifier hs-var">tvs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1941"></a><span>
</span><a name="line-1942"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-1943"></a><span>
</span><a name="line-1944"></a><span class="hs-identifier">tidyTyConBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyConBinder</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TyConBinder</span><span class="hs-special">)</span><span>
</span><a name="line-1945"></a><span class="hs-comment">-- If the type variable &quot;binder&quot; is in scope, don't re-bind it</span><span>
</span><a name="line-1946"></a><span class="hs-comment">-- In a class decl, for example, the ATD binders mention</span><span>
</span><a name="line-1947"></a><span class="hs-comment">-- (amd must mention) the class tyvars</span><span>
</span><a name="line-1948"></a><a name="tidyTyConBinder"><a href="MkIface.html#tidyTyConBinder"><span class="hs-identifier">tidyTyConBinder</span></a></a><span> </span><a name="local-6989586621682533693"><a href="#local-6989586621682533693"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682533694"><a href="#local-6989586621682533694"><span class="hs-identifier">subst</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682533695"><a href="#local-6989586621682533695"><span class="hs-identifier">tvb</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Bndr</span><span> </span><a name="local-6989586621682533696"><a href="#local-6989586621682533696"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682533697"><a href="#local-6989586621682533697"><span class="hs-identifier">vis</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1949"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621682533694"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682533696"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1950"></a><span>     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533698"><a href="#local-6989586621682533698"><span class="hs-identifier">tv'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682533693"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-var">Bndr</span><span> </span><a href="#local-6989586621682533698"><span class="hs-identifier hs-var">tv'</span></a><span> </span><a href="#local-6989586621682533697"><span class="hs-identifier hs-var">vis</span></a><span class="hs-special">)</span><span>
</span><a name="line-1951"></a><span>     </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">tidyTyCoVarBinder</span><span> </span><a href="#local-6989586621682533693"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682533695"><span class="hs-identifier hs-var">tvb</span></a><span>
</span><a name="line-1952"></a><span>
</span><a name="line-1953"></a><span class="hs-identifier">tidyTyConBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyConBinder</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyConBinder</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1954"></a><a name="tidyTyConBinders"><a href="MkIface.html#tidyTyConBinders"><span class="hs-identifier">tidyTyConBinders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="MkIface.html#tidyTyConBinder"><span class="hs-identifier hs-var">tidyTyConBinder</span></a><span>
</span><a name="line-1955"></a><span>
</span><a name="line-1956"></a><span class="hs-identifier">tidyTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FastString</span><span>
</span><a name="line-1957"></a><a name="tidyTyVar"><a href="MkIface.html#tidyTyVar"><span class="hs-identifier">tidyTyVar</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682533699"><a href="#local-6989586621682533699"><span class="hs-identifier">subst</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682533700"><a href="#local-6989586621682533700"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceTyVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621682533699"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682533700"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682533700"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1958"></a><span>
</span><a name="line-1959"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-1960"></a><span class="hs-identifier">instanceToIfaceInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceClsInst</span><span>
</span><a name="line-1961"></a><a name="instanceToIfaceInst"><a href="MkIface.html#instanceToIfaceInst"><span class="hs-identifier">instanceToIfaceInst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClsInst</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_dfun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533701"><a href="#local-6989586621682533701"><span class="hs-identifier">dfun_id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_flag</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533702"><a href="#local-6989586621682533702"><span class="hs-identifier">oflag</span></a></a><span>
</span><a name="line-1962"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_cls_nm</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533703"><a href="#local-6989586621682533703"><span class="hs-identifier">cls_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533704"><a href="#local-6989586621682533704"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-1963"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_tcs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533705"><a href="#local-6989586621682533705"><span class="hs-identifier">mb_tcs</span></a></a><span>
</span><a name="line-1964"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">is_orphan</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533706"><a href="#local-6989586621682533706"><span class="hs-identifier">orph</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1965"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">cls_name</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">className</span><span> </span><span class="hs-identifier">cls</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1966"></a><span>    </span><span class="hs-identifier hs-var">IfaceClsInst</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifDFun</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533708"><span class="hs-identifier hs-var">dfun_name</span></a><span class="hs-special">,</span><span>
</span><a name="line-1967"></a><span>                </span><span class="hs-identifier">ifOFlag</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533702"><span class="hs-identifier hs-var">oflag</span></a><span class="hs-special">,</span><span>
</span><a name="line-1968"></a><span>                </span><span class="hs-identifier">ifInstCls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533703"><span class="hs-identifier hs-var">cls_name</span></a><span class="hs-special">,</span><span>
</span><a name="line-1969"></a><span>                </span><span class="hs-identifier">ifInstTys</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533707"><span class="hs-identifier hs-var">do_rough</span></a><span> </span><a href="#local-6989586621682533705"><span class="hs-identifier hs-var">mb_tcs</span></a><span class="hs-special">,</span><span>
</span><a name="line-1970"></a><span>                </span><span class="hs-identifier">ifInstOrph</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533706"><span class="hs-identifier hs-var">orph</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1971"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1972"></a><span>    </span><a name="local-6989586621682533707"><a href="#local-6989586621682533707"><span class="hs-identifier">do_rough</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1973"></a><span>    </span><span class="hs-identifier">do_rough</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533709"><a href="#local-6989586621682533709"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toIfaceTyCon_name</span><span> </span><a href="#local-6989586621682533709"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1974"></a><span>
</span><a name="line-1975"></a><span>    </span><a name="local-6989586621682533708"><a href="#local-6989586621682533708"><span class="hs-identifier">dfun_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621682533701"><span class="hs-identifier hs-var">dfun_id</span></a><span>
</span><a name="line-1976"></a><span>
</span><a name="line-1977"></a><span>
</span><a name="line-1978"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-1979"></a><span class="hs-identifier">famInstToIfaceFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceFamInst</span><span>
</span><a name="line-1980"></a><a name="famInstToIfaceFamInst"><a href="MkIface.html#famInstToIfaceFamInst"><span class="hs-identifier">famInstToIfaceFamInst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FamInst</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533710"><a href="#local-6989586621682533710"><span class="hs-identifier">axiom</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1981"></a><span>                                 </span><span class="hs-identifier">fi_fam</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533711"><a href="#local-6989586621682533711"><span class="hs-identifier">fam</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1982"></a><span>                                 </span><span class="hs-identifier">fi_tcs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533712"><a href="#local-6989586621682533712"><span class="hs-identifier">roughs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1983"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceFamInst</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifFamInstAxiom</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">coAxiomName</span><span> </span><a href="#local-6989586621682533710"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-1984"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifFamInstFam</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533711"><span class="hs-identifier hs-var">fam</span></a><span>
</span><a name="line-1985"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifFamInstTys</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533713"><span class="hs-identifier hs-var">do_rough</span></a><span> </span><a href="#local-6989586621682533712"><span class="hs-identifier hs-var">roughs</span></a><span>
</span><a name="line-1986"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifFamInstOrph</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533718"><span class="hs-identifier hs-var">orph</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1987"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1988"></a><span>    </span><a name="local-6989586621682533713"><a href="#local-6989586621682533713"><span class="hs-identifier">do_rough</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1989"></a><span>    </span><span class="hs-identifier">do_rough</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682533719"><a href="#local-6989586621682533719"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toIfaceTyCon_name</span><span> </span><a href="#local-6989586621682533719"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1990"></a><span>
</span><a name="line-1991"></a><span>    </span><a name="local-6989586621682533714"><a href="#local-6989586621682533714"><span class="hs-identifier">fam_decl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">coAxiomTyCon</span><span> </span><a href="#local-6989586621682533710"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-1992"></a><span>    </span><a name="local-6989586621682533715"><a href="#local-6989586621682533715"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coAxiomName</span><span> </span><span class="hs-identifier">axiom</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1993"></a><span>          </span><span class="hs-identifier hs-var">nameModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">coAxiomName</span><span> </span><a href="#local-6989586621682533710"><span class="hs-identifier hs-var">axiom</span></a><span class="hs-special">)</span><span>
</span><a name="line-1994"></a><span>    </span><a name="local-6989586621682533716"><a href="#local-6989586621682533716"><span class="hs-identifier">is_local</span></a></a><span> </span><a name="local-6989586621682533720"><a href="#local-6989586621682533720"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621682533715"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621682533720"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1995"></a><span>
</span><a name="line-1996"></a><span>    </span><a name="local-6989586621682533717"><a href="#local-6989586621682533717"><span class="hs-identifier">lhs_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterNameSet</span><span> </span><a href="#local-6989586621682533716"><span class="hs-identifier hs-var">is_local</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">orphNamesOfCoCon</span><span> </span><a href="#local-6989586621682533710"><span class="hs-identifier hs-var">axiom</span></a><span class="hs-special">)</span><span>
</span><a name="line-1997"></a><span>
</span><a name="line-1998"></a><span>    </span><a name="local-6989586621682533718"><a href="#local-6989586621682533718"><span class="hs-identifier">orph</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682533716"><span class="hs-identifier hs-var">is_local</span></a><span> </span><a href="#local-6989586621682533714"><span class="hs-identifier hs-var">fam_decl</span></a><span>
</span><a name="line-1999"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotOrphan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621682533714"><span class="hs-identifier hs-var">fam_decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-2000"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2001"></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">chooseOrphanAnchor</span><span> </span><a href="#local-6989586621682533717"><span class="hs-identifier hs-var">lhs_names</span></a><span>
</span><a name="line-2002"></a><span>
</span><a name="line-2003"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-2004"></a><span class="hs-identifier">coreRuleToIfaceRule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CoreRule</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceRule</span><span>
</span><a name="line-2005"></a><a name="coreRuleToIfaceRule"><a href="MkIface.html#coreRuleToIfaceRule"><span class="hs-identifier">coreRuleToIfaceRule</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BuiltinRule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533721"><a href="#local-6989586621682533721"><span class="hs-identifier">fn</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2006"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprTrace</span><span> </span><span class="hs-string">&quot;toHsRule: builtin&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682533721"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2007"></a><span>    </span><a href="MkIface.html#bogusIfaceRule"><span class="hs-identifier hs-var">bogusIfaceRule</span></a><span> </span><a href="#local-6989586621682533721"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-2008"></a><span>
</span><a name="line-2009"></a><span class="hs-identifier">coreRuleToIfaceRule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533722"><a href="#local-6989586621682533722"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533723"><a href="#local-6989586621682533723"><span class="hs-identifier">fn</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-2010"></a><span>                            </span><span class="hs-identifier">ru_act</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533724"><a href="#local-6989586621682533724"><span class="hs-identifier">act</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533725"><a href="#local-6989586621682533725"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-2011"></a><span>                            </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533726"><a href="#local-6989586621682533726"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533727"><a href="#local-6989586621682533727"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-2012"></a><span>                            </span><span class="hs-identifier">ru_orphan</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533728"><a href="#local-6989586621682533728"><span class="hs-identifier">orph</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_auto</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682533729"><a href="#local-6989586621682533729"><span class="hs-identifier">auto</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2013"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceRule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifRuleName</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533722"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifActivation</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533724"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">,</span><span>
</span><a name="line-2014"></a><span>                </span><span class="hs-identifier">ifRuleBndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toIfaceBndr</span><span> </span><a href="#local-6989586621682533725"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-2015"></a><span>                </span><span class="hs-identifier">ifRuleHead</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533723"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">,</span><span>
</span><a name="line-2016"></a><span>                </span><span class="hs-identifier">ifRuleArgs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682533730"><span class="hs-identifier hs-var">do_arg</span></a><span> </span><a href="#local-6989586621682533726"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span>
</span><a name="line-2017"></a><span>                </span><span class="hs-identifier">ifRuleRhs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceExpr</span><span> </span><a href="#local-6989586621682533727"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span>
</span><a name="line-2018"></a><span>                </span><span class="hs-identifier">ifRuleAuto</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533729"><span class="hs-identifier hs-var">auto</span></a><span class="hs-special">,</span><span>
</span><a name="line-2019"></a><span>                </span><span class="hs-identifier">ifRuleOrph</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533728"><span class="hs-identifier hs-var">orph</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2020"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2021"></a><span>        </span><span class="hs-comment">-- For type args we must remove synonyms from the outermost</span><span>
</span><a name="line-2022"></a><span>        </span><span class="hs-comment">-- level.  Reason: so that when we read it back in we'll</span><span>
</span><a name="line-2023"></a><span>        </span><span class="hs-comment">-- construct the same ru_rough field as we have right now;</span><span>
</span><a name="line-2024"></a><span>        </span><span class="hs-comment">-- see tcIfaceRule</span><span>
</span><a name="line-2025"></a><span>    </span><a name="local-6989586621682533730"><a href="#local-6989586621682533730"><span class="hs-identifier">do_arg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><a name="local-6989586621682533731"><a href="#local-6989586621682533731"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toIfaceType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deNoteType</span><span> </span><a href="#local-6989586621682533731"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2026"></a><span>    </span><span class="hs-identifier">do_arg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Coercion</span><span> </span><a name="local-6989586621682533732"><a href="#local-6989586621682533732"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceCo</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toIfaceCoercion</span><span> </span><a href="#local-6989586621682533732"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2027"></a><span>    </span><span class="hs-identifier">do_arg</span><span> </span><a name="local-6989586621682533733"><a href="#local-6989586621682533733"><span class="hs-identifier">arg</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toIfaceExpr</span><span> </span><a href="#local-6989586621682533733"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-2028"></a><span>
</span><a name="line-2029"></a><span class="hs-identifier">bogusIfaceRule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfaceRule</span><span>
</span><a name="line-2030"></a><a name="bogusIfaceRule"><a href="MkIface.html#bogusIfaceRule"><span class="hs-identifier">bogusIfaceRule</span></a></a><span> </span><a name="local-6989586621682533734"><a href="#local-6989586621682533734"><span class="hs-identifier">id_name</span></a></a><span>
</span><a name="line-2031"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceRule</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ifRuleName</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;bogus&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifActivation</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NeverActive</span><span class="hs-special">,</span><span>
</span><a name="line-2032"></a><span>        </span><span class="hs-identifier">ifRuleBndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifRuleHead</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682533734"><span class="hs-identifier hs-var">id_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifRuleArgs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-2033"></a><span>        </span><span class="hs-identifier">ifRuleRhs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfaceExt</span><span> </span><a href="#local-6989586621682533734"><span class="hs-identifier hs-var">id_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ifRuleOrph</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsOrphan</span><span class="hs-special">,</span><span>
</span><a name="line-2034"></a><span>        </span><span class="hs-identifier">ifRuleAuto</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2035"></a></pre></body></html>