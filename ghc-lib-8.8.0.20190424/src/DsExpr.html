<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Desugaring expressions.
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, MultiWayIf #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">DsExpr</span><span> </span><span class="hs-special">(</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsLocalBinds"><span class="hs-identifier hs-var">dsLocalBinds</span></a><span>
</span><a name="line-14"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsValBinds"><span class="hs-identifier hs-var">dsValBinds</span></a><span class="hs-special">,</span><span> </span><a href="MatchLit.html#dsLit"><span class="hs-identifier hs-var">dsLit</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="Match.html"><span class="hs-identifier">Match</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="MatchLit.html"><span class="hs-identifier">MatchLit</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="DsBinds.html"><span class="hs-identifier">DsBinds</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="DsGRHSs.html"><span class="hs-identifier">DsGRHSs</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="DsListComp.html"><span class="hs-identifier">DsListComp</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="DsUtils.html"><span class="hs-identifier">DsUtils</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="DsArrows.html"><span class="hs-identifier">DsArrows</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="DsMonad.html"><span class="hs-identifier">DsMonad</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Check.html"><span class="hs-identifier">Check</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Check.html#checkGuardMatches"><span class="hs-identifier hs-var">checkGuardMatches</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">topNormaliseType</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="DsMeta.html"><span class="hs-identifier">DsMeta</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">-- NB: The desugarer, which straddles the source and Core worlds, sometimes</span><span>
</span><a name="line-36"></a><span class="hs-comment">--     needs to see source types</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreUtils</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkCore</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                dsLocalBinds, dsValBinds
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-identifier">dsLocalBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsLocalBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-75"></a><a name="dsLocalBinds"><a href="DsExpr.html#dsLocalBinds"><span class="hs-identifier">dsLocalBinds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EmptyLocalBinds</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><a name="local-6989586621684137065"><a href="#local-6989586621684137065"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684137065"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-76"></a><span class="hs-identifier">dsLocalBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137066"><a href="#local-6989586621684137066"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137067"><a href="#local-6989586621684137067"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137068"><a href="#local-6989586621684137068"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684137066"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-77"></a><span>                                                   </span><a href="DsExpr.html#dsValBinds"><span class="hs-identifier hs-var">dsValBinds</span></a><span> </span><a href="#local-6989586621684137067"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684137068"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-78"></a><span class="hs-identifier">dsLocalBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPBinds</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137069"><a href="#local-6989586621684137069"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><a name="local-6989586621684137070"><a href="#local-6989586621684137070"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsIPBinds"><span class="hs-identifier hs-var">dsIPBinds</span></a><span>  </span><a href="#local-6989586621684137069"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684137070"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-79"></a><span class="hs-identifier">dsLocalBinds</span><span> </span><span class="hs-identifier">_</span><span>                                </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsLocalBinds&quot;</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- caller sets location</span><span>
</span><a name="line-83"></a><span class="hs-identifier">dsValBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsValBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-84"></a><a name="dsValBinds"><a href="DsExpr.html#dsValBinds"><span class="hs-identifier">dsValBinds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XValBindsLR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NValBinds</span><span> </span><a name="local-6989586621684137071"><a href="#local-6989586621684137071"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137072"><a href="#local-6989586621684137072"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-85"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrM</span><span> </span><a href="DsExpr.html#ds_val_bind"><span class="hs-identifier hs-var">ds_val_bind</span></a><span> </span><a href="#local-6989586621684137072"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621684137071"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-86"></a><span class="hs-identifier">dsValBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ValBinds</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsValBinds ValBindsIn&quot;</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-89"></a><span class="hs-identifier">dsIPBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsIPBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-90"></a><a name="dsIPBinds"><a href="DsExpr.html#dsIPBinds"><span class="hs-identifier">dsIPBinds</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPBinds</span><span> </span><a name="local-6989586621684137073"><a href="#local-6989586621684137073"><span class="hs-identifier">ev_binds</span></a></a><span> </span><a name="local-6989586621684137074"><a href="#local-6989586621684137074"><span class="hs-identifier">ip_binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137075"><a href="#local-6989586621684137075"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-91"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137081"><a href="#local-6989586621684137081"><span class="hs-identifier">ds_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsTcEvBinds"><span class="hs-identifier hs-var">dsTcEvBinds</span></a><span> </span><a href="#local-6989586621684137073"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-92"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137082"><a href="#local-6989586621684137082"><span class="hs-identifier">inner</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCoreLets</span><span> </span><a href="#local-6989586621684137081"><span class="hs-identifier hs-var">ds_binds</span></a><span> </span><a href="#local-6989586621684137075"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-93"></a><span>                </span><span class="hs-comment">-- The dict bindings may not be in</span><span>
</span><a name="line-94"></a><span>                </span><span class="hs-comment">-- dependency order; hence Rec</span><span>
</span><a name="line-95"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">foldrM</span><span> </span><a href="#local-6989586621684137076"><span class="hs-identifier hs-var">ds_ip_bind</span></a><span> </span><a href="#local-6989586621684137082"><span class="hs-identifier hs-var">inner</span></a><span> </span><a href="#local-6989586621684137074"><span class="hs-identifier hs-var">ip_binds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-96"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>    </span><a name="local-6989586621684137076"><a href="#local-6989586621684137076"><span class="hs-identifier">ds_ip_bind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IPBind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">~</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621684137077"><a href="#local-6989586621684137077"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137078"><a href="#local-6989586621684137078"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137079"><a href="#local-6989586621684137079"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-98"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684137080"><a href="#local-6989586621684137080"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137078"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-99"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRec</span><span> </span><a href="#local-6989586621684137077"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684137080"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137079"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-identifier">ds_ip_bind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsIPBinds&quot;</span><span>
</span><a name="line-101"></a><span class="hs-identifier">dsIPBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XHsIPBinds</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsIPBinds&quot;</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- caller sets location</span><span>
</span><a name="line-105"></a><span class="hs-identifier">ds_val_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- Special case for bindings which bind unlifted variables</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- We need to do a case right away, rather than building</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- a tuple and doing selections.</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- Silently ignore INLINE and SPECIALISE pragmas...</span><span>
</span><a name="line-110"></a><a name="ds_val_bind"><a href="DsExpr.html#ds_val_bind"><span class="hs-identifier">ds_val_bind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRecursive</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684137083"><a href="#local-6989586621684137083"><span class="hs-identifier">hsbinds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137084"><a href="#local-6989586621684137084"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137092"><a href="#local-6989586621684137092"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621684137093"><a href="#local-6989586621684137093"><span class="hs-identifier">bind</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621684137083"><span class="hs-identifier hs-var">hsbinds</span></a><span>
</span><a name="line-112"></a><span>        </span><span class="hs-comment">-- Non-recursive, non-overloaded bindings only come in ones</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-comment">-- ToDo: in some bizarre case it's conceivable that there</span><span>
</span><a name="line-114"></a><span>        </span><span class="hs-comment">--       could be dict binds in the 'binds'.  (See the notes</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-comment">--       below.  Then pattern-match would fail.  Urk.)</span><span>
</span><a name="line-116"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isUnliftedHsBind</span><span> </span><a href="#local-6989586621684137093"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-117"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684137092"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-118"></a><span>     </span><span class="hs-comment">-- see Note [Strict binds checks] in DsBinds</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684137085"><span class="hs-identifier hs-var">is_polymorphic</span></a><span> </span><a href="#local-6989586621684137093"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-120"></a><span>    </span><span class="hs-keyword">then</span><span> </span><a href="DsMonad.html#errDsCoreExpr"><span class="hs-identifier hs-var">errDsCoreExpr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137087"><span class="hs-identifier hs-var">poly_bind_err</span></a><span> </span><a href="#local-6989586621684137093"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>            </span><span class="hs-comment">-- data Ptr a = Ptr Addr#</span><span>
</span><a name="line-122"></a><span>            </span><span class="hs-comment">-- f x = let p@(Ptr y) = ... in ...</span><span>
</span><a name="line-123"></a><span>            </span><span class="hs-comment">-- Here the binding for 'p' is polymorphic, but does</span><span>
</span><a name="line-124"></a><span>            </span><span class="hs-comment">-- not mix with an unlifted binding for 'y'.  You should</span><span>
</span><a name="line-125"></a><span>            </span><span class="hs-comment">-- use a bang pattern.  Trac #6078.</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">looksLazyPatBind</span><span> </span><a href="#local-6989586621684137093"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-128"></a><span>              </span><a href="DsMonad.html#warnIfSetDs"><span class="hs-identifier hs-var">warnIfSetDs</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnUnbangedStrictPatterns</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137086"><span class="hs-identifier hs-var">unlifted_must_be_bang</span></a><span> </span><a href="#local-6989586621684137093"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-comment">-- Complain about a binding that looks lazy</span><span>
</span><a name="line-130"></a><span>        </span><span class="hs-comment">--    e.g.    let I# y = x in ...</span><span>
</span><a name="line-131"></a><span>        </span><span class="hs-comment">-- Remember, in checkStrictBinds we are going to do strict</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-comment">-- matching, so (for software engineering reasons) we insist</span><span>
</span><a name="line-133"></a><span>        </span><span class="hs-comment">-- that the strictness is manifest on each binding</span><span>
</span><a name="line-134"></a><span>        </span><span class="hs-comment">-- However, lone (unboxed) variables are ok</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsUnliftedBind"><span class="hs-identifier hs-var">dsUnliftedBind</span></a><span> </span><a href="#local-6989586621684137093"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621684137084"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-138"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-139"></a><span>    </span><a name="local-6989586621684137085"><a href="#local-6989586621684137085"><span class="hs-identifier">is_polymorphic</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AbsBinds</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abs_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137088"><a href="#local-6989586621684137088"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_vars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137089"><a href="#local-6989586621684137089"><span class="hs-identifier">evs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137088"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137089"><span class="hs-identifier hs-var">evs</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-identifier">is_polymorphic</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span>    </span><a name="local-6989586621684137086"><a href="#local-6989586621684137086"><span class="hs-identifier">unlifted_must_be_bang</span></a></a><span> </span><a name="local-6989586621684137090"><a href="#local-6989586621684137090"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-144"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Pattern bindings containing unlifted types should use&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-145"></a><span>              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;an outermost bang pattern:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>           </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137090"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span>    </span><a name="local-6989586621684137087"><a href="#local-6989586621684137087"><span class="hs-identifier">poly_bind_err</span></a></a><span> </span><a name="local-6989586621684137091"><a href="#local-6989586621684137091"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-149"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;You can't mix polymorphic and unlifted bindings:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>           </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137091"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Probable fix: add a type signature&quot;</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-identifier">ds_val_bind</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137094"><a href="#local-6989586621684137094"><span class="hs-identifier">is_rec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137095"><a href="#local-6989586621684137095"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137096"><a href="#local-6989586621684137096"><span class="hs-identifier">_body</span></a></a><span>
</span><a name="line-154"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">anyBag</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnliftedHsBind</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137095"><span class="hs-identifier hs-var">binds</span></a><span>  </span><span class="hs-comment">-- see Note [Strict binds checks] in DsBinds</span><span>
</span><a name="line-155"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isRec</span><span> </span><span class="hs-identifier">is_rec</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span>    </span><a href="DsMonad.html#errDsCoreExpr"><span class="hs-identifier hs-var">errDsCoreExpr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-157"></a><span>    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Recursive bindings for unlifted types aren't allowed:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621684137095"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-comment">-- Ordinary case for bindings; none should be unlifted</span><span>
</span><a name="line-161"></a><span class="hs-identifier">ds_val_bind</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137097"><a href="#local-6989586621684137097"><span class="hs-identifier">is_rec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137098"><a href="#local-6989586621684137098"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137099"><a href="#local-6989586621684137099"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-162"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isRec</span><span> </span><span class="hs-identifier">is_rec</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">isSingletonBag</span><span> </span><span class="hs-identifier hs-var">binds</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>               </span><span class="hs-comment">-- we should never produce a non-recursive list of multiple binds</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137100"><a href="#local-6989586621684137100"><span class="hs-identifier">force_vars</span></a></a><span class="hs-special">,</span><a name="local-6989586621684137101"><a href="#local-6989586621684137101"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsLHsBinds"><span class="hs-identifier hs-var">dsLHsBinds</span></a><span> </span><a href="#local-6989586621684137098"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-166"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137102"><a href="#local-6989586621684137102"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="DsUtils.html#seqVar"><span class="hs-identifier hs-var">seqVar</span></a><span> </span><a href="#local-6989586621684137099"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621684137100"><span class="hs-identifier hs-var">force_vars</span></a><span>
</span><a name="line-167"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isUnliftedType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">fst</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">prs</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">is_rec</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">binds</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684137101"><span class="hs-identifier hs-var">prs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-169"></a><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684137099"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-170"></a><span>            </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Rec</span><span> </span><a href="#local-6989586621684137101"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137102"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-comment">-- Use a Rec regardless of is_rec.</span><span>
</span><a name="line-172"></a><span>        </span><span class="hs-comment">-- Why? Because it allows the binds to be all</span><span>
</span><a name="line-173"></a><span>        </span><span class="hs-comment">-- mixed up, which is what happens in one rare case</span><span>
</span><a name="line-174"></a><span>        </span><span class="hs-comment">-- Namely, for an AbsBind with no tyvars and no dicts,</span><span>
</span><a name="line-175"></a><span>        </span><span class="hs-comment">--         but which does have dictionary bindings.</span><span>
</span><a name="line-176"></a><span>        </span><span class="hs-comment">-- See notes with TcSimplify.inferLoop [NO TYVARS]</span><span>
</span><a name="line-177"></a><span>        </span><span class="hs-comment">-- It turned out that wrapping a Rec here was the easiest solution</span><span>
</span><a name="line-178"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-179"></a><span>        </span><span class="hs-comment">-- NB The previous case dealt with unlifted bindings, so we</span><span>
</span><a name="line-180"></a><span>        </span><span class="hs-comment">--    only have to deal with lifted ones now; so Rec is ok</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-183"></a><span class="hs-identifier">dsUnliftedBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsBind</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-184"></a><a name="dsUnliftedBind"><a href="DsExpr.html#dsUnliftedBind"><span class="hs-identifier">dsUnliftedBind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AbsBinds</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">abs_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_vars</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-185"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_exports</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137103"><a href="#local-6989586621684137103"><span class="hs-identifier">exports</span></a></a><span>
</span><a name="line-186"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137104"><a href="#local-6989586621684137104"><span class="hs-identifier">ev_binds</span></a></a><span>
</span><a name="line-187"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">abs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137105"><a href="#local-6989586621684137105"><span class="hs-identifier">lbinds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137106"><a href="#local-6989586621684137106"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-188"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137107"><a href="#local-6989586621684137107"><span class="hs-identifier">body1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621684137108"><span class="hs-identifier hs-var">bind_export</span></a><span> </span><a href="#local-6989586621684137106"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621684137103"><span class="hs-identifier hs-var">exports</span></a><span>
</span><a name="line-189"></a><span>             </span><a name="local-6989586621684137108"><a href="#local-6989586621684137108"><span class="hs-identifier">bind_export</span></a></a><span> </span><span class="hs-keyword">export</span><span> </span><a name="local-6989586621684137110"><a href="#local-6989586621684137110"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">abe_poly</span><span> </span><span class="hs-keyword">export</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">abe_mono</span><span> </span><span class="hs-keyword">export</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137110"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-190"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137113"><a href="#local-6989586621684137113"><span class="hs-identifier">body2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldlBagM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684137111"><a href="#local-6989586621684137111"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621684137112"><a href="#local-6989586621684137112"><span class="hs-identifier">lbind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsExpr.html#dsUnliftedBind"><span class="hs-identifier hs-var">dsUnliftedBind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684137112"><span class="hs-identifier hs-var">lbind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137111"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>                            </span><a href="#local-6989586621684137107"><span class="hs-identifier hs-var">body1</span></a><span> </span><a href="#local-6989586621684137105"><span class="hs-identifier hs-var">lbinds</span></a><span>
</span><a name="line-192"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137114"><a href="#local-6989586621684137114"><span class="hs-identifier">ds_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsTcEvBinds_s"><span class="hs-identifier hs-var">dsTcEvBinds_s</span></a><span> </span><a href="#local-6989586621684137104"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-193"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCoreLets</span><span> </span><a href="#local-6989586621684137114"><span class="hs-identifier hs-var">ds_binds</span></a><span> </span><a href="#local-6989586621684137113"><span class="hs-identifier hs-var">body2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-identifier">dsUnliftedBind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_id</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137115"><a href="#local-6989586621684137115"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621684137116"><a href="#local-6989586621684137116"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137117"><a href="#local-6989586621684137117"><span class="hs-identifier">matches</span></a></a><span>
</span><a name="line-197"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_co_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137118"><a href="#local-6989586621684137118"><span class="hs-identifier">co_fn</span></a></a><span>
</span><a name="line-198"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fun_tick</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137119"><a href="#local-6989586621684137119"><span class="hs-identifier">tick</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137120"><a href="#local-6989586621684137120"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-199"></a><span>               </span><span class="hs-comment">-- Can't be a bang pattern (that looks like a PatBind)</span><span>
</span><a name="line-200"></a><span>               </span><span class="hs-comment">-- so must be simply unboxed</span><span>
</span><a name="line-201"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137121"><a href="#local-6989586621684137121"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137122"><a href="#local-6989586621684137122"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchWrapper"><span class="hs-identifier hs-var">matchWrapper</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPrefixFunRhs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684137115"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684137116"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>                                     </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684137117"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-203"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Functions aren't lifted</span><span>
</span><a name="line-204"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isIdHsWrapper</span><span> </span><span class="hs-identifier hs-var">co_fn</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137123"><a href="#local-6989586621684137123"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkOptTickBox"><span class="hs-identifier hs-var">mkOptTickBox</span></a><span> </span><a href="#local-6989586621684137119"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="#local-6989586621684137122"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-206"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><a href="#local-6989586621684137116"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621684137123"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621684137120"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-identifier">dsUnliftedBind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatBind</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">pat_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137124"><a href="#local-6989586621684137124"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137125"><a href="#local-6989586621684137125"><span class="hs-identifier">grhss</span></a></a><span>
</span><a name="line-209"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NPatBindTc</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137126"><a href="#local-6989586621684137126"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137127"><a href="#local-6989586621684137127"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-210"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- let C x# y# = rhs in body</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-comment">-- ==&gt; case rhs of C x# y# -&gt; body</span><span>
</span><a name="line-212"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137128"><a href="#local-6989586621684137128"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsGRHSs.html#dsGuarded"><span class="hs-identifier hs-var">dsGuarded</span></a><span> </span><a href="#local-6989586621684137125"><span class="hs-identifier hs-var">grhss</span></a><span> </span><a href="#local-6989586621684137126"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-213"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Check.html#checkGuardMatches"><span class="hs-identifier hs-var">checkGuardMatches</span></a><span> </span><span class="hs-identifier hs-var">PatBindGuards</span><span> </span><a href="#local-6989586621684137125"><span class="hs-identifier hs-var">grhss</span></a><span>
</span><a name="line-214"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137129"><a href="#local-6989586621684137129"><span class="hs-identifier">upat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621684137124"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-215"></a><span>             </span><a name="local-6989586621684137130"><a href="#local-6989586621684137130"><span class="hs-identifier">eqn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#EqnInfo"><span class="hs-identifier hs-var">EqnInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137129"><span class="hs-identifier hs-var">upat</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-216"></a><span>                             </span><span class="hs-identifier">eqn_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FromSource</span><span class="hs-special">,</span><span>
</span><a name="line-217"></a><span>                             </span><span class="hs-identifier">eqn_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#cantFailMatchResult"><span class="hs-identifier hs-var">cantFailMatchResult</span></a><span> </span><a href="#local-6989586621684137127"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-218"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137131"><a href="#local-6989586621684137131"><span class="hs-identifier">var</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#selectMatchVar"><span class="hs-identifier hs-var">selectMatchVar</span></a><span> </span><a href="#local-6989586621684137129"><span class="hs-identifier hs-var">upat</span></a><span>
</span><a name="line-219"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137132"><a href="#local-6989586621684137132"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchEquations"><span class="hs-identifier hs-var">matchEquations</span></a><span> </span><span class="hs-identifier hs-var">PatBindRhs</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137131"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137130"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684137127"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><a href="#local-6989586621684137131"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684137128"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684137132"><span class="hs-identifier hs-var">result</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">dsUnliftedBind</span><span> </span><a name="local-6989586621684137133"><a href="#local-6989586621684137133"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621684137134"><a href="#local-6989586621684137134"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;dsLet: unlifted&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137133"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137134"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[DsExpr-vars-and-cons]{Variables, constructors, literals}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-identifier">dsLExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><a name="dsLExpr"><a href="DsExpr.html#dsLExpr"><span class="hs-identifier">dsLExpr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137135"><a href="#local-6989586621684137135"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621684137136"><a href="#local-6989586621684137136"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-235"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684137135"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-236"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137137"><a href="#local-6989586621684137137"><span class="hs-identifier">core_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684137136"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-237"></a><span>   </span><span class="hs-comment">-- uncomment this check to test the hsExprType function in TcHsSyn</span><span>
</span><a name="line-238"></a><span>   </span><span class="hs-comment">--    ; MASSERT2( exprType core_expr `eqType` hsExprType e</span><span>
</span><a name="line-239"></a><span>   </span><span class="hs-comment">--              , ppr e &lt;+&gt; dcolon &lt;+&gt; ppr (hsExprType e) $$</span><span>
</span><a name="line-240"></a><span>   </span><span class="hs-comment">--                ppr core_expr &lt;+&gt; dcolon &lt;+&gt; ppr (exprType core_expr) )</span><span>
</span><a name="line-241"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684137137"><span class="hs-identifier hs-var">core_expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-comment">-- | Variant of 'dsLExpr' that ensures that the result is not levity</span><span>
</span><a name="line-244"></a><span class="hs-comment">-- polymorphic. This should be used when the resulting expression will</span><span>
</span><a name="line-245"></a><span class="hs-comment">-- be an argument to some other function.</span><span>
</span><a name="line-246"></a><span class="hs-comment">-- See Note [Levity polymorphism checking] in DsMonad</span><span>
</span><a name="line-247"></a><span class="hs-comment">-- See Note [Levity polymorphism invariants] in CoreSyn</span><span>
</span><a name="line-248"></a><span class="hs-identifier">dsLExprNoLP</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-249"></a><a name="dsLExprNoLP"><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier">dsLExprNoLP</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137138"><a href="#local-6989586621684137138"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621684137139"><a href="#local-6989586621684137139"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684137138"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-251"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137140"><a href="#local-6989586621684137140"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684137139"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-252"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsMonad.html#dsNoLevPolyExpr"><span class="hs-identifier hs-var">dsNoLevPolyExpr</span></a><span> </span><a href="#local-6989586621684137140"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the type of expression:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137139"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684137140"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span class="hs-identifier">dsExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-256"></a><a name="dsExpr"><a href="DsExpr.html#dsExpr"><span class="hs-identifier">dsExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#ds_expr"><span class="hs-identifier hs-var">ds_expr</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>   </span><span class="hs-comment">-- are we directly inside an HsWrap?</span><span>
</span><a name="line-259"></a><span>                  </span><span class="hs-comment">-- See Wrinkle in Note [Detecting forced eta expansion]</span><span>
</span><a name="line-260"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-261"></a><a name="ds_expr"><a href="DsExpr.html#ds_expr"><span class="hs-identifier">ds_expr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsPar</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137141"><a href="#local-6989586621684137141"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137141"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-262"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExprWithTySig</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137142"><a href="#local-6989586621684137142"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137142"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-263"></a><span class="hs-identifier">ds_expr</span><span> </span><a name="local-6989586621684137143"><a href="#local-6989586621684137143"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137144"><a href="#local-6989586621684137144"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsHsVar"><span class="hs-identifier hs-var">dsHsVar</span></a><span> </span><a href="#local-6989586621684137143"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621684137144"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-264"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsUnboundVar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr: HsUnboundVar&quot;</span><span> </span><span class="hs-comment">-- Typechecker eliminates them</span><span>
</span><a name="line-265"></a><span class="hs-identifier">ds_expr</span><span> </span><a name="local-6989586621684137145"><a href="#local-6989586621684137145"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsConLikeOut</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137146"><a href="#local-6989586621684137146"><span class="hs-identifier">con</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsConLike"><span class="hs-identifier hs-var">dsConLike</span></a><span> </span><a href="#local-6989586621684137145"><span class="hs-identifier hs-var">w</span></a><span> </span><a href="#local-6989586621684137146"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-266"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIPVar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr: HsIPVar&quot;</span><span>
</span><a name="line-267"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLabel</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr: HsOverLabel&quot;</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLit</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137147"><a href="#local-6989586621684137147"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="MatchLit.html#warnAboutOverflowedLit"><span class="hs-identifier hs-var">warnAboutOverflowedLit</span></a><span> </span><a href="#local-6989586621684137147"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-271"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="MatchLit.html#dsLit"><span class="hs-identifier hs-var">dsLit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">convertLit</span><span> </span><a href="#local-6989586621684137147"><span class="hs-identifier hs-var">lit</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137148"><a href="#local-6989586621684137148"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="MatchLit.html#warnAboutOverflowedOverLit"><span class="hs-identifier hs-var">warnAboutOverflowedOverLit</span></a><span> </span><a href="#local-6989586621684137148"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-275"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="MatchLit.html#dsOverLit"><span class="hs-identifier hs-var">dsOverLit</span></a><span> </span><a href="#local-6989586621684137148"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWrap</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137149"><a href="#local-6989586621684137149"><span class="hs-identifier">co_fn</span></a></a><span> </span><a name="local-6989586621684137150"><a href="#local-6989586621684137150"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137151"><a href="#local-6989586621684137151"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#ds_expr"><span class="hs-identifier hs-var">ds_expr</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621684137150"><span class="hs-identifier hs-var">e</span></a><span>    </span><span class="hs-comment">-- This is the one place where we recurse to</span><span>
</span><a name="line-279"></a><span>                                 </span><span class="hs-comment">-- ds_expr (passing True), rather than dsExpr</span><span>
</span><a name="line-280"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137152"><a href="#local-6989586621684137152"><span class="hs-identifier">wrap'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684137149"><span class="hs-identifier hs-var">co_fn</span></a><span>
</span><a name="line-281"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137153"><a href="#local-6989586621684137153"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-282"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137154"><a href="#local-6989586621684137154"><span class="hs-identifier">wrapped_e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137152"><span class="hs-identifier hs-var">wrap'</span></a><span> </span><a href="#local-6989586621684137151"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-283"></a><span>             </span><a name="local-6989586621684137155"><a href="#local-6989586621684137155"><span class="hs-identifier">wrapped_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684137154"><span class="hs-identifier hs-var">wrapped_e</span></a><span>
</span><a name="line-284"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#checkForcedEtaExpansion"><span class="hs-identifier hs-var">checkForcedEtaExpansion</span></a><span> </span><a href="#local-6989586621684137150"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684137155"><span class="hs-identifier hs-var">wrapped_ty</span></a><span> </span><span class="hs-comment">-- See Note [Detecting forced eta expansion]</span><span>
</span><a name="line-285"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="MatchLit.html#warnAboutIdentities"><span class="hs-identifier hs-var">warnAboutIdentities</span></a><span> </span><a href="#local-6989586621684137153"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684137151"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-6989586621684137155"><span class="hs-identifier hs-var">wrapped_ty</span></a><span>
</span><a name="line-286"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684137154"><span class="hs-identifier hs-var">wrapped_e</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NegApp</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137156"><a href="#local-6989586621684137156"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-289"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsOverLit</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137157"><a href="#local-6989586621684137157"><span class="hs-identifier">lit</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">OverLit</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ol_val</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsIntegral</span><span> </span><a name="local-6989586621684137158"><a href="#local-6989586621684137158"><span class="hs-identifier">i</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>                  </span><a name="local-6989586621684137159"><a href="#local-6989586621684137159"><span class="hs-identifier">neg_expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137160"><a href="#local-6989586621684137160"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684137156"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-292"></a><span>          </span><span class="hs-special">{</span><span> </span><a href="MatchLit.html#warnAboutOverflowedOverLit"><span class="hs-identifier hs-var">warnAboutOverflowedOverLit</span></a><span>
</span><a name="line-293"></a><span>              </span><span class="hs-special">(</span><a href="#local-6989586621684137157"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ol_val</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">HsIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">negateIntegralLit</span><span> </span><a href="#local-6989586621684137158"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-294"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="MatchLit.html#dsOverLit"><span class="hs-identifier hs-var">dsOverLit</span></a><span> </span><a href="#local-6989586621684137157"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-295"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137159"><span class="hs-identifier hs-var">neg_expr</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137160"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NegApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137161"><a href="#local-6989586621684137161"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684137162"><a href="#local-6989586621684137162"><span class="hs-identifier">neg_expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137163"><a href="#local-6989586621684137163"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137161"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-299"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137162"><span class="hs-identifier hs-var">neg_expr</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137163"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLam</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137164"><a href="#local-6989586621684137164"><span class="hs-identifier">a_Match</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">uncurry</span><span> </span><span class="hs-identifier hs-var">mkLams</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Match.html#matchWrapper"><span class="hs-identifier hs-var">matchWrapper</span></a><span> </span><span class="hs-identifier hs-var">LambdaExpr</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684137164"><span class="hs-identifier hs-var">a_Match</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLamCase</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137165"><a href="#local-6989586621684137165"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621684137166"><a href="#local-6989586621684137166"><span class="hs-identifier">discrim_var</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684137167"><a href="#local-6989586621684137167"><span class="hs-identifier">matching_code</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchWrapper"><span class="hs-identifier hs-var">matchWrapper</span></a><span> </span><span class="hs-identifier hs-var">CaseAlt</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684137165"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-306"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684137166"><span class="hs-identifier hs-var">discrim_var</span></a><span> </span><a href="#local-6989586621684137167"><span class="hs-identifier hs-var">matching_code</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137168"><a href="#local-6989586621684137168"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137169"><a href="#local-6989586621684137169"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621684137170"><a href="#local-6989586621684137170"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137171"><a href="#local-6989586621684137171"><span class="hs-identifier">fun'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137169"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-310"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier hs-var">dsWhenNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137170"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684137172"><a href="#local-6989586621684137172"><span class="hs-identifier">arg'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#mkCoreAppDs"><span class="hs-identifier hs-var">mkCoreAppDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;HsApp&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137168"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137171"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621684137172"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-312"></a><span>
</span><a name="line-313"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsAppType</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137173"><a href="#local-6989586621684137173"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-comment">-- ignore type arguments here; they're in the wrappers instead at this point</span><span>
</span><a name="line-315"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137173"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-comment">{-
Note [Desugaring vars]
~~~~~~~~~~~~~~~~~~~~~~
In one situation we can get a *coercion* variable in a HsVar, namely
the support method for an equality superclass:
   class (a~b) =&gt; C a b where ...
   instance (blah) =&gt; C (T a) (T b) where ..
Then we get
   $dfCT :: forall ab. blah =&gt; C (T a) (T b)
   $dfCT ab blah = MkC ($c$p1C a blah) ($cop a blah)

   $c$p1C :: forall ab. blah =&gt; (T a ~ T b)
   $c$p1C ab blah = let ...; g :: T a ~ T b = ... } in g

That 'g' in the 'in' part is an evidence variable, and when
converting to core it must become a CO.

Operator sections.  At first it looks as if we can convert
\begin{verbatim}
        (expr op)
\end{verbatim}
to
\begin{verbatim}
        \x -&gt; op expr x
\end{verbatim}

But no!  expr might be a redex, and we can lose laziness badly this
way.  Consider
\begin{verbatim}
        map (expr op) xs
\end{verbatim}
for example.  So we convert instead to
\begin{verbatim}
        let y = expr in \x -&gt; op y x
\end{verbatim}
If \tr{expr} is actually just a variable, say, then the simplifier
will sort it out.
-}</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137174"><a href="#local-6989586621684137174"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">OpApp</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137175"><a href="#local-6989586621684137175"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684137176"><a href="#local-6989586621684137176"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621684137177"><a href="#local-6989586621684137177"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- for the type of y, we need the type of op's 2nd argument</span><span>
</span><a name="line-358"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137178"><a href="#local-6989586621684137178"><span class="hs-identifier">op'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137176"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-359"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier hs-var">dsWhenNoErrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137175"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137177"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684137179"><a href="#local-6989586621684137179"><span class="hs-identifier">exprs'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#mkCoreAppsDs"><span class="hs-identifier hs-var">mkCoreAppsDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;opapp&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137174"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137178"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621684137179"><span class="hs-identifier hs-var">exprs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionL</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137180"><a href="#local-6989586621684137180"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684137181"><a href="#local-6989586621684137181"><span class="hs-identifier">op</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- Desugar (e !) to ((!) e)</span><span>
</span><a name="line-363"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137182"><a href="#local-6989586621684137182"><span class="hs-identifier">op'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137181"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-364"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier hs-var">dsWhenNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137180"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684137183"><a href="#local-6989586621684137183"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#mkCoreAppDs"><span class="hs-identifier hs-var">mkCoreAppDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;sectionl&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137180"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137182"><span class="hs-identifier hs-var">op'</span></a><span> </span><a href="#local-6989586621684137183"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-comment">-- dsLExpr (SectionR op expr)   -- \ x -&gt; op x expr</span><span>
</span><a name="line-368"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137184"><a href="#local-6989586621684137184"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">SectionR</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137185"><a href="#local-6989586621684137185"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621684137186"><a href="#local-6989586621684137186"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-369"></a><span>    </span><a name="local-6989586621684137187"><a href="#local-6989586621684137187"><span class="hs-identifier">core_op</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137185"><span class="hs-identifier hs-var">op</span></a><span>
</span><a name="line-370"></a><span>    </span><span class="hs-comment">-- for the type of x, we need the type of op's 2nd argument</span><span>
</span><a name="line-371"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137188"><a href="#local-6989586621684137188"><span class="hs-identifier">x_ty</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684137189"><a href="#local-6989586621684137189"><span class="hs-identifier">y_ty</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitFunTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684137187"><span class="hs-identifier hs-var">core_op</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>        </span><span class="hs-comment">-- See comment with SectionL</span><span>
</span><a name="line-373"></a><span>    </span><a name="local-6989586621684137190"><a href="#local-6989586621684137190"><span class="hs-identifier">y_core</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137186"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-374"></a><span>    </span><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier hs-var">dsWhenNoErrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137188"><span class="hs-identifier hs-var">x_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137189"><span class="hs-identifier hs-var">y_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>                 </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">[</span><a name="local-6989586621684137191"><a href="#local-6989586621684137191"><span class="hs-identifier">x_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137192"><a href="#local-6989586621684137192"><span class="hs-identifier">y_id</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><a href="#local-6989586621684137192"><span class="hs-identifier hs-var">y_id</span></a><span> </span><a href="#local-6989586621684137190"><span class="hs-identifier hs-var">y_core</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-376"></a><span>                                   </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684137191"><span class="hs-identifier hs-var">x_id</span></a><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkCoreAppsDs"><span class="hs-identifier hs-var">mkCoreAppsDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;sectionr&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137184"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-377"></a><span>                                                          </span><a href="#local-6989586621684137187"><span class="hs-identifier hs-var">core_op</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684137191"><span class="hs-identifier hs-var">x_id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684137192"><span class="hs-identifier hs-var">y_id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitTuple</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137193"><a href="#local-6989586621684137193"><span class="hs-identifier">tup_args</span></a></a><span> </span><a name="local-6989586621684137194"><a href="#local-6989586621684137194"><span class="hs-identifier">boxity</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137195"><a href="#local-6989586621684137195"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684137196"><a href="#local-6989586621684137196"><span class="hs-identifier">lam_vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137197"><a href="#local-6989586621684137197"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Missing</span><span> </span><a name="local-6989586621684137198"><a href="#local-6989586621684137198"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>                    </span><span class="hs-comment">-- For every missing expression, we need</span><span>
</span><a name="line-382"></a><span>                    </span><span class="hs-comment">-- another lambda in the desugaring.</span><span>
</span><a name="line-383"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137199"><a href="#local-6989586621684137199"><span class="hs-identifier">lam_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDsNoLP"><span class="hs-identifier hs-var">newSysLocalDsNoLP</span></a><span> </span><a href="#local-6989586621684137198"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-384"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137199"><span class="hs-identifier hs-var">lam_var</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684137196"><span class="hs-identifier hs-var">lam_vars</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684137199"><span class="hs-identifier hs-var">lam_var</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684137197"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-385"></a><span>             </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137200"><a href="#local-6989586621684137200"><span class="hs-identifier">lam_vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137201"><a href="#local-6989586621684137201"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Present</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137202"><a href="#local-6989586621684137202"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>                    </span><span class="hs-comment">-- Expressions that are present don't generate</span><span>
</span><a name="line-387"></a><span>                    </span><span class="hs-comment">-- lambdas, just arguments.</span><span>
</span><a name="line-388"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137203"><a href="#local-6989586621684137203"><span class="hs-identifier">core_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137202"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-389"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137200"><span class="hs-identifier hs-var">lam_vars</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137203"><span class="hs-identifier hs-var">core_expr</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684137201"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-390"></a><span>             </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;ds_expr&quot;</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier hs-var">dsWhenNoErrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621684137195"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684137193"><span class="hs-identifier hs-var">tup_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>                </span><span class="hs-comment">-- The reverse is because foldM goes left-to-right</span><span>
</span><a name="line-394"></a><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621684137204"><a href="#local-6989586621684137204"><span class="hs-identifier">lam_vars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137205"><a href="#local-6989586621684137205"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkCoreLams</span><span> </span><a href="#local-6989586621684137204"><span class="hs-identifier hs-var">lam_vars</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-395"></a><span>                                            </span><span class="hs-identifier hs-var">mkCoreTupBoxity</span><span> </span><a href="#local-6989586621684137194"><span class="hs-identifier hs-var">boxity</span></a><span> </span><a href="#local-6989586621684137205"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitSum</span><span> </span><a name="local-6989586621684137206"><a href="#local-6989586621684137206"><span class="hs-identifier">types</span></a></a><span> </span><a name="local-6989586621684137207"><a href="#local-6989586621684137207"><span class="hs-identifier">alt</span></a></a><span> </span><a name="local-6989586621684137208"><a href="#local-6989586621684137208"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621684137209"><a href="#local-6989586621684137209"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier hs-var">dsWhenNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137209"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684137210"><a href="#local-6989586621684137210"><span class="hs-identifier">core_expr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkCoreConApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sumDataCon</span><span> </span><a href="#local-6989586621684137207"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621684137208"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">getRuntimeRep</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137206"><span class="hs-identifier hs-var">types</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-401"></a><span>                                      </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684137206"><span class="hs-identifier hs-var">types</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-402"></a><span>                                      </span><span class="hs-special">[</span><a href="#local-6989586621684137210"><span class="hs-identifier hs-var">core_expr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSCC</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137211"><a href="#local-6989586621684137211"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621684137212"><a href="#local-6989586621684137212"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137213"><a href="#local-6989586621684137213"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-405"></a><span>    </span><a name="local-6989586621684137214"><a href="#local-6989586621684137214"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-406"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621684137214"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-407"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-408"></a><span>        </span><a name="local-6989586621684137215"><a href="#local-6989586621684137215"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-409"></a><span>        </span><a name="local-6989586621684137216"><a href="#local-6989586621684137216"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_ProfCountEntries</span><span>
</span><a name="line-410"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137217"><a href="#local-6989586621684137217"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sl_fs</span><span> </span><a href="#local-6989586621684137211"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-411"></a><span>        </span><a name="local-6989586621684137218"><a href="#local-6989586621684137218"><span class="hs-identifier">flavour</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ExprCC</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#getCCIndexM"><span class="hs-identifier hs-var">getCCIndexM</span></a><span> </span><a href="#local-6989586621684137217"><span class="hs-identifier hs-var">nm</span></a><span>
</span><a name="line-412"></a><span>        </span><span class="hs-identifier hs-var">Tick</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProfNote</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUserCC</span><span> </span><a href="#local-6989586621684137217"><span class="hs-identifier hs-var">nm</span></a><span> </span><a href="#local-6989586621684137215"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621684137213"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621684137218"><span class="hs-identifier hs-var">flavour</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137216"><span class="hs-identifier hs-var">count</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-413"></a><span>               </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137212"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-414"></a><span>      </span><span class="hs-keyword">else</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137212"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCoreAnn</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137219"><a href="#local-6989586621684137219"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137219"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsCase</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137220"><a href="#local-6989586621684137220"><span class="hs-identifier">discrim</span></a></a><span> </span><a name="local-6989586621684137221"><a href="#local-6989586621684137221"><span class="hs-identifier">matches</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137222"><a href="#local-6989586621684137222"><span class="hs-identifier">core_discrim</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137220"><span class="hs-identifier hs-var">discrim</span></a><span>
</span><a name="line-421"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621684137223"><a href="#local-6989586621684137223"><span class="hs-identifier">discrim_var</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684137224"><a href="#local-6989586621684137224"><span class="hs-identifier">matching_code</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchWrapper"><span class="hs-identifier hs-var">matchWrapper</span></a><span> </span><span class="hs-identifier hs-var">CaseAlt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684137220"><span class="hs-identifier hs-var">discrim</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137221"><span class="hs-identifier hs-var">matches</span></a><span>
</span><a name="line-422"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><a href="#local-6989586621684137223"><span class="hs-identifier hs-var">discrim_var</span></a><span> </span><a href="#local-6989586621684137222"><span class="hs-identifier hs-var">core_discrim</span></a><span> </span><a href="#local-6989586621684137224"><span class="hs-identifier hs-var">matching_code</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-comment">-- Pepe: The binds are in scope in the body but NOT in the binding group</span><span>
</span><a name="line-425"></a><span class="hs-comment">--       This is to avoid silliness in breakpoints</span><span>
</span><a name="line-426"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsLet</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137225"><a href="#local-6989586621684137225"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621684137226"><a href="#local-6989586621684137226"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-427"></a><span>    </span><a name="local-6989586621684137227"><a href="#local-6989586621684137227"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137226"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-428"></a><span>    </span><a href="DsExpr.html#dsLocalBinds"><span class="hs-identifier hs-var">dsLocalBinds</span></a><span> </span><a href="#local-6989586621684137225"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684137227"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span class="hs-comment">-- We need the `ListComp' form to use `deListComp' (rather than the &quot;do&quot; form)</span><span>
</span><a name="line-431"></a><span class="hs-comment">-- because the interpretation of `stmts' depends on what sort of thing it is.</span><span>
</span><a name="line-432"></a><span class="hs-comment">--</span><span>
</span><a name="line-433"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><a name="local-6989586621684137228"><a href="#local-6989586621684137228"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-identifier hs-var">ListComp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137229"><a href="#local-6989586621684137229"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsListComp.html#dsListComp"><span class="hs-identifier hs-var">dsListComp</span></a><span> </span><a href="#local-6989586621684137229"><span class="hs-identifier hs-var">stmts</span></a><span> </span><a href="#local-6989586621684137228"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-434"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">DoExpr</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137230"><a href="#local-6989586621684137230"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsDo"><span class="hs-identifier hs-var">dsDo</span></a><span> </span><a href="#local-6989586621684137230"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-435"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">GhciStmtCtxt</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137231"><a href="#local-6989586621684137231"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsDo"><span class="hs-identifier hs-var">dsDo</span></a><span> </span><a href="#local-6989586621684137231"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-436"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">MDoExpr</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137232"><a href="#local-6989586621684137232"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsDo"><span class="hs-identifier hs-var">dsDo</span></a><span> </span><a href="#local-6989586621684137232"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-437"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">MonadComp</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137233"><a href="#local-6989586621684137233"><span class="hs-identifier">stmts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsListComp.html#dsMonadComp"><span class="hs-identifier hs-var">dsMonadComp</span></a><span> </span><a href="#local-6989586621684137233"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsIf</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137234"><a href="#local-6989586621684137234"><span class="hs-identifier">mb_fun</span></a></a><span> </span><a name="local-6989586621684137235"><a href="#local-6989586621684137235"><span class="hs-identifier">guard_expr</span></a></a><span> </span><a name="local-6989586621684137236"><a href="#local-6989586621684137236"><span class="hs-identifier">then_expr</span></a></a><span> </span><a name="local-6989586621684137237"><a href="#local-6989586621684137237"><span class="hs-identifier">else_expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137238"><a href="#local-6989586621684137238"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137235"><span class="hs-identifier hs-var">guard_expr</span></a><span>
</span><a name="line-441"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137239"><a href="#local-6989586621684137239"><span class="hs-identifier">b1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137236"><span class="hs-identifier hs-var">then_expr</span></a><span>
</span><a name="line-442"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137240"><a href="#local-6989586621684137240"><span class="hs-identifier">b2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137237"><span class="hs-identifier hs-var">else_expr</span></a><span>
</span><a name="line-443"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684137234"><span class="hs-identifier hs-var">mb_fun</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-444"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684137241"><a href="#local-6989586621684137241"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137241"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137238"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137239"><span class="hs-identifier hs-var">b1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137240"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">]</span><span>
</span><a name="line-445"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkIfThenElse</span><span> </span><a href="#local-6989586621684137238"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621684137239"><span class="hs-identifier hs-var">b1</span></a><span> </span><a href="#local-6989586621684137240"><span class="hs-identifier hs-var">b2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsMultiIf</span><span> </span><a name="local-6989586621684137242"><a href="#local-6989586621684137242"><span class="hs-identifier">res_ty</span></a></a><span> </span><a name="local-6989586621684137243"><a href="#local-6989586621684137243"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137243"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-449"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137244"><span class="hs-identifier hs-var">mkErrorExpr</span></a><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-452"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137245"><a href="#local-6989586621684137245"><span class="hs-identifier">match_result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr1</span><span> </span><a href="DsUtils.html#combineMatchResults"><span class="hs-identifier hs-var">combineMatchResults</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="DsGRHSs.html#dsGRHS"><span class="hs-identifier hs-var">dsGRHS</span></a><span> </span><span class="hs-identifier hs-var">IfAlt</span><span> </span><a href="#local-6989586621684137242"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137243"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Check.html#checkGuardMatches"><span class="hs-identifier hs-var">checkGuardMatches</span></a><span> </span><span class="hs-identifier hs-var">IfAlt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GRHSs</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621684137243"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-identifier hs-var">emptyLocalBinds</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137246"><a href="#local-6989586621684137246"><span class="hs-identifier">error_expr</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137244"><span class="hs-identifier hs-var">mkErrorExpr</span></a><span>
</span><a name="line-456"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier hs-var">extractMatchResult</span></a><span> </span><a href="#local-6989586621684137245"><span class="hs-identifier hs-var">match_result</span></a><span> </span><a href="#local-6989586621684137246"><span class="hs-identifier hs-var">error_expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-457"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-458"></a><span>    </span><a name="local-6989586621684137244"><a href="#local-6989586621684137244"><span class="hs-identifier">mkErrorExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkErrorAppDs"><span class="hs-identifier hs-var">mkErrorAppDs</span></a><span> </span><span class="hs-identifier hs-var">nON_EXHAUSTIVE_GUARDS_ERROR_ID</span><span> </span><a href="#local-6989586621684137242"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-459"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;multi-way if&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-comment">{-
\noindent
\underline{\bf Various data construction things}
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-}</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><a name="local-6989586621684137247"><a href="#local-6989586621684137247"><span class="hs-identifier">elt_ty</span></a></a><span> </span><a name="local-6989586621684137248"><a href="#local-6989586621684137248"><span class="hs-identifier">wit</span></a></a><span> </span><a name="local-6989586621684137249"><a href="#local-6989586621684137249"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsExplicitList"><span class="hs-identifier hs-var">dsExplicitList</span></a><span> </span><a href="#local-6989586621684137247"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><a href="#local-6989586621684137248"><span class="hs-identifier hs-var">wit</span></a><span> </span><a href="#local-6989586621684137249"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArithSeq</span><span> </span><a name="local-6989586621684137250"><a href="#local-6989586621684137250"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684137251"><a href="#local-6989586621684137251"><span class="hs-identifier">witness</span></a></a><span> </span><a name="local-6989586621684137252"><a href="#local-6989586621684137252"><span class="hs-identifier">seq</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684137251"><span class="hs-identifier hs-var">witness</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-472"></a><span>     </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsExpr.html#dsArithSeq"><span class="hs-identifier hs-var">dsArithSeq</span></a><span> </span><a href="#local-6989586621684137250"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621684137252"><span class="hs-identifier hs-var">seq</span></a><span>
</span><a name="line-473"></a><span>     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684137253"><a href="#local-6989586621684137253"><span class="hs-identifier">fl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137254"><a href="#local-6989586621684137254"><span class="hs-identifier">newArithSeq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsArithSeq"><span class="hs-identifier hs-var">dsArithSeq</span></a><span> </span><a href="#local-6989586621684137250"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621684137252"><span class="hs-identifier hs-var">seq</span></a><span>
</span><a name="line-474"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137253"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137254"><span class="hs-identifier hs-var">newArithSeq</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-comment">{-
Static Pointers
~~~~~~~~~~~~~~~

See Note [Grand plan for static forms] in StaticPtrTable for an overview.

    g = ... static f ...
==&gt;
    g = ... makeStatic loc f ...
-}</span><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsStatic</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137255"><a href="#local-6989586621684137255"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137256"><a href="#local-6989586621684137256"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-488"></a><span>    </span><a name="local-6989586621684137257"><a href="#local-6989586621684137257"><span class="hs-identifier">expr_ds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137255"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-489"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137258"><a href="#local-6989586621684137258"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684137257"><span class="hs-identifier hs-var">expr_ds</span></a><span>
</span><a name="line-490"></a><span>    </span><a name="local-6989586621684137259"><a href="#local-6989586621684137259"><span class="hs-identifier">makeStaticId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsLookupGlobalId"><span class="hs-identifier hs-var">dsLookupGlobalId</span></a><span> </span><span class="hs-identifier hs-var">makeStaticName</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span>    </span><a name="local-6989586621684137260"><a href="#local-6989586621684137260"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-493"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137261"><a href="#local-6989586621684137261"><span class="hs-identifier">line</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137262"><a href="#local-6989586621684137262"><span class="hs-identifier">col</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684137256"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-494"></a><span>           </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621684137264"><a href="#local-6989586621684137264"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">srcLocLine</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">realSrcSpanStart</span><span> </span><a href="#local-6989586621684137264"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-495"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcLocCol</span><span>  </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">realSrcSpanStart</span><span> </span><a href="#local-6989586621684137264"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-496"></a><span>                            </span><span class="hs-special">)</span><span>
</span><a name="line-497"></a><span>           </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>        </span><a name="local-6989586621684137263"><a href="#local-6989586621684137263"><span class="hs-identifier">srcLoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkCoreConApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tupleDataCon</span><span> </span><span class="hs-identifier hs-var">Boxed</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>                     </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-identifier hs-var">intTy</span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><span class="hs-identifier hs-var">intTy</span><span>
</span><a name="line-500"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkIntExprInt</span><span> </span><a href="#local-6989586621684137260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684137261"><span class="hs-identifier hs-var">line</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkIntExprInt</span><span> </span><a href="#local-6989586621684137260"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684137262"><span class="hs-identifier hs-var">col</span></a><span>
</span><a name="line-501"></a><span>                     </span><span class="hs-special">]</span><span>
</span><a name="line-502"></a><span>
</span><a name="line-503"></a><span>    </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684137256"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-504"></a><span>      </span><span class="hs-identifier hs-var">mkCoreApps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684137259"><span class="hs-identifier hs-var">makeStaticId</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Type</span><span> </span><a href="#local-6989586621684137258"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137263"><span class="hs-identifier hs-var">srcLoc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137257"><span class="hs-identifier hs-var">expr_ds</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-comment">{-
\noindent
\underline{\bf Record construction and update}
             ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For record construction we do this (assuming T has three arguments)
\begin{verbatim}
        T { op2 = e }
==&gt;
        let err = /\a -&gt; recConErr a
        T (recConErr t1 &quot;M.hs/230/op1&quot;)
          e
          (recConErr t1 &quot;M.hs/230/op3&quot;)
\end{verbatim}
@recConErr@ then converts its argument string into a proper message
before printing it as
\begin{verbatim}
        M.hs, line 230: missing field op1 was evaluated
\end{verbatim}

We also handle @C{}@ as valid construction syntax for an unlabelled
constructor @C@, setting all of @C@'s fields to bottom.
-}</span><span>
</span><a name="line-528"></a><span>
</span><a name="line-529"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecordCon</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rcon_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137265"><a href="#local-6989586621684137265"><span class="hs-identifier">rbinds</span></a></a><span>
</span><a name="line-530"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecordConTc</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rcon_con_expr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137266"><a href="#local-6989586621684137266"><span class="hs-identifier">con_expr</span></a></a><span>
</span><a name="line-531"></a><span>                                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rcon_con_like</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137267"><a href="#local-6989586621684137267"><span class="hs-identifier">con_like</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-532"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137268"><a href="#local-6989586621684137268"><span class="hs-identifier">con_expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684137266"><span class="hs-identifier hs-var">con_expr</span></a><span>
</span><a name="line-533"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-534"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621684137269"><a href="#local-6989586621684137269"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcSplitFunTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684137268"><span class="hs-identifier hs-var">con_expr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>             </span><span class="hs-comment">-- A newtype in the corner should be opaque;</span><span>
</span><a name="line-536"></a><span>             </span><span class="hs-comment">-- hence TcType.tcSplitFunTys</span><span>
</span><a name="line-537"></a><span>
</span><a name="line-538"></a><span>             </span><a name="local-6989586621684137270"><a href="#local-6989586621684137270"><span class="hs-identifier">mk_arg</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684137273"><a href="#local-6989586621684137273"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137274"><a href="#local-6989586621684137274"><span class="hs-identifier">fl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-539"></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="DsExpr.html#findField"><span class="hs-identifier hs-var">findField</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rec_flds</span><span> </span><a href="#local-6989586621684137265"><span class="hs-identifier hs-var">rbinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621684137274"><span class="hs-identifier hs-var">fl</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-540"></a><span>                   </span><span class="hs-special">(</span><a name="local-6989586621684137275"><a href="#local-6989586621684137275"><span class="hs-identifier">rhs</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684137276"><a href="#local-6989586621684137276"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">rhss</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>                                 </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137275"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-542"></a><span>                   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsUtils.html#mkErrorAppDs"><span class="hs-identifier hs-var">mkErrorAppDs</span></a><span> </span><span class="hs-identifier hs-var">rEC_CON_ERROR_ID</span><span> </span><a href="#local-6989586621684137273"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621684137274"><span class="hs-identifier hs-var">fl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>             </span><a name="local-6989586621684137271"><a href="#local-6989586621684137271"><span class="hs-identifier">unlabelled_bottom</span></a></a><span> </span><a name="local-6989586621684137277"><a href="#local-6989586621684137277"><span class="hs-identifier">arg_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#mkErrorAppDs"><span class="hs-identifier hs-var">mkErrorAppDs</span></a><span> </span><span class="hs-identifier hs-var">rEC_CON_ERROR_ID</span><span> </span><a href="#local-6989586621684137277"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-544"></a><span>
</span><a name="line-545"></a><span>             </span><a name="local-6989586621684137272"><a href="#local-6989586621684137272"><span class="hs-identifier">labels</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span> </span><a href="#local-6989586621684137267"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137278"><a href="#local-6989586621684137278"><span class="hs-identifier">con_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137272"><span class="hs-identifier hs-var">labels</span></a><span>
</span><a name="line-548"></a><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684137271"><span class="hs-identifier hs-var">unlabelled_bottom</span></a><span> </span><a href="#local-6989586621684137269"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-549"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684137270"><span class="hs-identifier hs-var">mk_arg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;dsExpr:RecordCon&quot;</span><span> </span><a href="#local-6989586621684137269"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621684137272"><span class="hs-identifier hs-var">labels</span></a><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCoreApps</span><span> </span><a href="#local-6989586621684137268"><span class="hs-identifier hs-var">con_expr'</span></a><span> </span><a href="#local-6989586621684137278"><span class="hs-identifier hs-var">con_args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span class="hs-comment">{-
Record update is a little harder. Suppose we have the decl:
\begin{verbatim}
        data T = T1 {op1, op2, op3 :: Int}
               | T2 {op4, op2 :: Int}
               | T3
\end{verbatim}
Then we translate as follows:
\begin{verbatim}
        r { op2 = e }
===&gt;
        let op2 = e in
        case r of
          T1 op1 _ op3 -&gt; T1 op1 op2 op3
          T2 op4 _     -&gt; T2 op4 op2
          other        -&gt; recUpdError &quot;M.hs/230&quot;
\end{verbatim}
It's important that we use the constructor Ids for @T1@, @T2@ etc on the
RHSs, and do not generate a Core constructor application directly, because the constructor
might do some argument-evaluation first; and may have to throw away some
dictionaries.

Note [Update for GADTs]
~~~~~~~~~~~~~~~~~~~~~~~
Consider
   data T a b where
     T1 :: { f1 :: a } -&gt; T a Int

Then the wrapper function for T1 has type
   $WT1 :: a -&gt; T a Int
But if x::T a b, then
   x { f1 = v } :: T a b   (not T a Int!)
So we need to cast (T a Int) to (T a b).  Sigh.

-}</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137279"><a href="#local-6989586621684137279"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecordUpd</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rupd_expr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137280"><a href="#local-6989586621684137280"><span class="hs-identifier">record_expr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_flds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137281"><a href="#local-6989586621684137281"><span class="hs-identifier">fields</span></a></a><span>
</span><a name="line-590"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecordUpdTc</span><span>
</span><a name="line-591"></a><span>                              </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rupd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137282"><a href="#local-6989586621684137282"><span class="hs-identifier">cons_to_upd</span></a></a><span>
</span><a name="line-592"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_in_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137283"><a href="#local-6989586621684137283"><span class="hs-identifier">in_inst_tys</span></a></a><span>
</span><a name="line-593"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_out_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137284"><a href="#local-6989586621684137284"><span class="hs-identifier">out_inst_tys</span></a></a><span>
</span><a name="line-594"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rupd_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137285"><a href="#local-6989586621684137285"><span class="hs-identifier">dict_req_wrap</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137281"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-596"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137280"><span class="hs-identifier hs-var">record_expr</span></a><span>
</span><a name="line-597"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-598"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">notNull</span><span> </span><span class="hs-identifier">cons_to_upd</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137282"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684137282"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137344"><a href="#local-6989586621684137344"><span class="hs-identifier">record_expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137280"><span class="hs-identifier hs-var">record_expr</span></a><span>
</span><a name="line-601"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137345"><a href="#local-6989586621684137345"><span class="hs-identifier">field_binds'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621684137286"><span class="hs-identifier hs-var">ds_field</span></a><span> </span><a href="#local-6989586621684137281"><span class="hs-identifier hs-var">fields</span></a><span>
</span><a name="line-602"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">upd_fld_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-comment">-- Maps field name to the LocalId of the field binding</span><span>
</span><a name="line-603"></a><span>              </span><a name="local-6989586621684137346"><a href="#local-6989586621684137346"><span class="hs-identifier">upd_fld_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684137347"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><a href="#local-6989586621684137348"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137347"><a href="#local-6989586621684137347"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><a name="local-6989586621684137348"><a href="#local-6989586621684137348"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137345"><span class="hs-identifier hs-var">field_binds'</span></a><span class="hs-special">]</span><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span>        </span><span class="hs-comment">-- It's important to generate the match with matchWrapper,</span><span>
</span><a name="line-606"></a><span>        </span><span class="hs-comment">-- and the right hand sides with applications of the wrapper Id</span><span>
</span><a name="line-607"></a><span>        </span><span class="hs-comment">-- so that everything works when we are doing fancy unboxing on the</span><span>
</span><a name="line-608"></a><span>        </span><span class="hs-comment">-- constructor arguments.</span><span>
</span><a name="line-609"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137349"><a href="#local-6989586621684137349"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137290"><span class="hs-identifier hs-var">mk_alt</span></a><span> </span><a href="#local-6989586621684137346"><span class="hs-identifier hs-var">upd_fld_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137282"><span class="hs-identifier hs-var">cons_to_upd</span></a><span>
</span><a name="line-610"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621684137350"><a href="#local-6989586621684137350"><span class="hs-identifier">discrim_var</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684137351"><a href="#local-6989586621684137351"><span class="hs-identifier">matching_code</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-611"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchWrapper"><span class="hs-identifier hs-var">matchWrapper</span></a><span> </span><span class="hs-identifier hs-var">RecUpd</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-612"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621684137349"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-613"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MatchGroupTc</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137288"><span class="hs-identifier hs-var">in_ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684137289"><span class="hs-identifier hs-var">out_ty</span></a><span>
</span><a name="line-614"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FromSource</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-615"></a><span>                                     </span><span class="hs-comment">-- FromSource is not strictly right, but we</span><span>
</span><a name="line-616"></a><span>                                     </span><span class="hs-comment">-- want incomplete pattern-match warnings</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137287"><span class="hs-identifier hs-var">add_field_binds</span></a><span> </span><a href="#local-6989586621684137345"><span class="hs-identifier hs-var">field_binds'</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-619"></a><span>                  </span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><a href="#local-6989586621684137350"><span class="hs-identifier hs-var">discrim_var</span></a><span> </span><a href="#local-6989586621684137344"><span class="hs-identifier hs-var">record_expr'</span></a><span> </span><a href="#local-6989586621684137351"><span class="hs-identifier hs-var">matching_code</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-620"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-621"></a><span>    </span><span class="hs-identifier">ds_field</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsRecUpdField</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">)</span><span>
</span><a name="line-622"></a><span>      </span><span class="hs-comment">-- Clone the Id in the HsRecField, because its Name is that</span><span>
</span><a name="line-623"></a><span>      </span><span class="hs-comment">-- of the record selector, and we must not make that a local binder</span><span>
</span><a name="line-624"></a><span>      </span><span class="hs-comment">-- else we shadow other uses of the record selector</span><span>
</span><a name="line-625"></a><span>      </span><span class="hs-comment">-- Hence 'lcl_id'.  Cf Trac #2735</span><span>
</span><a name="line-626"></a><span>    </span><a name="local-6989586621684137286"><a href="#local-6989586621684137286"><span class="hs-identifier">ds_field</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137291"><a href="#local-6989586621684137291"><span class="hs-identifier">rec_field</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137292"><a href="#local-6989586621684137292"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsRecFieldArg</span><span> </span><a href="#local-6989586621684137291"><span class="hs-identifier hs-var">rec_field</span></a><span class="hs-special">)</span><span>
</span><a name="line-628"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137293"><a href="#local-6989586621684137293"><span class="hs-identifier">fld_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsRecUpdFieldId</span><span> </span><a href="#local-6989586621684137291"><span class="hs-identifier hs-var">rec_field</span></a><span class="hs-special">)</span><span>
</span><a name="line-629"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137294"><a href="#local-6989586621684137294"><span class="hs-identifier">lcl_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalDs"><span class="hs-identifier hs-var">newSysLocalDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684137293"><span class="hs-identifier hs-var">fld_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-630"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621684137293"><span class="hs-identifier hs-var">fld_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137294"><span class="hs-identifier hs-var">lcl_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137292"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span>    </span><a name="local-6989586621684137287"><a href="#local-6989586621684137287"><span class="hs-identifier">add_field_binds</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684137295"><a href="#local-6989586621684137295"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137295"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-633"></a><span>    </span><span class="hs-identifier">add_field_binds</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684137296"><a href="#local-6989586621684137296"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621684137297"><a href="#local-6989586621684137297"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684137298"><a href="#local-6989586621684137298"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137299"><a href="#local-6989586621684137299"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bindNonRec</span><span> </span><a href="#local-6989586621684137296"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684137297"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137287"><span class="hs-identifier hs-var">add_field_binds</span></a><span> </span><a href="#local-6989586621684137298"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684137299"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span>        </span><span class="hs-comment">-- Awkwardly, for families, the match goes</span><span>
</span><a name="line-636"></a><span>        </span><span class="hs-comment">-- from instance type to family type</span><span>
</span><a name="line-637"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684137288"><a href="#local-6989586621684137288"><span class="hs-identifier">in_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137289"><a href="#local-6989586621684137289"><span class="hs-identifier">out_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-638"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621684137282"><span class="hs-identifier hs-var">cons_to_upd</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-639"></a><span>        </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621684137300"><a href="#local-6989586621684137300"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-640"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137301"><a href="#local-6989586621684137301"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621684137300"><span class="hs-identifier hs-var">data_con</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-641"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621684137301"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621684137283"><span class="hs-identifier hs-var">in_inst_tys</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkFamilyTyConApp</span><span> </span><a href="#local-6989586621684137301"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621684137284"><span class="hs-identifier hs-var">out_inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>        </span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621684137302"><a href="#local-6989586621684137302"><span class="hs-identifier">pat_syn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-643"></a><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">patSynInstResTy</span><span> </span><a href="#local-6989586621684137302"><span class="hs-identifier hs-var">pat_syn</span></a><span> </span><a href="#local-6989586621684137283"><span class="hs-identifier hs-var">in_inst_tys</span></a><span>
</span><a name="line-644"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">patSynInstResTy</span><span> </span><a href="#local-6989586621684137302"><span class="hs-identifier hs-var">pat_syn</span></a><span> </span><a href="#local-6989586621684137284"><span class="hs-identifier hs-var">out_inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span>    </span><a name="local-6989586621684137290"><a href="#local-6989586621684137290"><span class="hs-identifier">mk_alt</span></a></a><span> </span><a name="local-6989586621684137303"><a href="#local-6989586621684137303"><span class="hs-identifier">upd_fld_env</span></a></a><span> </span><a name="local-6989586621684137304"><a href="#local-6989586621684137304"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-646"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137305"><a href="#local-6989586621684137305"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137306"><a href="#local-6989586621684137306"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137307"><a href="#local-6989586621684137307"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-647"></a><span>                  </span><a name="local-6989586621684137308"><a href="#local-6989586621684137308"><span class="hs-identifier">prov_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137309"><a href="#local-6989586621684137309"><span class="hs-identifier">_req_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137310"><a href="#local-6989586621684137310"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFullSig</span><span> </span><a href="#local-6989586621684137304"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-648"></a><span>                 </span><a name="local-6989586621684137311"><a href="#local-6989586621684137311"><span class="hs-identifier">user_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-649"></a><span>                   </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684137304"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-650"></a><span>                     </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621684137314"><a href="#local-6989586621684137314"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">dataConUserTyVars</span><span> </span><a href="#local-6989586621684137314"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-651"></a><span>                     </span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684137305"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684137306"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-652"></a><span>                       </span><span class="hs-comment">-- The order here is because of the order in `TcPatSyn`.</span><span>
</span><a name="line-653"></a><span>                 </span><a name="local-6989586621684137312"><a href="#local-6989586621684137312"><span class="hs-identifier">in_subst</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipTvSubst</span><span> </span><a href="#local-6989586621684137305"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-6989586621684137283"><span class="hs-identifier hs-var">in_inst_tys</span></a><span>
</span><a name="line-654"></a><span>                 </span><a name="local-6989586621684137313"><a href="#local-6989586621684137313"><span class="hs-identifier">out_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipTvSubst</span><span> </span><a href="#local-6989586621684137305"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-6989586621684137284"><span class="hs-identifier hs-var">out_inst_tys</span></a><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span>                </span><span class="hs-comment">-- I'm not bothering to clone the ex_tvs</span><span>
</span><a name="line-657"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137315"><a href="#local-6989586621684137315"><span class="hs-identifier">eqs_vars</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newPredVarDs"><span class="hs-identifier hs-var">newPredVarDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621684137312"><span class="hs-identifier hs-var">in_subst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqSpecPreds</span><span> </span><a href="#local-6989586621684137307"><span class="hs-identifier hs-var">eq_spec</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-658"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137316"><a href="#local-6989586621684137316"><span class="hs-identifier">theta_vars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsMonad.html#newPredVarDs"><span class="hs-identifier hs-var">newPredVarDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621684137312"><span class="hs-identifier hs-var">in_subst</span></a><span> </span><a href="#local-6989586621684137308"><span class="hs-identifier hs-var">prov_theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137317"><a href="#local-6989586621684137317"><span class="hs-identifier">arg_ids</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#newSysLocalsDs"><span class="hs-identifier hs-var">newSysLocalsDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTysUnchecked</span><span> </span><a href="#local-6989586621684137312"><span class="hs-identifier hs-var">in_subst</span></a><span> </span><a href="#local-6989586621684137310"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-660"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137318"><a href="#local-6989586621684137318"><span class="hs-identifier">field_labels</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span> </span><a href="#local-6989586621684137304"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-661"></a><span>                 </span><a name="local-6989586621684137319"><a href="#local-6989586621684137319"><span class="hs-identifier">val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWithEqual</span><span> </span><span class="hs-string">&quot;dsExpr:RecordUpd&quot;</span><span> </span><a href="#local-6989586621684137320"><span class="hs-identifier hs-var">mk_val_arg</span></a><span>
</span><a name="line-662"></a><span>                                         </span><a href="#local-6989586621684137318"><span class="hs-identifier hs-var">field_labels</span></a><span> </span><a href="#local-6989586621684137317"><span class="hs-identifier hs-var">arg_ids</span></a><span>
</span><a name="line-663"></a><span>                 </span><a name="local-6989586621684137320"><a href="#local-6989586621684137320"><span class="hs-identifier">mk_val_arg</span></a></a><span> </span><a name="local-6989586621684137328"><a href="#local-6989586621684137328"><span class="hs-identifier">fl</span></a></a><span> </span><a name="local-6989586621684137329"><a href="#local-6989586621684137329"><span class="hs-identifier">pat_arg_id</span></a></a><span>
</span><a name="line-664"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621684137303"><span class="hs-identifier hs-var">upd_fld_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621684137328"><span class="hs-identifier hs-var">fl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684137329"><span class="hs-identifier hs-var">pat_arg_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>
</span><a name="line-666"></a><span>                 </span><a name="local-6989586621684137321"><a href="#local-6989586621684137321"><span class="hs-identifier">inst_con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkHsWrap</span><span> </span><a href="#local-6989586621684137322"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsConLikeOut</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><a href="#local-6989586621684137304"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-667"></a><span>                        </span><span class="hs-comment">-- Reconstruct with the WrapId so that unpacking happens</span><span>
</span><a name="line-668"></a><span>                 </span><a name="local-6989586621684137322"><a href="#local-6989586621684137322"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWpEvVarApps</span><span> </span><a href="#local-6989586621684137316"><span class="hs-identifier hs-var">theta_vars</span></a><span>                                </span><span class="hs-operator hs-var">&lt;.&gt;</span><span>
</span><a name="line-669"></a><span>                        </span><a href="#local-6989586621684137285"><span class="hs-identifier hs-var">dict_req_wrap</span></a><span>                                           </span><span class="hs-operator hs-var">&lt;.&gt;</span><span>
</span><a name="line-670"></a><span>                        </span><span class="hs-identifier hs-var">mkWpTyApps</span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">lookupTyVar</span><span> </span><a href="#local-6989586621684137313"><span class="hs-identifier hs-var">out_subst</span></a><span> </span><a href="#local-6989586621684137330"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-671"></a><span>                                          </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621684137330"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-672"></a><span>                                      </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684137330"><a href="#local-6989586621684137330"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137311"><span class="hs-identifier hs-var">user_tvs</span></a><span>
</span><a name="line-673"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137330"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684137325"><span class="hs-identifier hs-var">wrap_subst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-674"></a><span>                          </span><span class="hs-comment">-- Be sure to use user_tvs (which may be ordered</span><span>
</span><a name="line-675"></a><span>                          </span><span class="hs-comment">-- differently than `univ_tvs ++ ex_tvs) above.</span><span>
</span><a name="line-676"></a><span>                          </span><span class="hs-comment">-- See Note [DataCon user type variable binders]</span><span>
</span><a name="line-677"></a><span>                          </span><span class="hs-comment">-- in DataCon.</span><span>
</span><a name="line-678"></a><span>                 </span><a name="local-6989586621684137323"><a href="#local-6989586621684137323"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684137331"><a href="#local-6989586621684137331"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621684137332"><a href="#local-6989586621684137332"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><a href="#local-6989586621684137331"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621684137332"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137321"><span class="hs-identifier hs-var">inst_con</span></a><span> </span><a href="#local-6989586621684137319"><span class="hs-identifier hs-var">val_args</span></a><span>
</span><a name="line-679"></a><span>
</span><a name="line-680"></a><span>                        </span><span class="hs-comment">-- Tediously wrap the application in a cast</span><span>
</span><a name="line-681"></a><span>                        </span><span class="hs-comment">-- Note [Update for GADTs]</span><span>
</span><a name="line-682"></a><span>                 </span><a name="local-6989586621684137324"><a href="#local-6989586621684137324"><span class="hs-identifier">wrapped_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-683"></a><span>                  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684137304"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-684"></a><span>                    </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621684137333"><a href="#local-6989586621684137333"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-685"></a><span>                      </span><span class="hs-keyword">let</span><span>
</span><a name="line-686"></a><span>                        </span><a name="local-6989586621684137334"><a href="#local-6989586621684137334"><span class="hs-identifier">wrap_co</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-687"></a><span>                          </span><span class="hs-identifier hs-var">mkTcTyConAppCo</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span>
</span><a name="line-688"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621684137333"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span>
</span><a name="line-689"></a><span>                            </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684137335"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621684137336"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621684137337"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-690"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137336"><a href="#local-6989586621684137336"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><a name="local-6989586621684137337"><a href="#local-6989586621684137337"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137305"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684137284"><span class="hs-identifier hs-var">out_inst_tys</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-691"></a><span>                        </span><a name="local-6989586621684137335"><a href="#local-6989586621684137335"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621684137338"><a href="#local-6989586621684137338"><span class="hs-identifier">univ_tv</span></a></a><span> </span><a name="local-6989586621684137339"><a href="#local-6989586621684137339"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-692"></a><span>                          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><a href="#local-6989586621684137325"><span class="hs-identifier hs-var">wrap_subst</span></a><span> </span><a href="#local-6989586621684137338"><span class="hs-identifier hs-var">univ_tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-693"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684137340"><a href="#local-6989586621684137340"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684137340"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-694"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkTcReflCo</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621684137339"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-695"></a><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137307"><span class="hs-identifier hs-var">eq_spec</span></a><span>
</span><a name="line-696"></a><span>                             </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621684137323"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-697"></a><span>                             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpCastN</span><span> </span><a href="#local-6989586621684137334"><span class="hs-identifier hs-var">wrap_co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137323"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-698"></a><span>                    </span><span class="hs-comment">-- eq_spec is always null for a PatSynCon</span><span>
</span><a name="line-699"></a><span>                    </span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684137323"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span>                 </span><a name="local-6989586621684137325"><a href="#local-6989586621684137325"><span class="hs-identifier">wrap_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-702"></a><span>                  </span><span class="hs-identifier hs-var">mkVarEnv</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137343"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcCoVarCo</span><span> </span><a href="#local-6989586621684137342"><span class="hs-identifier hs-var">eq_var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-703"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137341"><a href="#local-6989586621684137341"><span class="hs-identifier">spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137342"><a href="#local-6989586621684137342"><span class="hs-identifier">eq_var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137307"><span class="hs-identifier hs-var">eq_spec</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684137315"><span class="hs-identifier hs-var">eqs_vars</span></a><span>
</span><a name="line-704"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137343"><a href="#local-6989586621684137343"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqSpecTyVar</span><span> </span><a href="#local-6989586621684137341"><span class="hs-identifier hs-var">spec</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span>                 </span><a name="local-6989586621684137326"><a href="#local-6989586621684137326"><span class="hs-identifier">req_wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137285"><span class="hs-identifier hs-var">dict_req_wrap</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><a href="#local-6989586621684137283"><span class="hs-identifier hs-var">in_inst_tys</span></a><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span>                 </span><a name="local-6989586621684137327"><a href="#local-6989586621684137327"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ConPatOut</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_con</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621684137304"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-709"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137306"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-710"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137315"><span class="hs-identifier hs-var">eqs_vars</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684137316"><span class="hs-identifier hs-var">theta_vars</span></a><span>
</span><a name="line-711"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyTcEvBinds</span><span>
</span><a name="line-712"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nlVarPat</span><span> </span><a href="#local-6989586621684137317"><span class="hs-identifier hs-var">arg_ids</span></a><span>
</span><a name="line-713"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_arg_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137283"><span class="hs-identifier hs-var">in_inst_tys</span></a><span>
</span><a name="line-714"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137326"><span class="hs-identifier hs-var">req_wrap</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-715"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkSimpleMatch</span><span> </span><span class="hs-identifier hs-var">RecUpd</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137327"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684137324"><span class="hs-identifier hs-var">wrapped_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span class="hs-comment">-- Here is where we desugar the Template Haskell brackets and escapes</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span class="hs-comment">-- Template Haskell stuff</span><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRnBracketOut</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr HsRnBracketOut&quot;</span><span>
</span><a name="line-722"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTcBracketOut</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137352"><a href="#local-6989586621684137352"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621684137353"><a href="#local-6989586621684137353"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMeta.html#dsBracket"><span class="hs-identifier hs-var">dsBracket</span></a><span> </span><a href="#local-6989586621684137352"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684137353"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-723"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliceE</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137354"><a href="#local-6989586621684137354"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;dsExpr:splice&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137354"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span class="hs-comment">-- Arrow notation extension</span><span>
</span><a name="line-726"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsProc</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137355"><a href="#local-6989586621684137355"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684137356"><a href="#local-6989586621684137356"><span class="hs-identifier">cmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsArrows.html#dsProcExpr"><span class="hs-identifier hs-var">dsProcExpr</span></a><span> </span><a href="#local-6989586621684137355"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684137356"><span class="hs-identifier hs-var">cmd</span></a><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span class="hs-comment">-- Hpc Support</span><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137357"><a href="#local-6989586621684137357"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621684137358"><a href="#local-6989586621684137358"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-731"></a><span>  </span><a name="local-6989586621684137359"><a href="#local-6989586621684137359"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137358"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-732"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Tick</span><span> </span><a href="#local-6989586621684137357"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621684137359"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>
</span><a name="line-734"></a><span class="hs-comment">-- There is a problem here. The then and else branches</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- have no free variables, so they are open to lifting.</span><span>
</span><a name="line-736"></a><span class="hs-comment">-- We need someway of stopping this.</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- This will make no difference to binary coverage</span><span>
</span><a name="line-738"></a><span class="hs-comment">-- (did you go here: YES or NO), but will effect accurate</span><span>
</span><a name="line-739"></a><span class="hs-comment">-- tick counting.</span><span>
</span><a name="line-740"></a><span>
</span><a name="line-741"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsBinTick</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137360"><a href="#local-6989586621684137360"><span class="hs-identifier">ixT</span></a></a><span> </span><a name="local-6989586621684137361"><a href="#local-6989586621684137361"><span class="hs-identifier">ixF</span></a></a><span> </span><a name="local-6989586621684137362"><a href="#local-6989586621684137362"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-742"></a><span>  </span><a name="local-6989586621684137363"><a href="#local-6989586621684137363"><span class="hs-identifier">e2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137362"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-743"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">exprType</span><span> </span><span class="hs-identifier hs-var">e2</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">boolTy</span><span class="hs-special">)</span><span>
</span><a name="line-744"></a><span>       </span><a href="DsUtils.html#mkBinaryTickBox"><span class="hs-identifier hs-var">mkBinaryTickBox</span></a><span> </span><a href="#local-6989586621684137360"><span class="hs-identifier hs-var">ixT</span></a><span> </span><a href="#local-6989586621684137361"><span class="hs-identifier hs-var">ixF</span></a><span> </span><a href="#local-6989586621684137363"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-745"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-746"></a><span>
</span><a name="line-747"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsTickPragma</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137364"><a href="#local-6989586621684137364"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-748"></a><span>  </span><a name="local-6989586621684137365"><a href="#local-6989586621684137365"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-749"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Hpc</span><span> </span><a href="#local-6989586621684137365"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-750"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:HsTickPragma&quot;</span><span>
</span><a name="line-751"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137364"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span class="hs-comment">-- HsSyn constructs that just shouldn't be here:</span><span>
</span><a name="line-754"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsBracket</span><span>     </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:HsBracket&quot;</span><span>
</span><a name="line-755"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArrApp</span><span>      </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:HsArrApp&quot;</span><span>
</span><a name="line-756"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsArrForm</span><span>     </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:HsArrForm&quot;</span><span>
</span><a name="line-757"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EWildPat</span><span>      </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:EWildPat&quot;</span><span>
</span><a name="line-758"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EAsPat</span><span>        </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:EAsPat&quot;</span><span>
</span><a name="line-759"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EViewPat</span><span>      </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:EViewPat&quot;</span><span>
</span><a name="line-760"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ELazyPat</span><span>      </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:ELazyPat&quot;</span><span>
</span><a name="line-761"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span>          </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:HsDo&quot;</span><span>
</span><a name="line-762"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFld</span><span>      </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr:HsRecFld&quot;</span><span>
</span><a name="line-763"></a><span class="hs-identifier">ds_expr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XExpr</span><span>         </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsExpr: XExpr&quot;</span><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-767"></a><span class="hs-identifier">dsSyntaxExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CoreExpr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-768"></a><a name="dsSyntaxExpr"><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier">dsSyntaxExpr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SyntaxExpr</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">syn_expr</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137366"><a href="#local-6989586621684137366"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-769"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">syn_arg_wraps</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137367"><a href="#local-6989586621684137367"><span class="hs-identifier">arg_wraps</span></a></a><span>
</span><a name="line-770"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">syn_res_wrap</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137368"><a href="#local-6989586621684137368"><span class="hs-identifier">res_wrap</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-771"></a><span>             </span><a name="local-6989586621684137369"><a href="#local-6989586621684137369"><span class="hs-identifier">arg_exprs</span></a></a><span>
</span><a name="line-772"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137372"><a href="#local-6989586621684137372"><span class="hs-identifier">fun</span></a></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684137366"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-773"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137373"><a href="#local-6989586621684137373"><span class="hs-identifier">core_arg_wraps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684137367"><span class="hs-identifier hs-var">arg_wraps</span></a><span>
</span><a name="line-774"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137374"><a href="#local-6989586621684137374"><span class="hs-identifier">core_res_wrap</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsBinds.html#dsHsWrapper"><span class="hs-identifier hs-var">dsHsWrapper</span></a><span> </span><a href="#local-6989586621684137368"><span class="hs-identifier hs-var">res_wrap</span></a><span>
</span><a name="line-775"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137375"><a href="#local-6989586621684137375"><span class="hs-identifier">wrapped_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137373"><span class="hs-identifier hs-var">core_arg_wraps</span></a><span> </span><a href="#local-6989586621684137369"><span class="hs-identifier hs-var">arg_exprs</span></a><span>
</span><a name="line-776"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsMonad.html#dsWhenNoErrs"><span class="hs-identifier hs-var">dsWhenNoErrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWithM_</span><span> </span><a href="DsMonad.html#dsNoLevPolyExpr"><span class="hs-identifier hs-var">dsNoLevPolyExpr</span></a><span> </span><a href="#local-6989586621684137375"><span class="hs-identifier hs-var">wrapped_args</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684137370"><span class="hs-identifier hs-var">mk_doc</span></a><span> </span><a href="#local-6989586621684137376"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684137376"><a href="#local-6989586621684137376"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-777"></a><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684137374"><span class="hs-identifier hs-var">core_res_wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkApps</span><span> </span><a href="#local-6989586621684137372"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621684137375"><span class="hs-identifier hs-var">wrapped_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-778"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-779"></a><span>    </span><a name="local-6989586621684137370"><a href="#local-6989586621684137370"><span class="hs-identifier">mk_doc</span></a></a><span> </span><a name="local-6989586621684137371"><a href="#local-6989586621684137371"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">speakNth</span><span> </span><a href="#local-6989586621684137371"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;argument of&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137366"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-780"></a><span>
</span><a name="line-781"></a><span class="hs-identifier">findField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsRecField</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><a href="#local-6989586621684137064"><span class="hs-identifier hs-type">arg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137064"><span class="hs-identifier hs-type">arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-782"></a><a name="findField"><a href="DsExpr.html#findField"><span class="hs-identifier">findField</span></a></a><span> </span><a name="local-6989586621684137377"><a href="#local-6989586621684137377"><span class="hs-identifier">rbinds</span></a></a><span> </span><a name="local-6989586621684137378"><a href="#local-6989586621684137378"><span class="hs-identifier">sel</span></a></a><span>
</span><a name="line-783"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">hsRecFieldArg</span><span> </span><a href="#local-6989586621684137379"><span class="hs-identifier hs-var">fld</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137379"><a href="#local-6989586621684137379"><span class="hs-identifier">fld</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137377"><span class="hs-identifier hs-var">rbinds</span></a><span>
</span><a name="line-784"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137378"><span class="hs-identifier hs-var">sel</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">hsRecFieldId</span><span> </span><a href="#local-6989586621684137379"><span class="hs-identifier hs-var">fld</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span class="hs-comment">{-
%--------------------------------------------------------------------

Note [Desugaring explicit lists]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Explicit lists are desugared in a cleverer way to prevent some
fruitless allocations.  Essentially, whenever we see a list literal
[x_1, ..., x_n] we generate the corresponding expression in terms of
build:

Explicit lists (literals) are desugared to allow build/foldr fusion when
beneficial. This is a bit of a trade-off,

 * build/foldr fusion can generate far larger code than the corresponding
   cons-chain (e.g. see #11707)

 * even when it doesn't produce more code, build can still fail to fuse,
   requiring that the simplifier do more work to bring the expression
   back into cons-chain form; this costs compile time

 * when it works, fusion can be a significant win. Allocations are reduced
   by up to 25% in some nofib programs. Specifically,

        Program           Size    Allocs   Runtime  CompTime
        rewrite          +0.0%    -26.3%      0.02     -1.8%
           ansi          -0.3%    -13.8%      0.00     +0.0%
           lift          +0.0%     -8.7%      0.00     -2.3%

At the moment we use a simple heuristic to determine whether build will be
fruitful: for small lists we assume the benefits of fusion will be worthwhile;
for long lists we assume that the benefits will be outweighted by the cost of
code duplication. This magic length threshold is @maxBuildLength@. Also, fusion
won't work at all if rewrite rules are disabled, so we don't use the build-based
desugaring in this case.

We used to have a more complex heuristic which would try to break the list into
&quot;static&quot; and &quot;dynamic&quot; parts and only build-desugar the dynamic part.
Unfortunately, determining &quot;static-ness&quot; reliably is a bit tricky and the
heuristic at times produced surprising behavior (see #11710) so it was dropped.
-}</span><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span class="hs-comment">{- | The longest list length which we will desugar using @build@.

This is essentially a magic number and its setting is unfortunate rather
arbitrary. The idea here, as mentioned in Note [Desugaring explicit lists],
is to avoid deforesting large static data into large(r) code. Ideally we'd
want a smaller threshold with larger consumers and vice-versa, but we have no
way of knowing what will be consuming our list in the desugaring impossible to
set generally correctly.

The effect of reducing this number will be that 'build' fusion is applied
less often. From a runtime performance perspective, applying 'build' more
liberally on &quot;moderately&quot; sized lists should rarely hurt and will often it can
only expose further optimization opportunities; if no fusion is possible it will
eventually get rule-rewritten back to a list). We do, however, pay in compile
time.
-}</span><span>
</span><a name="line-843"></a><span class="hs-identifier">maxBuildLength</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-844"></a><a name="maxBuildLength"><a href="DsExpr.html#maxBuildLength"><span class="hs-identifier">maxBuildLength</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">32</span><span>
</span><a name="line-845"></a><span>
</span><a name="line-846"></a><span class="hs-identifier">dsExplicitList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span>
</span><a name="line-847"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-848"></a><span class="hs-comment">-- See Note [Desugaring explicit lists]</span><span>
</span><a name="line-849"></a><a name="dsExplicitList"><a href="DsExpr.html#dsExplicitList"><span class="hs-identifier">dsExplicitList</span></a></a><span> </span><a name="local-6989586621684137380"><a href="#local-6989586621684137380"><span class="hs-identifier">elt_ty</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621684137381"><a href="#local-6989586621684137381"><span class="hs-identifier">xs</span></a></a><span>
</span><a name="line-850"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137386"><a href="#local-6989586621684137386"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-851"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137387"><a href="#local-6989586621684137387"><span class="hs-identifier">xs'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137381"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-852"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684137387"><span class="hs-identifier hs-var">xs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthExceeds</span><span class="hs-special">`</span><span> </span><a href="DsExpr.html#maxBuildLength"><span class="hs-identifier hs-var">maxBuildLength</span></a><span>
</span><a name="line-853"></a><span>                </span><span class="hs-comment">-- Don't generate builds if the list is very long.</span><span>
</span><a name="line-854"></a><span>         </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137387"><span class="hs-identifier hs-var">xs'</span></a><span>
</span><a name="line-855"></a><span>                </span><span class="hs-comment">-- Don't generate builds when the [] constructor will do</span><span>
</span><a name="line-856"></a><span>         </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_EnableRewriteRules</span><span> </span><a href="#local-6989586621684137386"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Rewrite rules off</span><span>
</span><a name="line-857"></a><span>                </span><span class="hs-comment">-- Don't generate a build if there are no rules to eliminate it!</span><span>
</span><a name="line-858"></a><span>                </span><span class="hs-comment">-- See Note [Desugaring RULE left hand sides] in Desugar</span><span>
</span><a name="line-859"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkListExpr</span><span> </span><a href="#local-6989586621684137380"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><a href="#local-6989586621684137387"><span class="hs-identifier hs-var">xs'</span></a><span>
</span><a name="line-860"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mkBuildExpr</span><span> </span><a href="#local-6989586621684137380"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137382"><span class="hs-identifier hs-var">mk_build_list</span></a><span> </span><a href="#local-6989586621684137387"><span class="hs-identifier hs-var">xs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-861"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-862"></a><span>    </span><a name="local-6989586621684137382"><a href="#local-6989586621684137382"><span class="hs-identifier">mk_build_list</span></a></a><span> </span><a name="local-6989586621684137383"><a href="#local-6989586621684137383"><span class="hs-identifier">xs'</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684137384"><a href="#local-6989586621684137384"><span class="hs-identifier">cons</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137385"><a href="#local-6989586621684137385"><span class="hs-identifier">nil</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-863"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684137384"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684137385"><span class="hs-identifier hs-var">nil</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137383"><span class="hs-identifier hs-var">xs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span class="hs-identifier">dsExplicitList</span><span> </span><a name="local-6989586621684137388"><a href="#local-6989586621684137388"><span class="hs-identifier">elt_ty</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684137389"><a href="#local-6989586621684137389"><span class="hs-identifier">fln</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137390"><a href="#local-6989586621684137390"><span class="hs-identifier">xs</span></a></a><span>
</span><a name="line-866"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137391"><a href="#local-6989586621684137391"><span class="hs-identifier">list</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExplicitList"><span class="hs-identifier hs-var">dsExplicitList</span></a><span> </span><a href="#local-6989586621684137388"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684137390"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-867"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137392"><a href="#local-6989586621684137392"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-868"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137389"><span class="hs-identifier hs-var">fln</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkIntExprInt</span><span> </span><a href="#local-6989586621684137392"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684137390"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137391"><span class="hs-identifier hs-var">list</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-869"></a><span>
</span><a name="line-870"></a><span class="hs-identifier">dsArithSeq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PostTcExpr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ArithSeqInfo</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-871"></a><a name="dsArithSeq"><a href="DsExpr.html#dsArithSeq"><span class="hs-identifier">dsArithSeq</span></a></a><span> </span><a name="local-6989586621684137393"><a href="#local-6989586621684137393"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">From</span><span> </span><a name="local-6989586621684137394"><a href="#local-6989586621684137394"><span class="hs-identifier">from</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-872"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">App</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684137393"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137394"><span class="hs-identifier hs-var">from</span></a><span>
</span><a name="line-873"></a><span class="hs-identifier">dsArithSeq</span><span> </span><a name="local-6989586621684137395"><a href="#local-6989586621684137395"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromTo</span><span> </span><a name="local-6989586621684137396"><a href="#local-6989586621684137396"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621684137397"><a href="#local-6989586621684137397"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-874"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684137398"><a href="#local-6989586621684137398"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-875"></a><span>       </span><a href="MatchLit.html#warnAboutEmptyEnumerations"><span class="hs-identifier hs-var">warnAboutEmptyEnumerations</span></a><span> </span><a href="#local-6989586621684137398"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684137396"><span class="hs-identifier hs-var">from</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684137397"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-876"></a><span>       </span><a name="local-6989586621684137399"><a href="#local-6989586621684137399"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684137395"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-877"></a><span>       </span><a name="local-6989586621684137400"><a href="#local-6989586621684137400"><span class="hs-identifier">from'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137396"><span class="hs-identifier hs-var">from</span></a><span>
</span><a name="line-878"></a><span>       </span><a name="local-6989586621684137401"><a href="#local-6989586621684137401"><span class="hs-identifier">to'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137397"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-879"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><a href="#local-6989586621684137399"><span class="hs-identifier hs-var">expr'</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137400"><span class="hs-identifier hs-var">from'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137401"><span class="hs-identifier hs-var">to'</span></a><span class="hs-special">]</span><span>
</span><a name="line-880"></a><span class="hs-identifier">dsArithSeq</span><span> </span><a name="local-6989586621684137402"><a href="#local-6989586621684137402"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThen</span><span> </span><a name="local-6989586621684137403"><a href="#local-6989586621684137403"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621684137404"><a href="#local-6989586621684137404"><span class="hs-identifier">thn</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-881"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684137402"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137403"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137404"><span class="hs-identifier hs-var">thn</span></a><span class="hs-special">]</span><span>
</span><a name="line-882"></a><span class="hs-identifier">dsArithSeq</span><span> </span><a name="local-6989586621684137405"><a href="#local-6989586621684137405"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FromThenTo</span><span> </span><a name="local-6989586621684137406"><a href="#local-6989586621684137406"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621684137407"><a href="#local-6989586621684137407"><span class="hs-identifier">thn</span></a></a><span> </span><a name="local-6989586621684137408"><a href="#local-6989586621684137408"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-883"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621684137409"><a href="#local-6989586621684137409"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-884"></a><span>       </span><a href="MatchLit.html#warnAboutEmptyEnumerations"><span class="hs-identifier hs-var">warnAboutEmptyEnumerations</span></a><span> </span><a href="#local-6989586621684137409"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684137406"><span class="hs-identifier hs-var">from</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684137407"><span class="hs-identifier hs-var">thn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137408"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-885"></a><span>       </span><a name="local-6989586621684137410"><a href="#local-6989586621684137410"><span class="hs-identifier">expr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsExpr"><span class="hs-identifier hs-var">dsExpr</span></a><span> </span><a href="#local-6989586621684137405"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-886"></a><span>       </span><a name="local-6989586621684137411"><a href="#local-6989586621684137411"><span class="hs-identifier">from'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137406"><span class="hs-identifier hs-var">from</span></a><span>
</span><a name="line-887"></a><span>       </span><a name="local-6989586621684137412"><a href="#local-6989586621684137412"><span class="hs-identifier">thn'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137407"><span class="hs-identifier hs-var">thn</span></a><span>
</span><a name="line-888"></a><span>       </span><a name="local-6989586621684137413"><a href="#local-6989586621684137413"><span class="hs-identifier">to'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExprNoLP"><span class="hs-identifier hs-var">dsLExprNoLP</span></a><span> </span><a href="#local-6989586621684137408"><span class="hs-identifier hs-var">to</span></a><span>
</span><a name="line-889"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkApps</span><span> </span><a href="#local-6989586621684137410"><span class="hs-identifier hs-var">expr'</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137411"><span class="hs-identifier hs-var">from'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137412"><span class="hs-identifier hs-var">thn'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137413"><span class="hs-identifier hs-var">to'</span></a><span class="hs-special">]</span><span>
</span><a name="line-890"></a><span>
</span><a name="line-891"></a><span class="hs-comment">{-
Desugar 'do' and 'mdo' expressions (NOT list comprehensions, they're
handled in DsListComp).  Basically does the translation given in the
Haskell 98 report:
-}</span><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span class="hs-identifier">dsDo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExprLStmt</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-898"></a><a name="dsDo"><a href="DsExpr.html#dsDo"><span class="hs-identifier">dsDo</span></a></a><span> </span><a name="local-6989586621684137414"><a href="#local-6989586621684137414"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-899"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137415"><span class="hs-identifier hs-var">goL</span></a><span> </span><a href="#local-6989586621684137414"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-900"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-901"></a><span>    </span><a name="local-6989586621684137415"><a href="#local-6989586621684137415"><span class="hs-identifier">goL</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsDo&quot;</span><span>
</span><a name="line-902"></a><span>    </span><span class="hs-identifier">goL</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621684137417"><a href="#local-6989586621684137417"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621684137418"><a href="#local-6989586621684137418"><span class="hs-identifier">stmt</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684137419"><a href="#local-6989586621684137419"><span class="hs-identifier">lstmts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#putSrcSpanDs"><span class="hs-identifier hs-var">putSrcSpanDs</span></a><span> </span><a href="#local-6989586621684137417"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137416"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684137417"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621684137418"><span class="hs-identifier hs-var">stmt</span></a><span> </span><a href="#local-6989586621684137419"><span class="hs-identifier hs-var">lstmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span>    </span><a name="local-6989586621684137416"><a href="#local-6989586621684137416"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LastStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137420"><a href="#local-6989586621684137420"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137421"><a href="#local-6989586621684137421"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-905"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">stmts</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">dsLExpr</span><span> </span><span class="hs-identifier">body</span><span>
</span><a name="line-906"></a><span>        </span><span class="hs-comment">-- The 'return' op isn't used for 'do' expressions</span><span>
</span><a name="line-907"></a><span>
</span><a name="line-908"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137422"><a href="#local-6989586621684137422"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621684137423"><a href="#local-6989586621684137423"><span class="hs-identifier">then_expr</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137424"><a href="#local-6989586621684137424"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-909"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137425"><a href="#local-6989586621684137425"><span class="hs-identifier">rhs2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137422"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-910"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#warnDiscardedDoBindings"><span class="hs-identifier hs-var">warnDiscardedDoBindings</span></a><span> </span><a href="#local-6989586621684137422"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">exprType</span><span> </span><a href="#local-6989586621684137425"><span class="hs-identifier hs-var">rhs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-911"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137426"><a href="#local-6989586621684137426"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137415"><span class="hs-identifier hs-var">goL</span></a><span> </span><a href="#local-6989586621684137424"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-912"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137423"><span class="hs-identifier hs-var">then_expr</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137425"><span class="hs-identifier hs-var">rhs2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684137426"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137427"><a href="#local-6989586621684137427"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137428"><a href="#local-6989586621684137428"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-915"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137429"><a href="#local-6989586621684137429"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137415"><span class="hs-identifier hs-var">goL</span></a><span> </span><a href="#local-6989586621684137428"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-916"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsLocalBinds"><span class="hs-identifier hs-var">dsLocalBinds</span></a><span> </span><a href="#local-6989586621684137427"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621684137429"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><a name="local-6989586621684137430"><a href="#local-6989586621684137430"><span class="hs-identifier">res1_ty</span></a></a><span> </span><a name="local-6989586621684137431"><a href="#local-6989586621684137431"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684137432"><a href="#local-6989586621684137432"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621684137433"><a href="#local-6989586621684137433"><span class="hs-identifier">bind_op</span></a></a><span> </span><a name="local-6989586621684137434"><a href="#local-6989586621684137434"><span class="hs-identifier">fail_op</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137435"><a href="#local-6989586621684137435"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-919"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137436"><a href="#local-6989586621684137436"><span class="hs-identifier">body</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684137415"><span class="hs-identifier hs-var">goL</span></a><span> </span><a href="#local-6989586621684137435"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-920"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137437"><a href="#local-6989586621684137437"><span class="hs-identifier">rhs'</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137432"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-921"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137438"><a href="#local-6989586621684137438"><span class="hs-identifier">var</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsUtils.html#selectSimpleMatchVarL"><span class="hs-identifier hs-var">selectSimpleMatchVarL</span></a><span> </span><a href="#local-6989586621684137431"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-922"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137439"><a href="#local-6989586621684137439"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Match.html#matchSinglePatVar"><span class="hs-identifier hs-var">matchSinglePatVar</span></a><span> </span><a href="#local-6989586621684137438"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">StmtCtxt</span><span> </span><span class="hs-identifier hs-var">DoExpr</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137431"><span class="hs-identifier hs-var">pat</span></a><span>
</span><a name="line-923"></a><span>                                      </span><a href="#local-6989586621684137430"><span class="hs-identifier hs-var">res1_ty</span></a><span> </span><span class="hs-special">(</span><a href="DsUtils.html#cantFailMatchResult"><span class="hs-identifier hs-var">cantFailMatchResult</span></a><span> </span><a href="#local-6989586621684137436"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-924"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137440"><a href="#local-6989586621684137440"><span class="hs-identifier">match_code</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#handle_failure"><span class="hs-identifier hs-var">handle_failure</span></a><span> </span><a href="#local-6989586621684137431"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621684137439"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684137434"><span class="hs-identifier hs-var">fail_op</span></a><span>
</span><a name="line-925"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137433"><span class="hs-identifier hs-var">bind_op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137437"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Lam</span><span> </span><a href="#local-6989586621684137438"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684137440"><span class="hs-identifier hs-var">match_code</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-926"></a><span>
</span><a name="line-927"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeStmt</span><span> </span><a name="local-6989586621684137441"><a href="#local-6989586621684137441"><span class="hs-identifier">body_ty</span></a></a><span> </span><a name="local-6989586621684137442"><a href="#local-6989586621684137442"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684137443"><a href="#local-6989586621684137443"><span class="hs-identifier">mb_join</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684137444"><a href="#local-6989586621684137444"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-928"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-929"></a><span>             </span><span class="hs-keyword">let</span><span>
</span><a name="line-930"></a><span>               </span><span class="hs-special">(</span><a name="local-6989586621684137445"><a href="#local-6989586621684137445"><span class="hs-identifier">pats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137446"><a href="#local-6989586621684137446"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137447"><span class="hs-identifier hs-var">do_arg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137442"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-931"></a><span>
</span><a name="line-932"></a><span>               </span><a name="local-6989586621684137447"><a href="#local-6989586621684137447"><span class="hs-identifier">do_arg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgOne</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137449"><a href="#local-6989586621684137449"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684137450"><a href="#local-6989586621684137450"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-933"></a><span>                 </span><span class="hs-special">(</span><a href="#local-6989586621684137449"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137450"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-934"></a><span>               </span><span class="hs-identifier">do_arg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ApplicativeArgMany</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137451"><a href="#local-6989586621684137451"><span class="hs-identifier">stmts</span></a></a><span> </span><a name="local-6989586621684137452"><a href="#local-6989586621684137452"><span class="hs-identifier">ret</span></a></a><span> </span><a name="local-6989586621684137453"><a href="#local-6989586621684137453"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-935"></a><span>                 </span><span class="hs-special">(</span><a href="#local-6989586621684137453"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">,</span><span> </span><a href="DsExpr.html#dsDo"><span class="hs-identifier hs-var">dsDo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137451"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLastStmt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621684137452"><span class="hs-identifier hs-var">ret</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>               </span><span class="hs-identifier">do_arg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XApplicativeArg</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsDo&quot;</span><span>
</span><a name="line-937"></a><span>
</span><a name="line-938"></a><span>               </span><a name="local-6989586621684137448"><a href="#local-6989586621684137448"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcHsSyn.html#hsLPatType"><span class="hs-identifier hs-var">hsLPatType</span></a><span> </span><a href="#local-6989586621684137445"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-939"></a><span>
</span><a name="line-940"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137454"><a href="#local-6989586621684137454"><span class="hs-identifier">rhss'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><a href="#local-6989586621684137446"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137455"><a href="#local-6989586621684137455"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsDo</span><span> </span><a href="#local-6989586621684137441"><span class="hs-identifier hs-var">body_ty</span></a><span> </span><span class="hs-identifier hs-var">DoExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621684137444"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>
</span><a name="line-943"></a><span>
</span><a name="line-944"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137456"><a href="#local-6989586621684137456"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsLam</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-945"></a><span>                   </span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkSimpleMatch</span><span> </span><span class="hs-identifier hs-var">LambdaExpr</span><span> </span><a href="#local-6989586621684137445"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-946"></a><span>                                                       </span><a href="#local-6989586621684137455"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">]</span><span>
</span><a name="line-947"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MatchGroupTc</span><span> </span><a href="#local-6989586621684137448"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621684137441"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-948"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Generated</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137457"><a href="#local-6989586621684137457"><span class="hs-identifier">fun'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsLExpr"><span class="hs-identifier hs-var">dsLExpr</span></a><span> </span><a href="#local-6989586621684137456"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-951"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137458"><a href="#local-6989586621684137458"><span class="hs-identifier">mk_ap_call</span></a></a><span> </span><a name="local-6989586621684137459"><a href="#local-6989586621684137459"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684137460"><a href="#local-6989586621684137460"><span class="hs-identifier">op</span></a></a><span class="hs-special">,</span><a name="local-6989586621684137461"><a href="#local-6989586621684137461"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137460"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137459"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><a href="#local-6989586621684137461"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">]</span><span>
</span><a name="line-952"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137462"><a href="#local-6989586621684137462"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldlM</span><span> </span><a href="#local-6989586621684137458"><span class="hs-identifier hs-var">mk_ap_call</span></a><span> </span><a href="#local-6989586621684137457"><span class="hs-identifier hs-var">fun'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684137442"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137454"><span class="hs-identifier hs-var">rhss'</span></a><span class="hs-special">)</span><span>
</span><a name="line-953"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684137443"><span class="hs-identifier hs-var">mb_join</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-954"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684137462"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-955"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684137463"><a href="#local-6989586621684137463"><span class="hs-identifier">join_op</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137463"><span class="hs-identifier hs-var">join_op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137462"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-956"></a><span>
</span><a name="line-957"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684137464"><a href="#local-6989586621684137464"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecStmt</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_stmts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137465"><a href="#local-6989586621684137465"><span class="hs-identifier">rec_stmts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_later_ids</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137466"><a href="#local-6989586621684137466"><span class="hs-identifier">later_ids</span></a></a><span>
</span><a name="line-958"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_rec_ids</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137467"><a href="#local-6989586621684137467"><span class="hs-identifier">rec_ids</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_ret_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137468"><a href="#local-6989586621684137468"><span class="hs-identifier">return_op</span></a></a><span>
</span><a name="line-959"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_mfix_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137469"><a href="#local-6989586621684137469"><span class="hs-identifier">mfix_op</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_bind_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137470"><a href="#local-6989586621684137470"><span class="hs-identifier">bind_op</span></a></a><span>
</span><a name="line-960"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">RecStmtTc</span><span>
</span><a name="line-961"></a><span>                        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">recS_bind_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137471"><a href="#local-6989586621684137471"><span class="hs-identifier">bind_ty</span></a></a><span>
</span><a name="line-962"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_rec_rets</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137472"><a href="#local-6989586621684137472"><span class="hs-identifier">rec_rets</span></a></a><span>
</span><a name="line-963"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">recS_ret_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684137473"><a href="#local-6989586621684137473"><span class="hs-identifier">body_ty</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684137474"><a href="#local-6989586621684137474"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-964"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137415"><span class="hs-identifier hs-var">goL</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137475"><span class="hs-identifier hs-var">new_bind_stmt</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684137474"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- rec_ids can be empty; eg  rec { print 'x' }</span><span>
</span><a name="line-965"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-966"></a><span>        </span><a name="local-6989586621684137475"><a href="#local-6989586621684137475"><span class="hs-identifier">new_bind_stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621684137464"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BindStmt</span><span> </span><a href="#local-6989586621684137471"><span class="hs-identifier hs-var">bind_ty</span></a><span> </span><span class="hs-special">(</span><a href="DsUtils.html#mkBigLHsPatTupId"><span class="hs-identifier hs-var">mkBigLHsPatTupId</span></a><span> </span><a href="#local-6989586621684137479"><span class="hs-identifier hs-var">later_pats</span></a><span class="hs-special">)</span><span>
</span><a name="line-967"></a><span>                                         </span><a href="#local-6989586621684137481"><span class="hs-identifier hs-var">mfix_app</span></a><span> </span><a href="#local-6989586621684137470"><span class="hs-identifier hs-var">bind_op</span></a><span>
</span><a name="line-968"></a><span>                                         </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>  </span><span class="hs-comment">-- Tuple cannot fail</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span>        </span><a name="local-6989586621684137476"><a href="#local-6989586621684137476"><span class="hs-identifier">tup_ids</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137467"><span class="hs-identifier hs-var">rec_ids</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684137467"><span class="hs-identifier hs-var">rec_ids</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137466"><span class="hs-identifier hs-var">later_ids</span></a><span>
</span><a name="line-971"></a><span>        </span><a name="local-6989586621684137477"><a href="#local-6989586621684137477"><span class="hs-identifier">tup_ty</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkBigCoreTupTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684137476"><span class="hs-identifier hs-var">tup_ids</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Deals with singleton case</span><span>
</span><a name="line-972"></a><span>        </span><a name="local-6989586621684137478"><a href="#local-6989586621684137478"><span class="hs-identifier">rec_tup_pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nlVarPat</span><span> </span><a href="#local-6989586621684137476"><span class="hs-identifier hs-var">tup_ids</span></a><span>
</span><a name="line-973"></a><span>        </span><a name="local-6989586621684137479"><a href="#local-6989586621684137479"><span class="hs-identifier">later_pats</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684137478"><span class="hs-identifier hs-var">rec_tup_pats</span></a><span>
</span><a name="line-974"></a><span>        </span><a name="local-6989586621684137480"><a href="#local-6989586621684137480"><span class="hs-identifier">rets</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621684137472"><span class="hs-identifier hs-var">rec_rets</span></a><span>
</span><a name="line-975"></a><span>        </span><a name="local-6989586621684137481"><a href="#local-6989586621684137481"><span class="hs-identifier">mfix_app</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsSyntaxApps</span><span> </span><a href="#local-6989586621684137469"><span class="hs-identifier hs-var">mfix_op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137482"><span class="hs-identifier hs-var">mfix_arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-976"></a><span>        </span><a name="local-6989586621684137482"><a href="#local-6989586621684137482"><span class="hs-identifier">mfix_arg</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsLam</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-977"></a><span>                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">MG</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">mg_alts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkSimpleMatch</span><span>
</span><a name="line-978"></a><span>                                                    </span><span class="hs-identifier hs-var">LambdaExpr</span><span>
</span><a name="line-979"></a><span>                                                    </span><span class="hs-special">[</span><a href="#local-6989586621684137483"><span class="hs-identifier hs-var">mfix_pat</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684137484"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">]</span><span>
</span><a name="line-980"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MatchGroupTc</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137477"><span class="hs-identifier hs-var">tup_ty</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684137473"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-981"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mg_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Generated</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>        </span><a name="local-6989586621684137483"><a href="#local-6989586621684137483"><span class="hs-identifier">mfix_pat</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">LazyPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DsUtils.html#mkBigLHsPatTupId"><span class="hs-identifier hs-var">mkBigLHsPatTupId</span></a><span> </span><a href="#local-6989586621684137478"><span class="hs-identifier hs-var">rec_tup_pats</span></a><span>
</span><a name="line-983"></a><span>        </span><a name="local-6989586621684137484"><a href="#local-6989586621684137484"><span class="hs-identifier">body</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsDo</span><span> </span><a href="#local-6989586621684137473"><span class="hs-identifier hs-var">body_ty</span></a><span>
</span><a name="line-984"></a><span>                                </span><span class="hs-identifier hs-var">DoExpr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137465"><span class="hs-identifier hs-var">rec_stmts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137486"><span class="hs-identifier hs-var">ret_stmt</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-985"></a><span>        </span><a name="local-6989586621684137485"><a href="#local-6989586621684137485"><span class="hs-identifier">ret_app</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsSyntaxApps</span><span> </span><a href="#local-6989586621684137468"><span class="hs-identifier hs-var">return_op</span></a><span> </span><span class="hs-special">[</span><a href="DsUtils.html#mkBigLHsTupId"><span class="hs-identifier hs-var">mkBigLHsTupId</span></a><span> </span><a href="#local-6989586621684137480"><span class="hs-identifier hs-var">rets</span></a><span class="hs-special">]</span><span>
</span><a name="line-986"></a><span>        </span><a name="local-6989586621684137486"><a href="#local-6989586621684137486"><span class="hs-identifier">ret_stmt</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLastStmt</span><span> </span><a href="#local-6989586621684137485"><span class="hs-identifier hs-var">ret_app</span></a><span>
</span><a name="line-987"></a><span>                     </span><span class="hs-comment">-- This LastStmt will be desugared with dsDo,</span><span>
</span><a name="line-988"></a><span>                     </span><span class="hs-comment">-- which ignores the return_op in the LastStmt,</span><span>
</span><a name="line-989"></a><span>                     </span><span class="hs-comment">-- so we must apply the return_op explicitly</span><span>
</span><a name="line-990"></a><span>
</span><a name="line-991"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParStmt</span><span>   </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsDo ParStmt&quot;</span><span>
</span><a name="line-992"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TransStmt</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsDo TransStmt&quot;</span><span>
</span><a name="line-993"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XStmtLR</span><span>   </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;dsDo XStmtLR&quot;</span><span>
</span><a name="line-994"></a><span>
</span><a name="line-995"></a><span class="hs-identifier">handle_failure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#MatchResult"><span class="hs-identifier hs-type">MatchResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SyntaxExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-996"></a><span>    </span><span class="hs-comment">-- In a do expression, pattern-match failure just calls</span><span>
</span><a name="line-997"></a><span>    </span><span class="hs-comment">-- the monadic 'fail' rather than throwing an exception</span><span>
</span><a name="line-998"></a><a name="handle_failure"><a href="DsExpr.html#handle_failure"><span class="hs-identifier">handle_failure</span></a></a><span> </span><a name="local-6989586621684137487"><a href="#local-6989586621684137487"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621684137488"><a href="#local-6989586621684137488"><span class="hs-identifier">match</span></a></a><span> </span><a name="local-6989586621684137489"><a href="#local-6989586621684137489"><span class="hs-identifier">fail_op</span></a></a><span>
</span><a name="line-999"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="DsUtils.html#matchCanFail"><span class="hs-identifier hs-var">matchCanFail</span></a><span> </span><a href="#local-6989586621684137488"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-1000"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137490"><a href="#local-6989586621684137490"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1001"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137491"><a href="#local-6989586621684137491"><span class="hs-identifier">fail_msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkStringExpr</span><span> </span><span class="hs-special">(</span><a href="DsExpr.html#mk_fail_msg"><span class="hs-identifier hs-var">mk_fail_msg</span></a><span> </span><a href="#local-6989586621684137490"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684137487"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137492"><a href="#local-6989586621684137492"><span class="hs-identifier">fail_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsExpr.html#dsSyntaxExpr"><span class="hs-identifier hs-var">dsSyntaxExpr</span></a><span> </span><a href="#local-6989586621684137489"><span class="hs-identifier hs-var">fail_op</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684137491"><span class="hs-identifier hs-var">fail_msg</span></a><span class="hs-special">]</span><span>
</span><a name="line-1003"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier hs-var">extractMatchResult</span></a><span> </span><a href="#local-6989586621684137488"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684137492"><span class="hs-identifier hs-var">fail_expr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1004"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1005"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsUtils.html#extractMatchResult"><span class="hs-identifier hs-var">extractMatchResult</span></a><span> </span><a href="#local-6989586621684137488"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;It can't fail&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1006"></a><span>
</span><a name="line-1007"></a><span class="hs-identifier">mk_fail_msg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621684137063"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684137063"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-1008"></a><a name="mk_fail_msg"><a href="DsExpr.html#mk_fail_msg"><span class="hs-identifier">mk_fail_msg</span></a></a><span> </span><a name="local-6989586621684137493"><a href="#local-6989586621684137493"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684137494"><a href="#local-6989586621684137494"><span class="hs-identifier">pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Pattern match failure in do expression at &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1009"></a><span>                         </span><span class="hs-identifier hs-var">showPpr</span><span> </span><a href="#local-6989586621684137493"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621684137494"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-1010"></a><span>
</span><a name="line-1011"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
   Desugaring Variables
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-identifier">dsHsVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- are we directly inside an HsWrap?</span><span>
</span><a name="line-1020"></a><span>                 </span><span class="hs-comment">-- See Wrinkle in Note [Detecting forced eta expansion]</span><span>
</span><a name="line-1021"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1022"></a><a name="dsHsVar"><a href="DsExpr.html#dsHsVar"><span class="hs-identifier">dsHsVar</span></a></a><span> </span><a name="local-6989586621684137495"><a href="#local-6989586621684137495"><span class="hs-identifier">w</span></a></a><span> </span><a name="local-6989586621684137496"><a href="#local-6989586621684137496"><span class="hs-identifier">var</span></a></a><span>
</span><a name="line-1023"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684137495"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-1024"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137498"><a href="#local-6989586621684137498"><span class="hs-identifier">bad_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#badUseOfLevPolyPrimop"><span class="hs-identifier hs-var">badUseOfLevPolyPrimop</span></a><span> </span><a href="#local-6989586621684137496"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684137497"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1025"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137498"><span class="hs-identifier hs-var">bad_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="DsExpr.html#levPolyPrimopErr"><span class="hs-identifier hs-var">levPolyPrimopErr</span></a><span> </span><a href="#local-6989586621684137496"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684137497"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684137498"><span class="hs-identifier hs-var">bad_tys</span></a><span>
</span><a name="line-1027"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">unitExpr</span><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- return something eminently safe</span><span>
</span><a name="line-1028"></a><span>
</span><a name="line-1029"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1030"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">varToCoreExpr</span><span> </span><a href="#local-6989586621684137496"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- See Note [Desugaring vars]</span><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1033"></a><span>    </span><a name="local-6989586621684137497"><a href="#local-6989586621684137497"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621684137496"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1034"></a><span>
</span><a name="line-1035"></a><span class="hs-identifier">dsConLike</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- as in dsHsVar</span><span>
</span><a name="line-1036"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-identifier hs-type">CoreExpr</span><span>
</span><a name="line-1037"></a><a name="dsConLike"><a href="DsExpr.html#dsConLike"><span class="hs-identifier">dsConLike</span></a></a><span> </span><a name="local-6989586621684137499"><a href="#local-6989586621684137499"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621684137500"><a href="#local-6989586621684137500"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#dsHsVar"><span class="hs-identifier hs-var">dsHsVar</span></a><span> </span><a href="#local-6989586621684137499"><span class="hs-identifier hs-var">w</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWrapId</span><span> </span><a href="#local-6989586621684137500"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1038"></a><span class="hs-identifier">dsConLike</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621684137501"><a href="#local-6989586621684137501"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">patSynBuilder</span><span> </span><a href="#local-6989586621684137501"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1039"></a><span>  </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137502"><a href="#local-6989586621684137502"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137503"><a href="#local-6989586621684137503"><span class="hs-identifier">add_void</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1040"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684137503"><span class="hs-identifier hs-var">add_void</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkCoreApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;dsConLike&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137501"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684137502"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Var</span><span> </span><span class="hs-identifier hs-var">voidPrimId</span><span class="hs-special">)</span><span>
</span><a name="line-1041"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Var</span><span> </span><a href="#local-6989586621684137502"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1042"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;dsConLike&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137501"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1043"></a><span>
</span><a name="line-1044"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Errors and contexts}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1051"></a><span>
</span><a name="line-1052"></a><span class="hs-comment">-- Warn about certain types of values discarded in monadic bindings (#3263)</span><span>
</span><a name="line-1053"></a><span class="hs-identifier">warnDiscardedDoBindings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1054"></a><a name="warnDiscardedDoBindings"><a href="DsExpr.html#warnDiscardedDoBindings"><span class="hs-identifier">warnDiscardedDoBindings</span></a></a><span> </span><a name="local-6989586621684137504"><a href="#local-6989586621684137504"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621684137505"><a href="#local-6989586621684137505"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-1055"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137506"><a href="#local-6989586621684137506"><span class="hs-identifier">m_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684137507"><a href="#local-6989586621684137507"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span><span> </span><a href="#local-6989586621684137505"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1056"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137508"><a href="#local-6989586621684137508"><span class="hs-identifier">warn_unused</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnUnusedDoBind</span><span>
</span><a name="line-1057"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684137509"><a href="#local-6989586621684137509"><span class="hs-identifier">warn_wrong</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnWrongDoBind</span><span>
</span><a name="line-1058"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684137508"><span class="hs-identifier hs-var">warn_unused</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684137509"><span class="hs-identifier hs-var">warn_wrong</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1059"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684137510"><a href="#local-6989586621684137510"><span class="hs-identifier">fam_inst_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DsMonad.html#dsGetFamInstEnvs"><span class="hs-identifier hs-var">dsGetFamInstEnvs</span></a><span>
</span><a name="line-1060"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137511"><a href="#local-6989586621684137511"><span class="hs-identifier">norm_elt_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">topNormaliseType</span><span> </span><a href="#local-6989586621684137510"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621684137507"><span class="hs-identifier hs-var">elt_ty</span></a><span>
</span><a name="line-1061"></a><span>
</span><a name="line-1062"></a><span>           </span><span class="hs-comment">-- Warn about discarding non-() things in 'monadic' binding</span><span>
</span><a name="line-1063"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684137508"><span class="hs-identifier hs-var">warn_unused</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnitTy</span><span> </span><a href="#local-6989586621684137511"><span class="hs-identifier hs-var">norm_elt_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1064"></a><span>         </span><span class="hs-keyword">then</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnUnusedDoBind</span><span class="hs-special">)</span><span>
</span><a name="line-1065"></a><span>                     </span><span class="hs-special">(</span><a href="DsExpr.html#badMonadBind"><span class="hs-identifier hs-var">badMonadBind</span></a><span> </span><a href="#local-6989586621684137504"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684137507"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1066"></a><span>         </span><span class="hs-keyword">else</span><span>
</span><a name="line-1067"></a><span>
</span><a name="line-1068"></a><span>           </span><span class="hs-comment">-- Warn about discarding m a things in 'monadic' binding of the same type,</span><span>
</span><a name="line-1069"></a><span>           </span><span class="hs-comment">-- but only if we didn't already warn due to Opt_WarnUnusedDoBind</span><span>
</span><a name="line-1070"></a><span>           </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621684137509"><span class="hs-identifier hs-var">warn_wrong</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1071"></a><span>                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span><span> </span><a href="#local-6989586621684137511"><span class="hs-identifier hs-var">norm_elt_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1072"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684137512"><a href="#local-6989586621684137512"><span class="hs-identifier">elt_m_ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1073"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684137506"><span class="hs-identifier hs-var">m_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">topNormaliseType</span><span> </span><a href="#local-6989586621684137510"><span class="hs-identifier hs-var">fam_inst_envs</span></a><span> </span><a href="#local-6989586621684137512"><span class="hs-identifier hs-var">elt_m_ty</span></a><span>
</span><a name="line-1074"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DsMonad.html#warnDs"><span class="hs-identifier hs-var">warnDs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnWrongDoBind</span><span class="hs-special">)</span><span>
</span><a name="line-1075"></a><span>                                      </span><span class="hs-special">(</span><a href="DsExpr.html#badMonadBind"><span class="hs-identifier hs-var">badMonadBind</span></a><span> </span><a href="#local-6989586621684137504"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684137507"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1076"></a><span>                         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1077"></a><span>
</span><a name="line-1078"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- RHS does have type of form (m ty), which is weird</span><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- but at lesat this warning is irrelevant</span><span>
</span><a name="line-1080"></a><span>
</span><a name="line-1081"></a><span class="hs-identifier">badMonadBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1082"></a><a name="badMonadBind"><a href="DsExpr.html#badMonadBind"><span class="hs-identifier">badMonadBind</span></a></a><span> </span><a name="local-6989586621684137513"><a href="#local-6989586621684137513"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621684137514"><a href="#local-6989586621684137514"><span class="hs-identifier">elt_ty</span></a></a><span>
</span><a name="line-1083"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;A do-notation statement discarded a result of type&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1084"></a><span>              </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137514"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1085"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Suppress this warning by saying&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1086"></a><span>              </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;_ &lt;-&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137513"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-1088"></a><span>
</span><a name="line-1089"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
   Forced eta expansion and levity polymorphism
*                                                                      *
************************************************************************

Note [Detecting forced eta expansion]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We cannot have levity polymorphic function arguments. See
Note [Levity polymorphism invariants] in CoreSyn. But we *can* have
functions that take levity polymorphism arguments, as long as these
functions are eta-reduced. (See #12708 for an example.)

However, we absolutely cannot do this for functions that have no
binding (i.e., say True to Id.hasNoBinding), like primops and unboxed
tuple constructors. These get eta-expanded in CorePrep.maybeSaturate.

Detecting when this is about to happen is a bit tricky, though. When
the desugarer is looking at the Id itself (let's be concrete and
suppose we have (#,#)), we don't know whether it will be levity
polymorphic. So the right spot seems to be to look after the Id has
been applied to its type arguments. To make the algorithm efficient,
it's important to be able to spot ((#,#) @a @b @c @d) without looking
past all the type arguments. We thus require that
  * The body of an HsWrap is not an HsWrap.
With that representation invariant, we simply look inside every HsWrap
to see if its body is an HsVar whose Id hasNoBinding. Then, we look
at the wrapped type. If it has any levity polymorphic arguments, reject.

Interestingly, this approach does not look to see whether the Id in
question will be eta expanded. The logic is this:
  * Either the Id in question is saturated or not.
  * If it is, then it surely can't have levity polymorphic arguments.
    If its wrapped type contains levity polymorphic arguments, reject.
  * If it's not, then it can't be eta expanded with levity polymorphic
    argument. If its wrapped type contains levity polymorphic arguments, reject.
So, either way, we're good to reject.

Wrinkle
~~~~~~~
Not all polymorphic Ids are wrapped in
HsWrap, due to the lazy instantiation of TypeApplications. (See &quot;Visible type
application&quot;, ESOP '16.) But if we spot a levity-polymorphic hasNoBinding Id
without a wrapper, then that is surely problem and we can reject.

We thus have a parameter to `dsExpr` that tracks whether or not we are
directly in an HsWrap. If we find a levity-polymorphic hasNoBinding Id when
we're not directly in an HsWrap, reject.

-}</span><span>
</span><a name="line-1140"></a><span>
</span><a name="line-1141"></a><span class="hs-comment">-- | Takes an expression and its instantiated type. If the expression is an</span><span>
</span><a name="line-1142"></a><span class="hs-comment">-- HsVar with a hasNoBinding primop and the type has levity-polymorphic arguments,</span><span>
</span><a name="line-1143"></a><span class="hs-comment">-- issue an error. See Note [Detecting forced eta expansion]</span><span>
</span><a name="line-1144"></a><span class="hs-identifier">checkForcedEtaExpansion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1145"></a><a name="checkForcedEtaExpansion"><a href="DsExpr.html#checkForcedEtaExpansion"><span class="hs-identifier">checkForcedEtaExpansion</span></a></a><span> </span><a name="local-6989586621684137515"><a href="#local-6989586621684137515"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684137516"><a href="#local-6989586621684137516"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1146"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684137519"><a href="#local-6989586621684137519"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684137515"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1147"></a><span>                  </span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684137517"><a href="#local-6989586621684137517"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684137517"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-1148"></a><span>                  </span><span class="hs-identifier hs-var">HsConLikeOut</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621684137518"><a href="#local-6989586621684137518"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConWrapId</span><span> </span><a href="#local-6989586621684137518"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1149"></a><span>                  </span><span class="hs-identifier">_</span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1150"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684137520"><a href="#local-6989586621684137520"><span class="hs-identifier">bad_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#badUseOfLevPolyPrimop"><span class="hs-identifier hs-var">badUseOfLevPolyPrimop</span></a><span> </span><a href="#local-6989586621684137519"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684137516"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1151"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684137520"><span class="hs-identifier hs-var">bad_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1152"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsExpr.html#levPolyPrimopErr"><span class="hs-identifier hs-var">levPolyPrimopErr</span></a><span> </span><a href="#local-6989586621684137519"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684137516"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684137520"><span class="hs-identifier hs-var">bad_tys</span></a><span>
</span><a name="line-1153"></a><span class="hs-identifier">checkForcedEtaExpansion</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>
</span><a name="line-1155"></a><span class="hs-comment">-- | Is this a hasNoBinding Id with a levity-polymorphic type?</span><span>
</span><a name="line-1156"></a><span class="hs-comment">-- Returns the arguments that are levity polymorphic if they are bad;</span><span>
</span><a name="line-1157"></a><span class="hs-comment">-- or an empty list otherwise</span><span>
</span><a name="line-1158"></a><span class="hs-comment">-- See Note [Detecting forced eta expansion]</span><span>
</span><a name="line-1159"></a><span class="hs-identifier">badUseOfLevPolyPrimop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-1160"></a><a name="badUseOfLevPolyPrimop"><a href="DsExpr.html#badUseOfLevPolyPrimop"><span class="hs-identifier">badUseOfLevPolyPrimop</span></a></a><span> </span><a name="local-6989586621684137521"><a href="#local-6989586621684137521"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684137522"><a href="#local-6989586621684137522"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1161"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">hasNoBinding</span><span> </span><a href="#local-6989586621684137521"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1162"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isTypeLevPoly</span><span> </span><a href="#local-6989586621684137524"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-1163"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1164"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1165"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1166"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684137523"><a href="#local-6989586621684137523"><span class="hs-identifier">binders</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitPiTys</span><span> </span><a href="#local-6989586621684137522"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1167"></a><span>    </span><a name="local-6989586621684137524"><a href="#local-6989586621684137524"><span class="hs-identifier">arg_tys</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-identifier hs-var">binderRelevantType_maybe</span><span> </span><a href="#local-6989586621684137523"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-1168"></a><span>
</span><a name="line-1169"></a><span class="hs-identifier">levPolyPrimopErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DsM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1170"></a><a name="levPolyPrimopErr"><a href="DsExpr.html#levPolyPrimopErr"><span class="hs-identifier">levPolyPrimopErr</span></a></a><span> </span><a name="local-6989586621684137525"><a href="#local-6989586621684137525"><span class="hs-identifier">primop</span></a></a><span> </span><a name="local-6989586621684137526"><a href="#local-6989586621684137526"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684137527"><a href="#local-6989586621684137527"><span class="hs-identifier">bad_tys</span></a></a><span>
</span><a name="line-1171"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DsMonad.html#errDs"><span class="hs-identifier hs-var">errDs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cannot use primitive with levity-polymorphic arguments:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1172"></a><span>                      </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621684137525"><span class="hs-identifier hs-var">primop</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithTYPE</span><span> </span><a href="#local-6989586621684137526"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1173"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Levity-polymorphic arguments:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1174"></a><span>                      </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684137528"><a href="#local-6989586621684137528"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithTYPE</span><span> </span><a href="#local-6989586621684137528"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithTYPE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeKind</span><span> </span><a href="#local-6989586621684137528"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684137527"><span class="hs-identifier hs-var">bad_tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1175"></a></pre></body></html>