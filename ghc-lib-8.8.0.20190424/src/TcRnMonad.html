<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006


Functions for working with the typechecker environment (setters, getters...).
-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE CPP, ExplicitForAll, FlexibleInstances, BangPatterns #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcRnMonad</span><span class="hs-special">(</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-comment">-- * Initalisation</span><span>
</span><a name="line-16"></a><span>  </span><a href="TcRnMonad.html#initTc"><span class="hs-identifier hs-var">initTc</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#initTcWithGbl"><span class="hs-identifier hs-var">initTcWithGbl</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#initTcInteractive"><span class="hs-identifier hs-var">initTcInteractive</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#initTcRnIf"><span class="hs-identifier hs-var">initTcRnIf</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-comment">-- * Simple accessors</span><span>
</span><a name="line-19"></a><span>  </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>  </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#updTopEnv"><span class="hs-identifier hs-var">updTopEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier hs-var">updGblEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>  </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>  </span><a href="TcRnMonad.html#getEnvs"><span class="hs-identifier hs-var">getEnvs</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>  </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#doptM"><span class="hs-identifier hs-var">doptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>  </span><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier hs-var">setXOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#unsetXOptM"><span class="hs-identifier hs-var">unsetXOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#unsetGOptM"><span class="hs-identifier hs-var">unsetGOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#unsetWOptM"><span class="hs-identifier hs-var">unsetWOptM</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>  </span><a href="TcRnMonad.html#whenDOptM"><span class="hs-identifier hs-var">whenDOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#whenGOptM"><span class="hs-identifier hs-var">whenGOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>  </span><a href="TcRnMonad.html#whenXOptM"><span class="hs-identifier hs-var">whenXOptM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#unlessXOptM"><span class="hs-identifier hs-var">unlessXOptM</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>  </span><a href="TcRnMonad.html#getGhcMode"><span class="hs-identifier hs-var">getGhcMode</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>  </span><a href="TcRnMonad.html#withDoDynamicToo"><span class="hs-identifier hs-var">withDoDynamicToo</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>  </span><a href="TcRnMonad.html#getEpsVar"><span class="hs-identifier hs-var">getEpsVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>  </span><a href="TcRnMonad.html#getEps"><span class="hs-identifier hs-var">getEps</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>  </span><a href="TcRnMonad.html#updateEps"><span class="hs-identifier hs-var">updateEps</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#updateEps_"><span class="hs-identifier hs-var">updateEps_</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>  </span><a href="TcRnMonad.html#getHpt"><span class="hs-identifier hs-var">getHpt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getEpsAndHpt"><span class="hs-identifier hs-var">getEpsAndHpt</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-comment">-- * Arrow scopes</span><span>
</span><a name="line-35"></a><span>  </span><a href="TcRnMonad.html#newArrowScope"><span class="hs-identifier hs-var">newArrowScope</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#escapeArrowScope"><span class="hs-identifier hs-var">escapeArrowScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-comment">-- * Unique supply</span><span>
</span><a name="line-38"></a><span>  </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#newName"><span class="hs-identifier hs-var">newName</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#newNameAt"><span class="hs-identifier hs-var">newNameAt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#cloneLocalName"><span class="hs-identifier hs-var">cloneLocalName</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>  </span><a href="TcRnMonad.html#newSysName"><span class="hs-identifier hs-var">newSysName</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#newSysLocalId"><span class="hs-identifier hs-var">newSysLocalId</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#newSysLocalIds"><span class="hs-identifier hs-var">newSysLocalIds</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-comment">-- * Accessing input/output</span><span>
</span><a name="line-42"></a><span>  </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-comment">-- * Debugging</span><span>
</span><a name="line-45"></a><span>  </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#traceTcRn"><span class="hs-identifier hs-var">traceTcRn</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#traceTcRnForUser"><span class="hs-identifier hs-var">traceTcRnForUser</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>  </span><a href="TcRnMonad.html#traceTcRnWithStyle"><span class="hs-identifier hs-var">traceTcRnWithStyle</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>  </span><a href="TcRnMonad.html#getPrintUnqualified"><span class="hs-identifier hs-var">getPrintUnqualified</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>  </span><a href="TcRnMonad.html#printForUserTcRn"><span class="hs-identifier hs-var">printForUserTcRn</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>  </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier hs-var">traceHiDiffs</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#traceOptIf"><span class="hs-identifier hs-var">traceOptIf</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>  </span><a href="TcRnMonad.html#debugTc"><span class="hs-identifier hs-var">debugTc</span></a><span class="hs-special">,</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span>  </span><span class="hs-comment">-- * Typechecker global environment</span><span>
</span><a name="line-53"></a><span>  </span><a href="TcRnMonad.html#getIsGHCi"><span class="hs-identifier hs-var">getIsGHCi</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getGHCiMonad"><span class="hs-identifier hs-var">getGHCiMonad</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getInteractivePrintName"><span class="hs-identifier hs-var">getInteractivePrintName</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>  </span><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier hs-var">tcIsHsBootOrSig</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#tcIsHsig"><span class="hs-identifier hs-var">tcIsHsig</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#tcSelfBootInfo"><span class="hs-identifier hs-var">tcSelfBootInfo</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>  </span><a href="TcRnMonad.html#getRdrEnvs"><span class="hs-identifier hs-var">getRdrEnvs</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getImports"><span class="hs-identifier hs-var">getImports</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>  </span><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier hs-var">getFixityEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#extendFixityEnv"><span class="hs-identifier hs-var">extendFixityEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getRecFieldEnv"><span class="hs-identifier hs-var">getRecFieldEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>  </span><a href="TcRnMonad.html#getDeclaredDefaultTys"><span class="hs-identifier hs-var">getDeclaredDefaultTys</span></a><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>  </span><a href="TcRnMonad.html#addDependentFiles"><span class="hs-identifier hs-var">addDependentFiles</span></a><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>  </span><span class="hs-comment">-- * Error management</span><span>
</span><a name="line-61"></a><span>  </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>  </span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier hs-var">wrapLocFstM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#wrapLocSndM"><span class="hs-identifier hs-var">wrapLocSndM</span></a><span class="hs-special">,</span><a href="TcRnMonad.html#wrapLocM_"><span class="hs-identifier hs-var">wrapLocM_</span></a><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>  </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setErrsVar"><span class="hs-identifier hs-var">setErrsVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>  </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span>  </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#failAt"><span class="hs-identifier hs-var">failAt</span></a><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>  </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addErrs"><span class="hs-identifier hs-var">addErrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-67"></a><span>  </span><a href="TcRnMonad.html#checkErr"><span class="hs-identifier hs-var">checkErr</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>  </span><a href="TcRnMonad.html#addMessages"><span class="hs-identifier hs-var">addMessages</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>  </span><a href="TcRnMonad.html#discardWarnings"><span class="hs-identifier hs-var">discardWarnings</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-comment">-- * Shared error message stuff: renamer and typechecker</span><span>
</span><a name="line-72"></a><span>  </span><a href="TcRnMonad.html#mkLongErrAt"><span class="hs-identifier hs-var">mkLongErrAt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#mkErrDocAt"><span class="hs-identifier hs-var">mkErrDocAt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addLongErrAt"><span class="hs-identifier hs-var">addLongErrAt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#reportErrors"><span class="hs-identifier hs-var">reportErrors</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#reportError"><span class="hs-identifier hs-var">reportError</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>  </span><a href="TcRnMonad.html#reportWarning"><span class="hs-identifier hs-var">reportWarning</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#recoverM"><span class="hs-identifier hs-var">recoverM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#mapAndRecoverM"><span class="hs-identifier hs-var">mapAndRecoverM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#mapAndReportM"><span class="hs-identifier hs-var">mapAndReportM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#foldAndRecoverM"><span class="hs-identifier hs-var">foldAndRecoverM</span></a><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>  </span><a href="TcRnMonad.html#try_m"><span class="hs-identifier hs-var">try_m</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#tryTc"><span class="hs-identifier hs-var">tryTc</span></a><span class="hs-special">,</span><span>
</span><a name="line-75"></a><span>  </span><a href="TcRnMonad.html#askNoErrs"><span class="hs-identifier hs-var">askNoErrs</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#discardErrs"><span class="hs-identifier hs-var">discardErrs</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#tryTcDiscardingErrs"><span class="hs-identifier hs-var">tryTcDiscardingErrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-76"></a><span>  </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#whenNoErrs"><span class="hs-identifier hs-var">whenNoErrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-77"></a><span>  </span><a href="TcRnMonad.html#ifErrsM"><span class="hs-identifier hs-var">ifErrsM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span class="hs-special">,</span><span>
</span><a name="line-78"></a><span>  </span><a href="TcRnMonad.html#checkTH"><span class="hs-identifier hs-var">checkTH</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#failTH"><span class="hs-identifier hs-var">failTH</span></a><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span>  </span><span class="hs-comment">-- * Context management for the type checker</span><span>
</span><a name="line-81"></a><span>  </span><a href="TcRnMonad.html#getErrCtxt"><span class="hs-identifier hs-var">getErrCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setErrCtxt"><span class="hs-identifier hs-var">setErrCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addLandmarkErrCtxt"><span class="hs-identifier hs-var">addLandmarkErrCtxt</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>  </span><a href="TcRnMonad.html#addLandmarkErrCtxtM"><span class="hs-identifier hs-var">addLandmarkErrCtxtM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#updCtxt"><span class="hs-identifier hs-var">updCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#popErrCtxt"><span class="hs-identifier hs-var">popErrCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getCtLocM"><span class="hs-identifier hs-var">getCtLocM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setCtLocM"><span class="hs-identifier hs-var">setCtLocM</span></a><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>  </span><span class="hs-comment">-- * Error message generation (type checker)</span><span>
</span><a name="line-85"></a><span>  </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addErrsTc"><span class="hs-identifier hs-var">addErrsTc</span></a><span class="hs-special">,</span><span>
</span><a name="line-86"></a><span>  </span><a href="TcRnMonad.html#addErrTcM"><span class="hs-identifier hs-var">addErrTcM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#mkErrTcM"><span class="hs-identifier hs-var">mkErrTcM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#mkErrTc"><span class="hs-identifier hs-var">mkErrTc</span></a><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>  </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#failWithTcM"><span class="hs-identifier hs-var">failWithTcM</span></a><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>  </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier hs-var">checkTcM</span></a><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>  </span><a href="TcRnMonad.html#failIfTc"><span class="hs-identifier hs-var">failIfTc</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#failIfTcM"><span class="hs-identifier hs-var">failIfTcM</span></a><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>  </span><a href="TcRnMonad.html#warnIfFlag"><span class="hs-identifier hs-var">warnIfFlag</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#warnIf"><span class="hs-identifier hs-var">warnIf</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#warnTc"><span class="hs-identifier hs-var">warnTc</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#warnTcM"><span class="hs-identifier hs-var">warnTcM</span></a><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>  </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addWarnTcM"><span class="hs-identifier hs-var">addWarnTcM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier hs-var">addWarnAt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#add_warn"><span class="hs-identifier hs-var">add_warn</span></a><span class="hs-special">,</span><span>
</span><a name="line-92"></a><span>  </span><a href="TcRnMonad.html#mkErrInfo"><span class="hs-identifier hs-var">mkErrInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>  </span><span class="hs-comment">-- * Type constraints</span><span>
</span><a name="line-95"></a><span>  </span><a href="TcRnMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">newTcEvBinds</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#newNoTcEvBinds"><span class="hs-identifier hs-var">newNoTcEvBinds</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#cloneEvBindsVar"><span class="hs-identifier hs-var">cloneEvBindsVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-96"></a><span>  </span><a href="TcRnMonad.html#addTcEvBind"><span class="hs-identifier hs-var">addTcEvBind</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#addTopEvBinds"><span class="hs-identifier hs-var">addTopEvBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-97"></a><span>  </span><a href="TcRnMonad.html#getTcEvTyCoVars"><span class="hs-identifier hs-var">getTcEvTyCoVars</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getTcEvBindsMap"><span class="hs-identifier hs-var">getTcEvBindsMap</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setTcEvBindsMap"><span class="hs-identifier hs-var">setTcEvBindsMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-98"></a><span>  </span><a href="TcRnMonad.html#chooseUniqueOccTc"><span class="hs-identifier hs-var">chooseUniqueOccTc</span></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>  </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setConstraintVar"><span class="hs-identifier hs-var">setConstraintVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>  </span><a href="TcRnMonad.html#emitConstraints"><span class="hs-identifier hs-var">emitConstraints</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#emitStaticConstraints"><span class="hs-identifier hs-var">emitStaticConstraints</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#emitSimple"><span class="hs-identifier hs-var">emitSimple</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#emitSimples"><span class="hs-identifier hs-var">emitSimples</span></a><span class="hs-special">,</span><span>
</span><a name="line-101"></a><span>  </span><a href="TcRnMonad.html#emitImplication"><span class="hs-identifier hs-var">emitImplication</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#emitImplications"><span class="hs-identifier hs-var">emitImplications</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#emitInsoluble"><span class="hs-identifier hs-var">emitInsoluble</span></a><span class="hs-special">,</span><span>
</span><a name="line-102"></a><span>  </span><a href="TcRnMonad.html#discardConstraints"><span class="hs-identifier hs-var">discardConstraints</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#tryCaptureConstraints"><span class="hs-identifier hs-var">tryCaptureConstraints</span></a><span class="hs-special">,</span><span>
</span><a name="line-103"></a><span>  </span><a href="TcRnMonad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier hs-var">pushLevelAndCaptureConstraints</span></a><span class="hs-special">,</span><span>
</span><a name="line-104"></a><span>  </span><a href="TcRnMonad.html#pushTcLevelM_"><span class="hs-identifier hs-var">pushTcLevelM_</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#pushTcLevelM"><span class="hs-identifier hs-var">pushTcLevelM</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#pushTcLevelsM"><span class="hs-identifier hs-var">pushTcLevelsM</span></a><span class="hs-special">,</span><span>
</span><a name="line-105"></a><span>  </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setTcLevel"><span class="hs-identifier hs-var">setTcLevel</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#isTouchableTcM"><span class="hs-identifier hs-var">isTouchableTcM</span></a><span class="hs-special">,</span><span>
</span><a name="line-106"></a><span>  </span><a href="TcRnMonad.html#getLclTypeEnv"><span class="hs-identifier hs-var">getLclTypeEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setLclTypeEnv"><span class="hs-identifier hs-var">setLclTypeEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-107"></a><span>  </span><a href="TcRnMonad.html#traceTcConstraints"><span class="hs-identifier hs-var">traceTcConstraints</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#emitWildCardHoleConstraints"><span class="hs-identifier hs-var">emitWildCardHoleConstraints</span></a><span class="hs-special">,</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>  </span><span class="hs-comment">-- * Template Haskell context</span><span>
</span><a name="line-110"></a><span>  </span><a href="TcRnMonad.html#recordThUse"><span class="hs-identifier hs-var">recordThUse</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#recordThSpliceUse"><span class="hs-identifier hs-var">recordThSpliceUse</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#recordTopLevelSpliceLoc"><span class="hs-identifier hs-var">recordTopLevelSpliceLoc</span></a><span class="hs-special">,</span><span>
</span><a name="line-111"></a><span>  </span><a href="TcRnMonad.html#getTopLevelSpliceLocs"><span class="hs-identifier hs-var">getTopLevelSpliceLocs</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#keepAlive"><span class="hs-identifier hs-var">keepAlive</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getStage"><span class="hs-identifier hs-var">getStage</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getStageAndBindLevel"><span class="hs-identifier hs-var">getStageAndBindLevel</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setStage"><span class="hs-identifier hs-var">setStage</span></a><span class="hs-special">,</span><span>
</span><a name="line-112"></a><span>  </span><a href="TcRnMonad.html#addModFinalizersWithLclEnv"><span class="hs-identifier hs-var">addModFinalizersWithLclEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span>  </span><span class="hs-comment">-- * Safe Haskell context</span><span>
</span><a name="line-115"></a><span>  </span><a href="TcRnMonad.html#recordUnsafeInfer"><span class="hs-identifier hs-var">recordUnsafeInfer</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#finalSafeMode"><span class="hs-identifier hs-var">finalSafeMode</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#fixSafeInstances"><span class="hs-identifier hs-var">fixSafeInstances</span></a><span class="hs-special">,</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span>  </span><span class="hs-comment">-- * Stuff for the renamer's local env</span><span>
</span><a name="line-118"></a><span>  </span><a href="TcRnMonad.html#getLocalRdrEnv"><span class="hs-identifier hs-var">getLocalRdrEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#setLocalRdrEnv"><span class="hs-identifier hs-var">setLocalRdrEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span>  </span><span class="hs-comment">-- * Stuff for interface decls</span><span>
</span><a name="line-121"></a><span>  </span><a href="TcRnMonad.html#mkIfLclEnv"><span class="hs-identifier hs-var">mkIfLclEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-122"></a><span>  </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span class="hs-special">,</span><span>
</span><a name="line-123"></a><span>  </span><a href="TcRnMonad.html#initIfaceCheck"><span class="hs-identifier hs-var">initIfaceCheck</span></a><span class="hs-special">,</span><span>
</span><a name="line-124"></a><span>  </span><a href="TcRnMonad.html#initIfaceLcl"><span class="hs-identifier hs-var">initIfaceLcl</span></a><span class="hs-special">,</span><span>
</span><a name="line-125"></a><span>  </span><a href="TcRnMonad.html#initIfaceLclWithSubst"><span class="hs-identifier hs-var">initIfaceLclWithSubst</span></a><span class="hs-special">,</span><span>
</span><a name="line-126"></a><span>  </span><a href="TcRnMonad.html#initIfaceLoad"><span class="hs-identifier hs-var">initIfaceLoad</span></a><span class="hs-special">,</span><span>
</span><a name="line-127"></a><span>  </span><a href="TcRnMonad.html#getIfModule"><span class="hs-identifier hs-var">getIfModule</span></a><span class="hs-special">,</span><span>
</span><a name="line-128"></a><span>  </span><a href="TcRnMonad.html#failIfM"><span class="hs-identifier hs-var">failIfM</span></a><span class="hs-special">,</span><span>
</span><a name="line-129"></a><span>  </span><a href="TcRnMonad.html#forkM_maybe"><span class="hs-identifier hs-var">forkM_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-130"></a><span>  </span><a href="TcRnMonad.html#forkM"><span class="hs-identifier hs-var">forkM</span></a><span class="hs-special">,</span><span>
</span><a name="line-131"></a><span>  </span><a href="TcRnMonad.html#setImplicitEnvM"><span class="hs-identifier hs-var">setImplicitEnvM</span></a><span class="hs-special">,</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span>  </span><a href="TcRnMonad.html#withException"><span class="hs-identifier hs-var">withException</span></a><span class="hs-special">,</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span>  </span><span class="hs-comment">-- * Stuff for cost centres.</span><span>
</span><a name="line-136"></a><span>  </span><a href="TcRnMonad.html#ContainsCostCentreState"><span class="hs-identifier hs-type">ContainsCostCentreState</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#getCCIndexM"><span class="hs-identifier hs-var">getCCIndexM</span></a><span class="hs-special">,</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-comment">-- * Types etc.</span><span>
</span><a name="line-139"></a><span>  </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcRnTypes</span><span class="hs-special">,</span><span>
</span><a name="line-140"></a><span>  </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IOEnv</span><span>
</span><a name="line-141"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-145"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcRnTypes</span><span>        </span><span class="hs-comment">-- Re-export all</span><span>
</span><a name="line-148"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IOEnv</span><span>            </span><span class="hs-comment">-- Re-export all</span><span>
</span><a name="line-149"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LIE</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-153"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-154"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-155"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-156"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-159"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-160"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-161"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-162"></a><span>
</span><a name="line-163"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-164"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-165"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-166"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-167"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-168"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-169"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-170"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-171"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-172"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-173"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-174"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-175"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-176"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-177"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Annotations</span><span>
</span><a name="line-178"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-180"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentreState</span><span>
</span><a name="line-181"></a><span>
</span><a name="line-182"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-185"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-186"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                        initTc
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-comment">-- | Setup the initial typechecking environment</span><span>
</span><a name="line-202"></a><span class="hs-identifier">initTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-203"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span>
</span><a name="line-204"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>          </span><span class="hs-comment">-- True &lt;=&gt; retain renamed syntax trees</span><span>
</span><a name="line-205"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-206"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RealSrcSpan</span><span>
</span><a name="line-207"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681325016"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-208"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681325016"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>                </span><span class="hs-comment">-- Nothing =&gt; error thrown by the thing inside</span><span>
</span><a name="line-210"></a><span>                </span><span class="hs-comment">-- (error messages should have been printed already)</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><a name="initTc"><a href="TcRnMonad.html#initTc"><span class="hs-identifier">initTc</span></a></a><span> </span><a name="local-6989586621681325017"><a href="#local-6989586621681325017"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681325018"><a href="#local-6989586621681325018"><span class="hs-identifier">hsc_src</span></a></a><span> </span><a name="local-6989586621681325019"><a href="#local-6989586621681325019"><span class="hs-identifier">keep_rn_syntax</span></a></a><span> </span><a name="local-6989586621681325020"><a href="#local-6989586621681325020"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681325021"><a href="#local-6989586621681325021"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325022"><a href="#local-6989586621681325022"><span class="hs-identifier">do_this</span></a></a><span>
</span><a name="line-213"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325023"><a href="#local-6989586621681325023"><span class="hs-identifier">keep_var</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-214"></a><span>        </span><a name="local-6989586621681325024"><a href="#local-6989586621681325024"><span class="hs-identifier">used_gre_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-215"></a><span>        </span><a name="local-6989586621681325025"><a href="#local-6989586621681325025"><span class="hs-identifier">th_var</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-216"></a><span>        </span><a name="local-6989586621681325026"><a href="#local-6989586621681325026"><span class="hs-identifier">th_splice_var</span></a></a><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-217"></a><span>        </span><a name="local-6989586621681325027"><a href="#local-6989586621681325027"><span class="hs-identifier">th_locs_var</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-218"></a><span>        </span><a name="local-6989586621681325028"><a href="#local-6989586621681325028"><span class="hs-identifier">infer_var</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-219"></a><span>        </span><a name="local-6989586621681325029"><a href="#local-6989586621681325029"><span class="hs-identifier">dfun_n_var</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyOccSet</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-220"></a><span>        </span><a name="local-6989586621681325032"><a href="#local-6989586621681325032"><span class="hs-identifier">type_env_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hsc_type_env_var</span><span> </span><a href="#local-6989586621681325017"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-221"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325030"><a href="#local-6989586621681325030"><span class="hs-identifier">_mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325031"><a href="#local-6989586621681325031"><span class="hs-identifier">te_var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325031"><span class="hs-identifier hs-var">te_var</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-222"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span>        </span><a name="local-6989586621681325033"><a href="#local-6989586621681325033"><span class="hs-identifier">dependent_files_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-225"></a><span>        </span><a name="local-6989586621681325034"><a href="#local-6989586621681325034"><span class="hs-identifier">static_wc_var</span></a></a><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyWC</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-226"></a><span>        </span><a name="local-6989586621681325035"><a href="#local-6989586621681325035"><span class="hs-identifier">cc_st_var</span></a></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">newCostCentreState</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-227"></a><span>        </span><a name="local-6989586621681325036"><a href="#local-6989586621681325036"><span class="hs-identifier">th_topdecls_var</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-228"></a><span>        </span><a name="local-6989586621681325037"><a href="#local-6989586621681325037"><span class="hs-identifier">th_foreign_files_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-229"></a><span>        </span><a name="local-6989586621681325038"><a href="#local-6989586621681325038"><span class="hs-identifier">th_topnames_var</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-230"></a><span>        </span><a name="local-6989586621681325039"><a href="#local-6989586621681325039"><span class="hs-identifier">th_modfinalizers_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-231"></a><span>        </span><a name="local-6989586621681325040"><a href="#local-6989586621681325040"><span class="hs-identifier">th_coreplugins_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-232"></a><span>        </span><a name="local-6989586621681325041"><a href="#local-6989586621681325041"><span class="hs-identifier">th_state_var</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-233"></a><span>        </span><a name="local-6989586621681325042"><a href="#local-6989586621681325042"><span class="hs-identifier">th_remote_state_var</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-235"></a><span>             </span><a name="local-6989586621681325043"><a href="#local-6989586621681325043"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681325017"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span>             </span><span class="hs-identifier">maybe_rn_syntax</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621681325046"><a href="#local-6989586621681325046"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621681325046"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681325046"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-238"></a><span>             </span><a name="local-6989586621681325044"><a href="#local-6989586621681325044"><span class="hs-identifier">maybe_rn_syntax</span></a></a><span> </span><a name="local-6989586621681325047"><a href="#local-6989586621681325047"><span class="hs-identifier">empty_val</span></a></a><span>
</span><a name="line-239"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_rn_ast</span><span> </span><a href="#local-6989586621681325043"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325047"><span class="hs-identifier hs-var">empty_val</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_WriteHie</span><span> </span><a href="#local-6989586621681325043"><span class="hs-identifier hs-var">dflags</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325047"><span class="hs-identifier hs-var">empty_val</span></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>                  </span><span class="hs-comment">-- We want to serialize the documentation in the .hi-files,</span><span>
</span><a name="line-244"></a><span>                  </span><span class="hs-comment">-- and need to extract it from the renamed syntax first.</span><span>
</span><a name="line-245"></a><span>                  </span><span class="hs-comment">-- See 'ExtractDocs.extractDocs'.</span><span>
</span><a name="line-246"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_Haddock</span><span> </span><a href="#local-6989586621681325043"><span class="hs-identifier hs-var">dflags</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325047"><span class="hs-identifier hs-var">empty_val</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681325019"><span class="hs-identifier hs-var">keep_rn_syntax</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325047"><span class="hs-identifier hs-var">empty_val</span></a><span>
</span><a name="line-249"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span>             </span><a name="local-6989586621681325045"><a href="#local-6989586621681325045"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TcGblEnv</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-252"></a><span>                </span><span class="hs-identifier">tcg_th_topdecls</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325036"><span class="hs-identifier hs-var">th_topdecls_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-253"></a><span>                </span><span class="hs-identifier">tcg_th_foreign_files</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325037"><span class="hs-identifier hs-var">th_foreign_files_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-254"></a><span>                </span><span class="hs-identifier">tcg_th_topnames</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325038"><span class="hs-identifier hs-var">th_topnames_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-255"></a><span>                </span><span class="hs-identifier">tcg_th_modfinalizers</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325039"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-256"></a><span>                </span><span class="hs-identifier">tcg_th_coreplugins</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325040"><span class="hs-identifier hs-var">th_coreplugins_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-257"></a><span>                </span><span class="hs-identifier">tcg_th_state</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325041"><span class="hs-identifier hs-var">th_state_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-258"></a><span>                </span><span class="hs-identifier">tcg_th_remote_state</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325042"><span class="hs-identifier hs-var">th_remote_state_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span>                </span><span class="hs-identifier">tcg_mod</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325020"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-261"></a><span>                </span><span class="hs-identifier">tcg_semantic_mod</span><span>   </span><span class="hs-glyph">=</span><span>
</span><a name="line-262"></a><span>                    </span><span class="hs-identifier hs-var">canonicalizeModuleIfHome</span><span> </span><a href="#local-6989586621681325043"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325020"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-263"></a><span>                </span><span class="hs-identifier">tcg_src</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325018"><span class="hs-identifier hs-var">hsc_src</span></a><span class="hs-special">,</span><span>
</span><a name="line-264"></a><span>                </span><span class="hs-identifier">tcg_rdr_env</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyGlobalRdrEnv</span><span class="hs-special">,</span><span>
</span><a name="line-265"></a><span>                </span><span class="hs-identifier">tcg_fix_env</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span class="hs-special">,</span><span>
</span><a name="line-266"></a><span>                </span><span class="hs-identifier">tcg_field_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span class="hs-special">,</span><span>
</span><a name="line-267"></a><span>                </span><span class="hs-identifier">tcg_default</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681325020"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">primUnitId</span><span>
</span><a name="line-268"></a><span>                                     </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- See Note [Default types]</span><span>
</span><a name="line-269"></a><span>                                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-270"></a><span>                </span><span class="hs-identifier">tcg_type_env</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span class="hs-special">,</span><span>
</span><a name="line-271"></a><span>                </span><span class="hs-identifier">tcg_type_env_var</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325032"><span class="hs-identifier hs-var">type_env_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-272"></a><span>                </span><span class="hs-identifier">tcg_inst_env</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyInstEnv</span><span class="hs-special">,</span><span>
</span><a name="line-273"></a><span>                </span><span class="hs-identifier">tcg_fam_inst_env</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFamInstEnv</span><span class="hs-special">,</span><span>
</span><a name="line-274"></a><span>                </span><span class="hs-identifier">tcg_ann_env</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyAnnEnv</span><span class="hs-special">,</span><span>
</span><a name="line-275"></a><span>                </span><span class="hs-identifier">tcg_th_used</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325025"><span class="hs-identifier hs-var">th_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-276"></a><span>                </span><span class="hs-identifier">tcg_th_splice_used</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325026"><span class="hs-identifier hs-var">th_splice_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-277"></a><span>                </span><span class="hs-identifier">tcg_th_top_level_locs</span><span>
</span><a name="line-278"></a><span>                                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325027"><span class="hs-identifier hs-var">th_locs_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-279"></a><span>                </span><span class="hs-identifier">tcg_exports</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-280"></a><span>                </span><span class="hs-identifier">tcg_imports</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyImportAvails</span><span class="hs-special">,</span><span>
</span><a name="line-281"></a><span>                </span><span class="hs-identifier">tcg_used_gres</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325024"><span class="hs-identifier hs-var">used_gre_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-282"></a><span>                </span><span class="hs-identifier">tcg_dus</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyDUs</span><span class="hs-special">,</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span>                </span><span class="hs-identifier">tcg_rn_imports</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-285"></a><span>                </span><span class="hs-identifier">tcg_rn_exports</span><span>     </span><span class="hs-glyph">=</span><span>
</span><a name="line-286"></a><span>                    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681325018"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">HsigFile</span><span>
</span><a name="line-287"></a><span>                        </span><span class="hs-comment">-- Always retain renamed syntax, so that we can give</span><span>
</span><a name="line-288"></a><span>                        </span><span class="hs-comment">-- better errors.  (TODO: how?)</span><span>
</span><a name="line-289"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-290"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621681325044"><span class="hs-identifier hs-var">maybe_rn_syntax</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-291"></a><span>                </span><span class="hs-identifier">tcg_rn_decls</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325044"><span class="hs-identifier hs-var">maybe_rn_syntax</span></a><span> </span><span class="hs-identifier hs-var">emptyRnGroup</span><span class="hs-special">,</span><span>
</span><a name="line-292"></a><span>                </span><span class="hs-identifier">tcg_tr_module</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-293"></a><span>                </span><span class="hs-identifier">tcg_binds</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyLHsBinds</span><span class="hs-special">,</span><span>
</span><a name="line-294"></a><span>                </span><span class="hs-identifier">tcg_imp_specs</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-295"></a><span>                </span><span class="hs-identifier">tcg_sigs</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameSet</span><span class="hs-special">,</span><span>
</span><a name="line-296"></a><span>                </span><span class="hs-identifier">tcg_ev_binds</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span>
</span><a name="line-297"></a><span>                </span><span class="hs-identifier">tcg_warns</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoWarnings</span><span class="hs-special">,</span><span>
</span><a name="line-298"></a><span>                </span><span class="hs-identifier">tcg_anns</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-299"></a><span>                </span><span class="hs-identifier">tcg_tcs</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-300"></a><span>                </span><span class="hs-identifier">tcg_insts</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-301"></a><span>                </span><span class="hs-identifier">tcg_fam_insts</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-302"></a><span>                </span><span class="hs-identifier">tcg_rules</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-303"></a><span>                </span><span class="hs-identifier">tcg_fords</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-304"></a><span>                </span><span class="hs-identifier">tcg_patsyns</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-305"></a><span>                </span><span class="hs-identifier">tcg_merged</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-306"></a><span>                </span><span class="hs-identifier">tcg_dfun_n</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325029"><span class="hs-identifier hs-var">dfun_n_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-307"></a><span>                </span><span class="hs-identifier">tcg_keep</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325023"><span class="hs-identifier hs-var">keep_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-308"></a><span>                </span><span class="hs-identifier">tcg_doc_hdr</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-309"></a><span>                </span><span class="hs-identifier">tcg_hpc</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span>
</span><a name="line-310"></a><span>                </span><span class="hs-identifier">tcg_main</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-311"></a><span>                </span><span class="hs-identifier">tcg_self_boot</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoSelfBoot</span><span class="hs-special">,</span><span>
</span><a name="line-312"></a><span>                </span><span class="hs-identifier">tcg_safeInfer</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325028"><span class="hs-identifier hs-var">infer_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-313"></a><span>                </span><span class="hs-identifier">tcg_dependent_files</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325033"><span class="hs-identifier hs-var">dependent_files_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-314"></a><span>                </span><span class="hs-identifier">tcg_tc_plugins</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-315"></a><span>                </span><span class="hs-identifier">tcg_top_loc</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325021"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">,</span><span>
</span><a name="line-316"></a><span>                </span><span class="hs-identifier">tcg_static_wc</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325034"><span class="hs-identifier hs-var">static_wc_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-317"></a><span>                </span><span class="hs-identifier">tcg_complete_matches</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-318"></a><span>                </span><span class="hs-identifier">tcg_cc_st</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325035"><span class="hs-identifier hs-var">cc_st_var</span></a><span>
</span><a name="line-319"></a><span>             </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-320"></a><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span>        </span><span class="hs-comment">-- OK, here's the business end!</span><span>
</span><a name="line-323"></a><span>        </span><a href="TcRnMonad.html#initTcWithGbl"><span class="hs-identifier hs-var">initTcWithGbl</span></a><span> </span><a href="#local-6989586621681325017"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681325045"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><a href="#local-6989586621681325021"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325022"><span class="hs-identifier hs-var">do_this</span></a><span>
</span><a name="line-324"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span class="hs-comment">-- | Run a 'TcM' action in the context of an existing 'GblEnv'.</span><span>
</span><a name="line-327"></a><span class="hs-identifier">initTcWithGbl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-328"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-329"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RealSrcSpan</span><span>
</span><a name="line-330"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681325015"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-331"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681325015"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><a name="initTcWithGbl"><a href="TcRnMonad.html#initTcWithGbl"><span class="hs-identifier">initTcWithGbl</span></a></a><span> </span><a name="local-6989586621681325048"><a href="#local-6989586621681325048"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681325049"><a href="#local-6989586621681325049"><span class="hs-identifier">gbl_env</span></a></a><span> </span><a name="local-6989586621681325050"><a href="#local-6989586621681325050"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325051"><a href="#local-6989586621681325051"><span class="hs-identifier">do_this</span></a></a><span>
</span><a name="line-333"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325053"><a href="#local-6989586621681325053"><span class="hs-identifier">tvs_var</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-334"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325054"><a href="#local-6989586621681325054"><span class="hs-identifier">lie_var</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">emptyWC</span><span>
</span><a name="line-335"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325055"><a href="#local-6989586621681325055"><span class="hs-identifier">errs_var</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325056"><a href="#local-6989586621681325056"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TcLclEnv</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-337"></a><span>                </span><span class="hs-identifier">tcl_errs</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325055"><span class="hs-identifier hs-var">errs_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-338"></a><span>                </span><span class="hs-identifier">tcl_loc</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325050"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Should be over-ridden very soon!</span><span>
</span><a name="line-339"></a><span>                </span><span class="hs-identifier">tcl_ctxt</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-340"></a><span>                </span><span class="hs-identifier">tcl_rdr</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyLocalRdrEnv</span><span class="hs-special">,</span><span>
</span><a name="line-341"></a><span>                </span><span class="hs-identifier">tcl_th_ctxt</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">topStage</span><span class="hs-special">,</span><span>
</span><a name="line-342"></a><span>                </span><span class="hs-identifier">tcl_th_bndrs</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span class="hs-special">,</span><span>
</span><a name="line-343"></a><span>                </span><span class="hs-identifier">tcl_arrow_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoArrowCtxt</span><span class="hs-special">,</span><span>
</span><a name="line-344"></a><span>                </span><span class="hs-identifier">tcl_env</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyNameEnv</span><span class="hs-special">,</span><span>
</span><a name="line-345"></a><span>                </span><span class="hs-identifier">tcl_bndrs</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-346"></a><span>                </span><span class="hs-identifier">tcl_tyvars</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325053"><span class="hs-identifier hs-var">tvs_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-347"></a><span>                </span><span class="hs-identifier">tcl_lie</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325054"><span class="hs-identifier hs-var">lie_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-348"></a><span>                </span><span class="hs-identifier">tcl_tclvl</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">topTcLevel</span><span>
</span><a name="line-349"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325060"><a href="#local-6989586621681325060"><span class="hs-identifier">maybe_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#initTcRnIf"><span class="hs-identifier hs-var">initTcRnIf</span></a><span> </span><span class="hs-char">'a'</span><span> </span><a href="#local-6989586621681325048"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681325049"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><a href="#local-6989586621681325056"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-352"></a><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325058"><a href="#local-6989586621681325058"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryM</span><span> </span><a href="#local-6989586621681325051"><span class="hs-identifier hs-var">do_this</span></a><span>
</span><a name="line-353"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325058"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-354"></a><span>                          </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681325059"><a href="#local-6989586621681325059"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325059"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>                          </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-356"></a><span>
</span><a name="line-357"></a><span>      </span><span class="hs-comment">-- Check for unsolved constraints</span><span>
</span><a name="line-358"></a><span>      </span><span class="hs-comment">-- If we succeed (maybe_res = Just r), there should be</span><span>
</span><a name="line-359"></a><span>      </span><span class="hs-comment">-- no unsolved constraints.  But if we exit via an</span><span>
</span><a name="line-360"></a><span>      </span><span class="hs-comment">-- exception (maybe_res = Nothing), we may have skipped</span><span>
</span><a name="line-361"></a><span>      </span><span class="hs-comment">-- solving, so don't panic then (Trac #13466)</span><span>
</span><a name="line-362"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325061"><a href="#local-6989586621681325061"><span class="hs-identifier">lie</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_lie</span><span> </span><a href="#local-6989586621681325056"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621681325060"><span class="hs-identifier hs-var">maybe_res</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyWC</span><span> </span><a href="#local-6989586621681325061"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-364"></a><span>        </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;initTc: unsolved constraints&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325061"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span>        </span><span class="hs-comment">-- Collect any error messages</span><span>
</span><a name="line-367"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325062"><a href="#local-6989586621681325062"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_errs</span><span> </span><a href="#local-6989586621681325056"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325063"><a href="#local-6989586621681325063"><span class="hs-identifier">final_res</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">errorsFound</span><span> </span><a href="#local-6989586621681325052"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325062"><span class="hs-identifier hs-var">msgs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-370"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325060"><span class="hs-identifier hs-var">maybe_res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325062"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325063"><span class="hs-identifier hs-var">final_res</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-374"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681325052"><a href="#local-6989586621681325052"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681325048"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-identifier">initTcInteractive</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681325014"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681325014"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-377"></a><span class="hs-comment">-- Initialise the type checker monad for use in GHCi</span><span>
</span><a name="line-378"></a><a name="initTcInteractive"><a href="TcRnMonad.html#initTcInteractive"><span class="hs-identifier">initTcInteractive</span></a></a><span> </span><a name="local-6989586621681325064"><a href="#local-6989586621681325064"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681325065"><a href="#local-6989586621681325065"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-379"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#initTc"><span class="hs-identifier hs-var">initTc</span></a><span> </span><a href="#local-6989586621681325064"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-identifier hs-var">HsSrcFile</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-380"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">icInteractiveModule</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621681325064"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">realSrcLocSpan</span><span> </span><a href="#local-6989586621681325066"><span class="hs-identifier hs-var">interactive_src_loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>           </span><a href="#local-6989586621681325065"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-383"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-384"></a><span>    </span><a name="local-6989586621681325066"><a href="#local-6989586621681325066"><span class="hs-identifier">interactive_src_loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRealSrcLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;&lt;interactive&gt;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">{- Note [Default types]
~~~~~~~~~~~~~~~~~~~~~~~
The Integer type is simply not available in package ghc-prim (it is
declared in integer-gmp).  So we set the defaulting types to (Just
[]), meaning there are no default types, rather then Nothing, which
means &quot;use the default default types of Integer, Double&quot;.

If you don't do this, attempted defaulting in package ghc-prim causes
an actual crash (attempting to look up the Integer type).


************************************************************************
*                                                                      *
                Initialisation
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-identifier">initTcRnIf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Char</span><span>              </span><span class="hs-comment">-- Tag for unique supply</span><span>
</span><a name="line-405"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-406"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325011"><span class="hs-identifier hs-type">gbl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325012"><span class="hs-identifier hs-type">lcl</span></a><span>
</span><a name="line-407"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681325011"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681325012"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681325013"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-408"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681325013"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-409"></a><a name="initTcRnIf"><a href="TcRnMonad.html#initTcRnIf"><span class="hs-identifier">initTcRnIf</span></a></a><span> </span><a name="local-6989586621681325067"><a href="#local-6989586621681325067"><span class="hs-identifier">uniq_tag</span></a></a><span> </span><a name="local-6989586621681325068"><a href="#local-6989586621681325068"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681325069"><a href="#local-6989586621681325069"><span class="hs-identifier">gbl_env</span></a></a><span> </span><a name="local-6989586621681325070"><a href="#local-6989586621681325070"><span class="hs-identifier">lcl_env</span></a></a><span> </span><a name="local-6989586621681325071"><a href="#local-6989586621681325071"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-410"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325072"><a href="#local-6989586621681325072"><span class="hs-identifier">us</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mkSplitUniqSupply</span><span> </span><a href="#local-6989586621681325067"><span class="hs-identifier hs-var">uniq_tag</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-411"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325073"><a href="#local-6989586621681325073"><span class="hs-identifier">us_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><a href="#local-6989586621681325072"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325074"><a href="#local-6989586621681325074"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Env</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_top</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325068"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-414"></a><span>                            </span><span class="hs-identifier">env_us</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325073"><span class="hs-identifier hs-var">us_var</span></a><span class="hs-special">,</span><span>
</span><a name="line-415"></a><span>                            </span><span class="hs-identifier">env_gbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325069"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-416"></a><span>                            </span><span class="hs-identifier">env_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325070"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">runIOEnv</span><span> </span><a href="#local-6989586621681325074"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621681325071"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-419"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Simple accessors
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-428"></a><span>
</span><a name="line-429"></a><span class="hs-identifier">discardResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681325010"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-430"></a><a name="discardResult"><a href="TcRnMonad.html#discardResult"><span class="hs-identifier">discardResult</span></a></a><span> </span><a name="local-6989586621681325082"><a href="#local-6989586621681325082"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325082"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-identifier">getTopEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681325008"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681325009"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-433"></a><a name="getTopEnv"><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier">getTopEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325083"><a href="#local-6989586621681325083"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">env_top</span><span> </span><a href="#local-6989586621681325083"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span class="hs-identifier">updTopEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681325005"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681325006"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681325007"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681325005"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681325006"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681325007"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-436"></a><a name="updTopEnv"><a href="TcRnMonad.html#updTopEnv"><span class="hs-identifier">updTopEnv</span></a></a><span> </span><a name="local-6989586621681325084"><a href="#local-6989586621681325084"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325085"><a href="#local-6989586621681325085"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Env</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_top</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325086"><a href="#local-6989586621681325086"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-437"></a><span>                          </span><a href="#local-6989586621681325085"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_top</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325084"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621681325086"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>
</span><a name="line-439"></a><span class="hs-identifier">getGblEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681325003"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681325004"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681325003"><span class="hs-identifier hs-type">gbl</span></a><span>
</span><a name="line-440"></a><a name="getGblEnv"><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier">getGblEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Env</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325089"><span class="hs-identifier hs-var">env_gbl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span class="hs-identifier">updGblEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325000"><span class="hs-identifier hs-type">gbl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325000"><span class="hs-identifier hs-type">gbl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681325000"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681325001"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681325002"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681325000"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681325001"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681325002"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-443"></a><a name="updGblEnv"><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier">updGblEnv</span></a></a><span> </span><a name="local-6989586621681325091"><a href="#local-6989586621681325091"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325092"><a href="#local-6989586621681325092"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Env</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_gbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325093"><a href="#local-6989586621681325093"><span class="hs-identifier">gbl</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-444"></a><span>                          </span><a href="#local-6989586621681325092"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_gbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325091"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621681325093"><span class="hs-identifier hs-var">gbl</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span class="hs-identifier">setGblEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681324997"><span class="hs-identifier hs-type">gbl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324997"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324998"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324999"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324997"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324998"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324999"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-447"></a><a name="setGblEnv"><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier">setGblEnv</span></a></a><span> </span><a name="local-6989586621681325094"><a href="#local-6989586621681325094"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325095"><a href="#local-6989586621681325095"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325095"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_gbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325094"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span class="hs-identifier">getLclEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324995"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324996"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324996"><span class="hs-identifier hs-type">lcl</span></a><span>
</span><a name="line-450"></a><a name="getLclEnv"><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier">getLclEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Env</span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325099"><span class="hs-identifier hs-var">env_lcl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-identifier">updLclEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324992"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324992"><span class="hs-identifier hs-type">lcl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324993"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324992"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324994"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324993"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324992"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324994"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-453"></a><a name="updLclEnv"><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier">updLclEnv</span></a></a><span> </span><a name="local-6989586621681325100"><a href="#local-6989586621681325100"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325101"><a href="#local-6989586621681325101"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Env</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325102"><a href="#local-6989586621681325102"><span class="hs-identifier">lcl</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-454"></a><span>                          </span><a href="#local-6989586621681325101"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325100"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621681325102"><span class="hs-identifier hs-var">lcl</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span class="hs-identifier">setLclEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681324988"><span class="hs-identifier hs-type">lcl'</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324989"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324988"><span class="hs-identifier hs-type">lcl'</span></a><span> </span><a href="#local-6989586621681324990"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324989"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324991"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324990"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-457"></a><a name="setLclEnv"><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier">setLclEnv</span></a></a><span> </span><a name="local-6989586621681325103"><a href="#local-6989586621681325103"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325104"><a href="#local-6989586621681325104"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325104"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325103"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-identifier">getEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324986"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324987"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324986"><span class="hs-identifier hs-type">gbl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681324987"><span class="hs-identifier hs-type">lcl</span></a><span class="hs-special">)</span><span>
</span><a name="line-460"></a><a name="getEnvs"><a href="TcRnMonad.html#getEnvs"><span class="hs-identifier">getEnvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325105"><a href="#local-6989586621681325105"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">env_gbl</span><span> </span><a href="#local-6989586621681325105"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">env_lcl</span><span> </span><a href="#local-6989586621681325105"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span class="hs-identifier">setEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324981"><span class="hs-identifier hs-type">gbl'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681324982"><span class="hs-identifier hs-type">lcl'</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324981"><span class="hs-identifier hs-type">gbl'</span></a><span> </span><a href="#local-6989586621681324982"><span class="hs-identifier hs-type">lcl'</span></a><span> </span><a href="#local-6989586621681324983"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324984"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324985"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324983"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-463"></a><a name="setEnvs"><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier">setEnvs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681325106"><a href="#local-6989586621681325106"><span class="hs-identifier">gbl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325107"><a href="#local-6989586621681325107"><span class="hs-identifier">lcl_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">updEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325108"><a href="#local-6989586621681325108"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325108"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_gbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325106"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">env_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325107"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-comment">-- Command-line flags</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-identifier">xoptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LangExt.Extension</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324979"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324980"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-468"></a><a name="xoptM"><a href="TcRnMonad.html#xoptM"><span class="hs-identifier">xoptM</span></a></a><span> </span><a name="local-6989586621681325109"><a href="#local-6989586621681325109"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325110"><a href="#local-6989586621681325110"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">xopt</span><span> </span><a href="#local-6989586621681325109"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681325110"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">doptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DumpFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324977"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324978"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-471"></a><a name="doptM"><a href="TcRnMonad.html#doptM"><span class="hs-identifier">doptM</span></a></a><span> </span><a name="local-6989586621681325111"><a href="#local-6989586621681325111"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325112"><a href="#local-6989586621681325112"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dopt</span><span> </span><a href="#local-6989586621681325111"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681325112"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-472"></a><span>
</span><a name="line-473"></a><span class="hs-identifier">goptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GeneralFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324975"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324976"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-474"></a><a name="goptM"><a href="TcRnMonad.html#goptM"><span class="hs-identifier">goptM</span></a></a><span> </span><a name="local-6989586621681325113"><a href="#local-6989586621681325113"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325114"><a href="#local-6989586621681325114"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><a href="#local-6989586621681325113"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681325114"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-identifier">woptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324973"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324974"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-477"></a><a name="woptM"><a href="TcRnMonad.html#woptM"><span class="hs-identifier">woptM</span></a></a><span> </span><a name="local-6989586621681325115"><a href="#local-6989586621681325115"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325116"><a href="#local-6989586621681325116"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wopt</span><span> </span><a href="#local-6989586621681325115"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681325116"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span class="hs-identifier">setXOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LangExt.Extension</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324970"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324971"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324972"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324970"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324971"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324972"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-480"></a><a name="setXOptM"><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier">setXOptM</span></a></a><span> </span><a name="local-6989586621681325117"><a href="#local-6989586621681325117"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-481"></a><span>  </span><a href="TcRnMonad.html#updTopEnv"><span class="hs-identifier hs-var">updTopEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325118"><a href="#local-6989586621681325118"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325118"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt_set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681325118"><span class="hs-identifier hs-var">top</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325117"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span class="hs-identifier">unsetXOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LangExt.Extension</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324967"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324968"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324969"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324967"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324968"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324969"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-484"></a><a name="unsetXOptM"><a href="TcRnMonad.html#unsetXOptM"><span class="hs-identifier">unsetXOptM</span></a></a><span> </span><a name="local-6989586621681325119"><a href="#local-6989586621681325119"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-485"></a><span>  </span><a href="TcRnMonad.html#updTopEnv"><span class="hs-identifier hs-var">updTopEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325120"><a href="#local-6989586621681325120"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325120"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">xopt_unset</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681325120"><span class="hs-identifier hs-var">top</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325119"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-identifier">unsetGOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GeneralFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324964"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324965"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324966"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324964"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324965"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324966"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-488"></a><a name="unsetGOptM"><a href="TcRnMonad.html#unsetGOptM"><span class="hs-identifier">unsetGOptM</span></a></a><span> </span><a name="local-6989586621681325121"><a href="#local-6989586621681325121"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-489"></a><span>  </span><a href="TcRnMonad.html#updTopEnv"><span class="hs-identifier hs-var">updTopEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325122"><a href="#local-6989586621681325122"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325122"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gopt_unset</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681325122"><span class="hs-identifier hs-var">top</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325121"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-identifier">unsetWOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324961"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324962"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324963"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324961"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324962"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324963"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-492"></a><a name="unsetWOptM"><a href="TcRnMonad.html#unsetWOptM"><span class="hs-identifier">unsetWOptM</span></a></a><span> </span><a name="local-6989586621681325123"><a href="#local-6989586621681325123"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-493"></a><span>  </span><a href="TcRnMonad.html#updTopEnv"><span class="hs-identifier hs-var">updTopEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325124"><a href="#local-6989586621681325124"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325124"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">wopt_unset</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681325124"><span class="hs-identifier hs-var">top</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325123"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-comment">-- | Do it flag is true</span><span>
</span><a name="line-496"></a><span class="hs-identifier">whenDOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DumpFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324959"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324960"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324959"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324960"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-497"></a><a name="whenDOptM"><a href="TcRnMonad.html#whenDOptM"><span class="hs-identifier">whenDOptM</span></a></a><span> </span><a name="local-6989586621681325125"><a href="#local-6989586621681325125"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325126"><a href="#local-6989586621681325126"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681325127"><a href="#local-6989586621681325127"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#doptM"><span class="hs-identifier hs-var">doptM</span></a><span> </span><a href="#local-6989586621681325125"><span class="hs-identifier hs-var">flag</span></a><span>
</span><a name="line-498"></a><span>                                 </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681325127"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621681325126"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span class="hs-identifier">whenGOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GeneralFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324957"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324958"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324957"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324958"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-501"></a><a name="whenGOptM"><a href="TcRnMonad.html#whenGOptM"><span class="hs-identifier">whenGOptM</span></a></a><span> </span><a name="local-6989586621681325128"><a href="#local-6989586621681325128"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325129"><a href="#local-6989586621681325129"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681325130"><a href="#local-6989586621681325130"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><a href="#local-6989586621681325128"><span class="hs-identifier hs-var">flag</span></a><span>
</span><a name="line-502"></a><span>                                 </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681325130"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621681325129"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-identifier">whenWOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324955"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324956"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324955"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324956"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><a name="whenWOptM"><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier">whenWOptM</span></a></a><span> </span><a name="local-6989586621681325131"><a href="#local-6989586621681325131"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325132"><a href="#local-6989586621681325132"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681325133"><a href="#local-6989586621681325133"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><a href="#local-6989586621681325131"><span class="hs-identifier hs-var">flag</span></a><span>
</span><a name="line-506"></a><span>                                 </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681325133"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621681325132"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-identifier">whenXOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LangExt.Extension</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324953"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324954"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324953"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324954"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><a name="whenXOptM"><a href="TcRnMonad.html#whenXOptM"><span class="hs-identifier">whenXOptM</span></a></a><span> </span><a name="local-6989586621681325134"><a href="#local-6989586621681325134"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325135"><a href="#local-6989586621681325135"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681325136"><a href="#local-6989586621681325136"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="#local-6989586621681325134"><span class="hs-identifier hs-var">flag</span></a><span>
</span><a name="line-510"></a><span>                                 </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681325136"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621681325135"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span class="hs-identifier">unlessXOptM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LangExt.Extension</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324951"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324952"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324951"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324952"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-513"></a><a name="unlessXOptM"><a href="TcRnMonad.html#unlessXOptM"><span class="hs-identifier">unlessXOptM</span></a></a><span> </span><a name="local-6989586621681325137"><a href="#local-6989586621681325137"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325138"><a href="#local-6989586621681325138"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681325139"><a href="#local-6989586621681325139"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="#local-6989586621681325137"><span class="hs-identifier hs-var">flag</span></a><span>
</span><a name="line-514"></a><span>                                   </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621681325139"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621681325138"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span class="hs-identifier">getGhcMode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324949"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324950"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">GhcMode</span><span>
</span><a name="line-517"></a><a name="getGhcMode"><a href="TcRnMonad.html#getGhcMode"><span class="hs-identifier">getGhcMode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325140"><a href="#local-6989586621681325140"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcMode</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621681325140"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-518"></a><span>
</span><a name="line-519"></a><span class="hs-identifier">withDoDynamicToo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324946"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324947"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324948"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324946"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324947"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324948"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-520"></a><a name="withDoDynamicToo"><a href="TcRnMonad.html#withDoDynamicToo"><span class="hs-identifier">withDoDynamicToo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-521"></a><span>  </span><a href="TcRnMonad.html#updTopEnv"><span class="hs-identifier hs-var">updTopEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325141"><a href="#local-6989586621681325141"><span class="hs-identifier">top</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">HscEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325142"><a href="#local-6989586621681325142"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-522"></a><span>              </span><a href="#local-6989586621681325141"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dynamicTooMkDynamicDynFlags</span><span> </span><a href="#local-6989586621681325142"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span class="hs-identifier">getEpsVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324944"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324945"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcRef</span><span> </span><span class="hs-identifier hs-type">ExternalPackageState</span><span class="hs-special">)</span><span>
</span><a name="line-525"></a><a name="getEpsVar"><a href="TcRnMonad.html#getEpsVar"><span class="hs-identifier">getEpsVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325143"><a href="#local-6989586621681325143"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_EPS</span><span> </span><a href="#local-6989586621681325143"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-identifier">getEps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324942"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324943"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">ExternalPackageState</span><span>
</span><a name="line-528"></a><a name="getEps"><a href="TcRnMonad.html#getEps"><span class="hs-identifier">getEps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325144"><a href="#local-6989586621681325144"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_EPS</span><span> </span><a href="#local-6989586621681325144"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span class="hs-comment">-- | Update the external package state.  Returns the second result of the</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- modifier function.</span><span>
</span><a name="line-532"></a><span class="hs-comment">--</span><span>
</span><a name="line-533"></a><span class="hs-comment">-- This is an atomic operation and forces evaluation of the modified EPS in</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- order to avoid space leaks.</span><span>
</span><a name="line-535"></a><span class="hs-identifier">updateEps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExternalPackageState</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExternalPackageState</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681324939"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-536"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324940"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324941"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324939"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-537"></a><a name="updateEps"><a href="TcRnMonad.html#updateEps"><span class="hs-identifier">updateEps</span></a></a><span> </span><a name="local-6989586621681325145"><a href="#local-6989586621681325145"><span class="hs-identifier">upd_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-538"></a><span>  </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;updating EPS&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-539"></a><span>  </span><a name="local-6989586621681325146"><a href="#local-6989586621681325146"><span class="hs-identifier">eps_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEpsVar"><span class="hs-identifier hs-var">getEpsVar</span></a><span>
</span><a name="line-540"></a><span>  </span><span class="hs-identifier hs-var">atomicUpdMutVar'</span><span> </span><a href="#local-6989586621681325146"><span class="hs-identifier hs-var">eps_var</span></a><span> </span><a href="#local-6989586621681325145"><span class="hs-identifier hs-var">upd_fn</span></a><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-comment">-- | Update the external package state.</span><span>
</span><a name="line-543"></a><span class="hs-comment">--</span><span>
</span><a name="line-544"></a><span class="hs-comment">-- This is an atomic operation and forces evaluation of the modified EPS in</span><span>
</span><a name="line-545"></a><span class="hs-comment">-- order to avoid space leaks.</span><span>
</span><a name="line-546"></a><span class="hs-identifier">updateEps_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExternalPackageState</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExternalPackageState</span><span class="hs-special">)</span><span>
</span><a name="line-547"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324937"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324938"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-548"></a><a name="updateEps_"><a href="TcRnMonad.html#updateEps_"><span class="hs-identifier">updateEps_</span></a></a><span> </span><a name="local-6989586621681325147"><a href="#local-6989586621681325147"><span class="hs-identifier">upd_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-549"></a><span>  </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;updating EPS_&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span>  </span><a name="local-6989586621681325148"><a href="#local-6989586621681325148"><span class="hs-identifier">eps_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEpsVar"><span class="hs-identifier hs-var">getEpsVar</span></a><span>
</span><a name="line-551"></a><span>  </span><span class="hs-identifier hs-var">atomicUpdMutVar'</span><span> </span><a href="#local-6989586621681325148"><span class="hs-identifier hs-var">eps_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325149"><a href="#local-6989586621681325149"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325147"><span class="hs-identifier hs-var">upd_fn</span></a><span> </span><a href="#local-6989586621681325149"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span class="hs-identifier">getHpt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324935"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324936"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span>
</span><a name="line-554"></a><a name="getHpt"><a href="TcRnMonad.html#getHpt"><span class="hs-identifier">getHpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325150"><a href="#local-6989586621681325150"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621681325150"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span class="hs-identifier">getEpsAndHpt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324933"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324934"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ExternalPackageState</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HomePackageTable</span><span class="hs-special">)</span><span>
</span><a name="line-557"></a><a name="getEpsAndHpt"><a href="TcRnMonad.html#getEpsAndHpt"><span class="hs-identifier">getEpsAndHpt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325151"><a href="#local-6989586621681325151"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">;</span><span> </span><a name="local-6989586621681325152"><a href="#local-6989586621681325152"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_EPS</span><span> </span><a href="#local-6989586621681325151"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325152"><span class="hs-identifier hs-var">eps</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsc_HPT</span><span> </span><a href="#local-6989586621681325151"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span class="hs-comment">-- | A convenient wrapper for taking a @MaybeErr MsgDoc a@ and throwing</span><span>
</span><a name="line-561"></a><span class="hs-comment">-- an exception if it is an error.</span><span>
</span><a name="line-562"></a><span class="hs-identifier">withException</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324930"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324931"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MaybeErr</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><a href="#local-6989586621681324932"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324930"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324931"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324932"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-563"></a><a name="withException"><a href="TcRnMonad.html#withException"><span class="hs-identifier">withException</span></a></a><span> </span><a name="local-6989586621681325153"><a href="#local-6989586621681325153"><span class="hs-identifier">do_this</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-564"></a><span>    </span><a name="local-6989586621681325154"><a href="#local-6989586621681325154"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681325153"><span class="hs-identifier hs-var">do_this</span></a><span>
</span><a name="line-565"></a><span>    </span><a name="local-6989586621681325155"><a href="#local-6989586621681325155"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-566"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325154"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-567"></a><span>        </span><span class="hs-identifier hs-var">Failed</span><span> </span><a name="local-6989586621681325156"><a href="#local-6989586621681325156"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">throwGhcExceptionIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ProgramError</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621681325155"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325156"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>        </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><a name="local-6989586621681325157"><a href="#local-6989586621681325157"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325157"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Arrow scopes
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span class="hs-identifier">newArrowScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324929"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324929"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-579"></a><a name="newArrowScope"><a href="TcRnMonad.html#newArrowScope"><span class="hs-identifier">newArrowScope</span></a></a><span>
</span><a name="line-580"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681325158"><a href="#local-6989586621681325158"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325158"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_arrow_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ArrowCtxt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_rdr</span><span> </span><a href="#local-6989586621681325158"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_lie</span><span> </span><a href="#local-6989586621681325158"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span class="hs-comment">-- Return to the stored environment (from the enclosing proc)</span><span>
</span><a name="line-583"></a><span class="hs-identifier">escapeArrowScope</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324928"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324928"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-584"></a><a name="escapeArrowScope"><a href="TcRnMonad.html#escapeArrowScope"><span class="hs-identifier">escapeArrowScope</span></a></a><span>
</span><a name="line-585"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325159"><a href="#local-6989586621681325159"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-586"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">tcl_arrow_ctxt</span><span> </span><a href="#local-6989586621681325159"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-587"></a><span>      </span><span class="hs-identifier hs-var">NoArrowCtxt</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325159"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-588"></a><span>      </span><span class="hs-identifier hs-var">ArrowCtxt</span><span> </span><a name="local-6989586621681325160"><a href="#local-6989586621681325160"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621681325161"><a href="#local-6989586621681325161"><span class="hs-identifier">lie</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325159"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_arrow_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NoArrowCtxt</span><span>
</span><a name="line-589"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_lie</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325161"><span class="hs-identifier hs-var">lie</span></a><span>
</span><a name="line-590"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_rdr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325160"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Unique supply
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span class="hs-identifier">newUnique</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324926"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324927"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">Unique</span><span>
</span><a name="line-601"></a><a name="newUnique"><a href="TcRnMonad.html#newUnique"><span class="hs-identifier">newUnique</span></a></a><span>
</span><a name="line-602"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325162"><a href="#local-6989586621681325162"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-603"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325163"><a href="#local-6989586621681325163"><span class="hs-identifier">u_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">env_us</span><span> </span><a href="#local-6989586621681325162"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-604"></a><span>        </span><a name="local-6989586621681325164"><a href="#local-6989586621681325164"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621681325163"><span class="hs-identifier hs-var">u_var</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-605"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">takeUniqFromSupply</span><span> </span><a href="#local-6989586621681325164"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325165"><a href="#local-6989586621681325165"><span class="hs-identifier">uniq</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325166"><a href="#local-6989586621681325166"><span class="hs-identifier">us'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-606"></a><span>        </span><span class="hs-identifier hs-var">writeMutVar</span><span> </span><a href="#local-6989586621681325163"><span class="hs-identifier hs-var">u_var</span></a><span> </span><a href="#local-6989586621681325166"><span class="hs-identifier hs-var">us'</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-607"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621681325165"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-608"></a><span>   </span><span class="hs-comment">-- NOTE 1: we strictly split the supply, to avoid the possibility of leaving</span><span>
</span><a name="line-609"></a><span>   </span><span class="hs-comment">-- a chain of unevaluated supplies behind.</span><span>
</span><a name="line-610"></a><span>   </span><span class="hs-comment">-- NOTE 2: we use the uniq in the supply from the MutVar directly, and</span><span>
</span><a name="line-611"></a><span>   </span><span class="hs-comment">-- throw away one half of the new split supply.  This is safe because this</span><span>
</span><a name="line-612"></a><span>   </span><span class="hs-comment">-- is the only place we use that unique.  Using the other half of the split</span><span>
</span><a name="line-613"></a><span>   </span><span class="hs-comment">-- supply is safer, but slower.</span><span>
</span><a name="line-614"></a><span>
</span><a name="line-615"></a><span class="hs-identifier">newUniqueSupply</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324924"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324925"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">UniqSupply</span><span>
</span><a name="line-616"></a><a name="newUniqueSupply"><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier">newUniqueSupply</span></a></a><span>
</span><a name="line-617"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325167"><a href="#local-6989586621681325167"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-618"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325168"><a href="#local-6989586621681325168"><span class="hs-identifier">u_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">env_us</span><span> </span><a href="#local-6989586621681325167"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-619"></a><span>        </span><a name="local-6989586621681325169"><a href="#local-6989586621681325169"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span> </span><a href="#local-6989586621681325168"><span class="hs-identifier hs-var">u_var</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-620"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">splitUniqSupply</span><span> </span><a href="#local-6989586621681325169"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325170"><a href="#local-6989586621681325170"><span class="hs-identifier">us1</span></a></a><span class="hs-special">,</span><a name="local-6989586621681325171"><a href="#local-6989586621681325171"><span class="hs-identifier">us2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-621"></a><span>        </span><span class="hs-identifier hs-var">writeMutVar</span><span> </span><a href="#local-6989586621681325168"><span class="hs-identifier hs-var">u_var</span></a><span> </span><a href="#local-6989586621681325170"><span class="hs-identifier hs-var">us1</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-622"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325171"><span class="hs-identifier hs-var">us2</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-623"></a><span>
</span><a name="line-624"></a><span class="hs-identifier">cloneLocalName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-625"></a><span class="hs-comment">-- Make a fresh Internal name with the same OccName and SrcSpan</span><span>
</span><a name="line-626"></a><a name="cloneLocalName"><a href="TcRnMonad.html#cloneLocalName"><span class="hs-identifier">cloneLocalName</span></a></a><span> </span><a name="local-6989586621681325172"><a href="#local-6989586621681325172"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#newNameAt"><span class="hs-identifier hs-var">newNameAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621681325172"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><a href="#local-6989586621681325172"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span class="hs-identifier">newName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-629"></a><a name="newName"><a href="TcRnMonad.html#newName"><span class="hs-identifier">newName</span></a></a><span> </span><a name="local-6989586621681325173"><a href="#local-6989586621681325173"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325174"><a href="#local-6989586621681325174"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-630"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#newNameAt"><span class="hs-identifier hs-var">newNameAt</span></a><span> </span><a href="#local-6989586621681325173"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="#local-6989586621681325174"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-identifier">newNameAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-633"></a><a name="newNameAt"><a href="TcRnMonad.html#newNameAt"><span class="hs-identifier">newNameAt</span></a></a><span> </span><a name="local-6989586621681325175"><a href="#local-6989586621681325175"><span class="hs-identifier">occ</span></a></a><span> </span><a name="local-6989586621681325176"><a href="#local-6989586621681325176"><span class="hs-identifier">span</span></a></a><span>
</span><a name="line-634"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325177"><a href="#local-6989586621681325177"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-635"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkInternalName</span><span> </span><a href="#local-6989586621681325177"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621681325175"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="#local-6989586621681325176"><span class="hs-identifier hs-var">span</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span class="hs-identifier">newSysName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324922"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324923"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-638"></a><a name="newSysName"><a href="TcRnMonad.html#newSysName"><span class="hs-identifier">newSysName</span></a></a><span> </span><a name="local-6989586621681325178"><a href="#local-6989586621681325178"><span class="hs-identifier">occ</span></a></a><span>
</span><a name="line-639"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325179"><a href="#local-6989586621681325179"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-640"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkSystemName</span><span> </span><a href="#local-6989586621681325179"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621681325178"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span class="hs-identifier">newSysLocalId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324920"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324921"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-643"></a><a name="newSysLocalId"><a href="TcRnMonad.html#newSysLocalId"><span class="hs-identifier">newSysLocalId</span></a></a><span> </span><a name="local-6989586621681325180"><a href="#local-6989586621681325180"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-6989586621681325181"><a href="#local-6989586621681325181"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-644"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325182"><a href="#local-6989586621681325182"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-645"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkSysLocalOrCoVar</span><span> </span><a href="#local-6989586621681325180"><span class="hs-identifier hs-var">fs</span></a><span> </span><a href="#local-6989586621681325182"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621681325181"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-646"></a><span>
</span><a name="line-647"></a><span class="hs-identifier">newSysLocalIds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324918"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324919"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">]</span><span>
</span><a name="line-648"></a><a name="newSysLocalIds"><a href="TcRnMonad.html#newSysLocalIds"><span class="hs-identifier">newSysLocalIds</span></a></a><span> </span><a name="local-6989586621681325183"><a href="#local-6989586621681325183"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-6989586621681325184"><a href="#local-6989586621681325184"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-649"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325185"><a href="#local-6989586621681325185"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span>
</span><a name="line-650"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkSysLocalOrCoVar</span><span> </span><a href="#local-6989586621681325183"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uniqsFromSupply</span><span> </span><a href="#local-6989586621681325185"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325184"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-651"></a><span>
</span><a name="line-652"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadUnique</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IOEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Env</span><span> </span><a href="#local-6989586621681324830"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324831"><span class="hs-identifier hs-type">lcl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-653"></a><span>        </span><a name="local-8214565720323805400"><span class="hs-identifier">getUniqueM</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-654"></a><span>        </span><a name="local-8214565720323805401"><span class="hs-identifier">getUniqueSupplyM</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Accessing input/output
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span class="hs-identifier">newTcRef</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681324915"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324916"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324917"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcRef</span><span> </span><a href="#local-6989586621681324915"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-665"></a><a name="newTcRef"><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier">newTcRef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">newMutVar</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span class="hs-identifier">readTcRef</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRef</span><span> </span><a href="#local-6989586621681324912"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324913"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324914"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324912"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-668"></a><a name="readTcRef"><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier">readTcRef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">readMutVar</span><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span class="hs-identifier">writeTcRef</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRef</span><span> </span><a href="#local-6989586621681324909"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324909"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324910"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324911"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-671"></a><a name="writeTcRef"><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier">writeTcRef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">writeMutVar</span><span>
</span><a name="line-672"></a><span>
</span><a name="line-673"></a><span class="hs-identifier">updTcRef</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRef</span><span> </span><a href="#local-6989586621681324906"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324906"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324906"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324907"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324908"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span class="hs-comment">-- Returns ()</span><span>
</span><a name="line-675"></a><a name="updTcRef"><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier">updTcRef</span></a></a><span> </span><a name="local-6989586621681325186"><a href="#local-6989586621681325186"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621681325187"><a href="#local-6989586621681325187"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325188"><a href="#local-6989586621681325188"><span class="hs-identifier">old</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621681325186"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-676"></a><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621681325186"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325187"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681325188"><span class="hs-identifier hs-var">old</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-677"></a><span>
</span><a name="line-678"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Debugging
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span class="hs-comment">-- Typechecker trace</span><span>
</span><a name="line-688"></a><span class="hs-identifier">traceTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-689"></a><a name="traceTc"><a href="TcRnMonad.html#traceTc"><span class="hs-identifier">traceTc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-690"></a><span>  </span><a href="TcRnMonad.html#labelledTraceOptTcRn"><span class="hs-identifier hs-var">labelledTraceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_tc_trace</span><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span class="hs-comment">-- Renamer Trace</span><span>
</span><a name="line-693"></a><span class="hs-identifier">traceRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-694"></a><a name="traceRn"><a href="TcRnMonad.html#traceRn"><span class="hs-identifier">traceRn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-695"></a><span>  </span><a href="TcRnMonad.html#labelledTraceOptTcRn"><span class="hs-identifier hs-var">labelledTraceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_rn_trace</span><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span class="hs-comment">-- | Trace when a certain flag is enabled. This is like `traceOptTcRn`</span><span>
</span><a name="line-698"></a><span class="hs-comment">-- but accepts a string as a label and formats the trace message uniformly.</span><span>
</span><a name="line-699"></a><span class="hs-identifier">labelledTraceOptTcRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DumpFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-700"></a><a name="labelledTraceOptTcRn"><a href="TcRnMonad.html#labelledTraceOptTcRn"><span class="hs-identifier">labelledTraceOptTcRn</span></a></a><span> </span><a name="local-6989586621681325189"><a href="#local-6989586621681325189"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325190"><a href="#local-6989586621681325190"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-6989586621681325191"><a href="#local-6989586621681325191"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-701"></a><span>   </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span> </span><a href="#local-6989586621681325189"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#formatTraceMsg"><span class="hs-identifier hs-var">formatTraceMsg</span></a><span> </span><a href="#local-6989586621681325190"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-6989586621681325191"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-702"></a><span>
</span><a name="line-703"></a><span class="hs-identifier">formatTraceMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-704"></a><a name="formatTraceMsg"><a href="TcRnMonad.html#formatTraceMsg"><span class="hs-identifier">formatTraceMsg</span></a></a><span> </span><a name="local-6989586621681325192"><a href="#local-6989586621681325192"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-6989586621681325193"><a href="#local-6989586621681325193"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621681325192"><span class="hs-identifier hs-var">herald</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621681325193"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span class="hs-comment">-- | Output a doc if the given 'DumpFlag' is set.</span><span>
</span><a name="line-707"></a><span class="hs-comment">--</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- By default this logs to stdout</span><span>
</span><a name="line-709"></a><span class="hs-comment">-- However, if the `-ddump-to-file` flag is set,</span><span>
</span><a name="line-710"></a><span class="hs-comment">-- then this will dump output to a file</span><span>
</span><a name="line-711"></a><span class="hs-comment">--</span><span>
</span><a name="line-712"></a><span class="hs-comment">-- Just a wrapper for 'dumpSDoc'</span><span>
</span><a name="line-713"></a><span class="hs-identifier">traceOptTcRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DumpFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-714"></a><a name="traceOptTcRn"><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier">traceOptTcRn</span></a></a><span> </span><a name="local-6989586621681325194"><a href="#local-6989586621681325194"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325195"><a href="#local-6989586621681325195"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-715"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325196"><a href="#local-6989586621681325196"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-716"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dopt</span><span> </span><a href="#local-6989586621681325194"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681325196"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-717"></a><span>              </span><span class="hs-special">(</span><a href="TcRnMonad.html#traceTcRn"><span class="hs-identifier hs-var">traceTcRn</span></a><span> </span><a href="#local-6989586621681325194"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681325195"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-719"></a><span>
</span><a name="line-720"></a><span class="hs-comment">-- Certain tests (T3017, Roles3, T12763 etc.) expect part of the</span><span>
</span><a name="line-721"></a><span class="hs-comment">-- output generated by `-ddump-types` to be in 'PprUser' style. However,</span><span>
</span><a name="line-722"></a><span class="hs-comment">-- generally we want all other debugging output to use 'PprDump'</span><span>
</span><a name="line-723"></a><span class="hs-comment">-- style. 'traceTcRn' and 'traceTcRnForUser' help us accomplish this.</span><span>
</span><a name="line-724"></a><span>
</span><a name="line-725"></a><span class="hs-comment">-- | A wrapper around 'traceTcRnWithStyle' which uses 'PprDump' style.</span><span>
</span><a name="line-726"></a><span class="hs-identifier">traceTcRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DumpFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-727"></a><a name="traceTcRn"><a href="TcRnMonad.html#traceTcRn"><span class="hs-identifier">traceTcRn</span></a></a><span> </span><a name="local-6989586621681325197"><a href="#local-6989586621681325197"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325198"><a href="#local-6989586621681325198"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-728"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325199"><a href="#local-6989586621681325199"><span class="hs-identifier">dflags</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-729"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325200"><a href="#local-6989586621681325200"><span class="hs-identifier">printer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getPrintUnqualified"><span class="hs-identifier hs-var">getPrintUnqualified</span></a><span> </span><a href="#local-6989586621681325199"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-730"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325201"><a href="#local-6989586621681325201"><span class="hs-identifier">dump_style</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkDumpStyle</span><span> </span><a href="#local-6989586621681325199"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325200"><span class="hs-identifier hs-var">printer</span></a><span>
</span><a name="line-731"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTcRnWithStyle"><span class="hs-identifier hs-var">traceTcRnWithStyle</span></a><span> </span><a href="#local-6989586621681325201"><span class="hs-identifier hs-var">dump_style</span></a><span> </span><a href="#local-6989586621681325199"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325197"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681325198"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span class="hs-comment">-- | A wrapper around 'traceTcRnWithStyle' which uses 'PprUser' style.</span><span>
</span><a name="line-734"></a><span class="hs-identifier">traceTcRnForUser</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DumpFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-735"></a><span class="hs-comment">-- Used by 'TcRnDriver.tcDump'.</span><span>
</span><a name="line-736"></a><a name="traceTcRnForUser"><a href="TcRnMonad.html#traceTcRnForUser"><span class="hs-identifier">traceTcRnForUser</span></a></a><span> </span><a name="local-6989586621681325202"><a href="#local-6989586621681325202"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325203"><a href="#local-6989586621681325203"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-737"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325204"><a href="#local-6989586621681325204"><span class="hs-identifier">dflags</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-738"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325205"><a href="#local-6989586621681325205"><span class="hs-identifier">printer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getPrintUnqualified"><span class="hs-identifier hs-var">getPrintUnqualified</span></a><span> </span><a href="#local-6989586621681325204"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-739"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325206"><a href="#local-6989586621681325206"><span class="hs-identifier">user_style</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkUserStyle</span><span> </span><a href="#local-6989586621681325204"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325205"><span class="hs-identifier hs-var">printer</span></a><span> </span><span class="hs-identifier hs-var">AllTheWay</span><span>
</span><a name="line-740"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTcRnWithStyle"><span class="hs-identifier hs-var">traceTcRnWithStyle</span></a><span> </span><a href="#local-6989586621681325206"><span class="hs-identifier hs-var">user_style</span></a><span> </span><a href="#local-6989586621681325204"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325202"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681325203"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span class="hs-identifier">traceTcRnWithStyle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">PprStyle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DumpFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-743"></a><span class="hs-comment">-- ^ Unconditionally dump some trace output</span><span>
</span><a name="line-744"></a><span class="hs-comment">--</span><span>
</span><a name="line-745"></a><span class="hs-comment">-- The DumpFlag is used only to set the output filename</span><span>
</span><a name="line-746"></a><span class="hs-comment">-- for --dump-to-file, not to decide whether or not to output</span><span>
</span><a name="line-747"></a><span class="hs-comment">-- That part is done by the caller</span><span>
</span><a name="line-748"></a><a name="traceTcRnWithStyle"><a href="TcRnMonad.html#traceTcRnWithStyle"><span class="hs-identifier">traceTcRnWithStyle</span></a></a><span> </span><a name="local-6989586621681325207"><a href="#local-6989586621681325207"><span class="hs-identifier">sty</span></a></a><span> </span><a name="local-6989586621681325208"><a href="#local-6989586621681325208"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681325209"><a href="#local-6989586621681325209"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325210"><a href="#local-6989586621681325210"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-749"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325215"><a href="#local-6989586621681325215"><span class="hs-identifier">real_doc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681325211"><span class="hs-identifier hs-var">prettyDoc</span></a><span> </span><a href="#local-6989586621681325208"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325210"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-750"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dumpSDocWithStyle</span><span> </span><a href="#local-6989586621681325207"><span class="hs-identifier hs-var">sty</span></a><span> </span><a href="#local-6989586621681325208"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325209"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621681325215"><span class="hs-identifier hs-var">real_doc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-751"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-752"></a><span>    </span><span class="hs-comment">-- Add current location if -dppr-debug</span><span>
</span><a name="line-753"></a><span>    </span><span class="hs-identifier">prettyDoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-754"></a><span>    </span><a name="local-6989586621681325211"><a href="#local-6989586621681325211"><span class="hs-identifier">prettyDoc</span></a></a><span> </span><a name="local-6989586621681325212"><a href="#local-6989586621681325212"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681325213"><a href="#local-6989586621681325213"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">hasPprDebug</span><span> </span><a href="#local-6989586621681325212"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-755"></a><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325214"><a href="#local-6989586621681325214"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLocMessage</span><span> </span><span class="hs-identifier hs-var">SevOutput</span><span> </span><a href="#local-6989586621681325214"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325213"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-756"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325213"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-comment">-- The full location is usually way too much</span><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span>
</span><a name="line-759"></a><span class="hs-identifier">getPrintUnqualified</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">PrintUnqualified</span><span>
</span><a name="line-760"></a><a name="getPrintUnqualified"><a href="TcRnMonad.html#getPrintUnqualified"><span class="hs-identifier">getPrintUnqualified</span></a></a><span> </span><a name="local-6989586621681325216"><a href="#local-6989586621681325216"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-761"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325217"><a href="#local-6989586621681325217"><span class="hs-identifier">rdr_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-762"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkPrintUnqualified</span><span> </span><a href="#local-6989586621681325216"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325217"><span class="hs-identifier hs-var">rdr_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-763"></a><span>
</span><a name="line-764"></a><span class="hs-comment">-- | Like logInfoTcRn, but for user consumption</span><span>
</span><a name="line-765"></a><span class="hs-identifier">printForUserTcRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-766"></a><a name="printForUserTcRn"><a href="TcRnMonad.html#printForUserTcRn"><span class="hs-identifier">printForUserTcRn</span></a></a><span> </span><a name="local-6989586621681325218"><a href="#local-6989586621681325218"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-767"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325219"><a href="#local-6989586621681325219"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-768"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325220"><a href="#local-6989586621681325220"><span class="hs-identifier">printer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getPrintUnqualified"><span class="hs-identifier hs-var">getPrintUnqualified</span></a><span> </span><a href="#local-6989586621681325219"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-769"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">printOutputForUser</span><span> </span><a href="#local-6989586621681325219"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325220"><span class="hs-identifier hs-var">printer</span></a><span> </span><a href="#local-6989586621681325218"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-770"></a><span>
</span><a name="line-771"></a><span class="hs-comment">{-
traceIf and traceHiDiffs work in the TcRnIf monad, where no RdrEnv is
available.  Alas, they behave inconsistently with the other stuff;
e.g. are unaffected by -dump-to-file.
-}</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span class="hs-identifier">traceIf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">traceHiDiffs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324904"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621681324905"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-778"></a><a name="traceIf"><a href="TcRnMonad.html#traceIf"><span class="hs-identifier">traceIf</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceOptIf"><span class="hs-identifier hs-var">traceOptIf</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_if_trace</span><span>
</span><a name="line-779"></a><a name="traceHiDiffs"><a href="TcRnMonad.html#traceHiDiffs"><span class="hs-identifier">traceHiDiffs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceOptIf"><span class="hs-identifier hs-var">traceOptIf</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_hi_diffs</span><span>
</span><a name="line-780"></a><span>
</span><a name="line-781"></a><span>
</span><a name="line-782"></a><span class="hs-identifier">traceOptIf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DumpFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324902"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621681324903"><span class="hs-identifier hs-type">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-783"></a><a name="traceOptIf"><a href="TcRnMonad.html#traceOptIf"><span class="hs-identifier">traceOptIf</span></a></a><span> </span><a name="local-6989586621681325221"><a href="#local-6989586621681325221"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681325222"><a href="#local-6989586621681325222"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-784"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#whenDOptM"><span class="hs-identifier hs-var">whenDOptM</span></a><span> </span><a href="#local-6989586621681325221"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-operator hs-var">$</span><span>    </span><span class="hs-comment">-- No RdrEnv available, so qualify everything</span><span>
</span><a name="line-785"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325223"><a href="#local-6989586621681325223"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-786"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putMsg</span><span> </span><a href="#local-6989586621681325223"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325222"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Typechecker global environment
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span class="hs-identifier">getIsGHCi</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-797"></a><a name="getIsGHCi"><a href="TcRnMonad.html#getIsGHCi"><span class="hs-identifier">getIsGHCi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325224"><a href="#local-6989586621681325224"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-798"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isInteractiveModule</span><span> </span><a href="#local-6989586621681325224"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span class="hs-identifier">getGHCiMonad</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-801"></a><a name="getGHCiMonad"><a href="TcRnMonad.html#getGHCiMonad"><span class="hs-identifier">getGHCiMonad</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325225"><a href="#local-6989586621681325225"><span class="hs-identifier">hsc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_monad</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621681325225"><span class="hs-identifier hs-var">hsc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-802"></a><span>
</span><a name="line-803"></a><span class="hs-identifier">getInteractivePrintName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-804"></a><a name="getInteractivePrintName"><a href="TcRnMonad.html#getInteractivePrintName"><span class="hs-identifier">getInteractivePrintName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325226"><a href="#local-6989586621681325226"><span class="hs-identifier">hsc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_int_print</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621681325226"><span class="hs-identifier hs-var">hsc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span class="hs-identifier">tcIsHsBootOrSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-807"></a><a name="tcIsHsBootOrSig"><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier">tcIsHsBootOrSig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325227"><a href="#local-6989586621681325227"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isHsBootOrSig</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_src</span><span> </span><a href="#local-6989586621681325227"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-808"></a><span>
</span><a name="line-809"></a><span class="hs-identifier">tcIsHsig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-810"></a><a name="tcIsHsig"><a href="TcRnMonad.html#tcIsHsig"><span class="hs-identifier">tcIsHsig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325228"><a href="#local-6989586621681325228"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isHsigFile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_src</span><span> </span><a href="#local-6989586621681325228"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-811"></a><span>
</span><a name="line-812"></a><span class="hs-identifier">tcSelfBootInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">SelfBootInfo</span><span>
</span><a name="line-813"></a><a name="tcSelfBootInfo"><a href="TcRnMonad.html#tcSelfBootInfo"><span class="hs-identifier">tcSelfBootInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325229"><a href="#local-6989586621681325229"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_self_boot</span><span> </span><a href="#local-6989586621681325229"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-814"></a><span>
</span><a name="line-815"></a><span class="hs-identifier">getGlobalRdrEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-816"></a><a name="getGlobalRdrEnv"><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier">getGlobalRdrEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325230"><a href="#local-6989586621681325230"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_rdr_env</span><span> </span><a href="#local-6989586621681325230"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span class="hs-identifier">getRdrEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LocalRdrEnv</span><span class="hs-special">)</span><span>
</span><a name="line-819"></a><a name="getRdrEnvs"><a href="TcRnMonad.html#getRdrEnvs"><span class="hs-identifier">getRdrEnvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325231"><a href="#local-6989586621681325231"><span class="hs-identifier">gbl</span></a></a><span class="hs-special">,</span><a name="local-6989586621681325232"><a href="#local-6989586621681325232"><span class="hs-identifier">lcl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEnvs"><span class="hs-identifier hs-var">getEnvs</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_rdr_env</span><span> </span><a href="#local-6989586621681325231"><span class="hs-identifier hs-var">gbl</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_rdr</span><span> </span><a href="#local-6989586621681325232"><span class="hs-identifier hs-var">lcl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span class="hs-identifier">getImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">ImportAvails</span><span>
</span><a name="line-822"></a><a name="getImports"><a href="TcRnMonad.html#getImports"><span class="hs-identifier">getImports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325233"><a href="#local-6989586621681325233"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_imports</span><span> </span><a href="#local-6989586621681325233"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span class="hs-identifier">getFixityEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">FixityEnv</span><span>
</span><a name="line-825"></a><a name="getFixityEnv"><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier">getFixityEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325234"><a href="#local-6989586621681325234"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_fix_env</span><span> </span><a href="#local-6989586621681325234"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span class="hs-identifier">extendFixityEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span class="hs-identifier hs-type">FixItem</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><a href="#local-6989586621681324901"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><a href="#local-6989586621681324901"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-828"></a><a name="extendFixityEnv"><a href="TcRnMonad.html#extendFixityEnv"><span class="hs-identifier">extendFixityEnv</span></a></a><span> </span><a name="local-6989586621681325235"><a href="#local-6989586621681325235"><span class="hs-identifier">new_bit</span></a></a><span>
</span><a name="line-829"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier hs-var">updGblEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325236"><a href="#local-6989586621681325236"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcGblEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_fix_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325237"><a href="#local-6989586621681325237"><span class="hs-identifier">old_fix_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-830"></a><span>                </span><a href="#local-6989586621681325236"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">tcg_fix_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendNameEnvList</span><span> </span><a href="#local-6989586621681325237"><span class="hs-identifier hs-var">old_fix_env</span></a><span> </span><a href="#local-6989586621681325235"><span class="hs-identifier hs-var">new_bit</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-831"></a><span>
</span><a name="line-832"></a><span class="hs-identifier">getRecFieldEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">RecFieldEnv</span><span>
</span><a name="line-833"></a><a name="getRecFieldEnv"><a href="TcRnMonad.html#getRecFieldEnv"><span class="hs-identifier">getRecFieldEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325238"><a href="#local-6989586621681325238"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_field_env</span><span> </span><a href="#local-6989586621681325238"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-834"></a><span>
</span><a name="line-835"></a><span class="hs-identifier">getDeclaredDefaultTys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-836"></a><a name="getDeclaredDefaultTys"><a href="TcRnMonad.html#getDeclaredDefaultTys"><span class="hs-identifier">getDeclaredDefaultTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325239"><a href="#local-6989586621681325239"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_default</span><span> </span><a href="#local-6989586621681325239"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-837"></a><span>
</span><a name="line-838"></a><span class="hs-identifier">addDependentFiles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-839"></a><a name="addDependentFiles"><a href="TcRnMonad.html#addDependentFiles"><span class="hs-identifier">addDependentFiles</span></a></a><span> </span><a name="local-6989586621681325240"><a href="#local-6989586621681325240"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-840"></a><span>  </span><a name="local-6989586621681325241"><a href="#local-6989586621681325241"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_dependent_files</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-841"></a><span>  </span><a name="local-6989586621681325242"><a href="#local-6989586621681325242"><span class="hs-identifier">dep_files</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325241"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-842"></a><span>  </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325241"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325240"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681325242"><span class="hs-identifier hs-var">dep_files</span></a><span class="hs-special">)</span><span>
</span><a name="line-843"></a><span>
</span><a name="line-844"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Error management
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span class="hs-identifier">getSrcSpanM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-853"></a><span>        </span><span class="hs-comment">-- Avoid clash with Name.getSrcLoc</span><span>
</span><a name="line-854"></a><a name="getSrcSpanM"><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier">getSrcSpanM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325243"><a href="#local-6989586621681325243"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_loc</span><span> </span><a href="#local-6989586621681325243"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span class="hs-identifier">setSrcSpan</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324900"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324900"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-857"></a><a name="setSrcSpan"><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier">setSrcSpan</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621681325244"><a href="#local-6989586621681325244"><span class="hs-identifier">real_loc</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681325245"><a href="#local-6989586621681325245"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-858"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325246"><a href="#local-6989586621681325246"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325246"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325244"><span class="hs-identifier hs-var">real_loc</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325245"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-859"></a><span class="hs-comment">-- Don't overwrite useful info with useless:</span><span>
</span><a name="line-860"></a><span class="hs-identifier">setSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnhelpfulSpan</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681325247"><a href="#local-6989586621681325247"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325247"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span class="hs-identifier">addLocM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621681324898"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpanLess</span><span> </span><a href="#local-6989586621681324898"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324899"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324898"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324899"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-863"></a><a name="addLocM"><a href="TcRnMonad.html#addLocM"><span class="hs-identifier">addLocM</span></a></a><span> </span><a name="local-6989586621681325248"><a href="#local-6989586621681325248"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681325249"><a href="#local-6989586621681325249"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325250"><a href="#local-6989586621681325250"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621681325249"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681325248"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681325250"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span class="hs-identifier">wrapLocM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621681324896"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621681324897"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-866"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpanLess</span><span> </span><a href="#local-6989586621681324896"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpanLess</span><span> </span><a href="#local-6989586621681324897"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324896"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324897"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-867"></a><span class="hs-comment">-- wrapLocM :: (a -&gt; TcM b) -&gt; Located a -&gt; TcM (Located b)</span><span>
</span><a name="line-868"></a><a name="wrapLocM"><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier">wrapLocM</span></a></a><span> </span><a name="local-6989586621681325251"><a href="#local-6989586621681325251"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681325252"><a href="#local-6989586621681325252"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325253"><a href="#local-6989586621681325253"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621681325252"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325254"><a href="#local-6989586621681325254"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681325251"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681325253"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-869"></a><span>                                                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621681325252"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325254"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-870"></a><span class="hs-identifier">wrapLocFstM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621681324893"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621681324894"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-871"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpanLess</span><span> </span><a href="#local-6989586621681324893"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpanLess</span><span> </span><a href="#local-6989586621681324894"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><a href="#local-6989586621681324895"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324893"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324894"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681324895"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-872"></a><a name="wrapLocFstM"><a href="TcRnMonad.html#wrapLocFstM"><span class="hs-identifier">wrapLocFstM</span></a></a><span> </span><a name="local-6989586621681325255"><a href="#local-6989586621681325255"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681325256"><a href="#local-6989586621681325256"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325257"><a href="#local-6989586621681325257"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-873"></a><span>  </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621681325256"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-874"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681325258"><a href="#local-6989586621681325258"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621681325259"><a href="#local-6989586621681325259"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681325255"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681325257"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-875"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621681325256"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325258"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325259"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-876"></a><span>
</span><a name="line-877"></a><span class="hs-identifier">wrapLocSndM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621681324890"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621681324891"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-878"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpanLess</span><span> </span><a href="#local-6989586621681324890"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324892"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpanLess</span><span> </span><a href="#local-6989586621681324891"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324890"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324892"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681324891"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-879"></a><a name="wrapLocSndM"><a href="TcRnMonad.html#wrapLocSndM"><span class="hs-identifier">wrapLocSndM</span></a></a><span> </span><a name="local-6989586621681325260"><a href="#local-6989586621681325260"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681325261"><a href="#local-6989586621681325261"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325262"><a href="#local-6989586621681325262"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-880"></a><span>  </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621681325261"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-881"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681325263"><a href="#local-6989586621681325263"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621681325264"><a href="#local-6989586621681325264"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681325260"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681325262"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-882"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325263"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621681325261"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325264"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-883"></a><span>
</span><a name="line-884"></a><span class="hs-identifier">wrapLocM_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasSrcSpan</span><span> </span><a href="#local-6989586621681324889"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-885"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpanLess</span><span> </span><a href="#local-6989586621681324889"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324889"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-886"></a><a name="wrapLocM_"><a href="TcRnMonad.html#wrapLocM_"><span class="hs-identifier">wrapLocM_</span></a></a><span> </span><a name="local-6989586621681325265"><a href="#local-6989586621681325265"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621681325266"><a href="#local-6989586621681325266"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325267"><a href="#local-6989586621681325267"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621681325266"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325265"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681325267"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-887"></a><span>
</span><a name="line-888"></a><span class="hs-comment">-- Reporting errors</span><span>
</span><a name="line-889"></a><span>
</span><a name="line-890"></a><span class="hs-identifier">getErrsVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcRef</span><span> </span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">)</span><span>
</span><a name="line-891"></a><a name="getErrsVar"><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier">getErrsVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325268"><a href="#local-6989586621681325268"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_errs</span><span> </span><a href="#local-6989586621681325268"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span class="hs-identifier">setErrsVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRef</span><span> </span><span class="hs-identifier hs-type">Messages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324888"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324888"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-894"></a><a name="setErrsVar"><a href="TcRnMonad.html#setErrsVar"><span class="hs-identifier">setErrsVar</span></a></a><span> </span><a name="local-6989586621681325269"><a href="#local-6989586621681325269"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325270"><a href="#local-6989586621681325270"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325270"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_errs</span><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621681325269"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span class="hs-identifier">addErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-897"></a><a name="addErr"><a href="TcRnMonad.html#addErr"><span class="hs-identifier">addErr</span></a></a><span> </span><a name="local-6989586621681325271"><a href="#local-6989586621681325271"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325272"><a href="#local-6989586621681325272"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621681325272"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325271"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-898"></a><span>
</span><a name="line-899"></a><span class="hs-identifier">failWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324887"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-900"></a><a name="failWith"><a href="TcRnMonad.html#failWith"><span class="hs-identifier">failWith</span></a></a><span> </span><a name="local-6989586621681325273"><a href="#local-6989586621681325273"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="#local-6989586621681325273"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-901"></a><span>
</span><a name="line-902"></a><span class="hs-identifier">failAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324886"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-903"></a><a name="failAt"><a href="TcRnMonad.html#failAt"><span class="hs-identifier">failAt</span></a></a><span> </span><a name="local-6989586621681325274"><a href="#local-6989586621681325274"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325275"><a href="#local-6989586621681325275"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621681325274"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325275"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-904"></a><span>
</span><a name="line-905"></a><span class="hs-identifier">addErrAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span class="hs-comment">-- addErrAt is mainly (exclusively?) used by the renamer, where</span><span>
</span><a name="line-907"></a><span class="hs-comment">-- tidying is not an issue, but it's all lazy so the extra</span><span>
</span><a name="line-908"></a><span class="hs-comment">-- work doesn't matter</span><span>
</span><a name="line-909"></a><a name="addErrAt"><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier">addErrAt</span></a></a><span> </span><a name="local-6989586621681325276"><a href="#local-6989586621681325276"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325277"><a href="#local-6989586621681325277"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325278"><a href="#local-6989586621681325278"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrCtxt"><span class="hs-identifier hs-var">getErrCtxt</span></a><span>
</span><a name="line-910"></a><span>                      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325279"><a href="#local-6989586621681325279"><span class="hs-identifier">tidy_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span>
</span><a name="line-911"></a><span>                      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325280"><a href="#local-6989586621681325280"><span class="hs-identifier">err_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mkErrInfo"><span class="hs-identifier hs-var">mkErrInfo</span></a><span> </span><a href="#local-6989586621681325279"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621681325278"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-912"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addLongErrAt"><span class="hs-identifier hs-var">addLongErrAt</span></a><span> </span><a href="#local-6989586621681325276"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325277"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621681325280"><span class="hs-identifier hs-var">err_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span class="hs-identifier">addErrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">,</span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-915"></a><a name="addErrs"><a href="TcRnMonad.html#addErrs"><span class="hs-identifier">addErrs</span></a></a><span> </span><a name="local-6989586621681325281"><a href="#local-6989586621681325281"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621681325282"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621681325281"><span class="hs-identifier hs-var">msgs</span></a><span>
</span><a name="line-916"></a><span>             </span><span class="hs-keyword">where</span><span>
</span><a name="line-917"></a><span>               </span><a name="local-6989586621681325282"><a href="#local-6989586621681325282"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681325283"><a href="#local-6989586621681325283"><span class="hs-identifier">loc</span></a></a><span class="hs-special">,</span><a name="local-6989586621681325284"><a href="#local-6989586621681325284"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621681325283"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325284"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-918"></a><span>
</span><a name="line-919"></a><span class="hs-identifier">checkErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span class="hs-comment">-- Add the error if the bool is False</span><span>
</span><a name="line-921"></a><a name="checkErr"><a href="TcRnMonad.html#checkErr"><span class="hs-identifier">checkErr</span></a></a><span> </span><a name="local-6989586621681325285"><a href="#local-6989586621681325285"><span class="hs-identifier">ok</span></a></a><span> </span><a name="local-6989586621681325286"><a href="#local-6989586621681325286"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621681325285"><span class="hs-identifier hs-var">ok</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><a href="#local-6989586621681325286"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span class="hs-identifier">addMessages</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Messages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-924"></a><a name="addMessages"><a href="TcRnMonad.html#addMessages"><span class="hs-identifier">addMessages</span></a></a><span> </span><a name="local-6989586621681325287"><a href="#local-6989586621681325287"><span class="hs-identifier">msgs1</span></a></a><span>
</span><a name="line-925"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325288"><a href="#local-6989586621681325288"><span class="hs-identifier">errs_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-926"></a><span>         </span><a name="local-6989586621681325289"><a href="#local-6989586621681325289"><span class="hs-identifier">msgs0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325288"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-927"></a><span>         </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325288"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unionMessages</span><span> </span><a href="#local-6989586621681325289"><span class="hs-identifier hs-var">msgs0</span></a><span> </span><a href="#local-6989586621681325287"><span class="hs-identifier hs-var">msgs1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-928"></a><span>
</span><a name="line-929"></a><span class="hs-identifier">discardWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324885"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324885"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-930"></a><span class="hs-comment">-- Ignore warnings inside the thing inside;</span><span>
</span><a name="line-931"></a><span class="hs-comment">-- used to ignore-unused-variable warnings inside derived code</span><span>
</span><a name="line-932"></a><a name="discardWarnings"><a href="TcRnMonad.html#discardWarnings"><span class="hs-identifier">discardWarnings</span></a></a><span> </span><a name="local-6989586621681325290"><a href="#local-6989586621681325290"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-933"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325291"><a href="#local-6989586621681325291"><span class="hs-identifier">errs_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span>
</span><a name="line-934"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325292"><a href="#local-6989586621681325292"><span class="hs-identifier">old_warns</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325291"><span class="hs-identifier hs-var">errs_var</span></a><span>
</span><a name="line-935"></a><span>
</span><a name="line-936"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325293"><a href="#local-6989586621681325293"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681325290"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-937"></a><span>
</span><a name="line-938"></a><span>        </span><span class="hs-comment">-- Revert warnings to old_warns</span><span>
</span><a name="line-939"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325294"><a href="#local-6989586621681325294"><span class="hs-identifier">_new_warns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325295"><a href="#local-6989586621681325295"><span class="hs-identifier">new_errs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325291"><span class="hs-identifier hs-var">errs_var</span></a><span>
</span><a name="line-940"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325291"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325292"><span class="hs-identifier hs-var">old_warns</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325295"><span class="hs-identifier hs-var">new_errs</span></a><span class="hs-special">)</span><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325293"><span class="hs-identifier hs-var">result</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-943"></a><span>
</span><a name="line-944"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Shared error message stuff: renamer and typechecker
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-951"></a><span>
</span><a name="line-952"></a><span class="hs-identifier">mkLongErrAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span>
</span><a name="line-953"></a><a name="mkLongErrAt"><a href="TcRnMonad.html#mkLongErrAt"><span class="hs-identifier">mkLongErrAt</span></a></a><span> </span><a name="local-6989586621681325296"><a href="#local-6989586621681325296"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325297"><a href="#local-6989586621681325297"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621681325298"><a href="#local-6989586621681325298"><span class="hs-identifier">extra</span></a></a><span>
</span><a name="line-954"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325299"><a href="#local-6989586621681325299"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-955"></a><span>         </span><a name="local-6989586621681325300"><a href="#local-6989586621681325300"><span class="hs-identifier">printer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getPrintUnqualified"><span class="hs-identifier hs-var">getPrintUnqualified</span></a><span> </span><a href="#local-6989586621681325299"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-956"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkLongErrMsg</span><span> </span><a href="#local-6989586621681325299"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325296"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325300"><span class="hs-identifier hs-var">printer</span></a><span> </span><a href="#local-6989586621681325297"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621681325298"><span class="hs-identifier hs-var">extra</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-957"></a><span>
</span><a name="line-958"></a><span class="hs-identifier">mkErrDocAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ErrDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span>
</span><a name="line-959"></a><a name="mkErrDocAt"><a href="TcRnMonad.html#mkErrDocAt"><span class="hs-identifier">mkErrDocAt</span></a></a><span> </span><a name="local-6989586621681325301"><a href="#local-6989586621681325301"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325302"><a href="#local-6989586621681325302"><span class="hs-identifier">errDoc</span></a></a><span>
</span><a name="line-960"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325303"><a href="#local-6989586621681325303"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-961"></a><span>         </span><a name="local-6989586621681325304"><a href="#local-6989586621681325304"><span class="hs-identifier">printer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getPrintUnqualified"><span class="hs-identifier hs-var">getPrintUnqualified</span></a><span> </span><a href="#local-6989586621681325303"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-962"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkErrDoc</span><span> </span><a href="#local-6989586621681325303"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325301"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325304"><span class="hs-identifier hs-var">printer</span></a><span> </span><a href="#local-6989586621681325302"><span class="hs-identifier hs-var">errDoc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-963"></a><span>
</span><a name="line-964"></a><span class="hs-identifier">addLongErrAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-965"></a><a name="addLongErrAt"><a href="TcRnMonad.html#addLongErrAt"><span class="hs-identifier">addLongErrAt</span></a></a><span> </span><a name="local-6989586621681325305"><a href="#local-6989586621681325305"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325306"><a href="#local-6989586621681325306"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621681325307"><a href="#local-6989586621681325307"><span class="hs-identifier">extra</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#mkLongErrAt"><span class="hs-identifier hs-var">mkLongErrAt</span></a><span> </span><a href="#local-6989586621681325305"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325306"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621681325307"><span class="hs-identifier hs-var">extra</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="TcRnMonad.html#reportError"><span class="hs-identifier hs-var">reportError</span></a><span>
</span><a name="line-966"></a><span>
</span><a name="line-967"></a><span class="hs-identifier">reportErrors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrMsg</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-968"></a><a name="reportErrors"><a href="TcRnMonad.html#reportErrors"><span class="hs-identifier">reportErrors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="TcRnMonad.html#reportError"><span class="hs-identifier hs-var">reportError</span></a><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span class="hs-identifier">reportError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-971"></a><a name="reportError"><a href="TcRnMonad.html#reportError"><span class="hs-identifier">reportError</span></a></a><span> </span><a name="local-6989586621681325308"><a href="#local-6989586621681325308"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-972"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Adding error:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprLocErrMsg</span><span> </span><a href="#local-6989586621681325308"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-973"></a><span>         </span><a name="local-6989586621681325309"><a href="#local-6989586621681325309"><span class="hs-identifier">errs_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-974"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681325310"><a href="#local-6989586621681325310"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325311"><a href="#local-6989586621681325311"><span class="hs-identifier">errs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325309"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-975"></a><span>         </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325309"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325310"><span class="hs-identifier hs-var">warns</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325311"><span class="hs-identifier hs-var">errs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325308"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span class="hs-identifier">reportWarning</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-978"></a><a name="reportWarning"><a href="TcRnMonad.html#reportWarning"><span class="hs-identifier">reportWarning</span></a></a><span> </span><a name="local-6989586621681325312"><a href="#local-6989586621681325312"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681325313"><a href="#local-6989586621681325313"><span class="hs-identifier">err</span></a></a><span>
</span><a name="line-979"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325314"><a href="#local-6989586621681325314"><span class="hs-identifier">warn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">makeIntoWarning</span><span> </span><a href="#local-6989586621681325312"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621681325313"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-980"></a><span>                    </span><span class="hs-comment">-- 'err' was built by mkLongErrMsg or something like that,</span><span>
</span><a name="line-981"></a><span>                    </span><span class="hs-comment">-- so it's of error severity.  For a warning we downgrade</span><span>
</span><a name="line-982"></a><span>                    </span><span class="hs-comment">-- its severity to SevWarning</span><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Adding warning:&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprLocErrMsg</span><span> </span><a href="#local-6989586621681325314"><span class="hs-identifier hs-var">warn</span></a><span class="hs-special">)</span><span>
</span><a name="line-985"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325315"><a href="#local-6989586621681325315"><span class="hs-identifier">errs_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span>
</span><a name="line-986"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325316"><a href="#local-6989586621681325316"><span class="hs-identifier">warns</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325317"><a href="#local-6989586621681325317"><span class="hs-identifier">errs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325315"><span class="hs-identifier hs-var">errs_var</span></a><span>
</span><a name="line-987"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325315"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325316"><span class="hs-identifier hs-var">warns</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325314"><span class="hs-identifier hs-var">warn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325317"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-988"></a><span>
</span><a name="line-989"></a><span class="hs-identifier">try_m</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324884"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">IOEnvFailure</span><span> </span><a href="#local-6989586621681324884"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span class="hs-comment">-- Does tryM, with a debug-trace on failure</span><span>
</span><a name="line-991"></a><span class="hs-comment">-- If we do recover from an exception, /insoluble/ constraints</span><span>
</span><a name="line-992"></a><span class="hs-comment">-- (only) in 'thing' are are propagated</span><span>
</span><a name="line-993"></a><a name="try_m"><a href="TcRnMonad.html#try_m"><span class="hs-identifier">try_m</span></a></a><span> </span><a name="local-6989586621681325318"><a href="#local-6989586621681325318"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-994"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325319"><a href="#local-6989586621681325319"><span class="hs-identifier">mb_r</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325320"><a href="#local-6989586621681325320"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tryCaptureConstraints"><span class="hs-identifier hs-var">tryCaptureConstraints</span></a><span> </span><a href="#local-6989586621681325318"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-995"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitConstraints"><span class="hs-identifier hs-var">emitConstraints</span></a><span> </span><a href="#local-6989586621681325320"><span class="hs-identifier hs-var">lie</span></a><span>
</span><a name="line-996"></a><span>
</span><a name="line-997"></a><span>       </span><span class="hs-comment">-- Debug trace</span><span>
</span><a name="line-998"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325319"><span class="hs-identifier hs-var">mb_r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-999"></a><span>            </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681325321"><a href="#local-6989586621681325321"><span class="hs-identifier">exn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tryTc/recoverM recovering from&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1000"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showException</span><span> </span><a href="#local-6989586621681325321"><span class="hs-identifier hs-var">exn</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325320"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><span>            </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325319"><span class="hs-identifier hs-var">mb_r</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1004"></a><span>
</span><a name="line-1005"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1006"></a><span class="hs-identifier">recoverM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324883"><span class="hs-identifier hs-type">r</span></a><span>      </span><span class="hs-comment">-- Recovery action; do this if the main one fails</span><span>
</span><a name="line-1007"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324883"><span class="hs-identifier hs-type">r</span></a><span>      </span><span class="hs-comment">-- Main action: do this first;</span><span>
</span><a name="line-1008"></a><span>                        </span><span class="hs-comment">--  if it generates errors, propagate them all</span><span>
</span><a name="line-1009"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324883"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-1010"></a><span class="hs-comment">-- Errors in 'thing' are retained</span><span>
</span><a name="line-1011"></a><span class="hs-comment">-- If we do recover from an exception, /insoluble/ constraints</span><span>
</span><a name="line-1012"></a><span class="hs-comment">-- (only) in 'thing' are are propagated</span><span>
</span><a name="line-1013"></a><a name="recoverM"><a href="TcRnMonad.html#recoverM"><span class="hs-identifier">recoverM</span></a></a><span> </span><a name="local-6989586621681325322"><a href="#local-6989586621681325322"><span class="hs-identifier">recover</span></a></a><span> </span><a name="local-6989586621681325323"><a href="#local-6989586621681325323"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-1014"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325324"><a href="#local-6989586621681325324"><span class="hs-identifier">mb_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#try_m"><span class="hs-identifier hs-var">try_m</span></a><span> </span><a href="#local-6989586621681325323"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1015"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325324"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1016"></a><span>           </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325322"><span class="hs-identifier hs-var">recover</span></a><span>
</span><a name="line-1017"></a><span>           </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681325325"><a href="#local-6989586621681325325"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325325"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span>
</span><a name="line-1020"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1021"></a><span>
</span><a name="line-1022"></a><span class="hs-comment">-- | Drop elements of the input that fail, so the result</span><span>
</span><a name="line-1023"></a><span class="hs-comment">-- list can be shorter than the argument list</span><span>
</span><a name="line-1024"></a><span class="hs-identifier">mapAndRecoverM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324881"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324882"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681324881"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681324882"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-1025"></a><a name="mapAndRecoverM"><a href="TcRnMonad.html#mapAndRecoverM"><span class="hs-identifier">mapAndRecoverM</span></a></a><span> </span><a name="local-6989586621681325326"><a href="#local-6989586621681325326"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybeM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">rightToMaybe</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcRnMonad.html#try_m"><span class="hs-identifier hs-var">try_m</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681325326"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span>
</span><a name="line-1027"></a><span class="hs-comment">-- | The accumulator is not updated if the action fails</span><span>
</span><a name="line-1028"></a><span class="hs-identifier">foldAndRecoverM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324879"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324880"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324879"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681324879"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681324880"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324879"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1029"></a><a name="foldAndRecoverM"><a href="TcRnMonad.html#foldAndRecoverM"><span class="hs-identifier">foldAndRecoverM</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681325327"><a href="#local-6989586621681325327"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325327"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-1030"></a><span class="hs-identifier">foldAndRecoverM</span><span> </span><a name="local-6989586621681325328"><a href="#local-6989586621681325328"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621681325329"><a href="#local-6989586621681325329"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681325330"><a href="#local-6989586621681325330"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681325331"><a href="#local-6989586621681325331"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1031"></a><span>                          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325332"><a href="#local-6989586621681325332"><span class="hs-identifier">mb_r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#try_m"><span class="hs-identifier hs-var">try_m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325328"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681325329"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621681325330"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1032"></a><span>                             </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325332"><span class="hs-identifier hs-var">mb_r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1033"></a><span>                                </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#foldAndRecoverM"><span class="hs-identifier hs-var">foldAndRecoverM</span></a><span> </span><a href="#local-6989586621681325328"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681325329"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621681325331"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-1034"></a><span>                                </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681325333"><a href="#local-6989586621681325333"><span class="hs-identifier">acc'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#foldAndRecoverM"><span class="hs-identifier hs-var">foldAndRecoverM</span></a><span> </span><a href="#local-6989586621681325328"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681325333"><span class="hs-identifier hs-var">acc'</span></a><span> </span><a href="#local-6989586621681325331"><span class="hs-identifier hs-var">xs</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-1035"></a><span>
</span><a name="line-1036"></a><span class="hs-comment">-- | Succeeds if applying the argument to all members of the lists succeeds,</span><span>
</span><a name="line-1037"></a><span class="hs-comment">--   but nevertheless runs it on all arguments, to collect all errors.</span><span>
</span><a name="line-1038"></a><span class="hs-identifier">mapAndReportM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324877"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324878"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681324877"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681324878"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-1039"></a><a name="mapAndReportM"><a href="TcRnMonad.html#mapAndReportM"><span class="hs-identifier">mapAndReportM</span></a></a><span> </span><a name="local-6989586621681325334"><a href="#local-6989586621681325334"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621681325335"><a href="#local-6989586621681325335"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#mapAndRecoverM"><span class="hs-identifier hs-var">mapAndRecoverM</span></a><span> </span><a href="#local-6989586621681325334"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681325335"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1042"></a><span class="hs-identifier">tryTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324876"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681324876"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1043"></a><span class="hs-comment">-- (tryTc m) executes m, and returns</span><span>
</span><a name="line-1044"></a><span class="hs-comment">--      Just r,  if m succeeds (returning r)</span><span>
</span><a name="line-1045"></a><span class="hs-comment">--      Nothing, if m fails</span><span>
</span><a name="line-1046"></a><span class="hs-comment">-- It also returns all the errors and warnings accumulated by m</span><span>
</span><a name="line-1047"></a><span class="hs-comment">-- It always succeeds (never raises an exception)</span><span>
</span><a name="line-1048"></a><a name="tryTc"><a href="TcRnMonad.html#tryTc"><span class="hs-identifier">tryTc</span></a></a><span> </span><a name="local-6989586621681325336"><a href="#local-6989586621681325336"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1049"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325337"><a href="#local-6989586621681325337"><span class="hs-identifier">errs_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyMessages</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1050"></a><span>
</span><a name="line-1051"></a><span>        </span><a name="local-6989586621681325338"><a href="#local-6989586621681325338"><span class="hs-identifier">res</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#try_m"><span class="hs-identifier hs-var">try_m</span></a><span> </span><span class="hs-operator hs-var">$</span><span>  </span><span class="hs-comment">-- Be sure to catch exceptions, so that</span><span>
</span><a name="line-1052"></a><span>                         </span><span class="hs-comment">-- we guaranteed to read the messages out</span><span>
</span><a name="line-1053"></a><span>                         </span><span class="hs-comment">-- of that brand-new errs_var!</span><span>
</span><a name="line-1054"></a><span>                </span><a href="TcRnMonad.html#setErrsVar"><span class="hs-identifier hs-var">setErrsVar</span></a><span> </span><a href="#local-6989586621681325337"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1055"></a><span>                </span><a href="#local-6989586621681325336"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1056"></a><span>
</span><a name="line-1057"></a><span>        </span><a name="local-6989586621681325339"><a href="#local-6989586621681325339"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325337"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1058"></a><span>
</span><a name="line-1059"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325339"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325338"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1060"></a><span>                        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1061"></a><span>                        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681325340"><a href="#local-6989586621681325340"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325340"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span>
</span><a name="line-1062"></a><span>        </span><span class="hs-comment">-- The exception is always the IOEnv built-in</span><span>
</span><a name="line-1063"></a><span>        </span><span class="hs-comment">-- in exception; see IOEnv.failM</span><span>
</span><a name="line-1064"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-1065"></a><span>
</span><a name="line-1066"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1067"></a><span class="hs-identifier">discardErrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324875"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324875"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1068"></a><span class="hs-comment">-- (discardErrs m) runs m,</span><span>
</span><a name="line-1069"></a><span class="hs-comment">--   discarding all error messages and warnings generated by m</span><span>
</span><a name="line-1070"></a><span class="hs-comment">-- If m fails, discardErrs fails, and vice versa</span><span>
</span><a name="line-1071"></a><a name="discardErrs"><a href="TcRnMonad.html#discardErrs"><span class="hs-identifier">discardErrs</span></a></a><span> </span><a name="local-6989586621681325341"><a href="#local-6989586621681325341"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-1072"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325342"><a href="#local-6989586621681325342"><span class="hs-identifier">errs_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyMessages</span><span>
</span><a name="line-1073"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setErrsVar"><span class="hs-identifier hs-var">setErrsVar</span></a><span> </span><a href="#local-6989586621681325342"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><a href="#local-6989586621681325341"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1074"></a><span>
</span><a name="line-1075"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1076"></a><span class="hs-identifier">tryTcDiscardingErrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324874"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324874"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324874"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-1077"></a><span class="hs-comment">-- (tryTcDiscardingErrs recover main) tries 'main';</span><span>
</span><a name="line-1078"></a><span class="hs-comment">--      if 'main' succeeds with no error messages, it's the answer</span><span>
</span><a name="line-1079"></a><span class="hs-comment">--      otherwise discard everything from 'main', including errors,</span><span>
</span><a name="line-1080"></a><span class="hs-comment">--          and try 'recover' instead.</span><span>
</span><a name="line-1081"></a><a name="tryTcDiscardingErrs"><a href="TcRnMonad.html#tryTcDiscardingErrs"><span class="hs-identifier">tryTcDiscardingErrs</span></a></a><span> </span><a name="local-6989586621681325343"><a href="#local-6989586621681325343"><span class="hs-identifier">recover</span></a></a><span> </span><a name="local-6989586621681325344"><a href="#local-6989586621681325344"><span class="hs-identifier">main</span></a></a><span>
</span><a name="line-1082"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325345"><a href="#local-6989586621681325345"><span class="hs-identifier">msgs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325346"><a href="#local-6989586621681325346"><span class="hs-identifier">mb_res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tryTc"><span class="hs-identifier hs-var">tryTc</span></a><span> </span><a href="#local-6989586621681325344"><span class="hs-identifier hs-var">main</span></a><span>
</span><a name="line-1083"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325347"><a href="#local-6989586621681325347"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1084"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325346"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1085"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681325348"><a href="#local-6989586621681325348"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">errorsFound</span><span> </span><a href="#local-6989586621681325347"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325345"><span class="hs-identifier hs-var">msgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1086"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- 'main' succeeed with no error messages</span><span>
</span><a name="line-1087"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#addMessages"><span class="hs-identifier hs-var">addMessages</span></a><span> </span><a href="#local-6989586621681325345"><span class="hs-identifier hs-var">msgs</span></a><span>  </span><span class="hs-comment">-- msgs might still have warnings</span><span>
</span><a name="line-1088"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325348"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1089"></a><span>
</span><a name="line-1090"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- 'main' failed, or produced an error message</span><span>
</span><a name="line-1091"></a><span>                 </span><a href="#local-6989586621681325343"><span class="hs-identifier hs-var">recover</span></a><span>     </span><span class="hs-comment">-- Discard all errors and warnings entirely</span><span>
</span><a name="line-1092"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-1093"></a><span>
</span><a name="line-1094"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1095"></a><span class="hs-comment">-- (askNoErrs m) runs m</span><span>
</span><a name="line-1096"></a><span class="hs-comment">-- If m fails,</span><span>
</span><a name="line-1097"></a><span class="hs-comment">--    then (askNoErrs m) fails</span><span>
</span><a name="line-1098"></a><span class="hs-comment">-- If m succeeds with result r,</span><span>
</span><a name="line-1099"></a><span class="hs-comment">--    then (askNoErrs m) succeeds with result (r, b),</span><span>
</span><a name="line-1100"></a><span class="hs-comment">--         where b is True iff m generated no errors</span><span>
</span><a name="line-1101"></a><span class="hs-comment">-- Regardless of success or failure,</span><span>
</span><a name="line-1102"></a><span class="hs-comment">--   propagate any errors/warnings generated by m</span><span>
</span><a name="line-1103"></a><span class="hs-identifier">askNoErrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324873"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324873"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-1104"></a><a name="askNoErrs"><a href="TcRnMonad.html#askNoErrs"><span class="hs-identifier">askNoErrs</span></a></a><span> </span><a name="local-6989586621681325349"><a href="#local-6989586621681325349"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-1105"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325350"><a href="#local-6989586621681325350"><span class="hs-identifier">msgs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325351"><a href="#local-6989586621681325351"><span class="hs-identifier">mb_res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tryTc"><span class="hs-identifier hs-var">tryTc</span></a><span> </span><a href="#local-6989586621681325349"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1106"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addMessages"><span class="hs-identifier hs-var">addMessages</span></a><span> </span><a href="#local-6989586621681325350"><span class="hs-identifier hs-var">msgs</span></a><span>  </span><span class="hs-comment">-- Always propagate errors</span><span>
</span><a name="line-1107"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325351"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1108"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-1109"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681325352"><a href="#local-6989586621681325352"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325353"><a href="#local-6989586621681325353"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1110"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325354"><a href="#local-6989586621681325354"><span class="hs-identifier">errs_found</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">errorsFound</span><span> </span><a href="#local-6989586621681325353"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325350"><span class="hs-identifier hs-var">msgs</span></a><span>
</span><a name="line-1111"></a><span>                          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325352"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681325354"><span class="hs-identifier hs-var">errs_found</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1112"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1113"></a><span class="hs-identifier">checkNoErrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324872"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324872"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-1114"></a><span class="hs-comment">-- (checkNoErrs m) succeeds iff m succeeds and generates no errors</span><span>
</span><a name="line-1115"></a><span class="hs-comment">-- If m fails then (checkNoErrsTc m) fails.</span><span>
</span><a name="line-1116"></a><span class="hs-comment">-- If m succeeds, it checks whether m generated any errors messages</span><span>
</span><a name="line-1117"></a><span class="hs-comment">--      (it might have recovered internally)</span><span>
</span><a name="line-1118"></a><span class="hs-comment">--      If so, it fails too.</span><span>
</span><a name="line-1119"></a><span class="hs-comment">-- Regardless, any errors generated by m are propagated to the enclosing context.</span><span>
</span><a name="line-1120"></a><a name="checkNoErrs"><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier">checkNoErrs</span></a></a><span> </span><a name="local-6989586621681325355"><a href="#local-6989586621681325355"><span class="hs-identifier">main</span></a></a><span>
</span><a name="line-1121"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325356"><a href="#local-6989586621681325356"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325357"><a href="#local-6989586621681325357"><span class="hs-identifier">no_errs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#askNoErrs"><span class="hs-identifier hs-var">askNoErrs</span></a><span> </span><a href="#local-6989586621681325355"><span class="hs-identifier hs-var">main</span></a><span>
</span><a name="line-1122"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><a href="#local-6989586621681325357"><span class="hs-identifier hs-var">no_errs</span></a><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-1123"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325356"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1124"></a><span>
</span><a name="line-1125"></a><span class="hs-comment">-----------------------</span><span>
</span><a name="line-1126"></a><span class="hs-identifier">whenNoErrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1127"></a><a name="whenNoErrs"><a href="TcRnMonad.html#whenNoErrs"><span class="hs-identifier">whenNoErrs</span></a></a><span> </span><a name="local-6989586621681325358"><a href="#local-6989586621681325358"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#ifErrsM"><span class="hs-identifier hs-var">ifErrsM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325358"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1128"></a><span>
</span><a name="line-1129"></a><span class="hs-identifier">ifErrsM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324871"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324871"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324871"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-1130"></a><span class="hs-comment">--      ifErrsM bale_out normal</span><span>
</span><a name="line-1131"></a><span class="hs-comment">-- does 'bale_out' if there are errors in errors collection</span><span>
</span><a name="line-1132"></a><span class="hs-comment">-- otherwise does 'normal'</span><span>
</span><a name="line-1133"></a><a name="ifErrsM"><a href="TcRnMonad.html#ifErrsM"><span class="hs-identifier">ifErrsM</span></a></a><span> </span><a name="local-6989586621681325359"><a href="#local-6989586621681325359"><span class="hs-identifier">bale_out</span></a></a><span> </span><a name="local-6989586621681325360"><a href="#local-6989586621681325360"><span class="hs-identifier">normal</span></a></a><span>
</span><a name="line-1134"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325361"><a href="#local-6989586621681325361"><span class="hs-identifier">errs_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrsVar"><span class="hs-identifier hs-var">getErrsVar</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1135"></a><span>        </span><a name="local-6989586621681325362"><a href="#local-6989586621681325362"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325361"><span class="hs-identifier hs-var">errs_var</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1136"></a><span>        </span><a name="local-6989586621681325363"><a href="#local-6989586621681325363"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1137"></a><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">errorsFound</span><span> </span><a href="#local-6989586621681325363"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325362"><span class="hs-identifier hs-var">msgs</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-1138"></a><span>           </span><a href="#local-6989586621681325359"><span class="hs-identifier hs-var">bale_out</span></a><span>
</span><a name="line-1139"></a><span>        </span><span class="hs-keyword">else</span><span>
</span><a name="line-1140"></a><span>           </span><a href="#local-6989586621681325360"><span class="hs-identifier hs-var">normal</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1141"></a><span>
</span><a name="line-1142"></a><span class="hs-identifier">failIfErrsM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1143"></a><span class="hs-comment">-- Useful to avoid error cascades</span><span>
</span><a name="line-1144"></a><a name="failIfErrsM"><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier">failIfErrsM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#ifErrsM"><span class="hs-identifier hs-var">ifErrsM</span></a><span> </span><span class="hs-identifier hs-var">failM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1145"></a><span>
</span><a name="line-1146"></a><span class="hs-identifier">checkTH</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681324870"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1147"></a><a name="checkTH"><a href="TcRnMonad.html#checkTH"><span class="hs-identifier">checkTH</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- OK</span><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span class="hs-identifier">failTH</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621681324868"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621681324868"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324869"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-1150"></a><a name="failTH"><a href="TcRnMonad.html#failTH"><span class="hs-identifier">failTH</span></a></a><span> </span><a name="local-6989586621681325364"><a href="#local-6989586621681325364"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621681325365"><a href="#local-6989586621681325365"><span class="hs-identifier">what</span></a></a><span>  </span><span class="hs-comment">-- Raise an error in a stage-1 compiler</span><span>
</span><a name="line-1151"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'A'</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621681325365"><span class="hs-identifier hs-var">what</span></a><span>
</span><a name="line-1152"></a><span>                             </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;requires GHC with interpreter support:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1153"></a><span>                          </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325364"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Perhaps you are using a stage-1 compiler?&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>
</span><a name="line-1156"></a><span>
</span><a name="line-1157"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
        Context management for the type checker
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1163"></a><span>
</span><a name="line-1164"></a><span class="hs-identifier">getErrCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrCtxt</span><span class="hs-special">]</span><span>
</span><a name="line-1165"></a><a name="getErrCtxt"><a href="TcRnMonad.html#getErrCtxt"><span class="hs-identifier">getErrCtxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325366"><a href="#local-6989586621681325366"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_ctxt</span><span> </span><a href="#local-6989586621681325366"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1166"></a><span>
</span><a name="line-1167"></a><span class="hs-identifier">setErrCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrCtxt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324867"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324867"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1168"></a><a name="setErrCtxt"><a href="TcRnMonad.html#setErrCtxt"><span class="hs-identifier">setErrCtxt</span></a></a><span> </span><a name="local-6989586621681325367"><a href="#local-6989586621681325367"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325368"><a href="#local-6989586621681325368"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325368"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325367"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1169"></a><span>
</span><a name="line-1170"></a><span class="hs-comment">-- | Add a fixed message to the error context. This message should not</span><span>
</span><a name="line-1171"></a><span class="hs-comment">-- do any tidying.</span><span>
</span><a name="line-1172"></a><span class="hs-identifier">addErrCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324866"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324866"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1173"></a><a name="addErrCtxt"><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier">addErrCtxt</span></a></a><span> </span><a name="local-6989586621681325369"><a href="#local-6989586621681325369"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier hs-var">addErrCtxtM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325370"><a href="#local-6989586621681325370"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325370"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325369"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1174"></a><span>
</span><a name="line-1175"></a><span class="hs-comment">-- | Add a message to the error context. This message may do tidying.</span><span>
</span><a name="line-1176"></a><span class="hs-identifier">addErrCtxtM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324865"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324865"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1177"></a><a name="addErrCtxtM"><a href="TcRnMonad.html#addErrCtxtM"><span class="hs-identifier">addErrCtxtM</span></a></a><span> </span><a name="local-6989586621681325371"><a href="#local-6989586621681325371"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updCtxt"><span class="hs-identifier hs-var">updCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325372"><a href="#local-6989586621681325372"><span class="hs-identifier">ctxts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325371"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681325372"><span class="hs-identifier hs-var">ctxts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1178"></a><span>
</span><a name="line-1179"></a><span class="hs-comment">-- | Add a fixed landmark message to the error context. A landmark</span><span>
</span><a name="line-1180"></a><span class="hs-comment">-- message is always sure to be reported, even if there is a lot of</span><span>
</span><a name="line-1181"></a><span class="hs-comment">-- context. It also doesn't count toward the maximum number of contexts</span><span>
</span><a name="line-1182"></a><span class="hs-comment">-- reported.</span><span>
</span><a name="line-1183"></a><span class="hs-identifier">addLandmarkErrCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324864"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324864"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1184"></a><a name="addLandmarkErrCtxt"><a href="TcRnMonad.html#addLandmarkErrCtxt"><span class="hs-identifier">addLandmarkErrCtxt</span></a></a><span> </span><a name="local-6989586621681325373"><a href="#local-6989586621681325373"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addLandmarkErrCtxtM"><span class="hs-identifier hs-var">addLandmarkErrCtxtM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325374"><a href="#local-6989586621681325374"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325374"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325373"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1185"></a><span>
</span><a name="line-1186"></a><span class="hs-comment">-- | Variant of 'addLandmarkErrCtxt' that allows for monadic operations</span><span>
</span><a name="line-1187"></a><span class="hs-comment">-- and tidying.</span><span>
</span><a name="line-1188"></a><span class="hs-identifier">addLandmarkErrCtxtM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324863"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324863"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1189"></a><a name="addLandmarkErrCtxtM"><a href="TcRnMonad.html#addLandmarkErrCtxtM"><span class="hs-identifier">addLandmarkErrCtxtM</span></a></a><span> </span><a name="local-6989586621681325375"><a href="#local-6989586621681325375"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updCtxt"><span class="hs-identifier hs-var">updCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325376"><a href="#local-6989586621681325376"><span class="hs-identifier">ctxts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325375"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681325376"><span class="hs-identifier hs-var">ctxts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1190"></a><span>
</span><a name="line-1191"></a><span class="hs-comment">-- Helper function for the above</span><span>
</span><a name="line-1192"></a><span class="hs-identifier">updCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrCtxt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrCtxt</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324862"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324862"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1193"></a><a name="updCtxt"><a href="TcRnMonad.html#updCtxt"><span class="hs-identifier">updCtxt</span></a></a><span> </span><a name="local-6989586621681325377"><a href="#local-6989586621681325377"><span class="hs-identifier">upd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325378"><a href="#local-6989586621681325378"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcLclEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325379"><a href="#local-6989586621681325379"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1194"></a><span>                           </span><a href="#local-6989586621681325378"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325377"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621681325379"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1195"></a><span>
</span><a name="line-1196"></a><span class="hs-identifier">popErrCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324861"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324861"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1197"></a><a name="popErrCtxt"><a href="TcRnMonad.html#popErrCtxt"><span class="hs-identifier">popErrCtxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updCtxt"><span class="hs-identifier hs-var">updCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325380"><a href="#local-6989586621681325380"><span class="hs-identifier">msgs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325380"><span class="hs-identifier hs-var">msgs</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681325381"><a href="#local-6989586621681325381"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325381"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1198"></a><span>
</span><a name="line-1199"></a><span class="hs-identifier">getCtLocM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TypeOrKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span>
</span><a name="line-1200"></a><a name="getCtLocM"><a href="TcRnMonad.html#getCtLocM"><span class="hs-identifier">getCtLocM</span></a></a><span> </span><a name="local-6989586621681325382"><a href="#local-6989586621681325382"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-6989586621681325383"><a href="#local-6989586621681325383"><span class="hs-identifier">t_or_k</span></a></a><span>
</span><a name="line-1201"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325384"><a href="#local-6989586621681325384"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1202"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CtLoc</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctl_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325382"><span class="hs-identifier hs-var">origin</span></a><span>
</span><a name="line-1203"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctl_env</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325384"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1204"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctl_t_or_k</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325383"><span class="hs-identifier hs-var">t_or_k</span></a><span>
</span><a name="line-1205"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctl_depth</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">initialSubGoalDepth</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1206"></a><span>
</span><a name="line-1207"></a><span class="hs-identifier">setCtLocM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324860"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324860"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1208"></a><span class="hs-comment">-- Set the SrcSpan and error context from the CtLoc</span><span>
</span><a name="line-1209"></a><a name="setCtLocM"><a href="TcRnMonad.html#setCtLocM"><span class="hs-identifier">setCtLocM</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CtLoc</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325395"><a href="#local-6989586621681325395"><span class="hs-identifier">lcl</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681325396"><a href="#local-6989586621681325396"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1210"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325397"><a href="#local-6989586621681325397"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325397"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_loc</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcl_loc</span><span> </span><a href="#local-6989586621681325395"><span class="hs-identifier hs-var">lcl</span></a><span>
</span><a name="line-1211"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcl_bndrs</span><span> </span><a href="#local-6989586621681325395"><span class="hs-identifier hs-var">lcl</span></a><span>
</span><a name="line-1212"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_ctxt</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcl_ctxt</span><span> </span><a href="#local-6989586621681325395"><span class="hs-identifier hs-var">lcl</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1213"></a><span>              </span><a href="#local-6989586621681325396"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1214"></a><span>
</span><a name="line-1215"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
             Error message generation (type checker)
*                                                                      *
************************************************************************

    The addErrTc functions add an error message, but do not cause failure.
    The 'M' variants pass a TidyEnv that has already been used to
    tidy up the message; we then use it to tidy the context messages
-}</span><span>
</span><a name="line-1226"></a><span>
</span><a name="line-1227"></a><span class="hs-identifier">addErrTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1228"></a><a name="addErrTc"><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier">addErrTc</span></a></a><span> </span><a name="local-6989586621681325398"><a href="#local-6989586621681325398"><span class="hs-identifier">err_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325399"><a href="#local-6989586621681325399"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span>
</span><a name="line-1229"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addErrTcM"><span class="hs-identifier hs-var">addErrTcM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325399"><span class="hs-identifier hs-var">env0</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325398"><span class="hs-identifier hs-var">err_msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1230"></a><span>
</span><a name="line-1231"></a><span class="hs-identifier">addErrsTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1232"></a><a name="addErrsTc"><a href="TcRnMonad.html#addErrsTc"><span class="hs-identifier">addErrsTc</span></a></a><span> </span><a name="local-6989586621681325400"><a href="#local-6989586621681325400"><span class="hs-identifier">err_msgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><a href="#local-6989586621681325400"><span class="hs-identifier hs-var">err_msgs</span></a><span>
</span><a name="line-1233"></a><span>
</span><a name="line-1234"></a><span class="hs-identifier">addErrTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1235"></a><a name="addErrTcM"><a href="TcRnMonad.html#addErrTcM"><span class="hs-identifier">addErrTcM</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681325401"><a href="#local-6989586621681325401"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325402"><a href="#local-6989586621681325402"><span class="hs-identifier">err_msg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1236"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325403"><a href="#local-6989586621681325403"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrCtxt"><span class="hs-identifier hs-var">getErrCtxt</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1237"></a><span>         </span><a name="local-6989586621681325404"><a href="#local-6989586621681325404"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1238"></a><span>         </span><a href="TcRnMonad.html#add_err_tcm"><span class="hs-identifier hs-var">add_err_tcm</span></a><span> </span><a href="#local-6989586621681325401"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621681325402"><span class="hs-identifier hs-var">err_msg</span></a><span> </span><a href="#local-6989586621681325404"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325403"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1239"></a><span>
</span><a name="line-1240"></a><span class="hs-comment">-- Return the error message, instead of reporting it straight away</span><span>
</span><a name="line-1241"></a><span class="hs-identifier">mkErrTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span>
</span><a name="line-1242"></a><a name="mkErrTcM"><a href="TcRnMonad.html#mkErrTcM"><span class="hs-identifier">mkErrTcM</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681325405"><a href="#local-6989586621681325405"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325406"><a href="#local-6989586621681325406"><span class="hs-identifier">err_msg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1243"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325407"><a href="#local-6989586621681325407"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrCtxt"><span class="hs-identifier hs-var">getErrCtxt</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1244"></a><span>         </span><a name="local-6989586621681325408"><a href="#local-6989586621681325408"><span class="hs-identifier">loc</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1245"></a><span>         </span><a name="local-6989586621681325409"><a href="#local-6989586621681325409"><span class="hs-identifier">err_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mkErrInfo"><span class="hs-identifier hs-var">mkErrInfo</span></a><span> </span><a href="#local-6989586621681325405"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621681325407"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1246"></a><span>         </span><a href="TcRnMonad.html#mkLongErrAt"><span class="hs-identifier hs-var">mkLongErrAt</span></a><span> </span><a href="#local-6989586621681325408"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325406"><span class="hs-identifier hs-var">err_msg</span></a><span> </span><a href="#local-6989586621681325409"><span class="hs-identifier hs-var">err_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1247"></a><span>
</span><a name="line-1248"></a><span class="hs-identifier">mkErrTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">ErrMsg</span><span>
</span><a name="line-1249"></a><a name="mkErrTc"><a href="TcRnMonad.html#mkErrTc"><span class="hs-identifier">mkErrTc</span></a></a><span> </span><a name="local-6989586621681325410"><a href="#local-6989586621681325410"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325411"><a href="#local-6989586621681325411"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span>
</span><a name="line-1250"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#mkErrTcM"><span class="hs-identifier hs-var">mkErrTcM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325411"><span class="hs-identifier hs-var">env0</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325410"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1251"></a><span>
</span><a name="line-1252"></a><span class="hs-comment">-- The failWith functions add an error message and cause failure</span><span>
</span><a name="line-1253"></a><span>
</span><a name="line-1254"></a><span class="hs-identifier">failWithTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324859"><span class="hs-identifier hs-type">a</span></a><span>               </span><span class="hs-comment">-- Add an error message and fail</span><span>
</span><a name="line-1255"></a><a name="failWithTc"><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier">failWithTc</span></a></a><span> </span><a name="local-6989586621681325412"><a href="#local-6989586621681325412"><span class="hs-identifier">err_msg</span></a></a><span>
</span><a name="line-1256"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><a href="#local-6989586621681325412"><span class="hs-identifier hs-var">err_msg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-1257"></a><span>
</span><a name="line-1258"></a><span class="hs-identifier">failWithTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324858"><span class="hs-identifier hs-type">a</span></a><span>   </span><span class="hs-comment">-- Add an error message and fail</span><span>
</span><a name="line-1259"></a><a name="failWithTcM"><a href="TcRnMonad.html#failWithTcM"><span class="hs-identifier">failWithTcM</span></a></a><span> </span><a name="local-6989586621681325413"><a href="#local-6989586621681325413"><span class="hs-identifier">local_and_msg</span></a></a><span>
</span><a name="line-1260"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTcM"><span class="hs-identifier hs-var">addErrTcM</span></a><span> </span><a href="#local-6989586621681325413"><span class="hs-identifier hs-var">local_and_msg</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-1261"></a><span>
</span><a name="line-1262"></a><span class="hs-identifier">checkTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Check that the boolean is true</span><span>
</span><a name="line-1263"></a><a name="checkTc"><a href="TcRnMonad.html#checkTc"><span class="hs-identifier">checkTc</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1264"></a><span class="hs-identifier">checkTc</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621681325414"><a href="#local-6989586621681325414"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621681325414"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1265"></a><span>
</span><a name="line-1266"></a><span class="hs-identifier">checkTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1267"></a><a name="checkTcM"><a href="TcRnMonad.html#checkTcM"><span class="hs-identifier">checkTcM</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1268"></a><span class="hs-identifier">checkTcM</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621681325415"><a href="#local-6989586621681325415"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTcM"><span class="hs-identifier hs-var">failWithTcM</span></a><span> </span><a href="#local-6989586621681325415"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1269"></a><span>
</span><a name="line-1270"></a><span class="hs-identifier">failIfTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Check that the boolean is false</span><span>
</span><a name="line-1271"></a><a name="failIfTc"><a href="TcRnMonad.html#failIfTc"><span class="hs-identifier">failIfTc</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1272"></a><span class="hs-identifier">failIfTc</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><a name="local-6989586621681325416"><a href="#local-6989586621681325416"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="#local-6989586621681325416"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1273"></a><span>
</span><a name="line-1274"></a><span class="hs-identifier">failIfTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1275"></a><span>   </span><span class="hs-comment">-- Check that the boolean is false</span><span>
</span><a name="line-1276"></a><a name="failIfTcM"><a href="TcRnMonad.html#failIfTcM"><span class="hs-identifier">failIfTcM</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1277"></a><span class="hs-identifier">failIfTcM</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><a name="local-6989586621681325417"><a href="#local-6989586621681325417"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTcM"><span class="hs-identifier hs-var">failWithTcM</span></a><span> </span><a href="#local-6989586621681325417"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-1278"></a><span>
</span><a name="line-1279"></a><span>
</span><a name="line-1280"></a><span class="hs-comment">--         Warnings have no 'M' variant, nor failure</span><span>
</span><a name="line-1281"></a><span>
</span><a name="line-1282"></a><span class="hs-comment">-- | Display a warning if a condition is met,</span><span>
</span><a name="line-1283"></a><span class="hs-comment">--   and the warning is enabled</span><span>
</span><a name="line-1284"></a><span class="hs-identifier">warnIfFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1285"></a><a name="warnIfFlag"><a href="TcRnMonad.html#warnIfFlag"><span class="hs-identifier">warnIfFlag</span></a></a><span> </span><a name="local-6989586621681325418"><a href="#local-6989586621681325418"><span class="hs-identifier">warn_flag</span></a></a><span> </span><a name="local-6989586621681325419"><a href="#local-6989586621681325419"><span class="hs-identifier">is_bad</span></a></a><span> </span><a name="local-6989586621681325420"><a href="#local-6989586621681325420"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-1286"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325421"><a href="#local-6989586621681325421"><span class="hs-identifier">warn_on</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><a href="#local-6989586621681325418"><span class="hs-identifier hs-var">warn_flag</span></a><span>
</span><a name="line-1287"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325421"><span class="hs-identifier hs-var">warn_on</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681325419"><span class="hs-identifier hs-var">is_bad</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1288"></a><span>         </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621681325418"><span class="hs-identifier hs-var">warn_flag</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325420"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1289"></a><span>
</span><a name="line-1290"></a><span class="hs-comment">-- | Display a warning if a condition is met.</span><span>
</span><a name="line-1291"></a><span class="hs-identifier">warnIf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1292"></a><a name="warnIf"><a href="TcRnMonad.html#warnIf"><span class="hs-identifier">warnIf</span></a></a><span> </span><a name="local-6989586621681325422"><a href="#local-6989586621681325422"><span class="hs-identifier">is_bad</span></a></a><span> </span><a name="local-6989586621681325423"><a href="#local-6989586621681325423"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-1293"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681325422"><span class="hs-identifier hs-var">is_bad</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><a href="#local-6989586621681325423"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span class="hs-comment">-- | Display a warning if a condition is met.</span><span>
</span><a name="line-1296"></a><span class="hs-identifier">warnTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1297"></a><a name="warnTc"><a href="TcRnMonad.html#warnTc"><span class="hs-identifier">warnTc</span></a></a><span> </span><a name="local-6989586621681325424"><a href="#local-6989586621681325424"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681325425"><a href="#local-6989586621681325425"><span class="hs-identifier">warn_if_true</span></a></a><span> </span><a name="local-6989586621681325426"><a href="#local-6989586621681325426"><span class="hs-identifier">warn_msg</span></a></a><span>
</span><a name="line-1298"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681325425"><span class="hs-identifier hs-var">warn_if_true</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><a href="#local-6989586621681325424"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621681325426"><span class="hs-identifier hs-var">warn_msg</span></a><span>
</span><a name="line-1299"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1300"></a><span>
</span><a name="line-1301"></a><span class="hs-comment">-- | Display a warning if a condition is met.</span><span>
</span><a name="line-1302"></a><span class="hs-identifier">warnTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1303"></a><a name="warnTcM"><a href="TcRnMonad.html#warnTcM"><span class="hs-identifier">warnTcM</span></a></a><span> </span><a name="local-6989586621681325427"><a href="#local-6989586621681325427"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681325428"><a href="#local-6989586621681325428"><span class="hs-identifier">warn_if_true</span></a></a><span> </span><a name="local-6989586621681325429"><a href="#local-6989586621681325429"><span class="hs-identifier">warn_msg</span></a></a><span>
</span><a name="line-1304"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681325428"><span class="hs-identifier hs-var">warn_if_true</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addWarnTcM"><span class="hs-identifier hs-var">addWarnTcM</span></a><span> </span><a href="#local-6989586621681325427"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621681325429"><span class="hs-identifier hs-var">warn_msg</span></a><span>
</span><a name="line-1305"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1306"></a><span>
</span><a name="line-1307"></a><span class="hs-comment">-- | Display a warning in the current context.</span><span>
</span><a name="line-1308"></a><span class="hs-identifier">addWarnTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1309"></a><a name="addWarnTc"><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier">addWarnTc</span></a></a><span> </span><a name="local-6989586621681325430"><a href="#local-6989586621681325430"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681325431"><a href="#local-6989586621681325431"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-1310"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325432"><a href="#local-6989586621681325432"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcInitTidyEnv"><span class="hs-identifier hs-var">tcInitTidyEnv</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1311"></a><span>      </span><a href="TcRnMonad.html#addWarnTcM"><span class="hs-identifier hs-var">addWarnTcM</span></a><span> </span><a href="#local-6989586621681325430"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325432"><span class="hs-identifier hs-var">env0</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325431"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1312"></a><span>
</span><a name="line-1313"></a><span class="hs-comment">-- | Display a warning in a given context.</span><span>
</span><a name="line-1314"></a><span class="hs-identifier">addWarnTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TidyEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1315"></a><a name="addWarnTcM"><a href="TcRnMonad.html#addWarnTcM"><span class="hs-identifier">addWarnTcM</span></a></a><span> </span><a name="local-6989586621681325433"><a href="#local-6989586621681325433"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681325434"><a href="#local-6989586621681325434"><span class="hs-identifier">env0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325435"><a href="#local-6989586621681325435"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1316"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325436"><a href="#local-6989586621681325436"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrCtxt"><span class="hs-identifier hs-var">getErrCtxt</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1317"></a><span>        </span><a name="local-6989586621681325437"><a href="#local-6989586621681325437"><span class="hs-identifier">err_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mkErrInfo"><span class="hs-identifier hs-var">mkErrInfo</span></a><span> </span><a href="#local-6989586621681325434"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621681325436"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1318"></a><span>        </span><a href="TcRnMonad.html#add_warn"><span class="hs-identifier hs-var">add_warn</span></a><span> </span><a href="#local-6989586621681325433"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621681325435"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621681325437"><span class="hs-identifier hs-var">err_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1319"></a><span>
</span><a name="line-1320"></a><span class="hs-comment">-- | Display a warning for the current source location.</span><span>
</span><a name="line-1321"></a><span class="hs-identifier">addWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1322"></a><a name="addWarn"><a href="TcRnMonad.html#addWarn"><span class="hs-identifier">addWarn</span></a></a><span> </span><a name="local-6989586621681325438"><a href="#local-6989586621681325438"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681325439"><a href="#local-6989586621681325439"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#add_warn"><span class="hs-identifier hs-var">add_warn</span></a><span> </span><a href="#local-6989586621681325438"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621681325439"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1323"></a><span>
</span><a name="line-1324"></a><span class="hs-comment">-- | Display a warning for a given source location.</span><span>
</span><a name="line-1325"></a><span class="hs-identifier">addWarnAt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1326"></a><a name="addWarnAt"><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier">addWarnAt</span></a></a><span> </span><a name="local-6989586621681325440"><a href="#local-6989586621681325440"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681325441"><a href="#local-6989586621681325441"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325442"><a href="#local-6989586621681325442"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#add_warn_at"><span class="hs-identifier hs-var">add_warn_at</span></a><span> </span><a href="#local-6989586621681325440"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621681325441"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325442"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-1327"></a><span>
</span><a name="line-1328"></a><span class="hs-comment">-- | Display a warning, with an optional flag, for the current source</span><span>
</span><a name="line-1329"></a><span class="hs-comment">-- location.</span><span>
</span><a name="line-1330"></a><span class="hs-identifier">add_warn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1331"></a><a name="add_warn"><a href="TcRnMonad.html#add_warn"><span class="hs-identifier">add_warn</span></a></a><span> </span><a name="local-6989586621681325443"><a href="#local-6989586621681325443"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681325444"><a href="#local-6989586621681325444"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621681325445"><a href="#local-6989586621681325445"><span class="hs-identifier">extra_info</span></a></a><span>
</span><a name="line-1332"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325446"><a href="#local-6989586621681325446"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-1333"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#add_warn_at"><span class="hs-identifier hs-var">add_warn_at</span></a><span> </span><a href="#local-6989586621681325443"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621681325446"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325444"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621681325445"><span class="hs-identifier hs-var">extra_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1334"></a><span>
</span><a name="line-1335"></a><span class="hs-comment">-- | Display a warning, with an optional flag, for a given location.</span><span>
</span><a name="line-1336"></a><span class="hs-identifier">add_warn_at</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarnReason</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1337"></a><a name="add_warn_at"><a href="TcRnMonad.html#add_warn_at"><span class="hs-identifier">add_warn_at</span></a></a><span> </span><a name="local-6989586621681325447"><a href="#local-6989586621681325447"><span class="hs-identifier">reason</span></a></a><span> </span><a name="local-6989586621681325448"><a href="#local-6989586621681325448"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325449"><a href="#local-6989586621681325449"><span class="hs-identifier">msg</span></a></a><span> </span><a name="local-6989586621681325450"><a href="#local-6989586621681325450"><span class="hs-identifier">extra_info</span></a></a><span>
</span><a name="line-1338"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325451"><a href="#local-6989586621681325451"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1339"></a><span>         </span><a name="local-6989586621681325452"><a href="#local-6989586621681325452"><span class="hs-identifier">printer</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getPrintUnqualified"><span class="hs-identifier hs-var">getPrintUnqualified</span></a><span> </span><a href="#local-6989586621681325451"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1340"></a><span>         </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325453"><a href="#local-6989586621681325453"><span class="hs-identifier">warn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkLongWarnMsg</span><span> </span><a href="#local-6989586621681325451"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681325448"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325452"><span class="hs-identifier hs-var">printer</span></a><span>
</span><a name="line-1341"></a><span>                                    </span><a href="#local-6989586621681325449"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="#local-6989586621681325450"><span class="hs-identifier hs-var">extra_info</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1342"></a><span>         </span><a href="TcRnMonad.html#reportWarning"><span class="hs-identifier hs-var">reportWarning</span></a><span> </span><a href="#local-6989586621681325447"><span class="hs-identifier hs-var">reason</span></a><span> </span><a href="#local-6989586621681325453"><span class="hs-identifier hs-var">warn</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1343"></a><span>
</span><a name="line-1344"></a><span>
</span><a name="line-1345"></a><span class="hs-comment">{-
-----------------------------------
        Other helper functions
-}</span><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span class="hs-identifier">add_err_tcm</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-1351"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrCtxt</span><span class="hs-special">]</span><span>
</span><a name="line-1352"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1353"></a><a name="add_err_tcm"><a href="TcRnMonad.html#add_err_tcm"><span class="hs-identifier">add_err_tcm</span></a></a><span> </span><a name="local-6989586621681325454"><a href="#local-6989586621681325454"><span class="hs-identifier">tidy_env</span></a></a><span> </span><a name="local-6989586621681325455"><a href="#local-6989586621681325455"><span class="hs-identifier">err_msg</span></a></a><span> </span><a name="local-6989586621681325456"><a href="#local-6989586621681325456"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325457"><a href="#local-6989586621681325457"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-1354"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325458"><a href="#local-6989586621681325458"><span class="hs-identifier">err_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mkErrInfo"><span class="hs-identifier hs-var">mkErrInfo</span></a><span> </span><a href="#local-6989586621681325454"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621681325457"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1355"></a><span>        </span><a href="TcRnMonad.html#addLongErrAt"><span class="hs-identifier hs-var">addLongErrAt</span></a><span> </span><a href="#local-6989586621681325456"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621681325455"><span class="hs-identifier hs-var">err_msg</span></a><span> </span><a href="#local-6989586621681325458"><span class="hs-identifier hs-var">err_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1356"></a><span>
</span><a name="line-1357"></a><span class="hs-identifier">mkErrInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrCtxt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1358"></a><span class="hs-comment">-- Tidy the error info, trimming excessive contexts</span><span>
</span><a name="line-1359"></a><a name="mkErrInfo"><a href="TcRnMonad.html#mkErrInfo"><span class="hs-identifier">mkErrInfo</span></a></a><span> </span><a name="local-6989586621681325459"><a href="#local-6989586621681325459"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621681325460"><a href="#local-6989586621681325460"><span class="hs-identifier">ctxts</span></a></a><span>
</span><a name="line-1360"></a><span class="hs-comment">--  = do</span><span>
</span><a name="line-1361"></a><span class="hs-comment">--       dbg &lt;- hasPprDebug &lt;$&gt; getDynFlags</span><span>
</span><a name="line-1362"></a><span class="hs-comment">--       if dbg                -- In -dppr-debug style the output</span><span>
</span><a name="line-1363"></a><span class="hs-comment">--          then return empty  -- just becomes too voluminous</span><span>
</span><a name="line-1364"></a><span class="hs-comment">--          else go dbg 0 env ctxts</span><span>
</span><a name="line-1365"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325461"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681325459"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621681325460"><span class="hs-identifier hs-var">ctxts</span></a><span>
</span><a name="line-1366"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1367"></a><span>   </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TidyEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ErrCtxt</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1368"></a><span>   </span><a name="local-6989586621681325461"><a href="#local-6989586621681325461"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1369"></a><span>   </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621681325462"><a href="#local-6989586621681325462"><span class="hs-identifier">dbg</span></a></a><span> </span><a name="local-6989586621681325463"><a href="#local-6989586621681325463"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621681325464"><a href="#local-6989586621681325464"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621681325465"><a href="#local-6989586621681325465"><span class="hs-identifier">is_landmark</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325466"><a href="#local-6989586621681325466"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621681325467"><a href="#local-6989586621681325467"><span class="hs-identifier">ctxts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1370"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681325465"><span class="hs-identifier hs-var">is_landmark</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681325463"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="TcRnMonad.html#mAX_CONTEXTS"><span class="hs-identifier hs-var">mAX_CONTEXTS</span></a><span> </span><span class="hs-comment">-- Too verbose || dbg</span><span>
</span><a name="line-1371"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325468"><a href="#local-6989586621681325468"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325469"><a href="#local-6989586621681325469"><span class="hs-identifier">msg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681325466"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621681325464"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1372"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325470"><a href="#local-6989586621681325470"><span class="hs-identifier">n'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681325465"><span class="hs-identifier hs-var">is_landmark</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681325463"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621681325463"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span>
</span><a name="line-1373"></a><span>          </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325471"><a href="#local-6989586621681325471"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681325461"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681325462"><span class="hs-identifier hs-var">dbg</span></a><span> </span><a href="#local-6989586621681325470"><span class="hs-identifier hs-var">n'</span></a><span> </span><a href="#local-6989586621681325468"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621681325467"><span class="hs-identifier hs-var">ctxts</span></a><span>
</span><a name="line-1374"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325469"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621681325471"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1375"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1376"></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325461"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681325462"><span class="hs-identifier hs-var">dbg</span></a><span> </span><a href="#local-6989586621681325463"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621681325464"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621681325467"><span class="hs-identifier hs-var">ctxts</span></a><span>
</span><a name="line-1377"></a><span>
</span><a name="line-1378"></a><span class="hs-identifier">mAX_CONTEXTS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>     </span><span class="hs-comment">-- No more than this number of non-landmark contexts</span><span>
</span><a name="line-1379"></a><a name="mAX_CONTEXTS"><a href="TcRnMonad.html#mAX_CONTEXTS"><span class="hs-identifier">mAX_CONTEXTS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-1380"></a><span>
</span><a name="line-1381"></a><span class="hs-comment">-- debugTc is useful for monadic debugging code</span><span>
</span><a name="line-1382"></a><span>
</span><a name="line-1383"></a><span class="hs-identifier">debugTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1384"></a><a name="debugTc"><a href="TcRnMonad.html#debugTc"><span class="hs-identifier">debugTc</span></a></a><span> </span><a name="local-6989586621681325472"><a href="#local-6989586621681325472"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-1385"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">debugIsOn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325472"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1386"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1387"></a><span>
</span><a name="line-1388"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
             Type constraints
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1395"></a><span>
</span><a name="line-1396"></a><span class="hs-identifier">addTopEvBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">EvBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324857"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324857"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1397"></a><a name="addTopEvBinds"><a href="TcRnMonad.html#addTopEvBinds"><span class="hs-identifier">addTopEvBinds</span></a></a><span> </span><a name="local-6989586621681325473"><a href="#local-6989586621681325473"><span class="hs-identifier">new_ev_binds</span></a></a><span> </span><a name="local-6989586621681325474"><a href="#local-6989586621681325474"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1398"></a><span>  </span><span class="hs-glyph">=</span><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier hs-var">updGblEnv</span></a><span> </span><a href="#local-6989586621681325475"><span class="hs-identifier hs-var">upd_env</span></a><span> </span><a href="#local-6989586621681325474"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1399"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1400"></a><span>    </span><a name="local-6989586621681325475"><a href="#local-6989586621681325475"><span class="hs-identifier">upd_env</span></a></a><span> </span><a name="local-6989586621681325476"><a href="#local-6989586621681325476"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325476"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_ev_binds</span><span> </span><a href="#local-6989586621681325476"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1401"></a><span>                                               </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325473"><span class="hs-identifier hs-var">new_ev_binds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1402"></a><span>
</span><a name="line-1403"></a><span class="hs-identifier">newTcEvBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span>
</span><a name="line-1404"></a><a name="newTcEvBinds"><a href="TcRnMonad.html#newTcEvBinds"><span class="hs-identifier">newTcEvBinds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325477"><a href="#local-6989586621681325477"><span class="hs-identifier">binds_ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyEvBindMap</span><span>
</span><a name="line-1405"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325478"><a href="#local-6989586621681325478"><span class="hs-identifier">tcvs_ref</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-1406"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325479"><a href="#local-6989586621681325479"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-1407"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;newTcEvBinds&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;unique =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325479"><span class="hs-identifier hs-var">uniq</span></a><span class="hs-special">)</span><span>
</span><a name="line-1408"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBindsVar</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ebv_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325477"><span class="hs-identifier hs-var">binds_ref</span></a><span>
</span><a name="line-1409"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ebv_tcvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325478"><span class="hs-identifier hs-var">tcvs_ref</span></a><span>
</span><a name="line-1410"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ebv_uniq</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325479"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1411"></a><span>
</span><a name="line-1412"></a><span class="hs-comment">-- | Creates an EvBindsVar incapable of holding any bindings. It still</span><span>
</span><a name="line-1413"></a><span class="hs-comment">-- tracks covar usages (see comments on ebv_tcvs in TcEvidence), thus</span><span>
</span><a name="line-1414"></a><span class="hs-comment">-- must be made monadically</span><span>
</span><a name="line-1415"></a><span class="hs-identifier">newNoTcEvBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span>
</span><a name="line-1416"></a><a name="newNoTcEvBinds"><a href="TcRnMonad.html#newNoTcEvBinds"><span class="hs-identifier">newNoTcEvBinds</span></a></a><span>
</span><a name="line-1417"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325482"><a href="#local-6989586621681325482"><span class="hs-identifier">tcvs_ref</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-1418"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325483"><a href="#local-6989586621681325483"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-1419"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;newNoTcEvBinds&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;unique =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325483"><span class="hs-identifier hs-var">uniq</span></a><span class="hs-special">)</span><span>
</span><a name="line-1420"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoEvBindsVar</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ebv_tcvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325482"><span class="hs-identifier hs-var">tcvs_ref</span></a><span>
</span><a name="line-1421"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ebv_uniq</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325483"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1422"></a><span>
</span><a name="line-1423"></a><span class="hs-identifier">cloneEvBindsVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span>
</span><a name="line-1424"></a><span class="hs-comment">-- Clone the refs, so that any binding created when</span><span>
</span><a name="line-1425"></a><span class="hs-comment">-- solving don't pollute the original</span><span>
</span><a name="line-1426"></a><a name="cloneEvBindsVar"><a href="TcRnMonad.html#cloneEvBindsVar"><span class="hs-identifier">cloneEvBindsVar</span></a></a><span> </span><a name="local-6989586621681325484"><a href="#local-6989586621681325484"><span class="hs-identifier">ebv</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBindsVar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1427"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325485"><a href="#local-6989586621681325485"><span class="hs-identifier">binds_ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyEvBindMap</span><span>
</span><a name="line-1428"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325486"><a href="#local-6989586621681325486"><span class="hs-identifier">tcvs_ref</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-1429"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325484"><span class="hs-identifier hs-var">ebv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ebv_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325485"><span class="hs-identifier hs-var">binds_ref</span></a><span>
</span><a name="line-1430"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ebv_tcvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325486"><span class="hs-identifier hs-var">tcvs_ref</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1431"></a><span class="hs-identifier">cloneEvBindsVar</span><span> </span><a name="local-6989586621681325487"><a href="#local-6989586621681325487"><span class="hs-identifier">ebv</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoEvBindsVar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1432"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325488"><a href="#local-6989586621681325488"><span class="hs-identifier">tcvs_ref</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyVarSet</span><span>
</span><a name="line-1433"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325487"><span class="hs-identifier hs-var">ebv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ebv_tcvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325488"><span class="hs-identifier hs-var">tcvs_ref</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1434"></a><span>
</span><a name="line-1435"></a><span class="hs-identifier">getTcEvTyCoVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TyCoVarSet</span><span>
</span><a name="line-1436"></a><a name="getTcEvTyCoVars"><a href="TcRnMonad.html#getTcEvTyCoVars"><span class="hs-identifier">getTcEvTyCoVars</span></a></a><span> </span><a name="local-6989586621681325489"><a href="#local-6989586621681325489"><span class="hs-identifier">ev_binds_var</span></a></a><span>
</span><a name="line-1437"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ebv_tcvs</span><span> </span><a href="#local-6989586621681325489"><span class="hs-identifier hs-var">ev_binds_var</span></a><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span>
</span><a name="line-1439"></a><span class="hs-identifier">getTcEvBindsMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">EvBindMap</span><span>
</span><a name="line-1440"></a><a name="getTcEvBindsMap"><a href="TcRnMonad.html#getTcEvBindsMap"><span class="hs-identifier">getTcEvBindsMap</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBindsVar</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ebv_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325490"><a href="#local-6989586621681325490"><span class="hs-identifier">ev_ref</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1441"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325490"><span class="hs-identifier hs-var">ev_ref</span></a><span>
</span><a name="line-1442"></a><span class="hs-identifier">getTcEvBindsMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoEvBindsVar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1443"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">emptyEvBindMap</span><span>
</span><a name="line-1444"></a><span>
</span><a name="line-1445"></a><span class="hs-identifier">setTcEvBindsMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvBindMap</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1446"></a><a name="setTcEvBindsMap"><a href="TcRnMonad.html#setTcEvBindsMap"><span class="hs-identifier">setTcEvBindsMap</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBindsVar</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ebv_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325491"><a href="#local-6989586621681325491"><span class="hs-identifier">ev_ref</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681325492"><a href="#local-6989586621681325492"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-1447"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325491"><span class="hs-identifier hs-var">ev_ref</span></a><span> </span><a href="#local-6989586621681325492"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-1448"></a><span class="hs-identifier">setTcEvBindsMap</span><span> </span><a name="local-6989586621681325493"><a href="#local-6989586621681325493"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoEvBindsVar</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681325494"><a href="#local-6989586621681325494"><span class="hs-identifier">ev_binds</span></a></a><span>
</span><a name="line-1449"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyEvBindMap</span><span> </span><a href="#local-6989586621681325494"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1450"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1451"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1452"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;setTcEvBindsMap&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325493"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325494"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1453"></a><span>
</span><a name="line-1454"></a><span class="hs-identifier">addTcEvBind</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EvBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1455"></a><span class="hs-comment">-- Add a binding to the TcEvBinds by side effect</span><span>
</span><a name="line-1456"></a><a name="addTcEvBind"><a href="TcRnMonad.html#addTcEvBind"><span class="hs-identifier">addTcEvBind</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBindsVar</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ebv_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325495"><a href="#local-6989586621681325495"><span class="hs-identifier">ev_ref</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ebv_uniq</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325496"><a href="#local-6989586621681325496"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681325497"><a href="#local-6989586621681325497"><span class="hs-identifier">ev_bind</span></a></a><span>
</span><a name="line-1457"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;addTcEvBind&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325496"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1458"></a><span>                                 </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325497"><span class="hs-identifier hs-var">ev_bind</span></a><span>
</span><a name="line-1459"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325498"><a href="#local-6989586621681325498"><span class="hs-identifier">bnds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325495"><span class="hs-identifier hs-var">ev_ref</span></a><span>
</span><a name="line-1460"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325495"><span class="hs-identifier hs-var">ev_ref</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendEvBinds</span><span> </span><a href="#local-6989586621681325498"><span class="hs-identifier hs-var">bnds</span></a><span> </span><a href="#local-6989586621681325497"><span class="hs-identifier hs-var">ev_bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1461"></a><span class="hs-identifier">addTcEvBind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoEvBindsVar</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ebv_uniq</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681325499"><a href="#local-6989586621681325499"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681325500"><a href="#local-6989586621681325500"><span class="hs-identifier">ev_bind</span></a></a><span>
</span><a name="line-1462"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;addTcEvBind CoEvBindsVar&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325500"><span class="hs-identifier hs-var">ev_bind</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325499"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-1463"></a><span>
</span><a name="line-1464"></a><span class="hs-identifier">chooseUniqueOccTc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OccSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OccName</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">OccName</span><span>
</span><a name="line-1465"></a><a name="chooseUniqueOccTc"><a href="TcRnMonad.html#chooseUniqueOccTc"><span class="hs-identifier">chooseUniqueOccTc</span></a></a><span> </span><a name="local-6989586621681325501"><a href="#local-6989586621681325501"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1466"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325502"><a href="#local-6989586621681325502"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1467"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325503"><a href="#local-6989586621681325503"><span class="hs-identifier">dfun_n_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_dfun_n</span><span> </span><a href="#local-6989586621681325502"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1468"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325504"><a href="#local-6989586621681325504"><span class="hs-identifier">set</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325503"><span class="hs-identifier hs-var">dfun_n_var</span></a><span>
</span><a name="line-1469"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325505"><a href="#local-6989586621681325505"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325501"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621681325504"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-1470"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325503"><span class="hs-identifier hs-var">dfun_n_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendOccSet</span><span> </span><a href="#local-6989586621681325504"><span class="hs-identifier hs-var">set</span></a><span> </span><a href="#local-6989586621681325505"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-1471"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325505"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1472"></a><span>
</span><a name="line-1473"></a><span class="hs-identifier">getConstraintVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcRef</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span class="hs-special">)</span><span>
</span><a name="line-1474"></a><a name="getConstraintVar"><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier">getConstraintVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325506"><a href="#local-6989586621681325506"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_lie</span><span> </span><a href="#local-6989586621681325506"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1475"></a><span>
</span><a name="line-1476"></a><span class="hs-identifier">setConstraintVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcRef</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324856"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324856"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1477"></a><a name="setConstraintVar"><a href="TcRnMonad.html#setConstraintVar"><span class="hs-identifier">setConstraintVar</span></a></a><span> </span><a name="local-6989586621681325507"><a href="#local-6989586621681325507"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325508"><a href="#local-6989586621681325508"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325508"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_lie</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325507"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1478"></a><span>
</span><a name="line-1479"></a><span class="hs-identifier">emitStaticConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1480"></a><a name="emitStaticConstraints"><a href="TcRnMonad.html#emitStaticConstraints"><span class="hs-identifier">emitStaticConstraints</span></a></a><span> </span><a name="local-6989586621681325509"><a href="#local-6989586621681325509"><span class="hs-identifier">static_lie</span></a></a><span>
</span><a name="line-1481"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325510"><a href="#local-6989586621681325510"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1482"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_static_wc</span><span> </span><a href="#local-6989586621681325510"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">andWC</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325509"><span class="hs-identifier hs-var">static_lie</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1483"></a><span>
</span><a name="line-1484"></a><span class="hs-identifier">emitConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1485"></a><a name="emitConstraints"><a href="TcRnMonad.html#emitConstraints"><span class="hs-identifier">emitConstraints</span></a></a><span> </span><a name="local-6989586621681325511"><a href="#local-6989586621681325511"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1486"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyWC</span><span> </span><a href="#local-6989586621681325511"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1487"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1488"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1489"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325512"><a href="#local-6989586621681325512"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1490"></a><span>         </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621681325512"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">andWC</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325511"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1491"></a><span>
</span><a name="line-1492"></a><span class="hs-identifier">emitSimple</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1493"></a><a name="emitSimple"><a href="TcRnMonad.html#emitSimple"><span class="hs-identifier">emitSimple</span></a></a><span> </span><a name="local-6989586621681325513"><a href="#local-6989586621681325513"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1494"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325514"><a href="#local-6989586621681325514"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1495"></a><span>         </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621681325514"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">addSimples</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621681325513"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span class="hs-identifier">emitSimples</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Cts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1498"></a><a name="emitSimples"><a href="TcRnMonad.html#emitSimples"><span class="hs-identifier">emitSimples</span></a></a><span> </span><a name="local-6989586621681325515"><a href="#local-6989586621681325515"><span class="hs-identifier">cts</span></a></a><span>
</span><a name="line-1499"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325516"><a href="#local-6989586621681325516"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1500"></a><span>         </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621681325516"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">addSimples</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325515"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1501"></a><span>
</span><a name="line-1502"></a><span class="hs-identifier">emitImplication</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Implication</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1503"></a><a name="emitImplication"><a href="TcRnMonad.html#emitImplication"><span class="hs-identifier">emitImplication</span></a></a><span> </span><a name="local-6989586621681325517"><a href="#local-6989586621681325517"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1504"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325518"><a href="#local-6989586621681325518"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1505"></a><span>         </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621681325518"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">addImplics</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621681325517"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1506"></a><span>
</span><a name="line-1507"></a><span class="hs-identifier">emitImplications</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">Implication</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1508"></a><a name="emitImplications"><a href="TcRnMonad.html#emitImplications"><span class="hs-identifier">emitImplications</span></a></a><span> </span><a name="local-6989586621681325519"><a href="#local-6989586621681325519"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1509"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621681325519"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1510"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325520"><a href="#local-6989586621681325520"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1511"></a><span>         </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621681325520"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">addImplics</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325519"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1512"></a><span>
</span><a name="line-1513"></a><span class="hs-identifier">emitInsoluble</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1514"></a><a name="emitInsoluble"><a href="TcRnMonad.html#emitInsoluble"><span class="hs-identifier">emitInsoluble</span></a></a><span> </span><a name="local-6989586621681325521"><a href="#local-6989586621681325521"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1515"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;emitInsoluble&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325521"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1516"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325522"><a href="#local-6989586621681325522"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span>
</span><a name="line-1517"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621681325522"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">addInsols</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621681325521"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1518"></a><span>
</span><a name="line-1519"></a><span class="hs-identifier">emitInsolubles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Cts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1520"></a><a name="emitInsolubles"><a href="TcRnMonad.html#emitInsolubles"><span class="hs-identifier">emitInsolubles</span></a></a><span> </span><a name="local-6989586621681325523"><a href="#local-6989586621681325523"><span class="hs-identifier">cts</span></a></a><span>
</span><a name="line-1521"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621681325523"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1522"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;emitInsolubles&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325523"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1523"></a><span>                        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325524"><a href="#local-6989586621681325524"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span>
</span><a name="line-1524"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621681325524"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">addInsols</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325523"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1525"></a><span>
</span><a name="line-1526"></a><span class="hs-comment">-- | Throw out any constraints emitted by the thing_inside</span><span>
</span><a name="line-1527"></a><span class="hs-identifier">discardConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324855"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324855"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1528"></a><a name="discardConstraints"><a href="TcRnMonad.html#discardConstraints"><span class="hs-identifier">discardConstraints</span></a></a><span> </span><a name="local-6989586621681325525"><a href="#local-6989586621681325525"><span class="hs-identifier">thing_inside</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="#local-6989586621681325525"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1529"></a><span>
</span><a name="line-1530"></a><span class="hs-identifier">tryCaptureConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324854"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">IOEnvFailure</span><span> </span><a href="#local-6989586621681324854"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span class="hs-special">)</span><span>
</span><a name="line-1531"></a><span class="hs-comment">-- (captureConstraints_maybe m) runs m,</span><span>
</span><a name="line-1532"></a><span class="hs-comment">-- and returns the type constraints it generates</span><span>
</span><a name="line-1533"></a><span class="hs-comment">-- It never throws an exception; instead if thing_inside fails,</span><span>
</span><a name="line-1534"></a><span class="hs-comment">--   it returns Left exn and the /insoluble/ constraints</span><span>
</span><a name="line-1535"></a><a name="tryCaptureConstraints"><a href="TcRnMonad.html#tryCaptureConstraints"><span class="hs-identifier">tryCaptureConstraints</span></a></a><span> </span><a name="local-6989586621681325526"><a href="#local-6989586621681325526"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1536"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325527"><a href="#local-6989586621681325527"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span> </span><span class="hs-identifier hs-var">emptyWC</span><span>
</span><a name="line-1537"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325529"><a href="#local-6989586621681325529"><span class="hs-identifier">mb_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryM</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1538"></a><span>                   </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325528"><a href="#local-6989586621681325528"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325528"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_lie</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325527"><span class="hs-identifier hs-var">lie_var</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1539"></a><span>                   </span><a href="#local-6989586621681325526"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1540"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325530"><a href="#local-6989586621681325530"><span class="hs-identifier">lie</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325527"><span class="hs-identifier hs-var">lie_var</span></a><span>
</span><a name="line-1541"></a><span>
</span><a name="line-1542"></a><span>       </span><span class="hs-comment">-- See Note [Constraints and errors]</span><span>
</span><a name="line-1543"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325531"><a href="#local-6989586621681325531"><span class="hs-identifier">lie_to_keep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325529"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1544"></a><span>                             </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">insolublesOnly</span><span> </span><a href="#local-6989586621681325530"><span class="hs-identifier hs-var">lie</span></a><span>
</span><a name="line-1545"></a><span>                             </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325530"><span class="hs-identifier hs-var">lie</span></a><span>
</span><a name="line-1546"></a><span>
</span><a name="line-1547"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325529"><span class="hs-identifier hs-var">mb_res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325531"><span class="hs-identifier hs-var">lie_to_keep</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1548"></a><span>
</span><a name="line-1549"></a><span class="hs-identifier">captureConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324853"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324853"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span class="hs-special">)</span><span>
</span><a name="line-1550"></a><span class="hs-comment">-- (captureConstraints m) runs m, and returns the type constraints it generates</span><span>
</span><a name="line-1551"></a><a name="captureConstraints"><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier">captureConstraints</span></a></a><span> </span><a name="local-6989586621681325532"><a href="#local-6989586621681325532"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1552"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325533"><a href="#local-6989586621681325533"><span class="hs-identifier">mb_res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325534"><a href="#local-6989586621681325534"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tryCaptureConstraints"><span class="hs-identifier hs-var">tryCaptureConstraints</span></a><span> </span><a href="#local-6989586621681325532"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1553"></a><span>
</span><a name="line-1554"></a><span>            </span><span class="hs-comment">-- See Note [Constraints and errors]</span><span>
</span><a name="line-1555"></a><span>            </span><span class="hs-comment">-- If the thing_inside threw an exception, emit the insoluble</span><span>
</span><a name="line-1556"></a><span>            </span><span class="hs-comment">-- constraints only (returned by tryCaptureConstraints)</span><span>
</span><a name="line-1557"></a><span>            </span><span class="hs-comment">-- so that they are not lost</span><span>
</span><a name="line-1558"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325533"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1559"></a><span>           </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#emitConstraints"><span class="hs-identifier hs-var">emitConstraints</span></a><span> </span><a href="#local-6989586621681325534"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">failM</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1560"></a><span>           </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681325535"><a href="#local-6989586621681325535"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325535"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325534"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1561"></a><span>
</span><a name="line-1562"></a><span class="hs-comment">-- | The name says it all. The returned TcLevel is the *inner* TcLevel.</span><span>
</span><a name="line-1563"></a><span class="hs-identifier">pushLevelAndCaptureConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324852"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcLevel</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681324852"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1564"></a><a name="pushLevelAndCaptureConstraints"><a href="TcRnMonad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier">pushLevelAndCaptureConstraints</span></a></a><span> </span><a name="local-6989586621681325536"><a href="#local-6989586621681325536"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1565"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325537"><a href="#local-6989586621681325537"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1566"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325538"><a href="#local-6989586621681325538"><span class="hs-identifier">tclvl'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pushTcLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_tclvl</span><span> </span><a href="#local-6989586621681325537"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1567"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;pushLevelAndCaptureConstraints {&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325538"><span class="hs-identifier hs-var">tclvl'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1568"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325539"><a href="#local-6989586621681325539"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325540"><a href="#local-6989586621681325540"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325537"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_tclvl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325538"><span class="hs-identifier hs-var">tclvl'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1569"></a><span>                       </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="#local-6989586621681325536"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1570"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;pushLevelAndCaptureConstraints }&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325538"><span class="hs-identifier hs-var">tclvl'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1571"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325538"><span class="hs-identifier hs-var">tclvl'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325540"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325539"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span class="hs-identifier">pushTcLevelM_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324851"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324851"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1574"></a><a name="pushTcLevelM_"><a href="TcRnMonad.html#pushTcLevelM_"><span class="hs-identifier">pushTcLevelM_</span></a></a><span> </span><a name="local-6989586621681325541"><a href="#local-6989586621681325541"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325542"><a href="#local-6989586621681325542"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325542"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_tclvl</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pushTcLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_tclvl</span><span> </span><a href="#local-6989586621681325542"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325541"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1575"></a><span>
</span><a name="line-1576"></a><span class="hs-identifier">pushTcLevelM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324850"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcLevel</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681324850"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1577"></a><span class="hs-comment">-- See Note [TcLevel assignment] in TcType</span><span>
</span><a name="line-1578"></a><a name="pushTcLevelM"><a href="TcRnMonad.html#pushTcLevelM"><span class="hs-identifier">pushTcLevelM</span></a></a><span> </span><a name="local-6989586621681325543"><a href="#local-6989586621681325543"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1579"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325544"><a href="#local-6989586621681325544"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1580"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325545"><a href="#local-6989586621681325545"><span class="hs-identifier">tclvl'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pushTcLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_tclvl</span><span> </span><a href="#local-6989586621681325544"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1581"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325546"><a href="#local-6989586621681325546"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325544"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_tclvl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325545"><span class="hs-identifier hs-var">tclvl'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1582"></a><span>                          </span><a href="#local-6989586621681325543"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1583"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325545"><span class="hs-identifier hs-var">tclvl'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325546"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1584"></a><span>
</span><a name="line-1585"></a><span class="hs-comment">-- Returns pushed TcLevel</span><span>
</span><a name="line-1586"></a><span class="hs-identifier">pushTcLevelsM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324849"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681324849"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcLevel</span><span class="hs-special">)</span><span>
</span><a name="line-1587"></a><a name="pushTcLevelsM"><a href="TcRnMonad.html#pushTcLevelsM"><span class="hs-identifier">pushTcLevelsM</span></a></a><span> </span><a name="local-6989586621681325547"><a href="#local-6989586621681325547"><span class="hs-identifier">num_levels</span></a></a><span> </span><a name="local-6989586621681325548"><a href="#local-6989586621681325548"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1588"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325549"><a href="#local-6989586621681325549"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1589"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325550"><a href="#local-6989586621681325550"><span class="hs-identifier">tclvl'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nTimes</span><span> </span><a href="#local-6989586621681325547"><span class="hs-identifier hs-var">num_levels</span></a><span> </span><span class="hs-identifier hs-var">pushTcLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_tclvl</span><span> </span><a href="#local-6989586621681325549"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1590"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325551"><a href="#local-6989586621681325551"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325549"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_tclvl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325550"><span class="hs-identifier hs-var">tclvl'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1591"></a><span>                </span><a href="#local-6989586621681325548"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1592"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325551"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325550"><span class="hs-identifier hs-var">tclvl'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1593"></a><span>
</span><a name="line-1594"></a><span class="hs-identifier">getTcLevel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcLevel</span><span>
</span><a name="line-1595"></a><a name="getTcLevel"><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier">getTcLevel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325552"><a href="#local-6989586621681325552"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1596"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_tclvl</span><span> </span><a href="#local-6989586621681325552"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1597"></a><span>
</span><a name="line-1598"></a><span class="hs-identifier">setTcLevel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcLevel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324848"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324848"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1599"></a><a name="setTcLevel"><a href="TcRnMonad.html#setTcLevel"><span class="hs-identifier">setTcLevel</span></a></a><span> </span><a name="local-6989586621681325553"><a href="#local-6989586621681325553"><span class="hs-identifier">tclvl</span></a></a><span> </span><a name="local-6989586621681325554"><a href="#local-6989586621681325554"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1600"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325555"><a href="#local-6989586621681325555"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325555"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_tclvl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325553"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325554"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1601"></a><span>
</span><a name="line-1602"></a><span class="hs-identifier">isTouchableTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1603"></a><a name="isTouchableTcM"><a href="TcRnMonad.html#isTouchableTcM"><span class="hs-identifier">isTouchableTcM</span></a></a><span> </span><a name="local-6989586621681325556"><a href="#local-6989586621681325556"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1604"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325557"><a href="#local-6989586621681325557"><span class="hs-identifier">lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-1605"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTouchableMetaTyVar</span><span> </span><a href="#local-6989586621681325557"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621681325556"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1606"></a><span>
</span><a name="line-1607"></a><span class="hs-identifier">getLclTypeEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcTypeEnv</span><span>
</span><a name="line-1608"></a><a name="getLclTypeEnv"><a href="TcRnMonad.html#getLclTypeEnv"><span class="hs-identifier">getLclTypeEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325558"><a href="#local-6989586621681325558"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621681325558"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1609"></a><span>
</span><a name="line-1610"></a><span class="hs-identifier">setLclTypeEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324847"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324847"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1611"></a><span class="hs-comment">-- Set the local type envt, but do *not* disturb other fields,</span><span>
</span><a name="line-1612"></a><span class="hs-comment">-- notably the lie_var</span><span>
</span><a name="line-1613"></a><a name="setLclTypeEnv"><a href="TcRnMonad.html#setLclTypeEnv"><span class="hs-identifier">setLclTypeEnv</span></a></a><span> </span><a name="local-6989586621681325559"><a href="#local-6989586621681325559"><span class="hs-identifier">lcl_env</span></a></a><span> </span><a name="local-6989586621681325560"><a href="#local-6989586621681325560"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1614"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><a href="#local-6989586621681325561"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621681325560"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1615"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1616"></a><span>    </span><a name="local-6989586621681325561"><a href="#local-6989586621681325561"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621681325562"><a href="#local-6989586621681325562"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325562"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621681325559"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-1617"></a><span>                    </span><span class="hs-identifier">tcl_tyvars</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcl_tyvars</span><span> </span><a href="#local-6989586621681325559"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1618"></a><span>
</span><a name="line-1619"></a><span class="hs-identifier">traceTcConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1620"></a><a name="traceTcConstraints"><a href="TcRnMonad.html#traceTcConstraints"><span class="hs-identifier">traceTcConstraints</span></a></a><span> </span><a name="local-6989586621681325563"><a href="#local-6989586621681325563"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-1621"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325564"><a href="#local-6989586621681325564"><span class="hs-identifier">lie_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getConstraintVar"><span class="hs-identifier hs-var">getConstraintVar</span></a><span>
</span><a name="line-1622"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325565"><a href="#local-6989586621681325565"><span class="hs-identifier">lie</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325564"><span class="hs-identifier hs-var">lie_var</span></a><span>
</span><a name="line-1623"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_tc_trace</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1624"></a><span>         </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325563"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;: LIE:&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325565"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">)</span><span>
</span><a name="line-1625"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1626"></a><span>
</span><a name="line-1627"></a><span class="hs-identifier">emitWildCardHoleConstraints</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1628"></a><a name="emitWildCardHoleConstraints"><a href="TcRnMonad.html#emitWildCardHoleConstraints"><span class="hs-identifier">emitWildCardHoleConstraints</span></a></a><span> </span><a name="local-6989586621681325566"><a href="#local-6989586621681325566"><span class="hs-identifier">wcs</span></a></a><span>
</span><a name="line-1629"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325585"><a href="#local-6989586621681325585"><span class="hs-identifier">ct_loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getCtLocM"><span class="hs-identifier hs-var">getCtLocM</span></a><span> </span><span class="hs-identifier hs-var">HoleOrigin</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1630"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitInsolubles"><span class="hs-identifier hs-var">emitInsolubles</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1631"></a><span>         </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325567"><span class="hs-identifier hs-var">do_one</span></a><span> </span><a href="#local-6989586621681325585"><span class="hs-identifier hs-var">ct_loc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325566"><span class="hs-identifier hs-var">wcs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1632"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1633"></a><span>    </span><span class="hs-identifier">do_one</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-1634"></a><span>    </span><a name="local-6989586621681325567"><a href="#local-6989586621681325567"><span class="hs-identifier">do_one</span></a></a><span> </span><a name="local-6989586621681325568"><a href="#local-6989586621681325568"><span class="hs-identifier">ct_loc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681325569"><a href="#local-6989586621681325569"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325570"><a href="#local-6989586621681325570"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1635"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CHoleCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CtDerived</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621681325570"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1636"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325572"><span class="hs-identifier hs-var">ct_loc'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1637"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_hole</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TypeHole</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">occName</span><span> </span><a href="#local-6989586621681325569"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1638"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-1639"></a><span>         </span><a name="local-6989586621681325571"><a href="#local-6989586621681325571"><span class="hs-identifier">real_span</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><a href="#local-6989586621681325569"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1640"></a><span>                           </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621681325573"><a href="#local-6989586621681325573"><span class="hs-identifier">span</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325573"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-1641"></a><span>                           </span><span class="hs-identifier hs-var">UnhelpfulSpan</span><span> </span><a name="local-6989586621681325574"><a href="#local-6989586621681325574"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;emitWildCardHoleConstraints&quot;</span><span>
</span><a name="line-1642"></a><span>                                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325569"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ftext</span><span> </span><a href="#local-6989586621681325574"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1643"></a><span>               </span><span class="hs-comment">-- Wildcards are defined locally, and so have RealSrcSpans</span><span>
</span><a name="line-1644"></a><span>         </span><a name="local-6989586621681325572"><a href="#local-6989586621681325572"><span class="hs-identifier">ct_loc'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">setCtLocSpan</span><span> </span><a href="#local-6989586621681325568"><span class="hs-identifier hs-var">ct_loc</span></a><span> </span><a href="#local-6989586621681325571"><span class="hs-identifier hs-var">real_span</span></a><span>
</span><a name="line-1645"></a><span>
</span><a name="line-1646"></a><span class="hs-comment">{- Note [Constraints and errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (Trac #12124):

  foo :: Maybe Int
  foo = return (case Left 3 of
                  Left -&gt; 1  -- Hard error here!
                  _    -&gt; 0)

The call to 'return' will generate a (Monad m) wanted constraint; but
then there'll be &quot;hard error&quot; (i.e. an exception in the TcM monad), from
the unsaturated Left constructor pattern.

We'll recover in tcPolyBinds, using recoverM.  But then the final
tcSimplifyTop will see that (Monad m) constraint, with 'm' utterly
un-filled-in, and will emit a misleading error message.

The underlying problem is that an exception interrupts the constraint
gathering process. Bottom line: if we have an exception, it's best
simply to discard any gathered constraints.  Hence in 'try_m' we
capture the constraints in a fresh variable, and only emit them into
the surrounding context if we exit normally.  If an exception is
raised, simply discard the collected constraints... we have a hard
error to report.  So this capture-the-emit dance isn't as stupid as it
looks :-).

However suppose we throw an exception inside an invocation of
captureConstraints, and discard all the constraints. Some of those
constraints might be &quot;variable out of scope&quot; Hole constraints, and that
might have been the actual original cause of the exception!  For
example (Trac #12529):
   f = p @ Int
Here 'p' is out of scope, so we get an insolube Hole constraint. But
the visible type application fails in the monad (thows an exception).
We must not discard the out-of-scope error.

So we /retain the insoluble constraints/ if there is an exception.
Hence:
  - insolublesOnly in tryCaptureConstraints
  - emitConstraints in the Left case of captureConstraints

Hover note that fresly-generated constraints like (Int ~ Bool), or
((a -&gt; b) ~ Int) are all CNonCanonical, and hence won't be flagged as
insoluble.  The constraint solver does that.  So they'll be discarded.
That's probably ok; but see th/5358 as a not-so-good example:
   t1 :: Int
   t1 x = x   -- Manifestly wrong

   foo = $(...raises exception...)
We report the exception, but not the bug in t1.  Oh well.  Possible
solution: make TcUnify.uType spot manifestly-insoluble constraints.


************************************************************************
*                                                                      *
             Template Haskell context
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1705"></a><span>
</span><a name="line-1706"></a><span class="hs-identifier">recordThUse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1707"></a><a name="recordThUse"><a href="TcRnMonad.html#recordThUse"><span class="hs-identifier">recordThUse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325586"><a href="#local-6989586621681325586"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_used</span><span> </span><a href="#local-6989586621681325586"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1708"></a><span>
</span><a name="line-1709"></a><span class="hs-identifier">recordThSpliceUse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1710"></a><a name="recordThSpliceUse"><a href="TcRnMonad.html#recordThSpliceUse"><span class="hs-identifier">recordThSpliceUse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325587"><a href="#local-6989586621681325587"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_splice_used</span><span> </span><a href="#local-6989586621681325587"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1711"></a><span>
</span><a name="line-1712"></a><span class="hs-comment">-- | When generating an out-of-scope error message for a variable matching a</span><span>
</span><a name="line-1713"></a><span class="hs-comment">-- binding in a later inter-splice group, the typechecker uses the splice</span><span>
</span><a name="line-1714"></a><span class="hs-comment">-- locations to provide details in the message about the scope of that binding.</span><span>
</span><a name="line-1715"></a><span class="hs-identifier">recordTopLevelSpliceLoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1716"></a><a name="recordTopLevelSpliceLoc"><a href="TcRnMonad.html#recordTopLevelSpliceLoc"><span class="hs-identifier">recordTopLevelSpliceLoc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621681325588"><a href="#local-6989586621681325588"><span class="hs-identifier">real_loc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1717"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325589"><a href="#local-6989586621681325589"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1718"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325590"><a href="#local-6989586621681325590"><span class="hs-identifier">locs_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_th_top_level_locs</span><span> </span><a href="#local-6989586621681325589"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1719"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325591"><a href="#local-6989586621681325591"><span class="hs-identifier">locs0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325590"><span class="hs-identifier hs-var">locs_var</span></a><span>
</span><a name="line-1720"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325590"><span class="hs-identifier hs-var">locs_var</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.insert</span><span> </span><a href="#local-6989586621681325588"><span class="hs-identifier hs-var">real_loc</span></a><span> </span><a href="#local-6989586621681325591"><span class="hs-identifier hs-var">locs0</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1721"></a><span class="hs-identifier">recordTopLevelSpliceLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">UnhelpfulSpan</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1722"></a><span>
</span><a name="line-1723"></a><span class="hs-identifier">getTopLevelSpliceLocs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><span class="hs-identifier hs-type">RealSrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-1724"></a><a name="getTopLevelSpliceLocs"><a href="TcRnMonad.html#getTopLevelSpliceLocs"><span class="hs-identifier">getTopLevelSpliceLocs</span></a></a><span>
</span><a name="line-1725"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325592"><a href="#local-6989586621681325592"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1726"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_th_top_level_locs</span><span> </span><a href="#local-6989586621681325592"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1727"></a><span>
</span><a name="line-1728"></a><span class="hs-identifier">keepAlive</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Record the name in the keep-alive set</span><span>
</span><a name="line-1729"></a><a name="keepAlive"><a href="TcRnMonad.html#keepAlive"><span class="hs-identifier">keepAlive</span></a></a><span> </span><a name="local-6989586621681325593"><a href="#local-6989586621681325593"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1730"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325594"><a href="#local-6989586621681325594"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1731"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;keep alive&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681325593"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1732"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_keep</span><span> </span><a href="#local-6989586621681325594"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681325593"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1733"></a><span>
</span><a name="line-1734"></a><span class="hs-identifier">getStage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">ThStage</span><span>
</span><a name="line-1735"></a><a name="getStage"><a href="TcRnMonad.html#getStage"><span class="hs-identifier">getStage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325595"><a href="#local-6989586621681325595"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_th_ctxt</span><span> </span><a href="#local-6989586621681325595"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1736"></a><span>
</span><a name="line-1737"></a><span class="hs-identifier">getStageAndBindLevel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TopLevelFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ThLevel</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ThStage</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1738"></a><a name="getStageAndBindLevel"><a href="TcRnMonad.html#getStageAndBindLevel"><span class="hs-identifier">getStageAndBindLevel</span></a></a><span> </span><a name="local-6989586621681325596"><a href="#local-6989586621681325596"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1739"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325597"><a href="#local-6989586621681325597"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span>
</span><a name="line-1740"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_th_bndrs</span><span> </span><a href="#local-6989586621681325597"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325596"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1741"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1742"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325598"><a href="#local-6989586621681325598"><span class="hs-identifier">top_lvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325599"><a href="#local-6989586621681325599"><span class="hs-identifier">bind_lvl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325598"><span class="hs-identifier hs-var">top_lvl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325599"><span class="hs-identifier hs-var">bind_lvl</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcl_th_ctxt</span><span> </span><a href="#local-6989586621681325597"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1743"></a><span>
</span><a name="line-1744"></a><span class="hs-identifier">setStage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThStage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621681324846"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324846"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1745"></a><a name="setStage"><a href="TcRnMonad.html#setStage"><span class="hs-identifier">setStage</span></a></a><span> </span><a name="local-6989586621681325600"><a href="#local-6989586621681325600"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621681325601"><a href="#local-6989586621681325601"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325601"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcl_th_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325600"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1746"></a><span>
</span><a name="line-1747"></a><span class="hs-comment">-- | Adds the given modFinalizers to the global environment and set them to use</span><span>
</span><a name="line-1748"></a><span class="hs-comment">-- the current local environment.</span><span>
</span><a name="line-1749"></a><span class="hs-identifier">addModFinalizersWithLclEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThModFinalizers</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1750"></a><a name="addModFinalizersWithLclEnv"><a href="TcRnMonad.html#addModFinalizersWithLclEnv"><span class="hs-identifier">addModFinalizersWithLclEnv</span></a></a><span> </span><a name="local-6989586621681325602"><a href="#local-6989586621681325602"><span class="hs-identifier">mod_finalizers</span></a></a><span>
</span><a name="line-1751"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681325603"><a href="#local-6989586621681325603"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1752"></a><span>       </span><a name="local-6989586621681325604"><a href="#local-6989586621681325604"><span class="hs-identifier">th_modfinalizers_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_modfinalizers</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1753"></a><span>       </span><a href="TcRnMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span> </span><a href="#local-6989586621681325604"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681325605"><a href="#local-6989586621681325605"><span class="hs-identifier">fins</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1754"></a><span>         </span><span class="hs-special">(</span><a href="#local-6989586621681325603"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325602"><span class="hs-identifier hs-var">mod_finalizers</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681325605"><span class="hs-identifier hs-var">fins</span></a><span>
</span><a name="line-1755"></a><span>
</span><a name="line-1756"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
             Safe Haskell context
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1763"></a><span>
</span><a name="line-1764"></a><span class="hs-comment">-- | Mark that safe inference has failed</span><span>
</span><a name="line-1765"></a><span class="hs-comment">-- See Note [Safe Haskell Overlapping Instances Implementation]</span><span>
</span><a name="line-1766"></a><span class="hs-comment">-- although this is used for more than just that failure case.</span><span>
</span><a name="line-1767"></a><span class="hs-identifier">recordUnsafeInfer</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningMessages</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1768"></a><a name="recordUnsafeInfer"><a href="TcRnMonad.html#recordUnsafeInfer"><span class="hs-identifier">recordUnsafeInfer</span></a></a><span> </span><a name="local-6989586621681325606"><a href="#local-6989586621681325606"><span class="hs-identifier">warns</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1769"></a><span>    </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681325607"><a href="#local-6989586621681325607"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_safeInfer</span><span> </span><a href="#local-6989586621681325607"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325606"><span class="hs-identifier hs-var">warns</span></a><span class="hs-special">)</span><span>
</span><a name="line-1770"></a><span>
</span><a name="line-1771"></a><span class="hs-comment">-- | Figure out the final correct safe haskell mode</span><span>
</span><a name="line-1772"></a><span class="hs-identifier">finalSafeMode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">SafeHaskellMode</span><span>
</span><a name="line-1773"></a><a name="finalSafeMode"><a href="TcRnMonad.html#finalSafeMode"><span class="hs-identifier">finalSafeMode</span></a></a><span> </span><a name="local-6989586621681325608"><a href="#local-6989586621681325608"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681325609"><a href="#local-6989586621681325609"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1774"></a><span>    </span><a name="local-6989586621681325610"><a href="#local-6989586621681325610"><span class="hs-identifier">safeInf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_safeInfer</span><span> </span><a href="#local-6989586621681325609"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1775"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">safeHaskell</span><span> </span><a href="#local-6989586621681325608"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1776"></a><span>        </span><span class="hs-identifier hs-var">Sf_None</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">safeInferOn</span><span> </span><a href="#local-6989586621681325608"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681325610"><span class="hs-identifier hs-var">safeInf</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Sf_Safe</span><span>
</span><a name="line-1777"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Sf_None</span><span>
</span><a name="line-1778"></a><span>        </span><a name="local-6989586621681325611"><a href="#local-6989586621681325611"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325611"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1779"></a><span>
</span><a name="line-1780"></a><span class="hs-comment">-- | Switch instances to safe instances if we're in Safe mode.</span><span>
</span><a name="line-1781"></a><span class="hs-identifier">fixSafeInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SafeHaskellMode</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span>
</span><a name="line-1782"></a><a name="fixSafeInstances"><a href="TcRnMonad.html#fixSafeInstances"><span class="hs-identifier">fixSafeInstances</span></a></a><span> </span><a name="local-6989586621681325612"><a href="#local-6989586621681325612"><span class="hs-identifier">sfMode</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681325612"><span class="hs-identifier hs-var">sfMode</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">Sf_Safe</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-1783"></a><span class="hs-identifier">fixSafeInstances</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681325613"><span class="hs-identifier hs-var">fixSafe</span></a><span>
</span><a name="line-1784"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681325613"><a href="#local-6989586621681325613"><span class="hs-identifier">fixSafe</span></a></a><span> </span><a name="local-6989586621681325614"><a href="#local-6989586621681325614"><span class="hs-identifier">inst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325615"><a href="#local-6989586621681325615"><span class="hs-identifier">new_flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_flag</span><span> </span><a href="#local-6989586621681325614"><span class="hs-identifier hs-var">inst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">isSafeOverlap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1785"></a><span>                       </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621681325614"><span class="hs-identifier hs-var">inst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">is_flag</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325615"><span class="hs-identifier hs-var">new_flag</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1786"></a><span>
</span><a name="line-1787"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
             Stuff for the renamer's local env
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1794"></a><span>
</span><a name="line-1795"></a><span class="hs-identifier">getLocalRdrEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><span class="hs-identifier hs-type">LocalRdrEnv</span><span>
</span><a name="line-1796"></a><a name="getLocalRdrEnv"><a href="TcRnMonad.html#getLocalRdrEnv"><span class="hs-identifier">getLocalRdrEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325616"><a href="#local-6989586621681325616"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_rdr</span><span> </span><a href="#local-6989586621681325616"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1797"></a><span>
</span><a name="line-1798"></a><span class="hs-identifier">setLocalRdrEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LocalRdrEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><a href="#local-6989586621681324845"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RnM</span><span> </span><a href="#local-6989586621681324845"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1799"></a><a name="setLocalRdrEnv"><a href="TcRnMonad.html#setLocalRdrEnv"><span class="hs-identifier">setLocalRdrEnv</span></a></a><span> </span><a name="local-6989586621681325617"><a href="#local-6989586621681325617"><span class="hs-identifier">rdr_env</span></a></a><span> </span><a name="local-6989586621681325618"><a href="#local-6989586621681325618"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1800"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325619"><a href="#local-6989586621681325619"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325619"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">tcl_rdr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325617"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325618"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1801"></a><span>
</span><a name="line-1802"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
             Stuff for interface decls
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1809"></a><span>
</span><a name="line-1810"></a><span class="hs-identifier">mkIfLclEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfLclEnv</span><span>
</span><a name="line-1811"></a><a name="mkIfLclEnv"><a href="TcRnMonad.html#mkIfLclEnv"><span class="hs-identifier">mkIfLclEnv</span></a></a><span> </span><a name="local-6989586621681325620"><a href="#local-6989586621681325620"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681325621"><a href="#local-6989586621681325621"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621681325622"><a href="#local-6989586621681325622"><span class="hs-identifier">boot</span></a></a><span>
</span><a name="line-1812"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfLclEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">if_mod</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325620"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-1813"></a><span>                                </span><span class="hs-identifier">if_loc</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325621"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">,</span><span>
</span><a name="line-1814"></a><span>                                </span><span class="hs-identifier">if_boot</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325622"><span class="hs-identifier hs-var">boot</span></a><span class="hs-special">,</span><span>
</span><a name="line-1815"></a><span>                                </span><span class="hs-identifier">if_nsubst</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-1816"></a><span>                                </span><span class="hs-identifier">if_implicits_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-1817"></a><span>                                </span><span class="hs-identifier">if_tv_env</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFsEnv</span><span class="hs-special">,</span><span>
</span><a name="line-1818"></a><span>                                </span><span class="hs-identifier">if_id_env</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyFsEnv</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1819"></a><span>
</span><a name="line-1820"></a><span class="hs-comment">-- | Run an 'IfG' (top-level interface monad) computation inside an existing</span><span>
</span><a name="line-1821"></a><span class="hs-comment">-- 'TcRn' (typecheck-renaming monad) computation by initializing an 'IfGblEnv'</span><span>
</span><a name="line-1822"></a><span class="hs-comment">-- based on 'TcGblEnv'.</span><span>
</span><a name="line-1823"></a><span class="hs-identifier">initIfaceTcRn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="#local-6989586621681324844"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621681324844"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1824"></a><a name="initIfaceTcRn"><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier">initIfaceTcRn</span></a></a><span> </span><a name="local-6989586621681325624"><a href="#local-6989586621681325624"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1825"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325625"><a href="#local-6989586621681325625"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1826"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325626"><a href="#local-6989586621681325626"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1827"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681325627"><a href="#local-6989586621681325627"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_semantic_mod</span><span> </span><a href="#local-6989586621681325625"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1828"></a><span>              </span><span class="hs-comment">-- When we are instantiating a signature, we DEFINITELY</span><span>
</span><a name="line-1829"></a><span>              </span><span class="hs-comment">-- do not want to knot tie.</span><span>
</span><a name="line-1830"></a><span>              </span><a name="local-6989586621681325628"><a href="#local-6989586621681325628"><span class="hs-identifier">is_instantiate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitIdIsDefinite</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisPackage</span><span> </span><a href="#local-6989586621681325626"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1831"></a><span>                               </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">thisUnitIdInsts</span><span> </span><a href="#local-6989586621681325626"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1832"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325629"><a href="#local-6989586621681325629"><span class="hs-identifier">if_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfGblEnv</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1833"></a><span>                            </span><span class="hs-identifier">if_doc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;initIfaceTcRn&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1834"></a><span>                            </span><span class="hs-identifier">if_rec_types</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1835"></a><span>                                </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681325628"><span class="hs-identifier hs-var">is_instantiate</span></a><span>
</span><a name="line-1836"></a><span>                                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1837"></a><span>                                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325627"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681325630"><span class="hs-identifier hs-var">get_type_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1838"></a><span>                         </span><span class="hs-special">}</span><span>
</span><a name="line-1839"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325630"><a href="#local-6989586621681325630"><span class="hs-identifier">get_type_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_type_env_var</span><span> </span><a href="#local-6989586621681325625"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1840"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325629"><span class="hs-identifier hs-var">if_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325624"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1841"></a><span>
</span><a name="line-1842"></a><span class="hs-comment">-- Used when sucking in a ModIface into a ModDetails to put in</span><span>
</span><a name="line-1843"></a><span class="hs-comment">-- the HPT.  Notably, unlike initIfaceCheck, this does NOT use</span><span>
</span><a name="line-1844"></a><span class="hs-comment">-- hsc_type_env_var (since we're not actually going to typecheck,</span><span>
</span><a name="line-1845"></a><span class="hs-comment">-- so this variable will never get updated!)</span><span>
</span><a name="line-1846"></a><span class="hs-identifier">initIfaceLoad</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="#local-6989586621681324843"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681324843"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1847"></a><a name="initIfaceLoad"><a href="TcRnMonad.html#initIfaceLoad"><span class="hs-identifier">initIfaceLoad</span></a></a><span> </span><a name="local-6989586621681325632"><a href="#local-6989586621681325632"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681325633"><a href="#local-6989586621681325633"><span class="hs-identifier">do_this</span></a></a><span>
</span><a name="line-1848"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325634"><a href="#local-6989586621681325634"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfGblEnv</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1849"></a><span>                        </span><span class="hs-identifier">if_doc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;initIfaceLoad&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1850"></a><span>                        </span><span class="hs-identifier">if_rec_types</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1851"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-1852"></a><span>      </span><a href="TcRnMonad.html#initTcRnIf"><span class="hs-identifier hs-var">initTcRnIf</span></a><span> </span><span class="hs-char">'i'</span><span> </span><a href="#local-6989586621681325632"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681325634"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325633"><span class="hs-identifier hs-var">do_this</span></a><span>
</span><a name="line-1853"></a><span>
</span><a name="line-1854"></a><span class="hs-identifier">initIfaceCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfG</span><span> </span><a href="#local-6989586621681324842"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681324842"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1855"></a><span class="hs-comment">-- Used when checking the up-to-date-ness of the old Iface</span><span>
</span><a name="line-1856"></a><span class="hs-comment">-- Initialise the environment with no useful info at all</span><span>
</span><a name="line-1857"></a><a name="initIfaceCheck"><a href="TcRnMonad.html#initIfaceCheck"><span class="hs-identifier">initIfaceCheck</span></a></a><span> </span><a name="local-6989586621681325635"><a href="#local-6989586621681325635"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681325636"><a href="#local-6989586621681325636"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621681325637"><a href="#local-6989586621681325637"><span class="hs-identifier">do_this</span></a></a><span>
</span><a name="line-1858"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325638"><a href="#local-6989586621681325638"><span class="hs-identifier">rec_types</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">hsc_type_env_var</span><span> </span><a href="#local-6989586621681325636"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1859"></a><span>                         </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325640"><a href="#local-6989586621681325640"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><a name="local-6989586621681325641"><a href="#local-6989586621681325641"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681325640"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325641"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-1860"></a><span>                         </span><span class="hs-identifier hs-var">Nothing</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1861"></a><span>          </span><a name="local-6989586621681325639"><a href="#local-6989586621681325639"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IfGblEnv</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1862"></a><span>                        </span><span class="hs-identifier">if_doc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;initIfaceCheck&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681325635"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">,</span><span>
</span><a name="line-1863"></a><span>                        </span><span class="hs-identifier">if_rec_types</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325638"><span class="hs-identifier hs-var">rec_types</span></a><span>
</span><a name="line-1864"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-1865"></a><span>      </span><a href="TcRnMonad.html#initTcRnIf"><span class="hs-identifier hs-var">initTcRnIf</span></a><span> </span><span class="hs-char">'i'</span><span> </span><a href="#local-6989586621681325636"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621681325639"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325637"><span class="hs-identifier hs-var">do_this</span></a><span>
</span><a name="line-1866"></a><span>
</span><a name="line-1867"></a><span class="hs-identifier">initIfaceLcl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681324840"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681324841"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324840"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1868"></a><a name="initIfaceLcl"><a href="TcRnMonad.html#initIfaceLcl"><span class="hs-identifier">initIfaceLcl</span></a></a><span> </span><a name="local-6989586621681325642"><a href="#local-6989586621681325642"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681325643"><a href="#local-6989586621681325643"><span class="hs-identifier">loc_doc</span></a></a><span> </span><a name="local-6989586621681325644"><a href="#local-6989586621681325644"><span class="hs-identifier">hi_boot_file</span></a></a><span> </span><a name="local-6989586621681325645"><a href="#local-6989586621681325645"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1869"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#mkIfLclEnv"><span class="hs-identifier hs-var">mkIfLclEnv</span></a><span> </span><a href="#local-6989586621681325642"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681325643"><span class="hs-identifier hs-var">loc_doc</span></a><span> </span><a href="#local-6989586621681325644"><span class="hs-identifier hs-var">hi_boot_file</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325645"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1870"></a><span>
</span><a name="line-1871"></a><span class="hs-comment">-- | Initialize interface typechecking, but with a 'NameShape'</span><span>
</span><a name="line-1872"></a><span class="hs-comment">-- to apply when typechecking top-level 'OccName's (see</span><span>
</span><a name="line-1873"></a><span class="hs-comment">-- 'lookupIfaceTop')</span><span>
</span><a name="line-1874"></a><span class="hs-identifier">initIfaceLclWithSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">NameShape</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681324838"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfM</span><span> </span><a href="#local-6989586621681324839"><span class="hs-identifier hs-type">lcl</span></a><span> </span><a href="#local-6989586621681324838"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1875"></a><a name="initIfaceLclWithSubst"><a href="TcRnMonad.html#initIfaceLclWithSubst"><span class="hs-identifier">initIfaceLclWithSubst</span></a></a><span> </span><a name="local-6989586621681325646"><a href="#local-6989586621681325646"><span class="hs-identifier">mod</span></a></a><span> </span><a name="local-6989586621681325647"><a href="#local-6989586621681325647"><span class="hs-identifier">loc_doc</span></a></a><span> </span><a name="local-6989586621681325648"><a href="#local-6989586621681325648"><span class="hs-identifier">hi_boot_file</span></a></a><span> </span><a name="local-6989586621681325649"><a href="#local-6989586621681325649"><span class="hs-identifier">nsubst</span></a></a><span> </span><a name="local-6989586621681325650"><a href="#local-6989586621681325650"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1876"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="TcRnMonad.html#mkIfLclEnv"><span class="hs-identifier hs-var">mkIfLclEnv</span></a><span> </span><a href="#local-6989586621681325646"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681325647"><span class="hs-identifier hs-var">loc_doc</span></a><span> </span><a href="#local-6989586621681325648"><span class="hs-identifier hs-var">hi_boot_file</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">if_nsubst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325649"><span class="hs-identifier hs-var">nsubst</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325650"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1877"></a><span>
</span><a name="line-1878"></a><span class="hs-identifier">getIfModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><span class="hs-identifier hs-type">Module</span><span>
</span><a name="line-1879"></a><a name="getIfModule"><a href="TcRnMonad.html#getIfModule"><span class="hs-identifier">getIfModule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325651"><a href="#local-6989586621681325651"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">if_mod</span><span> </span><a href="#local-6989586621681325651"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1880"></a><span>
</span><a name="line-1881"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-1882"></a><span class="hs-identifier">failIfM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MsgDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681324837"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1883"></a><span class="hs-comment">-- The Iface monad doesn't have a place to accumulate errors, so we</span><span>
</span><a name="line-1884"></a><span class="hs-comment">-- just fall over fast if one happens; it &quot;shouldn't happen&quot;.</span><span>
</span><a name="line-1885"></a><span class="hs-comment">-- We use IfL here so that we can get context info out of the local env</span><span>
</span><a name="line-1886"></a><a name="failIfM"><a href="TcRnMonad.html#failIfM"><span class="hs-identifier">failIfM</span></a></a><span> </span><a name="local-6989586621681325652"><a href="#local-6989586621681325652"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-1887"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325653"><a href="#local-6989586621681325653"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1888"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325654"><a href="#local-6989586621681325654"><span class="hs-identifier">full_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">if_loc</span><span> </span><a href="#local-6989586621681325653"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621681325652"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1889"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325655"><a href="#local-6989586621681325655"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1890"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621681325655"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-identifier hs-var">SevFatal</span><span>
</span><a name="line-1891"></a><span>                   </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultErrStyle</span><span> </span><a href="#local-6989586621681325655"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325654"><span class="hs-identifier hs-var">full_msg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1892"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">failM</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1893"></a><span>
</span><a name="line-1894"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-1895"></a><span class="hs-identifier">forkM_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681324836"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621681324836"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1896"></a><span class="hs-comment">-- Run thing_inside in an interleaved thread.</span><span>
</span><a name="line-1897"></a><span class="hs-comment">-- It shares everything with the parent thread, so this is DANGEROUS.</span><span>
</span><a name="line-1898"></a><span class="hs-comment">--</span><span>
</span><a name="line-1899"></a><span class="hs-comment">-- It returns Nothing if the computation fails</span><span>
</span><a name="line-1900"></a><span class="hs-comment">--</span><span>
</span><a name="line-1901"></a><span class="hs-comment">-- It's used for lazily type-checking interface</span><span>
</span><a name="line-1902"></a><span class="hs-comment">-- signatures, which is pretty benign</span><span>
</span><a name="line-1903"></a><span>
</span><a name="line-1904"></a><a name="forkM_maybe"><a href="TcRnMonad.html#forkM_maybe"><span class="hs-identifier">forkM_maybe</span></a></a><span> </span><a name="local-6989586621681325656"><a href="#local-6989586621681325656"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681325657"><a href="#local-6989586621681325657"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1905"></a><span> </span><span class="hs-comment">-- NB: Don't share the mutable env_us with the interleaved thread since env_us</span><span>
</span><a name="line-1906"></a><span> </span><span class="hs-comment">--     does not get updated atomically (e.g. in newUnique and newUniqueSupply).</span><span>
</span><a name="line-1907"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325658"><a href="#local-6989586621681325658"><span class="hs-identifier">child_us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUniqueSupply"><span class="hs-identifier hs-var">newUniqueSupply</span></a><span>
</span><a name="line-1908"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325659"><a href="#local-6989586621681325659"><span class="hs-identifier">child_env_us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newMutVar</span><span> </span><a href="#local-6989586621681325658"><span class="hs-identifier hs-var">child_us</span></a><span>
</span><a name="line-1909"></a><span>        </span><span class="hs-comment">-- see Note [Masking exceptions in forkM_maybe]</span><span>
</span><a name="line-1910"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unsafeInterleaveM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">uninterruptibleMaskM_</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">updEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325660"><a href="#local-6989586621681325660"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325660"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">env_us</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681325659"><span class="hs-identifier hs-var">child_env_us</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1911"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Starting fork {&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681325656"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1912"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681325662"><a href="#local-6989586621681325662"><span class="hs-identifier">mb_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryM</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1913"></a><span>                       </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325661"><a href="#local-6989586621681325661"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325661"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">if_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">if_loc</span><span> </span><a href="#local-6989586621681325661"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621681325656"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1914"></a><span>                       </span><a href="#local-6989586621681325657"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1915"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325662"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1916"></a><span>                </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681325663"><a href="#local-6989586621681325663"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;} ending fork&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681325656"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1917"></a><span>                                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325663"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1918"></a><span>                </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681325664"><a href="#local-6989586621681325664"><span class="hs-identifier">exn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1919"></a><span>
</span><a name="line-1920"></a><span>                    </span><span class="hs-comment">-- Bleat about errors in the forked thread, if -ddump-if-trace is on</span><span>
</span><a name="line-1921"></a><span>                    </span><span class="hs-comment">-- Otherwise we silently discard errors. Errors can legitimately</span><span>
</span><a name="line-1922"></a><span>                    </span><span class="hs-comment">-- happen when compiling interface signatures (see tcInterfaceSigs)</span><span>
</span><a name="line-1923"></a><span>                      </span><a href="TcRnMonad.html#whenDOptM"><span class="hs-identifier hs-var">whenDOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_if_trace</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1924"></a><span>                          </span><a name="local-6989586621681325665"><a href="#local-6989586621681325665"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1925"></a><span>                          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325666"><a href="#local-6989586621681325666"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;forkM failed:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681325656"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1926"></a><span>                                       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681325664"><span class="hs-identifier hs-var">exn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1927"></a><span>                          </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621681325665"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1928"></a><span>                                             </span><span class="hs-identifier hs-var">NoReason</span><span>
</span><a name="line-1929"></a><span>                                             </span><span class="hs-identifier hs-var">SevFatal</span><span>
</span><a name="line-1930"></a><span>                                             </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-1931"></a><span>                                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultErrStyle</span><span> </span><a href="#local-6989586621681325665"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1932"></a><span>                                             </span><a href="#local-6989586621681325666"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-1933"></a><span>
</span><a name="line-1934"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceIf"><span class="hs-identifier hs-var">traceIf</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;} ending fork (badly)&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621681325656"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1935"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1936"></a><span>        </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1937"></a><span>
</span><a name="line-1938"></a><span class="hs-identifier">forkM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681324835"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681324835"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1939"></a><a name="forkM"><a href="TcRnMonad.html#forkM"><span class="hs-identifier">forkM</span></a></a><span> </span><a name="local-6989586621681325667"><a href="#local-6989586621681325667"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621681325668"><a href="#local-6989586621681325668"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1940"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681325669"><a href="#local-6989586621681325669"><span class="hs-identifier">mb_res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#forkM_maybe"><span class="hs-identifier hs-var">forkM_maybe</span></a><span> </span><a href="#local-6989586621681325667"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621681325668"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1941"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681325669"><span class="hs-identifier hs-var">mb_res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1942"></a><span>                        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pgmError</span><span> </span><span class="hs-string">&quot;Cannot continue after interface file error&quot;</span><span>
</span><a name="line-1943"></a><span>                                   </span><span class="hs-comment">-- pprPanic &quot;forkM&quot; doc</span><span>
</span><a name="line-1944"></a><span>                        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681325670"><a href="#local-6989586621681325670"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325670"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1945"></a><span>
</span><a name="line-1946"></a><span class="hs-identifier">setImplicitEnvM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681324834"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IfL</span><span> </span><a href="#local-6989586621681324834"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1947"></a><a name="setImplicitEnvM"><a href="TcRnMonad.html#setImplicitEnvM"><span class="hs-identifier">setImplicitEnvM</span></a></a><span> </span><a name="local-6989586621681325671"><a href="#local-6989586621681325671"><span class="hs-identifier">tenv</span></a></a><span> </span><a name="local-6989586621681325672"><a href="#local-6989586621681325672"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#updLclEnv"><span class="hs-identifier hs-var">updLclEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681325673"><a href="#local-6989586621681325673"><span class="hs-identifier">lcl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681325673"><span class="hs-identifier hs-var">lcl</span></a><span>
</span><a name="line-1948"></a><span>                                     </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">if_implicits_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681325671"><span class="hs-identifier hs-var">tenv</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681325672"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1949"></a><span>
</span><a name="line-1950"></a><span class="hs-comment">{-
Note [Masking exceptions in forkM_maybe]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When using GHC-as-API it must be possible to interrupt snippets of code
executed using runStmt (#1381). Since commit 02c4ab04 this is almost possible
by throwing an asynchronous interrupt to the GHC thread. However, there is a
subtle problem: runStmt first typechecks the code before running it, and the
exception might interrupt the type checker rather than the code. Moreover, the
typechecker might be inside an unsafeInterleaveIO (through forkM_maybe), and
more importantly might be inside an exception handler inside that
unsafeInterleaveIO. If that is the case, the exception handler will rethrow the
asynchronous exception as a synchronous exception, and the exception will end
up as the value of the unsafeInterleaveIO thunk (see #8006 for a detailed
discussion).  We don't currently know a general solution to this problem, but
we can use uninterruptibleMask_ to avoid the situation.
-}</span><span>
</span><a name="line-1967"></a><span>
</span><a name="line-1968"></a><span class="hs-comment">-- | Environments which track 'CostCentreState'</span><span>
</span><a name="line-1969"></a><span class="hs-keyword">class</span><span> </span><a name="ContainsCostCentreState"><a href="TcRnMonad.html#ContainsCostCentreState"><span class="hs-identifier">ContainsCostCentreState</span></a></a><span> </span><a name="local-6989586621681324829"><a href="#local-6989586621681324829"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1970"></a><span>  </span><a name="extractCostCentreState"><a href="TcRnMonad.html#extractCostCentreState"><span class="hs-identifier">extractCostCentreState</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621681324829"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRef</span><span> </span><span class="hs-identifier hs-type">CostCentreState</span><span>
</span><a name="line-1971"></a><span>
</span><a name="line-1972"></a><span class="hs-keyword">instance</span><span> </span><a href="TcRnMonad.html#ContainsCostCentreState"><span class="hs-identifier hs-type">ContainsCostCentreState</span></a><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1973"></a><span>  </span><a name="local-8214565720326099529"><a href="TcRnMonad.html#extractCostCentreState"><span class="hs-identifier">extractCostCentreState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_cc_st</span><span>
</span><a name="line-1974"></a><span>
</span><a name="line-1975"></a><span class="hs-keyword">instance</span><span> </span><a href="TcRnMonad.html#ContainsCostCentreState"><span class="hs-identifier hs-type">ContainsCostCentreState</span></a><span> </span><span class="hs-identifier hs-type">DsGblEnv</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1976"></a><span>  </span><a name="local-8214565720326099529"><a href="TcRnMonad.html#extractCostCentreState"><span class="hs-identifier">extractCostCentreState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ds_cc_st</span><span>
</span><a name="line-1977"></a><span>
</span><a name="line-1978"></a><span class="hs-comment">-- | Get the next cost centre index associated with a given name.</span><span>
</span><a name="line-1979"></a><span class="hs-identifier">getCCIndexM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#ContainsCostCentreState"><span class="hs-identifier hs-type">ContainsCostCentreState</span></a><span> </span><a href="#local-6989586621681324832"><span class="hs-identifier hs-type">gbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1980"></a><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">FastString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRnIf</span><span> </span><a href="#local-6989586621681324832"><span class="hs-identifier hs-type">gbl</span></a><span> </span><a href="#local-6989586621681324833"><span class="hs-identifier hs-type">lcl</span></a><span> </span><span class="hs-identifier hs-type">CostCentreIndex</span><span>
</span><a name="line-1981"></a><a name="getCCIndexM"><a href="TcRnMonad.html#getCCIndexM"><span class="hs-identifier">getCCIndexM</span></a></a><span> </span><a name="local-6989586621681325674"><a href="#local-6989586621681325674"><span class="hs-identifier">nm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1982"></a><span>  </span><a name="local-6989586621681325675"><a href="#local-6989586621681325675"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1983"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681325676"><a href="#local-6989586621681325676"><span class="hs-identifier">cc_st_ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#extractCostCentreState"><span class="hs-identifier hs-var">extractCostCentreState</span></a><span> </span><a href="#local-6989586621681325675"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1984"></a><span>  </span><a name="local-6989586621681325677"><a href="#local-6989586621681325677"><span class="hs-identifier">cc_st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621681325676"><span class="hs-identifier hs-var">cc_st_ref</span></a><span>
</span><a name="line-1985"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681325678"><a href="#local-6989586621681325678"><span class="hs-identifier">idx</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681325679"><a href="#local-6989586621681325679"><span class="hs-identifier">cc_st'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getCCIndex</span><span> </span><a href="#local-6989586621681325674"><span class="hs-identifier hs-var">nm</span></a><span> </span><a href="#local-6989586621681325677"><span class="hs-identifier hs-var">cc_st</span></a><span>
</span><a name="line-1986"></a><span>  </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621681325676"><span class="hs-identifier hs-var">cc_st_ref</span></a><span> </span><a href="#local-6989586621681325679"><span class="hs-identifier hs-var">cc_st'</span></a><span>
</span><a name="line-1987"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681325678"><span class="hs-identifier hs-var">idx</span></a><span>
</span><a name="line-1988"></a></pre></body></html>