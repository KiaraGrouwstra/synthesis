<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2011


The deriving code for the Generic class
(equivalent to the code in TcGenDeriv, for other classes)
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, ScopedTypeVariables, TupleSections #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcGenGenerics</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#canDoGenerics"><span class="hs-identifier hs-var">canDoGenerics</span></a><span class="hs-special">,</span><span> </span><a href="TcGenGenerics.html#canDoGenerics1"><span class="hs-identifier hs-var">canDoGenerics1</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>                      </span><a href="TcGenGenerics.html#GenericKind"><span class="hs-identifier hs-type">GenericKind</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>                      </span><a href="TcGenGenerics.html#gen_Generic_binds"><span class="hs-identifier hs-var">gen_Generic_binds</span></a><span class="hs-special">,</span><span> </span><a href="TcGenGenerics.html#get_gen1_constrained_tys"><span class="hs-identifier hs-var">get_gen1_constrained_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="TcGenDeriv.html"><span class="hs-identifier">TcGenDeriv</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="TcGenFunctor.html"><span class="hs-identifier">TcGenFunctor</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FamFlavor</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkSingleCoAxiom</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">moduleName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">moduleNameFS</span><span>
</span><a name="line-29"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">moduleUnitId</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitIdFS</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getModule</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="IfaceEnv.html"><span class="hs-identifier">IfaceEnv</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="IfaceEnv.html#newGlobalBinder"><span class="hs-identifier hs-var">newGlobalBinder</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>      </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">varName</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysPrim</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Validity</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">andValid</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mplus</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip4</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">partition</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-55"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Bindings for the new generic deriving mechanism}
*                                                                      *
************************************************************************

For the generic representation we need to generate:
\begin{itemize}
\item A Generic instance
\item A Rep type instance
\item Many auxiliary datatypes and instances for them (for the meta-information)
\end{itemize}
-}</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-identifier">gen_Generic_binds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind"><span class="hs-identifier hs-type">GenericKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-71"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><a name="gen_Generic_binds"><a href="TcGenGenerics.html#gen_Generic_binds"><span class="hs-identifier">gen_Generic_binds</span></a></a><span> </span><a name="local-6989586621683326084"><a href="#local-6989586621683326084"><span class="hs-identifier">gk</span></a></a><span> </span><a name="local-6989586621683326085"><a href="#local-6989586621683326085"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683326086"><a href="#local-6989586621683326086"><span class="hs-identifier">inst_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-73"></a><span>  </span><a name="local-6989586621683326087"><a href="#local-6989586621683326087"><span class="hs-identifier">repTyInsts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcGenGenerics.html#tc_mkRepFamInsts"><span class="hs-identifier hs-var">tc_mkRepFamInsts</span></a><span> </span><a href="#local-6989586621683326084"><span class="hs-identifier hs-var">gk</span></a><span> </span><a href="#local-6989586621683326085"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683326086"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-74"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#mkBindsRep"><span class="hs-identifier hs-var">mkBindsRep</span></a><span> </span><a href="#local-6989586621683326084"><span class="hs-identifier hs-var">gk</span></a><span> </span><a href="#local-6989586621683326085"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326087"><span class="hs-identifier hs-var">repTyInsts</span></a><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Generating representation types}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-identifier">get_gen1_constrained_tys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- called by TcDeriv.inferConstraints; generates a list of types, each of which</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- must be a Functor in order for the Generic1 instance to work.</span><span>
</span><a name="line-87"></a><a name="get_gen1_constrained_tys"><a href="TcGenGenerics.html#get_gen1_constrained_tys"><span class="hs-identifier">get_gen1_constrained_tys</span></a></a><span> </span><a name="local-6989586621683326088"><a href="#local-6989586621683326088"><span class="hs-identifier">argVar</span></a></a><span>
</span><a name="line-88"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#argTyFold"><span class="hs-identifier hs-var">argTyFold</span></a><span> </span><a href="#local-6989586621683326088"><span class="hs-identifier hs-var">argVar</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcGenGenerics.html#ArgTyAlg"><span class="hs-identifier hs-var">ArgTyAlg</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ata_rec0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-89"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ata_par1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ata_rec1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-90"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ata_comp</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">{-

Note [Requirements for deriving Generic and Rep]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In the following, T, Tfun, and Targ are &quot;meta-variables&quot; ranging over type
expressions.

(Generic T) and (Rep T) are derivable for some type expression T if the
following constraints are satisfied.

  (a) D is a type constructor *value*. In other words, D is either a type
      constructor or it is equivalent to the head of a data family instance (up to
      alpha-renaming).

  (b) D cannot have a &quot;stupid context&quot;.

  (c) The right-hand side of D cannot include existential types, universally
      quantified types, or &quot;exotic&quot; unlifted types. An exotic unlifted type
      is one which is not listed in the definition of allowedUnliftedTy
      (i.e., one for which we have no representation type).
      See Note [Generics and unlifted types]

  (d) T :: *.

(Generic1 T) and (Rep1 T) are derivable for some type expression T if the
following constraints are satisfied.

  (a),(b),(c) As above.

  (d) T must expect arguments, and its last parameter must have kind *.

      We use `a' to denote the parameter of D that corresponds to the last
      parameter of T.

  (e) For any type-level application (Tfun Targ) in the right-hand side of D
      where the head of Tfun is not a tuple constructor:

      (b1) `a' must not occur in Tfun.

      (b2) If `a' occurs in Targ, then Tfun :: * -&gt; *.

-}</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-identifier">canDoGenerics</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- canDoGenerics determines if Generic/Rep can be derived.</span><span>
</span><a name="line-138"></a><span class="hs-comment">--</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- Check (a) from Note [Requirements for deriving Generic and Rep] is taken</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- care of because canDoGenerics is applied to rep tycons.</span><span>
</span><a name="line-141"></a><span class="hs-comment">--</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- It returns IsValid if deriving is possible. It returns (NotValid reason)</span><span>
</span><a name="line-143"></a><span class="hs-comment">-- if not.</span><span>
</span><a name="line-144"></a><a name="canDoGenerics"><a href="TcGenGenerics.html#canDoGenerics"><span class="hs-identifier">canDoGenerics</span></a></a><span> </span><a name="local-6989586621683326089"><a href="#local-6989586621683326089"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-145"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mergeErrors"><span class="hs-identifier hs-var">mergeErrors</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-146"></a><span>          </span><span class="hs-comment">-- Check (b) from Note [Requirements for deriving Generic and Rep].</span><span>
</span><a name="line-147"></a><span>              </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConStupidTheta</span><span> </span><a href="#local-6989586621683326089"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326090"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must not have a datatype context&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span class="hs-special">)</span><span>
</span><a name="line-150"></a><span>          </span><span class="hs-comment">-- See comment below</span><span>
</span><a name="line-151"></a><span>            </span><span class="hs-glyph">:</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683326091"><span class="hs-identifier hs-var">bad_con</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683326089"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-153"></a><span>    </span><span class="hs-comment">-- The tc can be a representation tycon. When we want to display it to the</span><span>
</span><a name="line-154"></a><span>    </span><span class="hs-comment">-- user (in an error message) we should print its parent</span><span>
</span><a name="line-155"></a><span>    </span><a name="local-6989586621683326090"><a href="#local-6989586621683326090"><span class="hs-identifier">tc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tyConFamInst_maybe</span><span> </span><a href="#local-6989586621683326089"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-156"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326093"><a href="#local-6989586621683326093"><span class="hs-identifier">ptc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326093"><span class="hs-identifier hs-var">ptc</span></a><span>
</span><a name="line-157"></a><span>        </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326089"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span>        </span><span class="hs-comment">-- Check (c) from Note [Requirements for deriving Generic and Rep].</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-161"></a><span>        </span><span class="hs-comment">-- If any of the constructors has an exotic unlifted type as argument,</span><span>
</span><a name="line-162"></a><span>        </span><span class="hs-comment">-- then we can't build the embedding-projection pair, because</span><span>
</span><a name="line-163"></a><span>        </span><span class="hs-comment">-- it relies on instantiating *polymorphic* sum and product types</span><span>
</span><a name="line-164"></a><span>        </span><span class="hs-comment">-- at the argument types of the constructors</span><span>
</span><a name="line-165"></a><span>    </span><a name="local-6989586621683326091"><a href="#local-6989586621683326091"><span class="hs-identifier">bad_con</span></a></a><span> </span><a name="local-6989586621683326094"><a href="#local-6989586621683326094"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621683326092"><span class="hs-identifier hs-var">bad_arg_type</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConOrigArgTys</span><span> </span><a href="#local-6989586621683326094"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683326094"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span>
</span><a name="line-167"></a><span>                    </span><span class="hs-string">&quot;must not have exotic unlifted or polymorphic arguments&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isVanillaDataCon</span><span> </span><a href="#local-6989586621683326094"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683326094"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must be a vanilla data constructor&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span class="hs-special">)</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>        </span><span class="hs-comment">-- Nor can we do the job if it's an existential data constructor,</span><span>
</span><a name="line-173"></a><span>        </span><span class="hs-comment">-- Nor if the args are polymorphic types (I don't think)</span><span>
</span><a name="line-174"></a><span>    </span><a name="local-6989586621683326092"><a href="#local-6989586621683326092"><span class="hs-identifier">bad_arg_type</span></a></a><span> </span><a name="local-6989586621683326095"><a href="#local-6989586621683326095"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><a href="#local-6989586621683326095"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#allowedUnliftedTy"><span class="hs-identifier hs-var">allowedUnliftedTy</span></a><span> </span><a href="#local-6989586621683326095"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>                      </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTauTy</span><span> </span><a href="#local-6989586621683326095"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span class="hs-comment">-- Returns True the Type argument is an unlifted type which has a</span><span>
</span><a name="line-178"></a><span class="hs-comment">-- corresponding generic representation type. For example,</span><span>
</span><a name="line-179"></a><span class="hs-comment">-- (allowedUnliftedTy Int#) would return True since there is the UInt</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- representation type.</span><span>
</span><a name="line-181"></a><span class="hs-identifier">allowedUnliftedTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-182"></a><a name="allowedUnliftedTy"><a href="TcGenGenerics.html#allowedUnliftedTy"><span class="hs-identifier">allowedUnliftedTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcGenGenerics.html#unboxedRepRDRs"><span class="hs-identifier hs-var">unboxedRepRDRs</span></a><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-identifier">mergeErrors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Validity</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-185"></a><a name="mergeErrors"><a href="TcGenGenerics.html#mergeErrors"><span class="hs-identifier">mergeErrors</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-186"></a><span class="hs-identifier">mergeErrors</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NotValid</span><span> </span><a name="local-6989586621683326096"><a href="#local-6989586621683326096"><span class="hs-identifier">s</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683326097"><a href="#local-6989586621683326097"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcGenGenerics.html#mergeErrors"><span class="hs-identifier hs-var">mergeErrors</span></a><span> </span><a href="#local-6989586621683326097"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-187"></a><span>  </span><span class="hs-identifier hs-var">IsValid</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a href="#local-6989586621683326096"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-188"></a><span>  </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a name="local-6989586621683326098"><a href="#local-6989586621683326098"><span class="hs-identifier">s'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326096"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;, and&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621683326098"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span class="hs-identifier">mergeErrors</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IsValid</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683326099"><a href="#local-6989586621683326099"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mergeErrors"><span class="hs-identifier hs-var">mergeErrors</span></a><span> </span><a href="#local-6989586621683326099"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-comment">-- A datatype used only inside of canDoGenerics1. It's the result of analysing</span><span>
</span><a name="line-192"></a><span class="hs-comment">-- a type term.</span><span>
</span><a name="line-193"></a><span class="hs-keyword">data</span><span> </span><a name="Check_for_CanDoGenerics1"><a href="TcGenGenerics.html#Check_for_CanDoGenerics1"><span class="hs-identifier">Check_for_CanDoGenerics1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CCDG1"><a href="TcGenGenerics.html#CCDG1"><span class="hs-identifier">CCDG1</span></a></a><span>
</span><a name="line-194"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="_ccdg1_hasParam"><a href="TcGenGenerics.html#_ccdg1_hasParam"><span class="hs-identifier">_ccdg1_hasParam</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>       </span><span class="hs-comment">-- does the parameter of interest occurs in</span><span>
</span><a name="line-195"></a><span>                                  </span><span class="hs-comment">-- this type?</span><span>
</span><a name="line-196"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="_ccdg1_errors"><a href="TcGenGenerics.html#_ccdg1_errors"><span class="hs-identifier">_ccdg1_errors</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>   </span><span class="hs-comment">-- errors generated by this type</span><span>
</span><a name="line-197"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">{-

Note [degenerate use of FFoldType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We use foldDataConArgs here only for its ability to treat tuples
specially. foldDataConArgs also tracks covariance (though it assumes all
higher-order type parameters are covariant) and has hooks for special handling
of functions and polytypes, but we do *not* use those.

The key issue is that Generic1 deriving currently offers no sophisticated
support for functions. For example, we cannot handle

  data F a = F ((a -&gt; Int) -&gt; Int)

even though a is occurring covariantly.

In fact, our rule is harsh: a is simply not allowed to occur within the first
argument of (-&gt;). We treat (-&gt;) the same as any other non-tuple tycon.

Unfortunately, this means we have to track &quot;the parameter occurs in this type&quot;
explicitly, even though foldDataConArgs is also doing this internally.

-}</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-comment">-- canDoGenerics1 determines if a Generic1/Rep1 can be derived.</span><span>
</span><a name="line-225"></a><span class="hs-comment">--</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- Checks (a) through (c) from Note [Requirements for deriving Generic and Rep]</span><span>
</span><a name="line-227"></a><span class="hs-comment">-- are taken care of by the call to canDoGenerics.</span><span>
</span><a name="line-228"></a><span class="hs-comment">--</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- It returns IsValid if deriving is possible. It returns (NotValid reason)</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- if not.</span><span>
</span><a name="line-231"></a><span class="hs-identifier">canDoGenerics1</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-232"></a><a name="canDoGenerics1"><a href="TcGenGenerics.html#canDoGenerics1"><span class="hs-identifier">canDoGenerics1</span></a></a><span> </span><a name="local-6989586621683326100"><a href="#local-6989586621683326100"><span class="hs-identifier">rep_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-233"></a><span>  </span><a href="TcGenGenerics.html#canDoGenerics"><span class="hs-identifier hs-var">canDoGenerics</span></a><span> </span><a href="#local-6989586621683326100"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andValid</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683326101"><span class="hs-identifier hs-var">additionalChecks</span></a><span>
</span><a name="line-234"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-235"></a><span>    </span><a name="local-6989586621683326101"><a href="#local-6989586621683326101"><span class="hs-identifier">additionalChecks</span></a></a><span>
</span><a name="line-236"></a><span>        </span><span class="hs-comment">-- check (d) from Note [Requirements for deriving Generic and Rep]</span><span>
</span><a name="line-237"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683326100"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-238"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Data type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683326100"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must have some type parameters&quot;</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mergeErrors"><span class="hs-identifier hs-var">mergeErrors</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621683326103"><span class="hs-identifier hs-var">check_con</span></a><span> </span><a href="#local-6989586621683326102"><span class="hs-identifier hs-var">data_cons</span></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>    </span><a name="local-6989586621683326102"><a href="#local-6989586621683326102"><span class="hs-identifier">data_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683326100"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-244"></a><span>    </span><a name="local-6989586621683326103"><a href="#local-6989586621683326103"><span class="hs-identifier">check_con</span></a></a><span> </span><a name="local-6989586621683326112"><a href="#local-6989586621683326112"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326105"><span class="hs-identifier hs-var">check_vanilla</span></a><span> </span><a href="#local-6989586621683326112"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-245"></a><span>      </span><a name="local-6989586621683326113"><a href="#local-6989586621683326113"><span class="hs-identifier">j</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326113"><span class="hs-identifier hs-var">j</span></a><span class="hs-special">]</span><span>
</span><a name="line-246"></a><span>      </span><span class="hs-identifier hs-var">IsValid</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">_ccdg1_errors</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">map</span><span class="hs-special">`</span><span> </span><a href="TcGenFunctor.html#foldDataConArgs"><span class="hs-identifier hs-var">foldDataConArgs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326109"><span class="hs-identifier hs-var">ft_check</span></a><span> </span><a href="#local-6989586621683326112"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326112"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span>    </span><span class="hs-identifier">bad</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-249"></a><span>    </span><a name="local-6989586621683326104"><a href="#local-6989586621683326104"><span class="hs-identifier">bad</span></a></a><span> </span><a name="local-6989586621683326114"><a href="#local-6989586621683326114"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621683326115"><a href="#local-6989586621683326115"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Constructor&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683326114"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683326115"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span>    </span><span class="hs-identifier">check_vanilla</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-252"></a><span>    </span><a name="local-6989586621683326105"><a href="#local-6989586621683326105"><span class="hs-identifier">check_vanilla</span></a></a><span> </span><a name="local-6989586621683326116"><a href="#local-6989586621683326116"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isVanillaDataCon</span><span> </span><a href="#local-6989586621683326116"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-253"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326104"><span class="hs-identifier hs-var">bad</span></a><span> </span><a href="#local-6989586621683326116"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683326110"><span class="hs-identifier hs-var">existential</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>
</span><a name="line-255"></a><span>    </span><a name="local-6989586621683326106"><a href="#local-6989586621683326106"><span class="hs-identifier">bmzero</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#CCDG1"><span class="hs-identifier hs-var">CCDG1</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-256"></a><span>    </span><a name="local-6989586621683326107"><a href="#local-6989586621683326107"><span class="hs-identifier">bmbad</span></a></a><span> </span><a name="local-6989586621683326117"><a href="#local-6989586621683326117"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621683326118"><a href="#local-6989586621683326118"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#CCDG1"><span class="hs-identifier hs-var">CCDG1</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683326104"><span class="hs-identifier hs-var">bad</span></a><span> </span><a href="#local-6989586621683326117"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683326118"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-257"></a><span>    </span><a name="local-6989586621683326108"><a href="#local-6989586621683326108"><span class="hs-identifier">bmplus</span></a></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#CCDG1"><span class="hs-identifier hs-var">CCDG1</span></a><span> </span><a name="local-6989586621683326119"><a href="#local-6989586621683326119"><span class="hs-identifier">b1</span></a></a><span> </span><a name="local-6989586621683326120"><a href="#local-6989586621683326120"><span class="hs-identifier">m1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#CCDG1"><span class="hs-identifier hs-var">CCDG1</span></a><span> </span><a name="local-6989586621683326121"><a href="#local-6989586621683326121"><span class="hs-identifier">b2</span></a></a><span> </span><a name="local-6989586621683326122"><a href="#local-6989586621683326122"><span class="hs-identifier">m2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#CCDG1"><span class="hs-identifier hs-var">CCDG1</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326119"><span class="hs-identifier hs-var">b1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621683326121"><span class="hs-identifier hs-var">b2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326120"><span class="hs-identifier hs-var">m1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andValid</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683326122"><span class="hs-identifier hs-var">m2</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span>    </span><span class="hs-comment">-- check (e) from Note [Requirements for deriving Generic and Rep]</span><span>
</span><a name="line-260"></a><span>    </span><span class="hs-comment">-- See also Note [degenerate use of FFoldType]</span><span>
</span><a name="line-261"></a><span>    </span><span class="hs-identifier">ft_check</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenFunctor.html#FFoldType"><span class="hs-identifier hs-type">FFoldType</span></a><span> </span><a href="TcGenGenerics.html#Check_for_CanDoGenerics1"><span class="hs-identifier hs-type">Check_for_CanDoGenerics1</span></a><span>
</span><a name="line-262"></a><span>    </span><a name="local-6989586621683326109"><a href="#local-6989586621683326109"><span class="hs-identifier">ft_check</span></a></a><span> </span><a name="local-6989586621683326123"><a href="#local-6989586621683326123"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenFunctor.html#FT"><span class="hs-identifier hs-var">FT</span></a><span>
</span><a name="line-263"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ft_triv</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326106"><span class="hs-identifier hs-var">bmzero</span></a><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_var</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326124"><span class="hs-identifier hs-var">caseVar</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_co_var</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326124"><span class="hs-identifier hs-var">caseVar</span></a><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span>      </span><span class="hs-comment">-- (component_0,component_1,...,component_n)</span><span>
</span><a name="line-268"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_tup</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326125"><a href="#local-6989586621683326125"><span class="hs-identifier">components</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier">_ccdg1_hasParam</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">init</span><span> </span><a href="#local-6989586621683326125"><span class="hs-identifier hs-var">components</span></a><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>                                  </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683326107"><span class="hs-identifier hs-var">bmbad</span></a><span> </span><a href="#local-6989586621683326123"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683326111"><span class="hs-identifier hs-var">wrong_arg</span></a><span>
</span><a name="line-270"></a><span>                                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621683326108"><span class="hs-identifier hs-var">bmplus</span></a><span> </span><a href="#local-6989586621683326106"><span class="hs-identifier hs-var">bmzero</span></a><span> </span><a href="#local-6989586621683326125"><span class="hs-identifier hs-var">components</span></a><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span>      </span><span class="hs-comment">-- (dom -&gt; rng), where the head of ty is not a tuple tycon</span><span>
</span><a name="line-273"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683326126"><a href="#local-6989586621683326126"><span class="hs-identifier">dom</span></a></a><span> </span><a name="local-6989586621683326127"><a href="#local-6989586621683326127"><span class="hs-identifier">rng</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- cf #8516</span><span>
</span><a name="line-274"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">_ccdg1_hasParam</span><span> </span><a href="#local-6989586621683326126"><span class="hs-identifier hs-var">dom</span></a><span>
</span><a name="line-275"></a><span>          </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683326107"><span class="hs-identifier hs-var">bmbad</span></a><span> </span><a href="#local-6989586621683326123"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683326111"><span class="hs-identifier hs-var">wrong_arg</span></a><span>
</span><a name="line-276"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683326108"><span class="hs-identifier hs-var">bmplus</span></a><span> </span><a href="#local-6989586621683326126"><span class="hs-identifier hs-var">dom</span></a><span> </span><a href="#local-6989586621683326127"><span class="hs-identifier hs-var">rng</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span>      </span><span class="hs-comment">-- (ty arg), where head of ty is neither (-&gt;) nor a tuple constructor and</span><span>
</span><a name="line-279"></a><span>      </span><span class="hs-comment">-- the parameter of interest does not occur in ty</span><span>
</span><a name="line-280"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_ty_app</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326128"><a href="#local-6989586621683326128"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326128"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_bad_app</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326107"><span class="hs-identifier hs-var">bmbad</span></a><span> </span><a href="#local-6989586621683326123"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683326111"><span class="hs-identifier hs-var">wrong_arg</span></a><span>
</span><a name="line-283"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_forall</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326129"><a href="#local-6989586621683326129"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326129"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-comment">-- polytypes are handled elsewhere</span><span>
</span><a name="line-284"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-285"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-286"></a><span>        </span><a name="local-6989586621683326124"><a href="#local-6989586621683326124"><span class="hs-identifier">caseVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#CCDG1"><span class="hs-identifier hs-var">CCDG1</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span>    </span><a name="local-6989586621683326110"><a href="#local-6989586621683326110"><span class="hs-identifier">existential</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must not have existential arguments&quot;</span><span>
</span><a name="line-290"></a><span>    </span><a name="local-6989586621683326111"><a href="#local-6989586621683326111"><span class="hs-identifier">wrong_arg</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;applies a type to an argument involving the last parameter&quot;</span><span>
</span><a name="line-291"></a><span>               </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but the applied type is not of kind * -&gt; *&quot;</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Generating the RHS of a generic default method}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-keyword">type</span><span> </span><a name="US"><a href="TcGenGenerics.html#US"><span class="hs-identifier">US</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span>   </span><span class="hs-comment">-- Local unique supply, just a plain Int</span><span>
</span><a name="line-302"></a><span class="hs-keyword">type</span><span> </span><a name="Alt"><a href="TcGenGenerics.html#Alt"><span class="hs-identifier">Alt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-comment">-- GenericKind serves to mark if a datatype derives Generic (Gen0) or</span><span>
</span><a name="line-305"></a><span class="hs-comment">-- Generic1 (Gen1).</span><span>
</span><a name="line-306"></a><span class="hs-keyword">data</span><span> </span><a name="GenericKind"><a href="TcGenGenerics.html#GenericKind"><span class="hs-identifier">GenericKind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Gen0"><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier">Gen0</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Gen1"><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier">Gen1</span></a></a><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-comment">-- as above, but with a payload of the TyCon's name for &quot;the&quot; parameter</span><span>
</span><a name="line-309"></a><span class="hs-keyword">data</span><span> </span><a name="GenericKind_"><a href="TcGenGenerics.html#GenericKind_"><span class="hs-identifier">GenericKind_</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Gen0_"><a href="TcGenGenerics.html#Gen0_"><span class="hs-identifier">Gen0_</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Gen1_"><a href="TcGenGenerics.html#Gen1_"><span class="hs-identifier">Gen1_</span></a></a><span> </span><span class="hs-identifier hs-type">TyVar</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-comment">-- as above, but using a single datacon's name for &quot;the&quot; parameter</span><span>
</span><a name="line-312"></a><span class="hs-keyword">data</span><span> </span><a name="GenericKind_DC"><a href="TcGenGenerics.html#GenericKind_DC"><span class="hs-identifier">GenericKind_DC</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Gen0_DC"><a href="TcGenGenerics.html#Gen0_DC"><span class="hs-identifier">Gen0_DC</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Gen1_DC"><a href="TcGenGenerics.html#Gen1_DC"><span class="hs-identifier">Gen1_DC</span></a></a><span> </span><span class="hs-identifier hs-type">TyVar</span><span>
</span><a name="line-313"></a><span>
</span><a name="line-314"></a><span class="hs-identifier">forgetArgVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind_DC"><span class="hs-identifier hs-type">GenericKind_DC</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenGenerics.html#GenericKind"><span class="hs-identifier hs-type">GenericKind</span></a><span>
</span><a name="line-315"></a><a name="forgetArgVar"><a href="TcGenGenerics.html#forgetArgVar"><span class="hs-identifier">forgetArgVar</span></a></a><span> </span><a href="TcGenGenerics.html#Gen0_DC"><span class="hs-identifier hs-var">Gen0_DC</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span>
</span><a name="line-316"></a><span class="hs-identifier">forgetArgVar</span><span> </span><a href="TcGenGenerics.html#Gen1_DC"><span class="hs-identifier hs-var">Gen1_DC</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-comment">-- When working only within a single datacon, &quot;the&quot; parameter's name should</span><span>
</span><a name="line-319"></a><span class="hs-comment">-- match that datacon's name for it.</span><span>
</span><a name="line-320"></a><span class="hs-identifier">gk2gkDC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind_"><span class="hs-identifier hs-type">GenericKind_</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenGenerics.html#GenericKind_DC"><span class="hs-identifier hs-type">GenericKind_DC</span></a><span>
</span><a name="line-321"></a><a name="gk2gkDC"><a href="TcGenGenerics.html#gk2gkDC"><span class="hs-identifier">gk2gkDC</span></a></a><span> </span><a href="TcGenGenerics.html#Gen0_"><span class="hs-identifier hs-var">Gen0_</span></a><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#Gen0_DC"><span class="hs-identifier hs-var">Gen0_DC</span></a><span>
</span><a name="line-322"></a><span class="hs-identifier">gk2gkDC</span><span> </span><a href="TcGenGenerics.html#Gen1_"><span class="hs-identifier hs-var">Gen1_</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><a name="local-6989586621683326130"><a href="#local-6989586621683326130"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#Gen1_DC"><span class="hs-identifier hs-var">Gen1_DC</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">dataConUnivTyVars</span><span> </span><a href="#local-6989586621683326130"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>
</span><a name="line-325"></a><span class="hs-comment">-- Bindings for the Generic instance</span><span>
</span><a name="line-326"></a><span class="hs-identifier">mkBindsRep</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind"><span class="hs-identifier hs-type">GenericKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-327"></a><a name="mkBindsRep"><a href="TcGenGenerics.html#mkBindsRep"><span class="hs-identifier">mkBindsRep</span></a></a><span> </span><a name="local-6989586621683326131"><a href="#local-6989586621683326131"><span class="hs-identifier">gk</span></a></a><span> </span><a name="local-6989586621683326132"><a href="#local-6989586621683326132"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-328"></a><span>    </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">(</span><a href="TcGenDeriv.html#mkRdrFunBind"><span class="hs-identifier hs-var">mkRdrFunBind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683326137"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683326139"><span class="hs-identifier hs-var">from01_RDR</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326133"><span class="hs-identifier hs-var">from_eqn</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-329"></a><span>  </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span>
</span><a name="line-330"></a><span>    </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">(</span><a href="TcGenDeriv.html#mkRdrFunBind"><span class="hs-identifier hs-var">mkRdrFunBind</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">L</span><span> </span><a href="#local-6989586621683326137"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683326140"><span class="hs-identifier hs-var">to01_RDR</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326134"><span class="hs-identifier hs-var">to_eqn</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-332"></a><span>        </span><span class="hs-comment">-- The topmost M1 (the datatype metadata) has the exact same type</span><span>
</span><a name="line-333"></a><span>        </span><span class="hs-comment">-- across all cases of a from/to definition, and can be factored out</span><span>
</span><a name="line-334"></a><span>        </span><span class="hs-comment">-- to save some allocations during typechecking.</span><span>
</span><a name="line-335"></a><span>        </span><span class="hs-comment">-- See Note [Generics compilation speed tricks]</span><span>
</span><a name="line-336"></a><span>        </span><a name="local-6989586621683326133"><a href="#local-6989586621683326133"><span class="hs-identifier">from_eqn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsCaseAlt</span><span> </span><a href="TcGenGenerics.html#x_Pat"><span class="hs-identifier hs-var">x_Pat</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcGenGenerics.html#mkM1_E"><span class="hs-identifier hs-var">mkM1_E</span></a><span>
</span><a name="line-337"></a><span>                                       </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsPar</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsCase</span><span> </span><a href="TcGenGenerics.html#x_Expr"><span class="hs-identifier hs-var">x_Expr</span></a><span> </span><a href="#local-6989586621683326135"><span class="hs-identifier hs-var">from_matches</span></a><span>
</span><a name="line-338"></a><span>        </span><a name="local-6989586621683326134"><a href="#local-6989586621683326134"><span class="hs-identifier">to_eqn</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkHsCaseAlt</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#mkM1_P"><span class="hs-identifier hs-var">mkM1_P</span></a><span> </span><a href="TcGenGenerics.html#x_Pat"><span class="hs-identifier hs-var">x_Pat</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsCase</span><span> </span><a href="TcGenGenerics.html#x_Expr"><span class="hs-identifier hs-var">x_Expr</span></a><span> </span><a href="#local-6989586621683326136"><span class="hs-identifier hs-var">to_matches</span></a><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span>        </span><a name="local-6989586621683326135"><a href="#local-6989586621683326135"><span class="hs-identifier">from_matches</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkHsCaseAlt</span><span> </span><a href="#local-6989586621683326143"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683326144"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326143"><a href="#local-6989586621683326143"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><a name="local-6989586621683326144"><a href="#local-6989586621683326144"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326141"><span class="hs-identifier hs-var">from_alts</span></a><span class="hs-special">]</span><span>
</span><a name="line-341"></a><span>        </span><a name="local-6989586621683326136"><a href="#local-6989586621683326136"><span class="hs-identifier">to_matches</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkHsCaseAlt</span><span> </span><a href="#local-6989586621683326145"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683326146"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326145"><a href="#local-6989586621683326145"><span class="hs-identifier">pat</span></a></a><span class="hs-special">,</span><a name="local-6989586621683326146"><a href="#local-6989586621683326146"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326142"><span class="hs-identifier hs-var">to_alts</span></a><span>  </span><span class="hs-special">]</span><span>
</span><a name="line-342"></a><span>        </span><a name="local-6989586621683326137"><a href="#local-6989586621683326137"><span class="hs-identifier">loc</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">srcLocSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcLoc</span><span> </span><a href="#local-6989586621683326132"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-343"></a><span>        </span><a name="local-6989586621683326138"><a href="#local-6989586621683326138"><span class="hs-identifier">datacons</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683326132"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683326139"><a href="#local-6989586621683326139"><span class="hs-identifier">from01_RDR</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326140"><a href="#local-6989586621683326140"><span class="hs-identifier">to01_RDR</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326131"><span class="hs-identifier hs-var">gk</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-346"></a><span>                                   </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">from_RDR</span><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-var">to_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>                                   </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">from1_RDR</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">to1_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>
</span><a name="line-349"></a><span>        </span><span class="hs-comment">-- Recurse over the sum first</span><span>
</span><a name="line-350"></a><span>        </span><span class="hs-identifier">from_alts</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">to_alts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcGenGenerics.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span class="hs-special">]</span><span>
</span><a name="line-351"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683326141"><a href="#local-6989586621683326141"><span class="hs-identifier">from_alts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326142"><a href="#local-6989586621683326142"><span class="hs-identifier">to_alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkSum"><span class="hs-identifier hs-var">mkSum</span></a><span> </span><a href="#local-6989586621683326147"><span class="hs-identifier hs-var">gk_</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#US"><span class="hs-identifier hs-type">US</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326138"><span class="hs-identifier hs-var">datacons</span></a><span>
</span><a name="line-352"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683326147"><a href="#local-6989586621683326147"><span class="hs-identifier">gk_</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326131"><span class="hs-identifier hs-var">gk</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-353"></a><span>                  </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenGenerics.html#Gen0_"><span class="hs-identifier hs-var">Gen0_</span></a><span>
</span><a name="line-354"></a><span>                  </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">tyvars</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthAtLeast</span><span class="hs-special">`</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>                          </span><a href="TcGenGenerics.html#Gen1_"><span class="hs-identifier hs-var">Gen1_</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621683326148"><span class="hs-identifier hs-var">tyvars</span></a><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>                    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683326148"><a href="#local-6989586621683326148"><span class="hs-identifier">tyvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683326132"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-359"></a><span class="hs-comment">-- The type synonym instance and synonym</span><span>
</span><a name="line-360"></a><span class="hs-comment">--       type instance Rep (D a b) = Rep_D a b</span><span>
</span><a name="line-361"></a><span class="hs-comment">--       type Rep_D a b = ...representation type for D ...</span><span>
</span><a name="line-362"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span class="hs-identifier">tc_mkRepFamInsts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind"><span class="hs-identifier hs-type">GenericKind</span></a><span>   </span><span class="hs-comment">-- Gen0 or Gen1</span><span>
</span><a name="line-365"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>         </span><span class="hs-comment">-- The type to generate representation for</span><span>
</span><a name="line-366"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- The type(s) to which Generic(1) is applied</span><span>
</span><a name="line-367"></a><span>                                  </span><span class="hs-comment">-- in the generated instance</span><span>
</span><a name="line-368"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span>   </span><span class="hs-comment">-- Generated representation0 coercion</span><span>
</span><a name="line-369"></a><a name="tc_mkRepFamInsts"><a href="TcGenGenerics.html#tc_mkRepFamInsts"><span class="hs-identifier">tc_mkRepFamInsts</span></a></a><span> </span><a name="local-6989586621683326149"><a href="#local-6989586621683326149"><span class="hs-identifier">gk</span></a></a><span> </span><a name="local-6989586621683326150"><a href="#local-6989586621683326150"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621683326151"><a href="#local-6989586621683326151"><span class="hs-identifier">inst_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-370"></a><span>       </span><span class="hs-comment">-- Consider the example input tycon `D`, where data D a b = D_ a</span><span>
</span><a name="line-371"></a><span>       </span><span class="hs-comment">-- Also consider `R:DInt`, where { data family D x y :: * -&gt; *</span><span>
</span><a name="line-372"></a><span>       </span><span class="hs-comment">--                               ; data instance D Int a b = D_ a }</span><span>
</span><a name="line-373"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- `rep` = GHC.Generics.Rep or GHC.Generics.Rep1 (type family)</span><span>
</span><a name="line-374"></a><span>       </span><a name="local-6989586621683326152"><a href="#local-6989586621683326152"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326149"><span class="hs-identifier hs-var">gk</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-375"></a><span>         </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">repTyConName</span><span>
</span><a name="line-376"></a><span>         </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">rep1TyConName</span><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683326153"><a href="#local-6989586621683326153"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- If the derived instance is</span><span>
</span><a name="line-381"></a><span>           </span><span class="hs-comment">--   instance Generic (Foo x)</span><span>
</span><a name="line-382"></a><span>           </span><span class="hs-comment">-- then:</span><span>
</span><a name="line-383"></a><span>           </span><span class="hs-comment">--   `arg_ki` = *, `inst_ty` = Foo x :: *</span><span>
</span><a name="line-384"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-385"></a><span>           </span><span class="hs-comment">-- If the derived instance is</span><span>
</span><a name="line-386"></a><span>           </span><span class="hs-comment">--   instance Generic1 (Bar x :: k -&gt; *)</span><span>
</span><a name="line-387"></a><span>           </span><span class="hs-comment">-- then:</span><span>
</span><a name="line-388"></a><span>           </span><span class="hs-comment">--   `arg_k` = k, `inst_ty` = Bar x :: k -&gt; *</span><span>
</span><a name="line-389"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621683326154"><a href="#local-6989586621683326154"><span class="hs-identifier">arg_ki</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326155"><a href="#local-6989586621683326155"><span class="hs-identifier">inst_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326149"><span class="hs-identifier hs-var">gk</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326151"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-390"></a><span>             </span><span class="hs-special">(</span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683326156"><a href="#local-6989586621683326156"><span class="hs-identifier">inst_t</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326156"><span class="hs-identifier hs-var">inst_t</span></a><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>             </span><span class="hs-special">(</span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683326157"><a href="#local-6989586621683326157"><span class="hs-identifier">arg_k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326158"><a href="#local-6989586621683326158"><span class="hs-identifier">inst_t</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326157"><span class="hs-identifier hs-var">arg_k</span></a><span class="hs-special">,</span><span>          </span><a href="#local-6989586621683326158"><span class="hs-identifier hs-var">inst_t</span></a><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>             </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;tc_mkRepFamInsts&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683326151"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683326159"><a href="#local-6989586621683326159"><span class="hs-identifier">mbFamInst</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConFamInst_maybe</span><span> </span><a href="#local-6989586621683326150"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-395"></a><span>           </span><span class="hs-comment">-- If we're examining a data family instance, we grab the parent</span><span>
</span><a name="line-396"></a><span>           </span><span class="hs-comment">-- TyCon (ptc) and use it to determine the type arguments</span><span>
</span><a name="line-397"></a><span>           </span><span class="hs-comment">-- (inst_args) for the data family *instance*'s type variables.</span><span>
</span><a name="line-398"></a><span>           </span><a name="local-6989586621683326160"><a href="#local-6989586621683326160"><span class="hs-identifier">ptc</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621683326150"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621683326159"><span class="hs-identifier hs-var">mbFamInst</span></a><span>
</span><a name="line-399"></a><span>           </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683326161"><a href="#local-6989586621683326161"><span class="hs-identifier">inst_args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInst.html#tcLookupDataFamInst"><span class="hs-identifier hs-var">tcLookupDataFamInst</span></a><span> </span><a href="#local-6989586621683326153"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621683326160"><span class="hs-identifier hs-var">ptc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">snd</span><span>
</span><a name="line-400"></a><span>                                 </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp</span><span> </span><a href="#local-6989586621683326155"><span class="hs-identifier hs-var">inst_ty</span></a><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- `tyvars` = [a,b]</span><span>
</span><a name="line-403"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621683326162"><a href="#local-6989586621683326162"><span class="hs-identifier">tyvars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326163"><a href="#local-6989586621683326163"><span class="hs-identifier">gk_</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326149"><span class="hs-identifier hs-var">gk</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-404"></a><span>             </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326164"><span class="hs-identifier hs-var">all_tyvars</span></a><span class="hs-special">,</span><span> </span><a href="TcGenGenerics.html#Gen0_"><span class="hs-identifier hs-var">Gen0_</span></a><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>             </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">all_tyvars</span><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">init</span><span> </span><a href="#local-6989586621683326164"><span class="hs-identifier hs-var">all_tyvars</span></a><span class="hs-special">,</span><span> </span><a href="TcGenGenerics.html#Gen1_"><span class="hs-identifier hs-var">Gen1_</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621683326164"><span class="hs-identifier hs-var">all_tyvars</span></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>             </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683326164"><a href="#local-6989586621683326164"><span class="hs-identifier">all_tyvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683326150"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span>       </span><span class="hs-comment">-- `repTy` = D1 ... (C1 ... (S1 ... (Rec0 a))) :: * -&gt; *</span><span>
</span><a name="line-410"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683326165"><a href="#local-6989586621683326165"><span class="hs-identifier">repTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcGenGenerics.html#tc_mkRepTy"><span class="hs-identifier hs-var">tc_mkRepTy</span></a><span> </span><a href="#local-6989586621683326163"><span class="hs-identifier hs-var">gk_</span></a><span> </span><a href="#local-6989586621683326150"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621683326154"><span class="hs-identifier hs-var">arg_ki</span></a><span>
</span><a name="line-411"></a><span>
</span><a name="line-412"></a><span>       </span><span class="hs-comment">-- `rep_name` is a name we generate for the synonym</span><span>
</span><a name="line-413"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683326166"><a href="#local-6989586621683326166"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-414"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683326167"><a href="#local-6989586621683326167"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getSrcSpanM"><span class="hs-identifier hs-var">getSrcSpanM</span></a><span>
</span><a name="line-415"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683326168"><a href="#local-6989586621683326168"><span class="hs-identifier">tc_occ</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683326150"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>           </span><a name="local-6989586621683326169"><a href="#local-6989586621683326169"><span class="hs-identifier">rep_occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326149"><span class="hs-identifier hs-var">gk</span></a><span> </span><span class="hs-keyword">of</span><span> </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkGenR</span><span> </span><a href="#local-6989586621683326168"><span class="hs-identifier hs-var">tc_occ</span></a><span class="hs-special">;</span><span> </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkGen1R</span><span> </span><a href="#local-6989586621683326168"><span class="hs-identifier hs-var">tc_occ</span></a><span>
</span><a name="line-417"></a><span>     </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683326170"><a href="#local-6989586621683326170"><span class="hs-identifier">rep_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IfaceEnv.html#newGlobalBinder"><span class="hs-identifier hs-var">newGlobalBinder</span></a><span> </span><a href="#local-6989586621683326166"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621683326169"><span class="hs-identifier hs-var">rep_occ</span></a><span> </span><a href="#local-6989586621683326167"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span>       </span><span class="hs-comment">-- We make sure to substitute the tyvars with their user-supplied</span><span>
</span><a name="line-420"></a><span>       </span><span class="hs-comment">-- type arguments before generating the Rep/Rep1 instance, since some</span><span>
</span><a name="line-421"></a><span>       </span><span class="hs-comment">-- of the tyvars might have been instantiated when deriving.</span><span>
</span><a name="line-422"></a><span>       </span><span class="hs-comment">-- See Note [Generating a correctly typed Rep instance].</span><span>
</span><a name="line-423"></a><span>     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326171"><a href="#local-6989586621683326171"><span class="hs-identifier">env_tyvars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326172"><a href="#local-6989586621683326172"><span class="hs-identifier">env_inst_args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326163"><span class="hs-identifier hs-var">gk_</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-425"></a><span>                 </span><a href="TcGenGenerics.html#Gen0_"><span class="hs-identifier hs-var">Gen0_</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326162"><span class="hs-identifier hs-var">tyvars</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326161"><span class="hs-identifier hs-var">inst_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>                 </span><a href="TcGenGenerics.html#Gen1_"><span class="hs-identifier hs-var">Gen1_</span></a><span> </span><a name="local-6989586621683326183"><a href="#local-6989586621683326183"><span class="hs-identifier">last_tv</span></a></a><span>
</span><a name="line-427"></a><span>                          </span><span class="hs-comment">-- See the &quot;wrinkle&quot; in</span><span>
</span><a name="line-428"></a><span>                          </span><span class="hs-comment">-- Note [Generating a correctly typed Rep instance]</span><span>
</span><a name="line-429"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621683326183"><span class="hs-identifier hs-var">last_tv</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683326162"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-430"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">anyTypeOfKind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683326183"><span class="hs-identifier hs-var">last_tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683326161"><span class="hs-identifier hs-var">inst_args</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>           </span><a name="local-6989586621683326173"><a href="#local-6989586621683326173"><span class="hs-identifier">env</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipTyEnv</span><span> </span><a href="#local-6989586621683326171"><span class="hs-identifier hs-var">env_tyvars</span></a><span> </span><a href="#local-6989586621683326172"><span class="hs-identifier hs-var">env_inst_args</span></a><span>
</span><a name="line-432"></a><span>           </span><a name="local-6989586621683326174"><a href="#local-6989586621683326174"><span class="hs-identifier">in_scope</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInScopeSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621683326151"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-433"></a><span>           </span><a name="local-6989586621683326175"><a href="#local-6989586621683326175"><span class="hs-identifier">subst</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTvSubst</span><span> </span><a href="#local-6989586621683326174"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621683326173"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-434"></a><span>           </span><a name="local-6989586621683326176"><a href="#local-6989586621683326176"><span class="hs-identifier">repTy'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span>  </span><a href="#local-6989586621683326175"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683326165"><span class="hs-identifier hs-var">repTy</span></a><span>
</span><a name="line-435"></a><span>           </span><a name="local-6989586621683326177"><a href="#local-6989586621683326177"><span class="hs-identifier">tcv'</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypeList</span><span> </span><a href="#local-6989586621683326155"><span class="hs-identifier hs-var">inst_ty</span></a><span>
</span><a name="line-436"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621683326178"><a href="#local-6989586621683326178"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326179"><a href="#local-6989586621683326179"><span class="hs-identifier">cv'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-identifier hs-var">isTyVar</span><span> </span><a href="#local-6989586621683326177"><span class="hs-identifier hs-var">tcv'</span></a><span>
</span><a name="line-437"></a><span>           </span><a name="local-6989586621683326180"><a href="#local-6989586621683326180"><span class="hs-identifier">tvs'</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scopedSort</span><span> </span><a href="#local-6989586621683326178"><span class="hs-identifier hs-var">tv'</span></a><span>
</span><a name="line-438"></a><span>           </span><a name="local-6989586621683326181"><a href="#local-6989586621683326181"><span class="hs-identifier">cvs'</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">scopedSort</span><span> </span><a href="#local-6989586621683326179"><span class="hs-identifier hs-var">cv'</span></a><span>
</span><a name="line-439"></a><span>           </span><a name="local-6989586621683326182"><a href="#local-6989586621683326182"><span class="hs-identifier">axiom</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkSingleCoAxiom</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621683326170"><span class="hs-identifier hs-var">rep_name</span></a><span> </span><a href="#local-6989586621683326180"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683326181"><span class="hs-identifier hs-var">cvs'</span></a><span>
</span><a name="line-440"></a><span>                                        </span><a href="#local-6989586621683326152"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621683326151"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="#local-6989586621683326176"><span class="hs-identifier hs-var">repTy'</span></a><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="FamInst.html#newFamInst"><span class="hs-identifier hs-var">newFamInst</span></a><span> </span><span class="hs-identifier hs-var">SynFamilyInst</span><span> </span><a href="#local-6989586621683326182"><span class="hs-identifier hs-var">axiom</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-443"></a><span>
</span><a name="line-444"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- Type representation</span><span>
</span><a name="line-446"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-comment">-- | See documentation of 'argTyFold'; that function uses the fields of this</span><span>
</span><a name="line-449"></a><span class="hs-comment">-- type to interpret the structure of a type when that type is considered as an</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- argument to a constructor that is being represented with 'Rep1'.</span><span>
</span><a name="line-451"></a><span class="hs-keyword">data</span><span> </span><a name="ArgTyAlg"><a href="TcGenGenerics.html#ArgTyAlg"><span class="hs-identifier">ArgTyAlg</span></a></a><span> </span><a name="local-6989586621683326080"><a href="#local-6989586621683326080"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="ArgTyAlg"><a href="TcGenGenerics.html#ArgTyAlg"><span class="hs-identifier">ArgTyAlg</span></a></a><span>
</span><a name="line-452"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="ata_rec0"><a href="TcGenGenerics.html#ata_rec0"><span class="hs-identifier">ata_rec0</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326080"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ata_par1"><a href="TcGenGenerics.html#ata_par1"><span class="hs-identifier">ata_par1</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621683326080"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a name="ata_rec1"><a href="TcGenGenerics.html#ata_rec1"><span class="hs-identifier">ata_rec1</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326080"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ata_comp"><a href="TcGenGenerics.html#ata_comp"><span class="hs-identifier">ata_comp</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326080"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326080"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-456"></a><span>
</span><a name="line-457"></a><span class="hs-comment">-- | @argTyFold@ implements a generalised and safer variant of the @arg@</span><span>
</span><a name="line-458"></a><span class="hs-comment">-- function from Figure 3 in &lt;http://dreixel.net/research/pdf/gdmh.pdf&gt;. @arg@</span><span>
</span><a name="line-459"></a><span class="hs-comment">-- is conceptually equivalent to:</span><span>
</span><a name="line-460"></a><span class="hs-comment">--</span><span>
</span><a name="line-461"></a><span class="hs-comment">-- &gt; arg t = case t of</span><span>
</span><a name="line-462"></a><span class="hs-comment">-- &gt;   _ | isTyVar t         -&gt; if (t == argVar) then Par1 else Par0 t</span><span>
</span><a name="line-463"></a><span class="hs-comment">-- &gt;   App f [t'] |</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- &gt;     representable1 f &amp;&amp;</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- &gt;     t' == argVar        -&gt; Rec1 f</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- &gt;   App f [t'] |</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- &gt;     representable1 f &amp;&amp;</span><span>
</span><a name="line-468"></a><span class="hs-comment">-- &gt;     t' has tyvars       -&gt; f :.: (arg t')</span><span>
</span><a name="line-469"></a><span class="hs-comment">-- &gt;   _                     -&gt; Rec0 t</span><span>
</span><a name="line-470"></a><span class="hs-comment">--</span><span>
</span><a name="line-471"></a><span class="hs-comment">-- where @argVar@ is the last type variable in the data type declaration we are</span><span>
</span><a name="line-472"></a><span class="hs-comment">-- finding the representation for.</span><span>
</span><a name="line-473"></a><span class="hs-comment">--</span><span>
</span><a name="line-474"></a><span class="hs-comment">-- @argTyFold@ is more general than @arg@ because it uses 'ArgTyAlg' to</span><span>
</span><a name="line-475"></a><span class="hs-comment">-- abstract out the concrete invocations of @Par0@, @Rec0@, @Par1@, @Rec1@, and</span><span>
</span><a name="line-476"></a><span class="hs-comment">-- @:.:@.</span><span>
</span><a name="line-477"></a><span class="hs-comment">--</span><span>
</span><a name="line-478"></a><span class="hs-comment">-- @argTyFold@ is safer than @arg@ because @arg@ would lead to a GHC panic for</span><span>
</span><a name="line-479"></a><span class="hs-comment">-- some data types. The problematic case is when @t@ is an application of a</span><span>
</span><a name="line-480"></a><span class="hs-comment">-- non-representable type @f@ to @argVar@: @App f [argVar]@ is caught by the</span><span>
</span><a name="line-481"></a><span class="hs-comment">-- @_@ pattern, and ends up represented as @Rec0 t@. This type occurs /free/ in</span><span>
</span><a name="line-482"></a><span class="hs-comment">-- the RHS of the eventual @Rep1@ instance, which is therefore ill-formed. Some</span><span>
</span><a name="line-483"></a><span class="hs-comment">-- representable1 checks have been relaxed, and others were moved to</span><span>
</span><a name="line-484"></a><span class="hs-comment">-- @canDoGenerics1@.</span><span>
</span><a name="line-485"></a><span class="hs-identifier">argTyFold</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621683326083"><a href="#local-6989586621683326083"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenGenerics.html#ArgTyAlg"><span class="hs-identifier hs-type">ArgTyAlg</span></a><span> </span><a href="#local-6989586621683326083"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326083"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-486"></a><a name="argTyFold"><a href="TcGenGenerics.html#argTyFold"><span class="hs-identifier">argTyFold</span></a></a><span> </span><a name="local-6989586621683326184"><a href="#local-6989586621683326184"><span class="hs-identifier">argVar</span></a></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#ArgTyAlg"><span class="hs-identifier hs-var">ArgTyAlg</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ata_rec0</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683326185"><a href="#local-6989586621683326185"><span class="hs-identifier">mkRec0</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-487"></a><span>                            </span><span class="hs-identifier">ata_par1</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683326186"><a href="#local-6989586621683326186"><span class="hs-identifier">mkPar1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ata_rec1</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683326187"><a href="#local-6989586621683326187"><span class="hs-identifier">mkRec1</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-488"></a><span>                            </span><span class="hs-identifier">ata_comp</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683326188"><a href="#local-6989586621683326188"><span class="hs-identifier">mkComp</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-489"></a><span>  </span><span class="hs-comment">-- mkRec0 is the default; use it if there is no interesting structure</span><span>
</span><a name="line-490"></a><span>  </span><span class="hs-comment">-- (e.g. occurrences of parameters or recursive occurrences)</span><span>
</span><a name="line-491"></a><span>  </span><span class="hs-glyph">\</span><a name="local-6989586621683326197"><a href="#local-6989586621683326197"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326185"><span class="hs-identifier hs-var">mkRec0</span></a><span> </span><a href="#local-6989586621683326197"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683326189"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683326197"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-492"></a><span>  </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- type to fold through</span><span>
</span><a name="line-493"></a><span>        </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621683326083"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-comment">-- the result (e.g. representation type), unless it's trivial</span><span>
</span><a name="line-494"></a><span>  </span><a name="local-6989586621683326189"><a href="#local-6989586621683326189"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621683326190"><a href="#local-6989586621683326190"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326191"><span class="hs-identifier hs-var">isParam</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mplus</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683326192"><span class="hs-identifier hs-var">isApp</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span>    </span><a name="local-6989586621683326191"><a href="#local-6989586621683326191"><span class="hs-identifier">isParam</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- handles parameters</span><span>
</span><a name="line-497"></a><span>      </span><a name="local-6989586621683326193"><a href="#local-6989586621683326193"><span class="hs-identifier">t'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getTyVar_maybe</span><span> </span><a href="#local-6989586621683326190"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-498"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683326193"><span class="hs-identifier hs-var">t'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683326184"><span class="hs-identifier hs-var">argVar</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683326186"><span class="hs-identifier hs-var">mkPar1</span></a><span> </span><span class="hs-comment">-- moreover, it is &quot;the&quot; parameter</span><span>
</span><a name="line-499"></a><span>             </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683326185"><span class="hs-identifier hs-var">mkRec0</span></a><span> </span><a href="#local-6989586621683326190"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-comment">-- NB mkRec0 instead of the conventional mkPar0</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>    </span><a name="local-6989586621683326192"><a href="#local-6989586621683326192"><span class="hs-identifier">isApp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- handles applications</span><span>
</span><a name="line-502"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621683326194"><a href="#local-6989586621683326194"><span class="hs-identifier">phi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326195"><a href="#local-6989586621683326195"><span class="hs-identifier">beta</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitAppTy_maybe</span><span> </span><a href="#local-6989586621683326190"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683326196"><a href="#local-6989586621683326196"><span class="hs-identifier">interesting</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326184"><span class="hs-identifier hs-var">argVar</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">exactTyCoVarsOfType</span><span> </span><a href="#local-6989586621683326195"><span class="hs-identifier hs-var">beta</span></a><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span>      </span><span class="hs-comment">-- Does it have no interesting structure to represent?</span><span>
</span><a name="line-507"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621683326196"><span class="hs-identifier hs-var">interesting</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-508"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- Is the argument the parameter? Special case for mkRec1.</span><span>
</span><a name="line-509"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683326184"><span class="hs-identifier hs-var">argVar</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">getTyVar_maybe</span><span> </span><a href="#local-6989586621683326195"><span class="hs-identifier hs-var">beta</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683326187"><span class="hs-identifier hs-var">mkRec1</span></a><span> </span><a href="#local-6989586621683326194"><span class="hs-identifier hs-var">phi</span></a><span>
</span><a name="line-510"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683326188"><span class="hs-identifier hs-var">mkComp</span></a><span> </span><a href="#local-6989586621683326194"><span class="hs-identifier hs-var">phi</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683326189"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683326195"><span class="hs-identifier hs-var">beta</span></a><span> </span><span class="hs-comment">-- It must be a composition.</span><span>
</span><a name="line-511"></a><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span class="hs-identifier">tc_mkRepTy</span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="hs-comment">-- Gen0_ or Gen1_, for Rep or Rep1</span><span>
</span><a name="line-514"></a><span>               </span><a href="TcGenGenerics.html#GenericKind_"><span class="hs-identifier hs-type">GenericKind_</span></a><span>
</span><a name="line-515"></a><span>              </span><span class="hs-comment">-- The type to generate representation for</span><span>
</span><a name="line-516"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-517"></a><span>              </span><span class="hs-comment">-- The kind of the representation type's argument</span><span>
</span><a name="line-518"></a><span>              </span><span class="hs-comment">-- See Note [Handling kinds in a Rep instance]</span><span>
</span><a name="line-519"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>
</span><a name="line-520"></a><span>               </span><span class="hs-comment">-- Generated representation0 type</span><span>
</span><a name="line-521"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-522"></a><a name="tc_mkRepTy"><a href="TcGenGenerics.html#tc_mkRepTy"><span class="hs-identifier">tc_mkRepTy</span></a></a><span> </span><a name="local-6989586621683326198"><a href="#local-6989586621683326198"><span class="hs-identifier">gk_</span></a></a><span> </span><a name="local-6989586621683326199"><a href="#local-6989586621683326199"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621683326200"><a href="#local-6989586621683326200"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-523"></a><span>  </span><span class="hs-keyword">do</span><span>
</span><a name="line-524"></a><span>    </span><a name="local-6989586621683326201"><a href="#local-6989586621683326201"><span class="hs-identifier">d1</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">d1TyConName</span><span>
</span><a name="line-525"></a><span>    </span><a name="local-6989586621683326202"><a href="#local-6989586621683326202"><span class="hs-identifier">c1</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">c1TyConName</span><span>
</span><a name="line-526"></a><span>    </span><a name="local-6989586621683326203"><a href="#local-6989586621683326203"><span class="hs-identifier">s1</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">s1TyConName</span><span>
</span><a name="line-527"></a><span>    </span><a name="local-6989586621683326204"><a href="#local-6989586621683326204"><span class="hs-identifier">rec0</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">rec0TyConName</span><span>
</span><a name="line-528"></a><span>    </span><a name="local-6989586621683326205"><a href="#local-6989586621683326205"><span class="hs-identifier">rec1</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">rec1TyConName</span><span>
</span><a name="line-529"></a><span>    </span><a name="local-6989586621683326206"><a href="#local-6989586621683326206"><span class="hs-identifier">par1</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">par1TyConName</span><span>
</span><a name="line-530"></a><span>    </span><a name="local-6989586621683326207"><a href="#local-6989586621683326207"><span class="hs-identifier">u1</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">u1TyConName</span><span>
</span><a name="line-531"></a><span>    </span><a name="local-6989586621683326208"><a href="#local-6989586621683326208"><span class="hs-identifier">v1</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">v1TyConName</span><span>
</span><a name="line-532"></a><span>    </span><a name="local-6989586621683326209"><a href="#local-6989586621683326209"><span class="hs-identifier">plus</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">sumTyConName</span><span>
</span><a name="line-533"></a><span>    </span><a name="local-6989586621683326210"><a href="#local-6989586621683326210"><span class="hs-identifier">times</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">prodTyConName</span><span>
</span><a name="line-534"></a><span>    </span><a name="local-6989586621683326211"><a href="#local-6989586621683326211"><span class="hs-identifier">comp</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">compTyConName</span><span>
</span><a name="line-535"></a><span>    </span><a name="local-6989586621683326212"><a href="#local-6989586621683326212"><span class="hs-identifier">uAddr</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">uAddrTyConName</span><span>
</span><a name="line-536"></a><span>    </span><a name="local-6989586621683326213"><a href="#local-6989586621683326213"><span class="hs-identifier">uChar</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">uCharTyConName</span><span>
</span><a name="line-537"></a><span>    </span><a name="local-6989586621683326214"><a href="#local-6989586621683326214"><span class="hs-identifier">uDouble</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">uDoubleTyConName</span><span>
</span><a name="line-538"></a><span>    </span><a name="local-6989586621683326215"><a href="#local-6989586621683326215"><span class="hs-identifier">uFloat</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">uFloatTyConName</span><span>
</span><a name="line-539"></a><span>    </span><a name="local-6989586621683326216"><a href="#local-6989586621683326216"><span class="hs-identifier">uInt</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">uIntTyConName</span><span>
</span><a name="line-540"></a><span>    </span><a name="local-6989586621683326217"><a href="#local-6989586621683326217"><span class="hs-identifier">uWord</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">uWordTyConName</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683326218"><a href="#local-6989586621683326218"><span class="hs-identifier">tcLookupPromDataCon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">promoteDataCon</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcEnv.html#tcLookupDataCon"><span class="hs-identifier hs-var">tcLookupDataCon</span></a><span>
</span><a name="line-543"></a><span>
</span><a name="line-544"></a><span>    </span><a name="local-6989586621683326219"><a href="#local-6989586621683326219"><span class="hs-identifier">md</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">metaDataDataConName</span><span>
</span><a name="line-545"></a><span>    </span><a name="local-6989586621683326220"><a href="#local-6989586621683326220"><span class="hs-identifier">mc</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">metaConsDataConName</span><span>
</span><a name="line-546"></a><span>    </span><a name="local-6989586621683326221"><a href="#local-6989586621683326221"><span class="hs-identifier">ms</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">metaSelDataConName</span><span>
</span><a name="line-547"></a><span>    </span><a name="local-6989586621683326222"><a href="#local-6989586621683326222"><span class="hs-identifier">pPrefix</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">prefixIDataConName</span><span>
</span><a name="line-548"></a><span>    </span><a name="local-6989586621683326223"><a href="#local-6989586621683326223"><span class="hs-identifier">pInfix</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">infixIDataConName</span><span>
</span><a name="line-549"></a><span>    </span><a name="local-6989586621683326224"><a href="#local-6989586621683326224"><span class="hs-identifier">pLA</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">leftAssociativeDataConName</span><span>
</span><a name="line-550"></a><span>    </span><a name="local-6989586621683326225"><a href="#local-6989586621683326225"><span class="hs-identifier">pRA</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">rightAssociativeDataConName</span><span>
</span><a name="line-551"></a><span>    </span><a name="local-6989586621683326226"><a href="#local-6989586621683326226"><span class="hs-identifier">pNA</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">notAssociativeDataConName</span><span>
</span><a name="line-552"></a><span>    </span><a name="local-6989586621683326227"><a href="#local-6989586621683326227"><span class="hs-identifier">pSUpk</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">sourceUnpackDataConName</span><span>
</span><a name="line-553"></a><span>    </span><a name="local-6989586621683326228"><a href="#local-6989586621683326228"><span class="hs-identifier">pSNUpk</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">sourceNoUnpackDataConName</span><span>
</span><a name="line-554"></a><span>    </span><a name="local-6989586621683326229"><a href="#local-6989586621683326229"><span class="hs-identifier">pNSUpkness</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">noSourceUnpackednessDataConName</span><span>
</span><a name="line-555"></a><span>    </span><a name="local-6989586621683326230"><a href="#local-6989586621683326230"><span class="hs-identifier">pSLzy</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">sourceLazyDataConName</span><span>
</span><a name="line-556"></a><span>    </span><a name="local-6989586621683326231"><a href="#local-6989586621683326231"><span class="hs-identifier">pSStr</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">sourceStrictDataConName</span><span>
</span><a name="line-557"></a><span>    </span><a name="local-6989586621683326232"><a href="#local-6989586621683326232"><span class="hs-identifier">pNSStrness</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">noSourceStrictnessDataConName</span><span>
</span><a name="line-558"></a><span>    </span><a name="local-6989586621683326233"><a href="#local-6989586621683326233"><span class="hs-identifier">pDLzy</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">decidedLazyDataConName</span><span>
</span><a name="line-559"></a><span>    </span><a name="local-6989586621683326234"><a href="#local-6989586621683326234"><span class="hs-identifier">pDStr</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">decidedStrictDataConName</span><span>
</span><a name="line-560"></a><span>    </span><a name="local-6989586621683326235"><a href="#local-6989586621683326235"><span class="hs-identifier">pDUpk</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683326218"><span class="hs-identifier hs-var">tcLookupPromDataCon</span></a><span> </span><span class="hs-identifier hs-var">decidedUnpackDataConName</span><span>
</span><a name="line-561"></a><span>
</span><a name="line-562"></a><span>    </span><a name="local-6989586621683326236"><a href="#local-6989586621683326236"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier hs-var">getFixityEnv</span></a><span>
</span><a name="line-563"></a><span>
</span><a name="line-564"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683326237"><a href="#local-6989586621683326237"><span class="hs-identifier">mkSum'</span></a></a><span> </span><a name="local-6989586621683326262"><a href="#local-6989586621683326262"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683326263"><a href="#local-6989586621683326263"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326209"><span class="hs-identifier hs-var">plus</span></a><span>  </span><span class="hs-special">[</span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621683326262"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621683326263"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-565"></a><span>        </span><a name="local-6989586621683326238"><a href="#local-6989586621683326238"><span class="hs-identifier">mkProd</span></a></a><span> </span><a name="local-6989586621683326264"><a href="#local-6989586621683326264"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683326265"><a href="#local-6989586621683326265"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326210"><span class="hs-identifier hs-var">times</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621683326264"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621683326265"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-566"></a><span>        </span><a name="local-6989586621683326239"><a href="#local-6989586621683326239"><span class="hs-identifier">mkRec0</span></a></a><span> </span><a name="local-6989586621683326266"><a href="#local-6989586621683326266"><span class="hs-identifier">a</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkBoxTy"><span class="hs-identifier hs-var">mkBoxTy</span></a><span> </span><a href="#local-6989586621683326212"><span class="hs-identifier hs-var">uAddr</span></a><span> </span><a href="#local-6989586621683326213"><span class="hs-identifier hs-var">uChar</span></a><span> </span><a href="#local-6989586621683326214"><span class="hs-identifier hs-var">uDouble</span></a><span> </span><a href="#local-6989586621683326215"><span class="hs-identifier hs-var">uFloat</span></a><span> </span><a href="#local-6989586621683326216"><span class="hs-identifier hs-var">uInt</span></a><span> </span><a href="#local-6989586621683326217"><span class="hs-identifier hs-var">uWord</span></a><span> </span><a href="#local-6989586621683326204"><span class="hs-identifier hs-var">rec0</span></a><span> </span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621683326266"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-567"></a><span>        </span><a name="local-6989586621683326240"><a href="#local-6989586621683326240"><span class="hs-identifier">mkRec1</span></a></a><span> </span><a name="local-6989586621683326267"><a href="#local-6989586621683326267"><span class="hs-identifier">a</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326205"><span class="hs-identifier hs-var">rec1</span></a><span>  </span><span class="hs-special">[</span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621683326267"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-568"></a><span>        </span><a name="local-6989586621683326241"><a href="#local-6989586621683326241"><span class="hs-identifier">mkPar1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span>  </span><a href="#local-6989586621683326206"><span class="hs-identifier hs-var">par1</span></a><span>
</span><a name="line-569"></a><span>        </span><a name="local-6989586621683326242"><a href="#local-6989586621683326242"><span class="hs-identifier">mkD</span></a></a><span>    </span><a name="local-6989586621683326268"><a href="#local-6989586621683326268"><span class="hs-identifier">a</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326201"><span class="hs-identifier hs-var">d1</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326259"><span class="hs-identifier hs-var">metaDataTy</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326245"><span class="hs-identifier hs-var">sumP</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683326268"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-570"></a><span>        </span><a name="local-6989586621683326243"><a href="#local-6989586621683326243"><span class="hs-identifier">mkC</span></a></a><span>      </span><a name="local-6989586621683326269"><a href="#local-6989586621683326269"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326202"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-571"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326260"><span class="hs-identifier hs-var">metaConsTy</span></a><span> </span><a href="#local-6989586621683326269"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-572"></a><span>                                   </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326246"><span class="hs-identifier hs-var">prod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConInstOrigArgTys</span><span> </span><a href="#local-6989586621683326269"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-573"></a><span>                                            </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683326199"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConSrcBangs</span><span>    </span><a href="#local-6989586621683326269"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-575"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConImplBangs</span><span>   </span><a href="#local-6989586621683326269"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConFieldLabels</span><span> </span><a href="#local-6989586621683326269"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-577"></a><span>        </span><a name="local-6989586621683326244"><a href="#local-6989586621683326244"><span class="hs-identifier">mkS</span></a></a><span> </span><a name="local-6989586621683326270"><a href="#local-6989586621683326270"><span class="hs-identifier">mlbl</span></a></a><span> </span><a name="local-6989586621683326271"><a href="#local-6989586621683326271"><span class="hs-identifier">su</span></a></a><span> </span><a name="local-6989586621683326272"><a href="#local-6989586621683326272"><span class="hs-identifier">ss</span></a></a><span> </span><a name="local-6989586621683326273"><a href="#local-6989586621683326273"><span class="hs-identifier">ib</span></a></a><span> </span><a name="local-6989586621683326274"><a href="#local-6989586621683326274"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326203"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326261"><span class="hs-identifier hs-var">metaSelTy</span></a><span> </span><a href="#local-6989586621683326270"><span class="hs-identifier hs-var">mlbl</span></a><span> </span><a href="#local-6989586621683326271"><span class="hs-identifier hs-var">su</span></a><span> </span><a href="#local-6989586621683326272"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621683326273"><span class="hs-identifier hs-var">ib</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326274"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-578"></a><span>
</span><a name="line-579"></a><span>        </span><span class="hs-comment">-- Sums and products are done in the same way for both Rep and Rep1</span><span>
</span><a name="line-580"></a><span>        </span><a name="local-6989586621683326245"><a href="#local-6989586621683326245"><span class="hs-identifier">sumP</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326208"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-581"></a><span>        </span><span class="hs-identifier">sumP</span><span> </span><a name="local-6989586621683326275"><a href="#local-6989586621683326275"><span class="hs-identifier">l</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#foldBal"><span class="hs-identifier hs-var">foldBal</span></a><span> </span><a href="#local-6989586621683326237"><span class="hs-identifier hs-var">mkSum'</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683326243"><span class="hs-identifier hs-var">mkC</span></a><span>  </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683326275"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-582"></a><span>        </span><span class="hs-comment">-- The Bool is True if this constructor has labelled fields</span><span>
</span><a name="line-583"></a><span>        </span><span class="hs-identifier">prod</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HsSrcBang</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">HsImplBang</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-584"></a><span>        </span><a name="local-6989586621683326246"><a href="#local-6989586621683326246"><span class="hs-identifier">prod</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326207"><span class="hs-identifier hs-var">u1</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-585"></a><span>        </span><span class="hs-identifier">prod</span><span> </span><a name="local-6989586621683326276"><a href="#local-6989586621683326276"><span class="hs-identifier">l</span></a></a><span>  </span><a name="local-6989586621683326277"><a href="#local-6989586621683326277"><span class="hs-identifier">sb</span></a></a><span> </span><a name="local-6989586621683326278"><a href="#local-6989586621683326278"><span class="hs-identifier">ib</span></a></a><span> </span><a name="local-6989586621683326279"><a href="#local-6989586621683326279"><span class="hs-identifier">fl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#foldBal"><span class="hs-identifier hs-var">foldBal</span></a><span> </span><a href="#local-6989586621683326238"><span class="hs-identifier hs-var">mkProd</span></a><span>
</span><a name="line-586"></a><span>                                   </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">fl</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-identifier">lengthExceeds</span><span> </span><span class="hs-identifier hs-var">fl</span><span> </span><span class="hs-identifier hs-var">j</span><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>                                     </span><a href="#local-6989586621683326247"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621683326280"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621683326281"><span class="hs-identifier hs-var">sb'</span></a><span> </span><a href="#local-6989586621683326282"><span class="hs-identifier hs-var">ib'</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683326279"><span class="hs-identifier hs-var">fl</span></a><span>
</span><a name="line-588"></a><span>                                                       </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-589"></a><span>                                                       </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326279"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><a href="#local-6989586621683326283"><span class="hs-identifier hs-var">j</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>                                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326280"><a href="#local-6989586621683326280"><span class="hs-identifier">t</span></a></a><span class="hs-special">,</span><a name="local-6989586621683326281"><a href="#local-6989586621683326281"><span class="hs-identifier">sb'</span></a></a><span class="hs-special">,</span><a name="local-6989586621683326282"><a href="#local-6989586621683326282"><span class="hs-identifier">ib'</span></a></a><span class="hs-special">,</span><a name="local-6989586621683326283"><a href="#local-6989586621683326283"><span class="hs-identifier">j</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip4</span><span> </span><a href="#local-6989586621683326276"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683326277"><span class="hs-identifier hs-var">sb</span></a><span> </span><a href="#local-6989586621683326278"><span class="hs-identifier hs-var">ib</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span>        </span><span class="hs-identifier">arg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsSrcBang</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsImplBang</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FieldLabel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-593"></a><span>        </span><a name="local-6989586621683326247"><a href="#local-6989586621683326247"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621683326284"><a href="#local-6989586621683326284"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSrcBang</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326285"><a href="#local-6989586621683326285"><span class="hs-identifier">su</span></a></a><span> </span><a name="local-6989586621683326286"><a href="#local-6989586621683326286"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683326287"><a href="#local-6989586621683326287"><span class="hs-identifier">ib</span></a></a><span> </span><a name="local-6989586621683326288"><a href="#local-6989586621683326288"><span class="hs-identifier">fl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326244"><span class="hs-identifier hs-var">mkS</span></a><span> </span><a href="#local-6989586621683326288"><span class="hs-identifier hs-var">fl</span></a><span> </span><a href="#local-6989586621683326285"><span class="hs-identifier hs-var">su</span></a><span> </span><a href="#local-6989586621683326286"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621683326287"><span class="hs-identifier hs-var">ib</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326198"><span class="hs-identifier hs-var">gk_</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-594"></a><span>            </span><span class="hs-comment">-- Here we previously used Par0 if t was a type variable, but we</span><span>
</span><a name="line-595"></a><span>            </span><span class="hs-comment">-- realized that we can't always guarantee that we are wrapping-up</span><span>
</span><a name="line-596"></a><span>            </span><span class="hs-comment">-- all type variables in Par0. So we decided to stop using Par0</span><span>
</span><a name="line-597"></a><span>            </span><span class="hs-comment">-- altogether, and use Rec0 all the time.</span><span>
</span><a name="line-598"></a><span>                      </span><a href="TcGenGenerics.html#Gen0_"><span class="hs-identifier hs-var">Gen0_</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326239"><span class="hs-identifier hs-var">mkRec0</span></a><span> </span><a href="#local-6989586621683326284"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-599"></a><span>                      </span><a href="TcGenGenerics.html#Gen1_"><span class="hs-identifier hs-var">Gen1_</span></a><span> </span><a name="local-6989586621683326291"><a href="#local-6989586621683326291"><span class="hs-identifier">argVar</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326289"><span class="hs-identifier hs-var">argPar</span></a><span> </span><a href="#local-6989586621683326291"><span class="hs-identifier hs-var">argVar</span></a><span> </span><a href="#local-6989586621683326284"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-600"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-601"></a><span>            </span><span class="hs-comment">-- Builds argument representation for Rep1 (more complicated due to</span><span>
</span><a name="line-602"></a><span>            </span><span class="hs-comment">-- the presence of composition).</span><span>
</span><a name="line-603"></a><span>            </span><a name="local-6989586621683326289"><a href="#local-6989586621683326289"><span class="hs-identifier">argPar</span></a></a><span> </span><a name="local-6989586621683326290"><a href="#local-6989586621683326290"><span class="hs-identifier">argVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#argTyFold"><span class="hs-identifier hs-var">argTyFold</span></a><span> </span><a href="#local-6989586621683326290"><span class="hs-identifier hs-var">argVar</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcGenGenerics.html#ArgTyAlg"><span class="hs-identifier hs-var">ArgTyAlg</span></a><span>
</span><a name="line-604"></a><span>              </span><span class="hs-special">{</span><span class="hs-identifier">ata_rec0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326239"><span class="hs-identifier hs-var">mkRec0</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ata_par1</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326241"><span class="hs-identifier hs-var">mkPar1</span></a><span class="hs-special">,</span><span>
</span><a name="line-605"></a><span>               </span><span class="hs-identifier">ata_rec1</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326240"><span class="hs-identifier hs-var">mkRec1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ata_comp</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkComp"><span class="hs-identifier hs-var">mkComp</span></a><span> </span><a href="#local-6989586621683326211"><span class="hs-identifier hs-var">comp</span></a><span> </span><a href="#local-6989586621683326200"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">}</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>        </span><a name="local-6989586621683326248"><a href="#local-6989586621683326248"><span class="hs-identifier">tyConName_user</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tyConFamInst_maybe</span><span> </span><a href="#local-6989586621683326199"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-608"></a><span>                           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326292"><a href="#local-6989586621683326292"><span class="hs-identifier">ptycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683326292"><span class="hs-identifier hs-var">ptycon</span></a><span>
</span><a name="line-609"></a><span>                           </span><span class="hs-identifier hs-var">Nothing</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683326199"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span>        </span><a name="local-6989586621683326249"><a href="#local-6989586621683326249"><span class="hs-identifier">dtName</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683326248"><span class="hs-identifier hs-var">tyConName_user</span></a><span>
</span><a name="line-612"></a><span>        </span><a name="local-6989586621683326250"><a href="#local-6989586621683326250"><span class="hs-identifier">mdName</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">moduleNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">moduleName</span><span>
</span><a name="line-613"></a><span>                </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683326199"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-614"></a><span>        </span><a name="local-6989586621683326251"><a href="#local-6989586621683326251"><span class="hs-identifier">pkgName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unitIdFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">moduleUnitId</span><span>
</span><a name="line-615"></a><span>                </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683326199"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-616"></a><span>        </span><a name="local-6989586621683326252"><a href="#local-6989586621683326252"><span class="hs-identifier">isNT</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isNewTyCon</span><span> </span><a href="#local-6989586621683326199"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-617"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">promotedTrueDataCon</span><span>
</span><a name="line-618"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">promotedFalseDataCon</span><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><span>        </span><a name="local-6989586621683326253"><a href="#local-6989586621683326253"><span class="hs-identifier">ctName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">dataConName</span><span>
</span><a name="line-621"></a><span>        </span><a name="local-6989586621683326254"><a href="#local-6989586621683326254"><span class="hs-identifier">ctFix</span></a></a><span> </span><a name="local-6989586621683326293"><a href="#local-6989586621683326293"><span class="hs-identifier">c</span></a></a><span>
</span><a name="line-622"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">dataConIsInfix</span><span> </span><a href="#local-6989586621683326293"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-623"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupFixity</span><span> </span><a href="#local-6989586621683326236"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621683326293"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-624"></a><span>                   </span><span class="hs-identifier hs-var">Fixity</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326294"><a href="#local-6989586621683326294"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier hs-var">InfixL</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326255"><span class="hs-identifier hs-var">buildFix</span></a><span> </span><a href="#local-6989586621683326294"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683326224"><span class="hs-identifier hs-var">pLA</span></a><span>
</span><a name="line-625"></a><span>                   </span><span class="hs-identifier hs-var">Fixity</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326295"><a href="#local-6989586621683326295"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier hs-var">InfixR</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326255"><span class="hs-identifier hs-var">buildFix</span></a><span> </span><a href="#local-6989586621683326295"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683326225"><span class="hs-identifier hs-var">pRA</span></a><span>
</span><a name="line-626"></a><span>                   </span><span class="hs-identifier hs-var">Fixity</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326296"><a href="#local-6989586621683326296"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier hs-var">InfixN</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326255"><span class="hs-identifier hs-var">buildFix</span></a><span> </span><a href="#local-6989586621683326296"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621683326226"><span class="hs-identifier hs-var">pNA</span></a><span>
</span><a name="line-627"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><a href="#local-6989586621683326222"><span class="hs-identifier hs-var">pPrefix</span></a><span>
</span><a name="line-628"></a><span>        </span><a name="local-6989586621683326255"><a href="#local-6989586621683326255"><span class="hs-identifier">buildFix</span></a></a><span> </span><a name="local-6989586621683326297"><a href="#local-6989586621683326297"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683326298"><a href="#local-6989586621683326298"><span class="hs-identifier">assoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326223"><span class="hs-identifier hs-var">pInfix</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><a href="#local-6989586621683326298"><span class="hs-identifier hs-var">assoc</span></a><span>
</span><a name="line-629"></a><span>                                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkNumLitTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><a href="#local-6989586621683326297"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span>        </span><a name="local-6989586621683326256"><a href="#local-6989586621683326256"><span class="hs-identifier">isRec</span></a></a><span> </span><a name="local-6989586621683326299"><a href="#local-6989586621683326299"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">dataConFieldLabels</span><span> </span><a href="#local-6989586621683326299"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthExceeds</span><span class="hs-special">`</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-632"></a><span>                              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">promotedTrueDataCon</span><span>
</span><a name="line-633"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">promotedFalseDataCon</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span>        </span><a name="local-6989586621683326257"><a href="#local-6989586621683326257"><span class="hs-identifier">selName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkStrLitTy</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">flLabel</span><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span>        </span><a name="local-6989586621683326258"><a href="#local-6989586621683326258"><span class="hs-identifier">mbSel</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-identifier hs-var">promotedNothingDataCon</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">typeSymbolKind</span><span class="hs-special">]</span><span>
</span><a name="line-638"></a><span>        </span><span class="hs-identifier">mbSel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683326300"><a href="#local-6989586621683326300"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><span class="hs-identifier hs-var">promotedJustDataCon</span><span>
</span><a name="line-639"></a><span>                                    </span><span class="hs-special">[</span><span class="hs-identifier hs-var">typeSymbolKind</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326257"><span class="hs-identifier hs-var">selName</span></a><span> </span><a href="#local-6989586621683326300"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">]</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span>        </span><a name="local-6989586621683326259"><a href="#local-6989586621683326259"><span class="hs-identifier">metaDataTy</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326219"><span class="hs-identifier hs-var">md</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326249"><span class="hs-identifier hs-var">dtName</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326250"><span class="hs-identifier hs-var">mdName</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326251"><span class="hs-identifier hs-var">pkgName</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326252"><span class="hs-identifier hs-var">isNT</span></a><span class="hs-special">]</span><span>
</span><a name="line-642"></a><span>        </span><a name="local-6989586621683326260"><a href="#local-6989586621683326260"><span class="hs-identifier">metaConsTy</span></a></a><span> </span><a name="local-6989586621683326301"><a href="#local-6989586621683326301"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326220"><span class="hs-identifier hs-var">mc</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326253"><span class="hs-identifier hs-var">ctName</span></a><span> </span><a href="#local-6989586621683326301"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326254"><span class="hs-identifier hs-var">ctFix</span></a><span> </span><a href="#local-6989586621683326301"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326256"><span class="hs-identifier hs-var">isRec</span></a><span> </span><a href="#local-6989586621683326301"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">]</span><span>
</span><a name="line-643"></a><span>        </span><a name="local-6989586621683326261"><a href="#local-6989586621683326261"><span class="hs-identifier">metaSelTy</span></a></a><span> </span><a name="local-6989586621683326302"><a href="#local-6989586621683326302"><span class="hs-identifier">mlbl</span></a></a><span> </span><a name="local-6989586621683326303"><a href="#local-6989586621683326303"><span class="hs-identifier">su</span></a></a><span> </span><a name="local-6989586621683326304"><a href="#local-6989586621683326304"><span class="hs-identifier">ss</span></a></a><span> </span><a name="local-6989586621683326305"><a href="#local-6989586621683326305"><span class="hs-identifier">ib</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-644"></a><span>            </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326221"><span class="hs-identifier hs-var">ms</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326258"><span class="hs-identifier hs-var">mbSel</span></a><span> </span><a href="#local-6989586621683326302"><span class="hs-identifier hs-var">mlbl</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326306"><span class="hs-identifier hs-var">pSUpkness</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326307"><span class="hs-identifier hs-var">pSStrness</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326308"><span class="hs-identifier hs-var">pDStrness</span></a><span class="hs-special">]</span><span>
</span><a name="line-645"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-646"></a><span>            </span><a name="local-6989586621683326306"><a href="#local-6989586621683326306"><span class="hs-identifier">pSUpkness</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326303"><span class="hs-identifier hs-var">su</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-647"></a><span>                                         </span><span class="hs-identifier hs-var">SrcUnpack</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326227"><span class="hs-identifier hs-var">pSUpk</span></a><span>
</span><a name="line-648"></a><span>                                         </span><span class="hs-identifier hs-var">SrcNoUnpack</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326228"><span class="hs-identifier hs-var">pSNUpk</span></a><span>
</span><a name="line-649"></a><span>                                         </span><span class="hs-identifier hs-var">NoSrcUnpack</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326229"><span class="hs-identifier hs-var">pNSUpkness</span></a><span>
</span><a name="line-650"></a><span>
</span><a name="line-651"></a><span>            </span><a name="local-6989586621683326307"><a href="#local-6989586621683326307"><span class="hs-identifier">pSStrness</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326304"><span class="hs-identifier hs-var">ss</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-652"></a><span>                                         </span><span class="hs-identifier hs-var">SrcLazy</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326230"><span class="hs-identifier hs-var">pSLzy</span></a><span>
</span><a name="line-653"></a><span>                                         </span><span class="hs-identifier hs-var">SrcStrict</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326231"><span class="hs-identifier hs-var">pSStr</span></a><span>
</span><a name="line-654"></a><span>                                         </span><span class="hs-identifier hs-var">NoSrcStrict</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326232"><span class="hs-identifier hs-var">pNSStrness</span></a><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span>            </span><a name="local-6989586621683326308"><a href="#local-6989586621683326308"><span class="hs-identifier">pDStrness</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326305"><span class="hs-identifier hs-var">ib</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-657"></a><span>                                         </span><span class="hs-identifier hs-var">HsLazy</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326233"><span class="hs-identifier hs-var">pDLzy</span></a><span>
</span><a name="line-658"></a><span>                                         </span><span class="hs-identifier hs-var">HsStrict</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326234"><span class="hs-identifier hs-var">pDStr</span></a><span>
</span><a name="line-659"></a><span>                                         </span><span class="hs-identifier hs-var">HsUnpack</span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326235"><span class="hs-identifier hs-var">pDUpk</span></a><span>
</span><a name="line-660"></a><span>
</span><a name="line-661"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326242"><span class="hs-identifier hs-var">mkD</span></a><span> </span><a href="#local-6989586621683326199"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span>
</span><a name="line-662"></a><span>
</span><a name="line-663"></a><span class="hs-identifier">mkComp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-664"></a><a name="mkComp"><a href="TcGenGenerics.html#mkComp"><span class="hs-identifier">mkComp</span></a></a><span> </span><a name="local-6989586621683326309"><a href="#local-6989586621683326309"><span class="hs-identifier">comp</span></a></a><span> </span><a name="local-6989586621683326310"><a href="#local-6989586621683326310"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621683326311"><a href="#local-6989586621683326311"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621683326312"><a href="#local-6989586621683326312"><span class="hs-identifier">g</span></a></a><span>
</span><a name="line-665"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326313"><span class="hs-identifier hs-var">k1_first</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326309"><span class="hs-identifier hs-var">comp</span></a><span>  </span><span class="hs-special">[</span><a href="#local-6989586621683326310"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">,</span><a href="#local-6989586621683326311"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><a href="#local-6989586621683326312"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">]</span><span>
</span><a name="line-666"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326309"><span class="hs-identifier hs-var">comp</span></a><span>  </span><span class="hs-special">[</span><span class="hs-identifier hs-var">liftedTypeKind</span><span class="hs-special">,</span><a href="#local-6989586621683326310"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621683326311"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><a href="#local-6989586621683326312"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">]</span><span>
</span><a name="line-667"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-668"></a><span>    </span><span class="hs-comment">-- Which of these is the case?</span><span>
</span><a name="line-669"></a><span>    </span><span class="hs-comment">--     newtype (:.:) {k1} {k2} (f :: k2-&gt;*) (g :: k1-&gt;k2) (p :: k1) = ...</span><span>
</span><a name="line-670"></a><span>    </span><span class="hs-comment">-- or  newtype (:.:) {k2} {k1} (f :: k2-&gt;*) (g :: k1-&gt;k2) (p :: k1) = ...</span><span>
</span><a name="line-671"></a><span>    </span><span class="hs-comment">-- We want to instantiate with k1=k, and k2=*</span><span>
</span><a name="line-672"></a><span>    </span><span class="hs-comment">--    Reason for k2=*: see Note [Handling kinds in a Rep instance]</span><span>
</span><a name="line-673"></a><span>    </span><span class="hs-comment">-- But we need to know which way round!</span><span>
</span><a name="line-674"></a><span>    </span><a name="local-6989586621683326313"><a href="#local-6989586621683326313"><span class="hs-identifier">k1_first</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326314"><span class="hs-identifier hs-var">k_first</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683326316"><span class="hs-identifier hs-var">p_kind_var</span></a><span>
</span><a name="line-675"></a><span>    </span><span class="hs-special">[</span><a name="local-6989586621683326314"><a href="#local-6989586621683326314"><span class="hs-identifier">k_first</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621683326315"><a href="#local-6989586621683326315"><span class="hs-identifier">p</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683326309"><span class="hs-identifier hs-var">comp</span></a><span>
</span><a name="line-676"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683326316"><a href="#local-6989586621683326316"><span class="hs-identifier">p_kind_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getTyVar_maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyVarKind</span><span> </span><a href="#local-6989586621683326315"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-677"></a><span>
</span><a name="line-678"></a><span class="hs-comment">-- Given the TyCons for each URec-related type synonym, check to see if the</span><span>
</span><a name="line-679"></a><span class="hs-comment">-- given type is an unlifted type that generics understands. If so, return</span><span>
</span><a name="line-680"></a><span class="hs-comment">-- its representation type. Otherwise, return Rec0.</span><span>
</span><a name="line-681"></a><span class="hs-comment">-- See Note [Generics and unlifted types]</span><span>
</span><a name="line-682"></a><span class="hs-identifier">mkBoxTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-comment">-- UAddr</span><span>
</span><a name="line-683"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-comment">-- UChar</span><span>
</span><a name="line-684"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-comment">-- UDouble</span><span>
</span><a name="line-685"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-comment">-- UFloat</span><span>
</span><a name="line-686"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-comment">-- UInt</span><span>
</span><a name="line-687"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-comment">-- UWord</span><span>
</span><a name="line-688"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-comment">-- Rec0</span><span>
</span><a name="line-689"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Kind</span><span>  </span><span class="hs-comment">-- What to instantiate Rec0's kind variable with</span><span>
</span><a name="line-690"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-691"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-692"></a><a name="mkBoxTy"><a href="TcGenGenerics.html#mkBoxTy"><span class="hs-identifier">mkBoxTy</span></a></a><span> </span><a name="local-6989586621683326317"><a href="#local-6989586621683326317"><span class="hs-identifier">uAddr</span></a></a><span> </span><a name="local-6989586621683326318"><a href="#local-6989586621683326318"><span class="hs-identifier">uChar</span></a></a><span> </span><a name="local-6989586621683326319"><a href="#local-6989586621683326319"><span class="hs-identifier">uDouble</span></a></a><span> </span><a name="local-6989586621683326320"><a href="#local-6989586621683326320"><span class="hs-identifier">uFloat</span></a></a><span> </span><a name="local-6989586621683326321"><a href="#local-6989586621683326321"><span class="hs-identifier">uInt</span></a></a><span> </span><a name="local-6989586621683326322"><a href="#local-6989586621683326322"><span class="hs-identifier">uWord</span></a></a><span> </span><a name="local-6989586621683326323"><a href="#local-6989586621683326323"><span class="hs-identifier">rec0</span></a></a><span> </span><a name="local-6989586621683326324"><a href="#local-6989586621683326324"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621683326325"><a href="#local-6989586621683326325"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-693"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326325"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">addrPrimTy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326317"><span class="hs-identifier hs-var">uAddr</span></a><span>   </span><span class="hs-special">[</span><a href="#local-6989586621683326324"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-694"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326325"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">charPrimTy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326318"><span class="hs-identifier hs-var">uChar</span></a><span>   </span><span class="hs-special">[</span><a href="#local-6989586621683326324"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-695"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326325"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">doublePrimTy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326319"><span class="hs-identifier hs-var">uDouble</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326324"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-696"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326325"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">floatPrimTy</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326320"><span class="hs-identifier hs-var">uFloat</span></a><span>  </span><span class="hs-special">[</span><a href="#local-6989586621683326324"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-697"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326325"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">intPrimTy</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326321"><span class="hs-identifier hs-var">uInt</span></a><span>    </span><span class="hs-special">[</span><a href="#local-6989586621683326324"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-698"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326325"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">wordPrimTy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326322"><span class="hs-identifier hs-var">uWord</span></a><span>   </span><span class="hs-special">[</span><a href="#local-6989586621683326324"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">]</span><span>
</span><a name="line-699"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683326323"><span class="hs-identifier hs-var">rec0</span></a><span>    </span><span class="hs-special">[</span><a href="#local-6989586621683326324"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621683326325"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-700"></a><span>
</span><a name="line-701"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-702"></a><span class="hs-comment">-- Dealing with sums</span><span>
</span><a name="line-703"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-704"></a><span>
</span><a name="line-705"></a><span class="hs-identifier">mkSum</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind_"><span class="hs-identifier hs-type">GenericKind_</span></a><span> </span><span class="hs-comment">-- Generic or Generic1?</span><span>
</span><a name="line-706"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenGenerics.html#US"><span class="hs-identifier hs-type">US</span></a><span>          </span><span class="hs-comment">-- Base for generating unique names</span><span>
</span><a name="line-707"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- The data constructors</span><span>
</span><a name="line-708"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcGenGenerics.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Alternatives for the T-&gt;Trep &quot;from&quot; function</span><span>
</span><a name="line-709"></a><span>          </span><span class="hs-special">[</span><a href="TcGenGenerics.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Alternatives for the Trep-&gt;T &quot;to&quot; function</span><span>
</span><a name="line-710"></a><span>
</span><a name="line-711"></a><span class="hs-comment">-- Datatype without any constructors</span><span>
</span><a name="line-712"></a><a name="mkSum"><a href="TcGenGenerics.html#mkSum"><span class="hs-identifier">mkSum</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621683326326"><span class="hs-identifier hs-var">from_alt</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326327"><span class="hs-identifier hs-var">to_alt</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-713"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-714"></a><span>    </span><a name="local-6989586621683326326"><a href="#local-6989586621683326326"><span class="hs-identifier">from_alt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#x_Pat"><span class="hs-identifier hs-var">x_Pat</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nlHsCase</span><span> </span><a href="TcGenGenerics.html#x_Expr"><span class="hs-identifier hs-var">x_Expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>    </span><a name="local-6989586621683326327"><a href="#local-6989586621683326327"><span class="hs-identifier">to_alt</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#x_Pat"><span class="hs-identifier hs-var">x_Pat</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nlHsCase</span><span> </span><a href="TcGenGenerics.html#x_Expr"><span class="hs-identifier hs-var">x_Expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>               </span><span class="hs-comment">-- These M1s are meta-information for the datatype</span><span>
</span><a name="line-717"></a><span>
</span><a name="line-718"></a><span class="hs-comment">-- Datatype with at least one constructor</span><span>
</span><a name="line-719"></a><span class="hs-identifier">mkSum</span><span> </span><a name="local-6989586621683326328"><a href="#local-6989586621683326328"><span class="hs-identifier">gk_</span></a></a><span> </span><a name="local-6989586621683326329"><a href="#local-6989586621683326329"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621683326330"><a href="#local-6989586621683326330"><span class="hs-identifier">datacons</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-720"></a><span>  </span><span class="hs-comment">-- switch the payload of gk_ to be datacon-centric instead of tycon-centric</span><span>
</span><a name="line-721"></a><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-special">[</span><span> </span><a href="TcGenGenerics.html#mk1Sum"><span class="hs-identifier hs-var">mk1Sum</span></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#gk2gkDC"><span class="hs-identifier hs-var">gk2gkDC</span></a><span> </span><a href="#local-6989586621683326328"><span class="hs-identifier hs-var">gk_</span></a><span> </span><a href="#local-6989586621683326331"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326329"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="#local-6989586621683326332"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683326330"><span class="hs-identifier hs-var">datacons</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326331"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-722"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326331"><a href="#local-6989586621683326331"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><a name="local-6989586621683326332"><a href="#local-6989586621683326332"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621683326330"><span class="hs-identifier hs-var">datacons</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span class="hs-comment">-- Build the sum for a particular constructor</span><span>
</span><a name="line-725"></a><span class="hs-identifier">mk1Sum</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind_DC"><span class="hs-identifier hs-type">GenericKind_DC</span></a><span> </span><span class="hs-comment">-- Generic or Generic1?</span><span>
</span><a name="line-726"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenGenerics.html#US"><span class="hs-identifier hs-type">US</span></a><span>        </span><span class="hs-comment">-- Base for generating unique names</span><span>
</span><a name="line-727"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>       </span><span class="hs-comment">-- The index of this constructor</span><span>
</span><a name="line-728"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>       </span><span class="hs-comment">-- Total number of constructors</span><span>
</span><a name="line-729"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>   </span><span class="hs-comment">-- The data constructor</span><span>
</span><a name="line-730"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Alternative for the T-&gt;Trep &quot;from&quot; function</span><span>
</span><a name="line-731"></a><span>           </span><a href="TcGenGenerics.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Alternative for the Trep-&gt;T &quot;to&quot; function</span><span>
</span><a name="line-732"></a><a name="mk1Sum"><a href="TcGenGenerics.html#mk1Sum"><span class="hs-identifier">mk1Sum</span></a></a><span> </span><a name="local-6989586621683326333"><a href="#local-6989586621683326333"><span class="hs-identifier">gk_</span></a></a><span> </span><a name="local-6989586621683326334"><a href="#local-6989586621683326334"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621683326335"><a href="#local-6989586621683326335"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621683326336"><a href="#local-6989586621683326336"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683326337"><a href="#local-6989586621683326337"><span class="hs-identifier">datacon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326345"><span class="hs-identifier hs-var">from_alt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326347"><span class="hs-identifier hs-var">to_alt</span></a><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-734"></a><span>    </span><a name="local-6989586621683326338"><a href="#local-6989586621683326338"><span class="hs-identifier">gk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#forgetArgVar"><span class="hs-identifier hs-var">forgetArgVar</span></a><span> </span><a href="#local-6989586621683326333"><span class="hs-identifier hs-var">gk_</span></a><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span>    </span><span class="hs-comment">-- Existentials already excluded</span><span>
</span><a name="line-737"></a><span>    </span><a name="local-6989586621683326339"><a href="#local-6989586621683326339"><span class="hs-identifier">argTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConOrigArgTys</span><span> </span><a href="#local-6989586621683326337"><span class="hs-identifier hs-var">datacon</span></a><span>
</span><a name="line-738"></a><span>    </span><a name="local-6989586621683326340"><a href="#local-6989586621683326340"><span class="hs-identifier">n_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConSourceArity</span><span> </span><a href="#local-6989586621683326337"><span class="hs-identifier hs-var">datacon</span></a><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span>    </span><a name="local-6989586621683326341"><a href="#local-6989586621683326341"><span class="hs-identifier">datacon_varTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcGenGenerics.html#mkGenericLocal"><span class="hs-identifier hs-var">mkGenericLocal</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326334"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621683326334"><span class="hs-identifier hs-var">us</span></a><span class="hs-operator hs-var">+</span><a href="#local-6989586621683326340"><span class="hs-identifier hs-var">n_args</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326339"><span class="hs-identifier hs-var">argTys</span></a><span>
</span><a name="line-741"></a><span>    </span><a name="local-6989586621683326342"><a href="#local-6989586621683326342"><span class="hs-identifier">datacon_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621683326341"><span class="hs-identifier hs-var">datacon_varTys</span></a><span>
</span><a name="line-742"></a><span>    </span><a name="local-6989586621683326343"><a href="#local-6989586621683326343"><span class="hs-identifier">us'</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326334"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621683326340"><span class="hs-identifier hs-var">n_args</span></a><span>
</span><a name="line-743"></a><span>
</span><a name="line-744"></a><span>    </span><a name="local-6989586621683326344"><a href="#local-6989586621683326344"><span class="hs-identifier">datacon_rdr</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getRdrName</span><span> </span><a href="#local-6989586621683326337"><span class="hs-identifier hs-var">datacon</span></a><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span>    </span><a name="local-6989586621683326345"><a href="#local-6989586621683326345"><span class="hs-identifier">from_alt</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlConVarPat</span><span> </span><a href="#local-6989586621683326344"><span class="hs-identifier hs-var">datacon_rdr</span></a><span> </span><a href="#local-6989586621683326342"><span class="hs-identifier hs-var">datacon_vars</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326346"><span class="hs-identifier hs-var">from_alt_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-747"></a><span>    </span><a name="local-6989586621683326346"><a href="#local-6989586621683326346"><span class="hs-identifier">from_alt_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#genLR_E"><span class="hs-identifier hs-var">genLR_E</span></a><span> </span><a href="#local-6989586621683326335"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621683326336"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#mkProd_E"><span class="hs-identifier hs-var">mkProd_E</span></a><span> </span><a href="#local-6989586621683326333"><span class="hs-identifier hs-var">gk_</span></a><span> </span><a href="#local-6989586621683326343"><span class="hs-identifier hs-var">us'</span></a><span> </span><a href="#local-6989586621683326341"><span class="hs-identifier hs-var">datacon_varTys</span></a><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span>    </span><a name="local-6989586621683326347"><a href="#local-6989586621683326347"><span class="hs-identifier">to_alt</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcGenGenerics.html#genLR_P"><span class="hs-identifier hs-var">genLR_P</span></a><span> </span><a href="#local-6989586621683326335"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621683326336"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#mkProd_P"><span class="hs-identifier hs-var">mkProd_P</span></a><span> </span><a href="#local-6989586621683326338"><span class="hs-identifier hs-var">gk</span></a><span> </span><a href="#local-6989586621683326343"><span class="hs-identifier hs-var">us'</span></a><span> </span><a href="#local-6989586621683326341"><span class="hs-identifier hs-var">datacon_varTys</span></a><span class="hs-special">)</span><span>
</span><a name="line-750"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326348"><span class="hs-identifier hs-var">to_alt_rhs</span></a><span>
</span><a name="line-751"></a><span>                 </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- These M1s are meta-information for the datatype</span><span>
</span><a name="line-752"></a><span>    </span><a name="local-6989586621683326348"><a href="#local-6989586621683326348"><span class="hs-identifier">to_alt_rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683326333"><span class="hs-identifier hs-var">gk_</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-753"></a><span>      </span><a href="TcGenGenerics.html#Gen0_DC"><span class="hs-identifier hs-var">Gen0_DC</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nlHsVarApps</span><span> </span><a href="#local-6989586621683326344"><span class="hs-identifier hs-var">datacon_rdr</span></a><span> </span><a href="#local-6989586621683326342"><span class="hs-identifier hs-var">datacon_vars</span></a><span>
</span><a name="line-754"></a><span>      </span><a href="TcGenGenerics.html#Gen1_DC"><span class="hs-identifier hs-var">Gen1_DC</span></a><span> </span><a name="local-6989586621683326349"><a href="#local-6989586621683326349"><span class="hs-identifier">argVar</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nlHsApps</span><span> </span><a href="#local-6989586621683326344"><span class="hs-identifier hs-var">datacon_rdr</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683326350"><span class="hs-identifier hs-var">argTo</span></a><span> </span><a href="#local-6989586621683326341"><span class="hs-identifier hs-var">datacon_varTys</span></a><span>
</span><a name="line-755"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-756"></a><span>          </span><a name="local-6989586621683326350"><a href="#local-6989586621683326350"><span class="hs-identifier">argTo</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683326351"><a href="#local-6989586621683326351"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326352"><a href="#local-6989586621683326352"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326353"><span class="hs-identifier hs-var">converter</span></a><span> </span><a href="#local-6989586621683326352"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683326351"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-757"></a><span>            </span><a name="local-6989586621683326353"><a href="#local-6989586621683326353"><span class="hs-identifier">converter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#argTyFold"><span class="hs-identifier hs-var">argTyFold</span></a><span> </span><a href="#local-6989586621683326349"><span class="hs-identifier hs-var">argVar</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcGenGenerics.html#ArgTyAlg"><span class="hs-identifier hs-var">ArgTyAlg</span></a><span>
</span><a name="line-758"></a><span>              </span><span class="hs-special">{</span><span class="hs-identifier">ata_rec0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcGenGenerics.html#unboxRepRDR"><span class="hs-identifier hs-var">unboxRepRDR</span></a><span class="hs-special">,</span><span>
</span><a name="line-759"></a><span>               </span><span class="hs-identifier">ata_par1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">unPar1_RDR</span><span class="hs-special">,</span><span>
</span><a name="line-760"></a><span>               </span><span class="hs-identifier">ata_rec1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">unRec1_RDR</span><span class="hs-special">,</span><span>
</span><a name="line-761"></a><span>               </span><span class="hs-identifier">ata_comp</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326354"><a href="#local-6989586621683326354"><span class="hs-identifier">cnv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">fmap_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683326354"><span class="hs-identifier hs-var">cnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>                                    </span><span class="hs-special">`</span><a href="TcGenGenerics.html#nlHsCompose"><span class="hs-identifier hs-var">nlHsCompose</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">unComp1_RDR</span><span class="hs-special">}</span><span>
</span><a name="line-763"></a><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span class="hs-comment">-- Generates the L1/R1 sum pattern</span><span>
</span><a name="line-766"></a><span class="hs-identifier">genLR_P</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-767"></a><a name="genLR_P"><a href="TcGenGenerics.html#genLR_P"><span class="hs-identifier">genLR_P</span></a></a><span> </span><a name="local-6989586621683326355"><a href="#local-6989586621683326355"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621683326356"><a href="#local-6989586621683326356"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683326357"><a href="#local-6989586621683326357"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-768"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326356"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;impossible&quot;</span><span>
</span><a name="line-769"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326356"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326357"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-770"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326355"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier hs-var">div</span><span> </span><a href="#local-6989586621683326356"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlParPat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlConPat</span><span> </span><span class="hs-identifier hs-var">l1DataCon_RDR</span><span> </span><span class="hs-special">[</span><a href="TcGenGenerics.html#genLR_P"><span class="hs-identifier hs-var">genLR_P</span></a><span> </span><a href="#local-6989586621683326355"><span class="hs-identifier hs-var">i</span></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">div</span><span> </span><a href="#local-6989586621683326356"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326357"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">]</span><span>
</span><a name="line-771"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlParPat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlConPat</span><span> </span><span class="hs-identifier hs-var">r1DataCon_RDR</span><span> </span><span class="hs-special">[</span><a href="TcGenGenerics.html#genLR_P"><span class="hs-identifier hs-var">genLR_P</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326355"><span class="hs-identifier hs-var">i</span></a><span class="hs-glyph">-</span><a href="#local-6989586621683326358"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326356"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><a href="#local-6989586621683326358"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>     </span><a href="#local-6989586621683326357"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">]</span><span>
</span><a name="line-772"></a><span>                     </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683326358"><a href="#local-6989586621683326358"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">div</span><span> </span><a href="#local-6989586621683326356"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><span class="hs-comment">-- Generates the L1/R1 sum expression</span><span>
</span><a name="line-775"></a><span class="hs-identifier">genLR_E</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-776"></a><a name="genLR_E"><a href="TcGenGenerics.html#genLR_E"><span class="hs-identifier">genLR_E</span></a></a><span> </span><a name="local-6989586621683326359"><a href="#local-6989586621683326359"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621683326360"><a href="#local-6989586621683326360"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621683326361"><a href="#local-6989586621683326361"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-777"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326360"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;impossible&quot;</span><span>
</span><a name="line-778"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326360"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326361"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-779"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326359"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier hs-var">div</span><span> </span><a href="#local-6989586621683326360"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">l1DataCon_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span>
</span><a name="line-780"></a><span>                                            </span><span class="hs-identifier hs-var">nlHsPar</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#genLR_E"><span class="hs-identifier hs-var">genLR_E</span></a><span> </span><a href="#local-6989586621683326359"><span class="hs-identifier hs-var">i</span></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">div</span><span> </span><a href="#local-6989586621683326360"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326361"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-781"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">r1DataCon_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span>
</span><a name="line-782"></a><span>                                            </span><span class="hs-identifier hs-var">nlHsPar</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#genLR_E"><span class="hs-identifier hs-var">genLR_E</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326359"><span class="hs-identifier hs-var">i</span></a><span class="hs-glyph">-</span><a href="#local-6989586621683326362"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326360"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><a href="#local-6989586621683326362"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>     </span><a href="#local-6989586621683326361"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>                     </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683326362"><a href="#local-6989586621683326362"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">div</span><span> </span><a href="#local-6989586621683326360"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-786"></a><span class="hs-comment">-- Dealing with products</span><span>
</span><a name="line-787"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span class="hs-comment">-- Build a product expression</span><span>
</span><a name="line-790"></a><span class="hs-identifier">mkProd_E</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind_DC"><span class="hs-identifier hs-type">GenericKind_DC</span></a><span>    </span><span class="hs-comment">-- Generic or Generic1?</span><span>
</span><a name="line-791"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenGenerics.html#US"><span class="hs-identifier hs-type">US</span></a><span>                </span><span class="hs-comment">-- Base for unique names</span><span>
</span><a name="line-792"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-793"></a><span>                       </span><span class="hs-comment">-- List of variables matched on the lhs and their types</span><span>
</span><a name="line-794"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>   </span><span class="hs-comment">-- Resulting product expression</span><span>
</span><a name="line-795"></a><a name="mkProd_E"><a href="TcGenGenerics.html#mkProd_E"><span class="hs-identifier">mkProd_E</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkM1_E"><span class="hs-identifier hs-var">mkM1_E</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">u1DataCon_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-796"></a><span class="hs-identifier">mkProd_E</span><span> </span><a name="local-6989586621683326363"><a href="#local-6989586621683326363"><span class="hs-identifier">gk_</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326364"><a href="#local-6989586621683326364"><span class="hs-identifier">varTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkM1_E"><span class="hs-identifier hs-var">mkM1_E</span></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#foldBal"><span class="hs-identifier hs-var">foldBal</span></a><span> </span><a href="#local-6989586621683326366"><span class="hs-identifier hs-var">prod</span></a><span> </span><a href="#local-6989586621683326365"><span class="hs-identifier hs-var">appVars</span></a><span class="hs-special">)</span><span>
</span><a name="line-797"></a><span>                     </span><span class="hs-comment">-- These M1s are meta-information for the constructor</span><span>
</span><a name="line-798"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-799"></a><span>    </span><a name="local-6989586621683326365"><a href="#local-6989586621683326365"><span class="hs-identifier">appVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#wrapArg_E"><span class="hs-identifier hs-var">wrapArg_E</span></a><span> </span><a href="#local-6989586621683326363"><span class="hs-identifier hs-var">gk_</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326364"><span class="hs-identifier hs-var">varTys</span></a><span>
</span><a name="line-800"></a><span>    </span><a name="local-6989586621683326366"><a href="#local-6989586621683326366"><span class="hs-identifier">prod</span></a></a><span> </span><a name="local-6989586621683326367"><a href="#local-6989586621683326367"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683326368"><a href="#local-6989586621683326368"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">prodDataCon_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApps</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326367"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621683326368"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-801"></a><span>
</span><a name="line-802"></a><span class="hs-identifier">wrapArg_E</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind_DC"><span class="hs-identifier hs-type">GenericKind_DC</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-803"></a><a name="wrapArg_E"><a href="TcGenGenerics.html#wrapArg_E"><span class="hs-identifier">wrapArg_E</span></a></a><span> </span><a href="TcGenGenerics.html#Gen0_DC"><span class="hs-identifier hs-var">Gen0_DC</span></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621683326369"><a href="#local-6989586621683326369"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326370"><a href="#local-6989586621683326370"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkM1_E"><span class="hs-identifier hs-var">mkM1_E</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-804"></a><span>                            </span><a href="TcGenGenerics.html#boxRepRDR"><span class="hs-identifier hs-var">boxRepRDR</span></a><span> </span><a href="#local-6989586621683326370"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsVarApps</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326369"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">]</span><span>
</span><a name="line-805"></a><span>                         </span><span class="hs-comment">-- This M1 is meta-information for the selector</span><span>
</span><a name="line-806"></a><span class="hs-identifier">wrapArg_E</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#Gen1_DC"><span class="hs-identifier hs-var">Gen1_DC</span></a><span> </span><a name="local-6989586621683326371"><a href="#local-6989586621683326371"><span class="hs-identifier">argVar</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326372"><a href="#local-6989586621683326372"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683326373"><a href="#local-6989586621683326373"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkM1_E"><span class="hs-identifier hs-var">mkM1_E</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-807"></a><span>                            </span><a href="#local-6989586621683326374"><span class="hs-identifier hs-var">converter</span></a><span> </span><a href="#local-6989586621683326373"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683326372"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-808"></a><span>                         </span><span class="hs-comment">-- This M1 is meta-information for the selector</span><span>
</span><a name="line-809"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621683326374"><a href="#local-6989586621683326374"><span class="hs-identifier">converter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#argTyFold"><span class="hs-identifier hs-var">argTyFold</span></a><span> </span><a href="#local-6989586621683326371"><span class="hs-identifier hs-var">argVar</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcGenGenerics.html#ArgTyAlg"><span class="hs-identifier hs-var">ArgTyAlg</span></a><span>
</span><a name="line-810"></a><span>          </span><span class="hs-special">{</span><span class="hs-identifier">ata_rec0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcGenGenerics.html#boxRepRDR"><span class="hs-identifier hs-var">boxRepRDR</span></a><span class="hs-special">,</span><span>
</span><a name="line-811"></a><span>           </span><span class="hs-identifier">ata_par1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">par1DataCon_RDR</span><span class="hs-special">,</span><span>
</span><a name="line-812"></a><span>           </span><span class="hs-identifier">ata_rec1</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">rec1DataCon_RDR</span><span class="hs-special">,</span><span>
</span><a name="line-813"></a><span>           </span><span class="hs-identifier">ata_comp</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326375"><a href="#local-6989586621683326375"><span class="hs-identifier">cnv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">comp1DataCon_RDR</span><span> </span><span class="hs-special">`</span><a href="TcGenGenerics.html#nlHsCompose"><span class="hs-identifier hs-var">nlHsCompose</span></a><span class="hs-special">`</span><span>
</span><a name="line-814"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">fmap_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683326375"><span class="hs-identifier hs-var">cnv</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-815"></a><span>
</span><a name="line-816"></a><span class="hs-identifier">boxRepRDR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-817"></a><a name="boxRepRDR"><a href="TcGenGenerics.html#boxRepRDR"><span class="hs-identifier">boxRepRDR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">k1DataCon_RDR</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcGenGenerics.html#unboxedRepRDRs"><span class="hs-identifier hs-var">unboxedRepRDRs</span></a><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-identifier">unboxRepRDR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-820"></a><a name="unboxRepRDR"><a href="TcGenGenerics.html#unboxRepRDR"><span class="hs-identifier">unboxRepRDR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">unK1_RDR</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcGenGenerics.html#unboxedRepRDRs"><span class="hs-identifier hs-var">unboxedRepRDRs</span></a><span>
</span><a name="line-821"></a><span>
</span><a name="line-822"></a><span class="hs-comment">-- Retrieve the RDRs associated with each URec data family instance</span><span>
</span><a name="line-823"></a><span class="hs-comment">-- constructor. See Note [Generics and unlifted types]</span><span>
</span><a name="line-824"></a><span class="hs-identifier">unboxedRepRDRs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">)</span><span>
</span><a name="line-825"></a><a name="unboxedRepRDRs"><a href="TcGenGenerics.html#unboxedRepRDRs"><span class="hs-identifier">unboxedRepRDRs</span></a></a><span> </span><a name="local-6989586621683326376"><a href="#local-6989586621683326376"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-826"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326376"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">addrPrimTy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uAddrDataCon_RDR</span><span class="hs-special">,</span><span>   </span><span class="hs-identifier hs-var">uAddrHash_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-827"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326376"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">charPrimTy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uCharDataCon_RDR</span><span class="hs-special">,</span><span>   </span><span class="hs-identifier hs-var">uCharHash_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-828"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326376"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">doublePrimTy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uDoubleDataCon_RDR</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">uDoubleHash_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326376"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">floatPrimTy</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uFloatDataCon_RDR</span><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-var">uFloatHash_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326376"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">intPrimTy</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uIntDataCon_RDR</span><span class="hs-special">,</span><span>    </span><span class="hs-identifier hs-var">uIntHash_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-831"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683326376"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">wordPrimTy</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uWordDataCon_RDR</span><span class="hs-special">,</span><span>   </span><span class="hs-identifier hs-var">uWordHash_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-832"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span class="hs-comment">-- Build a product pattern</span><span>
</span><a name="line-835"></a><span class="hs-identifier">mkProd_P</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind"><span class="hs-identifier hs-type">GenericKind</span></a><span>       </span><span class="hs-comment">-- Gen0 or Gen1</span><span>
</span><a name="line-836"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenGenerics.html#US"><span class="hs-identifier hs-type">US</span></a><span>                </span><span class="hs-comment">-- Base for unique names</span><span>
</span><a name="line-837"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RdrName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- List of variables to match,</span><span>
</span><a name="line-838"></a><span>                              </span><span class="hs-comment">--   along with their types</span><span>
</span><a name="line-839"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>      </span><span class="hs-comment">-- Resulting product pattern</span><span>
</span><a name="line-840"></a><a name="mkProd_P"><a href="TcGenGenerics.html#mkProd_P"><span class="hs-identifier">mkProd_P</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkM1_P"><span class="hs-identifier hs-var">mkM1_P</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlNullaryConPat</span><span> </span><span class="hs-identifier hs-var">u1DataCon_RDR</span><span class="hs-special">)</span><span>
</span><a name="line-841"></a><span class="hs-identifier">mkProd_P</span><span> </span><a name="local-6989586621683326377"><a href="#local-6989586621683326377"><span class="hs-identifier">gk</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683326378"><a href="#local-6989586621683326378"><span class="hs-identifier">varTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkM1_P"><span class="hs-identifier hs-var">mkM1_P</span></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#foldBal"><span class="hs-identifier hs-var">foldBal</span></a><span> </span><a href="#local-6989586621683326380"><span class="hs-identifier hs-var">prod</span></a><span> </span><a href="#local-6989586621683326379"><span class="hs-identifier hs-var">appVars</span></a><span class="hs-special">)</span><span>
</span><a name="line-842"></a><span>                     </span><span class="hs-comment">-- These M1s are meta-information for the constructor</span><span>
</span><a name="line-843"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-844"></a><span>    </span><a name="local-6989586621683326379"><a href="#local-6989586621683326379"><span class="hs-identifier">appVars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzipWith</span><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#wrapArg_P"><span class="hs-identifier hs-var">wrapArg_P</span></a><span> </span><a href="#local-6989586621683326377"><span class="hs-identifier hs-var">gk</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326378"><span class="hs-identifier hs-var">varTys</span></a><span>
</span><a name="line-845"></a><span>    </span><a name="local-6989586621683326380"><a href="#local-6989586621683326380"><span class="hs-identifier">prod</span></a></a><span> </span><a name="local-6989586621683326381"><a href="#local-6989586621683326381"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621683326382"><a href="#local-6989586621683326382"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlParPat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">prodDataCon_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlConPat</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326381"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621683326382"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span class="hs-identifier">wrapArg_P</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#GenericKind"><span class="hs-identifier hs-type">GenericKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-848"></a><a name="wrapArg_P"><a href="TcGenGenerics.html#wrapArg_P"><span class="hs-identifier">wrapArg_P</span></a></a><span> </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span> </span><a name="local-6989586621683326383"><a href="#local-6989586621683326383"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621683326384"><a href="#local-6989586621683326384"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#mkM1_P"><span class="hs-identifier hs-var">mkM1_P</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlParPat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcGenGenerics.html#boxRepRDR"><span class="hs-identifier hs-var">boxRepRDR</span></a><span> </span><a href="#local-6989586621683326384"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlConVarPat</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326383"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>                   </span><span class="hs-comment">-- This M1 is meta-information for the selector</span><span>
</span><a name="line-850"></a><span class="hs-identifier">wrapArg_P</span><span> </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span> </span><a name="local-6989586621683326385"><a href="#local-6989586621683326385"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlParPat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">m1DataCon_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlConVarPat</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326385"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span class="hs-identifier">mkGenericLocal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcGenGenerics.html#US"><span class="hs-identifier hs-type">US</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-853"></a><a name="mkGenericLocal"><a href="TcGenGenerics.html#mkGenericLocal"><span class="hs-identifier">mkGenericLocal</span></a></a><span> </span><a name="local-6989586621683326386"><a href="#local-6989586621683326386"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarUnqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;g&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621683326386"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-854"></a><span>
</span><a name="line-855"></a><span class="hs-identifier">x_RDR</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-856"></a><a name="x_RDR"><a href="TcGenGenerics.html#x_RDR"><span class="hs-identifier">x_RDR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarUnqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;x&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span class="hs-identifier">x_Expr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-859"></a><a name="x_Expr"><a href="TcGenGenerics.html#x_Expr"><span class="hs-identifier">x_Expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="TcGenGenerics.html#x_RDR"><span class="hs-identifier hs-var">x_RDR</span></a><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span class="hs-identifier">x_Pat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-862"></a><a name="x_Pat"><a href="TcGenGenerics.html#x_Pat"><span class="hs-identifier">x_Pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlVarPat</span><span> </span><a href="TcGenGenerics.html#x_RDR"><span class="hs-identifier hs-var">x_RDR</span></a><span>
</span><a name="line-863"></a><span>
</span><a name="line-864"></a><span class="hs-identifier">mkM1_E</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-865"></a><a name="mkM1_E"><a href="TcGenGenerics.html#mkM1_E"><span class="hs-identifier">mkM1_E</span></a></a><span> </span><a name="local-6989586621683326387"><a href="#local-6989586621683326387"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">m1DataCon_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApp</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683326387"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-866"></a><span>
</span><a name="line-867"></a><span class="hs-identifier">mkM1_P</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-868"></a><a name="mkM1_P"><a href="TcGenGenerics.html#mkM1_P"><span class="hs-identifier">mkM1_P</span></a></a><span> </span><a name="local-6989586621683326388"><a href="#local-6989586621683326388"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlParPat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">m1DataCon_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlConPat</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326388"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">]</span><span>
</span><a name="line-869"></a><span>
</span><a name="line-870"></a><span class="hs-identifier">nlHsCompose</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-871"></a><a name="nlHsCompose"><a href="TcGenGenerics.html#nlHsCompose"><span class="hs-identifier">nlHsCompose</span></a></a><span> </span><a name="local-6989586621683326389"><a href="#local-6989586621683326389"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683326390"><a href="#local-6989586621683326390"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">compose_RDR</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">nlHsApps</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326389"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683326390"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">]</span><span>
</span><a name="line-872"></a><span>
</span><a name="line-873"></a><span class="hs-comment">-- | Variant of foldr1 for producing balanced lists</span><span>
</span><a name="line-874"></a><span class="hs-identifier">foldBal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326082"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326082"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326082"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326082"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326082"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-875"></a><a name="foldBal"><a href="TcGenGenerics.html#foldBal"><span class="hs-identifier">foldBal</span></a></a><span> </span><a name="local-6989586621683326391"><a href="#local-6989586621683326391"><span class="hs-identifier">op</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#foldBal%27"><span class="hs-identifier hs-var">foldBal'</span></a><span> </span><a href="#local-6989586621683326391"><span class="hs-identifier hs-var">op</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;foldBal: empty list&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-876"></a><span>
</span><a name="line-877"></a><span class="hs-identifier">foldBal'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683326081"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326081"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326081"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326081"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683326081"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683326081"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-878"></a><a name="foldBal%27"><a href="TcGenGenerics.html#foldBal%27"><span class="hs-identifier">foldBal'</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><a name="local-6989586621683326392"><a href="#local-6989586621683326392"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326392"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-879"></a><span class="hs-identifier">foldBal'</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683326393"><a href="#local-6989586621683326393"><span class="hs-identifier">y</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683326393"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-880"></a><span class="hs-identifier">foldBal'</span><span> </span><a name="local-6989586621683326394"><a href="#local-6989586621683326394"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621683326395"><a href="#local-6989586621683326395"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683326396"><a href="#local-6989586621683326396"><span class="hs-identifier">l</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683326397"><a href="#local-6989586621683326397"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621683326398"><a href="#local-6989586621683326398"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683326396"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">div</span><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683326396"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-881"></a><span>                    </span><span class="hs-keyword">in</span><span> </span><a href="TcGenGenerics.html#foldBal%27"><span class="hs-identifier hs-var">foldBal'</span></a><span> </span><a href="#local-6989586621683326394"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621683326395"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683326397"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621683326394"><span class="hs-identifier hs-var">op</span></a><span class="hs-special">`</span><span> </span><a href="TcGenGenerics.html#foldBal%27"><span class="hs-identifier hs-var">foldBal'</span></a><span> </span><a href="#local-6989586621683326394"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621683326395"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683326398"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-882"></a><span>
</span><a name="line-883"></a><span class="hs-comment">{-
Note [Generics and unlifted types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Normally, all constants are marked with K1/Rec0. The exception to this rule is
when a data constructor has an unlifted argument (e.g., Int#, Char#, etc.). In
that case, we must use a data family instance of URec (from GHC.Generics) to
mark it. As a result, before we can generate K1 or unK1, we must first check
to see if the type is actually one of the unlifted types for which URec has a
data family instance; if so, we generate that instead.

See wiki:Commentary/Compiler/GenericDeriving#Handlingunliftedtypes for more
details on why URec is implemented the way it is.

Note [Generating a correctly typed Rep instance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
tc_mkRepTy derives the RHS of the Rep(1) type family instance when deriving
Generic(1). That is, it derives the ellipsis in the following:

    instance Generic Foo where
      type Rep Foo = ...

However, tc_mkRepTy only has knowledge of the *TyCon* of the type for which
a Generic(1) instance is being derived, not the fully instantiated type. As a
result, tc_mkRepTy builds the most generalized Rep(1) instance possible using
the type variables it learns from the TyCon (i.e., it uses tyConTyVars). This
can cause problems when the instance has instantiated type variables
(see Trac #11732). As an example:

    data T a = MkT a
    deriving instance Generic (T Int)
    ==&gt;
    instance Generic (T Int) where
      type Rep (T Int) = (... (Rec0 a)) -- wrong!

-XStandaloneDeriving is one way for the type variables to become instantiated.
Another way is when Generic1 is being derived for a datatype with a visible
kind binder, e.g.,

   data P k (a :: k) = MkP k deriving Generic1
   ==&gt;
   instance Generic1 (P *) where
     type Rep1 (P *) = (... (Rec0 k)) -- wrong!

See Note [Unify kinds in deriving] in TcDeriv.

In any such scenario, we must prevent a discrepancy between the LHS and RHS of
a Rep(1) instance. To do so, we create a type variable substitution that maps
the tyConTyVars of the TyCon to their counterparts in the fully instantiated
type. (For example, using T above as example, you'd map a :-&gt; Int.) We then
apply the substitution to the RHS before generating the instance.

A wrinkle in all of this: when forming the type variable substitution for
Generic1 instances, we map the last type variable of the tycon to Any. Why?
It's because of wily data types like this one (#15012):

   data T a = MkT (FakeOut a)
   type FakeOut a = Int

If we ignore a, then we'll produce the following Rep1 instance:

   instance Generic1 T where
     type Rep1 T = ... (Rec0 (FakeOut a))
     ...

Oh no! Now we have `a` on the RHS, but it's completely unbound. Instead, we
ensure that `a` is mapped to Any:

   instance Generic1 T where
     type Rep1 T = ... (Rec0 (FakeOut Any))
     ...

And now all is good.

Alternatively, we could have avoided this problem by expanding all type
synonyms on the RHSes of Rep1 instances. But we might blow up the size of
these types even further by doing this, so we choose not to do so.

Note [Handling kinds in a Rep instance]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Because Generic1 is poly-kinded, the representation types were generalized to
be kind-polymorphic as well. As a result, tc_mkRepTy must explicitly apply
the kind of the instance being derived to all the representation type
constructors. For instance, if you have

    data Empty (a :: k) = Empty deriving Generic1

Then the generated code is now approximately (with -fprint-explicit-kinds
syntax):

    instance Generic1 k (Empty k) where
      type Rep1 k (Empty k) = U1 k

Most representation types have only one kind variable, making them easy to deal
with. The only non-trivial case is (:.:), which is only used in Generic1
instances:

    newtype (:.:) (f :: k2 -&gt; *) (g :: k1 -&gt; k2) (p :: k1) =
        Comp1 { unComp1 :: f (g p) }

Here, we do something a bit counter-intuitive: we make k1 be the kind of the
instance being derived, and we always make k2 be *. Why *? It's because
the code that GHC generates using (:.:) is always of the form x :.: Rec1 y
for some types x and y. In other words, the second type to which (:.:) is
applied always has kind k -&gt; *, for some kind k, so k2 cannot possibly be
anything other than * in a generated Generic1 instance.

Note [Generics compilation speed tricks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Deriving Generic(1) is known to have a large constant factor during
compilation, which contributes to noticeable compilation slowdowns when
deriving Generic(1) for large datatypes (see Trac #5642).

To ease the pain, there is a trick one can play when generating definitions for
to(1) and from(1). If you have a datatype like:

  data Letter = A | B | C | D

then a na&#239;ve Generic instance for Letter would be:

  instance Generic Letter where
    type Rep Letter = D1 ('MetaData ...) ...

    to (M1 (L1 (L1 (M1 U1)))) = A
    to (M1 (L1 (R1 (M1 U1)))) = B
    to (M1 (R1 (L1 (M1 U1)))) = C
    to (M1 (R1 (R1 (M1 U1)))) = D

    from A = M1 (L1 (L1 (M1 U1)))
    from B = M1 (L1 (R1 (M1 U1)))
    from C = M1 (R1 (L1 (M1 U1)))
    from D = M1 (R1 (R1 (M1 U1)))

Notice that in every LHS pattern-match of the 'to' definition, and in every RHS
expression in the 'from' definition, the topmost constructor is M1. This
corresponds to the datatype-specific metadata (the D1 in the Rep Letter
instance). But this is wasteful from a typechecking perspective, since this
definition requires GHC to typecheck an application of M1 in every single case,
leading to an O(n) increase in the number of coercions the typechecker has to
solve, which in turn increases allocations and degrades compilation speed.

Luckily, since the topmost M1 has the exact same type across every case, we can
factor it out reduce the typechecker's burden:

  instance Generic Letter where
    type Rep Letter = D1 ('MetaData ...) ...

    to (M1 x) = case x of
      L1 (L1 (M1 U1)) -&gt; A
      L1 (R1 (M1 U1)) -&gt; B
      R1 (L1 (M1 U1)) -&gt; C
      R1 (R1 (M1 U1)) -&gt; D

    from x = M1 (case x of
      A -&gt; L1 (L1 (M1 U1))
      B -&gt; L1 (R1 (M1 U1))
      C -&gt; R1 (L1 (M1 U1))
      D -&gt; R1 (R1 (M1 U1)))

A simple change, but one that pays off, since it goes turns an O(n) amount of
coercions to an O(1) amount.
-}</span><span>
</span><a name="line-1044"></a></pre></body></html>