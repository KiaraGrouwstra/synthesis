<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP, TypeFamilies #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-- Type definitions for the constraint solver</span><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcSMonad</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span>    </span><span class="hs-comment">-- The work list</span><span>
</span><a name="line-7"></a><span>    </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#isEmptyWorkList"><span class="hs-identifier hs-var">isEmptyWorkList</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#emptyWorkList"><span class="hs-identifier hs-var">emptyWorkList</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>    </span><a href="TcSMonad.html#extendWorkListNonEq"><span class="hs-identifier hs-var">extendWorkListNonEq</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#extendWorkListCt"><span class="hs-identifier hs-var">extendWorkListCt</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>    </span><a href="TcSMonad.html#extendWorkListCts"><span class="hs-identifier hs-var">extendWorkListCts</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#extendWorkListEq"><span class="hs-identifier hs-var">extendWorkListEq</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#extendWorkListFunEq"><span class="hs-identifier hs-var">extendWorkListFunEq</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>    </span><a href="TcSMonad.html#appendWorkList"><span class="hs-identifier hs-var">appendWorkList</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#extendWorkListImplic"><span class="hs-identifier hs-var">extendWorkListImplic</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>    </span><a href="TcSMonad.html#selectNextWorkItem"><span class="hs-identifier hs-var">selectNextWorkItem</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>    </span><a href="TcSMonad.html#workListSize"><span class="hs-identifier hs-var">workListSize</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#workListWantedCount"><span class="hs-identifier hs-var">workListWantedCount</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>    </span><a href="TcSMonad.html#getWorkList"><span class="hs-identifier hs-var">getWorkList</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#updWorkListTcS"><span class="hs-identifier hs-var">updWorkListTcS</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>    </span><span class="hs-comment">-- The TcS monad</span><span>
</span><a name="line-16"></a><span>    </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#runTcS"><span class="hs-identifier hs-var">runTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#runTcSDeriveds"><span class="hs-identifier hs-var">runTcSDeriveds</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#runTcSWithEvBinds"><span class="hs-identifier hs-var">runTcSWithEvBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>    </span><a href="TcSMonad.html#failTcS"><span class="hs-identifier hs-var">failTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#warnTcS"><span class="hs-identifier hs-var">warnTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#addErrTcS"><span class="hs-identifier hs-var">addErrTcS</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>    </span><a href="TcSMonad.html#runTcSEqualities"><span class="hs-identifier hs-var">runTcSEqualities</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>    </span><a href="TcSMonad.html#nestTcS"><span class="hs-identifier hs-var">nestTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#nestImplicTcS"><span class="hs-identifier hs-var">nestImplicTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#setEvBindsTcS"><span class="hs-identifier hs-var">setEvBindsTcS</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>    </span><a href="TcSMonad.html#checkConstraintsTcS"><span class="hs-identifier hs-var">checkConstraintsTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#checkTvConstraintsTcS"><span class="hs-identifier hs-var">checkTvConstraintsTcS</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>    </span><a href="TcSMonad.html#runTcPluginTcS"><span class="hs-identifier hs-var">runTcPluginTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#addUsedGRE"><span class="hs-identifier hs-var">addUsedGRE</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#addUsedGREs"><span class="hs-identifier hs-var">addUsedGREs</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>    </span><a href="TcSMonad.html#matchGlobalInst"><span class="hs-identifier hs-var">matchGlobalInst</span></a><span class="hs-special">,</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">TcM.ClsInstResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span>    </span><span class="hs-identifier hs-type">QCInst</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-comment">-- Tracing etc</span><span>
</span><a name="line-28"></a><span>    </span><a href="TcSMonad.html#panicTcS"><span class="hs-identifier hs-var">panicTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>    </span><a href="TcSMonad.html#traceFireTcS"><span class="hs-identifier hs-var">traceFireTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#bumpStepCountTcS"><span class="hs-identifier hs-var">bumpStepCountTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#csTraceTcS"><span class="hs-identifier hs-var">csTraceTcS</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>    </span><a href="TcSMonad.html#wrapErrTcS"><span class="hs-identifier hs-var">wrapErrTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#wrapWarnTcS"><span class="hs-identifier hs-var">wrapWarnTcS</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>    </span><span class="hs-comment">-- Evidence creation and transformation</span><span>
</span><a name="line-33"></a><span>    </span><a href="TcSMonad.html#MaybeNew"><span class="hs-identifier hs-type">MaybeNew</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#freshGoals"><span class="hs-identifier hs-var">freshGoals</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#isFresh"><span class="hs-identifier hs-var">isFresh</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getEvExpr"><span class="hs-identifier hs-var">getEvExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>    </span><a href="TcSMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">newTcEvBinds</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#newNoTcEvBinds"><span class="hs-identifier hs-var">newNoTcEvBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>    </span><a href="TcSMonad.html#newWantedEq"><span class="hs-identifier hs-var">newWantedEq</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#emitNewWantedEq"><span class="hs-identifier hs-var">emitNewWantedEq</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>    </span><a href="TcSMonad.html#newWanted"><span class="hs-identifier hs-var">newWanted</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#newWantedEvVar"><span class="hs-identifier hs-var">newWantedEvVar</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#newWantedNC"><span class="hs-identifier hs-var">newWantedNC</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#newWantedEvVarNC"><span class="hs-identifier hs-var">newWantedEvVarNC</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#newDerivedNC"><span class="hs-identifier hs-var">newDerivedNC</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>    </span><a href="TcSMonad.html#newBoundEvVarId"><span class="hs-identifier hs-var">newBoundEvVarId</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>    </span><a href="TcSMonad.html#unifyTyVar"><span class="hs-identifier hs-var">unifyTyVar</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#unflattenFmv"><span class="hs-identifier hs-var">unflattenFmv</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#reportUnifications"><span class="hs-identifier hs-var">reportUnifications</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>    </span><a href="TcSMonad.html#setEvBind"><span class="hs-identifier hs-var">setEvBind</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#setWantedEq"><span class="hs-identifier hs-var">setWantedEq</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>    </span><a href="TcSMonad.html#setWantedEvTerm"><span class="hs-identifier hs-var">setWantedEvTerm</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#setEvBindIfWanted"><span class="hs-identifier hs-var">setEvBindIfWanted</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>    </span><a href="TcSMonad.html#newEvVar"><span class="hs-identifier hs-var">newEvVar</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#newGivenEvVar"><span class="hs-identifier hs-var">newGivenEvVar</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#newGivenEvVars"><span class="hs-identifier hs-var">newGivenEvVars</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>    </span><a href="TcSMonad.html#emitNewDeriveds"><span class="hs-identifier hs-var">emitNewDeriveds</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#emitNewDerivedEq"><span class="hs-identifier hs-var">emitNewDerivedEq</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>    </span><a href="TcSMonad.html#checkReductionDepth"><span class="hs-identifier hs-var">checkReductionDepth</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>    </span><a href="TcSMonad.html#getSolvedDicts"><span class="hs-identifier hs-var">getSolvedDicts</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#setSolvedDicts"><span class="hs-identifier hs-var">setSolvedDicts</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><span>    </span><a href="TcSMonad.html#getInstEnvs"><span class="hs-identifier hs-var">getInstEnvs</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getFamInstEnvs"><span class="hs-identifier hs-var">getFamInstEnvs</span></a><span class="hs-special">,</span><span>                </span><span class="hs-comment">-- Getting the environments</span><span>
</span><a name="line-48"></a><span>    </span><a href="TcSMonad.html#getTopEnv"><span class="hs-identifier hs-var">getTopEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>    </span><a href="TcSMonad.html#getTcEvBindsVar"><span class="hs-identifier hs-var">getTcEvBindsVar</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>    </span><a href="TcSMonad.html#getTcEvTyCoVars"><span class="hs-identifier hs-var">getTcEvTyCoVars</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getTcEvBindsMap"><span class="hs-identifier hs-var">getTcEvBindsMap</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#setTcEvBindsMap"><span class="hs-identifier hs-var">setTcEvBindsMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-51"></a><span>    </span><a href="TcSMonad.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-comment">-- Inerts</span><span>
</span><a name="line-54"></a><span>    </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>    </span><a href="TcSMonad.html#updInertTcS"><span class="hs-identifier hs-var">updInertTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#updInertDicts"><span class="hs-identifier hs-var">updInertDicts</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#updInertIrreds"><span class="hs-identifier hs-var">updInertIrreds</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>    </span><a href="TcSMonad.html#getNoGivenEqs"><span class="hs-identifier hs-var">getNoGivenEqs</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#setInertCans"><span class="hs-identifier hs-var">setInertCans</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>    </span><a href="TcSMonad.html#getInertEqs"><span class="hs-identifier hs-var">getInertEqs</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getInertGivens"><span class="hs-identifier hs-var">getInertGivens</span></a><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>    </span><a href="TcSMonad.html#getInertInsols"><span class="hs-identifier hs-var">getInertInsols</span></a><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>    </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#setTcSInerts"><span class="hs-identifier hs-var">setTcSInerts</span></a><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>    </span><a href="TcSMonad.html#matchableGivens"><span class="hs-identifier hs-var">matchableGivens</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#prohibitedSuperClassSolve"><span class="hs-identifier hs-var">prohibitedSuperClassSolve</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#mightMatchLater"><span class="hs-identifier hs-var">mightMatchLater</span></a><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>    </span><a href="TcSMonad.html#getUnsolvedInerts"><span class="hs-identifier hs-var">getUnsolvedInerts</span></a><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>    </span><a href="TcSMonad.html#removeInertCts"><span class="hs-identifier hs-var">removeInertCts</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getPendingGivenScs"><span class="hs-identifier hs-var">getPendingGivenScs</span></a><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>    </span><a href="TcSMonad.html#addInertCan"><span class="hs-identifier hs-var">addInertCan</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#insertFunEq"><span class="hs-identifier hs-var">insertFunEq</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#addInertForAll"><span class="hs-identifier hs-var">addInertForAll</span></a><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>    </span><a href="TcSMonad.html#emitWorkNC"><span class="hs-identifier hs-var">emitWorkNC</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#emitWork"><span class="hs-identifier hs-var">emitWork</span></a><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span>    </span><a href="TcSMonad.html#isImprovable"><span class="hs-identifier hs-var">isImprovable</span></a><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span>    </span><span class="hs-comment">-- The Model</span><span>
</span><a name="line-68"></a><span>    </span><a href="TcSMonad.html#kickOutAfterUnification"><span class="hs-identifier hs-var">kickOutAfterUnification</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span>    </span><span class="hs-comment">-- Inert Safe Haskell safe-overlap failures</span><span>
</span><a name="line-71"></a><span>    </span><a href="TcSMonad.html#addInertSafehask"><span class="hs-identifier hs-var">addInertSafehask</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#insertSafeOverlapFailureTcS"><span class="hs-identifier hs-var">insertSafeOverlapFailureTcS</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#updInertSafehask"><span class="hs-identifier hs-var">updInertSafehask</span></a><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>    </span><a href="TcSMonad.html#getSafeOverlapFailures"><span class="hs-identifier hs-var">getSafeOverlapFailures</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>    </span><span class="hs-comment">-- Inert CDictCans</span><span>
</span><a name="line-75"></a><span>    </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#emptyDictMap"><span class="hs-identifier hs-var">emptyDictMap</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#lookupInertDict"><span class="hs-identifier hs-var">lookupInertDict</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#findDictsByClass"><span class="hs-identifier hs-var">findDictsByClass</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#addDict"><span class="hs-identifier hs-var">addDict</span></a><span class="hs-special">,</span><span>
</span><a name="line-76"></a><span>    </span><a href="TcSMonad.html#addDictsByClass"><span class="hs-identifier hs-var">addDictsByClass</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#delDict"><span class="hs-identifier hs-var">delDict</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#foldDicts"><span class="hs-identifier hs-var">foldDicts</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#filterDicts"><span class="hs-identifier hs-var">filterDicts</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#findDict"><span class="hs-identifier hs-var">findDict</span></a><span class="hs-special">,</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span>    </span><span class="hs-comment">-- Inert CTyEqCans</span><span>
</span><a name="line-79"></a><span>    </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#findTyEqs"><span class="hs-identifier hs-var">findTyEqs</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#foldTyEqs"><span class="hs-identifier hs-var">foldTyEqs</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#isInInertEqs"><span class="hs-identifier hs-var">isInInertEqs</span></a><span class="hs-special">,</span><span>
</span><a name="line-80"></a><span>    </span><a href="TcSMonad.html#lookupFlattenTyVar"><span class="hs-identifier hs-var">lookupFlattenTyVar</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#lookupInertTyVar"><span class="hs-identifier hs-var">lookupInertTyVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>    </span><span class="hs-comment">-- Inert solved dictionaries</span><span>
</span><a name="line-83"></a><span>    </span><a href="TcSMonad.html#addSolvedDict"><span class="hs-identifier hs-var">addSolvedDict</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#lookupSolvedDict"><span class="hs-identifier hs-var">lookupSolvedDict</span></a><span class="hs-special">,</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span>    </span><span class="hs-comment">-- Irreds</span><span>
</span><a name="line-86"></a><span>    </span><a href="TcSMonad.html#foldIrreds"><span class="hs-identifier hs-var">foldIrreds</span></a><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>    </span><span class="hs-comment">-- The flattening cache</span><span>
</span><a name="line-89"></a><span>    </span><a href="TcSMonad.html#lookupFlatCache"><span class="hs-identifier hs-var">lookupFlatCache</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#extendFlatCache"><span class="hs-identifier hs-var">extendFlatCache</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#newFlattenSkolem"><span class="hs-identifier hs-var">newFlattenSkolem</span></a><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- Flatten skolems</span><span>
</span><a name="line-90"></a><span>    </span><a href="TcSMonad.html#dischargeFunEq"><span class="hs-identifier hs-var">dischargeFunEq</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#pprKicked"><span class="hs-identifier hs-var">pprKicked</span></a><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>    </span><span class="hs-comment">-- Inert CFunEqCans</span><span>
</span><a name="line-93"></a><span>    </span><a href="TcSMonad.html#updInertFunEqs"><span class="hs-identifier hs-var">updInertFunEqs</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#findFunEq"><span class="hs-identifier hs-var">findFunEq</span></a><span class="hs-special">,</span><span>
</span><a name="line-94"></a><span>    </span><a href="TcSMonad.html#findFunEqsByTyCon"><span class="hs-identifier hs-var">findFunEqsByTyCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-95"></a><span>
</span><a name="line-96"></a><span>    </span><a href="TcSMonad.html#instDFunType"><span class="hs-identifier hs-var">instDFunType</span></a><span class="hs-special">,</span><span>                              </span><span class="hs-comment">-- Instantiation</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-comment">-- MetaTyVars</span><span>
</span><a name="line-99"></a><span>    </span><a href="TcSMonad.html#newFlexiTcSTy"><span class="hs-identifier hs-var">newFlexiTcSTy</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#instFlexi"><span class="hs-identifier hs-var">instFlexi</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#instFlexiX"><span class="hs-identifier hs-var">instFlexiX</span></a><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>    </span><a href="TcSMonad.html#cloneMetaTyVar"><span class="hs-identifier hs-var">cloneMetaTyVar</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#demoteUnfilledFmv"><span class="hs-identifier hs-var">demoteUnfilledFmv</span></a><span class="hs-special">,</span><span>
</span><a name="line-101"></a><span>    </span><a href="TcSMonad.html#tcInstSkolTyVarsX"><span class="hs-identifier hs-var">tcInstSkolTyVarsX</span></a><span class="hs-special">,</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span>    </span><span class="hs-identifier hs-type">TcLevel</span><span class="hs-special">,</span><span>
</span><a name="line-104"></a><span>    </span><a href="TcSMonad.html#isFilledMetaTyVar_maybe"><span class="hs-identifier hs-var">isFilledMetaTyVar_maybe</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#isFilledMetaTyVar"><span class="hs-identifier hs-var">isFilledMetaTyVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-105"></a><span>    </span><a href="TcSMonad.html#zonkTyCoVarsAndFV"><span class="hs-identifier hs-var">zonkTyCoVarsAndFV</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#zonkTcTypes"><span class="hs-identifier hs-var">zonkTcTypes</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#zonkTcTyVar"><span class="hs-identifier hs-var">zonkTcTyVar</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#zonkCo"><span class="hs-identifier hs-var">zonkCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-106"></a><span>    </span><a href="TcSMonad.html#zonkTyCoVarsAndFVList"><span class="hs-identifier hs-var">zonkTyCoVarsAndFVList</span></a><span class="hs-special">,</span><span>
</span><a name="line-107"></a><span>    </span><a href="TcSMonad.html#zonkSimples"><span class="hs-identifier hs-var">zonkSimples</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#zonkWC"><span class="hs-identifier hs-var">zonkWC</span></a><span class="hs-special">,</span><span>
</span><a name="line-108"></a><span>    </span><a href="TcSMonad.html#zonkTyCoVarKind"><span class="hs-identifier hs-var">zonkTyCoVarKind</span></a><span class="hs-special">,</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span>    </span><span class="hs-comment">-- References</span><span>
</span><a name="line-111"></a><span>    </span><a href="TcSMonad.html#newTcRef"><span class="hs-identifier hs-var">newTcRef</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#updTcRef"><span class="hs-identifier hs-var">updTcRef</span></a><span class="hs-special">,</span><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-comment">-- Misc</span><span>
</span><a name="line-114"></a><span>    </span><a href="TcSMonad.html#getDefaultInfo"><span class="hs-identifier hs-var">getDefaultInfo</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#getGlobalRdrEnvTcS"><span class="hs-identifier hs-var">getGlobalRdrEnvTcS</span></a><span class="hs-special">,</span><span>
</span><a name="line-115"></a><span>    </span><a href="TcSMonad.html#matchFam"><span class="hs-identifier hs-var">matchFam</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#matchFamTcM"><span class="hs-identifier hs-var">matchFamTcM</span></a><span class="hs-special">,</span><span>
</span><a name="line-116"></a><span>    </span><a href="TcSMonad.html#checkWellStagedDFun"><span class="hs-identifier hs-var">checkWellStagedDFun</span></a><span class="hs-special">,</span><span>
</span><a name="line-117"></a><span>    </span><a href="TcSMonad.html#pprEq"><span class="hs-identifier hs-var">pprEq</span></a><span>                                    </span><span class="hs-comment">-- Smaller utils, re-exported from TcM</span><span>
</span><a name="line-118"></a><span>                                             </span><span class="hs-comment">-- TODO (DV): these are only really used in the</span><span>
</span><a name="line-119"></a><span>                                             </span><span class="hs-comment">-- instance matcher in TcSimplify. I am wondering</span><span>
</span><a name="line-120"></a><span>                                             </span><span class="hs-comment">-- if the whole instance matcher simply belongs</span><span>
</span><a name="line-121"></a><span>                                             </span><span class="hs-comment">-- here</span><span>
</span><a name="line-122"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcM</span><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcM</span><span>
</span><a name="line-136"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcM</span><span>
</span><a name="line-137"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="ClsInst.html"><span class="hs-identifier">ClsInst</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcM</span><span class="hs-special">(</span><span> </span><a href="ClsInst.html#matchGlobalInst"><span class="hs-identifier hs-var">matchGlobalInst</span></a><span class="hs-special">,</span><span> </span><a href="ClsInst.html#ClsInstResult"><span class="hs-identifier hs-type">ClsInstResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcM</span><span>
</span><a name="line-139"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="TcEnv.html#checkWellStaged"><span class="hs-identifier hs-var">checkWellStaged</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcGetDefaultTys"><span class="hs-identifier hs-var">tcGetDefaultTys</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span class="hs-special">,</span><span> </span><a href="TcEnv.html#topIdLvl"><span class="hs-identifier hs-var">topIdLvl</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">heqTyConKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">eqTyConKey</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span class="hs-keyword">import</span><span> </span><a href="ClsInst.html"><span class="hs-identifier">ClsInst</span></a><span class="hs-special">(</span><span> </span><a href="ClsInst.html#InstanceWhat"><span class="hs-identifier hs-type">InstanceWhat</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Kind</span><span>
</span><a name="line-143"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-144"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-145"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-146"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Coercion</span><span>
</span><a name="line-147"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unify</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-150"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-151"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-152"></a><span class="hs-keyword">import</span><span> </span><a href="TcErrors.html"><span class="hs-identifier">TcErrors</span></a><span>   </span><span class="hs-special">(</span><span> </span><a href="TcErrors.html#solverDepthErrorTcS"><span class="hs-identifier hs-var">solverDepthErrorTcS</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-155"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">HasModule</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getModule</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TcM</span><span>
</span><a name="line-158"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-159"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-160"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-161"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-162"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-163"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSupply</span><span>
</span><a name="line-164"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-165"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcRnTypes</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Unique</span><span>
</span><a name="line-168"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-169"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqDFM</span><span>
</span><a name="line-170"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMap</span><span>
</span><a name="line-173"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-174"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Monad.Fail</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MonadFail</span><span>
</span><a name="line-175"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MonadUtils</span><span>
</span><a name="line-176"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-177"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">partition</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-cpp">#if defined(DEBUG)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Digraph</span><span>
</span><a name="line-181"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqSet</span><span>
</span><a name="line-182"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-184"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
*                            Worklists                                *
*  Canonical and non-canonical constraints that the simplifier has to  *
*  work on. Including their simplification depths.                     *
*                                                                      *
*                                                                      *
************************************************************************

Note [WorkList priorities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
A WorkList contains canonical and non-canonical items (of all flavors).
Notice that each Ct now has a simplification depth. We may
consider using this depth for prioritization as well in the future.

As a simple form of priority queue, our worklist separates out

* equalities (wl_eqs); see Note [Prioritise equalities]
* type-function equalities (wl_funeqs)
* all the rest (wl_rest)

Note [Prioritise equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's very important to process equalities /first/:

* (Efficiency)  The general reason to do so is that if we process a
  class constraint first, we may end up putting it into the inert set
  and then kicking it out later.  That's extra work compared to just
  doing the equality first.

* (Avoiding fundep iteration) As Trac #14723 showed, it's possible to
  get non-termination if we
      - Emit the Derived fundep equalities for a class constraint,
        generating some fresh unification variables.
      - That leads to some unification
      - Which kicks out the class constraint
      - Which isn't solved (because there are still some more Derived
        equalities in the work-list), but generates yet more fundeps
  Solution: prioritise derived equalities over class constraints

* (Class equalities) We need to prioritise equalities even if they
  are hidden inside a class constraint;
  see Note [Prioritise class equalities]

* (Kick-out) We want to apply this priority scheme to kicked-out
  constraints too (see the call to extendWorkListCt in kick_out_rewritable
  E.g. a CIrredCan can be a hetero-kinded (t1 ~ t2), which may become
  homo-kinded when kicked out, and hence we want to priotitise it.

* (Derived equalities) Originally we tried to postpone processing
  Derived equalities, in the hope that we might never need to deal
  with them at all; but in fact we must process Derived equalities
  eagerly, partly for the (Efficiency) reason, and more importantly
  for (Avoiding fundep iteration).

Note [Prioritise class equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We prioritise equalities in the solver (see selectWorkItem). But class
constraints like (a ~ b) and (a ~~ b) are actually equalities too;
see Note [The equality types story] in TysPrim.

Failing to prioritise these is inefficient (more kick-outs etc).
But, worse, it can prevent us spotting a &quot;recursive knot&quot; among
Wanted constraints.  See comment:10 of Trac #12734 for a worked-out
example.

So we arrange to put these particular class constraints in the wl_eqs.

  NB: since we do not currently apply the substitution to the
  inert_solved_dicts, the knot-tying still seems a bit fragile.
  But this makes it better.
-}</span><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-- See Note [WorkList priorities]</span><span>
</span><a name="line-259"></a><span class="hs-keyword">data</span><span> </span><a name="WorkList"><a href="TcSMonad.html#WorkList"><span class="hs-identifier">WorkList</span></a></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="WL"><a href="TcSMonad.html#WL"><span class="hs-identifier">WL</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="wl_eqs"><a href="TcSMonad.html#wl_eqs"><span class="hs-identifier">wl_eqs</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- CTyEqCan, CDictCan, CIrredCan</span><span>
</span><a name="line-261"></a><span>                             </span><span class="hs-comment">-- Given, Wanted, and Derived</span><span>
</span><a name="line-262"></a><span>                       </span><span class="hs-comment">-- Contains both equality constraints and their</span><span>
</span><a name="line-263"></a><span>                       </span><span class="hs-comment">-- class-level variants (a~b) and (a~~b);</span><span>
</span><a name="line-264"></a><span>                       </span><span class="hs-comment">-- See Note [Prioritise equalities]</span><span>
</span><a name="line-265"></a><span>                       </span><span class="hs-comment">-- See Note [Prioritise class equalities]</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="wl_funeqs"><a href="TcSMonad.html#wl_funeqs"><span class="hs-identifier">wl_funeqs</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="wl_rest"><a href="TcSMonad.html#wl_rest"><span class="hs-identifier">wl_rest</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="wl_implics"><a href="TcSMonad.html#wl_implics"><span class="hs-identifier">wl_implics</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">Implication</span><span>  </span><span class="hs-comment">-- See Note [Residual implications]</span><span>
</span><a name="line-272"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span class="hs-identifier">appendWorkList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-275"></a><a name="appendWorkList"><a href="TcSMonad.html#appendWorkList"><span class="hs-identifier">appendWorkList</span></a></a><span>
</span><a name="line-276"></a><span>    </span><span class="hs-special">(</span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753637"><a href="#local-6989586621682753637"><span class="hs-identifier">eqs1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753638"><a href="#local-6989586621682753638"><span class="hs-identifier">funeqs1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753639"><a href="#local-6989586621682753639"><span class="hs-identifier">rest1</span></a></a><span>
</span><a name="line-277"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_implics</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753640"><a href="#local-6989586621682753640"><span class="hs-identifier">implics1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>    </span><span class="hs-special">(</span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753641"><a href="#local-6989586621682753641"><span class="hs-identifier">eqs2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753642"><a href="#local-6989586621682753642"><span class="hs-identifier">funeqs2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753643"><a href="#local-6989586621682753643"><span class="hs-identifier">rest2</span></a></a><span>
</span><a name="line-279"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_implics</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753644"><a href="#local-6989586621682753644"><span class="hs-identifier">implics2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-280"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753637"><span class="hs-identifier hs-var">eqs1</span></a><span>     </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682753641"><span class="hs-identifier hs-var">eqs2</span></a><span>
</span><a name="line-281"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753638"><span class="hs-identifier hs-var">funeqs1</span></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682753642"><span class="hs-identifier hs-var">funeqs2</span></a><span>
</span><a name="line-282"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753639"><span class="hs-identifier hs-var">rest1</span></a><span>    </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682753643"><span class="hs-identifier hs-var">rest2</span></a><span>
</span><a name="line-283"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_implics</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753640"><span class="hs-identifier hs-var">implics1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span>   </span><a href="#local-6989586621682753644"><span class="hs-identifier hs-var">implics2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span class="hs-identifier">workListSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-286"></a><a name="workListSize"><a href="TcSMonad.html#workListSize"><span class="hs-identifier">workListSize</span></a></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753645"><a href="#local-6989586621682753645"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753646"><a href="#local-6989586621682753646"><span class="hs-identifier">funeqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753647"><a href="#local-6989586621682753647"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682753645"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682753646"><span class="hs-identifier hs-var">funeqs</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682753647"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-identifier">workListWantedCount</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- Count the things we need to solve</span><span>
</span><a name="line-291"></a><span class="hs-comment">-- excluding the insolubles (c.f. inert_count)</span><span>
</span><a name="line-292"></a><a name="workListWantedCount"><a href="TcSMonad.html#workListWantedCount"><span class="hs-identifier">workListWantedCount</span></a></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753648"><a href="#local-6989586621682753648"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753649"><a href="#local-6989586621682753649"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><span class="hs-identifier hs-var">isWantedCt</span><span> </span><a href="#local-6989586621682753648"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">count</span><span> </span><a href="#local-6989586621682753650"><span class="hs-identifier hs-var">is_wanted</span></a><span> </span><a href="#local-6989586621682753649"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>    </span><a name="local-6989586621682753650"><a href="#local-6989586621682753650"><span class="hs-identifier">is_wanted</span></a></a><span> </span><a name="local-6989586621682753651"><a href="#local-6989586621682753651"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-296"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CIrredCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753652"><a href="#local-6989586621682753652"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753653"><a href="#local-6989586621682753653"><span class="hs-identifier">insol</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753651"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-297"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682753653"><span class="hs-identifier hs-var">insol</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isWanted</span><span> </span><a href="#local-6989586621682753652"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-298"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-299"></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isWantedCt</span><span> </span><a href="#local-6989586621682753651"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-identifier">extendWorkListEq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-302"></a><a name="extendWorkListEq"><a href="TcSMonad.html#extendWorkListEq"><span class="hs-identifier">extendWorkListEq</span></a></a><span> </span><a name="local-6989586621682753654"><a href="#local-6989586621682753654"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621682753655"><a href="#local-6989586621682753655"><span class="hs-identifier">wl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753655"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753654"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><a href="#local-6989586621682753655"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-identifier">extendWorkListFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-305"></a><a name="extendWorkListFunEq"><a href="TcSMonad.html#extendWorkListFunEq"><span class="hs-identifier">extendWorkListFunEq</span></a></a><span> </span><a name="local-6989586621682753656"><a href="#local-6989586621682753656"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621682753657"><a href="#local-6989586621682753657"><span class="hs-identifier">wl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753657"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753656"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><a href="#local-6989586621682753657"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-identifier">extendWorkListNonEq</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-308"></a><span class="hs-comment">-- Extension by non equality</span><span>
</span><a name="line-309"></a><a name="extendWorkListNonEq"><a href="TcSMonad.html#extendWorkListNonEq"><span class="hs-identifier">extendWorkListNonEq</span></a></a><span> </span><a name="local-6989586621682753658"><a href="#local-6989586621682753658"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621682753659"><a href="#local-6989586621682753659"><span class="hs-identifier">wl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753659"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753658"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><a href="#local-6989586621682753659"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-identifier">extendWorkListDeriveds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">CtEvidence</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-312"></a><a name="extendWorkListDeriveds"><a href="TcSMonad.html#extendWorkListDeriveds"><span class="hs-identifier">extendWorkListDeriveds</span></a></a><span> </span><a name="local-6989586621682753660"><a href="#local-6989586621682753660"><span class="hs-identifier">evs</span></a></a><span> </span><a name="local-6989586621682753661"><a href="#local-6989586621682753661"><span class="hs-identifier">wl</span></a></a><span>
</span><a name="line-313"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#extendWorkListCts"><span class="hs-identifier hs-var">extendWorkListCts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">mkNonCanonical</span><span> </span><a href="#local-6989586621682753660"><span class="hs-identifier hs-var">evs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753661"><span class="hs-identifier hs-var">wl</span></a><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-identifier">extendWorkListImplic</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">Implication</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-316"></a><a name="extendWorkListImplic"><a href="TcSMonad.html#extendWorkListImplic"><span class="hs-identifier">extendWorkListImplic</span></a></a><span> </span><a name="local-6989586621682753662"><a href="#local-6989586621682753662"><span class="hs-identifier">implics</span></a></a><span> </span><a name="local-6989586621682753663"><a href="#local-6989586621682753663"><span class="hs-identifier">wl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753663"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_implics</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753662"><span class="hs-identifier hs-var">implics</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">wl_implics</span><span> </span><a href="#local-6989586621682753663"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-identifier">extendWorkListCt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-319"></a><span class="hs-comment">-- Agnostic</span><span>
</span><a name="line-320"></a><a name="extendWorkListCt"><a href="TcSMonad.html#extendWorkListCt"><span class="hs-identifier">extendWorkListCt</span></a></a><span> </span><a name="local-6989586621682753664"><a href="#local-6989586621682753664"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621682753665"><a href="#local-6989586621682753665"><span class="hs-identifier">wl</span></a></a><span>
</span><a name="line-321"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">classifyPredType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctPred</span><span> </span><a href="#local-6989586621682753664"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-322"></a><span>     </span><span class="hs-identifier hs-var">EqPred</span><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><a name="local-6989586621682753666"><a href="#local-6989586621682753666"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-323"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682753667"><a href="#local-6989586621682753667"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcTyConAppTyCon_maybe</span><span> </span><a href="#local-6989586621682753666"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-324"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTypeFamilyTyCon</span><span> </span><a href="#local-6989586621682753667"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-325"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#extendWorkListFunEq"><span class="hs-identifier hs-var">extendWorkListFunEq</span></a><span> </span><a href="#local-6989586621682753664"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621682753665"><span class="hs-identifier hs-var">wl</span></a><span>
</span><a name="line-326"></a><span>
</span><a name="line-327"></a><span>     </span><span class="hs-identifier hs-var">EqPred</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-328"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#extendWorkListEq"><span class="hs-identifier hs-var">extendWorkListEq</span></a><span> </span><a href="#local-6989586621682753664"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621682753665"><span class="hs-identifier hs-var">wl</span></a><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>     </span><span class="hs-identifier hs-var">ClassPred</span><span> </span><a name="local-6989586621682753668"><a href="#local-6989586621682753668"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-comment">-- See Note [Prioritise class equalities]</span><span>
</span><a name="line-331"></a><span>       </span><span class="hs-glyph">|</span><span>  </span><a href="#local-6989586621682753668"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">heqTyConKey</span><span>
</span><a name="line-332"></a><span>       </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682753668"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">hasKey</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">eqTyConKey</span><span>
</span><a name="line-333"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#extendWorkListEq"><span class="hs-identifier hs-var">extendWorkListEq</span></a><span> </span><a href="#local-6989586621682753664"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621682753665"><span class="hs-identifier hs-var">wl</span></a><span>
</span><a name="line-334"></a><span>
</span><a name="line-335"></a><span>     </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#extendWorkListNonEq"><span class="hs-identifier hs-var">extendWorkListNonEq</span></a><span> </span><a href="#local-6989586621682753664"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621682753665"><span class="hs-identifier hs-var">wl</span></a><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span class="hs-identifier">extendWorkListCts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-338"></a><span class="hs-comment">-- Agnostic</span><span>
</span><a name="line-339"></a><a name="extendWorkListCts"><a href="TcSMonad.html#extendWorkListCts"><span class="hs-identifier">extendWorkListCts</span></a></a><span> </span><a name="local-6989586621682753669"><a href="#local-6989586621682753669"><span class="hs-identifier">cts</span></a></a><span> </span><a name="local-6989586621682753670"><a href="#local-6989586621682753670"><span class="hs-identifier">wl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="TcSMonad.html#extendWorkListCt"><span class="hs-identifier hs-var">extendWorkListCt</span></a><span> </span><a href="#local-6989586621682753670"><span class="hs-identifier hs-var">wl</span></a><span> </span><a href="#local-6989586621682753669"><span class="hs-identifier hs-var">cts</span></a><span>
</span><a name="line-340"></a><span>
</span><a name="line-341"></a><span class="hs-identifier">isEmptyWorkList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-342"></a><a name="isEmptyWorkList"><a href="TcSMonad.html#isEmptyWorkList"><span class="hs-identifier">isEmptyWorkList</span></a></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753671"><a href="#local-6989586621682753671"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753672"><a href="#local-6989586621682753672"><span class="hs-identifier">funeqs</span></a></a><span>
</span><a name="line-343"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753673"><a href="#local-6989586621682753673"><span class="hs-identifier">rest</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_implics</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753674"><a href="#local-6989586621682753674"><span class="hs-identifier">implics</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682753671"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682753673"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682753672"><span class="hs-identifier hs-var">funeqs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621682753674"><span class="hs-identifier hs-var">implics</span></a><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span class="hs-identifier">emptyWorkList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-347"></a><a name="emptyWorkList"><a href="TcSMonad.html#emptyWorkList"><span class="hs-identifier">emptyWorkList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-348"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_implics</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span class="hs-identifier">selectWorkItem</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span class="hs-comment">-- See Note [Prioritise equalities]</span><span>
</span><a name="line-352"></a><a name="selectWorkItem"><a href="TcSMonad.html#selectWorkItem"><span class="hs-identifier">selectWorkItem</span></a></a><span> </span><a name="local-6989586621682753675"><a href="#local-6989586621682753675"><span class="hs-identifier">wl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753676"><a href="#local-6989586621682753676"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753677"><a href="#local-6989586621682753677"><span class="hs-identifier">feqs</span></a></a><span>
</span><a name="line-353"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753678"><a href="#local-6989586621682753678"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682753679"><a href="#local-6989586621682753679"><span class="hs-identifier">ct</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682753680"><a href="#local-6989586621682753680"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753676"><span class="hs-identifier hs-var">eqs</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753679"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753675"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753680"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-355"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682753681"><a href="#local-6989586621682753681"><span class="hs-identifier">ct</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682753682"><a href="#local-6989586621682753682"><span class="hs-identifier">fes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753677"><span class="hs-identifier hs-var">feqs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753681"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753675"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753682"><span class="hs-identifier hs-var">fes</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621682753683"><a href="#local-6989586621682753683"><span class="hs-identifier">ct</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682753684"><a href="#local-6989586621682753684"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753678"><span class="hs-identifier hs-var">rest</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753683"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753675"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_rest</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753684"><span class="hs-identifier hs-var">cts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span class="hs-identifier">getWorkList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-360"></a><a name="getWorkList"><a href="TcSMonad.html#getWorkList"><span class="hs-identifier">getWorkList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753685"><a href="#local-6989586621682753685"><span class="hs-identifier">wl_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSWorkListRef"><span class="hs-identifier hs-var">getTcSWorkListRef</span></a><span>
</span><a name="line-361"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM.readTcRef</span></a><span> </span><a href="#local-6989586621682753685"><span class="hs-identifier hs-var">wl_var</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-identifier">selectNextWorkItem</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- Pick which work item to do next</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- See Note [Prioritise equalities]</span><span>
</span><a name="line-366"></a><a name="selectNextWorkItem"><a href="TcSMonad.html#selectNextWorkItem"><span class="hs-identifier">selectNextWorkItem</span></a></a><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753686"><a href="#local-6989586621682753686"><span class="hs-identifier">wl_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSWorkListRef"><span class="hs-identifier hs-var">getTcSWorkListRef</span></a><span>
</span><a name="line-368"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682753687"><a href="#local-6989586621682753687"><span class="hs-identifier">wl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621682753686"><span class="hs-identifier hs-var">wl_var</span></a><span>
</span><a name="line-369"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcSMonad.html#selectWorkItem"><span class="hs-identifier hs-var">selectWorkItem</span></a><span> </span><a href="#local-6989586621682753687"><span class="hs-identifier hs-var">wl</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-370"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-371"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682753688"><a href="#local-6989586621682753688"><span class="hs-identifier">ct</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753689"><a href="#local-6989586621682753689"><span class="hs-identifier">new_wl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-372"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- checkReductionDepth (ctLoc ct) (ctPred ct)</span><span>
</span><a name="line-373"></a><span>         </span><span class="hs-comment">-- This is done by TcInteract.chooseInstance</span><span>
</span><a name="line-374"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621682753686"><span class="hs-identifier hs-var">wl_var</span></a><span> </span><a href="#local-6989586621682753689"><span class="hs-identifier hs-var">new_wl</span></a><span>
</span><a name="line-375"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682753688"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-comment">-- Pretty printing</span><span>
</span><a name="line-378"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-379"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#WL"><span class="hs-identifier hs-var">WL</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753583"><a href="#local-6989586621682753583"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753584"><a href="#local-6989586621682753584"><span class="hs-identifier">feqs</span></a></a><span>
</span><a name="line-380"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_rest</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753585"><a href="#local-6989586621682753585"><span class="hs-identifier">rest</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_implics</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753586"><a href="#local-6989586621682753586"><span class="hs-identifier">implics</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;WL&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-382"></a><span>     </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682753583"><span class="hs-identifier hs-var">eqs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-383"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Eqs =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753583"><span class="hs-identifier hs-var">eqs</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682753584"><span class="hs-identifier hs-var">feqs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-385"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Funeqs =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753584"><span class="hs-identifier hs-var">feqs</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682753585"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-387"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Non-eqs =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753585"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyBag</span><span> </span><a href="#local-6989586621682753586"><span class="hs-identifier hs-var">implics</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-389"></a><span>            </span><span class="hs-identifier hs-var">ifPprDebug</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Implics =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621682753586"><span class="hs-identifier hs-var">implics</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(Implics omitted)&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>          </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                InertSet: the inert set
*                                                                      *
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span class="hs-keyword">data</span><span> </span><a name="InertSet"><a href="TcSMonad.html#InertSet"><span class="hs-identifier">InertSet</span></a></a><span>
</span><a name="line-402"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="IS"><a href="TcSMonad.html#IS"><span class="hs-identifier">IS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="inert_cans"><a href="TcSMonad.html#inert_cans"><span class="hs-identifier">inert_cans</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-403"></a><span>              </span><span class="hs-comment">-- Canonical Given, Wanted, Derived</span><span>
</span><a name="line-404"></a><span>              </span><span class="hs-comment">-- Sometimes called &quot;the inert set&quot;</span><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_fsks"><a href="TcSMonad.html#inert_fsks"><span class="hs-identifier">inert_fsks</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-407"></a><span>              </span><span class="hs-comment">-- A list of (fsk, ty) pairs; we add one element when we flatten</span><span>
</span><a name="line-408"></a><span>              </span><span class="hs-comment">-- a function application in a Given constraint, creating</span><span>
</span><a name="line-409"></a><span>              </span><span class="hs-comment">-- a new fsk in newFlattenSkolem.  When leaving a nested scope,</span><span>
</span><a name="line-410"></a><span>              </span><span class="hs-comment">-- unflattenGivens unifies fsk := ty</span><span>
</span><a name="line-411"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-412"></a><span>              </span><span class="hs-comment">-- We could also get this info from inert_funeqs, filtered by</span><span>
</span><a name="line-413"></a><span>              </span><span class="hs-comment">-- level, but it seems simpler and more direct to capture the</span><span>
</span><a name="line-414"></a><span>              </span><span class="hs-comment">-- fsk as we generate them.</span><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_flat_cache"><a href="TcSMonad.html#inert_flat_cache"><span class="hs-identifier">inert_flat_cache</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#ExactFunEqMap"><span class="hs-identifier hs-type">ExactFunEqMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CtFlavour</span><span class="hs-special">)</span><span>
</span><a name="line-417"></a><span>              </span><span class="hs-comment">-- See Note [Type family equations]</span><span>
</span><a name="line-418"></a><span>              </span><span class="hs-comment">-- If    F tys :-&gt; (co, rhs, flav),</span><span>
</span><a name="line-419"></a><span>              </span><span class="hs-comment">-- then  co :: F tys ~ rhs</span><span>
</span><a name="line-420"></a><span>              </span><span class="hs-comment">--       flav is [G] or [WD]</span><span>
</span><a name="line-421"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-422"></a><span>              </span><span class="hs-comment">-- Just a hash-cons cache for use when flattening only</span><span>
</span><a name="line-423"></a><span>              </span><span class="hs-comment">-- These include entirely un-processed goals, so don't use</span><span>
</span><a name="line-424"></a><span>              </span><span class="hs-comment">-- them to solve a top-level goal, else you may end up solving</span><span>
</span><a name="line-425"></a><span>              </span><span class="hs-comment">-- (w:F ty ~ a) by setting w:=w!  We just use the flat-cache</span><span>
</span><a name="line-426"></a><span>              </span><span class="hs-comment">-- when allocating a new flatten-skolem.</span><span>
</span><a name="line-427"></a><span>              </span><span class="hs-comment">-- Not necessarily inert wrt top-level equations (or inert_cans)</span><span>
</span><a name="line-428"></a><span>
</span><a name="line-429"></a><span>              </span><span class="hs-comment">-- NB: An ExactFunEqMap -- this doesn't match via loose types!</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_solved_dicts"><a href="TcSMonad.html#inert_solved_dicts"><span class="hs-identifier">inert_solved_dicts</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-432"></a><span>              </span><span class="hs-comment">-- All Wanteds, of form ev :: C t1 .. tn</span><span>
</span><a name="line-433"></a><span>              </span><span class="hs-comment">-- See Note [Solved dictionaries]</span><span>
</span><a name="line-434"></a><span>              </span><span class="hs-comment">-- and Note [Do not add superclasses of solved dictionaries]</span><span>
</span><a name="line-435"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-438"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#IS"><span class="hs-identifier hs-var">IS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753579"><a href="#local-6989586621682753579"><span class="hs-identifier">ics</span></a></a><span>
</span><a name="line-439"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_fsks</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753580"><a href="#local-6989586621682753580"><span class="hs-identifier">ifsks</span></a></a><span>
</span><a name="line-440"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_solved_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753581"><a href="#local-6989586621682753581"><span class="hs-identifier">solved_dicts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753579"><span class="hs-identifier hs-var">ics</span></a><span>
</span><a name="line-442"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Inert fsks =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753580"><span class="hs-identifier hs-var">ifsks</span></a><span>
</span><a name="line-443"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682753582"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-444"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Solved dicts =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753582"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-445"></a><span>         </span><span class="hs-keyword">where</span><span>
</span><a name="line-446"></a><span>           </span><a name="local-6989586621682753582"><a href="#local-6989586621682753582"><span class="hs-identifier">dicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bagToList</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#dictsToBag"><span class="hs-identifier hs-var">dictsToBag</span></a><span> </span><a href="#local-6989586621682753581"><span class="hs-identifier hs-var">solved_dicts</span></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>
</span><a name="line-448"></a><span class="hs-identifier">emptyInertCans</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-449"></a><a name="emptyInertCans"><a href="TcSMonad.html#emptyInertCans"><span class="hs-identifier">emptyInertCans</span></a></a><span>
</span><a name="line-450"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_count</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-451"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_eqs</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyDVarEnv</span><span>
</span><a name="line-452"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_dicts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyDicts"><span class="hs-identifier hs-var">emptyDicts</span></a><span>
</span><a name="line-453"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_safehask</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyDicts"><span class="hs-identifier hs-var">emptyDicts</span></a><span>
</span><a name="line-454"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_funeqs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyFunEqs"><span class="hs-identifier hs-var">emptyFunEqs</span></a><span>
</span><a name="line-455"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-456"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_irreds</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyCts</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span class="hs-identifier">emptyInert</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span>
</span><a name="line-459"></a><a name="emptyInert"><a href="TcSMonad.html#emptyInert"><span class="hs-identifier">emptyInert</span></a></a><span>
</span><a name="line-460"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#IS"><span class="hs-identifier hs-var">IS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_cans</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyInertCans"><span class="hs-identifier hs-var">emptyInertCans</span></a><span>
</span><a name="line-461"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_fsks</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-462"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_flat_cache</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyExactFunEqs"><span class="hs-identifier hs-var">emptyExactFunEqs</span></a><span>
</span><a name="line-463"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_solved_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyDictMap"><span class="hs-identifier hs-var">emptyDictMap</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span class="hs-comment">{- Note [Solved dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we apply a top-level instance declaration, we add the &quot;solved&quot;
dictionary to the inert_solved_dicts.  In general, we use it to avoid
creating a new EvVar when we have a new goal that we have solved in
the past.

But in particular, we can use it to create *recursive* dictionaries.
The simplest, degnerate case is
    instance C [a] =&gt; C [a] where ...
If we have
    [W] d1 :: C [x]
then we can apply the instance to get
    d1 = $dfCList d
    [W] d2 :: C [x]
Now 'd1' goes in inert_solved_dicts, and we can solve d2 directly from d1.
    d1 = $dfCList d
    d2 = d1

See Note [Example of recursive dictionaries]
Other notes about solved dictionaries

* See also Note [Do not add superclasses of solved dictionaries]

* The inert_solved_dicts field is not rewritten by equalities,
  so it may get out of date.

* THe inert_solved_dicts are all Wanteds, never givens

* We only cache dictionaries from top-level instances, not from
  local quantified constraints.  Reason: if we cached the latter
  we'd need to purge the cache when bringing new quantified
  constraints into scope, because quantified constraints &quot;shadow&quot;
  top-level instances.

Note [Do not add superclasses of solved dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Every member of inert_solved_dicts is the result of applying a dictionary
function, NOT of applying superclass selection to anything.
Consider

        class Ord a =&gt; C a where
        instance Ord [a] =&gt; C [a] where ...

Suppose we are trying to solve
  [G] d1 : Ord a
  [W] d2 : C [a]

Then we'll use the instance decl to give

  [G] d1 : Ord a     Solved: d2 : C [a] = $dfCList d3
  [W] d3 : Ord [a]

We must not add d4 : Ord [a] to the 'solved' set (by taking the
superclass of d2), otherwise we'll use it to solve d3, without ever
using d1, which would be a catastrophe.

Solution: when extending the solved dictionaries, do not add superclasses.
That's why each element of the inert_solved_dicts is the result of applying
a dictionary function.

Note [Example of recursive dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
--- Example 1

    data D r = ZeroD | SuccD (r (D r));

    instance (Eq (r (D r))) =&gt; Eq (D r) where
        ZeroD     == ZeroD     = True
        (SuccD a) == (SuccD b) = a == b
        _         == _         = False;

    equalDC :: D [] -&gt; D [] -&gt; Bool;
    equalDC = (==);

We need to prove (Eq (D [])). Here's how we go:

   [W] d1 : Eq (D [])
By instance decl of Eq (D r):
   [W] d2 : Eq [D []]      where   d1 = dfEqD d2
By instance decl of Eq [a]:
   [W] d3 : Eq (D [])      where   d2 = dfEqList d3
                                   d1 = dfEqD d2
Now this wanted can interact with our &quot;solved&quot; d1 to get:
    d3 = d1

-- Example 2:
This code arises in the context of &quot;Scrap Your Boilerplate with Class&quot;

    class Sat a
    class Data ctx a
    instance  Sat (ctx Char)             =&gt; Data ctx Char       -- dfunData1
    instance (Sat (ctx [a]), Data ctx a) =&gt; Data ctx [a]        -- dfunData2

    class Data Maybe a =&gt; Foo a

    instance Foo t =&gt; Sat (Maybe t)                             -- dfunSat

    instance Data Maybe a =&gt; Foo a                              -- dfunFoo1
    instance Foo a        =&gt; Foo [a]                            -- dfunFoo2
    instance                 Foo [Char]                         -- dfunFoo3

Consider generating the superclasses of the instance declaration
         instance Foo a =&gt; Foo [a]

So our problem is this
    [G] d0 : Foo t
    [W] d1 : Data Maybe [t]   -- Desired superclass

We may add the given in the inert set, along with its superclasses
  Inert:
    [G] d0 : Foo t
    [G] d01 : Data Maybe t   -- Superclass of d0
  WorkList
    [W] d1 : Data Maybe [t]

Solve d1 using instance dfunData2; d1 := dfunData2 d2 d3
  Inert:
    [G] d0 : Foo t
    [G] d01 : Data Maybe t   -- Superclass of d0
  Solved:
        d1 : Data Maybe [t]
  WorkList:
    [W] d2 : Sat (Maybe [t])
    [W] d3 : Data Maybe t

Now, we may simplify d2 using dfunSat; d2 := dfunSat d4
  Inert:
    [G] d0 : Foo t
    [G] d01 : Data Maybe t   -- Superclass of d0
  Solved:
        d1 : Data Maybe [t]
        d2 : Sat (Maybe [t])
  WorkList:
    [W] d3 : Data Maybe t
    [W] d4 : Foo [t]

Now, we can just solve d3 from d01; d3 := d01
  Inert
    [G] d0 : Foo t
    [G] d01 : Data Maybe t   -- Superclass of d0
  Solved:
        d1 : Data Maybe [t]
        d2 : Sat (Maybe [t])
  WorkList
    [W] d4 : Foo [t]

Now, solve d4 using dfunFoo2;  d4 := dfunFoo2 d5
  Inert
    [G] d0  : Foo t
    [G] d01 : Data Maybe t   -- Superclass of d0
  Solved:
        d1 : Data Maybe [t]
        d2 : Sat (Maybe [t])
        d4 : Foo [t]
  WorkList:
    [W] d5 : Foo t

Now, d5 can be solved! d5 := d0

Result
   d1 := dfunData2 d2 d3
   d2 := dfunSat d4
   d3 := d01
   d4 := dfunFoo2 d5
   d5 := d0
-}</span><span>
</span><a name="line-633"></a><span>
</span><a name="line-634"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                InertCans: the canonical inerts
*                                                                      *
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-keyword">data</span><span> </span><a name="InertCans"><a href="TcSMonad.html#InertCans"><span class="hs-identifier">InertCans</span></a></a><span>   </span><span class="hs-comment">-- See Note [Detailed InertCans Invariants] for more</span><span>
</span><a name="line-642"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="IC"><a href="TcSMonad.html#IC"><span class="hs-identifier">IC</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="inert_eqs"><a href="TcSMonad.html#inert_eqs"><span class="hs-identifier">inert_eqs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span>
</span><a name="line-643"></a><span>              </span><span class="hs-comment">-- See Note [inert_eqs: the inert equalities]</span><span>
</span><a name="line-644"></a><span>              </span><span class="hs-comment">-- All CTyEqCans; index is the LHS tyvar</span><span>
</span><a name="line-645"></a><span>              </span><span class="hs-comment">-- Domain = skolems and untouchables; a touchable would be unified</span><span>
</span><a name="line-646"></a><span>
</span><a name="line-647"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_funeqs"><a href="TcSMonad.html#inert_funeqs"><span class="hs-identifier">inert_funeqs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-648"></a><span>              </span><span class="hs-comment">-- All CFunEqCans; index is the whole family head type.</span><span>
</span><a name="line-649"></a><span>              </span><span class="hs-comment">-- All Nominal (that's an invarint of all CFunEqCans)</span><span>
</span><a name="line-650"></a><span>              </span><span class="hs-comment">-- LHS is fully rewritten (modulo eqCanRewrite constraints)</span><span>
</span><a name="line-651"></a><span>              </span><span class="hs-comment">--     wrt inert_eqs</span><span>
</span><a name="line-652"></a><span>              </span><span class="hs-comment">-- Can include all flavours, [G], [W], [WD], [D]</span><span>
</span><a name="line-653"></a><span>              </span><span class="hs-comment">-- See Note [Type family equations]</span><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_dicts"><a href="TcSMonad.html#inert_dicts"><span class="hs-identifier">inert_dicts</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-656"></a><span>              </span><span class="hs-comment">-- Dictionaries only</span><span>
</span><a name="line-657"></a><span>              </span><span class="hs-comment">-- All fully rewritten (modulo flavour constraints)</span><span>
</span><a name="line-658"></a><span>              </span><span class="hs-comment">--     wrt inert_eqs</span><span>
</span><a name="line-659"></a><span>
</span><a name="line-660"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_insts"><a href="TcSMonad.html#inert_insts"><span class="hs-identifier">inert_insts</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">QCInst</span><span class="hs-special">]</span><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_safehask"><a href="TcSMonad.html#inert_safehask"><span class="hs-identifier">inert_safehask</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-663"></a><span>              </span><span class="hs-comment">-- Failed dictionary resolution due to Safe Haskell overlapping</span><span>
</span><a name="line-664"></a><span>              </span><span class="hs-comment">-- instances restriction. We keep this separate from inert_dicts</span><span>
</span><a name="line-665"></a><span>              </span><span class="hs-comment">-- as it doesn't cause compilation failure, just safe inference</span><span>
</span><a name="line-666"></a><span>              </span><span class="hs-comment">-- failure.</span><span>
</span><a name="line-667"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-668"></a><span>              </span><span class="hs-comment">-- ^ See Note [Safe Haskell Overlapping Instances Implementation]</span><span>
</span><a name="line-669"></a><span>              </span><span class="hs-comment">-- in TcSimplify</span><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_irreds"><a href="TcSMonad.html#inert_irreds"><span class="hs-identifier">inert_irreds</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Cts</span><span>
</span><a name="line-672"></a><span>              </span><span class="hs-comment">-- Irreducible predicates that cannot be made canonical,</span><span>
</span><a name="line-673"></a><span>              </span><span class="hs-comment">--     and which don't interact with others (e.g.  (c a))</span><span>
</span><a name="line-674"></a><span>              </span><span class="hs-comment">-- and insoluble predicates (e.g.  Int ~ Bool, or a ~ [a])</span><span>
</span><a name="line-675"></a><span>
</span><a name="line-676"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="inert_count"><a href="TcSMonad.html#inert_count"><span class="hs-identifier">inert_count</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-677"></a><span>              </span><span class="hs-comment">-- Number of Wanted goals in</span><span>
</span><a name="line-678"></a><span>              </span><span class="hs-comment">--     inert_eqs, inert_dicts, inert_safehask, inert_irreds</span><span>
</span><a name="line-679"></a><span>              </span><span class="hs-comment">-- Does not include insolubles</span><span>
</span><a name="line-680"></a><span>              </span><span class="hs-comment">-- When non-zero, keep trying to solve</span><span>
</span><a name="line-681"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span class="hs-keyword">type</span><span> </span><a name="InertEqs"><a href="TcSMonad.html#InertEqs"><span class="hs-identifier">InertEqs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">DTyVarEnv</span><span> </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span>
</span><a name="line-684"></a><span class="hs-keyword">type</span><span> </span><a name="EqualCtList"><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier">EqualCtList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- See Note [EqualCtList invariants]</span><span>
</span><a name="line-685"></a><span>
</span><a name="line-686"></a><span class="hs-comment">{- Note [Detailed InertCans Invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The InertCans represents a collection of constraints with the following properties:

  * All canonical

  * No two dictionaries with the same head
  * No two CIrreds with the same type

  * Family equations inert wrt top-level family axioms

  * Dictionaries have no matching top-level instance

  * Given family or dictionary constraints don't mention touchable
    unification variables

  * Non-CTyEqCan constraints are fully rewritten with respect
    to the CTyEqCan equalities (modulo canRewrite of course;
    eg a wanted cannot rewrite a given)

  * CTyEqCan equalities: see Note [Applying the inert substitution]
                         in TcFlatten

Note [EqualCtList invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    * All are equalities
    * All these equalities have the same LHS
    * The list is never empty
    * No element of the list can rewrite any other
    * Derived before Wanted

From the fourth invariant it follows that the list is
   - A single [G], or
   - Zero or one [D] or [WD], followd by any number of [W]

The Wanteds can't rewrite anything which is why we put them last

Note [Type family equations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Type-family equations, CFunEqCans, of form (ev : F tys ~ ty),
live in three places

  * The work-list, of course

  * The inert_funeqs are un-solved but fully processed, and in
    the InertCans. They can be [G], [W], [WD], or [D].

  * The inert_flat_cache.  This is used when flattening, to get maximal
    sharing. Everthing in the inert_flat_cache is [G] or [WD]

    It contains lots of things that are still in the work-list.
    E.g Suppose we have (w1: F (G a) ~ Int), and (w2: H (G a) ~ Int) in the
        work list.  Then we flatten w1, dumping (w3: G a ~ f1) in the work
        list.  Now if we flatten w2 before we get to w3, we still want to
        share that (G a).
    Because it contains work-list things, DO NOT use the flat cache to solve
    a top-level goal.  Eg in the above example we don't want to solve w3
    using w3 itself!

The CFunEqCan Ownership Invariant:

  * Each [G/W/WD] CFunEqCan has a distinct fsk or fmv
    It &quot;owns&quot; that fsk/fmv, in the sense that:
      - reducing a [W/WD] CFunEqCan fills in the fmv
      - unflattening a [W/WD] CFunEqCan fills in the fmv
      (in both cases unless an occurs-check would result)

  * In contrast a [D] CFunEqCan does not &quot;own&quot; its fmv:
      - reducing a [D] CFunEqCan does not fill in the fmv;
        it just generates an equality
      - unflattening ignores [D] CFunEqCans altogether


Note [inert_eqs: the inert equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Definition [Can-rewrite relation]
A &quot;can-rewrite&quot; relation between flavours, written f1 &gt;= f2, is a
binary relation with the following properties

  (R1) &gt;= is transitive
  (R2) If f1 &gt;= f, and f2 &gt;= f,
       then either f1 &gt;= f2 or f2 &gt;= f1

Lemma.  If f1 &gt;= f then f1 &gt;= f1
Proof.  By property (R2), with f1=f2

Definition [Generalised substitution]
A &quot;generalised substitution&quot; S is a set of triples (a -f-&gt; t), where
  a is a type variable
  t is a type
  f is a flavour
such that
  (WF1) if (a -f1-&gt; t1) in S
           (a -f2-&gt; t2) in S
        then neither (f1 &gt;= f2) nor (f2 &gt;= f1) hold
  (WF2) if (a -f-&gt; t) is in S, then t /= a

Definition [Applying a generalised substitution]
If S is a generalised substitution
   S(f,a) = t,  if (a -fs-&gt; t) in S, and fs &gt;= f
          = a,  otherwise
Application extends naturally to types S(f,t), modulo roles.
See Note [Flavours with roles].

Theorem: S(f,a) is well defined as a function.
Proof: Suppose (a -f1-&gt; t1) and (a -f2-&gt; t2) are both in S,
               and  f1 &gt;= f and f2 &gt;= f
       Then by (R2) f1 &gt;= f2 or f2 &gt;= f1, which contradicts (WF1)

Notation: repeated application.
  S^0(f,t)     = t
  S^(n+1)(f,t) = S(f, S^n(t))

Definition: inert generalised substitution
A generalised substitution S is &quot;inert&quot; iff

  (IG1) there is an n such that
        for every f,t, S^n(f,t) = S^(n+1)(f,t)

By (IG1) we define S*(f,t) to be the result of exahaustively
applying S(f,_) to t.

----------------------------------------------------------------
Our main invariant:
   the inert CTyEqCans should be an inert generalised substitution
----------------------------------------------------------------

Note that inertness is not the same as idempotence.  To apply S to a
type, you may have to apply it recursive.  But inertness does
guarantee that this recursive use will terminate.

Note [Extending the inert equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Main Theorem [Stability under extension]
   Suppose we have a &quot;work item&quot;
       a -fw-&gt; t
   and an inert generalised substitution S,
   THEN the extended substitution T = S+(a -fw-&gt; t)
        is an inert generalised substitution
   PROVIDED
      (T1) S(fw,a) = a     -- LHS of work-item is a fixpoint of S(fw,_)
      (T2) S(fw,t) = t     -- RHS of work-item is a fixpoint of S(fw,_)
      (T3) a not in t      -- No occurs check in the work item

      AND, for every (b -fs-&gt; s) in S:
           (K0) not (fw &gt;= fs)
                Reason: suppose we kick out (a -fs-&gt; s),
                        and add (a -fw-&gt; t) to the inert set.
                        The latter can't rewrite the former,
                        so the kick-out achieved nothing

           OR { (K1) not (a = b)
                     Reason: if fw &gt;= fs, WF1 says we can't have both
                             a -fw-&gt; t  and  a -fs-&gt; s

                AND (K2): guarantees inertness of the new substitution
                    {  (K2a) not (fs &gt;= fs)
                    OR (K2b) fs &gt;= fw
                    OR (K2d) a not in s }

                AND (K3) See Note [K3: completeness of solving]
                    { (K3a) If the role of fs is nominal: s /= a
                      (K3b) If the role of fs is representational:
                            s is not of form (a t1 .. tn) } }


Conditions (T1-T3) are established by the canonicaliser
Conditions (K1-K3) are established by TcSMonad.kickOutRewritable

The idea is that
* (T1-2) are guaranteed by exhaustively rewriting the work-item
  with S(fw,_).

* T3 is guaranteed by a simple occurs-check on the work item.
  This is done during canonicalisation, in canEqTyVar;
  (invariant: a CTyEqCan never has an occurs check).

* (K1-3) are the &quot;kick-out&quot; criteria.  (As stated, they are really the
  &quot;keep&quot; criteria.) If the current inert S contains a triple that does
  not satisfy (K1-3), then we remove it from S by &quot;kicking it out&quot;,
  and re-processing it.

* Note that kicking out is a Bad Thing, because it means we have to
  re-process a constraint.  The less we kick out, the better.
  TODO: Make sure that kicking out really *is* a Bad Thing. We've assumed
  this but haven't done the empirical study to check.

* Assume we have  G&gt;=G, G&gt;=W and that's all.  Then, when performing
  a unification we add a new given  a -G-&gt; ty.  But doing so does NOT require
  us to kick out an inert wanted that mentions a, because of (K2a).  This
  is a common case, hence good not to kick out.

* Lemma (L2): if not (fw &gt;= fw), then K0 holds and we kick out nothing
  Proof: using Definition [Can-rewrite relation], fw can't rewrite anything
         and so K0 holds.  Intuitively, since fw can't rewrite anything,
         adding it cannot cause any loops
  This is a common case, because Wanteds cannot rewrite Wanteds.
  It's used to avoid even looking for constraint to kick out.

* Lemma (L1): The conditions of the Main Theorem imply that there is no
              (a -fs-&gt; t) in S, s.t.  (fs &gt;= fw).
  Proof. Suppose the contrary (fs &gt;= fw).  Then because of (T1),
  S(fw,a)=a.  But since fs&gt;=fw, S(fw,a) = s, hence s=a.  But now we
  have (a -fs-&gt; a) in S, which contradicts (WF2).

* The extended substitution satisfies (WF1) and (WF2)
  - (K1) plus (L1) guarantee that the extended substitution satisfies (WF1).
  - (T3) guarantees (WF2).

* (K2) is about inertness.  Intuitively, any infinite chain T^0(f,t),
  T^1(f,t), T^2(f,T).... must pass through the new work item infinitely
  often, since the substitution without the work item is inert; and must
  pass through at least one of the triples in S infinitely often.

  - (K2a): if not(fs&gt;=fs) then there is no f that fs can rewrite (fs&gt;=f),
    and hence this triple never plays a role in application S(f,a).
    It is always safe to extend S with such a triple.

    (NB: we could strengten K1) in this way too, but see K3.

  - (K2b): If this holds then, by (T2), b is not in t.  So applying the
    work item does not generate any new opportunities for applying S

  - (K2c): If this holds, we can't pass through this triple infinitely
    often, because if we did then fs&gt;=f, fw&gt;=f, hence by (R2)
      * either fw&gt;=fs, contradicting K2c
      * or fs&gt;=fw; so by the argument in K2b we can't have a loop

  - (K2d): if a not in s, we hae no further opportunity to apply the
    work item, similar to (K2b)

  NB: Dimitrios has a PDF that does this in more detail

Key lemma to make it watertight.
  Under the conditions of the Main Theorem,
  forall f st fw &gt;= f, a is not in S^k(f,t), for any k

Also, consider roles more carefully. See Note [Flavours with roles]

Note [K3: completeness of solving]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(K3) is not necessary for the extended substitution
to be inert.  In fact K1 could be made stronger by saying
   ... then (not (fw &gt;= fs) or not (fs &gt;= fs))
But it's not enough for S to be inert; we also want completeness.
That is, we want to be able to solve all soluble wanted equalities.
Suppose we have

   work-item   b -G-&gt; a
   inert-item  a -W-&gt; b

Assuming (G &gt;= W) but not (W &gt;= W), this fulfills all the conditions,
so we could extend the inerts, thus:

   inert-items   b -G-&gt; a
                 a -W-&gt; b

But if we kicked-out the inert item, we'd get

   work-item     a -W-&gt; b
   inert-item    b -G-&gt; a

Then rewrite the work-item gives us (a -W-&gt; a), which is soluble via Refl.
So we add one more clause to the kick-out criteria

Another way to understand (K3) is that we treat an inert item
        a -f-&gt; b
in the same way as
        b -f-&gt; a
So if we kick out one, we should kick out the other.  The orientation
is somewhat accidental.

When considering roles, we also need the second clause (K3b). Consider

  work-item    c -G/N-&gt; a
  inert-item   a -W/R-&gt; b c

The work-item doesn't get rewritten by the inert, because (&gt;=) doesn't hold.
But we don't kick out the inert item because not (W/R &gt;= W/R).  So we just
add the work item. But then, consider if we hit the following:

  work-item    b -G/N-&gt; Id
  inert-items  a -W/R-&gt; b c
               c -G/N-&gt; a
where
  newtype Id x = Id x

For similar reasons, if we only had (K3a), we wouldn't kick the
representational inert out. And then, we'd miss solving the inert, which
now reduced to reflexivity.

The solution here is to kick out representational inerts whenever the
tyvar of a work item is &quot;exposed&quot;, where exposed means being at the
head of the top-level application chain (a t1 .. tn).  See
TcType.isTyVarHead. This is encoded in (K3b).

Beware: if we make this test succeed too often, we kick out too much,
and the solver might loop.  Consider (Trac #14363)
  work item:   [G] a ~R f b
  inert item:  [G] b ~R f a
In GHC 8.2 the completeness tests more aggressive, and kicked out
the inert item; but no rewriting happened and there was an infinite
loop.  All we need is to have the tyvar at the head.

Note [Flavours with roles]
~~~~~~~~~~~~~~~~~~~~~~~~~~
The system described in Note [inert_eqs: the inert equalities]
discusses an abstract
set of flavours. In GHC, flavours have two components: the flavour proper,
taken from {Wanted, Derived, Given} and the equality relation (often called
role), taken from {NomEq, ReprEq}.
When substituting w.r.t. the inert set,
as described in Note [inert_eqs: the inert equalities],
we must be careful to respect all components of a flavour.
For example, if we have

  inert set: a -G/R-&gt; Int
             b -G/R-&gt; Bool

  type role T nominal representational

and we wish to compute S(W/R, T a b), the correct answer is T a Bool, NOT
T Int Bool. The reason is that T's first parameter has a nominal role, and
thus rewriting a to Int in T a b is wrong. Indeed, this non-congruence of
substitution means that the proof in Note [The inert equalities] may need
to be revisited, but we don't think that the end conclusion is wrong.
-}</span><span>
</span><a name="line-1013"></a><span>
</span><a name="line-1014"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1015"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753570"><a href="#local-6989586621682753570"><span class="hs-identifier">eqs</span></a></a><span>
</span><a name="line-1016"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753571"><a href="#local-6989586621682753571"><span class="hs-identifier">funeqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753572"><a href="#local-6989586621682753572"><span class="hs-identifier">dicts</span></a></a><span>
</span><a name="line-1017"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_safehask</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753573"><a href="#local-6989586621682753573"><span class="hs-identifier">safehask</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_irreds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753574"><a href="#local-6989586621682753574"><span class="hs-identifier">irreds</span></a></a><span>
</span><a name="line-1018"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753575"><a href="#local-6989586621682753575"><span class="hs-identifier">insts</span></a></a><span>
</span><a name="line-1019"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_count</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753576"><a href="#local-6989586621682753576"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-1021"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyDVarEnv</span><span> </span><a href="#local-6989586621682753570"><span class="hs-identifier hs-var">eqs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1022"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Equalities:&quot;</span><span>
</span><a name="line-1023"></a><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprCts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldDVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682753577"><a href="#local-6989586621682753577"><span class="hs-identifier">eqs</span></a></a><span> </span><a name="local-6989586621682753578"><a href="#local-6989586621682753578"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span> </span><a href="#local-6989586621682753577"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andCts</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753578"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">emptyCts</span><span> </span><a href="#local-6989586621682753570"><span class="hs-identifier hs-var">eqs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#isEmptyTcAppMap"><span class="hs-identifier hs-var">isEmptyTcAppMap</span></a><span> </span><a href="#local-6989586621682753571"><span class="hs-identifier hs-var">funeqs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1025"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Type-function equalities =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprCts</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#funEqsToBag"><span class="hs-identifier hs-var">funEqsToBag</span></a><span> </span><a href="#local-6989586621682753571"><span class="hs-identifier hs-var">funeqs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#isEmptyTcAppMap"><span class="hs-identifier hs-var">isEmptyTcAppMap</span></a><span> </span><a href="#local-6989586621682753572"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1027"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Dictionaries =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprCts</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#dictsToBag"><span class="hs-identifier hs-var">dictsToBag</span></a><span> </span><a href="#local-6989586621682753572"><span class="hs-identifier hs-var">dicts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1028"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#isEmptyTcAppMap"><span class="hs-identifier hs-var">isEmptyTcAppMap</span></a><span> </span><a href="#local-6989586621682753573"><span class="hs-identifier hs-var">safehask</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1029"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Safe Haskell unsafe overlap =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprCts</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#dictsToBag"><span class="hs-identifier hs-var">dictsToBag</span></a><span> </span><a href="#local-6989586621682753573"><span class="hs-identifier hs-var">safehask</span></a><span class="hs-special">)</span><span>
</span><a name="line-1030"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isEmptyCts</span><span> </span><a href="#local-6989586621682753574"><span class="hs-identifier hs-var">irreds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1031"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Irreds =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprCts</span><span> </span><a href="#local-6989586621682753574"><span class="hs-identifier hs-var">irreds</span></a><span>
</span><a name="line-1032"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682753575"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1033"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Given instances =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753575"><span class="hs-identifier hs-var">insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1034"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Unsolved goals =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621682753576"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-1035"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-1036"></a><span>
</span><a name="line-1037"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
             Shadow constraints and improvement
*                                                                      *
************************************************************************

Note [The improvement story and derived shadows]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Because Wanteds cannot rewrite Wanteds (see Note [Wanteds do not
rewrite Wanteds] in TcRnTypes), we may miss some opportunities for
solving.  Here's a classic example (indexed-types/should_fail/T4093a)

    Ambiguity check for f: (Foo e ~ Maybe e) =&gt; Foo e

    We get [G] Foo e ~ Maybe e
           [W] Foo e ~ Foo ee      -- ee is a unification variable
           [W] Foo ee ~ Maybe ee

    Flatten: [G] Foo e ~ fsk
             [G] fsk ~ Maybe e   -- (A)

             [W] Foo ee ~ fmv
             [W] fmv ~ fsk       -- (B) From Foo e ~ Foo ee
             [W] fmv ~ Maybe ee

    --&gt; rewrite (B) with (A)
             [W] Foo ee ~ fmv
             [W] fmv ~ Maybe e
             [W] fmv ~ Maybe ee

    But now we appear to be stuck, since we don't rewrite Wanteds with
    Wanteds.  This is silly because we can see that ee := e is the
    only solution.

The basic plan is
  * generate Derived constraints that shadow Wanted constraints
  * allow Derived to rewrite Derived
  * in order to cause some unifications to take place
  * that in turn solve the original Wanteds

The ONLY reason for all these Derived equalities is to tell us how to
unify a variable: that is, what Mark Jones calls &quot;improvement&quot;.

The same idea is sometimes also called &quot;saturation&quot;; find all the
equalities that must hold in any solution.

Or, equivalently, you can think of the derived shadows as implementing
the &quot;model&quot;: a non-idempotent but no-occurs-check substitution,
reflecting *all* *Nominal* equalities (a ~N ty) that are not
immediately soluble by unification.

More specifically, here's how it works (Oct 16):

* Wanted constraints are born as [WD]; this behaves like a
  [W] and a [D] paired together.

* When we are about to add a [WD] to the inert set, if it can
  be rewritten by a [D] a ~ ty, then we split it into [W] and [D],
  putting the latter into the work list (see maybeEmitShadow).

In the example above, we get to the point where we are stuck:
    [WD] Foo ee ~ fmv
    [WD] fmv ~ Maybe e
    [WD] fmv ~ Maybe ee

But now when [WD] fmv ~ Maybe ee is about to be added, we'll
split it into [W] and [D], since the inert [WD] fmv ~ Maybe e
can rewrite it.  Then:
    work item: [D] fmv ~ Maybe ee
    inert:     [W] fmv ~ Maybe ee
               [WD] fmv ~ Maybe e   -- (C)
               [WD] Foo ee ~ fmv

See Note [Splitting WD constraints].  Now the work item is rewritten
by (C) and we soon get ee := e.

Additional notes:

  * The derived shadow equalities live in inert_eqs, along with
    the Givens and Wanteds; see Note [EqualCtList invariants].

  * We make Derived shadows only for Wanteds, not Givens.  So we
    have only [G], not [GD] and [G] plus splitting.  See
    Note [Add derived shadows only for Wanteds]

  * We also get Derived equalities from functional dependencies
    and type-function injectivity; see calls to unifyDerived.

  * This splitting business applies to CFunEqCans too; and then
    we do apply type-function reductions to the [D] CFunEqCan.
    See Note [Reduction for Derived CFunEqCans]

  * It's worth having [WD] rather than just [W] and [D] because
    * efficiency: silly to process the same thing twice
    * inert_funeqs, inert_dicts is a finite map keyed by
      the type; it's inconvenient for it to map to TWO constraints

Note [Splitting WD constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We are about to add a [WD] constraint to the inert set; and we
know that the inert set has fully rewritten it.  Should we split
it into [W] and [D], and put the [D] in the work list for further
work?

* CDictCan (C tys) or CFunEqCan (F tys ~ fsk):
  Yes if the inert set could rewrite tys to make the class constraint,
  or type family, fire.  That is, yes if the inert_eqs intersects
  with the free vars of tys.  For this test we use
  (anyRewritableTyVar True) which ignores casts and coercions in tys,
  because rewriting the casts or coercions won't make the thing fire
  more often.

* CTyEqCan (a ~ ty): Yes if the inert set could rewrite 'a' or 'ty'.
  We need to check both 'a' and 'ty' against the inert set:
    - Inert set contains  [D] a ~ ty2
      Then we want to put [D] a ~ ty in the worklist, so we'll
      get [D] ty ~ ty2 with consequent good things

    - Inert set contains [D] b ~ a, where b is in ty.
      We can't just add [WD] a ~ ty[b] to the inert set, because
      that breaks the inert-set invariants.  If we tried to
      canonicalise another [D] constraint mentioning 'a', we'd
      get an infinite loop

  Moreover we must use (anyRewritableTyVar False) for the RHS,
  because even tyvars in the casts and coercions could give
  an infinite loop if we don't expose it

* CIrredCan: Yes if the inert set can rewrite the constraint.
  We used to think splitting irreds was unnecessary, but
  see Note [Splitting Irred WD constraints]

* Others: nothing is gained by splitting.

Note [Splitting Irred WD constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Splitting Irred constraints can make a difference. Here is the
scenario:

  a[sk] :: F v     -- F is a type family
  beta :: alpha

  work item: [WD] a ~ beta

This is heterogeneous, so we try flattening the kinds.

  co :: F v ~ fmv
  [WD] (a |&gt; co) ~ beta

This is still hetero, so we emit a kind equality and make the work item an
inert Irred.

  work item: [D] fmv ~ alpha
  inert: [WD] (a |&gt; co) ~ beta (CIrredCan)

Can't make progress on the work item. Add to inert set. This kicks out the
old inert, because a [D] can rewrite a [WD].

  work item: [WD] (a |&gt; co) ~ beta
  inert: [D] fmv ~ alpha (CTyEqCan)

Can't make progress on this work item either (although GHC tries by
decomposing the cast and reflattening... but that doesn't make a difference),
which is still hetero. Emit a new kind equality and add to inert set. But,
critically, we split the Irred.

  work list:
   [D] fmv ~ alpha (CTyEqCan)
   [D] (a |&gt; co) ~ beta (CIrred) -- this one was split off
  inert:
   [W] (a |&gt; co) ~ beta
   [D] fmv ~ alpha

We quickly solve the first work item, as it's the same as an inert.

  work item: [D] (a |&gt; co) ~ beta
  inert:
   [W] (a |&gt; co) ~ beta
   [D] fmv ~ alpha

We decompose the cast, yielding

  [D] a ~ beta

We then flatten the kinds. The lhs kind is F v, which flattens to fmv which
then rewrites to alpha.

  co' :: F v ~ alpha
  [D] (a |&gt; co') ~ beta

Now this equality is homo-kinded. So we swizzle it around to

  [D] beta ~ (a |&gt; co')

and set beta := a |&gt; co', and go home happy.

If we don't split the Irreds, we loop. This is all dangerously subtle.

This is triggered by test case typecheck/should_compile/SplitWD.

Note [Examples of how Derived shadows helps completeness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Trac #10009, a very nasty example:

    f :: (UnF (F b) ~ b) =&gt; F b -&gt; ()

    g :: forall a. (UnF (F a) ~ a) =&gt; a -&gt; ()
    g _ = f (undefined :: F a)

  For g we get [G] UnF (F a) ~ a
               [WD] UnF (F beta) ~ beta
               [WD] F a ~ F beta
  Flatten:
      [G] g1: F a ~ fsk1         fsk1 := F a
      [G] g2: UnF fsk1 ~ fsk2    fsk2 := UnF fsk1
      [G] g3: fsk2 ~ a

      [WD] w1: F beta ~ fmv1
      [WD] w2: UnF fmv1 ~ fmv2
      [WD] w3: fmv2 ~ beta
      [WD] w4: fmv1 ~ fsk1   -- From F a ~ F beta using flat-cache
                             -- and re-orient to put meta-var on left

Rewrite w2 with w4: [D] d1: UnF fsk1 ~ fmv2
React that with g2: [D] d2: fmv2 ~ fsk2
React that with w3: [D] beta ~ fsk2
            and g3: [D] beta ~ a -- Hooray beta := a
And that is enough to solve everything

Note [Add derived shadows only for Wanteds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We only add shadows for Wanted constraints. That is, we have
[WD] but not [GD]; and maybeEmitShaodw looks only at [WD]
constraints.

It does just possibly make sense ot add a derived shadow for a
Given. If we created a Derived shadow of a Given, it could be
rewritten by other Deriveds, and that could, conceivably, lead to a
useful unification.

But (a) I have been unable to come up with an example of this
        happening
    (b) see Trac #12660 for how adding the derived shadows
        of a Given led to an infinite loop.
    (c) It's unlikely that rewriting derived Givens will lead
        to a unification because Givens don't mention touchable
        unification variables

For (b) there may be other ways to solve the loop, but simply
reraining from adding derived shadows of Givens is particularly
simple.  And it's more efficient too!

Still, here's one possible reason for adding derived shadows
for Givens.  Consider
           work-item [G] a ~ [b], inerts has [D] b ~ a.
If we added the derived shadow (into the work list)
         [D] a ~ [b]
When we process it, we'll rewrite to a ~ [a] and get an
occurs check.  Without it we'll miss the occurs check (reporting
inaccessible code); but that's probably OK.

Note [Keep CDictCan shadows as CDictCan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have
  class C a =&gt; D a b
and [G] D a b, [G] C a in the inert set.  Now we insert
[D] b ~ c.  We want to kick out a derived shadow for [D] D a b,
so we can rewrite it with the new constraint, and perhaps get
instance reduction or other consequences.

BUT we do not want to kick out a *non-canonical* (D a b). If we
did, we would do this:
  - rewrite it to [D] D a c, with pend_sc = True
  - use expandSuperClasses to add C a
  - go round again, which solves C a from the givens
This loop goes on for ever and triggers the simpl_loop limit.

Solution: kick out the CDictCan which will have pend_sc = False,
because we've already added its superclasses.  So we won't re-add
them.  If we forget the pend_sc flag, our cunning scheme for avoiding
generating superclasses repeatedly will fail.

See Trac #11379 for a case of this.

Note [Do not do improvement for WOnly]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do improvement between two constraints (e.g. for injectivity
or functional dependencies) only if both are &quot;improvable&quot;. And
we improve a constraint wrt the top-level instances only if
it is improvable.

Improvable:     [G] [WD] [D}
Not improvable: [W]

Reasons:

* It's less work: fewer pairs to compare

* Every [W] has a shadow [D] so nothing is lost

* Consider [WD] C Int b,  where 'b' is a skolem, and
    class C a b | a -&gt; b
    instance C Int Bool
  We'll do a fundep on it and emit [D] b ~ Bool
  That will kick out constraint [WD] C Int b
  Then we'll split it to [W] C Int b (keep in inert)
                     and [D] C Int b (in work list)
  When processing the latter we'll rewrite it to
        [D] C Int Bool
  At that point it would be /stupid/ to interact it
  with the inert [W] C Int b in the inert set; after all,
  it's the very constraint from which the [D] C Int Bool
  was split!  We can avoid this by not doing improvement
  on [W] constraints. This came up in Trac #12860.
-}</span><span>
</span><a name="line-1352"></a><span>
</span><a name="line-1353"></a><span class="hs-identifier">maybeEmitShadow</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-1354"></a><span class="hs-comment">-- See Note [The improvement story and derived shadows]</span><span>
</span><a name="line-1355"></a><a name="maybeEmitShadow"><a href="TcSMonad.html#maybeEmitShadow"><span class="hs-identifier">maybeEmitShadow</span></a></a><span> </span><a name="local-6989586621682753690"><a href="#local-6989586621682753690"><span class="hs-identifier">ics</span></a></a><span> </span><a name="local-6989586621682753691"><a href="#local-6989586621682753691"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1356"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682753692"><a href="#local-6989586621682753692"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvidence</span><span> </span><a href="#local-6989586621682753691"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1357"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CtWanted</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753693"><a href="#local-6989586621682753693"><span class="hs-identifier">pred</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753694"><a href="#local-6989586621682753694"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-1358"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_nosh</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WDeriv</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753692"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1359"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#shouldSplitWD"><span class="hs-identifier hs-var">shouldSplitWD</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_eqs</span><span> </span><a href="#local-6989586621682753690"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753691"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1360"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;Emit derived shadow&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753691"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1361"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682753695"><a href="#local-6989586621682753695"><span class="hs-identifier">derived_ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CtDerived</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753693"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-1362"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_loc</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753694"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1363"></a><span>             </span><a name="local-6989586621682753696"><a href="#local-6989586621682753696"><span class="hs-identifier">shadow_ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753691"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753695"><span class="hs-identifier hs-var">derived_ev</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1364"></a><span>               </span><span class="hs-comment">-- Te shadow constraint keeps the canonical shape.</span><span>
</span><a name="line-1365"></a><span>               </span><span class="hs-comment">-- This just saves work, but is sometimes important;</span><span>
</span><a name="line-1366"></a><span>               </span><span class="hs-comment">-- see Note [Keep CDictCan shadows as CDictCan]</span><span>
</span><a name="line-1367"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#emitWork"><span class="hs-identifier hs-var">emitWork</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682753696"><span class="hs-identifier hs-var">shadow_ct</span></a><span class="hs-special">]</span><span>
</span><a name="line-1368"></a><span>
</span><a name="line-1369"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682753697"><a href="#local-6989586621682753697"><span class="hs-identifier">ev'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753692"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_nosh</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WOnly</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1370"></a><span>             </span><a name="local-6989586621682753698"><a href="#local-6989586621682753698"><span class="hs-identifier">ct'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753691"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753697"><span class="hs-identifier hs-var">ev'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1371"></a><span>                 </span><span class="hs-comment">-- Record that it now has a shadow</span><span>
</span><a name="line-1372"></a><span>                 </span><span class="hs-comment">-- This is /the/ place we set the flag to WOnly</span><span>
</span><a name="line-1373"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682753698"><span class="hs-identifier hs-var">ct'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1374"></a><span>
</span><a name="line-1375"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1376"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682753691"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1377"></a><span>
</span><a name="line-1378"></a><span class="hs-identifier">shouldSplitWD</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1379"></a><span class="hs-comment">-- Precondition: 'ct' is [WD], and is inert</span><span>
</span><a name="line-1380"></a><span class="hs-comment">-- True &lt;=&gt; we should split ct ito [W] and [D] because</span><span>
</span><a name="line-1381"></a><span class="hs-comment">--          the inert_eqs can make progress on the [D]</span><span>
</span><a name="line-1382"></a><span class="hs-comment">-- See Note [Splitting WD constraints]</span><span>
</span><a name="line-1383"></a><span>
</span><a name="line-1384"></a><a name="shouldSplitWD"><a href="TcSMonad.html#shouldSplitWD"><span class="hs-identifier">shouldSplitWD</span></a></a><span> </span><a name="local-6989586621682753699"><a href="#local-6989586621682753699"><span class="hs-identifier">inert_eqs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CFunEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753700"><a href="#local-6989586621682753700"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1385"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#should_split_match_args"><span class="hs-identifier hs-var">should_split_match_args</span></a><span> </span><a href="#local-6989586621682753699"><span class="hs-identifier hs-var">inert_eqs</span></a><span> </span><a href="#local-6989586621682753700"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1386"></a><span>    </span><span class="hs-comment">-- We don't need to split if the tv is the RHS fsk</span><span>
</span><a name="line-1387"></a><span>
</span><a name="line-1388"></a><span class="hs-identifier">shouldSplitWD</span><span> </span><a name="local-6989586621682753701"><a href="#local-6989586621682753701"><span class="hs-identifier">inert_eqs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753702"><a href="#local-6989586621682753702"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1389"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#should_split_match_args"><span class="hs-identifier hs-var">should_split_match_args</span></a><span> </span><a href="#local-6989586621682753701"><span class="hs-identifier hs-var">inert_eqs</span></a><span> </span><a href="#local-6989586621682753702"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1390"></a><span>    </span><span class="hs-comment">-- NB True: ignore coercions</span><span>
</span><a name="line-1391"></a><span>    </span><span class="hs-comment">-- See Note [Splitting WD constraints]</span><span>
</span><a name="line-1392"></a><span>
</span><a name="line-1393"></a><span class="hs-identifier">shouldSplitWD</span><span> </span><a name="local-6989586621682753703"><a href="#local-6989586621682753703"><span class="hs-identifier">inert_eqs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyvar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753704"><a href="#local-6989586621682753704"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753705"><a href="#local-6989586621682753705"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1394"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753706"><a href="#local-6989586621682753706"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1395"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621682753704"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemDVarEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753703"><span class="hs-identifier hs-var">inert_eqs</span></a><span>
</span><a name="line-1396"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">anyRewritableTyVar</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682753706"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#canRewriteTv"><span class="hs-identifier hs-var">canRewriteTv</span></a><span> </span><a href="#local-6989586621682753703"><span class="hs-identifier hs-var">inert_eqs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753705"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1397"></a><span>  </span><span class="hs-comment">-- NB False: do not ignore casts and coercions</span><span>
</span><a name="line-1398"></a><span>  </span><span class="hs-comment">-- See Note [Splitting WD constraints]</span><span>
</span><a name="line-1399"></a><span>
</span><a name="line-1400"></a><span class="hs-identifier">shouldSplitWD</span><span> </span><a name="local-6989586621682753707"><a href="#local-6989586621682753707"><span class="hs-identifier">inert_eqs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CIrredCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753708"><a href="#local-6989586621682753708"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1401"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">anyRewritableTyVar</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvEqRel</span><span> </span><a href="#local-6989586621682753708"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#canRewriteTv"><span class="hs-identifier hs-var">canRewriteTv</span></a><span> </span><a href="#local-6989586621682753707"><span class="hs-identifier hs-var">inert_eqs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682753708"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1402"></a><span>
</span><a name="line-1403"></a><span class="hs-identifier">shouldSplitWD</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>   </span><span class="hs-comment">-- No point in splitting otherwise</span><span>
</span><a name="line-1404"></a><span>
</span><a name="line-1405"></a><span class="hs-identifier">should_split_match_args</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1406"></a><span class="hs-comment">-- True if the inert_eqs can rewrite anything in the argument</span><span>
</span><a name="line-1407"></a><span class="hs-comment">-- types, ignoring casts and coercions</span><span>
</span><a name="line-1408"></a><a name="should_split_match_args"><a href="TcSMonad.html#should_split_match_args"><span class="hs-identifier">should_split_match_args</span></a></a><span> </span><a name="local-6989586621682753709"><a href="#local-6989586621682753709"><span class="hs-identifier">inert_eqs</span></a></a><span> </span><a name="local-6989586621682753710"><a href="#local-6989586621682753710"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1409"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">anyRewritableTyVar</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#canRewriteTv"><span class="hs-identifier hs-var">canRewriteTv</span></a><span> </span><a href="#local-6989586621682753709"><span class="hs-identifier hs-var">inert_eqs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753710"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1410"></a><span>    </span><span class="hs-comment">-- NB True: ignore casts coercions</span><span>
</span><a name="line-1411"></a><span>    </span><span class="hs-comment">-- See Note [Splitting WD constraints]</span><span>
</span><a name="line-1412"></a><span>
</span><a name="line-1413"></a><span class="hs-identifier">canRewriteTv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1414"></a><a name="canRewriteTv"><a href="TcSMonad.html#canRewriteTv"><span class="hs-identifier">canRewriteTv</span></a></a><span> </span><a name="local-6989586621682753711"><a href="#local-6989586621682753711"><span class="hs-identifier">inert_eqs</span></a></a><span> </span><a name="local-6989586621682753712"><a href="#local-6989586621682753712"><span class="hs-identifier">eq_rel</span></a></a><span> </span><a name="local-6989586621682753713"><a href="#local-6989586621682753713"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1415"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682753714"><a href="#local-6989586621682753714"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupDVarEnv</span><span> </span><a href="#local-6989586621682753711"><span class="hs-identifier hs-var">inert_eqs</span></a><span> </span><a href="#local-6989586621682753713"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1416"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753715"><a href="#local-6989586621682753715"><span class="hs-identifier">eq_rel1</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753714"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1417"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753715"><span class="hs-identifier hs-var">eq_rel1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqCanRewrite</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753712"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-1418"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1419"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1420"></a><span>
</span><a name="line-1421"></a><span class="hs-identifier">isImprovable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1422"></a><span class="hs-comment">-- See Note [Do not do improvement for WOnly]</span><span>
</span><a name="line-1423"></a><a name="isImprovable"><a href="TcSMonad.html#isImprovable"><span class="hs-identifier">isImprovable</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CtWanted</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_nosh</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WOnly</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1424"></a><span class="hs-identifier">isImprovable</span><span> </span><span class="hs-identifier">_</span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1425"></a><span>
</span><a name="line-1426"></a><span>
</span><a name="line-1427"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   Inert equalities
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1432"></a><span>
</span><a name="line-1433"></a><span class="hs-identifier">addTyEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span>
</span><a name="line-1434"></a><a name="addTyEq"><a href="TcSMonad.html#addTyEq"><span class="hs-identifier">addTyEq</span></a></a><span> </span><a name="local-6989586621682753716"><a href="#local-6989586621682753716"><span class="hs-identifier">old_eqs</span></a></a><span> </span><a name="local-6989586621682753717"><a href="#local-6989586621682753717"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682753718"><a href="#local-6989586621682753718"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1435"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendDVarEnv_C</span><span> </span><a href="#local-6989586621682753719"><span class="hs-identifier hs-var">add_eq</span></a><span> </span><a href="#local-6989586621682753716"><span class="hs-identifier hs-var">old_eqs</span></a><span> </span><a href="#local-6989586621682753717"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682753718"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">]</span><span>
</span><a name="line-1436"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1437"></a><span>    </span><a name="local-6989586621682753719"><a href="#local-6989586621682753719"><span class="hs-identifier">add_eq</span></a></a><span> </span><a name="local-6989586621682753720"><a href="#local-6989586621682753720"><span class="hs-identifier">old_eqs</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1438"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWantedCt</span><span> </span><a href="#local-6989586621682753718"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1439"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682753721"><a href="#local-6989586621682753721"><span class="hs-identifier">eq1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682753722"><a href="#local-6989586621682753722"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753720"><span class="hs-identifier hs-var">old_eqs</span></a><span>
</span><a name="line-1440"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753721"><span class="hs-identifier hs-var">eq1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682753718"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682753722"><span class="hs-identifier hs-var">eqs</span></a><span>
</span><a name="line-1441"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1442"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753718"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682753720"><span class="hs-identifier hs-var">old_eqs</span></a><span>
</span><a name="line-1443"></a><span>
</span><a name="line-1444"></a><span class="hs-identifier">foldTyEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753636"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753636"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753636"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753636"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1445"></a><a name="foldTyEqs"><a href="TcSMonad.html#foldTyEqs"><span class="hs-identifier">foldTyEqs</span></a></a><span> </span><a name="local-6989586621682753723"><a href="#local-6989586621682753723"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621682753724"><a href="#local-6989586621682753724"><span class="hs-identifier">eqs</span></a></a><span> </span><a name="local-6989586621682753725"><a href="#local-6989586621682753725"><span class="hs-identifier">z</span></a></a><span>
</span><a name="line-1446"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldDVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682753726"><a href="#local-6989586621682753726"><span class="hs-identifier">cts</span></a></a><span> </span><a name="local-6989586621682753727"><a href="#local-6989586621682753727"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682753723"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621682753727"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621682753726"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753725"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621682753724"><span class="hs-identifier hs-var">eqs</span></a><span>
</span><a name="line-1447"></a><span>
</span><a name="line-1448"></a><span class="hs-identifier">findTyEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span>
</span><a name="line-1449"></a><a name="findTyEqs"><a href="TcSMonad.html#findTyEqs"><span class="hs-identifier">findTyEqs</span></a></a><span> </span><a name="local-6989586621682753728"><a href="#local-6989586621682753728"><span class="hs-identifier">icans</span></a></a><span> </span><a name="local-6989586621682753729"><a href="#local-6989586621682753729"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupDVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_eqs</span><span> </span><a href="#local-6989586621682753728"><span class="hs-identifier hs-var">icans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753729"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1450"></a><span>
</span><a name="line-1451"></a><span class="hs-identifier">delTyEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span>
</span><a name="line-1452"></a><a name="delTyEq"><a href="TcSMonad.html#delTyEq"><span class="hs-identifier">delTyEq</span></a></a><span> </span><a name="local-6989586621682753730"><a href="#local-6989586621682753730"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682753731"><a href="#local-6989586621682753731"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682753732"><a href="#local-6989586621682753732"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modifyDVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682753733"><span class="hs-identifier hs-var">isThisOne</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753730"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682753731"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1453"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682753733"><a href="#local-6989586621682753733"><span class="hs-identifier">isThisOne</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753734"><a href="#local-6989586621682753734"><span class="hs-identifier">t1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqType</span><span> </span><a href="#local-6989586621682753732"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621682753734"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-1454"></a><span>        </span><span class="hs-identifier">isThisOne</span><span> </span><span class="hs-identifier">_</span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1455"></a><span>
</span><a name="line-1456"></a><span class="hs-identifier">lookupInertTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-1457"></a><a name="lookupInertTyVar"><a href="TcSMonad.html#lookupInertTyVar"><span class="hs-identifier">lookupInertTyVar</span></a></a><span> </span><a name="local-6989586621682753735"><a href="#local-6989586621682753735"><span class="hs-identifier">ieqs</span></a></a><span> </span><a name="local-6989586621682753736"><a href="#local-6989586621682753736"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1458"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupDVarEnv</span><span> </span><a href="#local-6989586621682753735"><span class="hs-identifier hs-var">ieqs</span></a><span> </span><a href="#local-6989586621682753736"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1459"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753737"><a href="#local-6989586621682753737"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682753737"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1460"></a><span>      </span><span class="hs-identifier">_</span><span>                                                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1461"></a><span>
</span><a name="line-1462"></a><span class="hs-identifier">lookupFlattenTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertEqs"><span class="hs-identifier hs-type">InertEqs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-1463"></a><span class="hs-comment">-- See Note [lookupFlattenTyVar]</span><span>
</span><a name="line-1464"></a><a name="lookupFlattenTyVar"><a href="TcSMonad.html#lookupFlattenTyVar"><span class="hs-identifier">lookupFlattenTyVar</span></a></a><span> </span><a name="local-6989586621682753738"><a href="#local-6989586621682753738"><span class="hs-identifier">ieqs</span></a></a><span> </span><a name="local-6989586621682753739"><a href="#local-6989586621682753739"><span class="hs-identifier">ftv</span></a></a><span>
</span><a name="line-1465"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#lookupInertTyVar"><span class="hs-identifier hs-var">lookupInertTyVar</span></a><span> </span><a href="#local-6989586621682753738"><span class="hs-identifier hs-var">ieqs</span></a><span> </span><a href="#local-6989586621682753739"><span class="hs-identifier hs-var">ftv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682753739"><span class="hs-identifier hs-var">ftv</span></a><span>
</span><a name="line-1466"></a><span>
</span><a name="line-1467"></a><span class="hs-comment">{- Note [lookupFlattenTyVar]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have an injective function F and
  inert_funeqs:   F t1 ~ fsk1
                  F t2 ~ fsk2
  inert_eqs:      fsk1 ~ fsk2

We never rewrite the RHS (cc_fsk) of a CFunEqCan.  But we /do/ want to
get the [D] t1 ~ t2 from the injectiveness of F.  So we look up the
cc_fsk of CFunEqCans in the inert_eqs when trying to find derived
equalities arising from injectivity.
-}</span><span>
</span><a name="line-1479"></a><span>
</span><a name="line-1480"></a><span>
</span><a name="line-1481"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   Inert instances: inert_insts
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1486"></a><span>
</span><a name="line-1487"></a><span class="hs-identifier">addInertForAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">QCInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1488"></a><span class="hs-comment">-- Add a local Given instance, typically arising from a type signature</span><span>
</span><a name="line-1489"></a><a name="addInertForAll"><a href="TcSMonad.html#addInertForAll"><span class="hs-identifier">addInertForAll</span></a></a><span> </span><a name="local-6989586621682753740"><a href="#local-6989586621682753740"><span class="hs-identifier">new_qci</span></a></a><span>
</span><a name="line-1490"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682753745"><a href="#local-6989586621682753745"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1491"></a><span>    </span><a href="#local-6989586621682753745"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753741"><span class="hs-identifier hs-var">add_qci</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_insts</span><span> </span><a href="#local-6989586621682753745"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1492"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1493"></a><span>    </span><span class="hs-identifier">add_qci</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">QCInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">QCInst</span><span class="hs-special">]</span><span>
</span><a name="line-1494"></a><span>    </span><span class="hs-comment">-- See Note [Do not add duplicate quantified instances]</span><span>
</span><a name="line-1495"></a><span>    </span><a name="local-6989586621682753741"><a href="#local-6989586621682753741"><span class="hs-identifier">add_qci</span></a></a><span> </span><a name="local-6989586621682753743"><a href="#local-6989586621682753743"><span class="hs-identifier">qcis</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621682753742"><span class="hs-identifier hs-var">same_qci</span></a><span> </span><a href="#local-6989586621682753743"><span class="hs-identifier hs-var">qcis</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753743"><span class="hs-identifier hs-var">qcis</span></a><span>
</span><a name="line-1496"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753740"><span class="hs-identifier hs-var">new_qci</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682753743"><span class="hs-identifier hs-var">qcis</span></a><span>
</span><a name="line-1497"></a><span>
</span><a name="line-1498"></a><span>    </span><a name="local-6989586621682753742"><a href="#local-6989586621682753742"><span class="hs-identifier">same_qci</span></a></a><span> </span><a name="local-6989586621682753744"><a href="#local-6989586621682753744"><span class="hs-identifier">old_qci</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tcEqType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">qci_ev</span><span> </span><a href="#local-6989586621682753744"><span class="hs-identifier hs-var">old_qci</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1499"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">qci_ev</span><span> </span><a href="#local-6989586621682753740"><span class="hs-identifier hs-var">new_qci</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1500"></a><span>
</span><a name="line-1501"></a><span class="hs-comment">{- Note [Do not add duplicate quantified instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (Trac #15244):

  f :: (C g, D g) =&gt; ....
  class S g =&gt; C g where ...
  class S g =&gt; D g where ...
  class (forall a. Eq a =&gt; Eq (g a)) =&gt; S g where ...

Then in f's RHS there are two identical quantified constraints
available, one via the superclasses of C and one via the superclasses
of D.  The two are identical, and it seems wrong to reject the program
because of that. But without doing duplicate-elimination we will have
two matching QCInsts when we try to solve constraints arising from f's
RHS.

The simplest thing is simply to eliminate duplicattes, which we do here.
-}</span><span>
</span><a name="line-1519"></a><span>
</span><a name="line-1520"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                  Adding an inert
*                                                                      *
************************************************************************

Note [Adding an equality to the InertCans]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When adding an equality to the inerts:

* Split [WD] into [W] and [D] if the inerts can rewrite the latter;
  done by maybeEmitShadow.

* Kick out any constraints that can be rewritten by the thing
  we are adding.  Done by kickOutRewritable.

* Note that unifying a:=ty, is like adding [G] a~ty; just use
  kickOutRewritable with Nominal, Given.  See kickOutAfterUnification.

Note [Kicking out CFunEqCan for fundeps]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:
   New:    [D] fmv1 ~ fmv2
   Inert:  [W] F alpha ~ fmv1
           [W] F beta  ~ fmv2

where F is injective. The new (derived) equality certainly can't
rewrite the inerts. But we *must* kick out the first one, to get:

   New:   [W] F alpha ~ fmv1
   Inert: [W] F beta ~ fmv2
          [D] fmv1 ~ fmv2

and now improvement will discover [D] alpha ~ beta. This is important;
eg in Trac #9587.

So in kickOutRewritable we look at all the tyvars of the
CFunEqCan, including the fsk.
-}</span><span>
</span><a name="line-1559"></a><span>
</span><a name="line-1560"></a><span class="hs-identifier">addInertCan</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Constraints *other than* equalities</span><span>
</span><a name="line-1561"></a><span class="hs-comment">-- Precondition: item /is/ canonical</span><span>
</span><a name="line-1562"></a><span class="hs-comment">-- See Note [Adding an equality to the InertCans]</span><span>
</span><a name="line-1563"></a><a name="addInertCan"><a href="TcSMonad.html#addInertCan"><span class="hs-identifier">addInertCan</span></a></a><span> </span><a name="local-6989586621682753746"><a href="#local-6989586621682753746"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1564"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;insertInertCan {&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1565"></a><span>         </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Trying to insert new inert item:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753746"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1566"></a><span>
</span><a name="line-1567"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682753747"><a href="#local-6989586621682753747"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span>
</span><a name="line-1568"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682753748"><a href="#local-6989586621682753748"><span class="hs-identifier">ct</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#maybeEmitShadow"><span class="hs-identifier hs-var">maybeEmitShadow</span></a><span> </span><a href="#local-6989586621682753747"><span class="hs-identifier hs-var">ics</span></a><span> </span><a href="#local-6989586621682753746"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1569"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682753749"><a href="#local-6989586621682753749"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#maybeKickOut"><span class="hs-identifier hs-var">maybeKickOut</span></a><span> </span><a href="#local-6989586621682753747"><span class="hs-identifier hs-var">ics</span></a><span> </span><a href="#local-6989586621682753748"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1570"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setInertCans"><span class="hs-identifier hs-var">setInertCans</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#add_item"><span class="hs-identifier hs-var">add_item</span></a><span> </span><a href="#local-6989586621682753749"><span class="hs-identifier hs-var">ics</span></a><span> </span><a href="#local-6989586621682753748"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1571"></a><span>
</span><a name="line-1572"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;addInertCan }&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1573"></a><span>
</span><a name="line-1574"></a><span class="hs-identifier">maybeKickOut</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-1575"></a><span class="hs-comment">-- For a CTyEqCan, kick out any inert that can be rewritten by the CTyEqCan</span><span>
</span><a name="line-1576"></a><a name="maybeKickOut"><a href="TcSMonad.html#maybeKickOut"><span class="hs-identifier">maybeKickOut</span></a></a><span> </span><a name="local-6989586621682753750"><a href="#local-6989586621682753750"><span class="hs-identifier">ics</span></a></a><span> </span><a name="local-6989586621682753751"><a href="#local-6989586621682753751"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-1577"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyvar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753752"><a href="#local-6989586621682753752"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753753"><a href="#local-6989586621682753753"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753754"><a href="#local-6989586621682753754"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753751"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1578"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682753755"><a href="#local-6989586621682753755"><span class="hs-identifier">ics'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#kickOutRewritable"><span class="hs-identifier hs-var">kickOutRewritable</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvFlavour</span><span> </span><a href="#local-6989586621682753753"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753754"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753752"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682753750"><span class="hs-identifier hs-var">ics</span></a><span>
</span><a name="line-1579"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682753755"><span class="hs-identifier hs-var">ics'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1580"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1581"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682753750"><span class="hs-identifier hs-var">ics</span></a><span>
</span><a name="line-1582"></a><span>
</span><a name="line-1583"></a><span class="hs-identifier">add_item</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-1584"></a><a name="add_item"><a href="TcSMonad.html#add_item"><span class="hs-identifier">add_item</span></a></a><span> </span><a name="local-6989586621682753756"><a href="#local-6989586621682753756"><span class="hs-identifier">ics</span></a></a><span> </span><a name="local-6989586621682753757"><a href="#local-6989586621682753757"><span class="hs-identifier">item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CFunEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753758"><a href="#local-6989586621682753758"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753759"><a href="#local-6989586621682753759"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1585"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753756"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#insertFunEq"><span class="hs-identifier hs-var">insertFunEq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_funeqs</span><span> </span><a href="#local-6989586621682753756"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753758"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682753759"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682753757"><span class="hs-identifier hs-var">item</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1586"></a><span>
</span><a name="line-1587"></a><span class="hs-identifier">add_item</span><span> </span><a name="local-6989586621682753760"><a href="#local-6989586621682753760"><span class="hs-identifier">ics</span></a></a><span> </span><a name="local-6989586621682753761"><a href="#local-6989586621682753761"><span class="hs-identifier">item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyvar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753762"><a href="#local-6989586621682753762"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753763"><a href="#local-6989586621682753763"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1588"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753760"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_eqs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#addTyEq"><span class="hs-identifier hs-var">addTyEq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_eqs</span><span> </span><a href="#local-6989586621682753760"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753762"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682753761"><span class="hs-identifier hs-var">item</span></a><span>
</span><a name="line-1589"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_count</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#bumpUnsolvedCount"><span class="hs-identifier hs-var">bumpUnsolvedCount</span></a><span> </span><a href="#local-6989586621682753763"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_count</span><span> </span><a href="#local-6989586621682753760"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1590"></a><span>
</span><a name="line-1591"></a><span class="hs-identifier">add_item</span><span> </span><a name="local-6989586621682753764"><a href="#local-6989586621682753764"><span class="hs-identifier">ics</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_irreds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753765"><a href="#local-6989586621682753765"><span class="hs-identifier">irreds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_count</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753766"><a href="#local-6989586621682753766"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1592"></a><span>         </span><a name="local-6989586621682753767"><a href="#local-6989586621682753767"><span class="hs-identifier">item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CIrredCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753768"><a href="#local-6989586621682753768"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_insol</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753769"><a href="#local-6989586621682753769"><span class="hs-identifier">insoluble</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1593"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753764"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_irreds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753765"><span class="hs-identifier hs-var">irreds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Bag.snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753767"><span class="hs-identifier hs-var">item</span></a><span>
</span><a name="line-1594"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_count</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682753769"><span class="hs-identifier hs-var">insoluble</span></a><span>
</span><a name="line-1595"></a><span>                         </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621682753766"><span class="hs-identifier hs-var">count</span></a><span>  </span><span class="hs-comment">-- inert_count does not include insolubles</span><span>
</span><a name="line-1596"></a><span>                         </span><span class="hs-keyword">else</span><span> </span><a href="TcSMonad.html#bumpUnsolvedCount"><span class="hs-identifier hs-var">bumpUnsolvedCount</span></a><span> </span><a href="#local-6989586621682753768"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682753766"><span class="hs-identifier hs-var">count</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1597"></a><span>
</span><a name="line-1598"></a><span class="hs-identifier">add_item</span><span> </span><a name="local-6989586621682753770"><a href="#local-6989586621682753770"><span class="hs-identifier">ics</span></a></a><span> </span><a name="local-6989586621682753771"><a href="#local-6989586621682753771"><span class="hs-identifier">item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753772"><a href="#local-6989586621682753772"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753773"><a href="#local-6989586621682753773"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753774"><a href="#local-6989586621682753774"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1599"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753770"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#addDict"><span class="hs-identifier hs-var">addDict</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_dicts</span><span> </span><a href="#local-6989586621682753770"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753773"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682753774"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682753771"><span class="hs-identifier hs-var">item</span></a><span>
</span><a name="line-1600"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_count</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#bumpUnsolvedCount"><span class="hs-identifier hs-var">bumpUnsolvedCount</span></a><span> </span><a href="#local-6989586621682753772"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_count</span><span> </span><a href="#local-6989586621682753770"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1601"></a><span>
</span><a name="line-1602"></a><span class="hs-identifier">add_item</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682753775"><a href="#local-6989586621682753775"><span class="hs-identifier">item</span></a></a><span>
</span><a name="line-1603"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;upd_inert set: can't happen! Inserting &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1604"></a><span>    </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753775"><span class="hs-identifier hs-var">item</span></a><span>   </span><span class="hs-comment">-- Can't be CNonCanonical, CHoleCan,</span><span>
</span><a name="line-1605"></a><span>               </span><span class="hs-comment">-- because they only land in inert_irreds</span><span>
</span><a name="line-1606"></a><span>
</span><a name="line-1607"></a><span class="hs-identifier">bumpUnsolvedCount</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1608"></a><a name="bumpUnsolvedCount"><a href="TcSMonad.html#bumpUnsolvedCount"><span class="hs-identifier">bumpUnsolvedCount</span></a></a><span> </span><a name="local-6989586621682753776"><a href="#local-6989586621682753776"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682753777"><a href="#local-6989586621682753777"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWanted</span><span> </span><a href="#local-6989586621682753776"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753777"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span>
</span><a name="line-1609"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753777"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1610"></a><span>
</span><a name="line-1611"></a><span>
</span><a name="line-1612"></a><span class="hs-comment">-----------------------------------------</span><span>
</span><a name="line-1613"></a><span class="hs-identifier">kickOutRewritable</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtFlavourRole</span><span>  </span><span class="hs-comment">-- Flavour/role of the equality that</span><span>
</span><a name="line-1614"></a><span>                                      </span><span class="hs-comment">-- is being added to the inert set</span><span>
</span><a name="line-1615"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>        </span><span class="hs-comment">-- The new equality is tv ~ ty</span><span>
</span><a name="line-1616"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-1617"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span class="hs-special">)</span><span>
</span><a name="line-1618"></a><a name="kickOutRewritable"><a href="TcSMonad.html#kickOutRewritable"><span class="hs-identifier">kickOutRewritable</span></a></a><span> </span><a name="local-6989586621682753778"><a href="#local-6989586621682753778"><span class="hs-identifier">new_fr</span></a></a><span> </span><a name="local-6989586621682753779"><a href="#local-6989586621682753779"><span class="hs-identifier">new_tv</span></a></a><span> </span><a name="local-6989586621682753780"><a href="#local-6989586621682753780"><span class="hs-identifier">ics</span></a></a><span>
</span><a name="line-1619"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682753781"><a href="#local-6989586621682753781"><span class="hs-identifier">kicked_out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753782"><a href="#local-6989586621682753782"><span class="hs-identifier">ics'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#kick_out_rewritable"><span class="hs-identifier hs-var">kick_out_rewritable</span></a><span> </span><a href="#local-6989586621682753778"><span class="hs-identifier hs-var">new_fr</span></a><span> </span><a href="#local-6989586621682753779"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621682753780"><span class="hs-identifier hs-var">ics</span></a><span>
</span><a name="line-1620"></a><span>             </span><a name="local-6989586621682753783"><a href="#local-6989586621682753783"><span class="hs-identifier">n_kicked</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#workListSize"><span class="hs-identifier hs-var">workListSize</span></a><span> </span><a href="#local-6989586621682753781"><span class="hs-identifier hs-var">kicked_out</span></a><span>
</span><a name="line-1621"></a><span>
</span><a name="line-1622"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753783"><span class="hs-identifier hs-var">n_kicked</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1623"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#updWorkListTcS"><span class="hs-identifier hs-var">updWorkListTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#appendWorkList"><span class="hs-identifier hs-var">appendWorkList</span></a><span> </span><a href="#local-6989586621682753781"><span class="hs-identifier hs-var">kicked_out</span></a><span class="hs-special">)</span><span>
</span><a name="line-1624"></a><span>            </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#csTraceTcS"><span class="hs-identifier hs-var">csTraceTcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1625"></a><span>              </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Kick out, tv =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753779"><span class="hs-identifier hs-var">new_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1626"></a><span>                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;n-kicked =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621682753783"><span class="hs-identifier hs-var">n_kicked</span></a><span>
</span><a name="line-1627"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;kicked_out =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753781"><span class="hs-identifier hs-var">kicked_out</span></a><span>
</span><a name="line-1628"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Residual inerts =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753782"><span class="hs-identifier hs-var">ics'</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1629"></a><span>
</span><a name="line-1630"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753783"><span class="hs-identifier hs-var">n_kicked</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753782"><span class="hs-identifier hs-var">ics'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1631"></a><span>
</span><a name="line-1632"></a><span class="hs-identifier">kick_out_rewritable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtFlavourRole</span><span>  </span><span class="hs-comment">-- Flavour/role of the equality that</span><span>
</span><a name="line-1633"></a><span>                                      </span><span class="hs-comment">-- is being added to the inert set</span><span>
</span><a name="line-1634"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span>        </span><span class="hs-comment">-- The new equality is tv ~ ty</span><span>
</span><a name="line-1635"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-1636"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span class="hs-special">)</span><span>
</span><a name="line-1637"></a><span class="hs-comment">-- See Note [kickOutRewritable]</span><span>
</span><a name="line-1638"></a><a name="kick_out_rewritable"><a href="TcSMonad.html#kick_out_rewritable"><span class="hs-identifier">kick_out_rewritable</span></a></a><span> </span><a name="local-6989586621682753784"><a href="#local-6989586621682753784"><span class="hs-identifier">new_fr</span></a></a><span> </span><a name="local-6989586621682753785"><a href="#local-6989586621682753785"><span class="hs-identifier">new_tv</span></a></a><span>
</span><a name="line-1639"></a><span>                    </span><a name="local-6989586621682753786"><a href="#local-6989586621682753786"><span class="hs-identifier">ics</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_eqs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753787"><a href="#local-6989586621682753787"><span class="hs-identifier">tv_eqs</span></a></a><span>
</span><a name="line-1640"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_dicts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753788"><a href="#local-6989586621682753788"><span class="hs-identifier">dictmap</span></a></a><span>
</span><a name="line-1641"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_safehask</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753789"><a href="#local-6989586621682753789"><span class="hs-identifier">safehask</span></a></a><span>
</span><a name="line-1642"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_funeqs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753790"><a href="#local-6989586621682753790"><span class="hs-identifier">funeqmap</span></a></a><span>
</span><a name="line-1643"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_irreds</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753791"><a href="#local-6989586621682753791"><span class="hs-identifier">irreds</span></a></a><span>
</span><a name="line-1644"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753792"><a href="#local-6989586621682753792"><span class="hs-identifier">old_insts</span></a></a><span>
</span><a name="line-1645"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_count</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753793"><a href="#local-6989586621682753793"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1646"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753784"><span class="hs-identifier hs-var">new_fr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqMayRewriteFR</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753784"><span class="hs-identifier hs-var">new_fr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1647"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#emptyWorkList"><span class="hs-identifier hs-var">emptyWorkList</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753786"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span>
</span><a name="line-1648"></a><span>        </span><span class="hs-comment">-- If new_fr can't rewrite itself, it can't rewrite</span><span>
</span><a name="line-1649"></a><span>        </span><span class="hs-comment">-- anything else, so no need to kick out anything.</span><span>
</span><a name="line-1650"></a><span>        </span><span class="hs-comment">-- (This is a common case: wanteds can't rewrite wanteds)</span><span>
</span><a name="line-1651"></a><span>        </span><span class="hs-comment">-- Lemma (L2) in Note [Extending the inert equalities]</span><span>
</span><a name="line-1652"></a><span>
</span><a name="line-1653"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1654"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753795"><span class="hs-identifier hs-var">kicked_out</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753794"><span class="hs-identifier hs-var">inert_cans_in</span></a><span class="hs-special">)</span><span>
</span><a name="line-1655"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1656"></a><span>    </span><a name="local-6989586621682753794"><a href="#local-6989586621682753794"><span class="hs-identifier">inert_cans_in</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_eqs</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753797"><span class="hs-identifier hs-var">tv_eqs_in</span></a><span>
</span><a name="line-1657"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_dicts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753801"><span class="hs-identifier hs-var">dicts_in</span></a><span>
</span><a name="line-1658"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_safehask</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753789"><span class="hs-identifier hs-var">safehask</span></a><span>   </span><span class="hs-comment">-- ??</span><span>
</span><a name="line-1659"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_funeqs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753799"><span class="hs-identifier hs-var">feqs_in</span></a><span>
</span><a name="line-1660"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_irreds</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753803"><span class="hs-identifier hs-var">irs_in</span></a><span>
</span><a name="line-1661"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753805"><span class="hs-identifier hs-var">insts_in</span></a><span>
</span><a name="line-1662"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_count</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753793"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="TcSMonad.html#workListWantedCount"><span class="hs-identifier hs-var">workListWantedCount</span></a><span> </span><a href="#local-6989586621682753795"><span class="hs-identifier hs-var">kicked_out</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1663"></a><span>
</span><a name="line-1664"></a><span>    </span><span class="hs-identifier">kicked_out</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span>
</span><a name="line-1665"></a><span>    </span><span class="hs-comment">-- NB: use extendWorkList to ensure that kicked-out equalities get priority</span><span>
</span><a name="line-1666"></a><span>    </span><span class="hs-comment">-- See Note [Prioritise equality constraints] (Kick-out).</span><span>
</span><a name="line-1667"></a><span>    </span><span class="hs-comment">-- The irreds may include non-canonical (hetero-kinded) equality</span><span>
</span><a name="line-1668"></a><span>    </span><span class="hs-comment">-- constraints, which perhaps may have become soluble after new_tv</span><span>
</span><a name="line-1669"></a><span>    </span><span class="hs-comment">-- is substituted; ditto the dictionaries, which may include (a~b)</span><span>
</span><a name="line-1670"></a><span>    </span><span class="hs-comment">-- or (a~~b) constraints.</span><span>
</span><a name="line-1671"></a><span>    </span><a name="local-6989586621682753795"><a href="#local-6989586621682753795"><span class="hs-identifier">kicked_out</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><a href="TcSMonad.html#extendWorkListCt"><span class="hs-identifier hs-var">extendWorkListCt</span></a><span>
</span><a name="line-1672"></a><span>                          </span><span class="hs-special">(</span><a href="TcSMonad.html#emptyWorkList"><span class="hs-identifier hs-var">emptyWorkList</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">wl_eqs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753796"><span class="hs-identifier hs-var">tv_eqs_out</span></a><span>
</span><a name="line-1673"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wl_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753798"><span class="hs-identifier hs-var">feqs_out</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1674"></a><span>                          </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621682753800"><span class="hs-identifier hs-var">dicts_out</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andCts</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753802"><span class="hs-identifier hs-var">irs_out</span></a><span class="hs-special">)</span><span>
</span><a name="line-1675"></a><span>                            </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendCtsList</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753804"><span class="hs-identifier hs-var">insts_out</span></a><span class="hs-special">)</span><span>
</span><a name="line-1676"></a><span>
</span><a name="line-1677"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682753796"><a href="#local-6989586621682753796"><span class="hs-identifier">tv_eqs_out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753797"><a href="#local-6989586621682753797"><span class="hs-identifier">tv_eqs_in</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldDVarEnv</span><span> </span><a href="#local-6989586621682753812"><span class="hs-identifier hs-var">kick_out_eqs</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyDVarEnv</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753787"><span class="hs-identifier hs-var">tv_eqs</span></a><span>
</span><a name="line-1678"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682753798"><a href="#local-6989586621682753798"><span class="hs-identifier">feqs_out</span></a></a><span class="hs-special">,</span><span>   </span><a name="local-6989586621682753799"><a href="#local-6989586621682753799"><span class="hs-identifier">feqs_in</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#partitionFunEqs"><span class="hs-identifier hs-var">partitionFunEqs</span></a><span>  </span><a href="#local-6989586621682753811"><span class="hs-identifier hs-var">kick_out_ct</span></a><span> </span><a href="#local-6989586621682753790"><span class="hs-identifier hs-var">funeqmap</span></a><span>
</span><a name="line-1679"></a><span>           </span><span class="hs-comment">-- See Note [Kicking out CFunEqCan for fundeps]</span><span>
</span><a name="line-1680"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682753800"><a href="#local-6989586621682753800"><span class="hs-identifier">dicts_out</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621682753801"><a href="#local-6989586621682753801"><span class="hs-identifier">dicts_in</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#partitionDicts"><span class="hs-identifier hs-var">partitionDicts</span></a><span>   </span><a href="#local-6989586621682753811"><span class="hs-identifier hs-var">kick_out_ct</span></a><span> </span><a href="#local-6989586621682753788"><span class="hs-identifier hs-var">dictmap</span></a><span>
</span><a name="line-1681"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682753802"><a href="#local-6989586621682753802"><span class="hs-identifier">irs_out</span></a></a><span class="hs-special">,</span><span>    </span><a name="local-6989586621682753803"><a href="#local-6989586621682753803"><span class="hs-identifier">irs_in</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionBag</span><span>     </span><a href="#local-6989586621682753811"><span class="hs-identifier hs-var">kick_out_ct</span></a><span> </span><a href="#local-6989586621682753791"><span class="hs-identifier hs-var">irreds</span></a><span>
</span><a name="line-1682"></a><span>      </span><span class="hs-comment">-- Kick out even insolubles: See Note [Rewrite insolubles]</span><span>
</span><a name="line-1683"></a><span>      </span><span class="hs-comment">-- Of course we must kick out irreducibles like (c a), in case</span><span>
</span><a name="line-1684"></a><span>      </span><span class="hs-comment">-- we can rewrite 'c' to something more useful</span><span>
</span><a name="line-1685"></a><span>
</span><a name="line-1686"></a><span>    </span><span class="hs-comment">-- Kick-out for inert instances</span><span>
</span><a name="line-1687"></a><span>    </span><span class="hs-comment">-- See Note [Quantified constraints] in TcCanonical</span><span>
</span><a name="line-1688"></a><span>    </span><span class="hs-identifier">insts_out</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-1689"></a><span>    </span><span class="hs-identifier">insts_in</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">QCInst</span><span class="hs-special">]</span><span>
</span><a name="line-1690"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682753804"><a href="#local-6989586621682753804"><span class="hs-identifier">insts_out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753805"><a href="#local-6989586621682753805"><span class="hs-identifier">insts_in</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682753810"><span class="hs-identifier hs-var">fr_may_rewrite</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Given</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">NomEq</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- All the insts are Givens</span><span>
</span><a name="line-1692"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionWith</span><span> </span><a href="#local-6989586621682753806"><span class="hs-identifier hs-var">kick_out_qci</span></a><span> </span><a href="#local-6989586621682753792"><span class="hs-identifier hs-var">old_insts</span></a><span>
</span><a name="line-1693"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1694"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753792"><span class="hs-identifier hs-var">old_insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1695"></a><span>    </span><a name="local-6989586621682753806"><a href="#local-6989586621682753806"><span class="hs-identifier">kick_out_qci</span></a></a><span> </span><a name="local-6989586621682753814"><a href="#local-6989586621682753814"><span class="hs-identifier">qci</span></a></a><span>
</span><a name="line-1696"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682753815"><a href="#local-6989586621682753815"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">qci_ev</span><span> </span><a href="#local-6989586621682753814"><span class="hs-identifier hs-var">qci</span></a><span>
</span><a name="line-1697"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753808"><span class="hs-identifier hs-var">fr_can_rewrite_ty</span></a><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">qci_ev</span><span> </span><a href="#local-6989586621682753814"><span class="hs-identifier hs-var">qci</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1698"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkNonCanonical</span><span> </span><a href="#local-6989586621682753815"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1699"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1700"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621682753814"><span class="hs-identifier hs-var">qci</span></a><span>
</span><a name="line-1701"></a><span>
</span><a name="line-1702"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682753807"><a href="#local-6989586621682753807"><span class="hs-identifier">new_role</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753784"><span class="hs-identifier hs-var">new_fr</span></a><span>
</span><a name="line-1703"></a><span>
</span><a name="line-1704"></a><span>    </span><span class="hs-identifier">fr_can_rewrite_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1705"></a><span>    </span><a name="local-6989586621682753808"><a href="#local-6989586621682753808"><span class="hs-identifier">fr_can_rewrite_ty</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682753817"><a href="#local-6989586621682753817"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">anyRewritableTyVar</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-1706"></a><span>                                                   </span><a href="#local-6989586621682753809"><span class="hs-identifier hs-var">fr_can_rewrite_tv</span></a><span> </span><a href="#local-6989586621682753817"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1707"></a><span>    </span><span class="hs-identifier">fr_can_rewrite_tv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EqRel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1708"></a><span>    </span><a name="local-6989586621682753809"><a href="#local-6989586621682753809"><span class="hs-identifier">fr_can_rewrite_tv</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682753819"><a href="#local-6989586621682753819"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753807"><span class="hs-identifier hs-var">new_role</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqCanRewrite</span><span class="hs-special">`</span><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-1709"></a><span>                             </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682753819"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682753785"><span class="hs-identifier hs-var">new_tv</span></a><span>
</span><a name="line-1710"></a><span>
</span><a name="line-1711"></a><span>    </span><span class="hs-identifier">fr_may_rewrite</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtFlavourRole</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1712"></a><span>    </span><a name="local-6989586621682753810"><a href="#local-6989586621682753810"><span class="hs-identifier">fr_may_rewrite</span></a></a><span> </span><a name="local-6989586621682753820"><a href="#local-6989586621682753820"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753784"><span class="hs-identifier hs-var">new_fr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqMayRewriteFR</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753820"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1713"></a><span>        </span><span class="hs-comment">-- Can the new item rewrite the inert item?</span><span>
</span><a name="line-1714"></a><span>
</span><a name="line-1715"></a><span>    </span><span class="hs-identifier">kick_out_ct</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1716"></a><span>    </span><span class="hs-comment">-- Kick it out if the new CTyEqCan can rewrite the inert one</span><span>
</span><a name="line-1717"></a><span>    </span><span class="hs-comment">-- See Note [kickOutRewritable]</span><span>
</span><a name="line-1718"></a><span>    </span><a name="local-6989586621682753811"><a href="#local-6989586621682753811"><span class="hs-identifier">kick_out_ct</span></a></a><span> </span><a name="local-6989586621682753821"><a href="#local-6989586621682753821"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682753822"><a href="#local-6989586621682753822"><span class="hs-identifier">fs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-keyword">role</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctFlavourRole</span><span> </span><a href="#local-6989586621682753821"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1719"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753810"><span class="hs-identifier hs-var">fr_may_rewrite</span></a><span> </span><a href="#local-6989586621682753822"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1720"></a><span>                   </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682753808"><span class="hs-identifier hs-var">fr_can_rewrite_ty</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctPred</span><span> </span><a href="#local-6989586621682753821"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1721"></a><span>                  </span><span class="hs-comment">-- False: ignore casts and coercions</span><span>
</span><a name="line-1722"></a><span>                  </span><span class="hs-comment">-- NB: this includes the fsk of a CFunEqCan.  It can't</span><span>
</span><a name="line-1723"></a><span>                  </span><span class="hs-comment">--     actually be rewritten, but we need to kick it out</span><span>
</span><a name="line-1724"></a><span>                  </span><span class="hs-comment">--     so we get to take advantage of injectivity</span><span>
</span><a name="line-1725"></a><span>                  </span><span class="hs-comment">-- See Note [Kicking out CFunEqCan for fundeps]</span><span>
</span><a name="line-1726"></a><span>
</span><a name="line-1727"></a><span>    </span><span class="hs-identifier">kick_out_eqs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DTyVarEnv</span><span> </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span class="hs-special">)</span><span>
</span><a name="line-1728"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">DTyVarEnv</span><span> </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span class="hs-special">)</span><span>
</span><a name="line-1729"></a><span>    </span><a name="local-6989586621682753812"><a href="#local-6989586621682753812"><span class="hs-identifier">kick_out_eqs</span></a></a><span> </span><a name="local-6989586621682753824"><a href="#local-6989586621682753824"><span class="hs-identifier">eqs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682753825"><a href="#local-6989586621682753825"><span class="hs-identifier">acc_out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753826"><a href="#local-6989586621682753826"><span class="hs-identifier">acc_in</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1730"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753827"><span class="hs-identifier hs-var">eqs_out</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682753825"><span class="hs-identifier hs-var">acc_out</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682753828"><span class="hs-identifier hs-var">eqs_in</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1731"></a><span>                               </span><span class="hs-special">[</span><span class="hs-special">]</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753826"><span class="hs-identifier hs-var">acc_in</span></a><span>
</span><a name="line-1732"></a><span>                               </span><span class="hs-special">(</span><a name="local-6989586621682753829"><a href="#local-6989586621682753829"><span class="hs-identifier">eq1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">extendDVarEnv</span><span> </span><a href="#local-6989586621682753826"><span class="hs-identifier hs-var">acc_in</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cc_tyvar</span><span> </span><a href="#local-6989586621682753829"><span class="hs-identifier hs-var">eq1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753828"><span class="hs-identifier hs-var">eqs_in</span></a><span class="hs-special">)</span><span>
</span><a name="line-1733"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1734"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682753827"><a href="#local-6989586621682753827"><span class="hs-identifier">eqs_out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753828"><a href="#local-6989586621682753828"><span class="hs-identifier">eqs_in</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><a href="#local-6989586621682753813"><span class="hs-identifier hs-var">kick_out_eq</span></a><span> </span><a href="#local-6989586621682753824"><span class="hs-identifier hs-var">eqs</span></a><span>
</span><a name="line-1735"></a><span>
</span><a name="line-1736"></a><span>    </span><span class="hs-comment">-- Implements criteria K1-K3 in Note [Extending the inert equalities]</span><span>
</span><a name="line-1737"></a><span>    </span><a name="local-6989586621682753813"><a href="#local-6989586621682753813"><span class="hs-identifier">kick_out_eq</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyvar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753830"><a href="#local-6989586621682753830"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753831"><a href="#local-6989586621682753831"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-1738"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753832"><a href="#local-6989586621682753832"><span class="hs-identifier">ev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753833"><a href="#local-6989586621682753833"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1739"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753810"><span class="hs-identifier hs-var">fr_may_rewrite</span></a><span> </span><a href="#local-6989586621682753834"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1740"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- Keep it in the inert set if the new thing can't rewrite it</span><span>
</span><a name="line-1741"></a><span>
</span><a name="line-1742"></a><span>      </span><span class="hs-comment">-- Below here (fr_may_rewrite fs) is True</span><span>
</span><a name="line-1743"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682753830"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682753785"><span class="hs-identifier hs-var">new_tv</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>        </span><span class="hs-comment">-- (K1)</span><span>
</span><a name="line-1744"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682753835"><span class="hs-identifier hs-var">kick_out_for_inertness</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1745"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682753836"><span class="hs-identifier hs-var">kick_out_for_completeness</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1746"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1747"></a><span>
</span><a name="line-1748"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1749"></a><span>        </span><a name="local-6989586621682753834"><a href="#local-6989586621682753834"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvFlavour</span><span> </span><a href="#local-6989586621682753832"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753833"><span class="hs-identifier hs-var">eq_rel</span></a><span class="hs-special">)</span><span>
</span><a name="line-1750"></a><span>        </span><a name="local-6989586621682753835"><a href="#local-6989586621682753835"><span class="hs-identifier">kick_out_for_inertness</span></a></a><span>
</span><a name="line-1751"></a><span>          </span><span class="hs-glyph">=</span><span>        </span><span class="hs-special">(</span><a href="#local-6989586621682753834"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqMayRewriteFR</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753834"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- (K2a)</span><span>
</span><a name="line-1752"></a><span>            </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753834"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqMayRewriteFR</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753784"><span class="hs-identifier hs-var">new_fr</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- (K2b)</span><span>
</span><a name="line-1753"></a><span>            </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682753808"><span class="hs-identifier hs-var">fr_can_rewrite_ty</span></a><span> </span><a href="#local-6989586621682753833"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><a href="#local-6989586621682753831"><span class="hs-identifier hs-var">rhs_ty</span></a><span>    </span><span class="hs-comment">-- (K2d)</span><span>
</span><a name="line-1754"></a><span>            </span><span class="hs-comment">-- (K2c) is guaranteed by the first guard of keep_eq</span><span>
</span><a name="line-1755"></a><span>
</span><a name="line-1756"></a><span>        </span><a name="local-6989586621682753836"><a href="#local-6989586621682753836"><span class="hs-identifier">kick_out_for_completeness</span></a></a><span>
</span><a name="line-1757"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682753833"><span class="hs-identifier hs-var">eq_rel</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1758"></a><span>              </span><span class="hs-identifier hs-var">NomEq</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753831"><span class="hs-identifier hs-var">rhs_ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682753785"><span class="hs-identifier hs-var">new_tv</span></a><span>
</span><a name="line-1759"></a><span>              </span><span class="hs-identifier hs-var">ReprEq</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">isTyVarHead</span><span> </span><a href="#local-6989586621682753785"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621682753831"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1760"></a><span>
</span><a name="line-1761"></a><span>    </span><span class="hs-identifier">kick_out_eq</span><span> </span><a name="local-6989586621682753837"><a href="#local-6989586621682753837"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;keep_eq&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753837"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1762"></a><span>
</span><a name="line-1763"></a><span class="hs-identifier">kickOutAfterUnification</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1764"></a><a name="kickOutAfterUnification"><a href="TcSMonad.html#kickOutAfterUnification"><span class="hs-identifier">kickOutAfterUnification</span></a></a><span> </span><a name="local-6989586621682753838"><a href="#local-6989586621682753838"><span class="hs-identifier">new_tv</span></a></a><span>
</span><a name="line-1765"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753839"><a href="#local-6989586621682753839"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span>
</span><a name="line-1766"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682753840"><a href="#local-6989586621682753840"><span class="hs-identifier">n_kicked</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753841"><a href="#local-6989586621682753841"><span class="hs-identifier">ics2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#kickOutRewritable"><span class="hs-identifier hs-var">kickOutRewritable</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Given</span><span class="hs-special">,</span><span class="hs-identifier hs-var">NomEq</span><span class="hs-special">)</span><span>
</span><a name="line-1767"></a><span>                                                 </span><a href="#local-6989586621682753838"><span class="hs-identifier hs-var">new_tv</span></a><span> </span><a href="#local-6989586621682753839"><span class="hs-identifier hs-var">ics</span></a><span>
</span><a name="line-1768"></a><span>                     </span><span class="hs-comment">-- Given because the tv := xi is given; NomEq because</span><span>
</span><a name="line-1769"></a><span>                     </span><span class="hs-comment">-- only nominal equalities are solved by unification</span><span>
</span><a name="line-1770"></a><span>
</span><a name="line-1771"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#setInertCans"><span class="hs-identifier hs-var">setInertCans</span></a><span> </span><a href="#local-6989586621682753841"><span class="hs-identifier hs-var">ics2</span></a><span>
</span><a name="line-1772"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682753840"><span class="hs-identifier hs-var">n_kicked</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1773"></a><span>
</span><a name="line-1774"></a><span class="hs-comment">{- Note [kickOutRewritable]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
See also Note [inert_eqs: the inert equalities].

When we add a new inert equality (a ~N ty) to the inert set,
we must kick out any inert items that could be rewritten by the
new equality, to maintain the inert-set invariants.

  - We want to kick out an existing inert constraint if
    a) the new constraint can rewrite the inert one
    b) 'a' is free in the inert constraint (so that it *will*)
       rewrite it if we kick it out.

    For (b) we use tyCoVarsOfCt, which returns the type variables /and
    the kind variables/ that are directly visible in the type. Hence
    we will have exposed all the rewriting we care about to make the
    most precise kinds visible for matching classes etc. No need to
    kick out constraints that mention type variables whose kinds
    contain this variable!

  - A Derived equality can kick out [D] constraints in inert_eqs,
    inert_dicts, inert_irreds etc.

  - We don't kick out constraints from inert_solved_dicts, and
    inert_solved_funeqs optimistically. But when we lookup we have to
    take the substitution into account


Note [Rewrite insolubles]
~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have an insoluble alpha ~ [alpha], which is insoluble
because an occurs check.  And then we unify alpha := [Int].  Then we
really want to rewrite the insoluble to [Int] ~ [[Int]].  Now it can
be decomposed.  Otherwise we end up with a &quot;Can't match [Int] ~
[[Int]]&quot; which is true, but a bit confusing because the outer type
constructors match.

Similarly, if we have a CHoleCan, we'd like to rewrite it with any
Givens, to give as informative an error messasge as possible
(Trac #12468, #11325).

Hence:
 * In the main simlifier loops in TcSimplify (solveWanteds,
   simpl_loop), we feed the insolubles in solveSimpleWanteds,
   so that they get rewritten (albeit not solved).

 * We kick insolubles out of the inert set, if they can be
   rewritten (see TcSMonad.kick_out_rewritable)

 * We rewrite those insolubles in TcCanonical.
   See Note [Make sure that insolubles are fully rewritten]
-}</span><span>
</span><a name="line-1826"></a><span>
</span><a name="line-1827"></a><span>
</span><a name="line-1828"></a><span>
</span><a name="line-1829"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-1830"></a><span class="hs-identifier">addInertSafehask</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-1831"></a><a name="addInertSafehask"><a href="TcSMonad.html#addInertSafehask"><span class="hs-identifier">addInertSafehask</span></a></a><span> </span><a name="local-6989586621682753842"><a href="#local-6989586621682753842"><span class="hs-identifier">ics</span></a></a><span> </span><a name="local-6989586621682753843"><a href="#local-6989586621682753843"><span class="hs-identifier">item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753844"><a href="#local-6989586621682753844"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753845"><a href="#local-6989586621682753845"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1832"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753842"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_safehask</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#addDict"><span class="hs-identifier hs-var">addDict</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_dicts</span><span> </span><a href="#local-6989586621682753842"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753844"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682753845"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682753843"><span class="hs-identifier hs-var">item</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1833"></a><span>
</span><a name="line-1834"></a><span class="hs-identifier">addInertSafehask</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682753846"><a href="#local-6989586621682753846"><span class="hs-identifier">item</span></a></a><span>
</span><a name="line-1835"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;addInertSafehask: can't happen! Inserting &quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753846"><span class="hs-identifier hs-var">item</span></a><span>
</span><a name="line-1836"></a><span>
</span><a name="line-1837"></a><span class="hs-identifier">insertSafeOverlapFailureTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1838"></a><span class="hs-comment">-- See Note [Safe Haskell Overlapping Instances Implementation] in TcSimplify</span><span>
</span><a name="line-1839"></a><a name="insertSafeOverlapFailureTcS"><a href="TcSMonad.html#insertSafeOverlapFailureTcS"><span class="hs-identifier">insertSafeOverlapFailureTcS</span></a></a><span> </span><a name="local-6989586621682753847"><a href="#local-6989586621682753847"><span class="hs-identifier">item</span></a></a><span>
</span><a name="line-1840"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682753848"><a href="#local-6989586621682753848"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#addInertSafehask"><span class="hs-identifier hs-var">addInertSafehask</span></a><span> </span><a href="#local-6989586621682753848"><span class="hs-identifier hs-var">ics</span></a><span> </span><a href="#local-6989586621682753847"><span class="hs-identifier hs-var">item</span></a><span class="hs-special">)</span><span>
</span><a name="line-1841"></a><span>
</span><a name="line-1842"></a><span class="hs-identifier">getSafeOverlapFailures</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">Cts</span><span>
</span><a name="line-1843"></a><span class="hs-comment">-- See Note [Safe Haskell Overlapping Instances Implementation] in TcSimplify</span><span>
</span><a name="line-1844"></a><a name="getSafeOverlapFailures"><a href="TcSMonad.html#getSafeOverlapFailures"><span class="hs-identifier">getSafeOverlapFailures</span></a></a><span>
</span><a name="line-1845"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_safehask</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753849"><a href="#local-6989586621682753849"><span class="hs-identifier">safehask</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span>
</span><a name="line-1846"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcSMonad.html#foldDicts"><span class="hs-identifier hs-var">foldDicts</span></a><span> </span><span class="hs-identifier hs-var">consCts</span><span> </span><a href="#local-6989586621682753849"><span class="hs-identifier hs-var">safehask</span></a><span> </span><span class="hs-identifier hs-var">emptyCts</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1847"></a><span>
</span><a name="line-1848"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-1849"></a><span class="hs-identifier">addSolvedDict</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1850"></a><span class="hs-comment">-- Add a new item in the solved set of the monad</span><span>
</span><a name="line-1851"></a><span class="hs-comment">-- See Note [Solved dictionaries]</span><span>
</span><a name="line-1852"></a><a name="addSolvedDict"><a href="TcSMonad.html#addSolvedDict"><span class="hs-identifier">addSolvedDict</span></a></a><span> </span><a name="local-6989586621682753850"><a href="#local-6989586621682753850"><span class="hs-identifier">item</span></a></a><span> </span><a name="local-6989586621682753851"><a href="#local-6989586621682753851"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682753852"><a href="#local-6989586621682753852"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1853"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isIPPred</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvPred</span><span> </span><a href="#local-6989586621682753850"><span class="hs-identifier hs-var">item</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Never cache &quot;solved&quot; implicit parameters (not sure why!)</span><span>
</span><a name="line-1854"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1855"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1856"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;updSolvedSetTcs:&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753850"><span class="hs-identifier hs-var">item</span></a><span>
</span><a name="line-1857"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#updInertTcS"><span class="hs-identifier hs-var">updInertTcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682753853"><a href="#local-6989586621682753853"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1858"></a><span>             </span><a href="#local-6989586621682753853"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_solved_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#addDict"><span class="hs-identifier hs-var">addDict</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_solved_dicts</span><span> </span><a href="#local-6989586621682753853"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753851"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682753852"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682753850"><span class="hs-identifier hs-var">item</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1859"></a><span>
</span><a name="line-1860"></a><span class="hs-identifier">getSolvedDicts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span class="hs-special">)</span><span>
</span><a name="line-1861"></a><a name="getSolvedDicts"><a href="TcSMonad.html#getSolvedDicts"><span class="hs-identifier">getSolvedDicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753854"><a href="#local-6989586621682753854"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_solved_dicts</span><span> </span><a href="#local-6989586621682753854"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1862"></a><span>
</span><a name="line-1863"></a><span class="hs-identifier">setSolvedDicts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1864"></a><a name="setSolvedDicts"><a href="TcSMonad.html#setSolvedDicts"><span class="hs-identifier">setSolvedDicts</span></a></a><span> </span><a name="local-6989586621682753855"><a href="#local-6989586621682753855"><span class="hs-identifier">solved_dicts</span></a></a><span>
</span><a name="line-1865"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertTcS"><span class="hs-identifier hs-var">updInertTcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682753856"><a href="#local-6989586621682753856"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1866"></a><span>    </span><a href="#local-6989586621682753856"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_solved_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753855"><span class="hs-identifier hs-var">solved_dicts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1867"></a><span>
</span><a name="line-1868"></a><span>
</span><a name="line-1869"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                  Other inert-set operations
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-1874"></a><span>
</span><a name="line-1875"></a><span class="hs-identifier">updInertTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1876"></a><span class="hs-comment">-- Modify the inert set with the supplied function</span><span>
</span><a name="line-1877"></a><a name="updInertTcS"><a href="TcSMonad.html#updInertTcS"><span class="hs-identifier">updInertTcS</span></a></a><span> </span><a name="local-6989586621682753857"><a href="#local-6989586621682753857"><span class="hs-identifier">upd_fn</span></a></a><span>
</span><a name="line-1878"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753858"><a href="#local-6989586621682753858"><span class="hs-identifier">is_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInertsRef"><span class="hs-identifier hs-var">getTcSInertsRef</span></a><span>
</span><a name="line-1879"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753859"><a href="#local-6989586621682753859"><span class="hs-identifier">curr_inert</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM.readTcRef</span></a><span> </span><a href="#local-6989586621682753858"><span class="hs-identifier hs-var">is_var</span></a><span>
</span><a name="line-1880"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">TcM.writeTcRef</span></a><span> </span><a href="#local-6989586621682753858"><span class="hs-identifier hs-var">is_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753857"><span class="hs-identifier hs-var">upd_fn</span></a><span> </span><a href="#local-6989586621682753859"><span class="hs-identifier hs-var">curr_inert</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1881"></a><span>
</span><a name="line-1882"></a><span class="hs-identifier">getInertCans</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-1883"></a><a name="getInertCans"><a href="TcSMonad.html#getInertCans"><span class="hs-identifier">getInertCans</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753860"><a href="#local-6989586621682753860"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_cans</span><span> </span><a href="#local-6989586621682753860"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1884"></a><span>
</span><a name="line-1885"></a><span class="hs-identifier">setInertCans</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1886"></a><a name="setInertCans"><a href="TcSMonad.html#setInertCans"><span class="hs-identifier">setInertCans</span></a></a><span> </span><a name="local-6989586621682753861"><a href="#local-6989586621682753861"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertTcS"><span class="hs-identifier hs-var">updInertTcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682753862"><a href="#local-6989586621682753862"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753862"><span class="hs-identifier hs-var">inerts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753861"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1887"></a><span>
</span><a name="line-1888"></a><span class="hs-identifier">updRetInertCans</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753635"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753635"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1889"></a><span class="hs-comment">-- Modify the inert set with the supplied function</span><span>
</span><a name="line-1890"></a><a name="updRetInertCans"><a href="TcSMonad.html#updRetInertCans"><span class="hs-identifier">updRetInertCans</span></a></a><span> </span><a name="local-6989586621682753863"><a href="#local-6989586621682753863"><span class="hs-identifier">upd_fn</span></a></a><span>
</span><a name="line-1891"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753864"><a href="#local-6989586621682753864"><span class="hs-identifier">is_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInertsRef"><span class="hs-identifier hs-var">getTcSInertsRef</span></a><span>
</span><a name="line-1892"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753865"><a href="#local-6989586621682753865"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM.readTcRef</span></a><span> </span><a href="#local-6989586621682753864"><span class="hs-identifier hs-var">is_var</span></a><span>
</span><a name="line-1893"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682753866"><a href="#local-6989586621682753866"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753867"><a href="#local-6989586621682753867"><span class="hs-identifier">cans'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753863"><span class="hs-identifier hs-var">upd_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_cans</span><span> </span><a href="#local-6989586621682753865"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1894"></a><span>                     </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">TcM.writeTcRef</span></a><span> </span><a href="#local-6989586621682753864"><span class="hs-identifier hs-var">is_var</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753865"><span class="hs-identifier hs-var">inerts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753867"><span class="hs-identifier hs-var">cans'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1895"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682753866"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1896"></a><span>
</span><a name="line-1897"></a><span class="hs-identifier">updInertCans</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1898"></a><span class="hs-comment">-- Modify the inert set with the supplied function</span><span>
</span><a name="line-1899"></a><a name="updInertCans"><a href="TcSMonad.html#updInertCans"><span class="hs-identifier">updInertCans</span></a></a><span> </span><a name="local-6989586621682753868"><a href="#local-6989586621682753868"><span class="hs-identifier">upd_fn</span></a></a><span>
</span><a name="line-1900"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertTcS"><span class="hs-identifier hs-var">updInertTcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682753869"><a href="#local-6989586621682753869"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753869"><span class="hs-identifier hs-var">inerts</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753868"><span class="hs-identifier hs-var">upd_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_cans</span><span> </span><a href="#local-6989586621682753869"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1901"></a><span>
</span><a name="line-1902"></a><span class="hs-identifier">updInertDicts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1903"></a><span class="hs-comment">-- Modify the inert set with the supplied function</span><span>
</span><a name="line-1904"></a><a name="updInertDicts"><a href="TcSMonad.html#updInertDicts"><span class="hs-identifier">updInertDicts</span></a></a><span> </span><a name="local-6989586621682753870"><a href="#local-6989586621682753870"><span class="hs-identifier">upd_fn</span></a></a><span>
</span><a name="line-1905"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682753871"><a href="#local-6989586621682753871"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753871"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753870"><span class="hs-identifier hs-var">upd_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_dicts</span><span> </span><a href="#local-6989586621682753871"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1906"></a><span>
</span><a name="line-1907"></a><span class="hs-identifier">updInertSafehask</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1908"></a><span class="hs-comment">-- Modify the inert set with the supplied function</span><span>
</span><a name="line-1909"></a><a name="updInertSafehask"><a href="TcSMonad.html#updInertSafehask"><span class="hs-identifier">updInertSafehask</span></a></a><span> </span><a name="local-6989586621682753872"><a href="#local-6989586621682753872"><span class="hs-identifier">upd_fn</span></a></a><span>
</span><a name="line-1910"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682753873"><a href="#local-6989586621682753873"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753873"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_safehask</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753872"><span class="hs-identifier hs-var">upd_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_safehask</span><span> </span><a href="#local-6989586621682753873"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1911"></a><span>
</span><a name="line-1912"></a><span class="hs-identifier">updInertFunEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1913"></a><span class="hs-comment">-- Modify the inert set with the supplied function</span><span>
</span><a name="line-1914"></a><a name="updInertFunEqs"><a href="TcSMonad.html#updInertFunEqs"><span class="hs-identifier">updInertFunEqs</span></a></a><span> </span><a name="local-6989586621682753874"><a href="#local-6989586621682753874"><span class="hs-identifier">upd_fn</span></a></a><span>
</span><a name="line-1915"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682753875"><a href="#local-6989586621682753875"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753875"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753874"><span class="hs-identifier hs-var">upd_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_funeqs</span><span> </span><a href="#local-6989586621682753875"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1916"></a><span>
</span><a name="line-1917"></a><span class="hs-identifier">updInertIrreds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Cts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cts</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1918"></a><span class="hs-comment">-- Modify the inert set with the supplied function</span><span>
</span><a name="line-1919"></a><a name="updInertIrreds"><a href="TcSMonad.html#updInertIrreds"><span class="hs-identifier">updInertIrreds</span></a></a><span> </span><a name="local-6989586621682753876"><a href="#local-6989586621682753876"><span class="hs-identifier">upd_fn</span></a></a><span>
</span><a name="line-1920"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#updInertCans"><span class="hs-identifier hs-var">updInertCans</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682753877"><a href="#local-6989586621682753877"><span class="hs-identifier">ics</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753877"><span class="hs-identifier hs-var">ics</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_irreds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753876"><span class="hs-identifier hs-var">upd_fn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_irreds</span><span> </span><a href="#local-6989586621682753877"><span class="hs-identifier hs-var">ics</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1921"></a><span>
</span><a name="line-1922"></a><span class="hs-identifier">getInertEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DTyVarEnv</span><span> </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span class="hs-special">)</span><span>
</span><a name="line-1923"></a><a name="getInertEqs"><a href="TcSMonad.html#getInertEqs"><span class="hs-identifier">getInertEqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753878"><a href="#local-6989586621682753878"><span class="hs-identifier">inert</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_eqs</span><span> </span><a href="#local-6989586621682753878"><span class="hs-identifier hs-var">inert</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1924"></a><span>
</span><a name="line-1925"></a><span class="hs-identifier">getInertInsols</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">Cts</span><span>
</span><a name="line-1926"></a><span class="hs-comment">-- Returns insoluble equality constraints</span><span>
</span><a name="line-1927"></a><span class="hs-comment">-- specifically including Givens</span><span>
</span><a name="line-1928"></a><a name="getInertInsols"><a href="TcSMonad.html#getInertInsols"><span class="hs-identifier">getInertInsols</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753879"><a href="#local-6989586621682753879"><span class="hs-identifier">inert</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span>
</span><a name="line-1929"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterBag</span><span> </span><span class="hs-identifier hs-var">insolubleEqCt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_irreds</span><span> </span><a href="#local-6989586621682753879"><span class="hs-identifier hs-var">inert</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1930"></a><span>
</span><a name="line-1931"></a><span class="hs-identifier">getInertGivens</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-1932"></a><span class="hs-comment">-- Returns the Given constraints in the inert set,</span><span>
</span><a name="line-1933"></a><span class="hs-comment">-- with type functions *not* unflattened</span><span>
</span><a name="line-1934"></a><a name="getInertGivens"><a href="TcSMonad.html#getInertGivens"><span class="hs-identifier">getInertGivens</span></a></a><span>
</span><a name="line-1935"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753880"><a href="#local-6989586621682753880"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span>
</span><a name="line-1936"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682753881"><a href="#local-6989586621682753881"><span class="hs-identifier">all_cts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldDicts"><span class="hs-identifier hs-var">foldDicts</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_dicts</span><span> </span><a href="#local-6989586621682753880"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1937"></a><span>                     </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcSMonad.html#foldFunEqs"><span class="hs-identifier hs-var">foldFunEqs</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_funeqs</span><span> </span><a href="#local-6989586621682753880"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1938"></a><span>                     </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dVarEnvElts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_eqs</span><span> </span><a href="#local-6989586621682753880"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1939"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isGivenCt</span><span> </span><a href="#local-6989586621682753881"><span class="hs-identifier hs-var">all_cts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1940"></a><span>
</span><a name="line-1941"></a><span class="hs-identifier">getPendingGivenScs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>
</span><a name="line-1942"></a><span class="hs-comment">-- Find all inert Given dictionaries, or quantified constraints,</span><span>
</span><a name="line-1943"></a><span class="hs-comment">--     whose cc_pend_sc flag is True</span><span>
</span><a name="line-1944"></a><span class="hs-comment">--     and that belong to the current level</span><span>
</span><a name="line-1945"></a><span class="hs-comment">-- Set their cc_pend_sc flag to False in the inert set, and return that Ct</span><span>
</span><a name="line-1946"></a><a name="getPendingGivenScs"><a href="TcSMonad.html#getPendingGivenScs"><span class="hs-identifier">getPendingGivenScs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753882"><a href="#local-6989586621682753882"><span class="hs-identifier">lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-1947"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#updRetInertCans"><span class="hs-identifier hs-var">updRetInertCans</span></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#get_sc_pending"><span class="hs-identifier hs-var">get_sc_pending</span></a><span> </span><a href="#local-6989586621682753882"><span class="hs-identifier hs-var">lvl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1948"></a><span>
</span><a name="line-1949"></a><span class="hs-identifier">get_sc_pending</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcLevel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span class="hs-special">)</span><span>
</span><a name="line-1950"></a><a name="get_sc_pending"><a href="TcSMonad.html#get_sc_pending"><span class="hs-identifier">get_sc_pending</span></a></a><span> </span><a name="local-6989586621682753883"><a href="#local-6989586621682753883"><span class="hs-identifier">this_lvl</span></a></a><span> </span><a name="local-6989586621682753884"><a href="#local-6989586621682753884"><span class="hs-identifier">ic</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753885"><a href="#local-6989586621682753885"><span class="hs-identifier">dicts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753886"><a href="#local-6989586621682753886"><span class="hs-identifier">insts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1951"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier">isGivenCt</span><span> </span><span class="hs-identifier">sc_pending</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">sc_pending</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1952"></a><span>       </span><span class="hs-comment">-- When getPendingScDics is called,</span><span>
</span><a name="line-1953"></a><span>       </span><span class="hs-comment">-- there are never any Wanteds in the inert set</span><span>
</span><a name="line-1954"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621682753887"><span class="hs-identifier hs-var">sc_pending</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753884"><span class="hs-identifier hs-var">ic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753889"><span class="hs-identifier hs-var">dicts'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753891"><span class="hs-identifier hs-var">insts'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1955"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1956"></a><span>    </span><a name="local-6989586621682753887"><a href="#local-6989586621682753887"><span class="hs-identifier">sc_pending</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753890"><span class="hs-identifier hs-var">sc_pend_insts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682753888"><span class="hs-identifier hs-var">sc_pend_dicts</span></a><span>
</span><a name="line-1957"></a><span>
</span><a name="line-1958"></a><span>    </span><a name="local-6989586621682753888"><a href="#local-6989586621682753888"><span class="hs-identifier">sc_pend_dicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldDicts"><span class="hs-identifier hs-var">foldDicts</span></a><span> </span><a href="#local-6989586621682753892"><span class="hs-identifier hs-var">get_pending</span></a><span> </span><a href="#local-6989586621682753885"><span class="hs-identifier hs-var">dicts</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1959"></a><span>    </span><a name="local-6989586621682753889"><a href="#local-6989586621682753889"><span class="hs-identifier">dicts'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682753893"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621682753885"><span class="hs-identifier hs-var">dicts</span></a><span> </span><a href="#local-6989586621682753888"><span class="hs-identifier hs-var">sc_pend_dicts</span></a><span>
</span><a name="line-1960"></a><span>
</span><a name="line-1961"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682753890"><a href="#local-6989586621682753890"><span class="hs-identifier">sc_pend_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682753891"><a href="#local-6989586621682753891"><span class="hs-identifier">insts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621682753894"><span class="hs-identifier hs-var">get_pending_inst</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682753886"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-1962"></a><span>
</span><a name="line-1963"></a><span>    </span><span class="hs-identifier">get_pending</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Get dicts with cc_pend_sc = True</span><span>
</span><a name="line-1964"></a><span>                                       </span><span class="hs-comment">-- but flipping the flag</span><span>
</span><a name="line-1965"></a><span>    </span><a name="local-6989586621682753892"><a href="#local-6989586621682753892"><span class="hs-identifier">get_pending</span></a></a><span> </span><a name="local-6989586621682753896"><a href="#local-6989586621682753896"><span class="hs-identifier">dict</span></a></a><span> </span><a name="local-6989586621682753897"><a href="#local-6989586621682753897"><span class="hs-identifier">dicts</span></a></a><span>
</span><a name="line-1966"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682753898"><a href="#local-6989586621682753898"><span class="hs-identifier">dict'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isPendingScDict</span><span> </span><a href="#local-6989586621682753896"><span class="hs-identifier hs-var">dict</span></a><span>
</span><a name="line-1967"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753895"><span class="hs-identifier hs-var">belongs_to_this_level</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvidence</span><span> </span><a href="#local-6989586621682753896"><span class="hs-identifier hs-var">dict</span></a><span class="hs-special">)</span><span>
</span><a name="line-1968"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753898"><span class="hs-identifier hs-var">dict'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682753897"><span class="hs-identifier hs-var">dicts</span></a><span>
</span><a name="line-1969"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1970"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753897"><span class="hs-identifier hs-var">dicts</span></a><span>
</span><a name="line-1971"></a><span>
</span><a name="line-1972"></a><span>    </span><span class="hs-identifier">add</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-1973"></a><span>    </span><a name="local-6989586621682753893"><a href="#local-6989586621682753893"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621682753899"><a href="#local-6989586621682753899"><span class="hs-identifier">ct</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753900"><a href="#local-6989586621682753900"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753901"><a href="#local-6989586621682753901"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682753902"><a href="#local-6989586621682753902"><span class="hs-identifier">dicts</span></a></a><span>
</span><a name="line-1974"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#addDict"><span class="hs-identifier hs-var">addDict</span></a><span> </span><a href="#local-6989586621682753902"><span class="hs-identifier hs-var">dicts</span></a><span> </span><a href="#local-6989586621682753900"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682753901"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682753899"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-1975"></a><span>    </span><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682753903"><a href="#local-6989586621682753903"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;getPendingScDicts&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753903"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-1976"></a><span>
</span><a name="line-1977"></a><span>    </span><span class="hs-identifier">get_pending_inst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">QCInst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">QCInst</span><span class="hs-special">)</span><span>
</span><a name="line-1978"></a><span>    </span><a name="local-6989586621682753894"><a href="#local-6989586621682753894"><span class="hs-identifier">get_pending_inst</span></a></a><span> </span><a name="local-6989586621682753904"><a href="#local-6989586621682753904"><span class="hs-identifier">cts</span></a></a><span> </span><a name="local-6989586621682753905"><a href="#local-6989586621682753905"><span class="hs-identifier">qci</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">QCI</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">qci_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753906"><a href="#local-6989586621682753906"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1979"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682753907"><a href="#local-6989586621682753907"><span class="hs-identifier">qci'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isPendingScInst</span><span> </span><a href="#local-6989586621682753905"><span class="hs-identifier hs-var">qci</span></a><span>
</span><a name="line-1980"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753895"><span class="hs-identifier hs-var">belongs_to_this_level</span></a><span> </span><a href="#local-6989586621682753906"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-1981"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CQuantCan</span><span> </span><a href="#local-6989586621682753907"><span class="hs-identifier hs-var">qci'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682753904"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753907"><span class="hs-identifier hs-var">qci'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1982"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1983"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753904"><span class="hs-identifier hs-var">cts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753905"><span class="hs-identifier hs-var">qci</span></a><span class="hs-special">)</span><span>
</span><a name="line-1984"></a><span>
</span><a name="line-1985"></a><span>    </span><a name="local-6989586621682753895"><a href="#local-6989586621682753895"><span class="hs-identifier">belongs_to_this_level</span></a></a><span> </span><a name="local-6989586621682753908"><a href="#local-6989586621682753908"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctLocLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682753908"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682753883"><span class="hs-identifier hs-var">this_lvl</span></a><span>
</span><a name="line-1986"></a><span>    </span><span class="hs-comment">-- We only want Givens from this level; see (3a) in</span><span>
</span><a name="line-1987"></a><span>    </span><span class="hs-comment">-- Note [The superclass story] in TcCanonical</span><span>
</span><a name="line-1988"></a><span>
</span><a name="line-1989"></a><span class="hs-identifier">getUnsolvedInerts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">Implication</span><span>
</span><a name="line-1990"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Cts</span><span>     </span><span class="hs-comment">-- Tyvar eqs: a ~ ty</span><span>
</span><a name="line-1991"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Cts</span><span>     </span><span class="hs-comment">-- Fun eqs:   F a ~ ty</span><span>
</span><a name="line-1992"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Cts</span><span> </span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- All others</span><span>
</span><a name="line-1993"></a><span class="hs-comment">-- Return all the unsolved [Wanted] or [Derived] constraints</span><span>
</span><a name="line-1994"></a><span class="hs-comment">--</span><span>
</span><a name="line-1995"></a><span class="hs-comment">-- Post-condition: the returned simple constraints are all fully zonked</span><span>
</span><a name="line-1996"></a><span class="hs-comment">--                     (because they come from the inert set)</span><span>
</span><a name="line-1997"></a><span class="hs-comment">--                 the unsolved implics may not be</span><span>
</span><a name="line-1998"></a><a name="getUnsolvedInerts"><a href="TcSMonad.html#getUnsolvedInerts"><span class="hs-identifier">getUnsolvedInerts</span></a></a><span>
</span><a name="line-1999"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_eqs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753917"><a href="#local-6989586621682753917"><span class="hs-identifier">tv_eqs</span></a></a><span>
</span><a name="line-2000"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753918"><a href="#local-6989586621682753918"><span class="hs-identifier">fun_eqs</span></a></a><span>
</span><a name="line-2001"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_irreds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753919"><a href="#local-6989586621682753919"><span class="hs-identifier">irreds</span></a></a><span>
</span><a name="line-2002"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_dicts</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753920"><a href="#local-6989586621682753920"><span class="hs-identifier">idicts</span></a></a><span>
</span><a name="line-2003"></a><span>           </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span>
</span><a name="line-2004"></a><span>
</span><a name="line-2005"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682753921"><a href="#local-6989586621682753921"><span class="hs-identifier">unsolved_tv_eqs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldTyEqs"><span class="hs-identifier hs-var">foldTyEqs</span></a><span> </span><a href="#local-6989586621682753909"><span class="hs-identifier hs-var">add_if_unsolved</span></a><span> </span><a href="#local-6989586621682753917"><span class="hs-identifier hs-var">tv_eqs</span></a><span> </span><span class="hs-identifier hs-var">emptyCts</span><span>
</span><a name="line-2006"></a><span>            </span><a name="local-6989586621682753922"><a href="#local-6989586621682753922"><span class="hs-identifier">unsolved_fun_eqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldFunEqs"><span class="hs-identifier hs-var">foldFunEqs</span></a><span> </span><a href="#local-6989586621682753911"><span class="hs-identifier hs-var">add_if_wanted</span></a><span> </span><a href="#local-6989586621682753918"><span class="hs-identifier hs-var">fun_eqs</span></a><span> </span><span class="hs-identifier hs-var">emptyCts</span><span>
</span><a name="line-2007"></a><span>            </span><a name="local-6989586621682753923"><a href="#local-6989586621682753923"><span class="hs-identifier">unsolved_irreds</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Bag.filterBag</span><span> </span><a href="#local-6989586621682753910"><span class="hs-identifier hs-var">is_unsolved</span></a><span> </span><a href="#local-6989586621682753919"><span class="hs-identifier hs-var">irreds</span></a><span>
</span><a name="line-2008"></a><span>            </span><a name="local-6989586621682753924"><a href="#local-6989586621682753924"><span class="hs-identifier">unsolved_dicts</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldDicts"><span class="hs-identifier hs-var">foldDicts</span></a><span> </span><a href="#local-6989586621682753909"><span class="hs-identifier hs-var">add_if_unsolved</span></a><span> </span><a href="#local-6989586621682753920"><span class="hs-identifier hs-var">idicts</span></a><span> </span><span class="hs-identifier hs-var">emptyCts</span><span>
</span><a name="line-2009"></a><span>            </span><a name="local-6989586621682753925"><a href="#local-6989586621682753925"><span class="hs-identifier">unsolved_others</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753923"><span class="hs-identifier hs-var">unsolved_irreds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753924"><span class="hs-identifier hs-var">unsolved_dicts</span></a><span>
</span><a name="line-2010"></a><span>
</span><a name="line-2011"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682753926"><a href="#local-6989586621682753926"><span class="hs-identifier">implics</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getWorkListImplics"><span class="hs-identifier hs-var">getWorkListImplics</span></a><span>
</span><a name="line-2012"></a><span>
</span><a name="line-2013"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;getUnsolvedInerts&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2014"></a><span>        </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; tv eqs =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753921"><span class="hs-identifier hs-var">unsolved_tv_eqs</span></a><span>
</span><a name="line-2015"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;fun eqs =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753922"><span class="hs-identifier hs-var">unsolved_fun_eqs</span></a><span>
</span><a name="line-2016"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;others =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753925"><span class="hs-identifier hs-var">unsolved_others</span></a><span>
</span><a name="line-2017"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;implics =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753926"><span class="hs-identifier hs-var">implics</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2018"></a><span>
</span><a name="line-2019"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682753926"><span class="hs-identifier hs-var">implics</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753921"><span class="hs-identifier hs-var">unsolved_tv_eqs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753922"><span class="hs-identifier hs-var">unsolved_fun_eqs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753925"><span class="hs-identifier hs-var">unsolved_others</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2020"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2021"></a><span>    </span><span class="hs-identifier">add_if_unsolved</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cts</span><span>
</span><a name="line-2022"></a><span>    </span><a name="local-6989586621682753909"><a href="#local-6989586621682753909"><span class="hs-identifier">add_if_unsolved</span></a></a><span> </span><a name="local-6989586621682753912"><a href="#local-6989586621682753912"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621682753913"><a href="#local-6989586621682753913"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682753910"><span class="hs-identifier hs-var">is_unsolved</span></a><span> </span><a href="#local-6989586621682753912"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753912"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consCts</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753913"><span class="hs-identifier hs-var">cts</span></a><span>
</span><a name="line-2023"></a><span>                           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753913"><span class="hs-identifier hs-var">cts</span></a><span>
</span><a name="line-2024"></a><span>
</span><a name="line-2025"></a><span>    </span><a name="local-6989586621682753910"><a href="#local-6989586621682753910"><span class="hs-identifier">is_unsolved</span></a></a><span> </span><a name="local-6989586621682753914"><a href="#local-6989586621682753914"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isGivenCt</span><span> </span><a href="#local-6989586621682753914"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Wanted or Derived</span><span>
</span><a name="line-2026"></a><span>
</span><a name="line-2027"></a><span>    </span><span class="hs-comment">-- For CFunEqCans we ignore the Derived ones, and keep</span><span>
</span><a name="line-2028"></a><span>    </span><span class="hs-comment">-- only the Wanteds for flattening.  The Derived ones</span><span>
</span><a name="line-2029"></a><span>    </span><span class="hs-comment">-- share a unification variable with the corresponding</span><span>
</span><a name="line-2030"></a><span>    </span><span class="hs-comment">-- Wanted, so we definitely don't want to participate</span><span>
</span><a name="line-2031"></a><span>    </span><span class="hs-comment">-- in unflattening</span><span>
</span><a name="line-2032"></a><span>    </span><span class="hs-comment">-- See Note [Type family equations]</span><span>
</span><a name="line-2033"></a><span>    </span><a name="local-6989586621682753911"><a href="#local-6989586621682753911"><span class="hs-identifier">add_if_wanted</span></a></a><span> </span><a name="local-6989586621682753915"><a href="#local-6989586621682753915"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621682753916"><a href="#local-6989586621682753916"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWantedCt</span><span> </span><a href="#local-6989586621682753915"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753915"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consCts</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753916"><span class="hs-identifier hs-var">cts</span></a><span>
</span><a name="line-2034"></a><span>                         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753916"><span class="hs-identifier hs-var">cts</span></a><span>
</span><a name="line-2035"></a><span>
</span><a name="line-2036"></a><span class="hs-identifier">isInInertEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DTyVarEnv</span><span> </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2037"></a><span class="hs-comment">-- True if (a ~N ty) is in the inert set, in either Given or Wanted</span><span>
</span><a name="line-2038"></a><a name="isInInertEqs"><a href="TcSMonad.html#isInInertEqs"><span class="hs-identifier">isInInertEqs</span></a></a><span> </span><a name="local-6989586621682753927"><a href="#local-6989586621682753927"><span class="hs-identifier">eqs</span></a></a><span> </span><a name="local-6989586621682753928"><a href="#local-6989586621682753928"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682753929"><a href="#local-6989586621682753929"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-2039"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupDVarEnv</span><span> </span><a href="#local-6989586621682753927"><span class="hs-identifier hs-var">eqs</span></a><span> </span><a href="#local-6989586621682753928"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2040"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2041"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682753935"><a href="#local-6989586621682753935"><span class="hs-identifier">cts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753930"><span class="hs-identifier hs-var">same_pred</span></a><span> </span><a href="#local-6989586621682753929"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753935"><span class="hs-identifier hs-var">cts</span></a><span>
</span><a name="line-2042"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2043"></a><span>    </span><a name="local-6989586621682753930"><a href="#local-6989586621682753930"><span class="hs-identifier">same_pred</span></a></a><span> </span><a name="local-6989586621682753931"><a href="#local-6989586621682753931"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621682753932"><a href="#local-6989586621682753932"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-2044"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753933"><a href="#local-6989586621682753933"><span class="hs-identifier">rhs2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_eq_rel</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753934"><a href="#local-6989586621682753934"><span class="hs-identifier">eq_rel</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753932"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-2045"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">NomEq</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682753934"><span class="hs-identifier hs-var">eq_rel</span></a><span>
</span><a name="line-2046"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753931"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753933"><span class="hs-identifier hs-var">rhs2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2047"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2048"></a><span>
</span><a name="line-2049"></a><span class="hs-identifier">getNoGivenEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcLevel</span><span>          </span><span class="hs-comment">-- TcLevel of this implication</span><span>
</span><a name="line-2050"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcTyVar</span><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Skolems of this implication</span><span>
</span><a name="line-2051"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>      </span><span class="hs-comment">-- True &lt;=&gt; definitely no residual given equalities</span><span>
</span><a name="line-2052"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Cts</span><span> </span><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Insoluble equalities arising from givens</span><span>
</span><a name="line-2053"></a><span class="hs-comment">-- See Note [When does an implication have given equalities?]</span><span>
</span><a name="line-2054"></a><a name="getNoGivenEqs"><a href="TcSMonad.html#getNoGivenEqs"><span class="hs-identifier">getNoGivenEqs</span></a></a><span> </span><a name="local-6989586621682753936"><a href="#local-6989586621682753936"><span class="hs-identifier">tclvl</span></a></a><span> </span><a name="local-6989586621682753937"><a href="#local-6989586621682753937"><span class="hs-identifier">skol_tvs</span></a></a><span>
</span><a name="line-2055"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753947"><a href="#local-6989586621682753947"><span class="hs-identifier">inerts</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_eqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753948"><a href="#local-6989586621682753948"><span class="hs-identifier">ieqs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_irreds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753949"><a href="#local-6989586621682753949"><span class="hs-identifier">irreds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2056"></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getInertCans"><span class="hs-identifier hs-var">getInertCans</span></a><span>
</span><a name="line-2057"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682753950"><a href="#local-6989586621682753950"><span class="hs-identifier">has_given_eqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">||</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682753939"><span class="hs-identifier hs-var">ct_given_here</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621682753949"><span class="hs-identifier hs-var">irreds</span></a><span>
</span><a name="line-2058"></a><span>                          </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">anyDVarEnv</span><span> </span><a href="#local-6989586621682753938"><span class="hs-identifier hs-var">eqs_given_here</span></a><span> </span><a href="#local-6989586621682753948"><span class="hs-identifier hs-var">ieqs</span></a><span>
</span><a name="line-2059"></a><span>             </span><a name="local-6989586621682753951"><a href="#local-6989586621682753951"><span class="hs-identifier">insols</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterBag</span><span> </span><span class="hs-identifier hs-var">insolubleEqCt</span><span> </span><a href="#local-6989586621682753949"><span class="hs-identifier hs-var">irreds</span></a><span>
</span><a name="line-2060"></a><span>                      </span><span class="hs-comment">-- Specifically includes ones that originated in some</span><span>
</span><a name="line-2061"></a><span>                      </span><span class="hs-comment">-- outer context but were refined to an insoluble by</span><span>
</span><a name="line-2062"></a><span>                      </span><span class="hs-comment">-- a local equality; so do /not/ add ct_given_here.</span><span>
</span><a name="line-2063"></a><span>
</span><a name="line-2064"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#traceTcS"><span class="hs-identifier hs-var">traceTcS</span></a><span> </span><span class="hs-string">&quot;getNoGivenEqs&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2065"></a><span>         </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682753950"><span class="hs-identifier hs-var">has_given_eqs</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;May have given equalities&quot;</span><span>
</span><a name="line-2066"></a><span>                                 </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;No given equalities&quot;</span><span>
</span><a name="line-2067"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Skols:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753937"><span class="hs-identifier hs-var">skol_tvs</span></a><span>
</span><a name="line-2068"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Inerts:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753947"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-2069"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Insols:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682753951"><span class="hs-identifier hs-var">insols</span></a><span class="hs-special">]</span><span>
</span><a name="line-2070"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682753950"><span class="hs-identifier hs-var">has_given_eqs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753951"><span class="hs-identifier hs-var">insols</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2071"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2072"></a><span>    </span><span class="hs-identifier">eqs_given_here</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#EqualCtList"><span class="hs-identifier hs-type">EqualCtList</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2073"></a><span>    </span><a name="local-6989586621682753938"><a href="#local-6989586621682753938"><span class="hs-identifier">eqs_given_here</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621682753942"><a href="#local-6989586621682753942"><span class="hs-identifier">ct</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CTyEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyvar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753943"><a href="#local-6989586621682753943"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2074"></a><span>                              </span><span class="hs-comment">-- Givens are always a sigleton</span><span>
</span><a name="line-2075"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753941"><span class="hs-identifier hs-var">skolem_bound_here</span></a><span> </span><a href="#local-6989586621682753943"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682753939"><span class="hs-identifier hs-var">ct_given_here</span></a><span> </span><a href="#local-6989586621682753942"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-2076"></a><span>    </span><span class="hs-identifier">eqs_given_here</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2077"></a><span>
</span><a name="line-2078"></a><span>    </span><span class="hs-identifier">ct_given_here</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2079"></a><span>    </span><span class="hs-comment">-- True for a Given bound by the current implication,</span><span>
</span><a name="line-2080"></a><span>    </span><span class="hs-comment">-- i.e. the current level</span><span>
</span><a name="line-2081"></a><span>    </span><a name="local-6989586621682753939"><a href="#local-6989586621682753939"><span class="hs-identifier">ct_given_here</span></a></a><span> </span><a name="local-6989586621682753944"><a href="#local-6989586621682753944"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">isGiven</span><span> </span><a href="#local-6989586621682753945"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-2082"></a><span>                     </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682753936"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ctLocLevel</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682753945"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-2083"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-2084"></a><span>          </span><a name="local-6989586621682753945"><a href="#local-6989586621682753945"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ctEvidence</span><span> </span><a href="#local-6989586621682753944"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-2085"></a><span>
</span><a name="line-2086"></a><span>    </span><a name="local-6989586621682753940"><a href="#local-6989586621682753940"><span class="hs-identifier">skol_tv_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarSet</span><span> </span><a href="#local-6989586621682753937"><span class="hs-identifier hs-var">skol_tvs</span></a><span>
</span><a name="line-2087"></a><span>    </span><a name="local-6989586621682753941"><a href="#local-6989586621682753941"><span class="hs-identifier">skolem_bound_here</span></a></a><span> </span><a name="local-6989586621682753946"><a href="#local-6989586621682753946"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-comment">-- See Note [Let-bound skolems]</span><span>
</span><a name="line-2088"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">tcTyVarDetails</span><span> </span><a href="#local-6989586621682753946"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2089"></a><span>          </span><span class="hs-identifier hs-var">SkolemTv</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753946"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753940"><span class="hs-identifier hs-var">skol_tv_set</span></a><span>
</span><a name="line-2090"></a><span>          </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2091"></a><span>
</span><a name="line-2092"></a><span class="hs-comment">-- | Returns Given constraints that might,</span><span>
</span><a name="line-2093"></a><span class="hs-comment">-- potentially, match the given pred. This is used when checking to see if a</span><span>
</span><a name="line-2094"></a><span class="hs-comment">-- Given might overlap with an instance. See Note [Instance and Given overlap]</span><span>
</span><a name="line-2095"></a><span class="hs-comment">-- in TcInteract.</span><span>
</span><a name="line-2096"></a><span class="hs-identifier">matchableGivens</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cts</span><span>
</span><a name="line-2097"></a><a name="matchableGivens"><a href="TcSMonad.html#matchableGivens"><span class="hs-identifier">matchableGivens</span></a></a><span> </span><a name="local-6989586621682753952"><a href="#local-6989586621682753952"><span class="hs-identifier">loc_w</span></a></a><span> </span><a name="local-6989586621682753953"><a href="#local-6989586621682753953"><span class="hs-identifier">pred_w</span></a></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#IS"><span class="hs-identifier hs-var">IS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753954"><a href="#local-6989586621682753954"><span class="hs-identifier">inert_cans</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2098"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterBag</span><span> </span><a href="#local-6989586621682753956"><span class="hs-identifier hs-var">matchable_given</span></a><span> </span><a href="#local-6989586621682753955"><span class="hs-identifier hs-var">all_relevant_givens</span></a><span>
</span><a name="line-2099"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2100"></a><span>    </span><span class="hs-comment">-- just look in class constraints and irreds. matchableGivens does get called</span><span>
</span><a name="line-2101"></a><span>    </span><span class="hs-comment">-- for ~R constraints, but we don't need to look through equalities, because</span><span>
</span><a name="line-2102"></a><span>    </span><span class="hs-comment">-- canonical equalities are used for rewriting. We'll only get caught by</span><span>
</span><a name="line-2103"></a><span>    </span><span class="hs-comment">-- non-canonical -- that is, irreducible -- equalities.</span><span>
</span><a name="line-2104"></a><span>    </span><span class="hs-identifier">all_relevant_givens</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Cts</span><span>
</span><a name="line-2105"></a><span>    </span><a name="local-6989586621682753955"><a href="#local-6989586621682753955"><span class="hs-identifier">all_relevant_givens</span></a></a><span>
</span><a name="line-2106"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682753957"><a href="#local-6989586621682753957"><span class="hs-identifier">clas</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getClassPredTys_maybe</span><span> </span><a href="#local-6989586621682753953"><span class="hs-identifier hs-var">pred_w</span></a><span>
</span><a name="line-2107"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#findDictsByClass"><span class="hs-identifier hs-var">findDictsByClass</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_dicts</span><span> </span><a href="#local-6989586621682753954"><span class="hs-identifier hs-var">inert_cans</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753957"><span class="hs-identifier hs-var">clas</span></a><span>
</span><a name="line-2108"></a><span>        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">inert_irreds</span><span> </span><a href="#local-6989586621682753954"><span class="hs-identifier hs-var">inert_cans</span></a><span>
</span><a name="line-2109"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2110"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inert_irreds</span><span> </span><a href="#local-6989586621682753954"><span class="hs-identifier hs-var">inert_cans</span></a><span>
</span><a name="line-2111"></a><span>
</span><a name="line-2112"></a><span>    </span><span class="hs-identifier">matchable_given</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2113"></a><span>    </span><a name="local-6989586621682753956"><a href="#local-6989586621682753956"><span class="hs-identifier">matchable_given</span></a></a><span> </span><a name="local-6989586621682753958"><a href="#local-6989586621682753958"><span class="hs-identifier">ct</span></a></a><span>
</span><a name="line-2114"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">CtGiven</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ctev_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753959"><a href="#local-6989586621682753959"><span class="hs-identifier">loc_g</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ctev_pred</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753960"><a href="#local-6989586621682753960"><span class="hs-identifier">pred_g</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ctEvidence</span><span> </span><a href="#local-6989586621682753958"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-2115"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#mightMatchLater"><span class="hs-identifier hs-var">mightMatchLater</span></a><span> </span><a href="#local-6989586621682753960"><span class="hs-identifier hs-var">pred_g</span></a><span> </span><a href="#local-6989586621682753959"><span class="hs-identifier hs-var">loc_g</span></a><span> </span><a href="#local-6989586621682753953"><span class="hs-identifier hs-var">pred_w</span></a><span> </span><a href="#local-6989586621682753952"><span class="hs-identifier hs-var">loc_w</span></a><span>
</span><a name="line-2116"></a><span>
</span><a name="line-2117"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2118"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2119"></a><span>
</span><a name="line-2120"></a><span class="hs-identifier">mightMatchLater</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcPredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcPredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2121"></a><a name="mightMatchLater"><a href="TcSMonad.html#mightMatchLater"><span class="hs-identifier">mightMatchLater</span></a></a><span> </span><a name="local-6989586621682753961"><a href="#local-6989586621682753961"><span class="hs-identifier">given_pred</span></a></a><span> </span><a name="local-6989586621682753962"><a href="#local-6989586621682753962"><span class="hs-identifier">given_loc</span></a></a><span> </span><a name="local-6989586621682753963"><a href="#local-6989586621682753963"><span class="hs-identifier">wanted_pred</span></a></a><span> </span><a name="local-6989586621682753964"><a href="#local-6989586621682753964"><span class="hs-identifier">wanted_loc</span></a></a><span>
</span><a name="line-2122"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#prohibitedSuperClassSolve"><span class="hs-identifier hs-var">prohibitedSuperClassSolve</span></a><span> </span><a href="#local-6989586621682753962"><span class="hs-identifier hs-var">given_loc</span></a><span> </span><a href="#local-6989586621682753964"><span class="hs-identifier hs-var">wanted_loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2123"></a><span>  </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcUnifyTys</span><span> </span><a href="#local-6989586621682753965"><span class="hs-identifier hs-var">bind_meta_tv</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682753961"><span class="hs-identifier hs-var">given_pred</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682753963"><span class="hs-identifier hs-var">wanted_pred</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2124"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2125"></a><span>    </span><span class="hs-identifier">bind_meta_tv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcTyVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BindFlag</span><span>
</span><a name="line-2126"></a><span>    </span><span class="hs-comment">-- Any meta tyvar may be unified later, so we treat it as</span><span>
</span><a name="line-2127"></a><span>    </span><span class="hs-comment">-- bindable when unifying with givens. That ensures that we</span><span>
</span><a name="line-2128"></a><span>    </span><span class="hs-comment">-- conservatively assume that a meta tyvar might get unified with</span><span>
</span><a name="line-2129"></a><span>    </span><span class="hs-comment">-- something that matches the 'given', until demonstrated</span><span>
</span><a name="line-2130"></a><span>    </span><span class="hs-comment">-- otherwise.  More info in Note [Instance and Given overlap]</span><span>
</span><a name="line-2131"></a><span>    </span><span class="hs-comment">-- in TcInteract</span><span>
</span><a name="line-2132"></a><span>    </span><a name="local-6989586621682753965"><a href="#local-6989586621682753965"><span class="hs-identifier">bind_meta_tv</span></a></a><span> </span><a name="local-6989586621682753966"><a href="#local-6989586621682753966"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isMetaTyVar</span><span> </span><a href="#local-6989586621682753966"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-2133"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isFskTyVar</span><span> </span><a href="#local-6989586621682753966"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BindMe</span><span>
</span><a name="line-2134"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Skolem</span><span>
</span><a name="line-2135"></a><span>
</span><a name="line-2136"></a><span class="hs-identifier">prohibitedSuperClassSolve</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2137"></a><span class="hs-comment">-- See Note [Solving superclass constraints] in TcInstDcls</span><span>
</span><a name="line-2138"></a><a name="prohibitedSuperClassSolve"><a href="TcSMonad.html#prohibitedSuperClassSolve"><span class="hs-identifier">prohibitedSuperClassSolve</span></a></a><span> </span><a name="local-6989586621682753967"><a href="#local-6989586621682753967"><span class="hs-identifier">from_loc</span></a></a><span> </span><a name="local-6989586621682753968"><a href="#local-6989586621682753968"><span class="hs-identifier">solve_loc</span></a></a><span>
</span><a name="line-2139"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">GivenOrigin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InstSC</span><span> </span><a name="local-6989586621682753969"><a href="#local-6989586621682753969"><span class="hs-identifier">given_size</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ctLocOrigin</span><span> </span><a href="#local-6989586621682753967"><span class="hs-identifier hs-var">from_loc</span></a><span>
</span><a name="line-2140"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ScOrigin</span><span> </span><a name="local-6989586621682753970"><a href="#local-6989586621682753970"><span class="hs-identifier">wanted_size</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ctLocOrigin</span><span> </span><a href="#local-6989586621682753968"><span class="hs-identifier hs-var">solve_loc</span></a><span>
</span><a name="line-2141"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682753969"><span class="hs-identifier hs-var">given_size</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621682753970"><span class="hs-identifier hs-var">wanted_size</span></a><span>
</span><a name="line-2142"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2143"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2144"></a><span>
</span><a name="line-2145"></a><span class="hs-comment">{- Note [Unsolved Derived equalities]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In getUnsolvedInerts, we return a derived equality from the inert_eqs
because it is a candidate for floating out of this implication.  We
only float equalities with a meta-tyvar on the left, so we only pull
those out here.

Note [When does an implication have given equalities?]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider an implication
   beta =&gt; alpha ~ Int
where beta is a unification variable that has already been unified
to () in an outer scope.  Then we can float the (alpha ~ Int) out
just fine. So when deciding whether the givens contain an equality,
we should canonicalise first, rather than just looking at the original
givens (Trac #8644).

So we simply look at the inert, canonical Givens and see if there are
any equalities among them, the calculation of has_given_eqs.  There
are some wrinkles:

 * We must know which ones are bound in *this* implication and which
   are bound further out.  We can find that out from the TcLevel
   of the Given, which is itself recorded in the tcl_tclvl field
   of the TcLclEnv stored in the Given (ev_given_here).

   What about interactions between inner and outer givens?
      - Outer given is rewritten by an inner given, then there must
        have been an inner given equality, hence the &#8220;given-eq&#8221; flag
        will be true anyway.

      - Inner given rewritten by outer, retains its level (ie. The inner one)

 * We must take account of *potential* equalities, like the one above:
      beta =&gt; ...blah...
   If we still don't know what beta is, we conservatively treat it as potentially
   becoming an equality. Hence including 'irreds' in the calculation or has_given_eqs.

 * When flattening givens, we generate Given equalities like
     &lt;F [a]&gt; : F [a] ~ f,
   with Refl evidence, and we *don't* want those to count as an equality
   in the givens!  After all, the entire flattening business is just an
   internal matter, and the evidence does not mention any of the 'givens'
   of this implication.  So we do not treat inert_funeqs as a 'given equality'.

 * See Note [Let-bound skolems] for another wrinkle

 * We do *not* need to worry about representational equalities, because
   these do not affect the ability to float constraints.

Note [Let-bound skolems]
~~~~~~~~~~~~~~~~~~~~~~~~
If   * the inert set contains a canonical Given CTyEqCan (a ~ ty)
and  * 'a' is a skolem bound in this very implication,

then:
a) The Given is pretty much a let-binding, like
      f :: (a ~ b-&gt;c) =&gt; a -&gt; a
   Here the equality constraint is like saying
      let a = b-&gt;c in ...
   It is not adding any new, local equality  information,
   and hence can be ignored by has_given_eqs

b) 'a' will have been completely substituted out in the inert set,
   so we can safely discard it.  Notably, it doesn't need to be
   returned as part of 'fsks'

For an example, see Trac #9211.

See also TcUnify Note [Deeper level on the left] for how we ensure
that the right variable is on the left of the equality when both are
tyvars.

You might wonder whether the skokem really needs to be bound &quot;in the
very same implication&quot; as the equuality constraint.
(c.f. Trac #15009) Consider this:

  data S a where
    MkS :: (a ~ Int) =&gt; S a

  g :: forall a. S a -&gt; a -&gt; blah
  g x y = let h = \z. ( z :: Int
                      , case x of
                           MkS -&gt; [y,z])
          in ...

From the type signature for `g`, we get `y::a` .  Then when when we
encounter the `\z`, we'll assign `z :: alpha[1]`, say.  Next, from the
body of the lambda we'll get

  [W] alpha[1] ~ Int                             -- From z::Int
  [W] forall[2]. (a ~ Int) =&gt; [W] alpha[1] ~ a   -- From [y,z]

Now, suppose we decide to float `alpha ~ a` out of the implication
and then unify `alpha := a`.  Now we are stuck!  But if treat
`alpha ~ Int` first, and unify `alpha := Int`, all is fine.
But we absolutely cannot float that equality or we will get stuck.
-}</span><span>
</span><a name="line-2243"></a><span>
</span><a name="line-2244"></a><span class="hs-identifier">removeInertCts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-2245"></a><span class="hs-comment">-- ^ Remove inert constraints from the 'InertCans', for use when a</span><span>
</span><a name="line-2246"></a><span class="hs-comment">-- typechecker plugin wishes to discard a given.</span><span>
</span><a name="line-2247"></a><a name="removeInertCts"><a href="TcSMonad.html#removeInertCts"><span class="hs-identifier">removeInertCts</span></a></a><span> </span><a name="local-6989586621682753971"><a href="#local-6989586621682753971"><span class="hs-identifier">cts</span></a></a><span> </span><a name="local-6989586621682753972"><a href="#local-6989586621682753972"><span class="hs-identifier">icans</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="TcSMonad.html#removeInertCt"><span class="hs-identifier hs-var">removeInertCt</span></a><span> </span><a href="#local-6989586621682753972"><span class="hs-identifier hs-var">icans</span></a><span> </span><a href="#local-6989586621682753971"><span class="hs-identifier hs-var">cts</span></a><span>
</span><a name="line-2248"></a><span>
</span><a name="line-2249"></a><span class="hs-identifier">removeInertCt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span>
</span><a name="line-2250"></a><a name="removeInertCt"><a href="TcSMonad.html#removeInertCt"><span class="hs-identifier">removeInertCt</span></a></a><span> </span><a name="local-6989586621682753973"><a href="#local-6989586621682753973"><span class="hs-identifier">is</span></a></a><span> </span><a name="local-6989586621682753974"><a href="#local-6989586621682753974"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2251"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682753974"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2252"></a><span>
</span><a name="line-2253"></a><span>    </span><span class="hs-identifier hs-var">CDictCan</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753975"><a href="#local-6989586621682753975"><span class="hs-identifier">cl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753976"><a href="#local-6989586621682753976"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2254"></a><span>      </span><a href="#local-6989586621682753973"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#delDict"><span class="hs-identifier hs-var">delDict</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_dicts</span><span> </span><a href="#local-6989586621682753973"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753975"><span class="hs-identifier hs-var">cl</span></a><span> </span><a href="#local-6989586621682753976"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2255"></a><span>
</span><a name="line-2256"></a><span>    </span><span class="hs-identifier hs-var">CFunEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_fun</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753977"><a href="#local-6989586621682753977"><span class="hs-identifier">tf</span></a></a><span class="hs-special">,</span><span>  </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753978"><a href="#local-6989586621682753978"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2257"></a><span>      </span><a href="#local-6989586621682753973"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#delFunEq"><span class="hs-identifier hs-var">delFunEq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_funeqs</span><span> </span><a href="#local-6989586621682753973"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753977"><span class="hs-identifier hs-var">tf</span></a><span> </span><a href="#local-6989586621682753978"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2258"></a><span>
</span><a name="line-2259"></a><span>    </span><span class="hs-identifier hs-var">CTyEqCan</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyvar</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753979"><a href="#local-6989586621682753979"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span>  </span><span class="hs-identifier">cc_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753980"><a href="#local-6989586621682753980"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2260"></a><span>      </span><a href="#local-6989586621682753973"><span class="hs-identifier hs-var">is</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_eqs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#delTyEq"><span class="hs-identifier hs-var">delTyEq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_eqs</span><span> </span><a href="#local-6989586621682753973"><span class="hs-identifier hs-var">is</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753979"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682753980"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2261"></a><span>
</span><a name="line-2262"></a><span>    </span><span class="hs-identifier hs-var">CQuantCan</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;removeInertCt: CQuantCan&quot;</span><span>
</span><a name="line-2263"></a><span>    </span><span class="hs-identifier hs-var">CIrredCan</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;removeInertCt: CIrredEvCan&quot;</span><span>
</span><a name="line-2264"></a><span>    </span><span class="hs-identifier hs-var">CNonCanonical</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;removeInertCt: CNonCanonical&quot;</span><span>
</span><a name="line-2265"></a><span>    </span><span class="hs-identifier hs-var">CHoleCan</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;removeInertCt: CHoleCan&quot;</span><span>
</span><a name="line-2266"></a><span>
</span><a name="line-2267"></a><span>
</span><a name="line-2268"></a><span class="hs-identifier">lookupFlatCache</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcCoercion</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">CtFlavour</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2269"></a><a name="lookupFlatCache"><a href="TcSMonad.html#lookupFlatCache"><span class="hs-identifier">lookupFlatCache</span></a></a><span> </span><a name="local-6989586621682753981"><a href="#local-6989586621682753981"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621682753982"><a href="#local-6989586621682753982"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-2270"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcSMonad.html#IS"><span class="hs-identifier hs-var">IS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_flat_cache</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753990"><a href="#local-6989586621682753990"><span class="hs-identifier">flat_cache</span></a></a><span>
</span><a name="line-2271"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_funeqs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753991"><a href="#local-6989586621682753991"><span class="hs-identifier">inert_funeqs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span>
</span><a name="line-2272"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">firstJusts</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682753983"><span class="hs-identifier hs-var">lookup_inerts</span></a><span> </span><a href="#local-6989586621682753991"><span class="hs-identifier hs-var">inert_funeqs</span></a><span class="hs-special">,</span><span>
</span><a name="line-2273"></a><span>                             </span><a href="#local-6989586621682753984"><span class="hs-identifier hs-var">lookup_flats</span></a><span> </span><a href="#local-6989586621682753990"><span class="hs-identifier hs-var">flat_cache</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2274"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2275"></a><span>    </span><a name="local-6989586621682753983"><a href="#local-6989586621682753983"><span class="hs-identifier">lookup_inerts</span></a></a><span> </span><a name="local-6989586621682753985"><a href="#local-6989586621682753985"><span class="hs-identifier">inert_funeqs</span></a></a><span>
</span><a name="line-2276"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CFunEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_ev</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753986"><a href="#local-6989586621682753986"><span class="hs-identifier">ctev</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_fsk</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753987"><a href="#local-6989586621682753987"><span class="hs-identifier">fsk</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753988"><a href="#local-6989586621682753988"><span class="hs-identifier">xis</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2277"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#findFunEq"><span class="hs-identifier hs-var">findFunEq</span></a><span> </span><a href="#local-6989586621682753985"><span class="hs-identifier hs-var">inert_funeqs</span></a><span> </span><a href="#local-6989586621682753981"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621682753982"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2278"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682753982"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqTypes</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682753988"><span class="hs-identifier hs-var">xis</span></a><span>   </span><span class="hs-comment">-- The lookup might find a near-match; see</span><span>
</span><a name="line-2279"></a><span>                            </span><span class="hs-comment">-- Note [Use loose types in inert set]</span><span>
</span><a name="line-2280"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvCoercion</span><span> </span><a href="#local-6989586621682753986"><span class="hs-identifier hs-var">ctev</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkTyVarTy</span><span> </span><a href="#local-6989586621682753987"><span class="hs-identifier hs-var">fsk</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ctEvFlavour</span><span> </span><a href="#local-6989586621682753986"><span class="hs-identifier hs-var">ctev</span></a><span class="hs-special">)</span><span>
</span><a name="line-2281"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2282"></a><span>
</span><a name="line-2283"></a><span>    </span><a name="local-6989586621682753984"><a href="#local-6989586621682753984"><span class="hs-identifier">lookup_flats</span></a></a><span> </span><a name="local-6989586621682753989"><a href="#local-6989586621682753989"><span class="hs-identifier">flat_cache</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#findExactFunEq"><span class="hs-identifier hs-var">findExactFunEq</span></a><span> </span><a href="#local-6989586621682753989"><span class="hs-identifier hs-var">flat_cache</span></a><span> </span><a href="#local-6989586621682753981"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621682753982"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2284"></a><span>
</span><a name="line-2285"></a><span>
</span><a name="line-2286"></a><span class="hs-identifier">lookupInInerts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcPredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span class="hs-special">)</span><span>
</span><a name="line-2287"></a><span class="hs-comment">-- Is this exact predicate type cached in the solved or canonicals of the InertSet?</span><span>
</span><a name="line-2288"></a><a name="lookupInInerts"><a href="TcSMonad.html#lookupInInerts"><span class="hs-identifier">lookupInInerts</span></a></a><span> </span><a name="local-6989586621682753992"><a href="#local-6989586621682753992"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682753993"><a href="#local-6989586621682753993"><span class="hs-identifier">pty</span></a></a><span>
</span><a name="line-2289"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ClassPred</span><span> </span><a name="local-6989586621682753994"><a href="#local-6989586621682753994"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682753995"><a href="#local-6989586621682753995"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">classifyPredType</span><span> </span><a href="#local-6989586621682753993"><span class="hs-identifier hs-var">pty</span></a><span>
</span><a name="line-2290"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682753996"><a href="#local-6989586621682753996"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#getTcSInerts"><span class="hs-identifier hs-var">getTcSInerts</span></a><span>
</span><a name="line-2291"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#lookupSolvedDict"><span class="hs-identifier hs-var">lookupSolvedDict</span></a><span> </span><a href="#local-6989586621682753996"><span class="hs-identifier hs-var">inerts</span></a><span> </span><a href="#local-6989586621682753992"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682753994"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682753995"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mplus</span><span class="hs-special">`</span><span>
</span><a name="line-2292"></a><span>                 </span><a href="TcSMonad.html#lookupInertDict"><span class="hs-identifier hs-var">lookupInertDict</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">inert_cans</span><span> </span><a href="#local-6989586621682753996"><span class="hs-identifier hs-var">inerts</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753992"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682753994"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682753995"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2293"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- NB: No caching for equalities, IPs, holes, or errors</span><span>
</span><a name="line-2294"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2295"></a><span>
</span><a name="line-2296"></a><span class="hs-comment">-- | Look up a dictionary inert. NB: the returned 'CtEvidence' might not</span><span>
</span><a name="line-2297"></a><span class="hs-comment">-- match the input exactly. Note [Use loose types in inert set].</span><span>
</span><a name="line-2298"></a><span class="hs-identifier">lookupInertDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertCans"><span class="hs-identifier hs-type">InertCans</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-2299"></a><a name="lookupInertDict"><a href="TcSMonad.html#lookupInertDict"><span class="hs-identifier">lookupInertDict</span></a></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#IC"><span class="hs-identifier hs-var">IC</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682753997"><a href="#local-6989586621682753997"><span class="hs-identifier">dicts</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682753998"><a href="#local-6989586621682753998"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682753999"><a href="#local-6989586621682753999"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682754000"><a href="#local-6989586621682754000"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-2300"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcSMonad.html#findDict"><span class="hs-identifier hs-var">findDict</span></a><span> </span><a href="#local-6989586621682753997"><span class="hs-identifier hs-var">dicts</span></a><span> </span><a href="#local-6989586621682753998"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682753999"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682754000"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2301"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682754001"><a href="#local-6989586621682754001"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvidence</span><span> </span><a href="#local-6989586621682754001"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-2302"></a><span>      </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2303"></a><span>
</span><a name="line-2304"></a><span class="hs-comment">-- | Look up a solved inert. NB: the returned 'CtEvidence' might not</span><span>
</span><a name="line-2305"></a><span class="hs-comment">-- match the input exactly. See Note [Use loose types in inert set].</span><span>
</span><a name="line-2306"></a><span class="hs-identifier">lookupSolvedDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span>
</span><a name="line-2307"></a><span class="hs-comment">-- Returns just if exactly this predicate type exists in the solved.</span><span>
</span><a name="line-2308"></a><a name="lookupSolvedDict"><a href="TcSMonad.html#lookupSolvedDict"><span class="hs-identifier">lookupSolvedDict</span></a></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#IS"><span class="hs-identifier hs-var">IS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_solved_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754002"><a href="#local-6989586621682754002"><span class="hs-identifier">solved</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682754003"><a href="#local-6989586621682754003"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682754004"><a href="#local-6989586621682754004"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682754005"><a href="#local-6989586621682754005"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-2309"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TcSMonad.html#findDict"><span class="hs-identifier hs-var">findDict</span></a><span> </span><a href="#local-6989586621682754002"><span class="hs-identifier hs-var">solved</span></a><span> </span><a href="#local-6989586621682754003"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621682754004"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682754005"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2310"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682754006"><a href="#local-6989586621682754006"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682754006"><span class="hs-identifier hs-var">ev</span></a><span>
</span><a name="line-2311"></a><span>      </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2312"></a><span>
</span><a name="line-2313"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   Irreds
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-2318"></a><span>
</span><a name="line-2319"></a><span class="hs-identifier">foldIrreds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753634"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753634"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Cts</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753634"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753634"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-2320"></a><a name="foldIrreds"><a href="TcSMonad.html#foldIrreds"><span class="hs-identifier">foldIrreds</span></a></a><span> </span><a name="local-6989586621682754007"><a href="#local-6989586621682754007"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621682754008"><a href="#local-6989586621682754008"><span class="hs-identifier">irreds</span></a></a><span> </span><a name="local-6989586621682754009"><a href="#local-6989586621682754009"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><a href="#local-6989586621682754007"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621682754009"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621682754008"><span class="hs-identifier hs-var">irreds</span></a><span>
</span><a name="line-2321"></a><span>
</span><a name="line-2322"></a><span>
</span><a name="line-2323"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   TcAppMap
*                                                                      *
************************************************************************

Note [Use loose types in inert set]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Say we know (Eq (a |&gt; c1)) and we need (Eq (a |&gt; c2)). One is clearly
solvable from the other. So, we do lookup in the inert set using
loose types, which omit the kind-check.

We must be careful when using the result of a lookup because it may
not match the requested info exactly!

-}</span><span>
</span><a name="line-2339"></a><span>
</span><a name="line-2340"></a><span class="hs-keyword">type</span><span> </span><a name="TcAppMap"><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier">TcAppMap</span></a></a><span> </span><a name="local-6989586621682753560"><a href="#local-6989586621682753560"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">UniqDFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ListMap</span><span> </span><span class="hs-identifier hs-type">LooseTypeMap</span><span> </span><a href="#local-6989586621682753560"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2341"></a><span>    </span><span class="hs-comment">-- Indexed by tycon then the arg types, using &quot;loose&quot; matching, where</span><span>
</span><a name="line-2342"></a><span>    </span><span class="hs-comment">-- we don't require kind equality. This allows, for example, (a |&gt; co)</span><span>
</span><a name="line-2343"></a><span>    </span><span class="hs-comment">-- to match (a).</span><span>
</span><a name="line-2344"></a><span>    </span><span class="hs-comment">-- See Note [Use loose types in inert set]</span><span>
</span><a name="line-2345"></a><span>    </span><span class="hs-comment">-- Used for types and classes; hence UniqDFM</span><span>
</span><a name="line-2346"></a><span>    </span><span class="hs-comment">-- See Note [foldTM determinism] for why we use UniqDFM here</span><span>
</span><a name="line-2347"></a><span>
</span><a name="line-2348"></a><span class="hs-identifier">isEmptyTcAppMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753633"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2349"></a><a name="isEmptyTcAppMap"><a href="TcSMonad.html#isEmptyTcAppMap"><span class="hs-identifier">isEmptyTcAppMap</span></a></a><span> </span><a name="local-6989586621682754010"><a href="#local-6989586621682754010"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isNullUDFM</span><span> </span><a href="#local-6989586621682754010"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2350"></a><span>
</span><a name="line-2351"></a><span class="hs-identifier">emptyTcAppMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753632"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2352"></a><a name="emptyTcAppMap"><a href="TcSMonad.html#emptyTcAppMap"><span class="hs-identifier">emptyTcAppMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyUDFM</span><span>
</span><a name="line-2353"></a><span>
</span><a name="line-2354"></a><span class="hs-identifier">findTcApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753631"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Unique</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621682753631"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2355"></a><a name="findTcApp"><a href="TcSMonad.html#findTcApp"><span class="hs-identifier">findTcApp</span></a></a><span> </span><a name="local-6989586621682754011"><a href="#local-6989586621682754011"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754012"><a href="#local-6989586621682754012"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621682754013"><a href="#local-6989586621682754013"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754014"><a href="#local-6989586621682754014"><span class="hs-identifier">tys_map</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupUDFM</span><span> </span><a href="#local-6989586621682754011"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754012"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-2356"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">lookupTM</span><span> </span><a href="#local-6989586621682754013"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754014"><span class="hs-identifier hs-var">tys_map</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2357"></a><span>
</span><a name="line-2358"></a><span class="hs-identifier">delTcApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753630"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Unique</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753630"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2359"></a><a name="delTcApp"><a href="TcSMonad.html#delTcApp"><span class="hs-identifier">delTcApp</span></a></a><span> </span><a name="local-6989586621682754015"><a href="#local-6989586621682754015"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754016"><a href="#local-6989586621682754016"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682754017"><a href="#local-6989586621682754017"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">adjustUDFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">deleteTM</span><span> </span><a href="#local-6989586621682754017"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754015"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754016"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-2360"></a><span>
</span><a name="line-2361"></a><span class="hs-identifier">insertTcApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753629"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Unique</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753629"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753629"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2362"></a><a name="insertTcApp"><a href="TcSMonad.html#insertTcApp"><span class="hs-identifier">insertTcApp</span></a></a><span> </span><a name="local-6989586621682754018"><a href="#local-6989586621682754018"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754019"><a href="#local-6989586621682754019"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682754020"><a href="#local-6989586621682754020"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682754021"><a href="#local-6989586621682754021"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">alterUDFM</span><span> </span><a href="#local-6989586621682754022"><span class="hs-identifier hs-var">alter_tm</span></a><span> </span><a href="#local-6989586621682754018"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754019"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-2363"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2364"></a><span>    </span><a name="local-6989586621682754022"><a href="#local-6989586621682754022"><span class="hs-identifier">alter_tm</span></a></a><span> </span><a name="local-6989586621682754023"><a href="#local-6989586621682754023"><span class="hs-identifier">mb_tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">insertTM</span><span> </span><a href="#local-6989586621682754020"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754021"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754023"><span class="hs-identifier hs-var">mb_tm</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">emptyTM</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2365"></a><span>
</span><a name="line-2366"></a><span class="hs-comment">-- mapTcApp :: (a-&gt;b) -&gt; TcAppMap a -&gt; TcAppMap b</span><span>
</span><a name="line-2367"></a><span class="hs-comment">-- mapTcApp f = mapUDFM (mapTM f)</span><span>
</span><a name="line-2368"></a><span>
</span><a name="line-2369"></a><span class="hs-identifier">filterTcAppMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-2370"></a><a name="filterTcAppMap"><a href="TcSMonad.html#filterTcAppMap"><span class="hs-identifier">filterTcAppMap</span></a></a><span> </span><a name="local-6989586621682754024"><a href="#local-6989586621682754024"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682754025"><a href="#local-6989586621682754025"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-2371"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapUDFM</span><span> </span><a href="#local-6989586621682754026"><span class="hs-identifier hs-var">do_tm</span></a><span> </span><a href="#local-6989586621682754025"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2372"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2373"></a><span>    </span><a name="local-6989586621682754026"><a href="#local-6989586621682754026"><span class="hs-identifier">do_tm</span></a></a><span> </span><a name="local-6989586621682754028"><a href="#local-6989586621682754028"><span class="hs-identifier">tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldTM</span><span> </span><a href="#local-6989586621682754027"><span class="hs-identifier hs-var">insert_mb</span></a><span> </span><a href="#local-6989586621682754028"><span class="hs-identifier hs-var">tm</span></a><span> </span><span class="hs-identifier hs-var">emptyTM</span><span>
</span><a name="line-2374"></a><span>    </span><a name="local-6989586621682754027"><a href="#local-6989586621682754027"><span class="hs-identifier">insert_mb</span></a></a><span> </span><a name="local-6989586621682754029"><a href="#local-6989586621682754029"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621682754030"><a href="#local-6989586621682754030"><span class="hs-identifier">tm</span></a></a><span>
</span><a name="line-2375"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682754024"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682754029"><span class="hs-identifier hs-var">ct</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">insertTM</span><span> </span><a href="#local-6989586621682754031"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754029"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621682754030"><span class="hs-identifier hs-var">tm</span></a><span>
</span><a name="line-2376"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754030"><span class="hs-identifier hs-var">tm</span></a><span>
</span><a name="line-2377"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-2378"></a><span>         </span><a name="local-6989586621682754031"><a href="#local-6989586621682754031"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682754029"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2379"></a><span>                </span><span class="hs-identifier hs-var">CFunEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754032"><a href="#local-6989586621682754032"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682754032"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2380"></a><span>                </span><span class="hs-identifier hs-var">CDictCan</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754033"><a href="#local-6989586621682754033"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682754033"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2381"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;filterTcAppMap&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682754029"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-2382"></a><span>
</span><a name="line-2383"></a><span class="hs-identifier">tcAppMapToBag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753628"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="#local-6989586621682753628"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2384"></a><a name="tcAppMapToBag"><a href="TcSMonad.html#tcAppMapToBag"><span class="hs-identifier">tcAppMapToBag</span></a></a><span> </span><a name="local-6989586621682754034"><a href="#local-6989586621682754034"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldTcAppMap"><span class="hs-identifier hs-var">foldTcAppMap</span></a><span> </span><span class="hs-identifier hs-var">consBag</span><span> </span><a href="#local-6989586621682754034"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-identifier hs-var">emptyBag</span><span>
</span><a name="line-2385"></a><span>
</span><a name="line-2386"></a><span class="hs-identifier">foldTcAppMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753626"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753627"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753627"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753626"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753627"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753627"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-2387"></a><a name="foldTcAppMap"><a href="TcSMonad.html#foldTcAppMap"><span class="hs-identifier">foldTcAppMap</span></a></a><span> </span><a name="local-6989586621682754035"><a href="#local-6989586621682754035"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621682754036"><a href="#local-6989586621682754036"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754037"><a href="#local-6989586621682754037"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldUDFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldTM</span><span> </span><a href="#local-6989586621682754035"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754037"><span class="hs-identifier hs-var">z</span></a><span> </span><a href="#local-6989586621682754036"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2388"></a><span>
</span><a name="line-2389"></a><span>
</span><a name="line-2390"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   DictMap
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-2395"></a><span>
</span><a name="line-2396"></a><span>
</span><a name="line-2397"></a><span class="hs-comment">{- Note [Tuples hiding implicit parameters]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f,g :: (?x::Int, C a) =&gt; a -&gt; a
   f v = let ?x = 4 in g v

The call to 'g' gives rise to a Wanted constraint (?x::Int, C a).
We must /not/ solve this from the Given (?x::Int, C a), because of
the intervening binding for (?x::Int).  Trac #14218.

We deal with this by arranging that we always fail when looking up a
tuple constraint that hides an implicit parameter. Not that this applies
  * both to the inert_dicts (lookupInertDict)
  * and to the solved_dicts (looukpSolvedDict)
An alternative would be not to extend these sets with such tuple
constraints, but it seemed more direct to deal with the lookup.

Note [Solving CallStack constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose f :: HasCallStack =&gt; blah.  Then

* Each call to 'f' gives rise to
    [W] s1 :: IP &quot;callStack&quot; CallStack    -- CtOrigin = OccurrenceOf f
  with a CtOrigin that says &quot;OccurrenceOf f&quot;.
  Remember that HasCallStack is just shorthand for
    IP &quot;callStack CallStack
  See Note [Overview of implicit CallStacks] in TcEvidence

* We cannonicalise such constraints, in TcCanonical.canClassNC, by
  pushing the call-site info on the stack, and changing the CtOrigin
  to record that has been done.
   Bind:  s1 = pushCallStack &lt;site-info&gt; s2
   [W] s2 :: IP &quot;callStack&quot; CallStack   -- CtOrigin = IPOccOrigin

* Then, and only then, we can solve the constraint from an enclosing
  Given.

So we must be careful /not/ to solve 's1' from the Givens.  Again,
we ensure this by arranging that findDict always misses when looking
up souch constraints.
-}</span><span>
</span><a name="line-2438"></a><span>
</span><a name="line-2439"></a><span class="hs-keyword">type</span><span> </span><a name="DictMap"><a href="TcSMonad.html#DictMap"><span class="hs-identifier">DictMap</span></a></a><span> </span><a name="local-6989586621682753559"><a href="#local-6989586621682753559"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753559"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2440"></a><span>
</span><a name="line-2441"></a><span class="hs-identifier">emptyDictMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753625"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2442"></a><a name="emptyDictMap"><a href="TcSMonad.html#emptyDictMap"><span class="hs-identifier">emptyDictMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyTcAppMap"><span class="hs-identifier hs-var">emptyTcAppMap</span></a><span>
</span><a name="line-2443"></a><span>
</span><a name="line-2444"></a><span class="hs-identifier">findDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753624"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtLoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621682753624"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2445"></a><a name="findDict"><a href="TcSMonad.html#findDict"><span class="hs-identifier">findDict</span></a></a><span> </span><a name="local-6989586621682754038"><a href="#local-6989586621682754038"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754039"><a href="#local-6989586621682754039"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621682754040"><a href="#local-6989586621682754040"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682754041"><a href="#local-6989586621682754041"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-2446"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isCTupleClass</span><span> </span><a href="#local-6989586621682754040"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-2447"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">hasIPPred</span><span> </span><a href="#local-6989586621682754041"><span class="hs-identifier hs-var">tys</span></a><span>   </span><span class="hs-comment">-- See Note [Tuples hiding implicit parameters]</span><span>
</span><a name="line-2448"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2449"></a><span>
</span><a name="line-2450"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">isCallStackPred</span><span> </span><a href="#local-6989586621682754040"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682754041"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2451"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">ctLocOrigin</span><span> </span><a href="#local-6989586621682754039"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-2452"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>             </span><span class="hs-comment">-- See Note [Solving CallStack constraints]</span><span>
</span><a name="line-2453"></a><span>
</span><a name="line-2454"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2455"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#findTcApp"><span class="hs-identifier hs-var">findTcApp</span></a><span> </span><a href="#local-6989586621682754038"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621682754040"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754041"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2456"></a><span>
</span><a name="line-2457"></a><span class="hs-identifier">findDictsByClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753623"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="#local-6989586621682753623"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2458"></a><a name="findDictsByClass"><a href="TcSMonad.html#findDictsByClass"><span class="hs-identifier">findDictsByClass</span></a></a><span> </span><a name="local-6989586621682754042"><a href="#local-6989586621682754042"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754043"><a href="#local-6989586621682754043"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-2459"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682754044"><a href="#local-6989586621682754044"><span class="hs-identifier">tm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupUDFM</span><span> </span><a href="#local-6989586621682754042"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754043"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldTM</span><span> </span><span class="hs-identifier hs-var">consBag</span><span> </span><a href="#local-6989586621682754044"><span class="hs-identifier hs-var">tm</span></a><span> </span><span class="hs-identifier hs-var">emptyBag</span><span>
</span><a name="line-2460"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span>
</span><a name="line-2461"></a><span>
</span><a name="line-2462"></a><span class="hs-identifier">delDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753622"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753622"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2463"></a><a name="delDict"><a href="TcSMonad.html#delDict"><span class="hs-identifier">delDict</span></a></a><span> </span><a name="local-6989586621682754045"><a href="#local-6989586621682754045"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754046"><a href="#local-6989586621682754046"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682754047"><a href="#local-6989586621682754047"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#delTcApp"><span class="hs-identifier hs-var">delTcApp</span></a><span> </span><a href="#local-6989586621682754045"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621682754046"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754047"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2464"></a><span>
</span><a name="line-2465"></a><span class="hs-identifier">addDict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753621"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753621"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753621"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2466"></a><a name="addDict"><a href="TcSMonad.html#addDict"><span class="hs-identifier">addDict</span></a></a><span> </span><a name="local-6989586621682754048"><a href="#local-6989586621682754048"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754049"><a href="#local-6989586621682754049"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682754050"><a href="#local-6989586621682754050"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682754051"><a href="#local-6989586621682754051"><span class="hs-identifier">item</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#insertTcApp"><span class="hs-identifier hs-var">insertTcApp</span></a><span> </span><a href="#local-6989586621682754048"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621682754049"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754050"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754051"><span class="hs-identifier hs-var">item</span></a><span>
</span><a name="line-2467"></a><span>
</span><a name="line-2468"></a><span class="hs-identifier">addDictsByClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-2469"></a><a name="addDictsByClass"><a href="TcSMonad.html#addDictsByClass"><span class="hs-identifier">addDictsByClass</span></a></a><span> </span><a name="local-6989586621682754052"><a href="#local-6989586621682754052"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754053"><a href="#local-6989586621682754053"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621682754054"><a href="#local-6989586621682754054"><span class="hs-identifier">items</span></a></a><span>
</span><a name="line-2470"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">addToUDFM</span><span> </span><a href="#local-6989586621682754052"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754053"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldrBag</span><span> </span><a href="#local-6989586621682754055"><span class="hs-identifier hs-var">add</span></a><span> </span><span class="hs-identifier hs-var">emptyTM</span><span> </span><a href="#local-6989586621682754054"><span class="hs-identifier hs-var">items</span></a><span class="hs-special">)</span><span>
</span><a name="line-2471"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2472"></a><span>    </span><a name="local-6989586621682754055"><a href="#local-6989586621682754055"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621682754056"><a href="#local-6989586621682754056"><span class="hs-identifier">ct</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754057"><a href="#local-6989586621682754057"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682754058"><a href="#local-6989586621682754058"><span class="hs-identifier">tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">insertTM</span><span> </span><a href="#local-6989586621682754057"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754056"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621682754058"><span class="hs-identifier hs-var">tm</span></a><span>
</span><a name="line-2473"></a><span>    </span><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682754059"><a href="#local-6989586621682754059"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;addDictsByClass&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682754059"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-2474"></a><span>
</span><a name="line-2475"></a><span class="hs-identifier">filterDicts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span>
</span><a name="line-2476"></a><a name="filterDicts"><a href="TcSMonad.html#filterDicts"><span class="hs-identifier">filterDicts</span></a></a><span> </span><a name="local-6989586621682754060"><a href="#local-6989586621682754060"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682754061"><a href="#local-6989586621682754061"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#filterTcAppMap"><span class="hs-identifier hs-var">filterTcAppMap</span></a><span> </span><a href="#local-6989586621682754060"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682754061"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2477"></a><span>
</span><a name="line-2478"></a><span class="hs-identifier">partitionDicts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-2479"></a><a name="partitionDicts"><a href="TcSMonad.html#partitionDicts"><span class="hs-identifier">partitionDicts</span></a></a><span> </span><a name="local-6989586621682754062"><a href="#local-6989586621682754062"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682754063"><a href="#local-6989586621682754063"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldTcAppMap"><span class="hs-identifier hs-var">foldTcAppMap</span></a><span> </span><a href="#local-6989586621682754064"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621682754063"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#emptyDicts"><span class="hs-identifier hs-var">emptyDicts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2480"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2481"></a><span>    </span><a name="local-6989586621682754064"><a href="#local-6989586621682754064"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621682754066"><a href="#local-6989586621682754066"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682754067"><a href="#local-6989586621682754067"><span class="hs-identifier">yeses</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682754068"><a href="#local-6989586621682754068"><span class="hs-identifier">noes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682754062"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682754066"><span class="hs-identifier hs-var">ct</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754066"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">consBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682754067"><span class="hs-identifier hs-var">yeses</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682754068"><span class="hs-identifier hs-var">noes</span></a><span class="hs-special">)</span><span>
</span><a name="line-2482"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754067"><span class="hs-identifier hs-var">yeses</span></a><span class="hs-special">,</span><span>              </span><a href="#local-6989586621682754065"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621682754066"><span class="hs-identifier hs-var">ct</span></a><span> </span><a href="#local-6989586621682754068"><span class="hs-identifier hs-var">noes</span></a><span class="hs-special">)</span><span>
</span><a name="line-2483"></a><span>    </span><a name="local-6989586621682754065"><a href="#local-6989586621682754065"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621682754069"><a href="#local-6989586621682754069"><span class="hs-identifier">ct</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">CDictCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_class</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754070"><a href="#local-6989586621682754070"><span class="hs-identifier">cls</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754071"><a href="#local-6989586621682754071"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682754072"><a href="#local-6989586621682754072"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-2484"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#addDict"><span class="hs-identifier hs-var">addDict</span></a><span> </span><a href="#local-6989586621682754072"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754070"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621682754071"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754069"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-2485"></a><span>    </span><span class="hs-identifier">add</span><span> </span><a name="local-6989586621682754073"><a href="#local-6989586621682754073"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;partitionDicts&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682754073"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-2486"></a><span>
</span><a name="line-2487"></a><span class="hs-identifier">dictsToBag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753620"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="#local-6989586621682753620"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2488"></a><a name="dictsToBag"><a href="TcSMonad.html#dictsToBag"><span class="hs-identifier">dictsToBag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#tcAppMapToBag"><span class="hs-identifier hs-var">tcAppMapToBag</span></a><span>
</span><a name="line-2489"></a><span>
</span><a name="line-2490"></a><span class="hs-identifier">foldDicts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753618"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753619"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753619"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753618"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753619"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753619"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-2491"></a><a name="foldDicts"><a href="TcSMonad.html#foldDicts"><span class="hs-identifier">foldDicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldTcAppMap"><span class="hs-identifier hs-var">foldTcAppMap</span></a><span>
</span><a name="line-2492"></a><span>
</span><a name="line-2493"></a><span class="hs-identifier">emptyDicts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#DictMap"><span class="hs-identifier hs-type">DictMap</span></a><span> </span><a href="#local-6989586621682753617"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2494"></a><a name="emptyDicts"><a href="TcSMonad.html#emptyDicts"><span class="hs-identifier">emptyDicts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyTcAppMap"><span class="hs-identifier hs-var">emptyTcAppMap</span></a><span>
</span><a name="line-2495"></a><span>
</span><a name="line-2496"></a><span>
</span><a name="line-2497"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                   FunEqMap
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-2502"></a><span>
</span><a name="line-2503"></a><span class="hs-keyword">type</span><span> </span><a name="FunEqMap"><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier">FunEqMap</span></a></a><span> </span><a name="local-6989586621682753558"><a href="#local-6989586621682753558"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753558"><span class="hs-identifier hs-type">a</span></a><span>  </span><span class="hs-comment">-- A map whose key is a (TyCon, [Type]) pair</span><span>
</span><a name="line-2504"></a><span>
</span><a name="line-2505"></a><span class="hs-identifier">emptyFunEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcAppMap"><span class="hs-identifier hs-type">TcAppMap</span></a><span> </span><a href="#local-6989586621682753616"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2506"></a><a name="emptyFunEqs"><a href="TcSMonad.html#emptyFunEqs"><span class="hs-identifier">emptyFunEqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyTcAppMap"><span class="hs-identifier hs-var">emptyTcAppMap</span></a><span>
</span><a name="line-2507"></a><span>
</span><a name="line-2508"></a><span class="hs-identifier">findFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><a href="#local-6989586621682753615"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621682753615"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2509"></a><a name="findFunEq"><a href="TcSMonad.html#findFunEq"><span class="hs-identifier">findFunEq</span></a></a><span> </span><a name="local-6989586621682754074"><a href="#local-6989586621682754074"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754075"><a href="#local-6989586621682754075"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682754076"><a href="#local-6989586621682754076"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#findTcApp"><span class="hs-identifier hs-var">findTcApp</span></a><span> </span><a href="#local-6989586621682754074"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621682754075"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754076"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2510"></a><span>
</span><a name="line-2511"></a><span class="hs-identifier">funEqsToBag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><a href="#local-6989586621682753614"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><a href="#local-6989586621682753614"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2512"></a><a name="funEqsToBag"><a href="TcSMonad.html#funEqsToBag"><span class="hs-identifier">funEqsToBag</span></a></a><span> </span><a name="local-6989586621682754077"><a href="#local-6989586621682754077"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldTcAppMap"><span class="hs-identifier hs-var">foldTcAppMap</span></a><span> </span><span class="hs-identifier hs-var">consBag</span><span> </span><a href="#local-6989586621682754077"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-identifier hs-var">emptyBag</span><span>
</span><a name="line-2513"></a><span>
</span><a name="line-2514"></a><span class="hs-identifier">findFunEqsByTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><a href="#local-6989586621682753613"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682753613"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-2515"></a><span class="hs-comment">-- Get inert function equation constraints that have the given tycon</span><span>
</span><a name="line-2516"></a><span class="hs-comment">-- in their head.  Not that the constraints remain in the inert set.</span><span>
</span><a name="line-2517"></a><span class="hs-comment">-- We use this to check for derived interactions with built-in type-function</span><span>
</span><a name="line-2518"></a><span class="hs-comment">-- constructors.</span><span>
</span><a name="line-2519"></a><a name="findFunEqsByTyCon"><a href="TcSMonad.html#findFunEqsByTyCon"><span class="hs-identifier">findFunEqsByTyCon</span></a></a><span> </span><a name="local-6989586621682754078"><a href="#local-6989586621682754078"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754079"><a href="#local-6989586621682754079"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-2520"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682754080"><a href="#local-6989586621682754080"><span class="hs-identifier">tm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupUDFM</span><span> </span><a href="#local-6989586621682754078"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754079"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldTM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754080"><span class="hs-identifier hs-var">tm</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2521"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2522"></a><span>
</span><a name="line-2523"></a><span class="hs-identifier">foldFunEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753611"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753612"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753612"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><a href="#local-6989586621682753611"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753612"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753612"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-2524"></a><a name="foldFunEqs"><a href="TcSMonad.html#foldFunEqs"><span class="hs-identifier">foldFunEqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldTcAppMap"><span class="hs-identifier hs-var">foldTcAppMap</span></a><span>
</span><a name="line-2525"></a><span>
</span><a name="line-2526"></a><span class="hs-comment">-- mapFunEqs :: (a -&gt; b) -&gt; FunEqMap a -&gt; FunEqMap b</span><span>
</span><a name="line-2527"></a><span class="hs-comment">-- mapFunEqs = mapTcApp</span><span>
</span><a name="line-2528"></a><span>
</span><a name="line-2529"></a><span class="hs-comment">-- filterFunEqs :: (Ct -&gt; Bool) -&gt; FunEqMap Ct -&gt; FunEqMap Ct</span><span>
</span><a name="line-2530"></a><span class="hs-comment">-- filterFunEqs = filterTcAppMap</span><span>
</span><a name="line-2531"></a><span>
</span><a name="line-2532"></a><span class="hs-identifier">insertFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><a href="#local-6989586621682753610"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753610"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><a href="#local-6989586621682753610"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2533"></a><a name="insertFunEq"><a href="TcSMonad.html#insertFunEq"><span class="hs-identifier">insertFunEq</span></a></a><span> </span><a name="local-6989586621682754081"><a href="#local-6989586621682754081"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754082"><a href="#local-6989586621682754082"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682754083"><a href="#local-6989586621682754083"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682754084"><a href="#local-6989586621682754084"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#insertTcApp"><span class="hs-identifier hs-var">insertTcApp</span></a><span> </span><a href="#local-6989586621682754081"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621682754082"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754083"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754084"><span class="hs-identifier hs-var">val</span></a><span>
</span><a name="line-2534"></a><span>
</span><a name="line-2535"></a><span class="hs-identifier">partitionFunEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><span class="hs-identifier hs-type">Ct</span><span class="hs-special">)</span><span>
</span><a name="line-2536"></a><span class="hs-comment">-- Optimise for the case where the predicate is false</span><span>
</span><a name="line-2537"></a><span class="hs-comment">-- partitionFunEqs is called only from kick-out, and kick-out usually</span><span>
</span><a name="line-2538"></a><span class="hs-comment">-- kicks out very few equalities, so we want to optimise for that case</span><span>
</span><a name="line-2539"></a><a name="partitionFunEqs"><a href="TcSMonad.html#partitionFunEqs"><span class="hs-identifier">partitionFunEqs</span></a></a><span> </span><a name="local-6989586621682754085"><a href="#local-6989586621682754085"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682754086"><a href="#local-6989586621682754086"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754087"><span class="hs-identifier hs-var">yeses</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682754089"><span class="hs-identifier hs-var">del</span></a><span> </span><a href="#local-6989586621682754086"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754087"><span class="hs-identifier hs-var">yeses</span></a><span class="hs-special">)</span><span>
</span><a name="line-2540"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2541"></a><span>    </span><a name="local-6989586621682754087"><a href="#local-6989586621682754087"><span class="hs-identifier">yeses</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#foldTcAppMap"><span class="hs-identifier hs-var">foldTcAppMap</span></a><span> </span><a href="#local-6989586621682754088"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621682754086"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2542"></a><span>    </span><a name="local-6989586621682754088"><a href="#local-6989586621682754088"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621682754090"><a href="#local-6989586621682754090"><span class="hs-identifier">ct</span></a></a><span> </span><a name="local-6989586621682754091"><a href="#local-6989586621682754091"><span class="hs-identifier">yeses</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682754085"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682754090"><span class="hs-identifier hs-var">ct</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754090"><span class="hs-identifier hs-var">ct</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682754091"><span class="hs-identifier hs-var">yeses</span></a><span>
</span><a name="line-2543"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754091"><span class="hs-identifier hs-var">yeses</span></a><span>
</span><a name="line-2544"></a><span>    </span><a name="local-6989586621682754089"><a href="#local-6989586621682754089"><span class="hs-identifier">del</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CFunEqCan</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cc_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754092"><a href="#local-6989586621682754092"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cc_tyargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754093"><a href="#local-6989586621682754093"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682754094"><a href="#local-6989586621682754094"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-2545"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#delFunEq"><span class="hs-identifier hs-var">delFunEq</span></a><span> </span><a href="#local-6989586621682754094"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682754092"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682754093"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2546"></a><span>    </span><span class="hs-identifier">del</span><span> </span><a name="local-6989586621682754095"><a href="#local-6989586621682754095"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;partitionFunEqs&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682754095"><span class="hs-identifier hs-var">ct</span></a><span class="hs-special">)</span><span>
</span><a name="line-2547"></a><span>
</span><a name="line-2548"></a><span class="hs-identifier">delFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><a href="#local-6989586621682753609"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#FunEqMap"><span class="hs-identifier hs-type">FunEqMap</span></a><span> </span><a href="#local-6989586621682753609"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2549"></a><a name="delFunEq"><a href="TcSMonad.html#delFunEq"><span class="hs-identifier">delFunEq</span></a></a><span> </span><a name="local-6989586621682754096"><a href="#local-6989586621682754096"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754097"><a href="#local-6989586621682754097"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682754098"><a href="#local-6989586621682754098"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#delTcApp"><span class="hs-identifier hs-var">delTcApp</span></a><span> </span><a href="#local-6989586621682754096"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621682754097"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682754098"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2550"></a><span>
</span><a name="line-2551"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-2552"></a><span class="hs-keyword">type</span><span> </span><a name="ExactFunEqMap"><a href="TcSMonad.html#ExactFunEqMap"><span class="hs-identifier">ExactFunEqMap</span></a></a><span> </span><a name="local-6989586621682753557"><a href="#local-6989586621682753557"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">UniqFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ListMap</span><span> </span><span class="hs-identifier hs-type">TypeMap</span><span> </span><a href="#local-6989586621682753557"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2553"></a><span>
</span><a name="line-2554"></a><span class="hs-identifier">emptyExactFunEqs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#ExactFunEqMap"><span class="hs-identifier hs-type">ExactFunEqMap</span></a><span> </span><a href="#local-6989586621682753608"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2555"></a><a name="emptyExactFunEqs"><a href="TcSMonad.html#emptyExactFunEqs"><span class="hs-identifier">emptyExactFunEqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyUFM</span><span>
</span><a name="line-2556"></a><span>
</span><a name="line-2557"></a><span class="hs-identifier">findExactFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#ExactFunEqMap"><span class="hs-identifier hs-type">ExactFunEqMap</span></a><span> </span><a href="#local-6989586621682753607"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621682753607"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2558"></a><a name="findExactFunEq"><a href="TcSMonad.html#findExactFunEq"><span class="hs-identifier">findExactFunEq</span></a></a><span> </span><a name="local-6989586621682754099"><a href="#local-6989586621682754099"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754100"><a href="#local-6989586621682754100"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682754101"><a href="#local-6989586621682754101"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754102"><a href="#local-6989586621682754102"><span class="hs-identifier">tys_map</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupUFM</span><span> </span><a href="#local-6989586621682754099"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621682754100"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2559"></a><span>                             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">lookupTM</span><span> </span><a href="#local-6989586621682754101"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754102"><span class="hs-identifier hs-var">tys_map</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2560"></a><span>
</span><a name="line-2561"></a><span class="hs-identifier">insertExactFunEq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#ExactFunEqMap"><span class="hs-identifier hs-type">ExactFunEqMap</span></a><span> </span><a href="#local-6989586621682753606"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682753606"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#ExactFunEqMap"><span class="hs-identifier hs-type">ExactFunEqMap</span></a><span> </span><a href="#local-6989586621682753606"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2562"></a><a name="insertExactFunEq"><a href="TcSMonad.html#insertExactFunEq"><span class="hs-identifier">insertExactFunEq</span></a></a><span> </span><a name="local-6989586621682754103"><a href="#local-6989586621682754103"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621682754104"><a href="#local-6989586621682754104"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682754105"><a href="#local-6989586621682754105"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682754106"><a href="#local-6989586621682754106"><span class="hs-identifier">val</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">alterUFM</span><span> </span><a href="#local-6989586621682754107"><span class="hs-identifier hs-var">alter_tm</span></a><span> </span><a href="#local-6989586621682754103"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621682754104"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2563"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682754107"><a href="#local-6989586621682754107"><span class="hs-identifier">alter_tm</span></a></a><span> </span><a name="local-6989586621682754108"><a href="#local-6989586621682754108"><span class="hs-identifier">mb_tm</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">insertTM</span><span> </span><a href="#local-6989586621682754105"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682754106"><span class="hs-identifier hs-var">val</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754108"><span class="hs-identifier hs-var">mb_tm</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">emptyTM</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2564"></a><span>
</span><a name="line-2565"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
*              The TcS solver monad                                    *
*                                                                      *
************************************************************************

Note [The TcS monad]
~~~~~~~~~~~~~~~~~~~~
The TcS monad is a weak form of the main Tc monad

All you can do is
    * fail
    * allocate new variables
    * fill in evidence variables

Filling in a dictionary evidence variable means to create a binding
for it, so TcS carries a mutable location where the binding can be
added.  This is initialised from the innermost implication constraint.
-}</span><span>
</span><a name="line-2585"></a><span>
</span><a name="line-2586"></a><span class="hs-keyword">data</span><span> </span><a name="TcSEnv"><a href="TcSMonad.html#TcSEnv"><span class="hs-identifier">TcSEnv</span></a></a><span>
</span><a name="line-2587"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="TcSEnv"><a href="TcSMonad.html#TcSEnv"><span class="hs-identifier">TcSEnv</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-2588"></a><span>      </span><a name="tcs_ev_binds"><a href="TcSMonad.html#tcs_ev_binds"><span class="hs-identifier">tcs_ev_binds</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span class="hs-special">,</span><span>
</span><a name="line-2589"></a><span>
</span><a name="line-2590"></a><span>      </span><a name="tcs_unified"><a href="TcSMonad.html#tcs_unified"><span class="hs-identifier">tcs_unified</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>
</span><a name="line-2591"></a><span>         </span><span class="hs-comment">-- The number of unification variables we have filled</span><span>
</span><a name="line-2592"></a><span>         </span><span class="hs-comment">-- The important thing is whether it is non-zero</span><span>
</span><a name="line-2593"></a><span>
</span><a name="line-2594"></a><span>      </span><a name="tcs_count"><a href="TcSMonad.html#tcs_count"><span class="hs-identifier">tcs_count</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Global step count</span><span>
</span><a name="line-2595"></a><span>
</span><a name="line-2596"></a><span>      </span><a name="tcs_inerts"><a href="TcSMonad.html#tcs_inerts"><span class="hs-identifier">tcs_inerts</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="TcSMonad.html#InertSet"><span class="hs-identifier hs-type">InertSet</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Current inert set</span><span>
</span><a name="line-2597"></a><span>
</span><a name="line-2598"></a><span>      </span><span class="hs-comment">-- The main work-list and the flattening worklist</span><span>
</span><a name="line-2599"></a><span>      </span><span class="hs-comment">-- See Note [Work list priorities] and</span><span>
</span><a name="line-2600"></a><span>      </span><a name="tcs_worklist"><a href="TcSMonad.html#tcs_worklist"><span class="hs-identifier">tcs_worklist</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="TcSMonad.html#WorkList"><span class="hs-identifier hs-type">WorkList</span></a><span> </span><span class="hs-comment">-- Current worklist</span><span>
</span><a name="line-2601"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-2602"></a><span>
</span><a name="line-2603"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-2604"></a><span class="hs-keyword">newtype</span><span> </span><a name="TcS"><a href="TcSMonad.html#TcS"><span class="hs-identifier">TcS</span></a></a><span> </span><a name="local-6989586621682753556"><a href="#local-6989586621682753556"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TcS"><a href="TcSMonad.html#TcS"><span class="hs-identifier">TcS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unTcS"><a href="TcSMonad.html#unTcS"><span class="hs-identifier">unTcS</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcSEnv"><span class="hs-identifier hs-type">TcSEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682753556"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2605"></a><span>
</span><a name="line-2606"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2607"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621682753568"><a href="#local-6989586621682753568"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682753569"><a href="#local-6989586621682753569"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621682753568"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unTcS</span><span> </span><a href="#local-6989586621682753569"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2608"></a><span>
</span><a name="line-2609"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2610"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621682753567"><a href="#local-6989586621682753567"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682753567"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-2611"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-2612"></a><span>
</span><a name="line-2613"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2614"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,13,0)
</span><span>  </span><a name="local-3458764513820541098"><span class="hs-identifier">fail</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MonadFail.fail</span><span>
</span><a name="line-2616"></a><span class="hs-cpp">#endif
</span><span>  </span><a name="local-6989586621682753563"><a href="#local-6989586621682753563"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621682753564"><a href="#local-6989586621682753564"><span class="hs-identifier">k</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682753565"><a href="#local-6989586621682753565"><span class="hs-identifier">ebs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">unTcS</span><span> </span><a href="#local-6989586621682753563"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621682753565"><span class="hs-identifier hs-var">ebs</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682753566"><a href="#local-6989586621682753566"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">unTcS</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753564"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621682753566"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682753565"><span class="hs-identifier hs-var">ebs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2618"></a><span>
</span><a name="line-2619"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadFail.MonadFail</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2620"></a><span>  </span><a name="local-3458764513820541104"><span class="hs-identifier">fail</span></a><span> </span><a name="local-6989586621682753562"><a href="#local-6989586621682753562"><span class="hs-identifier">err</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621682753562"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span>
</span><a name="line-2621"></a><span>
</span><a name="line-2622"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadUnique</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2623"></a><span>   </span><a name="local-8214565720323805401"><span class="hs-identifier">getUniqueSupplyM</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-identifier hs-var">getUniqueSupplyM</span><span>
</span><a name="line-2624"></a><span>
</span><a name="line-2625"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasModule</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2626"></a><span>   </span><a name="local-8214565720323805038"><span class="hs-identifier">getModule</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-2627"></a><span>
</span><a name="line-2628"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadThings</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2629"></a><span>   </span><a name="local-8214565720323794786"><span class="hs-identifier">lookupThing</span></a><span> </span><a name="local-6989586621682753561"><a href="#local-6989586621682753561"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupThing</span><span> </span><a href="#local-6989586621682753561"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-2630"></a><span>
</span><a name="line-2631"></a><span class="hs-comment">-- Basic functionality</span><span>
</span><a name="line-2632"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-2633"></a><span class="hs-identifier">wrapTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682753605"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753605"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2634"></a><span class="hs-comment">-- Do not export wrapTcS, because it promotes an arbitrary TcM to TcS,</span><span>
</span><a name="line-2635"></a><span class="hs-comment">-- and TcS is supposed to have limited functionality</span><span>
</span><a name="line-2636"></a><a name="wrapTcS"><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier">wrapTcS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-comment">-- a TcM action will not use the TcEvBinds</span><span>
</span><a name="line-2637"></a><span>
</span><a name="line-2638"></a><span class="hs-identifier">wrapErrTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682753604"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753604"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2639"></a><span class="hs-comment">-- The thing wrapped should just fail</span><span>
</span><a name="line-2640"></a><span class="hs-comment">-- There's no static check; it's up to the user</span><span>
</span><a name="line-2641"></a><span class="hs-comment">-- Having a variant for each error message is too painful</span><span>
</span><a name="line-2642"></a><a name="wrapErrTcS"><a href="TcSMonad.html#wrapErrTcS"><span class="hs-identifier">wrapErrTcS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span>
</span><a name="line-2643"></a><span>
</span><a name="line-2644"></a><span class="hs-identifier">wrapWarnTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682753603"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753603"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2645"></a><span class="hs-comment">-- The thing wrapped should just add a warning, or no-op</span><span>
</span><a name="line-2646"></a><span class="hs-comment">-- There's no static check; it's up to the user</span><span>
</span><a name="line-2647"></a><a name="wrapWarnTcS"><a href="TcSMonad.html#wrapWarnTcS"><span class="hs-identifier">wrapWarnTcS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span>
</span><a name="line-2648"></a><span>
</span><a name="line-2649"></a><span class="hs-identifier">failTcS</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">panicTcS</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753602"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2650"></a><span class="hs-identifier">warnTcS</span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2651"></a><span class="hs-identifier">addErrTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2652"></a><a name="failTcS"><a href="TcSMonad.html#failTcS"><span class="hs-identifier">failTcS</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">TcM.failWith</span></a><span>
</span><a name="line-2653"></a><a name="warnTcS"><a href="TcSMonad.html#warnTcS"><span class="hs-identifier">warnTcS</span></a></a><span> </span><a name="local-6989586621682754109"><a href="#local-6989586621682754109"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">TcM.addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621682754109"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span>
</span><a name="line-2654"></a><a name="addErrTcS"><a href="TcSMonad.html#addErrTcS"><span class="hs-identifier">addErrTcS</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">TcM.addErr</span></a><span>
</span><a name="line-2655"></a><a name="panicTcS"><a href="TcSMonad.html#panicTcS"><span class="hs-identifier">panicTcS</span></a></a><span> </span><a name="local-6989586621682754110"><a href="#local-6989586621682754110"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;TcCanonical&quot;</span><span> </span><a href="#local-6989586621682754110"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-2656"></a><span>
</span><a name="line-2657"></a><span class="hs-identifier">traceTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2658"></a><a name="traceTcS"><a href="TcSMonad.html#traceTcS"><span class="hs-identifier">traceTcS</span></a></a><span> </span><a name="local-6989586621682754111"><a href="#local-6989586621682754111"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-6989586621682754112"><a href="#local-6989586621682754112"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">TcM.traceTc</span></a><span> </span><a href="#local-6989586621682754111"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-6989586621682754112"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2659"></a><span>
</span><a name="line-2660"></a><span class="hs-identifier">runTcPluginTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcPluginM</span><span> </span><a href="#local-6989586621682753601"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753601"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2661"></a><a name="runTcPluginTcS"><a href="TcSMonad.html#runTcPluginTcS"><span class="hs-identifier">runTcPluginTcS</span></a></a><span> </span><a name="local-6989586621682754113"><a href="#local-6989586621682754113"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">runTcPluginM</span><span> </span><a href="#local-6989586621682754113"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="TcSMonad.html#getTcEvBindsVar"><span class="hs-identifier hs-var">getTcEvBindsVar</span></a><span>
</span><a name="line-2662"></a><span>
</span><a name="line-2663"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">HasDynFlags</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2664"></a><span>    </span><a name="local-8214565720323804398"><span class="hs-identifier">getDynFlags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-2665"></a><span>
</span><a name="line-2666"></a><span class="hs-identifier">getGlobalRdrEnvTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span>
</span><a name="line-2667"></a><a name="getGlobalRdrEnvTcS"><a href="TcSMonad.html#getGlobalRdrEnvTcS"><span class="hs-identifier">getGlobalRdrEnvTcS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">TcM.getGlobalRdrEnv</span></a><span>
</span><a name="line-2668"></a><span>
</span><a name="line-2669"></a><span class="hs-identifier">bumpStepCountTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2670"></a><a name="bumpStepCountTcS"><a href="TcSMonad.html#bumpStepCountTcS"><span class="hs-identifier">bumpStepCountTcS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682754114"><a href="#local-6989586621682754114"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682754115"><a href="#local-6989586621682754115"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcs_count</span><span> </span><a href="#local-6989586621682754114"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2671"></a><span>                                    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754116"><a href="#local-6989586621682754116"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM.readTcRef</span></a><span> </span><a href="#local-6989586621682754115"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-2672"></a><span>                                    </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">TcM.writeTcRef</span></a><span> </span><a href="#local-6989586621682754115"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754116"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2673"></a><span>
</span><a name="line-2674"></a><span class="hs-identifier">csTraceTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2675"></a><a name="csTraceTcS"><a href="TcSMonad.html#csTraceTcS"><span class="hs-identifier">csTraceTcS</span></a></a><span> </span><a name="local-6989586621682754117"><a href="#local-6989586621682754117"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-2676"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#wrapTcS"><span class="hs-identifier hs-var">wrapTcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcSMonad.html#csTraceTcM"><span class="hs-identifier hs-var">csTraceTcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621682754117"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2677"></a><span>
</span><a name="line-2678"></a><span class="hs-identifier">traceFireTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtEvidence</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2679"></a><span class="hs-comment">-- Dump a rule-firing trace</span><span>
</span><a name="line-2680"></a><a name="traceFireTcS"><a href="TcSMonad.html#traceFireTcS"><span class="hs-identifier">traceFireTcS</span></a></a><span> </span><a name="local-6989586621682754118"><a href="#local-6989586621682754118"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682754119"><a href="#local-6989586621682754119"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-2681"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682754120"><a href="#local-6989586621682754120"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#csTraceTcM"><span class="hs-identifier hs-var">csTraceTcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2682"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754121"><a href="#local-6989586621682754121"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM.readTcRef</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcs_count</span><span> </span><a href="#local-6989586621682754120"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2683"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754122"><a href="#local-6989586621682754122"><span class="hs-identifier">tclvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">TcM.getTcLevel</span></a><span>
</span><a name="line-2684"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Step&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621682754121"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-2685"></a><span>                       </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;l:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682754122"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">comma</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-2686"></a><span>                                    </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;d:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctLocDepth</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ctEvLoc</span><span> </span><a href="#local-6989586621682754118"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2687"></a><span>                       </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621682754119"><span class="hs-identifier hs-var">doc</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-2688"></a><span>                     </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621682754118"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2689"></a><span>
</span><a name="line-2690"></a><span class="hs-identifier">csTraceTcM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2691"></a><span class="hs-comment">-- Constraint-solver tracing, -ddump-cs-trace</span><span>
</span><a name="line-2692"></a><a name="csTraceTcM"><a href="TcSMonad.html#csTraceTcM"><span class="hs-identifier">csTraceTcM</span></a></a><span> </span><a name="local-6989586621682754123"><a href="#local-6989586621682754123"><span class="hs-identifier">mk_doc</span></a></a><span>
</span><a name="line-2693"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754124"><a href="#local-6989586621682754124"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-2694"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span>  </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_cs_trace</span><span> </span><a href="#local-6989586621682754124"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2695"></a><span>                  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_tc_trace</span><span> </span><a href="#local-6989586621682754124"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2696"></a><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754125"><a href="#local-6989586621682754125"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682754123"><span class="hs-identifier hs-var">mk_doc</span></a><span>
</span><a name="line-2697"></a><span>                   </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTcRn"><span class="hs-identifier hs-var">TcM.traceTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_cs_trace</span><span> </span><a href="#local-6989586621682754125"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2698"></a><span>
</span><a name="line-2699"></a><span class="hs-identifier">runTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753600"><span class="hs-identifier hs-type">a</span></a><span>                </span><span class="hs-comment">-- What to run</span><span>
</span><a name="line-2700"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682753600"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">EvBindMap</span><span class="hs-special">)</span><span>
</span><a name="line-2701"></a><a name="runTcS"><a href="TcSMonad.html#runTcS"><span class="hs-identifier">runTcS</span></a></a><span> </span><a name="local-6989586621682754126"><a href="#local-6989586621682754126"><span class="hs-identifier">tcs</span></a></a><span>
</span><a name="line-2702"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754127"><a href="#local-6989586621682754127"><span class="hs-identifier">ev_binds_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">TcM.newTcEvBinds</span></a><span>
</span><a name="line-2703"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754128"><a href="#local-6989586621682754128"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSMonad.html#runTcSWithEvBinds"><span class="hs-identifier hs-var">runTcSWithEvBinds</span></a><span> </span><a href="#local-6989586621682754127"><span class="hs-identifier hs-var">ev_binds_var</span></a><span> </span><a href="#local-6989586621682754126"><span class="hs-identifier hs-var">tcs</span></a><span>
</span><a name="line-2704"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754129"><a href="#local-6989586621682754129"><span class="hs-identifier">ev_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcEvBindsMap"><span class="hs-identifier hs-var">TcM.getTcEvBindsMap</span></a><span> </span><a href="#local-6989586621682754127"><span class="hs-identifier hs-var">ev_binds_var</span></a><span>
</span><a name="line-2705"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754128"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682754129"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2706"></a><span>
</span><a name="line-2707"></a><span class="hs-comment">-- | This variant of 'runTcS' will keep solving, even when only Deriveds</span><span>
</span><a name="line-2708"></a><span class="hs-comment">-- are left around. It also doesn't return any evidence, as callers won't</span><span>
</span><a name="line-2709"></a><span class="hs-comment">-- need it.</span><span>
</span><a name="line-2710"></a><span class="hs-identifier">runTcSDeriveds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753599"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682753599"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2711"></a><a name="runTcSDeriveds"><a href="TcSMonad.html#runTcSDeriveds"><span class="hs-identifier">runTcSDeriveds</span></a></a><span> </span><a name="local-6989586621682754130"><a href="#local-6989586621682754130"><span class="hs-identifier">tcs</span></a></a><span>
</span><a name="line-2712"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754131"><a href="#local-6989586621682754131"><span class="hs-identifier">ev_binds_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">TcM.newTcEvBinds</span></a><span>
</span><a name="line-2713"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#runTcSWithEvBinds"><span class="hs-identifier hs-var">runTcSWithEvBinds</span></a><span> </span><a href="#local-6989586621682754131"><span class="hs-identifier hs-var">ev_binds_var</span></a><span> </span><a href="#local-6989586621682754130"><span class="hs-identifier hs-var">tcs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2714"></a><span>
</span><a name="line-2715"></a><span class="hs-comment">-- | This can deal only with equality constraints.</span><span>
</span><a name="line-2716"></a><span class="hs-identifier">runTcSEqualities</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753598"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682753598"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2717"></a><a name="runTcSEqualities"><a href="TcSMonad.html#runTcSEqualities"><span class="hs-identifier">runTcSEqualities</span></a></a><span> </span><a name="local-6989586621682754132"><a href="#local-6989586621682754132"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-2718"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754133"><a href="#local-6989586621682754133"><span class="hs-identifier">ev_binds_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newNoTcEvBinds"><span class="hs-identifier hs-var">TcM.newNoTcEvBinds</span></a><span>
</span><a name="line-2719"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#runTcSWithEvBinds"><span class="hs-identifier hs-var">runTcSWithEvBinds</span></a><span> </span><a href="#local-6989586621682754133"><span class="hs-identifier hs-var">ev_binds_var</span></a><span> </span><a href="#local-6989586621682754132"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2720"></a><span>
</span><a name="line-2721"></a><span class="hs-identifier">runTcSWithEvBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span>
</span><a name="line-2722"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753597"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2723"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621682753597"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2724"></a><a name="runTcSWithEvBinds"><a href="TcSMonad.html#runTcSWithEvBinds"><span class="hs-identifier">runTcSWithEvBinds</span></a></a><span> </span><a name="local-6989586621682754134"><a href="#local-6989586621682754134"><span class="hs-identifier">ev_binds_var</span></a></a><span> </span><a name="local-6989586621682754135"><a href="#local-6989586621682754135"><span class="hs-identifier">tcs</span></a></a><span>
</span><a name="line-2725"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754136"><a href="#local-6989586621682754136"><span class="hs-identifier">unified_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">TcM.newTcRef</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2726"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754137"><a href="#local-6989586621682754137"><span class="hs-identifier">step_count</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">TcM.newTcRef</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2727"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754138"><a href="#local-6989586621682754138"><span class="hs-identifier">inert_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">TcM.newTcRef</span></a><span> </span><a href="TcSMonad.html#emptyInert"><span class="hs-identifier hs-var">emptyInert</span></a><span>
</span><a name="line-2728"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754139"><a href="#local-6989586621682754139"><span class="hs-identifier">wl_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">TcM.newTcRef</span></a><span> </span><a href="TcSMonad.html#emptyWorkList"><span class="hs-identifier hs-var">emptyWorkList</span></a><span>
</span><a name="line-2729"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682754140"><a href="#local-6989586621682754140"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcSEnv"><span class="hs-identifier hs-var">TcSEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcs_ev_binds</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754134"><span class="hs-identifier hs-var">ev_binds_var</span></a><span>
</span><a name="line-2730"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_unified</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754136"><span class="hs-identifier hs-var">unified_var</span></a><span>
</span><a name="line-2731"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_count</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754137"><span class="hs-identifier hs-var">step_count</span></a><span>
</span><a name="line-2732"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_inerts</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754138"><span class="hs-identifier hs-var">inert_var</span></a><span>
</span><a name="line-2733"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_worklist</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754139"><span class="hs-identifier hs-var">wl_var</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2734"></a><span>
</span><a name="line-2735"></a><span>             </span><span class="hs-comment">-- Run the computation</span><span>
</span><a name="line-2736"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754141"><a href="#local-6989586621682754141"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">unTcS</span><span> </span><a href="#local-6989586621682754135"><span class="hs-identifier hs-var">tcs</span></a><span> </span><a href="#local-6989586621682754140"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2737"></a><span>
</span><a name="line-2738"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754142"><a href="#local-6989586621682754142"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM.readTcRef</span></a><span> </span><a href="#local-6989586621682754137"><span class="hs-identifier hs-var">step_count</span></a><span>
</span><a name="line-2739"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754142"><span class="hs-identifier hs-var">count</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2740"></a><span>         </span><a href="TcSMonad.html#csTraceTcM"><span class="hs-identifier hs-var">csTraceTcM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Constraint solver steps =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">int</span><span> </span><a href="#local-6989586621682754142"><span class="hs-identifier hs-var">count</span></a><span class="hs-special">)</span><span>
</span><a name="line-2741"></a><span>
</span><a name="line-2742"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#unflattenGivens"><span class="hs-identifier hs-var">unflattenGivens</span></a><span> </span><a href="#local-6989586621682754138"><span class="hs-identifier hs-var">inert_var</span></a><span>
</span><a name="line-2743"></a><span>
</span><a name="line-2744"></a><span class="hs-cpp">#if defined(DEBUG)
</span><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ev_binds</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">TcM.getTcEvBindsMap</span><span> </span><span class="hs-identifier">ev_binds_var</span><span>
</span><a name="line-2746"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">checkForCyclicBinds</span><span> </span><span class="hs-identifier">ev_binds</span><span>
</span><a name="line-2747"></a><span class="hs-cpp">#endif
</span><span class="">
       ; return res }

----------------------------
</span><span class="hs-cpp">#if defined(DEBUG)
</span><span class="hs-identifier">checkForCyclicBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">EvBindMap</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2754"></a><span class="hs-identifier">checkForCyclicBinds</span><span> </span><span class="hs-identifier">ev_binds_map</span><span>
</span><a name="line-2755"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">cycles</span><span>
</span><a name="line-2756"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2757"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">coercion_cycles</span><span>
</span><a name="line-2758"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">TcM.traceTc</span><span> </span><span class="hs-string">&quot;Cycle in evidence binds&quot;</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">cycles</span><span>
</span><a name="line-2759"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>
</span><a name="line-2760"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pprPanic</span><span> </span><span class="hs-string">&quot;Cycle in coercion bindings&quot;</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">coercion_cycles</span><span>
</span><a name="line-2761"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2762"></a><span>    </span><span class="hs-identifier">ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">evBindMapBinds</span><span> </span><span class="hs-identifier">ev_binds_map</span><span>
</span><a name="line-2763"></a><span>
</span><a name="line-2764"></a><span>    </span><span class="hs-identifier">cycles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier">EvBind</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-2765"></a><span>    </span><span class="hs-identifier">cycles</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">CyclicSCC</span><span> </span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">stronglyConnCompFromEdgedVerticesUniq</span><span> </span><span class="hs-identifier">edges</span><span class="hs-special">]</span><span>
</span><a name="line-2766"></a><span>
</span><a name="line-2767"></a><span>    </span><span class="hs-identifier">coercion_cycles</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">c</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">cycles</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">any</span><span> </span><span class="hs-identifier">is_co_bind</span><span> </span><span class="hs-identifier">c</span><span class="hs-special">]</span><span>
</span><a name="line-2768"></a><span>    </span><span class="hs-identifier">is_co_bind</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">EvBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eb_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">isEqPred</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span>
</span><a name="line-2769"></a><span>
</span><a name="line-2770"></a><span>    </span><span class="hs-identifier">edges</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">Node</span><span> </span><span class="hs-identifier">EvVar</span><span> </span><span class="hs-identifier">EvBind</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2771"></a><span>    </span><span class="hs-identifier">edges</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">DigraphNode</span><span> </span><span class="hs-identifier">bind</span><span> </span><span class="hs-identifier">bndr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nonDetEltsUniqSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">evVarsOfTerm</span><span> </span><span class="hs-identifier">rhs</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2772"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">bind</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">EvBind</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eb_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">bndr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">eb_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rhs</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">bagToList</span><span> </span><span class="hs-identifier">ev_binds</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2773"></a><span>            </span><span class="hs-comment">-- It's OK to use nonDetEltsUFM here as</span><span>
</span><a name="line-2774"></a><span>            </span><span class="hs-comment">-- stronglyConnCompFromEdgedVertices is still deterministic even</span><span>
</span><a name="line-2775"></a><span>            </span><span class="hs-comment">-- if the edges are in nondeterministic order as explained in</span><span>
</span><a name="line-2776"></a><span>            </span><span class="hs-comment">-- Note [Deterministic SCC] in Digraph.</span><span>
</span><a name="line-2777"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-2779"></a><span class="hs-comment">----------------------------</span><span>
</span><a name="line-2780"></a><span class="hs-identifier">setEvBindsTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753596"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753596"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2781"></a><a name="setEvBindsTcS"><a href="TcSMonad.html#setEvBindsTcS"><span class="hs-identifier">setEvBindsTcS</span></a></a><span> </span><a name="local-6989586621682754143"><a href="#local-6989586621682754143"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><a name="local-6989586621682754144"><a href="#local-6989586621682754144"><span class="hs-identifier">thing_inside</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2782"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682754145"><a href="#local-6989586621682754145"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682754144"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682754145"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcs_ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754143"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2783"></a><span>
</span><a name="line-2784"></a><span class="hs-identifier">nestImplicTcS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">EvBindsVar</span><span>
</span><a name="line-2785"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcLevel</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753595"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2786"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-type">TcS</span></a><span> </span><a href="#local-6989586621682753595"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2787"></a><a name="nestImplicTcS"><a href="TcSMonad.html#nestImplicTcS"><span class="hs-identifier">nestImplicTcS</span></a></a><span> </span><a name="local-6989586621682754146"><a href="#local-6989586621682754146"><span class="hs-identifier">ref</span></a></a><span> </span><a name="local-6989586621682754147"><a href="#local-6989586621682754147"><span class="hs-identifier">inner_tclvl</span></a></a><span> </span><span class="hs-special">(</span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><a name="local-6989586621682754148"><a href="#local-6989586621682754148"><span class="hs-identifier">thing_inside</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2788"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcS"><span class="hs-identifier hs-var">TcS</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a href="TcSMonad.html#TcSEnv"><span class="hs-identifier hs-var">TcSEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcs_unified</span><span>       </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754149"><a href="#local-6989586621682754149"><span class="hs-identifier">unified_var</span></a></a><span>
</span><a name="line-2789"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_inerts</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754150"><a href="#local-6989586621682754150"><span class="hs-identifier">old_inert_var</span></a></a><span>
</span><a name="line-2790"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_count</span><span>         </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682754151"><a href="#local-6989586621682754151"><span class="hs-identifier">count</span></a></a><span>
</span><a name="line-2791"></a><span>                   </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2792"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682754152"><a href="#local-6989586621682754152"><span class="hs-identifier">inerts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">TcM.readTcRef</span></a><span> </span><a href="#local-6989586621682754150"><span class="hs-identifier hs-var">old_inert_var</span></a><span>
</span><a name="line-2793"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682754153"><a href="#local-6989586621682754153"><span class="hs-identifier">nest_inert</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#emptyInert"><span class="hs-identifier hs-var">emptyInert</span></a><span>
</span><a name="line-2794"></a><span>                            </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inert_cans</span><span> </span><a href="#local-6989586621682754152"><span class="hs-identifier hs-var">inerts</span></a><span>
</span><a name="line-2795"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">inert_solved_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">inert_solved_dicts</span><span> </span><a href="#local-6989586621682754152"><span class="hs-identifier hs-var">inerts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2796"></a><span>                              </span><span class="hs-comment">-- See Note [Do not inherit the flat cache]</span><span>
</span><a name="line-2797"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754154"><a href="#local-6989586621682754154"><span class="hs-identifier">new_inert_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">TcM.newTcRef</span></a><span> </span><a href="#local-6989586621682754153"><span class="hs-identifier hs-var">nest_inert</span></a><span>
</span><a name="line-2798"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754155"><a href="#local-6989586621682754155"><span class="hs-identifier">new_wl_var</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcRef"><span class="hs-identifier hs-var">TcM.newTcRef</span></a><span> </span><a href="TcSMonad.html#emptyWorkList"><span class="hs-identifier hs-var">emptyWorkList</span></a><span>
</span><a name="line-2799"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682754156"><a href="#local-6989586621682754156"><span class="hs-identifier">nest_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcSMonad.html#TcSEnv"><span class="hs-identifier hs-var">TcSEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcs_ev_binds</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754146"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-2800"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_unified</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754149"><span class="hs-identifier hs-var">unified_var</span></a><span>
</span><a name="line-2801"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_count</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754151"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-2802"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_inerts</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754154"><span class="hs-identifier hs-var">new_inert_var</span></a><span>
</span><a name="line-2803"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcs_worklist</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682754155"><span class="hs-identifier hs-var">new_wl_var</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2804"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682754157"><a href="#local-6989586621682754157"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setTcLevel"><span class="hs-identifier hs-var">TcM.setTcLevel</span></a><span> </span><a href="#local-6989586621682754147"><span class="hs-identifier hs-var">inner_tclvl</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2805"></a><span>                </span><a href="#local-6989586621682754148"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621682754156"><span class="hs-identifier hs-var">nest_env</span></a><span>
</span><a name="line-2806"></a><span>
</span><a name="line-2807"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcSMonad.html#unflattenGivens"><span class="hs-identifier hs-var">unflattenGivens</span></a><span> </span><a href="#local-6989586621682754154"><span class="hs-identifier hs-var">new_inert_var</span></a><span>
</span><a name="line-2808"></a><span>
</span><a name="line-2809"></a><span class="hs-cpp">#if defined(DEBUG)
</span><span>       </span><span class="hs-comment">-- Perform a check that the thing_inside did not cause cycles</span><span>
</span><a name="line-2811"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ev_binds</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">TcM.getTcEvBindsMap</span><span> </span><span class="hs-identifier">ref</span><span>
</span><a name="line-2812"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">checkForCyclicBinds</span><span> </span><span class="hs-identifier">ev_binds</span><span>
</span><a name="line-2813"></a><span class="hs-cpp">#endif
</span><span class="">       ; return res }

{- Note [Do not inherit the flat cache]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do not want to inherit the flat cache when processing nested
implications.  Consider
   a ~ F b, forall c. b~Int =&gt; blah
If we have F b ~ fsk in the flat-cache, and we push that into the
nested implication, we might miss that F b can be rewritten to F Int,
and hence perhpas solve it.  Moreover, the fsk from outside is
flattened out after solving the outer level, but and we don't
do that flattening recursively.
-}

nestTcS ::  TcS a -&gt; TcS a
-- Use the current untouchables, augmenting the current
-- evidence bindings, and solved dictionaries
-- But have no effect on the InertCans, or on the inert_flat_cache
-- (we want to inherit the latter from processing the Givens)
nestTcS (TcS thing_inside)
  = TcS $ \ env@(TcSEnv { tcs_inerts = inerts_var }) -&gt;
    do { inerts &lt;- TcM.readTcRef inerts_var
       ; new_inert_var &lt;- TcM.newTcRef inerts
       ; new_wl_var    &lt;- TcM.newTcRef emptyWorkList
       ; let nest_env = env { tcs_inerts   = new_inert_var
                            , tcs_worklist = new_wl_var }

       ; res &lt;- thing_inside nest_env

       ; new_inerts &lt;- TcM.readTcRef new_inert_var

       -- we want to propogate the safe haskell failures
       ; let old_ic = inert_cans inerts
             new_ic = inert_cans new_inerts
             nxt_ic = old_ic { inert_safehask = inert_safehask new_ic }

       ; TcM.writeTcRef inerts_var  -- See Note [Propagate the solved dictionaries]
                        (inerts { inert_solved_dicts = inert_solved_dicts new_inerts
                                , inert_cans = nxt_ic })

       ; return res }

checkTvConstraintsTcS :: SkolemInfo
                      -&gt; [TcTyVar]        -- Skolems
                      -&gt; TcS (result, Cts)
                      -&gt; TcS result
-- Just like TcUnify.checkTvConstraints, but
--   - In the TcS monnad
--   - The thing-inside should not put things in the work-list
--     Instead, it returns the Wanted constraints it needs
--   - No 'givens', and no TcEvBinds; this is type-level constraints only
checkTvConstraintsTcS skol_info skol_tvs (TcS thing_inside)
  = TcS $ \ tcs_env -&gt;
    do { let wl_panic  = pprPanic &quot;TcSMonad.buildImplication&quot; $
                         ppr skol_info $$ ppr skol_tvs
                         -- This panic checks that the thing-inside
                         -- does not emit any work-list constraints
             new_tcs_env = tcs_env { tcs_worklist = wl_panic }

       ; (new_tclvl, (res, wanteds)) &lt;- TcM.pushTcLevelM $
                                        thing_inside new_tcs_env

       ; unless (null wanteds) $
         do { ev_binds_var &lt;- TcM.newNoTcEvBinds
            ; imp &lt;- newImplication
            ; let wc = emptyWC { wc_simple = wanteds }
                  imp' = imp { ic_tclvl  = new_tclvl
                             , ic_skols  = skol_tvs
                             , ic_wanted = wc
                             , ic_binds  = ev_binds_var
                             , ic_info   = skol_info }

           -- Add the implication to the work-list
           ; TcM.updTcRef (tcs_worklist tcs_env)
                          (extendWorkListImplic (unitBag imp')) }

      ; return res }

checkConstraintsTcS :: SkolemInfo
                    -&gt; [TcTyVar]        -- Skolems
                    -&gt; [EvVar]          -- Givens
                    -&gt; TcS (result, Cts)
                    -&gt; TcS (result, TcEvBinds)
-- Just like checkConstraintsTcS, but
--   - In the TcS monnad
--   - The thing-inside should not put things in the work-list
--     Instead, it returns the Wanted constraints it needs
--   - I did not bother to put in the fast-path for
--     empty-skols/empty-givens, or for empty-wanteds, because
--     this function is used only for &quot;quantified constraints&quot; in
--     with both tests are pretty much guaranteed to fail
checkConstraintsTcS skol_info skol_tvs given (TcS thing_inside)
  = TcS $ \ tcs_env -&gt;
    do { let wl_panic  = pprPanic &quot;TcSMonad.buildImplication&quot; $
                         ppr skol_info $$ ppr skol_tvs
                         -- This panic checks that the thing-inside
                         -- does not emit any work-list constraints
             new_tcs_env = tcs_env { tcs_worklist = wl_panic }

       ; (new_tclvl, (res, wanteds)) &lt;- TcM.pushTcLevelM $
                                        thing_inside new_tcs_env

       ; ev_binds_var &lt;- TcM.newTcEvBinds
       ; imp &lt;- newImplication
       ; let wc = emptyWC { wc_simple = wanteds }
             imp' = imp { ic_tclvl  = new_tclvl
                        , ic_skols  = skol_tvs
                        , ic_given  = given
                        , ic_wanted = wc
                        , ic_binds  = ev_binds_var
                        , ic_info   = skol_info }

           -- Add the implication to the work-list
       ; TcM.updTcRef (tcs_worklist tcs_env)
                      (extendWorkListImplic (unitBag imp'))

       ; return (res, TcEvBinds ev_binds_var) }

{-
Note [Propagate the solved dictionaries]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's really quite important that nestTcS does not discard the solved
dictionaries from the thing_inside.
Consider
   Eq [a]
   forall b. empty =&gt;  Eq [a]
We solve the simple (Eq [a]), under nestTcS, and then turn our attention to
the implications.  It's definitely fine to use the solved dictionaries on
the inner implications, and it can make a signficant performance difference
if you do so.
-}

-- Getters and setters of TcEnv fields
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-- Getter of inerts and worklist
getTcSInertsRef :: TcS (IORef InertSet)
getTcSInertsRef = TcS (return . tcs_inerts)

getTcSWorkListRef :: TcS (IORef WorkList)
getTcSWorkListRef = TcS (return . tcs_worklist)

getTcSInerts :: TcS InertSet
getTcSInerts = getTcSInertsRef &gt;&gt;= readTcRef

setTcSInerts :: InertSet -&gt; TcS ()
setTcSInerts ics = do { r &lt;- getTcSInertsRef; writeTcRef r ics }

getWorkListImplics :: TcS (Bag Implication)
getWorkListImplics
  = do { wl_var &lt;- getTcSWorkListRef
       ; wl_curr &lt;- readTcRef wl_var
       ; return (wl_implics wl_curr) }

updWorkListTcS :: (WorkList -&gt; WorkList) -&gt; TcS ()
updWorkListTcS f
  = do { wl_var &lt;- getTcSWorkListRef
       ; updTcRef wl_var f }

emitWorkNC :: [CtEvidence] -&gt; TcS ()
emitWorkNC evs
  | null evs
  = return ()
  | otherwise
  = emitWork (map mkNonCanonical evs)

emitWork :: [Ct] -&gt; TcS ()
emitWork cts
  = do { traceTcS &quot;Emitting fresh work&quot; (vcat (map ppr cts))
       ; updWorkListTcS (extendWorkListCts cts) }

newTcRef :: a -&gt; TcS (TcRef a)
newTcRef x = wrapTcS (TcM.newTcRef x)

readTcRef :: TcRef a -&gt; TcS a
readTcRef ref = wrapTcS (TcM.readTcRef ref)

writeTcRef :: TcRef a -&gt; a -&gt; TcS ()
writeTcRef ref val = wrapTcS (TcM.writeTcRef ref val)

updTcRef :: TcRef a -&gt; (a-&gt;a) -&gt; TcS ()
updTcRef ref upd_fn = wrapTcS (TcM.updTcRef ref upd_fn)

getTcEvBindsVar :: TcS EvBindsVar
getTcEvBindsVar = TcS (return . tcs_ev_binds)

getTcLevel :: TcS TcLevel
getTcLevel = wrapTcS TcM.getTcLevel

getTcEvTyCoVars :: EvBindsVar -&gt; TcS TyCoVarSet
getTcEvTyCoVars ev_binds_var
  = wrapTcS $ TcM.getTcEvTyCoVars ev_binds_var

getTcEvBindsMap :: EvBindsVar -&gt; TcS EvBindMap
getTcEvBindsMap ev_binds_var
  = wrapTcS $ TcM.getTcEvBindsMap ev_binds_var

setTcEvBindsMap :: EvBindsVar -&gt; EvBindMap -&gt; TcS ()
setTcEvBindsMap ev_binds_var binds
  = wrapTcS $ TcM.setTcEvBindsMap ev_binds_var binds

unifyTyVar :: TcTyVar -&gt; TcType -&gt; TcS ()
-- Unify a meta-tyvar with a type
-- We keep track of how many unifications have happened in tcs_unified,
--
-- We should never unify the same variable twice!
unifyTyVar tv ty
  = ASSERT2( isMetaTyVar tv, ppr tv )
    TcS $ \ env -&gt;
    do { TcM.traceTc &quot;unifyTyVar&quot; (ppr tv &lt;+&gt; text &quot;:=&quot; &lt;+&gt; ppr ty)
       ; TcM.writeMetaTyVar tv ty
       ; TcM.updTcRef (tcs_unified env) (+1) }

reportUnifications :: TcS a -&gt; TcS (Int, a)
reportUnifications (TcS thing_inside)
  = TcS $ \ env -&gt;
    do { inner_unified &lt;- TcM.newTcRef 0
       ; res &lt;- thing_inside (env { tcs_unified = inner_unified })
       ; n_unifs &lt;- TcM.readTcRef inner_unified
       ; TcM.updTcRef (tcs_unified env) (+ n_unifs)
       ; return (n_unifs, res) }

getDefaultInfo ::  TcS ([Type], (Bool, Bool))
getDefaultInfo = wrapTcS TcM.tcGetDefaultTys

-- Just get some environments needed for instance looking up and matching
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

getInstEnvs :: TcS InstEnvs
getInstEnvs = wrapTcS $ TcM.tcGetInstEnvs

getFamInstEnvs :: TcS (FamInstEnv, FamInstEnv)
getFamInstEnvs = wrapTcS $ FamInst.tcGetFamInstEnvs

getTopEnv :: TcS HscEnv
getTopEnv = wrapTcS $ TcM.getTopEnv

getGblEnv :: TcS TcGblEnv
getGblEnv = wrapTcS $ TcM.getGblEnv

getLclEnv :: TcS TcLclEnv
getLclEnv = wrapTcS $ TcM.getLclEnv

tcLookupClass :: Name -&gt; TcS Class
tcLookupClass c = wrapTcS $ TcM.tcLookupClass c

tcLookupId :: Name -&gt; TcS Id
tcLookupId n = wrapTcS $ TcM.tcLookupId n

-- Setting names as used (used in the deriving of Coercible evidence)
-- Too hackish to expose it to TcS? In that case somehow extract the used
-- constructors from the result of solveInteract
addUsedGREs :: [GlobalRdrElt] -&gt; TcS ()
addUsedGREs gres = wrapTcS  $ TcM.addUsedGREs gres

addUsedGRE :: Bool -&gt; GlobalRdrElt -&gt; TcS ()
addUsedGRE warn_if_deprec gre = wrapTcS $ TcM.addUsedGRE warn_if_deprec gre


-- Various smaller utilities [TODO, maybe will be absorbed in the instance matcher]
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

checkWellStagedDFun :: CtLoc -&gt; InstanceWhat -&gt; PredType -&gt; TcS ()
-- Check that we do not try to use an instance before it is available.  E.g.
--    instance Eq T where ...
--    f x = $( ... (\(p::T) -&gt; p == p)... )
-- Here we can't use the equality function from the instance in the splice

checkWellStagedDFun loc what pred
  | TopLevInstance { iw_dfun_id = dfun_id } &lt;- what
  , let bind_lvl = TcM.topIdLvl dfun_id
  , bind_lvl &gt; impLevel
  = wrapTcS $ TcM.setCtLocM loc $
    do { use_stage &lt;- TcM.getStage
       ; TcM.checkWellStaged pp_thing bind_lvl (thLevel use_stage) }

  | otherwise
  = return ()    -- Fast path for common case
  where
    pp_thing = text &quot;instance for&quot; &lt;+&gt; quotes (ppr pred)

pprEq :: TcType -&gt; TcType -&gt; SDoc
pprEq ty1 ty2 = pprParendType ty1 &lt;+&gt; char '~' &lt;+&gt; pprParendType ty2

isFilledMetaTyVar_maybe :: TcTyVar -&gt; TcS (Maybe Type)
isFilledMetaTyVar_maybe tv = wrapTcS (TcM.isFilledMetaTyVar_maybe tv)

isFilledMetaTyVar :: TcTyVar -&gt; TcS Bool
isFilledMetaTyVar tv = wrapTcS (TcM.isFilledMetaTyVar tv)

zonkTyCoVarsAndFV :: TcTyCoVarSet -&gt; TcS TcTyCoVarSet
zonkTyCoVarsAndFV tvs = wrapTcS (TcM.zonkTyCoVarsAndFV tvs)

zonkTyCoVarsAndFVList :: [TcTyCoVar] -&gt; TcS [TcTyCoVar]
zonkTyCoVarsAndFVList tvs = wrapTcS (TcM.zonkTyCoVarsAndFVList tvs)

zonkCo :: Coercion -&gt; TcS Coercion
zonkCo = wrapTcS . TcM.zonkCo

zonkTcType :: TcType -&gt; TcS TcType
zonkTcType ty = wrapTcS (TcM.zonkTcType ty)

zonkTcTypes :: [TcType] -&gt; TcS [TcType]
zonkTcTypes tys = wrapTcS (TcM.zonkTcTypes tys)

zonkTcTyVar :: TcTyVar -&gt; TcS TcType
zonkTcTyVar tv = wrapTcS (TcM.zonkTcTyVar tv)

zonkSimples :: Cts -&gt; TcS Cts
zonkSimples cts = wrapTcS (TcM.zonkSimples cts)

zonkWC :: WantedConstraints -&gt; TcS WantedConstraints
zonkWC wc = wrapTcS (TcM.zonkWC wc)

zonkTyCoVarKind :: TcTyCoVar -&gt; TcS TcTyCoVar
zonkTyCoVarKind tv = wrapTcS (TcM.zonkTyCoVarKind tv)

{- *********************************************************************
*                                                                      *
*                Flatten skolems                                       *
*                                                                      *
********************************************************************* -}

newFlattenSkolem :: CtFlavour -&gt; CtLoc
                 -&gt; TyCon -&gt; [TcType]                    -- F xis
                 -&gt; TcS (CtEvidence, Coercion, TcTyVar)  -- [G/WD] x:: F xis ~ fsk
newFlattenSkolem flav loc tc xis
  = do { stuff@(ev, co, fsk) &lt;- new_skolem
       ; let fsk_ty = mkTyVarTy fsk
       ; extendFlatCache tc xis (co, fsk_ty, ctEvFlavour ev)
       ; return stuff }
  where
    fam_ty = mkTyConApp tc xis

    new_skolem
      | Given &lt;- flav
      = do { fsk &lt;- wrapTcS (TcM.newFskTyVar fam_ty)

           -- Extend the inert_fsks list, for use by unflattenGivens
           ; updInertTcS $ \is -&gt; is { inert_fsks = (fsk, fam_ty) : inert_fsks is }

           -- Construct the Refl evidence
           ; let pred = mkPrimEqPred fam_ty (mkTyVarTy fsk)
                 co   = mkNomReflCo fam_ty
           ; ev  &lt;- newGivenEvVar loc (pred, evCoercion co)
           ; return (ev, co, fsk) }

      | otherwise  -- Generate a [WD] for both Wanted and Derived
                   -- See Note [No Derived CFunEqCans]
      = do { fmv &lt;- wrapTcS (TcM.newFmvTyVar fam_ty)
           ; (ev, hole_co) &lt;- newWantedEq loc Nominal fam_ty (mkTyVarTy fmv)
           ; return (ev, hole_co, fmv) }

----------------------------
unflattenGivens :: IORef InertSet -&gt; TcM ()
-- Unflatten all the fsks created by flattening types in Given
-- constraints. We must be sure to do this, else we end up with
-- flatten-skolems buried in any residual Wanteds
--
-- NB: this is the /only/ way that a fsk (MetaDetails = FlatSkolTv)
--     is filled in. Nothing else does so.
--
-- It's here (rather than in TcFlatten) because the Right Places
-- to call it are in runTcSWithEvBinds/nestImplicTcS, where it
-- is nicely paired with the creation an empty inert_fsks list.
unflattenGivens inert_var
 = do { inerts &lt;- TcM.readTcRef inert_var
       ; TcM.traceTc &quot;unflattenGivens&quot; (ppr (inert_fsks inerts))
       ; mapM_ flatten_one (inert_fsks inerts) }
  where
    flatten_one (fsk, ty) = TcM.writeMetaTyVar fsk ty

----------------------------
extendFlatCache :: TyCon -&gt; [Type] -&gt; (TcCoercion, TcType, CtFlavour) -&gt; TcS ()
extendFlatCache tc xi_args stuff@(_, ty, fl)
  | isGivenOrWDeriv fl  -- Maintain the invariant that inert_flat_cache
                        -- only has [G] and [WD] CFunEqCans
  = do { dflags &lt;- getDynFlags
       ; when (gopt Opt_FlatCache dflags) $
    do { traceTcS &quot;extendFlatCache&quot; (vcat [ ppr tc &lt;+&gt; ppr xi_args
                                          , ppr fl, ppr ty ])
            -- 'co' can be bottom, in the case of derived items
       ; updInertTcS $ \ is@(IS { inert_flat_cache = fc }) -&gt;
            is { inert_flat_cache = insertExactFunEq fc tc xi_args stuff } } }

  | otherwise
  = return ()

----------------------------
unflattenFmv :: TcTyVar -&gt; TcType -&gt; TcS ()
-- Fill a flatten-meta-var, simply by unifying it.
-- This does NOT count as a unification in tcs_unified.
unflattenFmv tv ty
  = ASSERT2( isMetaTyVar tv, ppr tv )
    TcS $ \ _ -&gt;
    do { TcM.traceTc &quot;unflattenFmv&quot; (ppr tv &lt;+&gt; text &quot;:=&quot; &lt;+&gt; ppr ty)
       ; TcM.writeMetaTyVar tv ty }

----------------------------
demoteUnfilledFmv :: TcTyVar -&gt; TcS ()
-- If a flatten-meta-var is still un-filled,
-- turn it into an ordinary meta-var
demoteUnfilledFmv fmv
  = wrapTcS $ do { is_filled &lt;- TcM.isFilledMetaTyVar fmv
                 ; unless is_filled $
                   do { tv_ty &lt;- TcM.newFlexiTyVarTy (tyVarKind fmv)
                      ; TcM.writeMetaTyVar fmv tv_ty } }

-----------------------------
dischargeFunEq :: CtEvidence -&gt; TcTyVar -&gt; TcCoercion -&gt; TcType -&gt; TcS ()
-- (dischargeFunEq tv co ty)
--     Preconditions
--       - ev :: F tys ~ tv   is a CFunEqCan
--       - tv is a FlatMetaTv of FlatSkolTv
--       - co :: F tys ~ xi
--       - fmv/fsk `notElem` xi
--       - fmv not filled (for Wanteds)
--
-- Then for [W] or [WD], we actually fill in the fmv:
--      set fmv := xi,
--      set ev  := co
--      kick out any inert things that are now rewritable
--
-- For [D], we instead emit an equality that must ultimately hold
--      [D] xi ~ fmv
--      Does not evaluate 'co' if 'ev' is Derived
--
-- For [G], emit this equality
--     [G] (sym ev; co) :: fsk ~ xi

-- See TcFlatten Note [The flattening story],
-- especially &quot;Ownership of fsk/fmv&quot;
dischargeFunEq (CtGiven { ctev_evar = old_evar, ctev_loc = loc }) fsk co xi
  = do { new_ev &lt;- newGivenEvVar loc ( new_pred, evCoercion new_co  )
       ; emitWorkNC [new_ev] }
  where
    new_pred = mkPrimEqPred (mkTyVarTy fsk) xi
    new_co   = mkTcSymCo (mkTcCoVarCo old_evar) `mkTcTransCo` co

dischargeFunEq ev@(CtWanted { ctev_dest = dest }) fmv co xi
  = ASSERT2( not (fmv `elemVarSet` tyCoVarsOfType xi), ppr ev $$ ppr fmv $$ ppr xi )
    do { setWantedEvTerm dest (evCoercion co)
       ; unflattenFmv fmv xi
       ; n_kicked &lt;- kickOutAfterUnification fmv
       ; traceTcS &quot;dischargeFmv&quot; (ppr fmv &lt;+&gt; equals &lt;+&gt; ppr xi $$ pprKicked n_kicked) }

dischargeFunEq (CtDerived { ctev_loc = loc }) fmv _co xi
  = emitNewDerivedEq loc Nominal xi (mkTyVarTy fmv)
              -- FunEqs are always at Nominal role

pprKicked :: Int -&gt; SDoc
pprKicked 0 = empty
pprKicked n = parens (int n &lt;+&gt; text &quot;kicked out&quot;)

{- *********************************************************************
*                                                                      *
*                Instantiation etc.
*                                                                      *
********************************************************************* -}

-- Instantiations
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

instDFunType :: DFunId -&gt; [DFunInstType] -&gt; TcS ([TcType], TcThetaType)
instDFunType dfun_id inst_tys
  = wrapTcS $ TcM.instDFunType dfun_id inst_tys

newFlexiTcSTy :: Kind -&gt; TcS TcType
newFlexiTcSTy knd = wrapTcS (TcM.newFlexiTyVarTy knd)

cloneMetaTyVar :: TcTyVar -&gt; TcS TcTyVar
cloneMetaTyVar tv = wrapTcS (TcM.cloneMetaTyVar tv)

instFlexi :: [TKVar] -&gt; TcS TCvSubst
instFlexi = instFlexiX emptyTCvSubst

instFlexiX :: TCvSubst -&gt; [TKVar] -&gt; TcS TCvSubst
instFlexiX subst tvs
  = wrapTcS (foldlM instFlexiHelper subst tvs)

instFlexiHelper :: TCvSubst -&gt; TKVar -&gt; TcM TCvSubst
instFlexiHelper subst tv
  = do { uniq &lt;- TcM.newUnique
       ; details &lt;- TcM.newMetaDetails TauTv
       ; let name = setNameUnique (tyVarName tv) uniq
             kind = substTyUnchecked subst (tyVarKind tv)
             ty'  = mkTyVarTy (mkTcTyVar name kind details)
       ; TcM.traceTc &quot;instFlexi&quot; (ppr ty')
       ; return (extendTvSubst subst tv ty') }

matchGlobalInst :: DynFlags
                -&gt; Bool      -- True &lt;=&gt; caller is the short-cut solver
                             -- See Note [Shortcut solving: overlap]
                -&gt; Class -&gt; [Type] -&gt; TcS TcM.ClsInstResult
matchGlobalInst dflags short_cut cls tys
  = wrapTcS (TcM.matchGlobalInst dflags short_cut cls tys)

tcInstSkolTyVarsX :: TCvSubst -&gt; [TyVar] -&gt; TcS (TCvSubst, [TcTyVar])
tcInstSkolTyVarsX subst tvs = wrapTcS $ TcM.tcInstSkolTyVarsX subst tvs

-- Creating and setting evidence variables and CtFlavors
-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data MaybeNew = Fresh CtEvidence | Cached EvExpr

isFresh :: MaybeNew -&gt; Bool
isFresh (Fresh {})  = True
isFresh (Cached {}) = False

freshGoals :: [MaybeNew] -&gt; [CtEvidence]
freshGoals mns = [ ctev | Fresh ctev &lt;- mns ]

getEvExpr :: MaybeNew -&gt; EvExpr
getEvExpr (Fresh ctev) = ctEvExpr ctev
getEvExpr (Cached evt) = evt

setEvBind :: EvBind -&gt; TcS ()
setEvBind ev_bind
  = do { evb &lt;- getTcEvBindsVar
       ; wrapTcS $ TcM.addTcEvBind evb ev_bind }

-- | Mark variables as used filling a coercion hole
useVars :: CoVarSet -&gt; TcS ()
useVars co_vars
  = do { ev_binds_var &lt;- getTcEvBindsVar
       ; let ref = ebv_tcvs ev_binds_var
       ; wrapTcS $
         do { tcvs &lt;- TcM.readTcRef ref
            ; let tcvs' = tcvs `unionVarSet` co_vars
            ; TcM.writeTcRef ref tcvs' } }

-- | Equalities only
setWantedEq :: TcEvDest -&gt; Coercion -&gt; TcS ()
setWantedEq (HoleDest hole) co
  = do { useVars (coVarsOfCo co)
       ; wrapTcS $ TcM.fillCoercionHole hole co }
setWantedEq (EvVarDest ev) _ = pprPanic &quot;setWantedEq&quot; (ppr ev)

-- | Good for both equalities and non-equalities
setWantedEvTerm :: TcEvDest -&gt; EvTerm -&gt; TcS ()
setWantedEvTerm (HoleDest hole) tm
  | Just co &lt;- evTermCoercion_maybe tm
  = do { useVars (coVarsOfCo co)
       ; wrapTcS $ TcM.fillCoercionHole hole co }
  | otherwise
  = do { let co_var = coHoleCoVar hole
       ; setEvBind (mkWantedEvBind co_var tm)
       ; wrapTcS $ TcM.fillCoercionHole hole (mkTcCoVarCo co_var) }

setWantedEvTerm (EvVarDest ev_id) tm
  = setEvBind (mkWantedEvBind ev_id tm)

setEvBindIfWanted :: CtEvidence -&gt; EvTerm -&gt; TcS ()
setEvBindIfWanted ev tm
  = case ev of
      CtWanted { ctev_dest = dest } -&gt; setWantedEvTerm dest tm
      _                             -&gt; return ()

newTcEvBinds :: TcS EvBindsVar
newTcEvBinds = wrapTcS TcM.newTcEvBinds

newNoTcEvBinds :: TcS EvBindsVar
newNoTcEvBinds = wrapTcS TcM.newNoTcEvBinds

newEvVar :: TcPredType -&gt; TcS EvVar
newEvVar pred = wrapTcS (TcM.newEvVar pred)

newGivenEvVar :: CtLoc -&gt; (TcPredType, EvTerm) -&gt; TcS CtEvidence
-- Make a new variable of the given PredType,
-- immediately bind it to the given term
-- and return its CtEvidence
-- See Note [Bind new Givens immediately] in TcRnTypes
newGivenEvVar loc (pred, rhs)
  = do { new_ev &lt;- newBoundEvVarId pred rhs
       ; return (CtGiven { ctev_pred = pred, ctev_evar = new_ev, ctev_loc = loc }) }

-- | Make a new 'Id' of the given type, bound (in the monad's EvBinds) to the
-- given term
newBoundEvVarId :: TcPredType -&gt; EvTerm -&gt; TcS EvVar
newBoundEvVarId pred rhs
  = do { new_ev &lt;- newEvVar pred
       ; setEvBind (mkGivenEvBind new_ev rhs)
       ; return new_ev }

newGivenEvVars :: CtLoc -&gt; [(TcPredType, EvTerm)] -&gt; TcS [CtEvidence]
newGivenEvVars loc pts = mapM (newGivenEvVar loc) pts

emitNewWantedEq :: CtLoc -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcS Coercion
-- | Emit a new Wanted equality into the work-list
emitNewWantedEq loc role ty1 ty2
  | otherwise
  = do { (ev, co) &lt;- newWantedEq loc role ty1 ty2
       ; updWorkListTcS $
         extendWorkListEq (mkNonCanonical ev)
       ; return co }

-- | Make a new equality CtEvidence
newWantedEq :: CtLoc -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcS (CtEvidence, Coercion)
newWantedEq loc role ty1 ty2
  = do { hole &lt;- wrapTcS $ TcM.newCoercionHole pty
       ; traceTcS &quot;Emitting new coercion hole&quot; (ppr hole &lt;+&gt; dcolon &lt;+&gt; ppr pty)
       ; return ( CtWanted { ctev_pred = pty, ctev_dest = HoleDest hole
                           , ctev_nosh = WDeriv
                           , ctev_loc = loc}
                , mkHoleCo hole ) }
  where
    pty = mkPrimEqPredRole role ty1 ty2

-- no equalities here. Use newWantedEq instead
newWantedEvVarNC :: CtLoc -&gt; TcPredType -&gt; TcS CtEvidence
-- Don't look up in the solved/inerts; we know it's not there
newWantedEvVarNC loc pty
  = do { new_ev &lt;- newEvVar pty
       ; traceTcS &quot;Emitting new wanted&quot; (ppr new_ev &lt;+&gt; dcolon &lt;+&gt; ppr pty $$
                                         pprCtLoc loc)
       ; return (CtWanted { ctev_pred = pty, ctev_dest = EvVarDest new_ev
                          , ctev_nosh = WDeriv
                          , ctev_loc = loc })}

newWantedEvVar :: CtLoc -&gt; TcPredType -&gt; TcS MaybeNew
-- For anything except ClassPred, this is the same as newWantedEvVarNC
newWantedEvVar loc pty
  = do { mb_ct &lt;- lookupInInerts loc pty
       ; case mb_ct of
            Just ctev
              | not (isDerived ctev)
              -&gt; do { traceTcS &quot;newWantedEvVar/cache hit&quot; $ ppr ctev
                    ; return $ Cached (ctEvExpr ctev) }
            _ -&gt; do { ctev &lt;- newWantedEvVarNC loc pty
                    ; return (Fresh ctev) } }

-- deals with both equalities and non equalities. Tries to look
-- up non-equalities in the cache
newWanted :: CtLoc -&gt; PredType -&gt; TcS MaybeNew
newWanted loc pty
  | Just (role, ty1, ty2) &lt;- getEqPredTys_maybe pty
  = Fresh . fst &lt;$&gt; newWantedEq loc role ty1 ty2
  | otherwise
  = newWantedEvVar loc pty

-- deals with both equalities and non equalities. Doesn't do any cache lookups.
newWantedNC :: CtLoc -&gt; PredType -&gt; TcS CtEvidence
newWantedNC loc pty
  | Just (role, ty1, ty2) &lt;- getEqPredTys_maybe pty
  = fst &lt;$&gt; newWantedEq loc role ty1 ty2
  | otherwise
  = newWantedEvVarNC loc pty

emitNewDeriveds :: CtLoc -&gt; [TcPredType] -&gt; TcS ()
emitNewDeriveds loc preds
  | null preds
  = return ()
  | otherwise
  = do { evs &lt;- mapM (newDerivedNC loc) preds
       ; traceTcS &quot;Emitting new deriveds&quot; (ppr evs)
       ; updWorkListTcS (extendWorkListDeriveds evs) }

emitNewDerivedEq :: CtLoc -&gt; Role -&gt; TcType -&gt; TcType -&gt; TcS ()
-- Create new equality Derived and put it in the work list
-- There's no caching, no lookupInInerts
emitNewDerivedEq loc role ty1 ty2
  = do { ev &lt;- newDerivedNC loc (mkPrimEqPredRole role ty1 ty2)
       ; traceTcS &quot;Emitting new derived equality&quot; (ppr ev $$ pprCtLoc loc)
       ; updWorkListTcS (extendWorkListEq (mkNonCanonical ev)) }
         -- Very important: put in the wl_eqs
         -- See Note [Prioritise equalities] (Avoiding fundep iteration)

newDerivedNC :: CtLoc -&gt; TcPredType -&gt; TcS CtEvidence
newDerivedNC loc pred
  = do { -- checkReductionDepth loc pred
       ; return (CtDerived { ctev_pred = pred, ctev_loc = loc }) }

-- --------- Check done in TcInteract.selectNewWorkItem???? ---------
-- | Checks if the depth of the given location is too much. Fails if
-- it's too big, with an appropriate error message.
checkReductionDepth :: CtLoc -&gt; TcType   -- ^ type being reduced
                    -&gt; TcS ()
checkReductionDepth loc ty
  = do { dflags &lt;- getDynFlags
       ; when (subGoalDepthExceeded dflags (ctLocDepth loc)) $
         wrapErrTcS $
         solverDepthErrorTcS loc ty }

matchFam :: TyCon -&gt; [Type] -&gt; TcS (Maybe (Coercion, TcType))
matchFam tycon args = wrapTcS $ matchFamTcM tycon args

matchFamTcM :: TyCon -&gt; [Type] -&gt; TcM (Maybe (Coercion, TcType))
-- Given (F tys) return (ty, co), where co :: F tys ~ ty
matchFamTcM tycon args
  = do { fam_envs &lt;- FamInst.tcGetFamInstEnvs
       ; let match_fam_result
              = reduceTyFamApp_maybe fam_envs Nominal tycon args
       ; TcM.traceTc &quot;matchFamTcM&quot; $
         vcat [ text &quot;Matching:&quot; &lt;+&gt; ppr (mkTyConApp tycon args)
              , ppr_res match_fam_result ]
       ; return match_fam_result }
  where
    ppr_res Nothing        = text &quot;Match failed&quot;
    ppr_res (Just (co,ty)) = hang (text &quot;Match succeeded:&quot;)
                                2 (vcat [ text &quot;Rewrites to:&quot; &lt;+&gt; ppr ty
                                        , text &quot;Coercion:&quot; &lt;+&gt; ppr co ])

{-
Note [Residual implications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The wl_implics in the WorkList are the residual implication
constraints that are generated while solving or canonicalising the
current worklist.  Specifically, when canonicalising
   (forall a. t1 ~ forall a. t2)
from which we get the implication
   (forall a. t1 ~ t2)
See TcSMonad.deferTcSForAllEq
-}
</span></pre></body></html>