<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">--</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Stg to C--: heap management functions</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- (c) The University of Glasgow 2004-2006</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCmmHeap</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-10"></a><span>        </span><a href="StgCmmMonad.html#getVirtHp"><span class="hs-identifier hs-var">getVirtHp</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#setVirtHp"><span class="hs-identifier hs-var">setVirtHp</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#setRealHp"><span class="hs-identifier hs-var">setRealHp</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>        </span><a href="StgCmmLayout.html#getHpRelOffset"><span class="hs-identifier hs-var">getHpRelOffset</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>        </span><a href="StgCmmHeap.html#entryHeapCheck"><span class="hs-identifier hs-var">entryHeapCheck</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmHeap.html#altHeapCheck"><span class="hs-identifier hs-var">altHeapCheck</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmHeap.html#noEscapeHeapCheck"><span class="hs-identifier hs-var">noEscapeHeapCheck</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmHeap.html#altHeapCheckReturnsTo"><span class="hs-identifier hs-var">altHeapCheckReturnsTo</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="StgCmmHeap.html#heapStackCheckGen"><span class="hs-identifier hs-var">heapStackCheckGen</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="StgCmmHeap.html#entryHeapCheck%27"><span class="hs-identifier hs-var">entryHeapCheck'</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>        </span><a href="StgCmmHeap.html#mkStaticClosureFields"><span class="hs-identifier hs-var">mkStaticClosureFields</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmHeap.html#mkStaticClosure"><span class="hs-identifier hs-var">mkStaticClosure</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>        </span><a href="StgCmmHeap.html#allocDynClosure"><span class="hs-identifier hs-var">allocDynClosure</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmHeap.html#allocDynClosureCmm"><span class="hs-identifier hs-var">allocDynClosureCmm</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmHeap.html#allocHeapClosure"><span class="hs-identifier hs-var">allocHeapClosure</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="StgCmmHeap.html#emitSetDynHdr"><span class="hs-identifier hs-var">emitSetDynHdr</span></a><span>
</span><a name="line-21"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;*&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmLayout.html"><span class="hs-identifier">StgCmmLayout</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmUtils.html"><span class="hs-identifier">StgCmmUtils</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmMonad.html"><span class="hs-identifier">StgCmmMonad</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmProf.html"><span class="hs-identifier">StgCmmProf</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmProf.html#profDynAlloc"><span class="hs-identifier hs-var">profDynAlloc</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmProf.html#dynProfHdr"><span class="hs-identifier hs-var">dynProfHdr</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmProf.html#staticProfHdr"><span class="hs-identifier hs-var">staticProfHdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmTicky.html"><span class="hs-identifier">StgCmmTicky</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmEnv.html"><span class="hs-identifier">StgCmmEnv</span></a><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="MkGraph.html"><span class="hs-identifier">MkGraph</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">CafInfo</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mayHaveCafRefs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">sorry</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">when</span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">-----------------------------------------------------------</span><span>
</span><a name="line-54"></a><span class="hs-comment">--              Initialise dynamic heap objects</span><span>
</span><a name="line-55"></a><span class="hs-comment">-----------------------------------------------------------</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-identifier">allocDynClosure</span><span>
</span><a name="line-58"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-59"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>
</span><a name="line-60"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-61"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>              </span><span class="hs-comment">-- Cost Centre to stick in the object</span><span>
</span><a name="line-62"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>              </span><span class="hs-comment">-- Cost Centre to blame for this alloc</span><span>
</span><a name="line-63"></a><span>                                </span><span class="hs-comment">-- (usually the same; sometimes &quot;OVERHEAD&quot;)</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#VirtualHpOffset"><span class="hs-identifier hs-type">VirtualHpOffset</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Offsets from start of object</span><span>
</span><a name="line-66"></a><span>                                                </span><span class="hs-comment">-- ie Info ptr has offset zero.</span><span>
</span><a name="line-67"></a><span>                                                </span><span class="hs-comment">-- No void args in here</span><span>
</span><a name="line-68"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-comment">-- returns Hp+n</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-identifier">allocDynClosureCmm</span><span>
</span><a name="line-71"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-72"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-73"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-comment">-- returns Hp+n</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">-- allocDynClosure allocates the thing in the heap,</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- and modifies the virtual Hp to account for this.</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- The second return value is the graph that sets the value of the</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- returned LocalReg, which should point to the closure after executing</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- the graph.</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-- allocDynClosure returns an (Hp+8) CmmExpr, and hence the result is</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- only valid until Hp is changed.  The caller should assign the</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- result to a LocalReg if it is required to remain live.</span><span>
</span><a name="line-84"></a><span class="hs-comment">--</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- The reason we don't assign it to a LocalReg here is that the caller</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- is often about to call regIdInfo, which immediately assigns the</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- result of allocDynClosure to a new temp in order to add the tag.</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- So by not generating a LocalReg here we avoid a common source of</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- new temporaries and save some compile time.  This can be quite</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- significant - see test T4801.</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><a name="allocDynClosure"><a href="StgCmmHeap.html#allocDynClosure"><span class="hs-identifier">allocDynClosure</span></a></a><span> </span><a name="local-6989586621680938059"><a href="#local-6989586621680938059"><span class="hs-identifier">mb_id</span></a></a><span> </span><a name="local-6989586621680938060"><a href="#local-6989586621680938060"><span class="hs-identifier">info_tbl</span></a></a><span> </span><a name="local-6989586621680938061"><a href="#local-6989586621680938061"><span class="hs-identifier">lf_info</span></a></a><span> </span><a name="local-6989586621680938062"><a href="#local-6989586621680938062"><span class="hs-identifier">use_cc</span></a></a><span> </span><a name="local-6989586621680938063"><a href="#local-6989586621680938063"><span class="hs-identifier">_blame_cc</span></a></a><span> </span><a name="local-6989586621680938064"><a href="#local-6989586621680938064"><span class="hs-identifier">args_w_offsets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-94"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680938065"><a href="#local-6989586621680938065"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680938066"><a href="#local-6989586621680938066"><span class="hs-identifier">offsets</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621680938064"><span class="hs-identifier hs-var">args_w_offsets</span></a><span>
</span><a name="line-95"></a><span>  </span><a name="local-6989586621680938067"><a href="#local-6989586621680938067"><span class="hs-identifier">cmm_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="StgCmmEnv.html#getArgAmode"><span class="hs-identifier hs-var">getArgAmode</span></a><span> </span><a href="#local-6989586621680938065"><span class="hs-identifier hs-var">args</span></a><span>     </span><span class="hs-comment">-- No void args</span><span>
</span><a name="line-96"></a><span>  </span><a href="StgCmmHeap.html#allocDynClosureCmm"><span class="hs-identifier hs-var">allocDynClosureCmm</span></a><span> </span><a href="#local-6989586621680938059"><span class="hs-identifier hs-var">mb_id</span></a><span> </span><a href="#local-6989586621680938060"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><a href="#local-6989586621680938061"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-97"></a><span>                     </span><a href="#local-6989586621680938062"><span class="hs-identifier hs-var">use_cc</span></a><span> </span><a href="#local-6989586621680938063"><span class="hs-identifier hs-var">_blame_cc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621680938067"><span class="hs-identifier hs-var">cmm_args</span></a><span> </span><a href="#local-6989586621680938066"><span class="hs-identifier hs-var">offsets</span></a><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><a name="allocDynClosureCmm"><a href="StgCmmHeap.html#allocDynClosureCmm"><span class="hs-identifier">allocDynClosureCmm</span></a></a><span> </span><a name="local-6989586621680938068"><a href="#local-6989586621680938068"><span class="hs-identifier">mb_id</span></a></a><span> </span><a name="local-6989586621680938069"><a href="#local-6989586621680938069"><span class="hs-identifier">info_tbl</span></a></a><span> </span><a name="local-6989586621680938070"><a href="#local-6989586621680938070"><span class="hs-identifier">lf_info</span></a></a><span> </span><a name="local-6989586621680938071"><a href="#local-6989586621680938071"><span class="hs-identifier">use_cc</span></a></a><span> </span><a name="local-6989586621680938072"><a href="#local-6989586621680938072"><span class="hs-identifier">_blame_cc</span></a></a><span> </span><a name="local-6989586621680938073"><a href="#local-6989586621680938073"><span class="hs-identifier">amodes_w_offsets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-101"></a><span>  </span><span class="hs-comment">-- SAY WHAT WE ARE ABOUT TO DO</span><span>
</span><a name="line-102"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680938074"><a href="#local-6989586621680938074"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><a href="#local-6989586621680938069"><span class="hs-identifier hs-var">info_tbl</span></a><span>
</span><a name="line-103"></a><span>  </span><a href="StgCmmTicky.html#tickyDynAlloc"><span class="hs-identifier hs-var">tickyDynAlloc</span></a><span> </span><a href="#local-6989586621680938068"><span class="hs-identifier hs-var">mb_id</span></a><span> </span><a href="#local-6989586621680938074"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-6989586621680938070"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-104"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680938075"><a href="#local-6989586621680938075"><span class="hs-identifier">info_ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cit_lbl</span><span> </span><a href="#local-6989586621680938069"><span class="hs-identifier hs-var">info_tbl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>  </span><a href="StgCmmHeap.html#allocHeapClosure"><span class="hs-identifier hs-var">allocHeapClosure</span></a><span> </span><a href="#local-6989586621680938074"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-6989586621680938075"><span class="hs-identifier hs-var">info_ptr</span></a><span> </span><a href="#local-6989586621680938071"><span class="hs-identifier hs-var">use_cc</span></a><span> </span><a href="#local-6989586621680938073"><span class="hs-identifier hs-var">amodes_w_offsets</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- | Low-level heap object allocation.</span><span>
</span><a name="line-109"></a><span class="hs-identifier">allocHeapClosure</span><span>
</span><a name="line-110"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="SMRep.html#SMRep"><span class="hs-identifier hs-type">SMRep</span></a><span>                            </span><span class="hs-comment">-- ^ representation of the object</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>                          </span><span class="hs-comment">-- ^ info pointer</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>                          </span><span class="hs-comment">-- ^ cost centre</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">,</span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- ^ payload</span><span>
</span><a name="line-114"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>                    </span><span class="hs-comment">-- ^ returns the address of the object</span><span>
</span><a name="line-115"></a><a name="allocHeapClosure"><a href="StgCmmHeap.html#allocHeapClosure"><span class="hs-identifier">allocHeapClosure</span></a></a><span> </span><a name="local-6989586621680938076"><a href="#local-6989586621680938076"><span class="hs-identifier">rep</span></a></a><span> </span><a name="local-6989586621680938077"><a href="#local-6989586621680938077"><span class="hs-identifier">info_ptr</span></a></a><span> </span><a name="local-6989586621680938078"><a href="#local-6989586621680938078"><span class="hs-identifier">use_cc</span></a></a><span> </span><a name="local-6989586621680938079"><a href="#local-6989586621680938079"><span class="hs-identifier">payload</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-116"></a><span>  </span><a href="StgCmmProf.html#profDynAlloc"><span class="hs-identifier hs-var">profDynAlloc</span></a><span> </span><a href="#local-6989586621680938076"><span class="hs-identifier hs-var">rep</span></a><span> </span><a href="#local-6989586621680938078"><span class="hs-identifier hs-var">use_cc</span></a><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span>  </span><a name="local-6989586621680938080"><a href="#local-6989586621680938080"><span class="hs-identifier">virt_hp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getVirtHp"><span class="hs-identifier hs-var">getVirtHp</span></a><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span>  </span><span class="hs-comment">-- Find the offset of the info-ptr word</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680938081"><a href="#local-6989586621680938081"><span class="hs-identifier">info_offset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680938080"><span class="hs-identifier hs-var">virt_hp</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-122"></a><span>            </span><span class="hs-comment">-- info_offset is the VirtualHpOffset of the first</span><span>
</span><a name="line-123"></a><span>            </span><span class="hs-comment">-- word of the new object</span><span>
</span><a name="line-124"></a><span>            </span><span class="hs-comment">-- Remember, virtHp points to last allocated word,</span><span>
</span><a name="line-125"></a><span>            </span><span class="hs-comment">-- ie 1 *before* the info-ptr word of new object.</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span>  </span><a name="local-6989586621680938082"><a href="#local-6989586621680938082"><span class="hs-identifier">base</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmLayout.html#getHpRelOffset"><span class="hs-identifier hs-var">getHpRelOffset</span></a><span> </span><a href="#local-6989586621680938081"><span class="hs-identifier hs-var">info_offset</span></a><span>
</span><a name="line-128"></a><span>  </span><a href="StgCmmMonad.html#emitComment"><span class="hs-identifier hs-var">emitComment</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-string">&quot;allocHeapClosure&quot;</span><span>
</span><a name="line-129"></a><span>  </span><a href="StgCmmHeap.html#emitSetDynHdr"><span class="hs-identifier hs-var">emitSetDynHdr</span></a><span> </span><a href="#local-6989586621680938082"><span class="hs-identifier hs-var">base</span></a><span> </span><a href="#local-6989586621680938077"><span class="hs-identifier hs-var">info_ptr</span></a><span> </span><a href="#local-6989586621680938078"><span class="hs-identifier hs-var">use_cc</span></a><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span>  </span><span class="hs-comment">-- Fill in the fields</span><span>
</span><a name="line-132"></a><span>  </span><a href="StgCmmHeap.html#hpStore"><span class="hs-identifier hs-var">hpStore</span></a><span> </span><a href="#local-6989586621680938082"><span class="hs-identifier hs-var">base</span></a><span> </span><a href="#local-6989586621680938079"><span class="hs-identifier hs-var">payload</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span>  </span><span class="hs-comment">-- Bump the virtual heap pointer</span><span>
</span><a name="line-135"></a><span>  </span><a name="local-6989586621680938083"><a href="#local-6989586621680938083"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-136"></a><span>  </span><a href="StgCmmMonad.html#setVirtHp"><span class="hs-identifier hs-var">setVirtHp</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938080"><span class="hs-identifier hs-var">virt_hp</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="SMRep.html#heapClosureSizeW"><span class="hs-identifier hs-var">heapClosureSizeW</span></a><span> </span><a href="#local-6989586621680938083"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680938076"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680938082"><span class="hs-identifier hs-var">base</span></a><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">emitSetDynHdr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-142"></a><a name="emitSetDynHdr"><a href="StgCmmHeap.html#emitSetDynHdr"><span class="hs-identifier">emitSetDynHdr</span></a></a><span> </span><a name="local-6989586621680938084"><a href="#local-6989586621680938084"><span class="hs-identifier">base</span></a></a><span> </span><a name="local-6989586621680938085"><a href="#local-6989586621680938085"><span class="hs-identifier">info_ptr</span></a></a><span> </span><a name="local-6989586621680938086"><a href="#local-6989586621680938086"><span class="hs-identifier">ccs</span></a></a><span>
</span><a name="line-143"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680938089"><a href="#local-6989586621680938089"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-144"></a><span>       </span><a href="StgCmmHeap.html#hpStore"><span class="hs-identifier hs-var">hpStore</span></a><span> </span><a href="#local-6989586621680938084"><span class="hs-identifier hs-var">base</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938087"><span class="hs-identifier hs-var">header</span></a><span> </span><a href="#local-6989586621680938089"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621680938089"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-146"></a><span>    </span><span class="hs-identifier">header</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">]</span><span>
</span><a name="line-147"></a><span>    </span><a name="local-6989586621680938087"><a href="#local-6989586621680938087"><span class="hs-identifier">header</span></a></a><span> </span><a name="local-6989586621680938088"><a href="#local-6989586621680938088"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680938085"><span class="hs-identifier hs-var">info_ptr</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="StgCmmProf.html#dynProfHdr"><span class="hs-identifier hs-var">dynProfHdr</span></a><span> </span><a href="#local-6989586621680938088"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680938086"><span class="hs-identifier hs-var">ccs</span></a><span>
</span><a name="line-148"></a><span>        </span><span class="hs-comment">-- ToDo: Parallel stuff</span><span>
</span><a name="line-149"></a><span>        </span><span class="hs-comment">-- No ticky header</span><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-comment">-- Store the item (expr,off) in base[off]</span><span>
</span><a name="line-152"></a><span class="hs-identifier">hpStore</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><a name="hpStore"><a href="StgCmmHeap.html#hpStore"><span class="hs-identifier">hpStore</span></a></a><span> </span><a name="local-6989586621680938090"><a href="#local-6989586621680938090"><span class="hs-identifier">base</span></a></a><span> </span><a name="local-6989586621680938091"><a href="#local-6989586621680938091"><span class="hs-identifier">vals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-154"></a><span>  </span><a name="local-6989586621680938092"><a href="#local-6989586621680938092"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-155"></a><span>  </span><span class="hs-identifier hs-var">sequence_</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-156"></a><span>    </span><span class="hs-special">[</span><span> </span><a href="StgCmmMonad.html#emitStore"><span class="hs-identifier hs-var">emitStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffsetB"><span class="hs-identifier hs-var">cmmOffsetB</span></a><span> </span><a href="#local-6989586621680938092"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680938090"><span class="hs-identifier hs-var">base</span></a><span> </span><a href="#local-6989586621680938094"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938093"><span class="hs-identifier hs-var">val</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680938093"><a href="#local-6989586621680938093"><span class="hs-identifier">val</span></a></a><span class="hs-special">,</span><a name="local-6989586621680938094"><a href="#local-6989586621680938094"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680938091"><span class="hs-identifier hs-var">vals</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-comment">-----------------------------------------------------------</span><span>
</span><a name="line-159"></a><span class="hs-comment">--              Layout of static closures</span><span>
</span><a name="line-160"></a><span class="hs-comment">-----------------------------------------------------------</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-- Make a static closure, adding on any extra padding needed for CAFs,</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- and adding a static link field if necessary.</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-identifier">mkStaticClosureFields</span><span>
</span><a name="line-166"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-167"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>
</span><a name="line-168"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span>
</span><a name="line-169"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CafInfo</span><span>
</span><a name="line-170"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Payload</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- The full closure</span><span>
</span><a name="line-172"></a><a name="mkStaticClosureFields"><a href="StgCmmHeap.html#mkStaticClosureFields"><span class="hs-identifier">mkStaticClosureFields</span></a></a><span> </span><a name="local-6989586621680938095"><a href="#local-6989586621680938095"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680938096"><a href="#local-6989586621680938096"><span class="hs-identifier">info_tbl</span></a></a><span> </span><a name="local-6989586621680938097"><a href="#local-6989586621680938097"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621680938098"><a href="#local-6989586621680938098"><span class="hs-identifier">caf_refs</span></a></a><span> </span><a name="local-6989586621680938099"><a href="#local-6989586621680938099"><span class="hs-identifier">payload</span></a></a><span>
</span><a name="line-173"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmHeap.html#mkStaticClosure"><span class="hs-identifier hs-var">mkStaticClosure</span></a><span> </span><a href="#local-6989586621680938095"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680938100"><span class="hs-identifier hs-var">info_lbl</span></a><span> </span><a href="#local-6989586621680938097"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621680938099"><span class="hs-identifier hs-var">payload</span></a><span> </span><a href="#local-6989586621680938102"><span class="hs-identifier hs-var">padding</span></a><span>
</span><a name="line-174"></a><span>        </span><a href="#local-6989586621680938103"><span class="hs-identifier hs-var">static_link_field</span></a><span> </span><a href="#local-6989586621680938104"><span class="hs-identifier hs-var">saved_info_field</span></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-176"></a><span>    </span><a name="local-6989586621680938100"><a href="#local-6989586621680938100"><span class="hs-identifier">info_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">cit_lbl</span><span> </span><a href="#local-6989586621680938096"><span class="hs-identifier hs-var">info_tbl</span></a><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span>    </span><span class="hs-comment">-- CAFs must have consistent layout, regardless of whether they</span><span>
</span><a name="line-179"></a><span>    </span><span class="hs-comment">-- are actually updatable or not.  The layout of a CAF is:</span><span>
</span><a name="line-180"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-181"></a><span>    </span><span class="hs-comment">--        3 saved_info</span><span>
</span><a name="line-182"></a><span>    </span><span class="hs-comment">--        2 static_link</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-comment">--        1 indirectee</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-comment">--        0 info ptr</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-186"></a><span>    </span><span class="hs-comment">-- the static_link and saved_info fields must always be in the</span><span>
</span><a name="line-187"></a><span>    </span><span class="hs-comment">-- same place.  So we use isThunkRep rather than closureUpdReqd</span><span>
</span><a name="line-188"></a><span>    </span><span class="hs-comment">-- here:</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span>    </span><a name="local-6989586621680938101"><a href="#local-6989586621680938101"><span class="hs-identifier">is_caf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#isThunkRep"><span class="hs-identifier hs-var">isThunkRep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">cit_rep</span><span> </span><a href="#local-6989586621680938096"><span class="hs-identifier hs-var">info_tbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621680938102"><a href="#local-6989586621680938102"><span class="hs-identifier">padding</span></a></a><span>
</span><a name="line-193"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938101"><span class="hs-identifier hs-var">is_caf</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680938099"><span class="hs-identifier hs-var">payload</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="CmmUtils.html#mkIntCLit"><span class="hs-identifier hs-var">mkIntCLit</span></a><span> </span><a href="#local-6989586621680938095"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">]</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>    </span><a name="local-6989586621680938103"><a href="#local-6989586621680938103"><span class="hs-identifier">static_link_field</span></a></a><span>
</span><a name="line-197"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938101"><span class="hs-identifier hs-var">is_caf</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="StgCmmClosure.html#staticClosureNeedsLink"><span class="hs-identifier hs-var">staticClosureNeedsLink</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mayHaveCafRefs</span><span> </span><a href="#local-6989586621680938098"><span class="hs-identifier hs-var">caf_refs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938096"><span class="hs-identifier hs-var">info_tbl</span></a><span>
</span><a name="line-198"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680938105"><span class="hs-identifier hs-var">static_link_value</span></a><span class="hs-special">]</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span>    </span><a name="local-6989586621680938104"><a href="#local-6989586621680938104"><span class="hs-identifier">saved_info_field</span></a></a><span>
</span><a name="line-203"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938101"><span class="hs-identifier hs-var">is_caf</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="CmmUtils.html#mkIntCLit"><span class="hs-identifier hs-var">mkIntCLit</span></a><span> </span><a href="#local-6989586621680938095"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">]</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-205"></a><span>
</span><a name="line-206"></a><span>        </span><span class="hs-comment">-- For a static constructor which has NoCafRefs, we set the</span><span>
</span><a name="line-207"></a><span>        </span><span class="hs-comment">-- static link field to a non-zero value so the garbage</span><span>
</span><a name="line-208"></a><span>        </span><span class="hs-comment">-- collector will ignore it.</span><span>
</span><a name="line-209"></a><span>    </span><a name="local-6989586621680938105"><a href="#local-6989586621680938105"><span class="hs-identifier">static_link_value</span></a></a><span>
</span><a name="line-210"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">mayHaveCafRefs</span><span> </span><a href="#local-6989586621680938098"><span class="hs-identifier hs-var">caf_refs</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#mkIntCLit"><span class="hs-identifier hs-var">mkIntCLit</span></a><span> </span><a href="#local-6989586621680938095"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#mkIntCLit"><span class="hs-identifier hs-var">mkIntCLit</span></a><span> </span><a href="#local-6989586621680938095"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span>  </span><span class="hs-comment">-- No CAF refs</span><span>
</span><a name="line-212"></a><span>                                      </span><span class="hs-comment">-- See Note [STATIC_LINK fields]</span><span>
</span><a name="line-213"></a><span>                                      </span><span class="hs-comment">-- in rts/sm/Storage.h</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-identifier">mkStaticClosure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span class="hs-special">]</span><span>
</span><a name="line-216"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-type">CmmLit</span></a><span class="hs-special">]</span><span>
</span><a name="line-217"></a><a name="mkStaticClosure"><a href="StgCmmHeap.html#mkStaticClosure"><span class="hs-identifier">mkStaticClosure</span></a></a><span> </span><a name="local-6989586621680938106"><a href="#local-6989586621680938106"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680938107"><a href="#local-6989586621680938107"><span class="hs-identifier">info_lbl</span></a></a><span> </span><a name="local-6989586621680938108"><a href="#local-6989586621680938108"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621680938109"><a href="#local-6989586621680938109"><span class="hs-identifier">payload</span></a></a><span> </span><a name="local-6989586621680938110"><a href="#local-6989586621680938110"><span class="hs-identifier">padding</span></a></a><span> </span><a name="local-6989586621680938111"><a href="#local-6989586621680938111"><span class="hs-identifier">static_link_field</span></a></a><span> </span><a name="local-6989586621680938112"><a href="#local-6989586621680938112"><span class="hs-identifier">saved_info_field</span></a></a><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621680938107"><span class="hs-identifier hs-var">info_lbl</span></a><span class="hs-special">]</span><span>
</span><a name="line-219"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><a href="StgCmmProf.html#staticProfHdr"><span class="hs-identifier hs-var">staticProfHdr</span></a><span> </span><a href="#local-6989586621680938106"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680938108"><span class="hs-identifier hs-var">ccs</span></a><span>
</span><a name="line-220"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680938109"><span class="hs-identifier hs-var">payload</span></a><span>
</span><a name="line-221"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680938110"><span class="hs-identifier hs-var">padding</span></a><span>
</span><a name="line-222"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680938111"><span class="hs-identifier hs-var">static_link_field</span></a><span>
</span><a name="line-223"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621680938112"><span class="hs-identifier hs-var">saved_info_field</span></a><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">-----------------------------------------------------------</span><span>
</span><a name="line-226"></a><span class="hs-comment">--              Heap overflow checking</span><span>
</span><a name="line-227"></a><span class="hs-comment">-----------------------------------------------------------</span><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">{- Note [Heap checks]
   ~~~~~~~~~~~~~~~~~~
Heap checks come in various forms.  We provide the following entry
points to the runtime system, all of which use the native C-- entry
convention.

  * gc() performs garbage collection and returns
    nothing to its caller

  * A series of canned entry points like
        r = gc_1p( r )
    where r is a pointer.  This performs gc, and
    then returns its argument r to its caller.

  * A series of canned entry points like
        gcfun_2p( f, x, y )
    where f is a function closure of arity 2
    This performs garbage collection, keeping alive the
    three argument ptrs, and then tail-calls f(x,y)

These are used in the following circumstances

* entryHeapCheck: Function entry
    (a) With a canned GC entry sequence
        f( f_clo, x:ptr, y:ptr ) {
             Hp = Hp+8
             if Hp &gt; HpLim goto L
             ...
          L: HpAlloc = 8
             jump gcfun_2p( f_clo, x, y ) }
     Note the tail call to the garbage collector;
     it should do no register shuffling

    (b) No canned sequence
        f( f_clo, x:ptr, y:ptr, ...etc... ) {
          T: Hp = Hp+8
             if Hp &gt; HpLim goto L
             ...
          L: HpAlloc = 8
             call gc()  -- Needs an info table
             goto T }

* altHeapCheck: Immediately following an eval
  Started as
        case f x y of r { (p,q) -&gt; rhs }
  (a) With a canned sequence for the results of f
       (which is the very common case since
       all boxed cases return just one pointer
           ...
           r = f( x, y )
        K:      -- K needs an info table
           Hp = Hp+8
           if Hp &gt; HpLim goto L
           ...code for rhs...

        L: r = gc_1p( r )
           goto K }

        Here, the info table needed by the call
        to gc_1p should be the *same* as the
        one for the call to f; the C-- optimiser
        spots this sharing opportunity)

   (b) No canned sequence for results of f
       Note second info table
           ...
           (r1,r2,r3) = call f( x, y )
        K:
           Hp = Hp+8
           if Hp &gt; HpLim goto L
           ...code for rhs...

        L: call gc()    -- Extra info table here
           goto K

* generalHeapCheck: Anywhere else
  e.g. entry to thunk
       case branch *not* following eval,
       or let-no-escape
  Exactly the same as the previous case:

        K:      -- K needs an info table
           Hp = Hp+8
           if Hp &gt; HpLim goto L
           ...

        L: call gc()
           goto K
-}</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-comment">--------------------------------------------------------------</span><span>
</span><a name="line-320"></a><span class="hs-comment">-- A heap/stack check at a function or thunk entry point.</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-identifier">entryHeapCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span>
</span><a name="line-323"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-comment">-- Function (closure environment)</span><span>
</span><a name="line-324"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>            </span><span class="hs-comment">-- Arity -- not same as len args b/c of voids</span><span>
</span><a name="line-325"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Non-void args (empty for thunk)</span><span>
</span><a name="line-326"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><a name="entryHeapCheck"><a href="StgCmmHeap.html#entryHeapCheck"><span class="hs-identifier">entryHeapCheck</span></a></a><span> </span><a name="local-6989586621680938113"><a href="#local-6989586621680938113"><span class="hs-identifier">cl_info</span></a></a><span> </span><a name="local-6989586621680938114"><a href="#local-6989586621680938114"><span class="hs-identifier">nodeSet</span></a></a><span> </span><a name="local-6989586621680938115"><a href="#local-6989586621680938115"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621680938116"><a href="#local-6989586621680938116"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680938117"><a href="#local-6989586621680938117"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmHeap.html#entryHeapCheck%27"><span class="hs-identifier hs-var">entryHeapCheck'</span></a><span> </span><a href="#local-6989586621680938119"><span class="hs-identifier hs-var">is_fastf</span></a><span> </span><a href="#local-6989586621680938118"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621680938115"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621680938116"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680938117"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-331"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-332"></a><span>    </span><a name="local-6989586621680938118"><a href="#local-6989586621680938118"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680938114"><span class="hs-identifier hs-var">nodeSet</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-333"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680938120"><a href="#local-6989586621680938120"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621680938120"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-334"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmClosure.html#staticClosureLabel"><span class="hs-identifier hs-var">staticClosureLabel</span></a><span> </span><a href="#local-6989586621680938113"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span>    </span><a name="local-6989586621680938119"><a href="#local-6989586621680938119"><span class="hs-identifier">is_fastf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="StgCmmClosure.html#closureFunInfo"><span class="hs-identifier hs-var">closureFunInfo</span></a><span> </span><a href="#local-6989586621680938113"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-337"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ArgGen"><span class="hs-identifier hs-var">ArgGen</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-338"></a><span>                 </span><a name="local-6989586621680938121"><a href="#local-6989586621680938121"><span class="hs-identifier">_otherwise</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span class="hs-comment">-- | lower-level version for CmmParse</span><span>
</span><a name="line-341"></a><span class="hs-identifier">entryHeapCheck'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>           </span><span class="hs-comment">-- is a known function pattern</span><span>
</span><a name="line-342"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>        </span><span class="hs-comment">-- expression for the closure pointer</span><span>
</span><a name="line-343"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>            </span><span class="hs-comment">-- Arity -- not same as len args b/c of voids</span><span>
</span><a name="line-344"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- Non-void args (empty for thunk)</span><span>
</span><a name="line-345"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-346"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-347"></a><a name="entryHeapCheck%27"><a href="StgCmmHeap.html#entryHeapCheck%27"><span class="hs-identifier">entryHeapCheck'</span></a></a><span> </span><a name="local-6989586621680938122"><a href="#local-6989586621680938122"><span class="hs-identifier">is_fastf</span></a></a><span> </span><a name="local-6989586621680938123"><a href="#local-6989586621680938123"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621680938124"><a href="#local-6989586621680938124"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621680938125"><a href="#local-6989586621680938125"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680938126"><a href="#local-6989586621680938126"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-348"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680938127"><a href="#local-6989586621680938127"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-349"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680938128"><a href="#local-6989586621680938128"><span class="hs-identifier">is_thunk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680938124"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span>           </span><a name="local-6989586621680938129"><a href="#local-6989586621680938129"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938125"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-352"></a><span>           </span><a name="local-6989586621680938130"><a href="#local-6989586621680938130"><span class="hs-identifier">stg_gc_fun</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#GCFun"><span class="hs-identifier hs-var">GCFun</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>           </span><a name="local-6989586621680938131"><a href="#local-6989586621680938131"><span class="hs-identifier">stg_gc_enter1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#GCEnter1"><span class="hs-identifier hs-var">GCEnter1</span></a><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>           </span><span class="hs-comment">{- Thunks:          jump stg_gc_enter_1

              Function (fast): call (NativeNode) stg_gc_fun(fun, args)

              Function (slow): call (slow) stg_gc_fun(fun, args)
           -}</span><span>
</span><a name="line-361"></a><span>           </span><a name="local-6989586621680938132"><a href="#local-6989586621680938132"><span class="hs-identifier">gc_call</span></a></a><span> </span><a name="local-6989586621680938133"><a href="#local-6989586621680938133"><span class="hs-identifier">upd</span></a></a><span>
</span><a name="line-362"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938128"><span class="hs-identifier hs-var">is_thunk</span></a><span>
</span><a name="line-363"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkJump"><span class="hs-identifier hs-var">mkJump</span></a><span> </span><a href="#local-6989586621680938127"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeNodeCall"><span class="hs-identifier hs-var">NativeNodeCall</span></a><span> </span><a href="#local-6989586621680938131"><span class="hs-identifier hs-var">stg_gc_enter1</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680938123"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621680938133"><span class="hs-identifier hs-var">upd</span></a><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938122"><span class="hs-identifier hs-var">is_fastf</span></a><span>
</span><a name="line-366"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkJump"><span class="hs-identifier hs-var">mkJump</span></a><span> </span><a href="#local-6989586621680938127"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeNodeCall"><span class="hs-identifier hs-var">NativeNodeCall</span></a><span> </span><a href="#local-6989586621680938130"><span class="hs-identifier hs-var">stg_gc_fun</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938123"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680938129"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938133"><span class="hs-identifier hs-var">upd</span></a><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-369"></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkJump"><span class="hs-identifier hs-var">mkJump</span></a><span> </span><a href="#local-6989586621680938127"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#Slow"><span class="hs-identifier hs-var">Slow</span></a><span> </span><a href="#local-6989586621680938130"><span class="hs-identifier hs-var">stg_gc_fun</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938123"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680938129"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938133"><span class="hs-identifier hs-var">upd</span></a><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span>       </span><a name="local-6989586621680938134"><a href="#local-6989586621680938134"><span class="hs-identifier">updfr_sz</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>       </span><a name="local-6989586621680938135"><a href="#local-6989586621680938135"><span class="hs-identifier">loop_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-374"></a><span>       </span><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier hs-var">emitLabel</span></a><span> </span><a href="#local-6989586621680938135"><span class="hs-identifier hs-var">loop_id</span></a><span>
</span><a name="line-375"></a><span>       </span><a href="StgCmmHeap.html#heapCheck"><span class="hs-identifier hs-var">heapCheck</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938132"><span class="hs-identifier hs-var">gc_call</span></a><span> </span><a href="#local-6989586621680938134"><span class="hs-identifier hs-var">updfr_sz</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621680938135"><span class="hs-identifier hs-var">loop_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938126"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span class="hs-comment">-- ------------------------------------------------------------</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- A heap/stack check in a case alternative</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span class="hs-comment">-- If there are multiple alts and we need to GC, but don't have a</span><span>
</span><a name="line-382"></a><span class="hs-comment">-- continuation already (the scrut was simple), then we should</span><span>
</span><a name="line-383"></a><span class="hs-comment">-- pre-generate the continuation.  (if there are multiple alts it is</span><span>
</span><a name="line-384"></a><span class="hs-comment">-- always a canned GC point).</span><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-- altHeapCheck:</span><span>
</span><a name="line-387"></a><span class="hs-comment">-- If we have a return continuation,</span><span>
</span><a name="line-388"></a><span class="hs-comment">--   then if it is a canned GC pattern,</span><span>
</span><a name="line-389"></a><span class="hs-comment">--           then we do mkJumpReturnsTo</span><span>
</span><a name="line-390"></a><span class="hs-comment">--           else we do a normal call to stg_gc_noregs</span><span>
</span><a name="line-391"></a><span class="hs-comment">--   else if it is a canned GC pattern,</span><span>
</span><a name="line-392"></a><span class="hs-comment">--           then generate the continuation and do mkCallReturnsTo</span><span>
</span><a name="line-393"></a><span class="hs-comment">--           else we do a normal call to stg_gc_noregs</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-identifier">altHeapCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938058"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938058"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-396"></a><a name="altHeapCheck"><a href="StgCmmHeap.html#altHeapCheck"><span class="hs-identifier">altHeapCheck</span></a></a><span> </span><a name="local-6989586621680938136"><a href="#local-6989586621680938136"><span class="hs-identifier">regs</span></a></a><span> </span><a name="local-6989586621680938137"><a href="#local-6989586621680938137"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmHeap.html#altOrNoEscapeHeapCheck"><span class="hs-identifier hs-var">altOrNoEscapeHeapCheck</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680938136"><span class="hs-identifier hs-var">regs</span></a><span> </span><a href="#local-6989586621680938137"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-397"></a><span>
</span><a name="line-398"></a><span class="hs-identifier">altOrNoEscapeHeapCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938057"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938057"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-399"></a><a name="altOrNoEscapeHeapCheck"><a href="StgCmmHeap.html#altOrNoEscapeHeapCheck"><span class="hs-identifier">altOrNoEscapeHeapCheck</span></a></a><span> </span><a name="local-6989586621680938138"><a href="#local-6989586621680938138"><span class="hs-identifier">checkYield</span></a></a><span> </span><a name="local-6989586621680938139"><a href="#local-6989586621680938139"><span class="hs-identifier">regs</span></a></a><span> </span><a name="local-6989586621680938140"><a href="#local-6989586621680938140"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-400"></a><span>    </span><a name="local-6989586621680938141"><a href="#local-6989586621680938141"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-401"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="StgCmmHeap.html#cannedGCEntryPoint"><span class="hs-identifier hs-var">cannedGCEntryPoint</span></a><span> </span><a href="#local-6989586621680938141"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680938139"><span class="hs-identifier hs-var">regs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-402"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmHeap.html#genericGC"><span class="hs-identifier hs-var">genericGC</span></a><span> </span><a href="#local-6989586621680938138"><span class="hs-identifier hs-var">checkYield</span></a><span> </span><a href="#local-6989586621680938140"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-403"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680938142"><a href="#local-6989586621680938142"><span class="hs-identifier">gc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-404"></a><span>        </span><a name="local-6989586621680938143"><a href="#local-6989586621680938143"><span class="hs-identifier">lret</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-405"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680938144"><a href="#local-6989586621680938144"><span class="hs-identifier">off</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680938145"><a href="#local-6989586621680938145"><span class="hs-identifier">copyin</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#copyInOflow"><span class="hs-identifier hs-var">copyInOflow</span></a><span> </span><a href="#local-6989586621680938141"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeReturn"><span class="hs-identifier hs-var">NativeReturn</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a href="#local-6989586621680938143"><span class="hs-identifier hs-var">lret</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938139"><span class="hs-identifier hs-var">regs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-406"></a><span>        </span><a name="local-6989586621680938146"><a href="#local-6989586621680938146"><span class="hs-identifier">lcont</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-407"></a><span>        </span><a name="local-6989586621680938147"><a href="#local-6989586621680938147"><span class="hs-identifier">tscope</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-408"></a><span>        </span><a href="StgCmmMonad.html#emitOutOfLine"><span class="hs-identifier hs-var">emitOutOfLine</span></a><span> </span><a href="#local-6989586621680938143"><span class="hs-identifier hs-var">lret</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938145"><span class="hs-identifier hs-var">copyin</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621680938146"><span class="hs-identifier hs-var">lcont</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680938147"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>        </span><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier hs-var">emitLabel</span></a><span> </span><a href="#local-6989586621680938146"><span class="hs-identifier hs-var">lcont</span></a><span>
</span><a name="line-410"></a><span>        </span><a href="StgCmmHeap.html#cannedGCReturnsTo"><span class="hs-identifier hs-var">cannedGCReturnsTo</span></a><span> </span><a href="#local-6989586621680938138"><span class="hs-identifier hs-var">checkYield</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680938142"><span class="hs-identifier hs-var">gc</span></a><span> </span><a href="#local-6989586621680938139"><span class="hs-identifier hs-var">regs</span></a><span> </span><a href="#local-6989586621680938143"><span class="hs-identifier hs-var">lret</span></a><span> </span><a href="#local-6989586621680938144"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621680938140"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-411"></a><span>
</span><a name="line-412"></a><span class="hs-identifier">altHeapCheckReturnsTo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938056"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938056"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-413"></a><a name="altHeapCheckReturnsTo"><a href="StgCmmHeap.html#altHeapCheckReturnsTo"><span class="hs-identifier">altHeapCheckReturnsTo</span></a></a><span> </span><a name="local-6989586621680938148"><a href="#local-6989586621680938148"><span class="hs-identifier">regs</span></a></a><span> </span><a name="local-6989586621680938149"><a href="#local-6989586621680938149"><span class="hs-identifier">lret</span></a></a><span> </span><a name="local-6989586621680938150"><a href="#local-6989586621680938150"><span class="hs-identifier">off</span></a></a><span> </span><a name="local-6989586621680938151"><a href="#local-6989586621680938151"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-414"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680938152"><a href="#local-6989586621680938152"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-415"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="StgCmmHeap.html#cannedGCEntryPoint"><span class="hs-identifier hs-var">cannedGCEntryPoint</span></a><span> </span><a href="#local-6989586621680938152"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680938148"><span class="hs-identifier hs-var">regs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-416"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmHeap.html#genericGC"><span class="hs-identifier hs-var">genericGC</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680938151"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-417"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680938153"><a href="#local-6989586621680938153"><span class="hs-identifier">gc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmHeap.html#cannedGCReturnsTo"><span class="hs-identifier hs-var">cannedGCReturnsTo</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621680938153"><span class="hs-identifier hs-var">gc</span></a><span> </span><a href="#local-6989586621680938148"><span class="hs-identifier hs-var">regs</span></a><span> </span><a href="#local-6989586621680938149"><span class="hs-identifier hs-var">lret</span></a><span> </span><a href="#local-6989586621680938150"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621680938151"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-comment">-- noEscapeHeapCheck is implemented identically to altHeapCheck (which</span><span>
</span><a name="line-420"></a><span class="hs-comment">-- is more efficient), but cannot be optimized away in the non-allocating</span><span>
</span><a name="line-421"></a><span class="hs-comment">-- case because it may occur in a loop</span><span>
</span><a name="line-422"></a><span class="hs-identifier">noEscapeHeapCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938055"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938055"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-423"></a><a name="noEscapeHeapCheck"><a href="StgCmmHeap.html#noEscapeHeapCheck"><span class="hs-identifier">noEscapeHeapCheck</span></a></a><span> </span><a name="local-6989586621680938154"><a href="#local-6989586621680938154"><span class="hs-identifier">regs</span></a></a><span> </span><a name="local-6989586621680938155"><a href="#local-6989586621680938155"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmHeap.html#altOrNoEscapeHeapCheck"><span class="hs-identifier hs-var">altOrNoEscapeHeapCheck</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621680938154"><span class="hs-identifier hs-var">regs</span></a><span> </span><a href="#local-6989586621680938155"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span class="hs-identifier">cannedGCReturnsTo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span>
</span><a name="line-426"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938054"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-427"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938054"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-428"></a><a name="cannedGCReturnsTo"><a href="StgCmmHeap.html#cannedGCReturnsTo"><span class="hs-identifier">cannedGCReturnsTo</span></a></a><span> </span><a name="local-6989586621680938156"><a href="#local-6989586621680938156"><span class="hs-identifier">checkYield</span></a></a><span> </span><a name="local-6989586621680938157"><a href="#local-6989586621680938157"><span class="hs-identifier">cont_on_stack</span></a></a><span> </span><a name="local-6989586621680938158"><a href="#local-6989586621680938158"><span class="hs-identifier">gc</span></a></a><span> </span><a name="local-6989586621680938159"><a href="#local-6989586621680938159"><span class="hs-identifier">regs</span></a></a><span> </span><a name="local-6989586621680938160"><a href="#local-6989586621680938160"><span class="hs-identifier">lret</span></a></a><span> </span><a name="local-6989586621680938161"><a href="#local-6989586621680938161"><span class="hs-identifier">off</span></a></a><span> </span><a name="local-6989586621680938162"><a href="#local-6989586621680938162"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-429"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680938168"><a href="#local-6989586621680938168"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-430"></a><span>       </span><a name="local-6989586621680938169"><a href="#local-6989586621680938169"><span class="hs-identifier">updfr_sz</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-431"></a><span>       </span><a href="StgCmmHeap.html#heapCheck"><span class="hs-identifier hs-var">heapCheck</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680938156"><span class="hs-identifier hs-var">checkYield</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938164"><span class="hs-identifier hs-var">gc_call</span></a><span> </span><a href="#local-6989586621680938168"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680938158"><span class="hs-identifier hs-var">gc</span></a><span> </span><a href="#local-6989586621680938169"><span class="hs-identifier hs-var">updfr_sz</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938162"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-433"></a><span>    </span><a name="local-6989586621680938163"><a href="#local-6989586621680938163"><span class="hs-identifier">reg_exprs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938159"><span class="hs-identifier hs-var">regs</span></a><span>
</span><a name="line-434"></a><span>      </span><span class="hs-comment">-- Note [stg_gc arguments]</span><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span>      </span><span class="hs-comment">-- NB. we use the NativeReturn convention for passing arguments</span><span>
</span><a name="line-437"></a><span>      </span><span class="hs-comment">-- to the canned heap-check routines, because we are in a case</span><span>
</span><a name="line-438"></a><span>      </span><span class="hs-comment">-- alternative and hence the [LocalReg] was passed to us in the</span><span>
</span><a name="line-439"></a><span>      </span><span class="hs-comment">-- NativeReturn convention.</span><span>
</span><a name="line-440"></a><span>    </span><a name="local-6989586621680938164"><a href="#local-6989586621680938164"><span class="hs-identifier">gc_call</span></a></a><span> </span><a name="local-6989586621680938165"><a href="#local-6989586621680938165"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-keyword">label</span><span> </span><a name="local-6989586621680938167"><a href="#local-6989586621680938167"><span class="hs-identifier">sp</span></a></a><span>
</span><a name="line-441"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938157"><span class="hs-identifier hs-var">cont_on_stack</span></a><span>
</span><a name="line-442"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkJumpReturnsTo"><span class="hs-identifier hs-var">mkJumpReturnsTo</span></a><span> </span><a href="#local-6989586621680938165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="CmmNode.html#NativeReturn"><span class="hs-identifier hs-var">NativeReturn</span></a><span> </span><a href="#local-6989586621680938163"><span class="hs-identifier hs-var">reg_exprs</span></a><span> </span><a href="#local-6989586621680938160"><span class="hs-identifier hs-var">lret</span></a><span> </span><a href="#local-6989586621680938161"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621680938167"><span class="hs-identifier hs-var">sp</span></a><span>
</span><a name="line-443"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-444"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkCallReturnsTo"><span class="hs-identifier hs-var">mkCallReturnsTo</span></a><span> </span><a href="#local-6989586621680938165"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="CmmNode.html#NativeReturn"><span class="hs-identifier hs-var">NativeReturn</span></a><span> </span><a href="#local-6989586621680938163"><span class="hs-identifier hs-var">reg_exprs</span></a><span> </span><a href="#local-6989586621680938160"><span class="hs-identifier hs-var">lret</span></a><span> </span><a href="#local-6989586621680938161"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621680938167"><span class="hs-identifier hs-var">sp</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span class="hs-identifier">genericGC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938053"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938053"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-447"></a><a name="genericGC"><a href="StgCmmHeap.html#genericGC"><span class="hs-identifier">genericGC</span></a></a><span> </span><a name="local-6989586621680938170"><a href="#local-6989586621680938170"><span class="hs-identifier">checkYield</span></a></a><span> </span><a name="local-6989586621680938171"><a href="#local-6989586621680938171"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-448"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680938172"><a href="#local-6989586621680938172"><span class="hs-identifier">updfr_sz</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-449"></a><span>       </span><a name="local-6989586621680938173"><a href="#local-6989586621680938173"><span class="hs-identifier">lretry</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-450"></a><span>       </span><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier hs-var">emitLabel</span></a><span> </span><a href="#local-6989586621680938173"><span class="hs-identifier hs-var">lretry</span></a><span>
</span><a name="line-451"></a><span>       </span><a name="local-6989586621680938174"><a href="#local-6989586621680938174"><span class="hs-identifier">call</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#mkCall"><span class="hs-identifier hs-var">mkCall</span></a><span> </span><a href="StgCmmHeap.html#generic_gc"><span class="hs-identifier hs-var">generic_gc</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#GC"><span class="hs-identifier hs-var">GC</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#GC"><span class="hs-identifier hs-var">GC</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680938172"><span class="hs-identifier hs-var">updfr_sz</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-452"></a><span>       </span><a href="StgCmmHeap.html#heapCheck"><span class="hs-identifier hs-var">heapCheck</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680938170"><span class="hs-identifier hs-var">checkYield</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938174"><span class="hs-identifier hs-var">call</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621680938173"><span class="hs-identifier hs-var">lretry</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938171"><span class="hs-identifier hs-var">code</span></a><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span class="hs-identifier">cannedGCEntryPoint</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-455"></a><a name="cannedGCEntryPoint"><a href="StgCmmHeap.html#cannedGCEntryPoint"><span class="hs-identifier">cannedGCEntryPoint</span></a></a><span> </span><a name="local-6989586621680938175"><a href="#local-6989586621680938175"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680938176"><a href="#local-6989586621680938176"><span class="hs-identifier">regs</span></a></a><span>
</span><a name="line-456"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="CmmExpr.html#localRegType"><span class="hs-identifier hs-var">localRegType</span></a><span> </span><a href="#local-6989586621680938176"><span class="hs-identifier hs-var">regs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-457"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_noregs&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>      </span><span class="hs-special">[</span><a name="local-6989586621680938177"><a href="#local-6989586621680938177"><span class="hs-identifier">ty</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-459"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938177"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_unpt_r1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isFloatType</span><span> </span><a href="#local-6989586621680938177"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680938178"><span class="hs-identifier hs-var">width</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-461"></a><span>                                  </span><span class="hs-identifier hs-var">W32</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_f1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-462"></a><span>                                  </span><span class="hs-identifier hs-var">W64</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_d1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>                                  </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938178"><span class="hs-identifier hs-var">width</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">wordWidth</span><span> </span><a href="#local-6989586621680938175"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_unbx_r1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-466"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938178"><span class="hs-identifier hs-var">width</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">W64</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_l1&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-467"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-468"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-469"></a><span>              </span><a name="local-6989586621680938178"><a href="#local-6989586621680938178"><span class="hs-identifier">width</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeWidth</span><span> </span><a href="#local-6989586621680938177"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-470"></a><span>      </span><span class="hs-special">[</span><a name="local-6989586621680938179"><a href="#local-6989586621680938179"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><a name="local-6989586621680938180"><a href="#local-6989586621680938180"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-471"></a><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938179"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-472"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938180"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_pp&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>      </span><span class="hs-special">[</span><a name="local-6989586621680938181"><a href="#local-6989586621680938181"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><a name="local-6989586621680938182"><a href="#local-6989586621680938182"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><a name="local-6989586621680938183"><a href="#local-6989586621680938183"><span class="hs-identifier">ty3</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-474"></a><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938181"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-475"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938182"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-476"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938183"><span class="hs-identifier hs-var">ty3</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_ppp&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>      </span><span class="hs-special">[</span><a name="local-6989586621680938184"><a href="#local-6989586621680938184"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><a name="local-6989586621680938185"><a href="#local-6989586621680938185"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><a name="local-6989586621680938186"><a href="#local-6989586621680938186"><span class="hs-identifier">ty3</span></a></a><span class="hs-special">,</span><a name="local-6989586621680938187"><a href="#local-6989586621680938187"><span class="hs-identifier">ty4</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-478"></a><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938184"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-479"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938185"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-480"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938186"><span class="hs-identifier hs-var">ty3</span></a><span>
</span><a name="line-481"></a><span>          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isGcPtrType</span><span> </span><a href="#local-6989586621680938187"><span class="hs-identifier hs-var">ty4</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_pppp&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>      </span><a name="local-6989586621680938188"><a href="#local-6989586621680938188"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span class="hs-comment">-- Note [stg_gc arguments]</span><span>
</span><a name="line-485"></a><span class="hs-comment">-- It might seem that we could avoid passing the arguments to the</span><span>
</span><a name="line-486"></a><span class="hs-comment">-- stg_gc function, because they are already in the right registers.</span><span>
</span><a name="line-487"></a><span class="hs-comment">-- While this is usually the case, it isn't always.  Sometimes the</span><span>
</span><a name="line-488"></a><span class="hs-comment">-- code generator has cleverly avoided the eval in a case, e.g. in</span><span>
</span><a name="line-489"></a><span class="hs-comment">-- ffi/should_run/4221.hs we found</span><span>
</span><a name="line-490"></a><span class="hs-comment">--</span><span>
</span><a name="line-491"></a><span class="hs-comment">--   case a_r1mb of z</span><span>
</span><a name="line-492"></a><span class="hs-comment">--     FunPtr x y -&gt; ...</span><span>
</span><a name="line-493"></a><span class="hs-comment">--</span><span>
</span><a name="line-494"></a><span class="hs-comment">-- where a_r1mb is bound a top-level constructor, and is known to be</span><span>
</span><a name="line-495"></a><span class="hs-comment">-- evaluated.  The codegen just assigns x, y and z, and continues;</span><span>
</span><a name="line-496"></a><span class="hs-comment">-- R1 is never assigned.</span><span>
</span><a name="line-497"></a><span class="hs-comment">--</span><span>
</span><a name="line-498"></a><span class="hs-comment">-- So we'll have to rely on optimisations to eliminatethese</span><span>
</span><a name="line-499"></a><span class="hs-comment">-- assignments where possible.</span><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span>
</span><a name="line-502"></a><span class="hs-comment">-- | The generic GC procedure; no params, no results</span><span>
</span><a name="line-503"></a><span class="hs-identifier">generic_gc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-504"></a><a name="generic_gc"><a href="StgCmmHeap.html#generic_gc"><span class="hs-identifier">generic_gc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier hs-var">mkGcLabel</span></a><span> </span><span class="hs-string">&quot;stg_gc_noregs&quot;</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-comment">-- | Create a CLabel for calling a garbage collector entry point</span><span>
</span><a name="line-507"></a><span class="hs-identifier">mkGcLabel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-508"></a><a name="mkGcLabel"><a href="StgCmmHeap.html#mkGcLabel"><span class="hs-identifier">mkGcLabel</span></a></a><span> </span><a name="local-6989586621680938189"><a href="#local-6989586621680938189"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#mkCmmCodeLabel"><span class="hs-identifier hs-var">mkCmmCodeLabel</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><a href="#local-6989586621680938189"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span class="hs-comment">-------------------------------</span><span>
</span><a name="line-511"></a><span class="hs-identifier">heapCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938052"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="#local-6989586621680938052"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-512"></a><a name="heapCheck"><a href="StgCmmHeap.html#heapCheck"><span class="hs-identifier">heapCheck</span></a></a><span> </span><a name="local-6989586621680938190"><a href="#local-6989586621680938190"><span class="hs-identifier">checkStack</span></a></a><span> </span><a name="local-6989586621680938191"><a href="#local-6989586621680938191"><span class="hs-identifier">checkYield</span></a></a><span> </span><a name="local-6989586621680938192"><a href="#local-6989586621680938192"><span class="hs-identifier">do_gc</span></a></a><span> </span><a name="local-6989586621680938193"><a href="#local-6989586621680938193"><span class="hs-identifier">code</span></a></a><span>
</span><a name="line-513"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmMonad.html#getHeapUsage"><span class="hs-identifier hs-var">getHeapUsage</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680938194"><a href="#local-6989586621680938194"><span class="hs-identifier">hpHw</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-514"></a><span>    </span><span class="hs-comment">-- Emit heap checks, but be sure to do it lazily so</span><span>
</span><a name="line-515"></a><span>    </span><span class="hs-comment">-- that the conditionals on hpHw don't cause a black hole</span><span>
</span><a name="line-516"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680938195"><a href="#local-6989586621680938195"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-517"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680938196"><a href="#local-6989586621680938196"><span class="hs-identifier">mb_alloc_bytes</span></a></a><span>
</span><a name="line-518"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938194"><span class="hs-identifier hs-var">hpHw</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621680938198"><span class="hs-identifier hs-var">mBLOCK_SIZE</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sorry</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unlines</span><span>
</span><a name="line-519"></a><span>                    </span><span class="hs-special">[</span><span class="hs-string">&quot; Trying to allocate more than &quot;</span><span class="hs-operator hs-var">++</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621680938198"><span class="hs-identifier hs-var">mBLOCK_SIZE</span></a><span class="hs-operator hs-var">++</span><span class="hs-string">&quot; bytes.&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-520"></a><span>                     </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-521"></a><span>                     </span><span class="hs-string">&quot;This is currently not possible due to a limitation of GHC's code generator.&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-522"></a><span>                     </span><span class="hs-string">&quot;See http://ghc.haskell.org/trac/ghc/ticket/4505 for details.&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-523"></a><span>                     </span><span class="hs-string">&quot;Suggestion: read data from a file instead of having large static data&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-524"></a><span>                     </span><span class="hs-string">&quot;structures in code.&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-525"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938194"><span class="hs-identifier hs-var">hpHw</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#mkIntExpr"><span class="hs-identifier hs-var">mkIntExpr</span></a><span> </span><a href="#local-6989586621680938195"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938194"><span class="hs-identifier hs-var">hpHw</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">wORD_SIZE</span><span> </span><a href="#local-6989586621680938195"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-527"></a><span>                 </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680938198"><a href="#local-6989586621680938198"><span class="hs-identifier">mBLOCK_SIZE</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bLOCKS_PER_MBLOCK</span><span> </span><a href="#local-6989586621680938195"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-identifier hs-var">bLOCK_SIZE_W</span><span> </span><a href="#local-6989586621680938195"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-528"></a><span>              </span><a name="local-6989586621680938197"><a href="#local-6989586621680938197"><span class="hs-identifier">stk_hwm</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938190"><span class="hs-identifier hs-var">checkStack</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><a href="CmmExpr.html#CmmHighStackMark"><span class="hs-identifier hs-var">CmmHighStackMark</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-530"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#codeOnly"><span class="hs-identifier hs-var">codeOnly</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmHeap.html#do_checks"><span class="hs-identifier hs-var">do_checks</span></a><span> </span><a href="#local-6989586621680938197"><span class="hs-identifier hs-var">stk_hwm</span></a><span> </span><a href="#local-6989586621680938191"><span class="hs-identifier hs-var">checkYield</span></a><span> </span><a href="#local-6989586621680938196"><span class="hs-identifier hs-var">mb_alloc_bytes</span></a><span> </span><a href="#local-6989586621680938192"><span class="hs-identifier hs-var">do_gc</span></a><span>
</span><a name="line-531"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#tickyAllocHeap"><span class="hs-identifier hs-var">tickyAllocHeap</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621680938194"><span class="hs-identifier hs-var">hpHw</span></a><span>
</span><a name="line-532"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#setRealHp"><span class="hs-identifier hs-var">setRealHp</span></a><span> </span><a href="#local-6989586621680938194"><span class="hs-identifier hs-var">hpHw</span></a><span>
</span><a name="line-533"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680938193"><span class="hs-identifier hs-var">code</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span class="hs-identifier">heapStackCheckGen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-536"></a><a name="heapStackCheckGen"><a href="StgCmmHeap.html#heapStackCheckGen"><span class="hs-identifier">heapStackCheckGen</span></a></a><span> </span><a name="local-6989586621680938199"><a href="#local-6989586621680938199"><span class="hs-identifier">stk_hwm</span></a></a><span> </span><a name="local-6989586621680938200"><a href="#local-6989586621680938200"><span class="hs-identifier">mb_bytes</span></a></a><span>
</span><a name="line-537"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680938201"><a href="#local-6989586621680938201"><span class="hs-identifier">updfr_sz</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-538"></a><span>       </span><a name="local-6989586621680938202"><a href="#local-6989586621680938202"><span class="hs-identifier">lretry</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-539"></a><span>       </span><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier hs-var">emitLabel</span></a><span> </span><a href="#local-6989586621680938202"><span class="hs-identifier hs-var">lretry</span></a><span>
</span><a name="line-540"></a><span>       </span><a name="local-6989586621680938203"><a href="#local-6989586621680938203"><span class="hs-identifier">call</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#mkCall"><span class="hs-identifier hs-var">mkCall</span></a><span> </span><a href="StgCmmHeap.html#generic_gc"><span class="hs-identifier hs-var">generic_gc</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#GC"><span class="hs-identifier hs-var">GC</span></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#GC"><span class="hs-identifier hs-var">GC</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680938201"><span class="hs-identifier hs-var">updfr_sz</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-541"></a><span>       </span><a href="StgCmmHeap.html#do_checks"><span class="hs-identifier hs-var">do_checks</span></a><span> </span><a href="#local-6989586621680938199"><span class="hs-identifier hs-var">stk_hwm</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680938200"><span class="hs-identifier hs-var">mb_bytes</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938203"><span class="hs-identifier hs-var">call</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621680938202"><span class="hs-identifier hs-var">lretry</span></a><span class="hs-special">)</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">-- Note [Single stack check]</span><span>
</span><a name="line-544"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-545"></a><span class="hs-comment">-- When compiling a function we can determine how much stack space it</span><span>
</span><a name="line-546"></a><span class="hs-comment">-- will use. We therefore need to perform only a single stack check at</span><span>
</span><a name="line-547"></a><span class="hs-comment">-- the beginning of a function to see if we have enough stack space.</span><span>
</span><a name="line-548"></a><span class="hs-comment">--</span><span>
</span><a name="line-549"></a><span class="hs-comment">-- The check boils down to comparing Sp-N with SpLim, where N is the</span><span>
</span><a name="line-550"></a><span class="hs-comment">-- amount of stack space needed (see Note [Stack usage] below).  *BUT*</span><span>
</span><a name="line-551"></a><span class="hs-comment">-- at this stage of the pipeline we are not supposed to refer to Sp</span><span>
</span><a name="line-552"></a><span class="hs-comment">-- itself, because the stack is not yet manifest, so we don't quite</span><span>
</span><a name="line-553"></a><span class="hs-comment">-- know where Sp pointing.</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span class="hs-comment">-- So instead of referring directly to Sp - as we used to do in the</span><span>
</span><a name="line-556"></a><span class="hs-comment">-- past - the code generator uses (old + 0) in the stack check. That</span><span>
</span><a name="line-557"></a><span class="hs-comment">-- is the address of the first word of the old area, so if we add N</span><span>
</span><a name="line-558"></a><span class="hs-comment">-- we'll get the address of highest used word.</span><span>
</span><a name="line-559"></a><span class="hs-comment">--</span><span>
</span><a name="line-560"></a><span class="hs-comment">-- This makes the check robust.  For example, while we need to perform</span><span>
</span><a name="line-561"></a><span class="hs-comment">-- only one stack check for each function, we could in theory place</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- more stack checks later in the function. They would be redundant,</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- but not incorrect (in a sense that they should not change program</span><span>
</span><a name="line-564"></a><span class="hs-comment">-- behaviour). We need to make sure however that a stack check</span><span>
</span><a name="line-565"></a><span class="hs-comment">-- inserted after incrementing the stack pointer checks for a</span><span>
</span><a name="line-566"></a><span class="hs-comment">-- respectively smaller stack space. This would not be the case if the</span><span>
</span><a name="line-567"></a><span class="hs-comment">-- code generator produced direct references to Sp. By referencing</span><span>
</span><a name="line-568"></a><span class="hs-comment">-- (old + 0) we make sure that we always check for a correct amount of</span><span>
</span><a name="line-569"></a><span class="hs-comment">-- stack: when converting (old + 0) to Sp the stack layout phase takes</span><span>
</span><a name="line-570"></a><span class="hs-comment">-- into account changes already made to stack pointer. The idea for</span><span>
</span><a name="line-571"></a><span class="hs-comment">-- this change came from observations made while debugging #8275.</span><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span class="hs-comment">-- Note [Stack usage]</span><span>
</span><a name="line-574"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-575"></a><span class="hs-comment">-- At the moment we convert from STG to Cmm we don't know N, the</span><span>
</span><a name="line-576"></a><span class="hs-comment">-- number of bytes of stack that the function will use, so we use a</span><span>
</span><a name="line-577"></a><span class="hs-comment">-- special late-bound CmmLit, namely</span><span>
</span><a name="line-578"></a><span class="hs-comment">--       CmmHighStackMark</span><span>
</span><a name="line-579"></a><span class="hs-comment">-- to stand for the number of bytes needed. When the stack is made</span><span>
</span><a name="line-580"></a><span class="hs-comment">-- manifest, the number of bytes needed is calculated, and used to</span><span>
</span><a name="line-581"></a><span class="hs-comment">-- replace occurrences of CmmHighStackMark</span><span>
</span><a name="line-582"></a><span class="hs-comment">--</span><span>
</span><a name="line-583"></a><span class="hs-comment">-- The (Maybe CmmExpr) passed to do_checks is usually</span><span>
</span><a name="line-584"></a><span class="hs-comment">--     Just (CmmLit CmmHighStackMark)</span><span>
</span><a name="line-585"></a><span class="hs-comment">-- but can also (in certain hand-written RTS functions)</span><span>
</span><a name="line-586"></a><span class="hs-comment">--     Just (CmmLit 8)  or some other fixed valuet</span><span>
</span><a name="line-587"></a><span class="hs-comment">-- If it is Nothing, we don't generate a stack check at all.</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span class="hs-identifier">do_checks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>    </span><span class="hs-comment">-- Should we check the stack?</span><span>
</span><a name="line-590"></a><span>                              </span><span class="hs-comment">-- See Note [Stack usage]</span><span>
</span><a name="line-591"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>             </span><span class="hs-comment">-- Should we check for preemption?</span><span>
</span><a name="line-592"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>    </span><span class="hs-comment">-- Heap headroom (bytes)</span><span>
</span><a name="line-593"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>        </span><span class="hs-comment">-- What to do on failure</span><span>
</span><a name="line-594"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-595"></a><a name="do_checks"><a href="StgCmmHeap.html#do_checks"><span class="hs-identifier">do_checks</span></a></a><span> </span><a name="local-6989586621680938204"><a href="#local-6989586621680938204"><span class="hs-identifier">mb_stk_hwm</span></a></a><span> </span><a name="local-6989586621680938205"><a href="#local-6989586621680938205"><span class="hs-identifier">checkYield</span></a></a><span> </span><a name="local-6989586621680938206"><a href="#local-6989586621680938206"><span class="hs-identifier">mb_alloc_lit</span></a></a><span> </span><a name="local-6989586621680938207"><a href="#local-6989586621680938207"><span class="hs-identifier">do_gc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-596"></a><span>  </span><a name="local-6989586621680938208"><a href="#local-6989586621680938208"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-597"></a><span>  </span><a name="local-6989586621680938209"><a href="#local-6989586621680938209"><span class="hs-identifier">gc_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-600"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680938210"><a href="#local-6989586621680938210"><span class="hs-identifier">alloc_lit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680938206"><span class="hs-identifier hs-var">mb_alloc_lit</span></a><span>
</span><a name="line-601"></a><span>
</span><a name="line-602"></a><span>    </span><a name="local-6989586621680938211"><a href="#local-6989586621680938211"><span class="hs-identifier">bump_hp</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cmmOffsetExprB"><span class="hs-identifier hs-var">cmmOffsetExprB</span></a><span> </span><a href="#local-6989586621680938208"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmUtils.html#hpExpr"><span class="hs-identifier hs-var">hpExpr</span></a><span> </span><a href="#local-6989586621680938210"><span class="hs-identifier hs-var">alloc_lit</span></a><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span>    </span><span class="hs-comment">-- Sp overflow if ((old + 0) - CmmHighStack &lt; SpLim)</span><span>
</span><a name="line-605"></a><span>    </span><span class="hs-comment">-- At the beginning of a function old + 0 = Sp</span><span>
</span><a name="line-606"></a><span>    </span><span class="hs-comment">-- See Note [Single stack check]</span><span>
</span><a name="line-607"></a><span>    </span><a name="local-6989586621680938212"><a href="#local-6989586621680938212"><span class="hs-identifier">sp_oflo</span></a></a><span> </span><a name="local-6989586621680938215"><a href="#local-6989586621680938215"><span class="hs-identifier">sp_hwm</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-608"></a><span>         </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_wordULt"><span class="hs-identifier hs-var">mo_wordULt</span></a><span> </span><a href="#local-6989586621680938208"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-609"></a><span>                  </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#MO_Sub"><span class="hs-identifier hs-var">MO_Sub</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeWidth</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#cmmRegType"><span class="hs-identifier hs-var">cmmRegType</span></a><span> </span><a href="#local-6989586621680938208"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmExpr.html#spReg"><span class="hs-identifier hs-var">spReg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-610"></a><span>                             </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><a href="CmmExpr.html#Old"><span class="hs-identifier hs-var">Old</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680938215"><span class="hs-identifier hs-var">sp_hwm</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-611"></a><span>                   </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="CmmExpr.html#spLimReg"><span class="hs-identifier hs-var">spLimReg</span></a><span class="hs-special">]</span><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span>    </span><span class="hs-comment">-- Hp overflow if (Hp &gt; HpLim)</span><span>
</span><a name="line-614"></a><span>    </span><span class="hs-comment">-- (Hp has been incremented by now)</span><span>
</span><a name="line-615"></a><span>    </span><span class="hs-comment">-- HpLim points to the LAST WORD of valid allocation space.</span><span>
</span><a name="line-616"></a><span>    </span><a name="local-6989586621680938213"><a href="#local-6989586621680938213"><span class="hs-identifier">hp_oflo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_wordUGt"><span class="hs-identifier hs-var">mo_wordUGt</span></a><span> </span><a href="#local-6989586621680938208"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="CmmUtils.html#hpExpr"><span class="hs-identifier hs-var">hpExpr</span></a><span class="hs-special">,</span><span> </span><a href="CmmUtils.html#hpLimExpr"><span class="hs-identifier hs-var">hpLimExpr</span></a><span class="hs-special">]</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span>    </span><a name="local-6989586621680938214"><a href="#local-6989586621680938214"><span class="hs-identifier">alloc_n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkAssign"><span class="hs-identifier hs-var">mkAssign</span></a><span> </span><a href="CmmExpr.html#hpAllocReg"><span class="hs-identifier hs-var">hpAllocReg</span></a><span> </span><a href="#local-6989586621680938210"><span class="hs-identifier hs-var">alloc_lit</span></a><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680938204"><span class="hs-identifier hs-var">mb_stk_hwm</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-621"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-622"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680938216"><a href="#local-6989586621680938216"><span class="hs-identifier">stk_hwm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmTicky.html#tickyStackCheck"><span class="hs-identifier hs-var">tickyStackCheck</span></a><span>
</span><a name="line-623"></a><span>      </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="StgCmmMonad.html#mkCmmIfGoto%27"><span class="hs-identifier hs-var">mkCmmIfGoto'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938212"><span class="hs-identifier hs-var">sp_oflo</span></a><span> </span><a href="#local-6989586621680938216"><span class="hs-identifier hs-var">stk_hwm</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680938209"><span class="hs-identifier hs-var">gc_id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span>  </span><span class="hs-comment">-- Emit new label that might potentially be a header</span><span>
</span><a name="line-626"></a><span>  </span><span class="hs-comment">-- of a self-recursive tail call.</span><span>
</span><a name="line-627"></a><span>  </span><span class="hs-comment">-- See Note [Self-recursive loop header].</span><span>
</span><a name="line-628"></a><span>  </span><a name="local-6989586621680938217"><a href="#local-6989586621680938217"><span class="hs-identifier">self_loop_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getSelfLoop"><span class="hs-identifier hs-var">getSelfLoop</span></a><span>
</span><a name="line-629"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680938217"><span class="hs-identifier hs-var">self_loop_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-630"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680938218"><a href="#local-6989586621680938218"><span class="hs-identifier">loop_header_id</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-631"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680938205"><span class="hs-identifier hs-var">checkYield</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621680938204"><span class="hs-identifier hs-var">mb_stk_hwm</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#emitLabel"><span class="hs-identifier hs-var">emitLabel</span></a><span> </span><a href="#local-6989586621680938218"><span class="hs-identifier hs-var">loop_header_id</span></a><span>
</span><a name="line-632"></a><span>    </span><a name="local-6989586621680938219"><a href="#local-6989586621680938219"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>
</span><a name="line-634"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621680938206"><span class="hs-identifier hs-var">mb_alloc_lit</span></a><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-636"></a><span>     </span><a href="StgCmmTicky.html#tickyHeapCheck"><span class="hs-identifier hs-var">tickyHeapCheck</span></a><span>
</span><a name="line-637"></a><span>     </span><a href="StgCmmMonad.html#emitAssign"><span class="hs-identifier hs-var">emitAssign</span></a><span> </span><a href="CmmExpr.html#hpReg"><span class="hs-identifier hs-var">hpReg</span></a><span> </span><a href="#local-6989586621680938211"><span class="hs-identifier hs-var">bump_hp</span></a><span>
</span><a name="line-638"></a><span>     </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="StgCmmMonad.html#mkCmmIfThen%27"><span class="hs-identifier hs-var">mkCmmIfThen'</span></a><span> </span><a href="#local-6989586621680938213"><span class="hs-identifier hs-var">hp_oflo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938214"><span class="hs-identifier hs-var">alloc_n</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="MkGraph.html#mkBranch"><span class="hs-identifier hs-var">mkBranch</span></a><span> </span><a href="#local-6989586621680938209"><span class="hs-identifier hs-var">gc_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-639"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-640"></a><span>      </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680938205"><span class="hs-identifier hs-var">checkYield</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_OmitYields</span><span> </span><a href="#local-6989586621680938208"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-641"></a><span>         </span><span class="hs-comment">-- Yielding if HpLim == 0</span><span>
</span><a name="line-642"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680938220"><a href="#local-6989586621680938220"><span class="hs-identifier">yielding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_wordEq"><span class="hs-identifier hs-var">mo_wordEq</span></a><span> </span><a href="#local-6989586621680938208"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>                                  </span><span class="hs-special">[</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="CmmExpr.html#hpLimReg"><span class="hs-identifier hs-var">hpLimReg</span></a><span class="hs-special">,</span><span>
</span><a name="line-644"></a><span>                                   </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#zeroCLit"><span class="hs-identifier hs-var">zeroCLit</span></a><span> </span><a href="#local-6989586621680938208"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-645"></a><span>         </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="StgCmmMonad.html#mkCmmIfGoto%27"><span class="hs-identifier hs-var">mkCmmIfGoto'</span></a><span> </span><a href="#local-6989586621680938220"><span class="hs-identifier hs-var">yielding</span></a><span> </span><a href="#local-6989586621680938209"><span class="hs-identifier hs-var">gc_id</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span>
</span><a name="line-647"></a><span>  </span><a name="local-6989586621680938221"><a href="#local-6989586621680938221"><span class="hs-identifier">tscope</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-648"></a><span>  </span><a href="StgCmmMonad.html#emitOutOfLine"><span class="hs-identifier hs-var">emitOutOfLine</span></a><span> </span><a href="#local-6989586621680938209"><span class="hs-identifier hs-var">gc_id</span></a><span>
</span><a name="line-649"></a><span>   </span><span class="hs-special">(</span><a href="#local-6989586621680938207"><span class="hs-identifier hs-var">do_gc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680938221"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- this is expected to jump back somewhere</span><span>
</span><a name="line-650"></a><span>
</span><a name="line-651"></a><span>                </span><span class="hs-comment">-- Test for stack pointer exhaustion, then</span><span>
</span><a name="line-652"></a><span>                </span><span class="hs-comment">-- bump heap pointer, and test for heap exhaustion</span><span>
</span><a name="line-653"></a><span>                </span><span class="hs-comment">-- Note that we don't move the heap pointer unless the</span><span>
</span><a name="line-654"></a><span>                </span><span class="hs-comment">-- stack check succeeds.  Otherwise we might end up</span><span>
</span><a name="line-655"></a><span>                </span><span class="hs-comment">-- with slop at the end of the current block, which can</span><span>
</span><a name="line-656"></a><span>                </span><span class="hs-comment">-- confuse the LDV profiler.</span><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span class="hs-comment">-- Note [Self-recursive loop header]</span><span>
</span><a name="line-659"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-660"></a><span class="hs-comment">--</span><span>
</span><a name="line-661"></a><span class="hs-comment">-- Self-recursive loop header is required by loopification optimization (See</span><span>
</span><a name="line-662"></a><span class="hs-comment">-- Note [Self-recursive tail calls] in StgCmmExpr). We emit it if:</span><span>
</span><a name="line-663"></a><span class="hs-comment">--</span><span>
</span><a name="line-664"></a><span class="hs-comment">--  1. There is information about self-loop in the FCode environment. We don't</span><span>
</span><a name="line-665"></a><span class="hs-comment">--     check the binder (first component of the self_loop_info) because we are</span><span>
</span><a name="line-666"></a><span class="hs-comment">--     certain that if the self-loop info is present then we are compiling the</span><span>
</span><a name="line-667"></a><span class="hs-comment">--     binder body. Reason: the only possible way to get here with the</span><span>
</span><a name="line-668"></a><span class="hs-comment">--     self_loop_info present is from closureCodeBody.</span><span>
</span><a name="line-669"></a><span class="hs-comment">--</span><span>
</span><a name="line-670"></a><span class="hs-comment">--  2. checkYield &amp;&amp; isJust mb_stk_hwm. checkYield tells us that it is possible</span><span>
</span><a name="line-671"></a><span class="hs-comment">--     to preempt the heap check (see #367 for motivation behind this check). It</span><span>
</span><a name="line-672"></a><span class="hs-comment">--     is True for heap checks placed at the entry to a function and</span><span>
</span><a name="line-673"></a><span class="hs-comment">--     let-no-escape heap checks but false for other heap checks (eg. in case</span><span>
</span><a name="line-674"></a><span class="hs-comment">--     alternatives or created from hand-written high-level Cmm). The second</span><span>
</span><a name="line-675"></a><span class="hs-comment">--     check (isJust mb_stk_hwm) is true for heap checks at the entry to a</span><span>
</span><a name="line-676"></a><span class="hs-comment">--     function and some heap checks created in hand-written Cmm. Otherwise it</span><span>
</span><a name="line-677"></a><span class="hs-comment">--     is Nothing. In other words the only situation when both conditions are</span><span>
</span><a name="line-678"></a><span class="hs-comment">--     true is when compiling stack and heap checks at the entry to a</span><span>
</span><a name="line-679"></a><span class="hs-comment">--     function. This is the only situation when we want to emit a self-loop</span><span>
</span><a name="line-680"></a><span class="hs-comment">--     label.</span><span>
</span><a name="line-681"></a></pre></body></html>