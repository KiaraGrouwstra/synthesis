<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Error-checking and other utilities for @deriving@ clauses or declarations.
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcDerivUtils</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>        </span><a href="TcDerivUtils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#DerivEnv"><span class="hs-identifier hs-type">DerivEnv</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>        </span><a href="TcDerivUtils.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#pprDerivSpec"><span class="hs-identifier hs-var">pprDerivSpec</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="TcDerivUtils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#derivSpecMechanismToStrategy"><span class="hs-identifier hs-var">derivSpecMechanismToStrategy</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#isDerivSpecStock"><span class="hs-identifier hs-var">isDerivSpecStock</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="TcDerivUtils.html#isDerivSpecNewtype"><span class="hs-identifier hs-var">isDerivSpecNewtype</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#isDerivSpecAnyClass"><span class="hs-identifier hs-var">isDerivSpecAnyClass</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#isDerivSpecVia"><span class="hs-identifier hs-var">isDerivSpecVia</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#OriginativeDerivStatus"><span class="hs-identifier hs-type">OriginativeDerivStatus</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="TcDerivUtils.html#isStandaloneDeriv"><span class="hs-identifier hs-var">isStandaloneDeriv</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#isStandaloneWildcardDeriv"><span class="hs-identifier hs-var">isStandaloneWildcardDeriv</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#mkDerivOrigin"><span class="hs-identifier hs-var">mkDerivOrigin</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#mkPredOrigin"><span class="hs-identifier hs-var">mkPredOrigin</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="TcDerivUtils.html#mkThetaOrigin"><span class="hs-identifier hs-var">mkThetaOrigin</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#mkThetaOriginFromPreds"><span class="hs-identifier hs-var">mkThetaOriginFromPreds</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#substPredOrigin"><span class="hs-identifier hs-var">substPredOrigin</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="TcDerivUtils.html#checkOriginativeSideConditions"><span class="hs-identifier hs-var">checkOriginativeSideConditions</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#hasStockDeriving"><span class="hs-identifier hs-var">hasStockDeriving</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="TcDerivUtils.html#canDeriveAnyClass"><span class="hs-identifier hs-var">canDeriveAnyClass</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="TcDerivUtils.html#std_class_via_coercible"><span class="hs-identifier hs-var">std_class_via_coercible</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#non_coercible_class"><span class="hs-identifier hs-var">non_coercible_class</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="TcDerivUtils.html#newDerivClsInst"><span class="hs-identifier hs-var">newDerivClsInst</span></a><span class="hs-special">,</span><span> </span><a href="TcDerivUtils.html#extendLocalInstEnv"><span class="hs-identifier hs-var">extendLocalInstEnv</span></a><span>
</span><a name="line-24"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupFixity</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mi_fix</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadInterfaceForName"><span class="hs-identifier hs-var">loadInterfaceForName</span></a><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getModule</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcGenDeriv.html"><span class="hs-identifier">TcGenDeriv</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="TcGenFunctor.html"><span class="hs-identifier">TcGenFunctor</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="TcGenGenerics.html"><span class="hs-identifier">TcGenGenerics</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="THNames.html"><span class="hs-identifier">THNames</span></a><span> </span><span class="hs-special">(</span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans.Reader</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">assocMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- | To avoid having to manually plumb everything in 'DerivEnv' throughout</span><span>
</span><a name="line-61"></a><span class="hs-comment">-- various functions in @TcDeriv@ and @TcDerivInfer@, we use 'DerivM', which</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- is a simple reader around 'TcRn'.</span><span>
</span><a name="line-63"></a><span class="hs-keyword">type</span><span> </span><a name="DerivM"><a href="TcDerivUtils.html#DerivM"><span class="hs-identifier">DerivM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="TcDerivUtils.html#DerivEnv"><span class="hs-identifier hs-type">DerivEnv</span></a><span> </span><span class="hs-identifier hs-type">TcRn</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- | Is GHC processing a standalone deriving declaration?</span><span>
</span><a name="line-66"></a><span class="hs-identifier">isStandaloneDeriv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-67"></a><a name="isStandaloneDeriv"><a href="TcDerivUtils.html#isStandaloneDeriv"><span class="hs-identifier">isStandaloneDeriv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349204"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">denv_ctxt</span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-69"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-70"></a><span>    </span><a name="local-6989586621683349204"><a href="#local-6989586621683349204"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#InferContext"><span class="hs-identifier hs-var">InferContext</span></a><span> </span><a name="local-6989586621683349205"><a href="#local-6989586621683349205"><span class="hs-identifier">wildcard</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621683349205"><span class="hs-identifier hs-var">wildcard</span></a><span>
</span><a name="line-71"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#SupplyContext"><span class="hs-identifier hs-var">SupplyContext</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- | Is GHC processing a standalone deriving declaration with an</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- extra-constraints wildcard as the context?</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- (e.g., @deriving instance _ =&gt; Eq (Foo a)@)</span><span>
</span><a name="line-76"></a><span class="hs-identifier">isStandaloneWildcardDeriv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivM"><span class="hs-identifier hs-type">DerivM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-77"></a><a name="isStandaloneWildcardDeriv"><a href="TcDerivUtils.html#isStandaloneWildcardDeriv"><span class="hs-identifier">isStandaloneWildcardDeriv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">asks</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349206"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">denv_ctxt</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-79"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-80"></a><span>    </span><a name="local-6989586621683349206"><a href="#local-6989586621683349206"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#InferContext"><span class="hs-identifier hs-var">InferContext</span></a><span> </span><a name="local-6989586621683349207"><a href="#local-6989586621683349207"><span class="hs-identifier">wildcard</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621683349207"><span class="hs-identifier hs-var">wildcard</span></a><span>
</span><a name="line-81"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#SupplyContext"><span class="hs-identifier hs-var">SupplyContext</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span class="hs-comment">-- | @'mkDerivOrigin' wc@ returns 'StandAloneDerivOrigin' if @wc@ is 'True',</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- and 'DerivClauseOrigin' if @wc@ is 'False'. Useful for error-reporting.</span><span>
</span><a name="line-85"></a><span class="hs-identifier">mkDerivOrigin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>
</span><a name="line-86"></a><a name="mkDerivOrigin"><a href="TcDerivUtils.html#mkDerivOrigin"><span class="hs-identifier">mkDerivOrigin</span></a></a><span> </span><a name="local-6989586621683349208"><a href="#local-6989586621683349208"><span class="hs-identifier">standalone_wildcard</span></a></a><span>
</span><a name="line-87"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349208"><span class="hs-identifier hs-var">standalone_wildcard</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">StandAloneDerivOrigin</span><span>
</span><a name="line-88"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DerivClauseOrigin</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">-- | Contains all of the information known about a derived instance when</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- determining what its @EarlyDerivSpec@ should be.</span><span>
</span><a name="line-92"></a><span class="hs-keyword">data</span><span> </span><a name="DerivEnv"><a href="TcDerivUtils.html#DerivEnv"><span class="hs-identifier">DerivEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DerivEnv"><a href="TcDerivUtils.html#DerivEnv"><span class="hs-identifier">DerivEnv</span></a></a><span>
</span><a name="line-93"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="denv_overlap_mode"><a href="TcDerivUtils.html#denv_overlap_mode"><span class="hs-identifier">denv_overlap_mode</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">OverlapMode</span><span>
</span><a name="line-94"></a><span>    </span><span class="hs-comment">-- ^ Is this an overlapping instance?</span><span>
</span><a name="line-95"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_tvs"><a href="TcDerivUtils.html#denv_tvs"><span class="hs-identifier">denv_tvs</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-comment">-- ^ Universally quantified type variables in the instance</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_cls"><a href="TcDerivUtils.html#denv_cls"><span class="hs-identifier">denv_cls</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span>
</span><a name="line-98"></a><span>    </span><span class="hs-comment">-- ^ Class for which we need to derive an instance</span><span>
</span><a name="line-99"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_cls_tys"><a href="TcDerivUtils.html#denv_cls_tys"><span class="hs-identifier">denv_cls_tys</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-comment">-- ^ Other arguments to the class except the last</span><span>
</span><a name="line-101"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_tc"><a href="TcDerivUtils.html#denv_tc"><span class="hs-identifier">denv_tc</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-comment">-- ^ Type constructor for which the instance is requested</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-comment">--   (last arguments to the type class)</span><span>
</span><a name="line-104"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_tc_args"><a href="TcDerivUtils.html#denv_tc_args"><span class="hs-identifier">denv_tc_args</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-comment">-- ^ Arguments to the type constructor</span><span>
</span><a name="line-106"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_rep_tc"><a href="TcDerivUtils.html#denv_rep_tc"><span class="hs-identifier">denv_rep_tc</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-107"></a><span>    </span><span class="hs-comment">-- ^ The representation tycon for 'denv_tc'</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-comment">--   (for data family instances)</span><span>
</span><a name="line-109"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_rep_tc_args"><a href="TcDerivUtils.html#denv_rep_tc_args"><span class="hs-identifier">denv_rep_tc_args</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-comment">-- ^ The representation types for 'denv_tc_args'</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-comment">--   (for data family instances)</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_ctxt"><a href="TcDerivUtils.html#denv_ctxt"><span class="hs-identifier">denv_ctxt</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-comment">-- ^ @'SupplyContext' theta@ for standalone deriving (where @theta@ is the</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-comment">--   context of the instance).</span><span>
</span><a name="line-115"></a><span>    </span><span class="hs-comment">--   'InferContext' for @deriving@ clauses, or for standalone deriving that</span><span>
</span><a name="line-116"></a><span>    </span><span class="hs-comment">--   uses a wildcard constraint.</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-comment">--   See @Note [Inferring the instance context]@.</span><span>
</span><a name="line-118"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="denv_strat"><a href="TcDerivUtils.html#denv_strat"><span class="hs-identifier">denv_strat</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>    </span><span class="hs-comment">-- ^ 'Just' if user requests a particular deriving strategy.</span><span>
</span><a name="line-120"></a><span>    </span><span class="hs-comment">--   Otherwise, 'Nothing'.</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-122"></a><span>
</span><a name="line-123"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcDerivUtils.html#DerivEnv"><span class="hs-identifier hs-type">DerivEnv</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-124"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivEnv"><span class="hs-identifier hs-var">DerivEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">denv_overlap_mode</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349191"><a href="#local-6989586621683349191"><span class="hs-identifier">overlap_mode</span></a></a><span>
</span><a name="line-125"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_tvs</span><span>          </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349192"><a href="#local-6989586621683349192"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-126"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_cls</span><span>          </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349193"><a href="#local-6989586621683349193"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-127"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_cls_tys</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349194"><a href="#local-6989586621683349194"><span class="hs-identifier">cls_tys</span></a></a><span>
</span><a name="line-128"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_tc</span><span>           </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349195"><a href="#local-6989586621683349195"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-129"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_tc_args</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349196"><a href="#local-6989586621683349196"><span class="hs-identifier">tc_args</span></a></a><span>
</span><a name="line-130"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_rep_tc</span><span>       </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349197"><a href="#local-6989586621683349197"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-131"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_rep_tc_args</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349198"><a href="#local-6989586621683349198"><span class="hs-identifier">rep_tc_args</span></a></a><span>
</span><a name="line-132"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_ctxt</span><span>         </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349199"><a href="#local-6989586621683349199"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-133"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">denv_strat</span><span>        </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349200"><a href="#local-6989586621683349200"><span class="hs-identifier">mb_strat</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DerivEnv&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_overlap_mode&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349191"><span class="hs-identifier hs-var">overlap_mode</span></a><span>
</span><a name="line-136"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_tvs&quot;</span><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349192"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-137"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_cls&quot;</span><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349193"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-138"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_cls_tys&quot;</span><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349194"><span class="hs-identifier hs-var">cls_tys</span></a><span>
</span><a name="line-139"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_tc&quot;</span><span>           </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349195"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-140"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_tc_args&quot;</span><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349196"><span class="hs-identifier hs-var">tc_args</span></a><span>
</span><a name="line-141"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_rep_tc&quot;</span><span>       </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349197"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-142"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_rep_tc_args&quot;</span><span>  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349198"><span class="hs-identifier hs-var">rep_tc_args</span></a><span>
</span><a name="line-143"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_ctxt&quot;</span><span>         </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349199"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-144"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;denv_strat&quot;</span><span>        </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349200"><span class="hs-identifier hs-var">mb_strat</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-keyword">data</span><span> </span><a name="DerivSpec"><a href="TcDerivUtils.html#DerivSpec"><span class="hs-identifier">DerivSpec</span></a></a><span> </span><a name="local-6989586621683349180"><a href="#local-6989586621683349180"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DS"><a href="TcDerivUtils.html#DS"><span class="hs-identifier">DS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ds_loc"><a href="TcDerivUtils.html#ds_loc"><span class="hs-identifier">ds_loc</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-147"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_name"><a href="TcDerivUtils.html#ds_name"><span class="hs-identifier">ds_name</span></a></a><span>                </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>         </span><span class="hs-comment">-- DFun name</span><span>
</span><a name="line-148"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_tvs"><a href="TcDerivUtils.html#ds_tvs"><span class="hs-identifier">ds_tvs</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span>
</span><a name="line-149"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_theta"><a href="TcDerivUtils.html#ds_theta"><span class="hs-identifier">ds_theta</span></a></a><span>               </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621683349180"><span class="hs-identifier hs-type">theta</span></a><span>
</span><a name="line-150"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_cls"><a href="TcDerivUtils.html#ds_cls"><span class="hs-identifier">ds_cls</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span>
</span><a name="line-151"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_tys"><a href="TcDerivUtils.html#ds_tys"><span class="hs-identifier">ds_tys</span></a></a><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-152"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_tc"><a href="TcDerivUtils.html#ds_tc"><span class="hs-identifier">ds_tc</span></a></a><span>                  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-153"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_overlap"><a href="TcDerivUtils.html#ds_overlap"><span class="hs-identifier">ds_overlap</span></a></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">OverlapMode</span><span>
</span><a name="line-154"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_standalone_wildcard"><a href="TcDerivUtils.html#ds_standalone_wildcard"><span class="hs-identifier">ds_standalone_wildcard</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-155"></a><span>                              </span><span class="hs-comment">-- See Note [Inferring the instance context]</span><span>
</span><a name="line-156"></a><span>                              </span><span class="hs-comment">-- in TcDerivInfer</span><span>
</span><a name="line-157"></a><span>                          </span><span class="hs-special">,</span><span> </span><a name="ds_mechanism"><a href="TcDerivUtils.html#ds_mechanism"><span class="hs-identifier">ds_mechanism</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-158"></a><span>        </span><span class="hs-comment">-- This spec implies a dfun declaration of the form</span><span>
</span><a name="line-159"></a><span>        </span><span class="hs-comment">--       df :: forall tvs. theta =&gt; C tys</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-comment">-- The Name is the name for the DFun we'll build</span><span>
</span><a name="line-161"></a><span>        </span><span class="hs-comment">-- The tyvars bind all the variables in the theta</span><span>
</span><a name="line-162"></a><span>        </span><span class="hs-comment">-- For type families, the tycon in</span><span>
</span><a name="line-163"></a><span>        </span><span class="hs-comment">--       in ds_tys is the *family* tycon</span><span>
</span><a name="line-164"></a><span>        </span><span class="hs-comment">--       in ds_tc is the *representation* type</span><span>
</span><a name="line-165"></a><span>        </span><span class="hs-comment">-- For non-family tycons, both are the same</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span>        </span><span class="hs-comment">-- the theta is either the given and final theta, in standalone deriving,</span><span>
</span><a name="line-168"></a><span>        </span><span class="hs-comment">-- or the not-yet-simplified list of constraints together with their origin</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span>        </span><span class="hs-comment">-- ds_mechanism specifies the means by which GHC derives the instance.</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-comment">-- See Note [Deriving strategies] in TcDeriv</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-comment">{-
Example:

     newtype instance T [a] = MkT (Tree a) deriving( C s )
==&gt;
     axiom T [a] = :RTList a
     axiom :RTList a = Tree a

     DS { ds_tvs = [a,s], ds_cls = C, ds_tys = [s, T [a]]
        , ds_tc = :RTList, ds_mechanism = DerivSpecNewtype (Tree a) }
-}</span><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-identifier">pprDerivSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621683349203"><span class="hs-identifier hs-type">theta</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TcDerivUtils.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="#local-6989586621683349203"><span class="hs-identifier hs-type">theta</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-186"></a><a name="pprDerivSpec"><a href="TcDerivUtils.html#pprDerivSpec"><span class="hs-identifier">pprDerivSpec</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DS"><span class="hs-identifier hs-var">DS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_loc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349209"><a href="#local-6989586621683349209"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349210"><a href="#local-6989586621683349210"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349211"><a href="#local-6989586621683349211"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349212"><a href="#local-6989586621683349212"><span class="hs-identifier">c</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-187"></a><span>                   </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349213"><a href="#local-6989586621683349213"><span class="hs-identifier">tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_theta</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349214"><a href="#local-6989586621683349214"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-188"></a><span>                   </span><span class="hs-identifier">ds_standalone_wildcard</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349215"><a href="#local-6989586621683349215"><span class="hs-identifier">wildcard</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_mechanism</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349216"><a href="#local-6989586621683349216"><span class="hs-identifier">mech</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DerivSpec&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ds_loc                  =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349209"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-191"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ds_name                 =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349210"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-192"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ds_tvs                  =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349211"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-193"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ds_cls                  =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349212"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-194"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ds_tys                  =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349213"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-195"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ds_theta                =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349214"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-196"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ds_standalone_wildcard  =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349215"><span class="hs-identifier hs-var">wildcard</span></a><span>
</span><a name="line-197"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ds_mechanism            =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349216"><span class="hs-identifier hs-var">mech</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621683349190"><span class="hs-identifier hs-type">theta</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="#local-6989586621683349190"><span class="hs-identifier hs-type">theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-200"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#pprDerivSpec"><span class="hs-identifier hs-var">pprDerivSpec</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-comment">-- What action to take in order to derive a class instance.</span><span>
</span><a name="line-203"></a><span class="hs-comment">-- See Note [Deriving strategies] in TcDeriv</span><span>
</span><a name="line-204"></a><span class="hs-keyword">data</span><span> </span><a name="DerivSpecMechanism"><a href="TcDerivUtils.html#DerivSpecMechanism"><span class="hs-identifier">DerivSpecMechanism</span></a></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="DerivSpecStock"><a href="TcDerivUtils.html#DerivSpecStock"><span class="hs-identifier">DerivSpecStock</span></a></a><span>   </span><span class="hs-comment">-- &quot;Standard&quot; classes</span><span>
</span><a name="line-206"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-207"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-208"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><a href="TcGenDeriv.html#BagDerivStuff"><span class="hs-identifier hs-type">BagDerivStuff</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>      </span><span class="hs-comment">-- This function returns three things:</span><span>
</span><a name="line-210"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-211"></a><span>      </span><span class="hs-comment">-- 1. @LHsBinds GhcPs@: The derived instance's function bindings</span><span>
</span><a name="line-212"></a><span>      </span><span class="hs-comment">--    (e.g., @compare (T x) (T y) = compare x y@)</span><span>
</span><a name="line-213"></a><span>      </span><span class="hs-comment">-- 2. @BagDerivStuff@: Auxiliary bindings needed to support the derived</span><span>
</span><a name="line-214"></a><span>      </span><span class="hs-comment">--    instance. As examples, derived 'Generic' instances require</span><span>
</span><a name="line-215"></a><span>      </span><span class="hs-comment">--    associated type family instances, and derived 'Eq' and 'Ord'</span><span>
</span><a name="line-216"></a><span>      </span><span class="hs-comment">--    instances require top-level @con2tag@ functions.</span><span>
</span><a name="line-217"></a><span>      </span><span class="hs-comment">--    See Note [Auxiliary binders] in TcGenDeriv.</span><span>
</span><a name="line-218"></a><span>      </span><span class="hs-comment">-- 3. @[Name]@: A list of Names for which @-Wunused-binds@ should be</span><span>
</span><a name="line-219"></a><span>      </span><span class="hs-comment">--    suppressed. This is used to suppress unused warnings for record</span><span>
</span><a name="line-220"></a><span>      </span><span class="hs-comment">--    selectors when deriving 'Read', 'Show', or 'Generic'.</span><span>
</span><a name="line-221"></a><span>      </span><span class="hs-comment">--    See Note [Deriving and unused record selectors].</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DerivSpecNewtype"><a href="TcDerivUtils.html#DerivSpecNewtype"><span class="hs-identifier">DerivSpecNewtype</span></a></a><span> </span><span class="hs-comment">-- -XGeneralizedNewtypeDeriving</span><span>
</span><a name="line-224"></a><span>      </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-comment">-- The newtype rep type</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DerivSpecAnyClass"><a href="TcDerivUtils.html#DerivSpecAnyClass"><span class="hs-identifier">DerivSpecAnyClass</span></a></a><span> </span><span class="hs-comment">-- -XDeriveAnyClass</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DerivSpecVia"><a href="TcDerivUtils.html#DerivSpecVia"><span class="hs-identifier">DerivSpecVia</span></a></a><span> </span><span class="hs-comment">-- -XDerivingVia</span><span>
</span><a name="line-229"></a><span>      </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-comment">-- The @via@ type</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span class="hs-comment">-- | Convert a 'DerivSpecMechanism' to its corresponding 'DerivStrategy'.</span><span>
</span><a name="line-232"></a><span class="hs-identifier">derivSpecMechanismToStrategy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DerivStrategy</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span>
</span><a name="line-233"></a><a name="derivSpecMechanismToStrategy"><a href="TcDerivUtils.html#derivSpecMechanismToStrategy"><span class="hs-identifier">derivSpecMechanismToStrategy</span></a></a><span> </span><a href="TcDerivUtils.html#DerivSpecStock"><span class="hs-identifier hs-var">DerivSpecStock</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">StockStrategy</span><span>
</span><a name="line-234"></a><span class="hs-identifier">derivSpecMechanismToStrategy</span><span> </span><a href="TcDerivUtils.html#DerivSpecNewtype"><span class="hs-identifier hs-var">DerivSpecNewtype</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NewtypeStrategy</span><span>
</span><a name="line-235"></a><span class="hs-identifier">derivSpecMechanismToStrategy</span><span> </span><a href="TcDerivUtils.html#DerivSpecAnyClass"><span class="hs-identifier hs-var">DerivSpecAnyClass</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">AnyclassStrategy</span><span>
</span><a name="line-236"></a><span class="hs-identifier">derivSpecMechanismToStrategy</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivSpecVia"><span class="hs-identifier hs-var">DerivSpecVia</span></a><span> </span><a name="local-6989586621683349217"><a href="#local-6989586621683349217"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ViaStrategy</span><span> </span><a href="#local-6989586621683349217"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-237"></a><span>
</span><a name="line-238"></a><span class="hs-identifier">isDerivSpecStock</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isDerivSpecNewtype</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isDerivSpecAnyClass</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isDerivSpecVia</span><span>
</span><a name="line-239"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-240"></a><a name="isDerivSpecStock"><a href="TcDerivUtils.html#isDerivSpecStock"><span class="hs-identifier">isDerivSpecStock</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivSpecStock"><span class="hs-identifier hs-var">DerivSpecStock</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-241"></a><span class="hs-identifier">isDerivSpecStock</span><span> </span><span class="hs-identifier">_</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><a name="isDerivSpecNewtype"><a href="TcDerivUtils.html#isDerivSpecNewtype"><span class="hs-identifier">isDerivSpecNewtype</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivSpecNewtype"><span class="hs-identifier hs-var">DerivSpecNewtype</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-244"></a><span class="hs-identifier">isDerivSpecNewtype</span><span> </span><span class="hs-identifier">_</span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><a name="isDerivSpecAnyClass"><a href="TcDerivUtils.html#isDerivSpecAnyClass"><span class="hs-identifier">isDerivSpecAnyClass</span></a></a><span> </span><a href="TcDerivUtils.html#DerivSpecAnyClass"><span class="hs-identifier hs-var">DerivSpecAnyClass</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-247"></a><span class="hs-identifier">isDerivSpecAnyClass</span><span> </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><a name="isDerivSpecVia"><a href="TcDerivUtils.html#isDerivSpecVia"><span class="hs-identifier">isDerivSpecVia</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivSpecVia"><span class="hs-identifier hs-var">DerivSpecVia</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-250"></a><span class="hs-identifier">isDerivSpecVia</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcDerivUtils.html#DerivSpecMechanism"><span class="hs-identifier hs-type">DerivSpecMechanism</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-253"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivSpecStock"><span class="hs-identifier hs-var">DerivSpecStock</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DerivSpecStock&quot;</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivSpecNewtype"><span class="hs-identifier hs-var">DerivSpecNewtype</span></a><span> </span><a name="local-6989586621683349188"><a href="#local-6989586621683349188"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DerivSpecNewtype&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349188"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-255"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="TcDerivUtils.html#DerivSpecAnyClass"><span class="hs-identifier hs-var">DerivSpecAnyClass</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DerivSpecAnyClass&quot;</span><span>
</span><a name="line-256"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DerivSpecVia"><span class="hs-identifier hs-var">DerivSpecVia</span></a><span> </span><a name="local-6989586621683349189"><a href="#local-6989586621683349189"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DerivSpecVia&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349189"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-- | Whether GHC is processing a @deriving@ clause or a standalone deriving</span><span>
</span><a name="line-259"></a><span class="hs-comment">-- declaration.</span><span>
</span><a name="line-260"></a><span class="hs-keyword">data</span><span> </span><a name="DerivContext"><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier">DerivContext</span></a></a><span>
</span><a name="line-261"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="InferContext"><a href="TcDerivUtils.html#InferContext"><span class="hs-identifier">InferContext</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ @'InferContext mb_wildcard@ is either:</span><span>
</span><a name="line-262"></a><span>                                 </span><span class="hs-comment">--</span><span>
</span><a name="line-263"></a><span>                                 </span><span class="hs-comment">-- * A @deriving@ clause (in which case</span><span>
</span><a name="line-264"></a><span>                                 </span><span class="hs-comment">--   @mb_wildcard@ is 'Nothing').</span><span>
</span><a name="line-265"></a><span>                                 </span><span class="hs-comment">--</span><span>
</span><a name="line-266"></a><span>                                 </span><span class="hs-comment">-- * A standalone deriving declaration with</span><span>
</span><a name="line-267"></a><span>                                 </span><span class="hs-comment">--   an extra-constraints wildcard as the</span><span>
</span><a name="line-268"></a><span>                                 </span><span class="hs-comment">--   context (in which case @mb_wildcard@ is</span><span>
</span><a name="line-269"></a><span>                                 </span><span class="hs-comment">--   @'Just' loc@, where @loc@ is the location</span><span>
</span><a name="line-270"></a><span>                                 </span><span class="hs-comment">--   of the wildcard.</span><span>
</span><a name="line-271"></a><span>                                 </span><span class="hs-comment">--</span><span>
</span><a name="line-272"></a><span>                                 </span><span class="hs-comment">-- GHC should infer the context.</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="SupplyContext"><a href="TcDerivUtils.html#SupplyContext"><span class="hs-identifier">SupplyContext</span></a></a><span> </span><span class="hs-identifier hs-type">ThetaType</span><span>      </span><span class="hs-comment">-- ^ @'SupplyContext' theta@ is a standalone</span><span>
</span><a name="line-275"></a><span>                                 </span><span class="hs-comment">-- deriving declaration, where @theta@ is the</span><span>
</span><a name="line-276"></a><span>                                 </span><span class="hs-comment">-- context supplied by the user.</span><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-279"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#InferContext"><span class="hs-identifier hs-var">InferContext</span></a><span> </span><a name="local-6989586621683349186"><a href="#local-6989586621683349186"><span class="hs-identifier">standalone</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;InferContext&quot;</span><span>  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349186"><span class="hs-identifier hs-var">standalone</span></a><span>
</span><a name="line-280"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#SupplyContext"><span class="hs-identifier hs-var">SupplyContext</span></a><span> </span><a name="local-6989586621683349187"><a href="#local-6989586621683349187"><span class="hs-identifier">theta</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;SupplyContext&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349187"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-comment">-- | Records whether a particular class can be derived by way of an</span><span>
</span><a name="line-283"></a><span class="hs-comment">-- /originative/ deriving strategy (i.e., @stock@ or @anyclass@).</span><span>
</span><a name="line-284"></a><span class="hs-comment">--</span><span>
</span><a name="line-285"></a><span class="hs-comment">-- See @Note [Deriving strategies]@ in &quot;TcDeriv&quot;.</span><span>
</span><a name="line-286"></a><span class="hs-keyword">data</span><span> </span><a name="OriginativeDerivStatus"><a href="TcDerivUtils.html#OriginativeDerivStatus"><span class="hs-identifier">OriginativeDerivStatus</span></a></a><span>
</span><a name="line-287"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="CanDeriveStock"><a href="TcDerivUtils.html#CanDeriveStock"><span class="hs-identifier">CanDeriveStock</span></a></a><span>            </span><span class="hs-comment">-- Stock class, can derive</span><span>
</span><a name="line-288"></a><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-289"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><a href="TcGenDeriv.html#BagDerivStuff"><span class="hs-identifier hs-type">BagDerivStuff</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="StockClassError"><a href="TcDerivUtils.html#StockClassError"><span class="hs-identifier">StockClassError</span></a></a><span> </span><span class="hs-identifier hs-type">SDoc</span><span>      </span><span class="hs-comment">-- Stock class, but can't do it</span><span>
</span><a name="line-291"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CanDeriveAnyClass"><a href="TcDerivUtils.html#CanDeriveAnyClass"><span class="hs-identifier">CanDeriveAnyClass</span></a></a><span>         </span><span class="hs-comment">-- See Note [Deriving any class]</span><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NonDerivableClass"><a href="TcDerivUtils.html#NonDerivableClass"><span class="hs-identifier">NonDerivableClass</span></a></a><span> </span><span class="hs-identifier hs-type">SDoc</span><span>    </span><span class="hs-comment">-- Cannot derive with either stock or anyclass</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">-- A stock class is one either defined in the Haskell report or for which GHC</span><span>
</span><a name="line-295"></a><span class="hs-comment">-- otherwise knows how to generate code for (possibly requiring the use of a</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- language extension), such as Eq, Ord, Ix, Data, Generic, etc.)</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span class="hs-comment">-- | A 'PredType' annotated with the origin of the constraint 'CtOrigin',</span><span>
</span><a name="line-299"></a><span class="hs-comment">-- and whether or the constraint deals in types or kinds.</span><span>
</span><a name="line-300"></a><span class="hs-keyword">data</span><span> </span><a name="PredOrigin"><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier">PredOrigin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PredOrigin"><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier">PredOrigin</span></a></a><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-identifier hs-type">TypeOrKind</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-comment">-- | A list of wanted 'PredOrigin' constraints ('to_wanted_origins') to</span><span>
</span><a name="line-303"></a><span class="hs-comment">-- simplify when inferring a derived instance's context. These are used in all</span><span>
</span><a name="line-304"></a><span class="hs-comment">-- deriving strategies, but in the particular case of @DeriveAnyClass@, we</span><span>
</span><a name="line-305"></a><span class="hs-comment">-- need extra information. In particular, we need:</span><span>
</span><a name="line-306"></a><span class="hs-comment">--</span><span>
</span><a name="line-307"></a><span class="hs-comment">-- * 'to_anyclass_skols', the list of type variables bound by a class method's</span><span>
</span><a name="line-308"></a><span class="hs-comment">--   regular type signature, which should be rigid.</span><span>
</span><a name="line-309"></a><span class="hs-comment">--</span><span>
</span><a name="line-310"></a><span class="hs-comment">-- * 'to_anyclass_metas', the list of type variables bound by a class method's</span><span>
</span><a name="line-311"></a><span class="hs-comment">--   default type signature. These can be unified as necessary.</span><span>
</span><a name="line-312"></a><span class="hs-comment">--</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- * 'to_anyclass_givens', the list of constraints from a class method's</span><span>
</span><a name="line-314"></a><span class="hs-comment">--   regular type signature, which can be used to help solve constraints</span><span>
</span><a name="line-315"></a><span class="hs-comment">--   in the 'to_wanted_origins'.</span><span>
</span><a name="line-316"></a><span class="hs-comment">--</span><span>
</span><a name="line-317"></a><span class="hs-comment">-- (Note that 'to_wanted_origins' will likely contain type variables from the</span><span>
</span><a name="line-318"></a><span class="hs-comment">-- derived type class or data type, neither of which will appear in</span><span>
</span><a name="line-319"></a><span class="hs-comment">-- 'to_anyclass_skols' or 'to_anyclass_metas'.)</span><span>
</span><a name="line-320"></a><span class="hs-comment">--</span><span>
</span><a name="line-321"></a><span class="hs-comment">-- For all other deriving strategies, it is always the case that</span><span>
</span><a name="line-322"></a><span class="hs-comment">-- 'to_anyclass_skols', 'to_anyclass_metas', and 'to_anyclass_givens' are</span><span>
</span><a name="line-323"></a><span class="hs-comment">-- empty.</span><span>
</span><a name="line-324"></a><span class="hs-comment">--</span><span>
</span><a name="line-325"></a><span class="hs-comment">-- Here is an example to illustrate this:</span><span>
</span><a name="line-326"></a><span class="hs-comment">--</span><span>
</span><a name="line-327"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-328"></a><span class="hs-comment">-- class Foo a where</span><span>
</span><a name="line-329"></a><span class="hs-comment">--   bar :: forall b. Ix b =&gt; a -&gt; b -&gt; String</span><span>
</span><a name="line-330"></a><span class="hs-comment">--   default bar :: forall y. (Show a, Ix y) =&gt; a -&gt; y -&gt; String</span><span>
</span><a name="line-331"></a><span class="hs-comment">--   bar x y = show x ++ show (range (y, y))</span><span>
</span><a name="line-332"></a><span class="hs-comment">--</span><span>
</span><a name="line-333"></a><span class="hs-comment">--   baz :: Eq a =&gt; a -&gt; a -&gt; Bool</span><span>
</span><a name="line-334"></a><span class="hs-comment">--   default baz :: Ord a =&gt; a -&gt; a -&gt; Bool</span><span>
</span><a name="line-335"></a><span class="hs-comment">--   baz x y = compare x y == EQ</span><span>
</span><a name="line-336"></a><span class="hs-comment">--</span><span>
</span><a name="line-337"></a><span class="hs-comment">-- data Quux q = Quux deriving anyclass Foo</span><span>
</span><a name="line-338"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-339"></a><span class="hs-comment">--</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- Then it would generate two 'ThetaOrigin's, one for each method:</span><span>
</span><a name="line-341"></a><span class="hs-comment">--</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-343"></a><span class="hs-comment">-- [ ThetaOrigin { to_anyclass_skols  = [b]</span><span>
</span><a name="line-344"></a><span class="hs-comment">--               , to_anyclass_metas  = [y]</span><span>
</span><a name="line-345"></a><span class="hs-comment">--               , to_anyclass_givens = [Ix b]</span><span>
</span><a name="line-346"></a><span class="hs-comment">--               , to_wanted_origins  = [ Show (Quux q), Ix y</span><span>
</span><a name="line-347"></a><span class="hs-comment">--                                      , (Quux q -&gt; b -&gt; String) ~</span><span>
</span><a name="line-348"></a><span class="hs-comment">--                                        (Quux q -&gt; y -&gt; String)</span><span>
</span><a name="line-349"></a><span class="hs-comment">--                                      ] }</span><span>
</span><a name="line-350"></a><span class="hs-comment">-- , ThetaOrigin { to_anyclass_skols  = []</span><span>
</span><a name="line-351"></a><span class="hs-comment">--               , to_anyclass_metas  = []</span><span>
</span><a name="line-352"></a><span class="hs-comment">--               , to_anyclass_givens = [Eq (Quux q)]</span><span>
</span><a name="line-353"></a><span class="hs-comment">--               , to_wanted_origins  = [ Ord (Quux q)</span><span>
</span><a name="line-354"></a><span class="hs-comment">--                                      , (Quux q -&gt; Quux q -&gt; Bool) ~</span><span>
</span><a name="line-355"></a><span class="hs-comment">--                                        (Quux q -&gt; Quux q -&gt; Bool)</span><span>
</span><a name="line-356"></a><span class="hs-comment">--                                      ] }</span><span>
</span><a name="line-357"></a><span class="hs-comment">-- ]</span><span>
</span><a name="line-358"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-359"></a><span class="hs-comment">--</span><span>
</span><a name="line-360"></a><span class="hs-comment">-- (Note that the type variable @q@ is bound by the data type @Quux@, and thus</span><span>
</span><a name="line-361"></a><span class="hs-comment">-- it appears in neither 'to_anyclass_skols' nor 'to_anyclass_metas'.)</span><span>
</span><a name="line-362"></a><span class="hs-comment">--</span><span>
</span><a name="line-363"></a><span class="hs-comment">-- See @Note [Gathering and simplifying constraints for DeriveAnyClass]@</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- in &quot;TcDerivInfer&quot; for an explanation of how 'to_wanted_origins' are</span><span>
</span><a name="line-365"></a><span class="hs-comment">-- determined in @DeriveAnyClass@, as well as how 'to_anyclass_skols',</span><span>
</span><a name="line-366"></a><span class="hs-comment">-- 'to_anyclass_metas', and 'to_anyclass_givens' are used.</span><span>
</span><a name="line-367"></a><span class="hs-keyword">data</span><span> </span><a name="ThetaOrigin"><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier">ThetaOrigin</span></a></a><span>
</span><a name="line-368"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ThetaOrigin"><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier">ThetaOrigin</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="to_anyclass_skols"><a href="TcDerivUtils.html#to_anyclass_skols"><span class="hs-identifier">to_anyclass_skols</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span>
</span><a name="line-369"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="to_anyclass_metas"><a href="TcDerivUtils.html#to_anyclass_metas"><span class="hs-identifier">to_anyclass_metas</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span>
</span><a name="line-370"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="to_anyclass_givens"><a href="TcDerivUtils.html#to_anyclass_givens"><span class="hs-identifier">to_anyclass_givens</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span>
</span><a name="line-371"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="to_wanted_origins"><a href="TcDerivUtils.html#to_wanted_origins"><span class="hs-identifier">to_wanted_origins</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-374"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-var">PredOrigin</span></a><span> </span><a name="local-6989586621683349185"><a href="#local-6989586621683349185"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349185"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-comment">-- The origin is not so interesting when debugging</span><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-377"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier hs-var">ThetaOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">to_anyclass_skols</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349181"><a href="#local-6989586621683349181"><span class="hs-identifier">ac_skols</span></a></a><span>
</span><a name="line-378"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">to_anyclass_metas</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349182"><a href="#local-6989586621683349182"><span class="hs-identifier">ac_metas</span></a></a><span>
</span><a name="line-379"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">to_anyclass_givens</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349183"><a href="#local-6989586621683349183"><span class="hs-identifier">ac_givens</span></a></a><span>
</span><a name="line-380"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">to_wanted_origins</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349184"><a href="#local-6989586621683349184"><span class="hs-identifier">wanted_origins</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ThetaOrigin&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>         </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to_anyclass_skols  =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349181"><span class="hs-identifier hs-var">ac_skols</span></a><span>
</span><a name="line-383"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to_anyclass_metas  =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349182"><span class="hs-identifier hs-var">ac_metas</span></a><span>
</span><a name="line-384"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to_anyclass_givens =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349183"><span class="hs-identifier hs-var">ac_givens</span></a><span>
</span><a name="line-385"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to_wanted_origins  =&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349184"><span class="hs-identifier hs-var">wanted_origins</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>
</span><a name="line-387"></a><span class="hs-identifier">mkPredOrigin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeOrKind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PredType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span>
</span><a name="line-388"></a><a name="mkPredOrigin"><a href="TcDerivUtils.html#mkPredOrigin"><span class="hs-identifier">mkPredOrigin</span></a></a><span> </span><a name="local-6989586621683349218"><a href="#local-6989586621683349218"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-6989586621683349219"><a href="#local-6989586621683349219"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-6989586621683349220"><a href="#local-6989586621683349220"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-var">PredOrigin</span></a><span> </span><a href="#local-6989586621683349220"><span class="hs-identifier hs-var">pred</span></a><span> </span><a href="#local-6989586621683349218"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-6989586621683349219"><span class="hs-identifier hs-var">t_or_k</span></a><span>
</span><a name="line-389"></a><span>
</span><a name="line-390"></a><span class="hs-identifier">mkThetaOrigin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeOrKind</span><span>
</span><a name="line-391"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span>
</span><a name="line-392"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span>
</span><a name="line-393"></a><a name="mkThetaOrigin"><a href="TcDerivUtils.html#mkThetaOrigin"><span class="hs-identifier">mkThetaOrigin</span></a></a><span> </span><a name="local-6989586621683349221"><a href="#local-6989586621683349221"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-6989586621683349222"><a href="#local-6989586621683349222"><span class="hs-identifier">t_or_k</span></a></a><span> </span><a name="local-6989586621683349223"><a href="#local-6989586621683349223"><span class="hs-identifier">skols</span></a></a><span> </span><a name="local-6989586621683349224"><a href="#local-6989586621683349224"><span class="hs-identifier">metas</span></a></a><span> </span><a name="local-6989586621683349225"><a href="#local-6989586621683349225"><span class="hs-identifier">givens</span></a></a><span>
</span><a name="line-394"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier hs-var">ThetaOrigin</span></a><span> </span><a href="#local-6989586621683349223"><span class="hs-identifier hs-var">skols</span></a><span> </span><a href="#local-6989586621683349224"><span class="hs-identifier hs-var">metas</span></a><span> </span><a href="#local-6989586621683349225"><span class="hs-identifier hs-var">givens</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#mkPredOrigin"><span class="hs-identifier hs-var">mkPredOrigin</span></a><span> </span><a href="#local-6989586621683349221"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-6989586621683349222"><span class="hs-identifier hs-var">t_or_k</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-comment">-- A common case where the ThetaOrigin only contains wanted constraints, with</span><span>
</span><a name="line-397"></a><span class="hs-comment">-- no givens or locally scoped type variables.</span><span>
</span><a name="line-398"></a><span class="hs-identifier">mkThetaOriginFromPreds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier hs-type">ThetaOrigin</span></a><span>
</span><a name="line-399"></a><a name="mkThetaOriginFromPreds"><a href="TcDerivUtils.html#mkThetaOriginFromPreds"><span class="hs-identifier">mkThetaOriginFromPreds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#ThetaOrigin"><span class="hs-identifier hs-var">ThetaOrigin</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-400"></a><span>
</span><a name="line-401"></a><span class="hs-identifier">substPredOrigin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HasCallStack</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">TCvSubst</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-type">PredOrigin</span></a><span>
</span><a name="line-402"></a><a name="substPredOrigin"><a href="TcDerivUtils.html#substPredOrigin"><span class="hs-identifier">substPredOrigin</span></a></a><span> </span><a name="local-6989586621683349226"><a href="#local-6989586621683349226"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-var">PredOrigin</span></a><span> </span><a name="local-6989586621683349227"><a href="#local-6989586621683349227"><span class="hs-identifier">pred</span></a></a><span> </span><a name="local-6989586621683349228"><a href="#local-6989586621683349228"><span class="hs-identifier">origin</span></a></a><span> </span><a name="local-6989586621683349229"><a href="#local-6989586621683349229"><span class="hs-identifier">t_or_k</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#PredOrigin"><span class="hs-identifier hs-var">PredOrigin</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683349226"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683349227"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683349228"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-6989586621683349229"><span class="hs-identifier hs-var">t_or_k</span></a><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Class deriving diagnostics
*                                                                      *
************************************************************************

Only certain blessed classes can be used in a deriving clause (without the
assistance of GeneralizedNewtypeDeriving or DeriveAnyClass). These classes
are listed below in the definition of hasStockDeriving. The stockSideConditions
function determines the criteria that needs to be met in order for a particular
stock class to be able to be derived successfully.

A class might be able to be used in a deriving clause if -XDeriveAnyClass
is willing to support it. The canDeriveAnyClass function checks if this is the
case.
-}</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-identifier">hasStockDeriving</span><span>
</span><a name="line-424"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-425"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-426"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-427"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><a href="TcGenDeriv.html#BagDerivStuff"><span class="hs-identifier hs-type">BagDerivStuff</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><a name="hasStockDeriving"><a href="TcDerivUtils.html#hasStockDeriving"><span class="hs-identifier">hasStockDeriving</span></a></a><span> </span><a name="local-6989586621683349230"><a href="#local-6989586621683349230"><span class="hs-identifier">clas</span></a></a><span>
</span><a name="line-429"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">assocMaybe</span><span> </span><a href="#local-6989586621683349231"><span class="hs-identifier hs-var">gen_list</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621683349230"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-431"></a><span>    </span><span class="hs-identifier">gen_list</span><span>
</span><a name="line-432"></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Unique</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span>
</span><a name="line-433"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-434"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>
</span><a name="line-435"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">,</span><span> </span><a href="TcGenDeriv.html#BagDerivStuff"><span class="hs-identifier hs-type">BagDerivStuff</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-436"></a><span>    </span><a name="local-6989586621683349231"><a href="#local-6989586621683349231"><span class="hs-identifier">gen_list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqClassKey</span><span class="hs-special">,</span><span>          </span><a href="#local-6989586621683349233"><span class="hs-identifier hs-var">simpleM</span></a><span> </span><a href="TcGenDeriv.html#gen_Eq_binds"><span class="hs-identifier hs-var">gen_Eq_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ordClassKey</span><span class="hs-special">,</span><span>         </span><a href="#local-6989586621683349233"><span class="hs-identifier hs-var">simpleM</span></a><span> </span><a href="TcGenDeriv.html#gen_Ord_binds"><span class="hs-identifier hs-var">gen_Ord_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">enumClassKey</span><span class="hs-special">,</span><span>        </span><a href="#local-6989586621683349233"><span class="hs-identifier hs-var">simpleM</span></a><span> </span><a href="TcGenDeriv.html#gen_Enum_binds"><span class="hs-identifier hs-var">gen_Enum_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">boundedClassKey</span><span class="hs-special">,</span><span>     </span><a href="#local-6989586621683349232"><span class="hs-identifier hs-var">simple</span></a><span> </span><a href="TcGenDeriv.html#gen_Bounded_binds"><span class="hs-identifier hs-var">gen_Bounded_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ixClassKey</span><span class="hs-special">,</span><span>          </span><a href="#local-6989586621683349233"><span class="hs-identifier hs-var">simpleM</span></a><span> </span><a href="TcGenDeriv.html#gen_Ix_binds"><span class="hs-identifier hs-var">gen_Ix_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showClassKey</span><span class="hs-special">,</span><span>        </span><a href="#local-6989586621683349234"><span class="hs-identifier hs-var">read_or_show</span></a><span> </span><a href="TcGenDeriv.html#gen_Show_binds"><span class="hs-identifier hs-var">gen_Show_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-442"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readClassKey</span><span class="hs-special">,</span><span>        </span><a href="#local-6989586621683349234"><span class="hs-identifier hs-var">read_or_show</span></a><span> </span><a href="TcGenDeriv.html#gen_Read_binds"><span class="hs-identifier hs-var">gen_Read_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataClassKey</span><span class="hs-special">,</span><span>        </span><a href="#local-6989586621683349233"><span class="hs-identifier hs-var">simpleM</span></a><span> </span><a href="TcGenDeriv.html#gen_Data_binds"><span class="hs-identifier hs-var">gen_Data_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">functorClassKey</span><span class="hs-special">,</span><span>     </span><a href="#local-6989586621683349232"><span class="hs-identifier hs-var">simple</span></a><span> </span><a href="TcGenFunctor.html#gen_Functor_binds"><span class="hs-identifier hs-var">gen_Functor_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldableClassKey</span><span class="hs-special">,</span><span>    </span><a href="#local-6989586621683349232"><span class="hs-identifier hs-var">simple</span></a><span> </span><a href="TcGenFunctor.html#gen_Foldable_binds"><span class="hs-identifier hs-var">gen_Foldable_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-446"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">traversableClassKey</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683349232"><span class="hs-identifier hs-var">simple</span></a><span> </span><a href="TcGenFunctor.html#gen_Traversable_binds"><span class="hs-identifier hs-var">gen_Traversable_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-447"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span class="hs-special">,</span><span>        </span><a href="#local-6989586621683349232"><span class="hs-identifier hs-var">simple</span></a><span> </span><a href="TcGenDeriv.html#gen_Lift_binds"><span class="hs-identifier hs-var">gen_Lift_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">genClassKey</span><span class="hs-special">,</span><span>         </span><a href="#local-6989586621683349235"><span class="hs-identifier hs-var">generic</span></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#gen_Generic_binds"><span class="hs-identifier hs-var">gen_Generic_binds</span></a><span> </span><a href="TcGenGenerics.html#Gen0"><span class="hs-identifier hs-var">Gen0</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gen1ClassKey</span><span class="hs-special">,</span><span>        </span><a href="#local-6989586621683349235"><span class="hs-identifier hs-var">generic</span></a><span> </span><span class="hs-special">(</span><a href="TcGenGenerics.html#gen_Generic_binds"><span class="hs-identifier hs-var">gen_Generic_binds</span></a><span> </span><a href="TcGenGenerics.html#Gen1"><span class="hs-identifier hs-var">Gen1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span>    </span><a name="local-6989586621683349232"><a href="#local-6989586621683349232"><span class="hs-identifier">simple</span></a></a><span> </span><a name="local-6989586621683349237"><a href="#local-6989586621683349237"><span class="hs-identifier">gen_fn</span></a></a><span> </span><a name="local-6989586621683349238"><a href="#local-6989586621683349238"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683349239"><a href="#local-6989586621683349239"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-452"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683349240"><a href="#local-6989586621683349240"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683349241"><a href="#local-6989586621683349241"><span class="hs-identifier">deriv_stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349237"><span class="hs-identifier hs-var">gen_fn</span></a><span> </span><a href="#local-6989586621683349238"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683349239"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-453"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349240"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683349241"><span class="hs-identifier hs-var">deriv_stuff</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span>    </span><a name="local-6989586621683349233"><a href="#local-6989586621683349233"><span class="hs-identifier">simpleM</span></a></a><span> </span><a name="local-6989586621683349242"><a href="#local-6989586621683349242"><span class="hs-identifier">gen_fn</span></a></a><span> </span><a name="local-6989586621683349243"><a href="#local-6989586621683349243"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683349244"><a href="#local-6989586621683349244"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-456"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683349245"><a href="#local-6989586621683349245"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683349246"><a href="#local-6989586621683349246"><span class="hs-identifier">deriv_stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683349242"><span class="hs-identifier hs-var">gen_fn</span></a><span> </span><a href="#local-6989586621683349243"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683349244"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-457"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349245"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683349246"><span class="hs-identifier hs-var">deriv_stuff</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span>    </span><a name="local-6989586621683349234"><a href="#local-6989586621683349234"><span class="hs-identifier">read_or_show</span></a></a><span> </span><a name="local-6989586621683349247"><a href="#local-6989586621683349247"><span class="hs-identifier">gen_fn</span></a></a><span> </span><a name="local-6989586621683349248"><a href="#local-6989586621683349248"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683349249"><a href="#local-6989586621683349249"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-460"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683349250"><a href="#local-6989586621683349250"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDerivUtils.html#getDataConFixityFun"><span class="hs-identifier hs-var">getDataConFixityFun</span></a><span> </span><a href="#local-6989586621683349249"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-461"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683349251"><a href="#local-6989586621683349251"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683349252"><a href="#local-6989586621683349252"><span class="hs-identifier">deriv_stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349247"><span class="hs-identifier hs-var">gen_fn</span></a><span> </span><a href="#local-6989586621683349250"><span class="hs-identifier hs-var">fix_env</span></a><span> </span><a href="#local-6989586621683349248"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683349249"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-462"></a><span>                 </span><a name="local-6989586621683349253"><a href="#local-6989586621683349253"><span class="hs-identifier">field_names</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349236"><span class="hs-identifier hs-var">all_field_names</span></a><span> </span><a href="#local-6989586621683349249"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-463"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349251"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683349252"><span class="hs-identifier hs-var">deriv_stuff</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683349253"><span class="hs-identifier hs-var">field_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span>    </span><a name="local-6989586621683349235"><a href="#local-6989586621683349235"><span class="hs-identifier">generic</span></a></a><span> </span><a name="local-6989586621683349254"><a href="#local-6989586621683349254"><span class="hs-identifier">gen_fn</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349255"><a href="#local-6989586621683349255"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683349256"><a href="#local-6989586621683349256"><span class="hs-identifier">inst_tys</span></a></a><span>
</span><a name="line-466"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683349257"><a href="#local-6989586621683349257"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683349258"><a href="#local-6989586621683349258"><span class="hs-identifier">faminst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683349254"><span class="hs-identifier hs-var">gen_fn</span></a><span> </span><a href="#local-6989586621683349255"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683349256"><span class="hs-identifier hs-var">inst_tys</span></a><span>
</span><a name="line-467"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683349259"><a href="#local-6989586621683349259"><span class="hs-identifier">field_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349236"><span class="hs-identifier hs-var">all_field_names</span></a><span> </span><a href="#local-6989586621683349255"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-468"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349257"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">(</span><a href="TcGenDeriv.html#DerivFamInst"><span class="hs-identifier hs-var">DerivFamInst</span></a><span> </span><a href="#local-6989586621683349258"><span class="hs-identifier hs-var">faminst</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683349259"><span class="hs-identifier hs-var">field_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span>    </span><span class="hs-comment">-- See Note [Deriving and unused record selectors]</span><span>
</span><a name="line-471"></a><span>    </span><a name="local-6989586621683349236"><a href="#local-6989586621683349236"><span class="hs-identifier">all_field_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">dataConFieldLabels</span><span>
</span><a name="line-472"></a><span>                                     </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-comment">{-
Note [Deriving and unused record selectors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this (see Trac #13919):

  module Main (main) where

  data Foo = MkFoo {bar :: String} deriving Show

  main :: IO ()
  main = print (Foo &quot;hello&quot;)

Strictly speaking, the record selector `bar` is unused in this module, since
neither `main` nor the derived `Show` instance for `Foo` mention `bar`.
However, the behavior of `main` is affected by the presence of `bar`, since
it will print different output depending on whether `MkFoo` is defined using
record selectors or not. Therefore, we do not to issue a
&quot;Defined but not used: &#8216;bar&#8217;&quot; warning for this module, since removing `bar`
changes the program's behavior. This is the reason behind the [Name] part of
the return type of `hasStockDeriving`&#8212;it tracks all of the record selector
`Name`s for which -Wunused-binds should be suppressed.

Currently, the only three stock derived classes that require this are Read,
Show, and Generic, as their derived code all depend on the record selectors
of the derived data type's constructors.

See also Note [Newtype deriving and unused constructors] in TcDeriv for
another example of a similar trick.
-}</span><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-identifier">getDataConFixityFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span class="hs-comment">-- If the TyCon is locally defined, we want the local fixity env;</span><span>
</span><a name="line-506"></a><span class="hs-comment">-- but if it is imported (which happens for standalone deriving)</span><span>
</span><a name="line-507"></a><span class="hs-comment">-- we need to get the fixity env from the interface file</span><span>
</span><a name="line-508"></a><span class="hs-comment">-- c.f. RnEnv.lookupFixity, and Trac #9830</span><span>
</span><a name="line-509"></a><a name="getDataConFixityFun"><a href="TcDerivUtils.html#getDataConFixityFun"><span class="hs-identifier">getDataConFixityFun</span></a></a><span> </span><a name="local-6989586621683349260"><a href="#local-6989586621683349260"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-510"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683349263"><a href="#local-6989586621683349263"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-511"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">nameIsLocalOrFrom</span><span> </span><a href="#local-6989586621683349263"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621683349261"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-512"></a><span>         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683349264"><a href="#local-6989586621683349264"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier hs-var">getFixityEnv</span></a><span>
</span><a name="line-513"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupFixity</span><span> </span><a href="#local-6989586621683349264"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-514"></a><span>         </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683349265"><a href="#local-6989586621683349265"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="LoadIface.html#loadInterfaceForName"><span class="hs-identifier hs-var">loadInterfaceForName</span></a><span> </span><a href="#local-6989586621683349262"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621683349261"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-515"></a><span>                            </span><span class="hs-comment">-- Should already be loaded!</span><span>
</span><a name="line-516"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mi_fix</span><span> </span><a href="#local-6989586621683349265"><span class="hs-identifier hs-var">iface</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-517"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-518"></a><span>    </span><a name="local-6989586621683349261"><a href="#local-6989586621683349261"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683349260"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-519"></a><span>    </span><a name="local-6989586621683349262"><a href="#local-6989586621683349262"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Data con fixities for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349261"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- Check side conditions that dis-allow derivability for the originative</span><span>
</span><a name="line-523"></a><span class="hs-comment">-- deriving strategies (stock and anyclass).</span><span>
</span><a name="line-524"></a><span class="hs-comment">-- See Note [Deriving strategies] in TcDeriv for an explanation of what</span><span>
</span><a name="line-525"></a><span class="hs-comment">-- &quot;originative&quot; means.</span><span>
</span><a name="line-526"></a><span class="hs-comment">--</span><span>
</span><a name="line-527"></a><span class="hs-comment">-- This is *apart* from the coerce-based strategies, newtype and via.</span><span>
</span><a name="line-528"></a><span class="hs-comment">--</span><span>
</span><a name="line-529"></a><span class="hs-comment">-- Here we get the representation tycon in case of family instances as it has</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- the data constructors - but we need to be careful to fall back to the</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- family tycon (with indexes) in error messages.</span><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span class="hs-identifier">checkOriginativeSideConditions</span><span>
</span><a name="line-534"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span>
</span><a name="line-535"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>
</span><a name="line-536"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#OriginativeDerivStatus"><span class="hs-identifier hs-type">OriginativeDerivStatus</span></a><span>
</span><a name="line-537"></a><a name="checkOriginativeSideConditions"><a href="TcDerivUtils.html#checkOriginativeSideConditions"><span class="hs-identifier">checkOriginativeSideConditions</span></a></a><span> </span><a name="local-6989586621683349266"><a href="#local-6989586621683349266"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621683349267"><a href="#local-6989586621683349267"><span class="hs-identifier">deriv_ctxt</span></a></a><span> </span><a name="local-6989586621683349268"><a href="#local-6989586621683349268"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621683349269"><a href="#local-6989586621683349269"><span class="hs-identifier">cls_tys</span></a></a><span> </span><a name="local-6989586621683349270"><a href="#local-6989586621683349270"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683349271"><a href="#local-6989586621683349271"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-538"></a><span>    </span><span class="hs-comment">-- First, check if stock deriving is possible...</span><span>
</span><a name="line-539"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683349272"><a href="#local-6989586621683349272"><span class="hs-identifier">cond</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDerivUtils.html#stockSideConditions"><span class="hs-identifier hs-var">stockSideConditions</span></a><span> </span><a href="#local-6989586621683349267"><span class="hs-identifier hs-var">deriv_ctxt</span></a><span> </span><a href="#local-6989586621683349268"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-540"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349272"><span class="hs-identifier hs-var">cond</span></a><span> </span><a href="#local-6989586621683349266"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683349270"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683349271"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-541"></a><span>        </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a name="local-6989586621683349273"><a href="#local-6989586621683349273"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#StockClassError"><span class="hs-identifier hs-var">StockClassError</span></a><span> </span><a href="#local-6989586621683349273"><span class="hs-identifier hs-var">err</span></a><span>  </span><span class="hs-comment">-- Class-specific error</span><span>
</span><a name="line-542"></a><span>        </span><span class="hs-identifier hs-var">IsValid</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterOutInvisibleTypes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621683349268"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683349269"><span class="hs-identifier hs-var">cls_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>                   </span><span class="hs-comment">-- All stock derivable classes are unary in the sense that</span><span>
</span><a name="line-544"></a><span>                   </span><span class="hs-comment">-- there should be not types in cls_tys (i.e., no type args</span><span>
</span><a name="line-545"></a><span>                   </span><span class="hs-comment">-- other than last). Note that cls_types can contain</span><span>
</span><a name="line-546"></a><span>                   </span><span class="hs-comment">-- invisible types as well (e.g., for Generic1, which is</span><span>
</span><a name="line-547"></a><span>                   </span><span class="hs-comment">-- poly-kinded), so make sure those are not counted.</span><span>
</span><a name="line-548"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683349274"><a href="#local-6989586621683349274"><span class="hs-identifier">gen_fn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDerivUtils.html#hasStockDeriving"><span class="hs-identifier hs-var">hasStockDeriving</span></a><span> </span><a href="#local-6989586621683349268"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-549"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#CanDeriveStock"><span class="hs-identifier hs-var">CanDeriveStock</span></a><span> </span><a href="#local-6989586621683349274"><span class="hs-identifier hs-var">gen_fn</span></a><span>
</span><a name="line-550"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#StockClassError"><span class="hs-identifier hs-var">StockClassError</span></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#classArgsErr"><span class="hs-identifier hs-var">classArgsErr</span></a><span> </span><a href="#local-6989586621683349268"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683349269"><span class="hs-identifier hs-var">cls_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>                   </span><span class="hs-comment">-- e.g. deriving( Eq s )</span><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span>    </span><span class="hs-comment">-- ...if not, try falling back on DeriveAnyClass.</span><span>
</span><a name="line-554"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a name="local-6989586621683349275"><a href="#local-6989586621683349275"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDerivUtils.html#canDeriveAnyClass"><span class="hs-identifier hs-var">canDeriveAnyClass</span></a><span> </span><a href="#local-6989586621683349266"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-555"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#NonDerivableClass"><span class="hs-identifier hs-var">NonDerivableClass</span></a><span> </span><a href="#local-6989586621683349275"><span class="hs-identifier hs-var">err</span></a><span>  </span><span class="hs-comment">-- Neither anyclass nor stock work</span><span>
</span><a name="line-556"></a><span>
</span><a name="line-557"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-558"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#CanDeriveAnyClass"><span class="hs-identifier hs-var">CanDeriveAnyClass</span></a><span>   </span><span class="hs-comment">-- DeriveAnyClass should work</span><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span class="hs-identifier">classArgsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-561"></a><a name="classArgsErr"><a href="TcDerivUtils.html#classArgsErr"><span class="hs-identifier">classArgsErr</span></a></a><span> </span><a name="local-6989586621683349276"><a href="#local-6989586621683349276"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621683349277"><a href="#local-6989586621683349277"><span class="hs-identifier">cls_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621683349276"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621683349277"><span class="hs-identifier hs-var">cls_tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not a class&quot;</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-comment">-- Side conditions (whether the datatype must have at least one constructor,</span><span>
</span><a name="line-564"></a><span class="hs-comment">-- required language extensions, etc.) for using GHC's stock deriving</span><span>
</span><a name="line-565"></a><span class="hs-comment">-- mechanism on certain classes (as opposed to classes that require</span><span>
</span><a name="line-566"></a><span class="hs-comment">-- GeneralizedNewtypeDeriving or DeriveAnyClass). Returns Nothing for a</span><span>
</span><a name="line-567"></a><span class="hs-comment">-- class for which stock deriving isn't possible.</span><span>
</span><a name="line-568"></a><span class="hs-identifier">stockSideConditions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-569"></a><a name="stockSideConditions"><a href="TcDerivUtils.html#stockSideConditions"><span class="hs-identifier">stockSideConditions</span></a></a><span> </span><a name="local-6989586621683349278"><a href="#local-6989586621683349278"><span class="hs-identifier">deriv_ctxt</span></a></a><span> </span><a name="local-6989586621683349279"><a href="#local-6989586621683349279"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-570"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">eqClassKey</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349281"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDerivUtils.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-571"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ordClassKey</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349281"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDerivUtils.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-572"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">showClassKey</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349281"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDerivUtils.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">readClassKey</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349281"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDerivUtils.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">enumClassKey</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349281"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDerivUtils.html#cond_isEnumeration"><span class="hs-identifier hs-var">cond_isEnumeration</span></a><span class="hs-special">)</span><span>
</span><a name="line-575"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ixClassKey</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349281"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDerivUtils.html#cond_enumOrProduct"><span class="hs-identifier hs-var">cond_enumOrProduct</span></a><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">boundedClassKey</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349281"><span class="hs-identifier hs-var">cond_std</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDerivUtils.html#cond_enumOrProduct"><span class="hs-identifier hs-var">cond_enumOrProduct</span></a><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-577"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">dataClassKey</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DeriveDataTypeable</span><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-578"></a><span>                                           </span><a href="#local-6989586621683349282"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-579"></a><span>                                           </span><a href="TcDerivUtils.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">functorClassKey</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DeriveFunctor</span><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-581"></a><span>                                           </span><a href="#local-6989586621683349282"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-582"></a><span>                                           </span><a href="TcDerivUtils.html#cond_functorOK"><span class="hs-identifier hs-var">cond_functorOK</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">foldableClassKey</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DeriveFoldable</span><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-584"></a><span>                                           </span><a href="#local-6989586621683349282"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-585"></a><span>                                           </span><a href="TcDerivUtils.html#cond_functorOK"><span class="hs-identifier hs-var">cond_functorOK</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>                                           </span><span class="hs-comment">-- Functor/Fold/Trav works ok</span><span>
</span><a name="line-587"></a><span>                                           </span><span class="hs-comment">-- for rank-n types</span><span>
</span><a name="line-588"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">traversableClassKey</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DeriveTraversable</span><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-589"></a><span>                                           </span><a href="#local-6989586621683349282"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-590"></a><span>                                           </span><a href="TcDerivUtils.html#cond_functorOK"><span class="hs-identifier hs-var">cond_functorOK</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">genClassKey</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DeriveGeneric</span><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-592"></a><span>                                           </span><a href="#local-6989586621683349282"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-593"></a><span>                                           </span><a href="TcDerivUtils.html#cond_RepresentableOk"><span class="hs-identifier hs-var">cond_RepresentableOk</span></a><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">gen1ClassKey</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DeriveGeneric</span><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-595"></a><span>                                           </span><a href="#local-6989586621683349282"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-596"></a><span>                                           </span><a href="TcDerivUtils.html#cond_Representable1Ok"><span class="hs-identifier hs-var">cond_Representable1Ok</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349280"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><span class="hs-identifier hs-var">LangExt.DeriveLift</span><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-598"></a><span>                                           </span><a href="#local-6989586621683349282"><span class="hs-identifier hs-var">cond_vanilla</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-599"></a><span>                                           </span><a href="TcDerivUtils.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-601"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-602"></a><span>    </span><a name="local-6989586621683349280"><a href="#local-6989586621683349280"><span class="hs-identifier">cls_key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getUnique</span><span> </span><a href="#local-6989586621683349279"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-603"></a><span>    </span><a name="local-6989586621683349281"><a href="#local-6989586621683349281"><span class="hs-identifier">cond_std</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#cond_stdOK"><span class="hs-identifier hs-var">cond_stdOK</span></a><span> </span><a href="#local-6989586621683349278"><span class="hs-identifier hs-var">deriv_ctxt</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-604"></a><span>      </span><span class="hs-comment">-- Vanilla data constructors, at least one, and monotype arguments</span><span>
</span><a name="line-605"></a><span>    </span><a name="local-6989586621683349282"><a href="#local-6989586621683349282"><span class="hs-identifier">cond_vanilla</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#cond_stdOK"><span class="hs-identifier hs-var">cond_stdOK</span></a><span> </span><a href="#local-6989586621683349278"><span class="hs-identifier hs-var">deriv_ctxt</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-606"></a><span>      </span><span class="hs-comment">-- Vanilla data constructors but allow no data cons or polytype arguments</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span class="hs-identifier">canDeriveAnyClass</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-609"></a><span class="hs-comment">-- IsValid: we can (try to) derive it via an empty instance declaration</span><span>
</span><a name="line-610"></a><span class="hs-comment">-- NotValid s:  we can't, reason s</span><span>
</span><a name="line-611"></a><a name="canDeriveAnyClass"><a href="TcDerivUtils.html#canDeriveAnyClass"><span class="hs-identifier">canDeriveAnyClass</span></a></a><span> </span><a name="local-6989586621683349283"><a href="#local-6989586621683349283"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-612"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">xopt</span><span> </span><span class="hs-identifier hs-var">LangExt.DeriveAnyClass</span><span> </span><a href="#local-6989586621683349283"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Try enabling DeriveAnyClass&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-615"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>   </span><span class="hs-comment">-- OK!</span><span>
</span><a name="line-616"></a><span>
</span><a name="line-617"></a><span class="hs-keyword">type</span><span> </span><a name="Condition"><a href="TcDerivUtils.html#Condition"><span class="hs-identifier">Condition</span></a></a><span>
</span><a name="line-618"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>    </span><span class="hs-comment">-- ^ The data type's 'TyCon'. For data families, this is the</span><span>
</span><a name="line-621"></a><span>              </span><span class="hs-comment">-- family 'TyCon'.</span><span>
</span><a name="line-622"></a><span>
</span><a name="line-623"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>    </span><span class="hs-comment">-- ^ For data families, this is the representation 'TyCon'.</span><span>
</span><a name="line-624"></a><span>              </span><span class="hs-comment">-- Otherwise, this is the same as the other 'TyCon' argument.</span><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span> </span><span class="hs-comment">-- ^ 'IsValid' if deriving an instance for this 'TyCon' is</span><span>
</span><a name="line-627"></a><span>              </span><span class="hs-comment">-- possible. Otherwise, it's @'NotValid' err@, where @err@</span><span>
</span><a name="line-628"></a><span>              </span><span class="hs-comment">-- explains what went wrong.</span><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span class="hs-identifier">orCond</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-631"></a><a name="orCond"><a href="TcDerivUtils.html#orCond"><span class="hs-identifier">orCond</span></a></a><span> </span><a name="local-6989586621683349284"><a href="#local-6989586621683349284"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621683349285"><a href="#local-6989586621683349285"><span class="hs-identifier">c2</span></a></a><span> </span><a name="local-6989586621683349286"><a href="#local-6989586621683349286"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621683349287"><a href="#local-6989586621683349287"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683349288"><a href="#local-6989586621683349288"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-632"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349284"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-6989586621683349286"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683349287"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683349288"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683349285"><span class="hs-identifier hs-var">c2</span></a><span> </span><a href="#local-6989586621683349286"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683349287"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683349288"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-633"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">IsValid</span><span class="hs-special">,</span><span>    </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>    </span><span class="hs-comment">-- c1 succeeds</span><span>
</span><a name="line-634"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>          </span><span class="hs-identifier hs-var">IsValid</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>    </span><span class="hs-comment">-- c21 succeeds</span><span>
</span><a name="line-635"></a><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NotValid</span><span> </span><a name="local-6989586621683349289"><a href="#local-6989586621683349289"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a name="local-6989586621683349290"><a href="#local-6989586621683349290"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349289"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  or&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621683349290"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span>
</span><a name="line-636"></a><span>                                            </span><span class="hs-comment">-- Both fail</span><span>
</span><a name="line-637"></a><span>
</span><a name="line-638"></a><span class="hs-identifier">andCond</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-639"></a><a name="andCond"><a href="TcDerivUtils.html#andCond"><span class="hs-identifier">andCond</span></a></a><span> </span><a name="local-6989586621683349291"><a href="#local-6989586621683349291"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621683349292"><a href="#local-6989586621683349292"><span class="hs-identifier">c2</span></a></a><span> </span><a name="local-6989586621683349293"><a href="#local-6989586621683349293"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621683349294"><a href="#local-6989586621683349294"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683349295"><a href="#local-6989586621683349295"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-640"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349291"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-6989586621683349293"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683349294"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683349295"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andValid</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683349292"><span class="hs-identifier hs-var">c2</span></a><span> </span><a href="#local-6989586621683349293"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683349294"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683349295"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-641"></a><span>
</span><a name="line-642"></a><span class="hs-comment">-- | Some common validity checks shared among stock derivable classes. One</span><span>
</span><a name="line-643"></a><span class="hs-comment">-- check that absolutely must hold is that if an instance @C (T a)@ is being</span><span>
</span><a name="line-644"></a><span class="hs-comment">-- derived, then @T@ must be a tycon for a data type or a newtype. The</span><span>
</span><a name="line-645"></a><span class="hs-comment">-- remaining checks are only performed if using a @deriving@ clause (i.e.,</span><span>
</span><a name="line-646"></a><span class="hs-comment">-- they're ignored if using @StandaloneDeriving@):</span><span>
</span><a name="line-647"></a><span class="hs-comment">--</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- 1. The data type must have at least one constructor (this check is ignored</span><span>
</span><a name="line-649"></a><span class="hs-comment">--    if using @EmptyDataDeriving@).</span><span>
</span><a name="line-650"></a><span class="hs-comment">--</span><span>
</span><a name="line-651"></a><span class="hs-comment">-- 2. The data type cannot have any GADT constructors.</span><span>
</span><a name="line-652"></a><span class="hs-comment">--</span><span>
</span><a name="line-653"></a><span class="hs-comment">-- 3. The data type cannot have any constructors with existentially quantified</span><span>
</span><a name="line-654"></a><span class="hs-comment">--    type variables.</span><span>
</span><a name="line-655"></a><span class="hs-comment">--</span><span>
</span><a name="line-656"></a><span class="hs-comment">-- 4. The data type cannot have a context (e.g., @data Foo a = Eq a =&gt; MkFoo@).</span><span>
</span><a name="line-657"></a><span class="hs-comment">--</span><span>
</span><a name="line-658"></a><span class="hs-comment">-- 5. The data type cannot have fields with higher-rank types.</span><span>
</span><a name="line-659"></a><span class="hs-identifier">cond_stdOK</span><span>
</span><a name="line-660"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#DerivContext"><span class="hs-identifier hs-type">DerivContext</span></a><span> </span><span class="hs-comment">-- ^ 'SupplyContext' if this is standalone deriving with a</span><span>
</span><a name="line-661"></a><span>                  </span><span class="hs-comment">-- user-supplied context, 'InferContext' if not.</span><span>
</span><a name="line-662"></a><span>                  </span><span class="hs-comment">-- If it is the former, we relax some of the validity checks</span><span>
</span><a name="line-663"></a><span>                  </span><span class="hs-comment">-- we would otherwise perform (i.e., &quot;just go for it&quot;).</span><span>
</span><a name="line-664"></a><span>
</span><a name="line-665"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>         </span><span class="hs-comment">-- ^ 'True' &lt;=&gt; allow higher rank arguments and empty data</span><span>
</span><a name="line-666"></a><span>                  </span><span class="hs-comment">-- types (with no data constructors) even in the absence of</span><span>
</span><a name="line-667"></a><span>                  </span><span class="hs-comment">-- the -XEmptyDataDeriving extension.</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-670"></a><a name="cond_stdOK"><a href="TcDerivUtils.html#cond_stdOK"><span class="hs-identifier">cond_stdOK</span></a></a><span> </span><a name="local-6989586621683349296"><a href="#local-6989586621683349296"><span class="hs-identifier">deriv_ctxt</span></a></a><span> </span><a name="local-6989586621683349297"><a href="#local-6989586621683349297"><span class="hs-identifier">permissive</span></a></a><span> </span><a name="local-6989586621683349298"><a href="#local-6989586621683349298"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621683349299"><a href="#local-6989586621683349299"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621683349300"><a href="#local-6989586621683349300"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-671"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349301"><span class="hs-identifier hs-var">valid_ADT</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andValid</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683349302"><span class="hs-identifier hs-var">valid_misc</span></a><span>
</span><a name="line-672"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-673"></a><span>    </span><span class="hs-identifier">valid_ADT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">valid_misc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-674"></a><span>    </span><a name="local-6989586621683349301"><a href="#local-6989586621683349301"><span class="hs-identifier">valid_ADT</span></a></a><span>
</span><a name="line-675"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621683349299"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isDataFamilyTyCon</span><span> </span><a href="#local-6989586621683349299"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-676"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-677"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-678"></a><span>        </span><span class="hs-comment">-- Complain about functions, primitive types, and other tycons that</span><span>
</span><a name="line-679"></a><span>        </span><span class="hs-comment">-- stock deriving can't handle.</span><span>
</span><a name="line-680"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The last argument of the instance must be a&quot;</span><span>
</span><a name="line-681"></a><span>               </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;data or newtype application&quot;</span><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span>    </span><a name="local-6989586621683349302"><a href="#local-6989586621683349302"><span class="hs-identifier">valid_misc</span></a></a><span>
</span><a name="line-684"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683349296"><span class="hs-identifier hs-var">deriv_ctxt</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-685"></a><span>         </span><a href="TcDerivUtils.html#SupplyContext"><span class="hs-identifier hs-var">SupplyContext</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-686"></a><span>                </span><span class="hs-comment">-- Don't check these conservative conditions for</span><span>
</span><a name="line-687"></a><span>                </span><span class="hs-comment">-- standalone deriving; just generate the code</span><span>
</span><a name="line-688"></a><span>                </span><span class="hs-comment">-- and let the typechecker handle the result</span><span>
</span><a name="line-689"></a><span>         </span><a href="TcDerivUtils.html#InferContext"><span class="hs-identifier hs-var">InferContext</span></a><span> </span><a name="local-6989586621683349308"><a href="#local-6989586621683349308"><span class="hs-identifier">wildcard</span></a></a><span>
</span><a name="line-690"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683349305"><span class="hs-identifier hs-var">data_cons</span></a><span> </span><span class="hs-comment">-- 1.</span><span>
</span><a name="line-691"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621683349297"><span class="hs-identifier hs-var">permissive</span></a><span>
</span><a name="line-692"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier hs-var">checkFlag</span></a><span> </span><span class="hs-identifier hs-var">LangExt.EmptyDataDeriving</span><span> </span><a href="#local-6989586621683349298"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683349299"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621683349300"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orValid</span><span class="hs-special">`</span><span>
</span><a name="line-693"></a><span>              </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#no_cons_why"><span class="hs-identifier hs-var">no_cons_why</span></a><span> </span><a href="#local-6989586621683349300"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621683349303"><span class="hs-identifier hs-var">empty_data_suggestion</span></a><span class="hs-special">)</span><span>
</span><a name="line-694"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683349306"><span class="hs-identifier hs-var">con_whys</span></a><span class="hs-special">)</span><span>
</span><a name="line-695"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><a href="#local-6989586621683349306"><span class="hs-identifier hs-var">con_whys</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621683349304"><span class="hs-identifier hs-var">possible_fix_suggestion</span></a><span> </span><a href="#local-6989586621683349308"><span class="hs-identifier hs-var">wildcard</span></a><span class="hs-special">)</span><span>
</span><a name="line-696"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-697"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span>    </span><a name="local-6989586621683349303"><a href="#local-6989586621683349303"><span class="hs-identifier">empty_data_suggestion</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-700"></a><span>      </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Use EmptyDataDeriving to enable deriving for empty data types&quot;</span><span>
</span><a name="line-701"></a><span>    </span><a name="local-6989586621683349304"><a href="#local-6989586621683349304"><span class="hs-identifier">possible_fix_suggestion</span></a></a><span> </span><a name="local-6989586621683349309"><a href="#local-6989586621683349309"><span class="hs-identifier">wildcard</span></a></a><span>
</span><a name="line-702"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683349309"><span class="hs-identifier hs-var">wildcard</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-703"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-704"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Possible fix: fill in the wildcard constraint yourself&quot;</span><span>
</span><a name="line-705"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-706"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Possible fix: use a standalone deriving declaration instead&quot;</span><span>
</span><a name="line-707"></a><span>    </span><a name="local-6989586621683349305"><a href="#local-6989586621683349305"><span class="hs-identifier">data_cons</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683349300"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-708"></a><span>    </span><a name="local-6989586621683349306"><a href="#local-6989586621683349306"><span class="hs-identifier">con_whys</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getInvalids</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683349307"><span class="hs-identifier hs-var">check_con</span></a><span> </span><a href="#local-6989586621683349305"><span class="hs-identifier hs-var">data_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span>    </span><span class="hs-identifier">check_con</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-711"></a><span>    </span><a name="local-6989586621683349307"><a href="#local-6989586621683349307"><span class="hs-identifier">check_con</span></a></a><span> </span><a name="local-6989586621683349310"><a href="#local-6989586621683349310"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-712"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683349312"><span class="hs-identifier hs-var">eq_spec</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 2.</span><span>
</span><a name="line-713"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349314"><span class="hs-identifier hs-var">bad</span></a><span> </span><span class="hs-string">&quot;is a GADT&quot;</span><span>
</span><a name="line-714"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683349311"><span class="hs-identifier hs-var">ex_tvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 3.</span><span>
</span><a name="line-715"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349314"><span class="hs-identifier hs-var">bad</span></a><span> </span><span class="hs-string">&quot;has existential type variables in its type&quot;</span><span>
</span><a name="line-716"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683349313"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 4.</span><span>
</span><a name="line-717"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349314"><span class="hs-identifier hs-var">bad</span></a><span> </span><span class="hs-string">&quot;has constraints in its type&quot;</span><span>
</span><a name="line-718"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349297"><span class="hs-identifier hs-var">permissive</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isTauTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConOrigArgTys</span><span> </span><a href="#local-6989586621683349310"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 5.</span><span>
</span><a name="line-719"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349314"><span class="hs-identifier hs-var">bad</span></a><span> </span><span class="hs-string">&quot;has a higher-rank type&quot;</span><span>
</span><a name="line-720"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-721"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-722"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-723"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683349311"><a href="#local-6989586621683349311"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683349312"><a href="#local-6989586621683349312"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683349313"><a href="#local-6989586621683349313"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConFullSig</span><span> </span><a href="#local-6989586621683349310"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-724"></a><span>        </span><a name="local-6989586621683349314"><a href="#local-6989586621683349314"><span class="hs-identifier">bad</span></a></a><span> </span><a name="local-6989586621683349315"><a href="#local-6989586621683349315"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-6989586621683349310"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683349315"><span class="hs-identifier hs-var">msg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span class="hs-identifier">no_cons_why</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-727"></a><a name="no_cons_why"><a href="TcDerivUtils.html#no_cons_why"><span class="hs-identifier">no_cons_why</span></a></a><span> </span><a name="local-6989586621683349316"><a href="#local-6989586621683349316"><span class="hs-identifier">rep_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprSourceTyCon</span><span> </span><a href="#local-6989586621683349316"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-728"></a><span>                     </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must have at least one data constructor&quot;</span><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-identifier">cond_RepresentableOk</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-731"></a><a name="cond_RepresentableOk"><a href="TcDerivUtils.html#cond_RepresentableOk"><span class="hs-identifier">cond_RepresentableOk</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349317"><a href="#local-6989586621683349317"><span class="hs-identifier">rep_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#canDoGenerics"><span class="hs-identifier hs-var">canDoGenerics</span></a><span> </span><a href="#local-6989586621683349317"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span class="hs-identifier">cond_Representable1Ok</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-734"></a><a name="cond_Representable1Ok"><a href="TcDerivUtils.html#cond_Representable1Ok"><span class="hs-identifier">cond_Representable1Ok</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349318"><a href="#local-6989586621683349318"><span class="hs-identifier">rep_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenGenerics.html#canDoGenerics1"><span class="hs-identifier hs-var">canDoGenerics1</span></a><span> </span><a href="#local-6989586621683349318"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span class="hs-identifier">cond_enumOrProduct</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-737"></a><a name="cond_enumOrProduct"><a href="TcDerivUtils.html#cond_enumOrProduct"><span class="hs-identifier">cond_enumOrProduct</span></a></a><span> </span><a name="local-6989586621683349319"><a href="#local-6989586621683349319"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcDerivUtils.html#cond_isEnumeration"><span class="hs-identifier hs-var">cond_isEnumeration</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#orCond"><span class="hs-identifier hs-var">orCond</span></a><span class="hs-special">`</span><span>
</span><a name="line-738"></a><span>                         </span><span class="hs-special">(</span><a href="TcDerivUtils.html#cond_isProduct"><span class="hs-identifier hs-var">cond_isProduct</span></a><span> </span><span class="hs-special">`</span><a href="TcDerivUtils.html#andCond"><span class="hs-identifier hs-var">andCond</span></a><span class="hs-special">`</span><span> </span><a href="TcDerivUtils.html#cond_args"><span class="hs-identifier hs-var">cond_args</span></a><span> </span><a href="#local-6989586621683349319"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span class="hs-identifier">cond_args</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-741"></a><span class="hs-comment">-- For some classes (eg Eq, Ord) we allow unlifted arg types</span><span>
</span><a name="line-742"></a><span class="hs-comment">-- by generating specialised code.  For others (eg Data) we don't.</span><span>
</span><a name="line-743"></a><a name="cond_args"><a href="TcDerivUtils.html#cond_args"><span class="hs-identifier">cond_args</span></a></a><span> </span><a name="local-6989586621683349320"><a href="#local-6989586621683349320"><span class="hs-identifier">cls</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349321"><a href="#local-6989586621683349321"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-744"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683349322"><span class="hs-identifier hs-var">bad_args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-745"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-746"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621683349332"><a href="#local-6989586621683349332"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Don't know how to derive&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349320"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-747"></a><span>                             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;for type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349332"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-748"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-749"></a><span>    </span><a name="local-6989586621683349322"><a href="#local-6989586621683349322"><span class="hs-identifier">bad_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683349328"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683349327"><a href="#local-6989586621683349327"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683349321"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-750"></a><span>                        </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683349328"><a href="#local-6989586621683349328"><span class="hs-identifier">arg_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">dataConOrigArgTys</span><span> </span><a href="#local-6989586621683349327"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-751"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><a href="#local-6989586621683349328"><span class="hs-identifier hs-var">arg_ty</span></a><span>
</span><a name="line-752"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349324"><span class="hs-identifier hs-var">ok_ty</span></a><span> </span><a href="#local-6989586621683349328"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-753"></a><span>
</span><a name="line-754"></a><span>    </span><a name="local-6989586621683349323"><a href="#local-6989586621683349323"><span class="hs-identifier">cls_key</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classKey</span><span> </span><a href="#local-6989586621683349320"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-755"></a><span>    </span><a name="local-6989586621683349324"><a href="#local-6989586621683349324"><span class="hs-identifier">ok_ty</span></a></a><span> </span><a name="local-6989586621683349329"><a href="#local-6989586621683349329"><span class="hs-identifier">arg_ty</span></a></a><span>
</span><a name="line-756"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349323"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">eqClassKey</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349325"><span class="hs-identifier hs-var">check_in</span></a><span> </span><a href="#local-6989586621683349329"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="TcGenDeriv.html#ordOpTbl"><span class="hs-identifier hs-var">ordOpTbl</span></a><span>
</span><a name="line-757"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349323"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">ordClassKey</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349325"><span class="hs-identifier hs-var">check_in</span></a><span> </span><a href="#local-6989586621683349329"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="TcGenDeriv.html#ordOpTbl"><span class="hs-identifier hs-var">ordOpTbl</span></a><span>
</span><a name="line-758"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349323"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">showClassKey</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349325"><span class="hs-identifier hs-var">check_in</span></a><span> </span><a href="#local-6989586621683349329"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="TcGenDeriv.html#boxConTbl"><span class="hs-identifier hs-var">boxConTbl</span></a><span>
</span><a name="line-759"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349323"><span class="hs-identifier hs-var">cls_key</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349325"><span class="hs-identifier hs-var">check_in</span></a><span> </span><a href="#local-6989586621683349329"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><a href="TcGenDeriv.html#litConTbl"><span class="hs-identifier hs-var">litConTbl</span></a><span>
</span><a name="line-760"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>    </span><span class="hs-comment">-- Read, Ix etc</span><span>
</span><a name="line-761"></a><span>
</span><a name="line-762"></a><span>    </span><span class="hs-identifier">check_in</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><a href="#local-6989586621683349326"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-763"></a><span>    </span><a name="local-6989586621683349325"><a href="#local-6989586621683349325"><span class="hs-identifier">check_in</span></a></a><span> </span><a name="local-6989586621683349330"><a href="#local-6989586621683349330"><span class="hs-identifier">arg_ty</span></a></a><span> </span><a name="local-6989586621683349331"><a href="#local-6989586621683349331"><span class="hs-identifier">tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqType</span><span> </span><a href="#local-6989586621683349330"><span class="hs-identifier hs-var">arg_ty</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683349331"><span class="hs-identifier hs-var">tbl</span></a><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span class="hs-identifier">cond_isEnumeration</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-767"></a><a name="cond_isEnumeration"><a href="TcDerivUtils.html#cond_isEnumeration"><span class="hs-identifier">cond_isEnumeration</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349333"><a href="#local-6989586621683349333"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-768"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isEnumerationTyCon</span><span> </span><a href="#local-6989586621683349333"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-769"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a href="#local-6989586621683349334"><span class="hs-identifier hs-var">why</span></a><span>
</span><a name="line-770"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-771"></a><span>    </span><a name="local-6989586621683349334"><a href="#local-6989586621683349334"><span class="hs-identifier">why</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprSourceTyCon</span><span> </span><a href="#local-6989586621683349333"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-772"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must be an enumeration type&quot;</span><span>
</span><a name="line-773"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(an enumeration consists of one or more nullary, non-GADT constructors)&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-774"></a><span>                  </span><span class="hs-comment">-- See Note [Enumeration types] in TyCon</span><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span class="hs-identifier">cond_isProduct</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-777"></a><a name="cond_isProduct"><a href="TcDerivUtils.html#cond_isProduct"><span class="hs-identifier">cond_isProduct</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349335"><a href="#local-6989586621683349335"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-778"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isProductTyCon</span><span> </span><a href="#local-6989586621683349335"><span class="hs-identifier hs-var">rep_tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-779"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a href="#local-6989586621683349336"><span class="hs-identifier hs-var">why</span></a><span>
</span><a name="line-780"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-781"></a><span>    </span><a name="local-6989586621683349336"><a href="#local-6989586621683349336"><span class="hs-identifier">why</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprSourceTyCon</span><span> </span><a href="#local-6989586621683349335"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-782"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must have precisely one constructor&quot;</span><span>
</span><a name="line-783"></a><span>
</span><a name="line-784"></a><span class="hs-identifier">cond_functorOK</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-785"></a><span class="hs-comment">-- OK for Functor/Foldable/Traversable class</span><span>
</span><a name="line-786"></a><span class="hs-comment">-- Currently: (a) at least one argument</span><span>
</span><a name="line-787"></a><span class="hs-comment">--            (b) don't use argument contravariantly</span><span>
</span><a name="line-788"></a><span class="hs-comment">--            (c) don't use argument in the wrong place, e.g. data T a = T (X a a)</span><span>
</span><a name="line-789"></a><span class="hs-comment">--            (d) optionally: don't use function types</span><span>
</span><a name="line-790"></a><span class="hs-comment">--            (e) no &quot;stupid context&quot; on data type</span><span>
</span><a name="line-791"></a><a name="cond_functorOK"><a href="TcDerivUtils.html#cond_functorOK"><span class="hs-identifier">cond_functorOK</span></a></a><span> </span><a name="local-6989586621683349337"><a href="#local-6989586621683349337"><span class="hs-identifier">allowFunctions</span></a></a><span> </span><a name="local-6989586621683349338"><a href="#local-6989586621683349338"><span class="hs-identifier">allowExQuantifiedLastTyVar</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349339"><a href="#local-6989586621683349339"><span class="hs-identifier">rep_tc</span></a></a><span>
</span><a name="line-792"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683349340"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-793"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Data type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349339"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-794"></a><span>              </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must have some type parameters&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683349342"><span class="hs-identifier hs-var">bad_stupid_theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-797"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Data type&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349339"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span>              </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must not have a class context:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprTheta</span><span> </span><a href="#local-6989586621683349342"><span class="hs-identifier hs-var">bad_stupid_theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-801"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">allValid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683349345"><span class="hs-identifier hs-var">check_con</span></a><span> </span><a href="#local-6989586621683349344"><span class="hs-identifier hs-var">data_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-802"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-803"></a><span>    </span><a name="local-6989586621683349340"><a href="#local-6989586621683349340"><span class="hs-identifier">tc_tvs</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683349339"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-804"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683349341"><a href="#local-6989586621683349341"><span class="hs-identifier">last_tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snocView</span><span> </span><a href="#local-6989586621683349340"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-805"></a><span>    </span><a name="local-6989586621683349342"><a href="#local-6989586621683349342"><span class="hs-identifier">bad_stupid_theta</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621683349343"><span class="hs-identifier hs-var">is_bad</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConStupidTheta</span><span> </span><a href="#local-6989586621683349339"><span class="hs-identifier hs-var">rep_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-806"></a><span>    </span><a name="local-6989586621683349343"><a href="#local-6989586621683349343"><span class="hs-identifier">is_bad</span></a></a><span> </span><a name="local-6989586621683349352"><a href="#local-6989586621683349352"><span class="hs-identifier">pred</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349341"><span class="hs-identifier hs-var">last_tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">exactTyCoVarsOfType</span><span> </span><a href="#local-6989586621683349352"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-807"></a><span>      </span><span class="hs-comment">-- See Note [Check that the type variable is truly universal]</span><span>
</span><a name="line-808"></a><span>
</span><a name="line-809"></a><span>    </span><a name="local-6989586621683349344"><a href="#local-6989586621683349344"><span class="hs-identifier">data_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683349339"><span class="hs-identifier hs-var">rep_tc</span></a><span>
</span><a name="line-810"></a><span>    </span><a name="local-6989586621683349345"><a href="#local-6989586621683349345"><span class="hs-identifier">check_con</span></a></a><span> </span><a name="local-6989586621683349353"><a href="#local-6989586621683349353"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">allValid</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349346"><span class="hs-identifier hs-var">check_universal</span></a><span> </span><a href="#local-6989586621683349353"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="TcGenFunctor.html#foldDataConArgs"><span class="hs-identifier hs-var">foldDataConArgs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349347"><span class="hs-identifier hs-var">ft_check</span></a><span> </span><a href="#local-6989586621683349353"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683349353"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-811"></a><span>
</span><a name="line-812"></a><span>    </span><span class="hs-identifier">check_universal</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-813"></a><span>    </span><a name="local-6989586621683349346"><a href="#local-6989586621683349346"><span class="hs-identifier">check_universal</span></a></a><span> </span><a name="local-6989586621683349354"><a href="#local-6989586621683349354"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-814"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683349338"><span class="hs-identifier hs-var">allowExQuantifiedLastTyVar</span></a><span>
</span><a name="line-815"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span> </span><span class="hs-comment">-- See Note [DeriveFoldable with ExistentialQuantification]</span><span>
</span><a name="line-816"></a><span>                </span><span class="hs-comment">-- in TcGenFunctor</span><span>
</span><a name="line-817"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683349355"><a href="#local-6989586621683349355"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getTyVar_maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConAppArgs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConOrigResTy</span><span> </span><a href="#local-6989586621683349354"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-818"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683349355"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">dataConUnivTyVars</span><span> </span><a href="#local-6989586621683349354"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-819"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683349355"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">exactTyCoVarsOfTypes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTheta</span><span> </span><a href="#local-6989586621683349354"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>   </span><span class="hs-comment">-- See Note [Check that the type variable is truly universal]</span><span>
</span><a name="line-821"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-822"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-6989586621683349354"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683349348"><span class="hs-identifier hs-var">existential</span></a><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span>    </span><span class="hs-identifier">ft_check</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcGenFunctor.html#FFoldType"><span class="hs-identifier hs-type">FFoldType</span></a><span> </span><span class="hs-identifier hs-type">Validity</span><span>
</span><a name="line-825"></a><span>    </span><a name="local-6989586621683349347"><a href="#local-6989586621683349347"><span class="hs-identifier">ft_check</span></a></a><span> </span><a name="local-6989586621683349356"><a href="#local-6989586621683349356"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcGenFunctor.html#FT"><span class="hs-identifier hs-var">FT</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ft_triv</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-826"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_co_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-6989586621683349356"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683349349"><span class="hs-identifier hs-var">covariant</span></a><span class="hs-special">)</span><span>
</span><a name="line-827"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_fun</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683349357"><a href="#local-6989586621683349357"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683349358"><a href="#local-6989586621683349358"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683349337"><span class="hs-identifier hs-var">allowFunctions</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683349357"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andValid</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683349358"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-828"></a><span>                                                           </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-6989586621683349356"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683349350"><span class="hs-identifier hs-var">functions</span></a><span class="hs-special">)</span><span>
</span><a name="line-829"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_tup</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349359"><a href="#local-6989586621683349359"><span class="hs-identifier">xs</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">allValid</span><span> </span><a href="#local-6989586621683349359"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-830"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_ty_app</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349360"><a href="#local-6989586621683349360"><span class="hs-identifier">x</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683349360"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-831"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_bad_app</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#badCon"><span class="hs-identifier hs-var">badCon</span></a><span> </span><a href="#local-6989586621683349356"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683349351"><span class="hs-identifier hs-var">wrong_arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-832"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ft_forall</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683349361"><a href="#local-6989586621683349361"><span class="hs-identifier">x</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683349361"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span>    </span><a name="local-6989586621683349348"><a href="#local-6989586621683349348"><span class="hs-identifier">existential</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must be truly polymorphic in the last argument of the data type&quot;</span><span>
</span><a name="line-835"></a><span>    </span><a name="local-6989586621683349349"><a href="#local-6989586621683349349"><span class="hs-identifier">covariant</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must not use the type variable in a function argument&quot;</span><span>
</span><a name="line-836"></a><span>    </span><a name="local-6989586621683349350"><a href="#local-6989586621683349350"><span class="hs-identifier">functions</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must not contain function types&quot;</span><span>
</span><a name="line-837"></a><span>    </span><a name="local-6989586621683349351"><a href="#local-6989586621683349351"><span class="hs-identifier">wrong_arg</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;must use the type variable only as the last argument of a data type&quot;</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span class="hs-identifier">checkFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LangExt.Extension</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#Condition"><span class="hs-identifier hs-type">Condition</span></a><span>
</span><a name="line-840"></a><a name="checkFlag"><a href="TcDerivUtils.html#checkFlag"><span class="hs-identifier">checkFlag</span></a></a><span> </span><a name="local-6989586621683349362"><a href="#local-6989586621683349362"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621683349363"><a href="#local-6989586621683349363"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-841"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">xopt</span><span> </span><a href="#local-6989586621683349362"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621683349363"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">IsValid</span><span>
</span><a name="line-842"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotValid</span><span> </span><a href="#local-6989586621683349364"><span class="hs-identifier hs-var">why</span></a><span>
</span><a name="line-843"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-844"></a><span>    </span><a name="local-6989586621683349364"><a href="#local-6989586621683349364"><span class="hs-identifier">why</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;You need &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683349365"><span class="hs-identifier hs-var">flag_str</span></a><span>
</span><a name="line-845"></a><span>          </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;to derive an instance for this class&quot;</span><span>
</span><a name="line-846"></a><span>    </span><a name="local-6989586621683349365"><a href="#local-6989586621683349365"><span class="hs-identifier">flag_str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">flagSpecName</span><span> </span><a href="#local-6989586621683349366"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683349366"><a href="#local-6989586621683349366"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">xFlags</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">flagSpecFlag</span><span> </span><a href="#local-6989586621683349366"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683349362"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-847"></a><span>                 </span><span class="hs-special">[</span><a name="local-6989586621683349367"><a href="#local-6989586621683349367"><span class="hs-identifier">s</span></a></a><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683349367"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-848"></a><span>                 </span><a name="local-6989586621683349368"><a href="#local-6989586621683349368"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;checkFlag&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349368"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span class="hs-identifier">std_class_via_coercible</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-851"></a><span class="hs-comment">-- These standard classes can be derived for a newtype</span><span>
</span><a name="line-852"></a><span class="hs-comment">-- using the coercible trick *even if no -XGeneralizedNewtypeDeriving</span><span>
</span><a name="line-853"></a><span class="hs-comment">-- because giving so gives the same results as generating the boilerplate</span><span>
</span><a name="line-854"></a><a name="std_class_via_coercible"><a href="TcDerivUtils.html#std_class_via_coercible"><span class="hs-identifier">std_class_via_coercible</span></a></a><span> </span><a name="local-6989586621683349369"><a href="#local-6989586621683349369"><span class="hs-identifier">clas</span></a></a><span>
</span><a name="line-855"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classKey</span><span> </span><a href="#local-6989586621683349369"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">eqClassKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ordClassKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ixClassKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">boundedClassKey</span><span class="hs-special">]</span><span>
</span><a name="line-856"></a><span>        </span><span class="hs-comment">-- Not Read/Show because they respect the type</span><span>
</span><a name="line-857"></a><span>        </span><span class="hs-comment">-- Not Enum, because newtypes are never in Enum</span><span>
</span><a name="line-858"></a><span>
</span><a name="line-859"></a><span>
</span><a name="line-860"></a><span class="hs-identifier">non_coercible_class</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-861"></a><span class="hs-comment">-- *Never* derive Read, Show, Typeable, Data, Generic, Generic1, Lift</span><span>
</span><a name="line-862"></a><span class="hs-comment">-- by Coercible, even with -XGeneralizedNewtypeDeriving</span><span>
</span><a name="line-863"></a><span class="hs-comment">-- Also, avoid Traversable, as the Coercible-derived instance and the &quot;normal&quot;-derived</span><span>
</span><a name="line-864"></a><span class="hs-comment">-- instance behave differently if there's a non-lawful Applicative out there.</span><span>
</span><a name="line-865"></a><span class="hs-comment">-- Besides, with roles, Coercible-deriving Traversable is ill-roled.</span><span>
</span><a name="line-866"></a><a name="non_coercible_class"><a href="TcDerivUtils.html#non_coercible_class"><span class="hs-identifier">non_coercible_class</span></a></a><span> </span><a name="local-6989586621683349370"><a href="#local-6989586621683349370"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-867"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">classKey</span><span> </span><a href="#local-6989586621683349370"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">readClassKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">showClassKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">dataClassKey</span><span>
</span><a name="line-868"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">genClassKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gen1ClassKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">typeableClassKey</span><span>
</span><a name="line-869"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">traversableClassKey</span><span class="hs-special">,</span><span> </span><a href="THNames.html#liftClassKey"><span class="hs-identifier hs-var">liftClassKey</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-870"></a><span>
</span><a name="line-871"></a><span class="hs-identifier">badCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-872"></a><a name="badCon"><a href="TcDerivUtils.html#badCon"><span class="hs-identifier">badCon</span></a></a><span> </span><a name="local-6989586621683349371"><a href="#local-6989586621683349371"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621683349372"><a href="#local-6989586621683349372"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Constructor&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683349371"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683349372"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-873"></a><span>
</span><a name="line-874"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-875"></a><span>
</span><a name="line-876"></a><span class="hs-identifier">newDerivClsInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ThetaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcDerivUtils.html#DerivSpec"><span class="hs-identifier hs-type">DerivSpec</span></a><span> </span><a href="#local-6989586621683349202"><span class="hs-identifier hs-type">theta</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span>
</span><a name="line-877"></a><a name="newDerivClsInst"><a href="TcDerivUtils.html#newDerivClsInst"><span class="hs-identifier">newDerivClsInst</span></a></a><span> </span><a name="local-6989586621683349373"><a href="#local-6989586621683349373"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-special">(</span><a href="TcDerivUtils.html#DS"><span class="hs-identifier hs-var">DS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ds_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349374"><a href="#local-6989586621683349374"><span class="hs-identifier">dfun_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_overlap</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349375"><a href="#local-6989586621683349375"><span class="hs-identifier">overlap_mode</span></a></a><span>
</span><a name="line-878"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349376"><a href="#local-6989586621683349376"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_cls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349377"><a href="#local-6989586621683349377"><span class="hs-identifier">clas</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ds_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683349378"><a href="#local-6989586621683349378"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-879"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#newClsInst"><span class="hs-identifier hs-var">newClsInst</span></a><span> </span><a href="#local-6989586621683349375"><span class="hs-identifier hs-var">overlap_mode</span></a><span> </span><a href="#local-6989586621683349374"><span class="hs-identifier hs-var">dfun_name</span></a><span> </span><a href="#local-6989586621683349376"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621683349373"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="#local-6989586621683349377"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621683349378"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span class="hs-identifier">extendLocalInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683349201"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683349201"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-882"></a><span class="hs-comment">-- Add new locally-defined instances; don't bother to check</span><span>
</span><a name="line-883"></a><span class="hs-comment">-- for functional dependency errors -- that'll happen in TcInstDcls</span><span>
</span><a name="line-884"></a><a name="extendLocalInstEnv"><a href="TcDerivUtils.html#extendLocalInstEnv"><span class="hs-identifier">extendLocalInstEnv</span></a></a><span> </span><a name="local-6989586621683349379"><a href="#local-6989586621683349379"><span class="hs-identifier">dfuns</span></a></a><span> </span><a name="local-6989586621683349380"><a href="#local-6989586621683349380"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-885"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683349381"><a href="#local-6989586621683349381"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-886"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>  </span><a name="local-6989586621683349382"><a href="#local-6989586621683349382"><span class="hs-identifier">inst_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInstEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_inst_env</span><span> </span><a href="#local-6989586621683349381"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683349379"><span class="hs-identifier hs-var">dfuns</span></a><span>
</span><a name="line-887"></a><span>             </span><a name="local-6989586621683349383"><a href="#local-6989586621683349383"><span class="hs-identifier">env'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349381"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683349382"><span class="hs-identifier hs-var">inst_env'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-888"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683349383"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621683349380"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-889"></a><span>
</span><a name="line-890"></a><span class="hs-comment">{-
Note [Deriving any class]
~~~~~~~~~~~~~~~~~~~~~~~~~
Classic uses of a deriving clause, or a standalone-deriving declaration, are
for:
  * a stock class like Eq or Show, for which GHC knows how to generate
    the instance code
  * a newtype, via the mechanism enabled by GeneralizedNewtypeDeriving

The DeriveAnyClass extension adds a third way to derive instances, based on
empty instance declarations.

The canonical use case is in combination with GHC.Generics and default method
signatures. These allow us to have instance declarations being empty, but still
useful, e.g.

  data T a = ...blah..blah... deriving( Generic )
  instance C a =&gt; C (T a)  -- No 'where' clause

where C is some &quot;random&quot; user-defined class.

This boilerplate code can be replaced by the more compact

  data T a = ...blah..blah... deriving( Generic, C )

if DeriveAnyClass is enabled.

This is not restricted to Generics; any class can be derived, simply giving
rise to an empty instance.

Unfortunately, it is not clear how to determine the context (when using a
deriving clause; in standalone deriving, the user provides the context).
GHC uses the same heuristic for figuring out the class context that it uses for
Eq in the case of *-kinded classes, and for Functor in the case of
* -&gt; *-kinded classes. That may not be optimal or even wrong. But in such
cases, standalone deriving can still be used.

Note [Check that the type variable is truly universal]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For Functor and Traversable instances, we must check that the *last argument*
of the type constructor is used truly universally quantified.  Example

   data T a b where
     T1 :: a -&gt; b -&gt; T a b      -- Fine! Vanilla H-98
     T2 :: b -&gt; c -&gt; T a b      -- Fine! Existential c, but we can still map over 'b'
     T3 :: b -&gt; T Int b         -- Fine! Constraint 'a', but 'b' is still polymorphic
     T4 :: Ord b =&gt; b -&gt; T a b  -- No!  'b' is constrained
     T5 :: b -&gt; T b b           -- No!  'b' is constrained
     T6 :: T a (b,b)            -- No!  'b' is constrained

Notice that only the first of these constructors is vanilla H-98. We only
need to take care about the last argument (b in this case).  See Trac #8678.
Eg. for T1-T3 we can write

     fmap f (T1 a b) = T1 a (f b)
     fmap f (T2 b c) = T2 (f b) c
     fmap f (T3 x)   = T3 (f x)

We need not perform these checks for Foldable instances, however, since
functions in Foldable can only consume existentially quantified type variables,
rather than produce them (as is the case in Functor and Traversable functions.)
As a result, T can have a derived Foldable instance:

    foldr f z (T1 a b) = f b z
    foldr f z (T2 b c) = f b z
    foldr f z (T3 x)   = f x z
    foldr f z (T4 x)   = f x z
    foldr f z (T5 x)   = f x z
    foldr _ z T6       = z

See Note [DeriveFoldable with ExistentialQuantification] in TcGenFunctor.

For Functor and Traversable, we must take care not to let type synonyms
unfairly reject a type for not being truly universally quantified. An
example of this is:

    type C (a :: Constraint) b = a
    data T a b = C (Show a) b =&gt; MkT b

Here, the existential context (C (Show a) b) does technically mention the last
type variable b. But this is OK, because expanding the type synonym C would
give us the context (Show a), which doesn't mention b. Therefore, we must make
sure to expand type synonyms before performing this check. Not doing so led to
Trac #13813.
-}</span><span>
</span><a name="line-975"></a></pre></body></html>