<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">--</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- GHC Extra object linking code</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- (c) The GHC Team 2017</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SysTools.ExtraObj</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-10"></a><span>  </span><a href="SysTools.ExtraObj.html#mkExtraObj"><span class="hs-identifier hs-var">mkExtraObj</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.ExtraObj.html#mkExtraObjToLinkIntoBinary"><span class="hs-identifier hs-var">mkExtraObjToLinkIntoBinary</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.ExtraObj.html#mkNoteObjsToLinkIntoBinary"><span class="hs-identifier hs-var">mkNoteObjsToLinkIntoBinary</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>  </span><a href="SysTools.ExtraObj.html#checkLinkInfo"><span class="hs-identifier hs-var">checkLinkInfo</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.ExtraObj.html#getLinkInfo"><span class="hs-identifier hs-var">getLinkInfo</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.Info.html#getCompilerInfo"><span class="hs-identifier hs-var">getCompilerInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>  </span><a href="SysTools.ExtraObj.html#ghcLinkInfoSectionName"><span class="hs-identifier hs-var">ghcLinkInfoSectionName</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.ExtraObj.html#ghcLinkInfoNoteName"><span class="hs-identifier hs-var">ghcLinkInfoNoteName</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.ExtraObj.html#platformSupportsSavingLinkOpts"><span class="hs-identifier hs-var">platformSupportsSavingLinkOpts</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>  </span><a href="SysTools.ExtraObj.html#haveRtsOptsFlags"><span class="hs-identifier hs-var">haveRtsOptsFlags</span></a><span>
</span><a name="line-14"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="AsmUtils.html"><span class="hs-identifier">AsmUtils</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Packages</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Platform</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Elf.html"><span class="hs-identifier">Elf</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.IO.Class</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FileCleanup</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.Tasks.html"><span class="hs-identifier">SysTools.Tasks</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="SysTools.Info.html"><span class="hs-identifier">SysTools.Info</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-identifier">mkExtraObj</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Suffix</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-38"></a><a name="mkExtraObj"><a href="SysTools.ExtraObj.html#mkExtraObj"><span class="hs-identifier">mkExtraObj</span></a></a><span> </span><a name="local-6989586621681248819"><a href="#local-6989586621681248819"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681248820"><a href="#local-6989586621681248820"><span class="hs-identifier">extn</span></a></a><span> </span><a name="local-6989586621681248821"><a href="#local-6989586621681248821"><span class="hs-identifier">xs</span></a></a><span>
</span><a name="line-39"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681248825"><a href="#local-6989586621681248825"><span class="hs-identifier">cFile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621681248819"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_CurrentModule</span><span> </span><a href="#local-6989586621681248820"><span class="hs-identifier hs-var">extn</span></a><span>
</span><a name="line-40"></a><span>      </span><a name="local-6989586621681248826"><a href="#local-6989586621681248826"><span class="hs-identifier">oFile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTempName</span><span> </span><a href="#local-6989586621681248819"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">TFL_GhcSession</span><span> </span><span class="hs-string">&quot;o&quot;</span><span>
</span><a name="line-41"></a><span>      </span><span class="hs-identifier hs-var">writeFile</span><span> </span><a href="#local-6989586621681248825"><span class="hs-identifier hs-var">cFile</span></a><span> </span><a href="#local-6989586621681248821"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-42"></a><span>      </span><a name="local-6989586621681248827"><a href="#local-6989586621681248827"><span class="hs-identifier">ccInfo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.Info.html#getCompilerInfo"><span class="hs-identifier hs-var">getCompilerInfo</span></a><span> </span><a href="#local-6989586621681248819"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-43"></a><span>      </span><a href="SysTools.Tasks.html#runCc"><span class="hs-identifier hs-var">runCc</span></a><span> </span><a href="#local-6989586621681248819"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-44"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span>        </span><span class="hs-string">&quot;-c&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>              </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621681248825"><span class="hs-identifier hs-var">cFile</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>              </span><span class="hs-identifier hs-var">Option</span><span>        </span><span class="hs-string">&quot;-o&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>              </span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><a href="#local-6989586621681248826"><span class="hs-identifier hs-var">oFile</span></a><span class="hs-special">]</span><span>
</span><a name="line-48"></a><span>              </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681248820"><span class="hs-identifier hs-var">extn</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-string">&quot;s&quot;</span><span>
</span><a name="line-49"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681248822"><span class="hs-identifier hs-var">cOpts</span></a><span>
</span><a name="line-50"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621681248823"><span class="hs-identifier hs-var">asmOpts</span></a><span> </span><a href="#local-6989586621681248827"><span class="hs-identifier hs-var">ccInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681248826"><span class="hs-identifier hs-var">oFile</span></a><span>
</span><a name="line-52"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-53"></a><span>      </span><span class="hs-comment">-- Pass a different set of options to the C compiler depending one whether</span><span>
</span><a name="line-54"></a><span>      </span><span class="hs-comment">-- we're compiling C or assembler. When compiling C, we pass the usual</span><span>
</span><a name="line-55"></a><span>      </span><span class="hs-comment">-- set of include directories and PIC flags.</span><span>
</span><a name="line-56"></a><span>      </span><a name="local-6989586621681248822"><a href="#local-6989586621681248822"><span class="hs-identifier">cOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">picCCOpts</span><span> </span><a href="#local-6989586621681248819"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FileOption</span><span> </span><span class="hs-string">&quot;-I&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier">includeDirs</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getPackageDetails</span><span> </span><a href="#local-6989586621681248819"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">rtsUnitId</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>      </span><span class="hs-comment">-- When compiling assembler code, we drop the usual C options, and if the</span><span>
</span><a name="line-61"></a><span>      </span><span class="hs-comment">-- compiler is Clang, we add an extra argument to tell Clang to ignore</span><span>
</span><a name="line-62"></a><span>      </span><span class="hs-comment">-- unused command line options. See trac #11684.</span><span>
</span><a name="line-63"></a><span>      </span><a name="local-6989586621681248823"><a href="#local-6989586621681248823"><span class="hs-identifier">asmOpts</span></a></a><span> </span><a name="local-6989586621681248824"><a href="#local-6989586621681248824"><span class="hs-identifier">ccInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-64"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681248824"><span class="hs-identifier hs-var">ccInfo</span></a><span> </span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Clang</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AppleClang</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AppleClang51</span><span class="hs-special">]</span><span>
</span><a name="line-65"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Option</span><span> </span><span class="hs-string">&quot;-Qunused-arguments&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-66"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-comment">-- When linking a binary, we need to create a C main() function that</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- starts everything off.  This used to be compiled statically as part</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- of the RTS, but that made it hard to change the -rtsopts setting,</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- so now we generate and compile a main() stub as part of every</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- binary and pass the -rtsopts setting directly to the RTS (#5373)</span><span>
</span><a name="line-73"></a><span class="hs-comment">--</span><span>
</span><a name="line-74"></a><span class="hs-comment">-- On Windows, when making a shared library we also may need a DllMain.</span><span>
</span><a name="line-75"></a><span class="hs-comment">--</span><span>
</span><a name="line-76"></a><span class="hs-identifier">mkExtraObjToLinkIntoBinary</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-77"></a><a name="mkExtraObjToLinkIntoBinary"><a href="SysTools.ExtraObj.html#mkExtraObjToLinkIntoBinary"><span class="hs-identifier">mkExtraObjToLinkIntoBinary</span></a></a><span> </span><a name="local-6989586621681248828"><a href="#local-6989586621681248828"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_NoHsMain</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="SysTools.ExtraObj.html#haveRtsOptsFlags"><span class="hs-identifier hs-var">haveRtsOptsFlags</span></a><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-79"></a><span>     </span><span class="hs-identifier hs-var">putLogMsg</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">NoReason</span><span> </span><span class="hs-identifier hs-var">SevInfo</span><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-80"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">defaultUserStyle</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Warning: -rtsopts and -with-rtsopts have no effect with -no-hs-main.&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-82"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;    Call hs_init_ghc() from your main() function to set these options.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>  </span><a href="SysTools.ExtraObj.html#mkExtraObj"><span class="hs-identifier hs-var">mkExtraObj</span></a><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;c&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681248829"><span class="hs-identifier hs-var">main</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-86"></a><span>    </span><a name="local-6989586621681248829"><a href="#local-6989586621681248829"><span class="hs-identifier">main</span></a></a><span>
</span><a name="line-87"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_NoHsMain</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-89"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-90"></a><span>                  </span><span class="hs-identifier hs-var">LinkDynLib</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSMinGW32</span><span>
</span><a name="line-91"></a><span>                                    </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681248831"><span class="hs-identifier hs-var">dllMain</span></a><span>
</span><a name="line-92"></a><span>                                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-93"></a><span>                  </span><span class="hs-identifier">_</span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681248830"><span class="hs-identifier hs-var">exeMain</span></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span>    </span><a name="local-6989586621681248830"><a href="#local-6989586621681248830"><span class="hs-identifier">exeMain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;#include \&quot;Rts.h\&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-97"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;extern StgClosure ZCMain_main_closure;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;int main(int argc, char *argv[])&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'{'</span><span class="hs-special">,</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; RtsConfig __conf = defaultRtsConfig;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-101"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; __conf.rts_opts_enabled = &quot;</span><span>
</span><a name="line-102"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rtsOptsEnabled</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">semi</span><span class="hs-special">,</span><span>
</span><a name="line-103"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; __conf.rts_opts_suggestions = &quot;</span><span>
</span><a name="line-104"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">rtsOptsSuggestions</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-105"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;true&quot;</span><span>
</span><a name="line-106"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;false&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">semi</span><span class="hs-special">,</span><span>
</span><a name="line-107"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;__conf.keep_cafs = &quot;</span><span>
</span><a name="line-108"></a><span>            </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_KeepCAFs</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-109"></a><span>                       </span><span class="hs-keyword">then</span><span> </span><span class="hs-string">&quot;true&quot;</span><span>
</span><a name="line-110"></a><span>                       </span><span class="hs-keyword">else</span><span> </span><span class="hs-string">&quot;false&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">semi</span><span class="hs-special">,</span><span>
</span><a name="line-111"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">rtsOpts</span><span> </span><a href="#local-6989586621681248828"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-112"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-113"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681248832"><a href="#local-6989586621681248832"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;    __conf.rts_opts= &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-114"></a><span>                          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681248832"><span class="hs-identifier hs-var">opts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">semi</span><span class="hs-special">,</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; __conf.rts_hs_main = true;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-116"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot; return hs_main(argc,argv,&amp;ZCMain_main_closure,__conf);&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-117"></a><span>        </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'}'</span><span class="hs-special">,</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'\n'</span><span> </span><span class="hs-comment">-- final newline, to keep gcc happy</span><span>
</span><a name="line-119"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span>    </span><a name="local-6989586621681248831"><a href="#local-6989586621681248831"><span class="hs-identifier">dllMain</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-122"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;#include \&quot;Rts.h\&quot;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-123"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;#include &lt;windows.h&gt;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-124"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;#include &lt;stdbool.h&gt;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-125"></a><span>        </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'\n'</span><span class="hs-special">,</span><span>
</span><a name="line-126"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;bool&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-127"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;WINAPI&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-128"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;DllMain ( HINSTANCE hInstance STG_UNUSED&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-129"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;        , DWORD reason STG_UNUSED&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-130"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;        , LPVOID reserved STG_UNUSED&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-131"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;        )&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-132"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;{&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-133"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;  return true;&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-134"></a><span>        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;}&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-135"></a><span>        </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'\n'</span><span> </span><span class="hs-comment">-- final newline, to keep gcc happy</span><span>
</span><a name="line-136"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">-- Write out the link info section into a new assembly file. Previously</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- this was included as inline assembly in the main.c file but this</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- is pretty fragile. gas gets upset trying to calculate relative offsets</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- that span the .note section (notably .text) when debug info is present</span><span>
</span><a name="line-142"></a><span class="hs-identifier">mkNoteObjsToLinkIntoBinary</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-143"></a><a name="mkNoteObjsToLinkIntoBinary"><a href="SysTools.ExtraObj.html#mkNoteObjsToLinkIntoBinary"><span class="hs-identifier">mkNoteObjsToLinkIntoBinary</span></a></a><span> </span><a name="local-6989586621681248833"><a href="#local-6989586621681248833"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681248834"><a href="#local-6989586621681248834"><span class="hs-identifier">dep_packages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-144"></a><span>   </span><a name="local-6989586621681248837"><a href="#local-6989586621681248837"><span class="hs-identifier">link_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.ExtraObj.html#getLinkInfo"><span class="hs-identifier hs-var">getLinkInfo</span></a><span> </span><a href="#local-6989586621681248833"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681248834"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span>   </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="SysTools.ExtraObj.html#platformSupportsSavingLinkOpts"><span class="hs-identifier hs-var">platformSupportsSavingLinkOpts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681248833"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>     </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="SysTools.ExtraObj.html#mkExtraObj"><span class="hs-identifier hs-var">mkExtraObj</span></a><span> </span><a href="#local-6989586621681248833"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;s&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">showSDoc</span><span> </span><a href="#local-6989586621681248833"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681248835"><span class="hs-identifier hs-var">link_opts</span></a><span> </span><a href="#local-6989586621681248837"><span class="hs-identifier hs-var">link_info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-151"></a><span>    </span><a name="local-6989586621681248835"><a href="#local-6989586621681248835"><span class="hs-identifier">link_opts</span></a></a><span> </span><a name="local-6989586621681248836"><a href="#local-6989586621681248836"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hcat</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-152"></a><span>      </span><span class="hs-comment">-- &quot;link info&quot; section (see Note [LinkInfo section])</span><span>
</span><a name="line-153"></a><span>      </span><a href="Elf.html#makeElfNote"><span class="hs-identifier hs-var">makeElfNote</span></a><span> </span><a href="SysTools.ExtraObj.html#ghcLinkInfoSectionName"><span class="hs-identifier hs-var">ghcLinkInfoSectionName</span></a><span> </span><a href="SysTools.ExtraObj.html#ghcLinkInfoNoteName"><span class="hs-identifier hs-var">ghcLinkInfoNoteName</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681248836"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">,</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>      </span><span class="hs-comment">-- ALL generated assembly must have this section to disable</span><span>
</span><a name="line-156"></a><span>      </span><span class="hs-comment">-- executable stacks.  See also</span><span>
</span><a name="line-157"></a><span>      </span><span class="hs-comment">-- compiler/nativeGen/AsmCodeGen.hs for another instance</span><span>
</span><a name="line-158"></a><span>      </span><span class="hs-comment">-- where we need to do this.</span><span>
</span><a name="line-159"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">platformHasGnuNonexecStack</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681248833"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.section .note.GNU-stack,\&quot;\&quot;,&quot;</span><span>
</span><a name="line-161"></a><span>             </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="AsmUtils.html#sectionType"><span class="hs-identifier hs-var">sectionType</span></a><span> </span><span class="hs-string">&quot;progbits&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'\n'</span><span>
</span><a name="line-162"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-163"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-comment">-- | Return the &quot;link info&quot; string</span><span>
</span><a name="line-166"></a><span class="hs-comment">--</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- See Note [LinkInfo section]</span><span>
</span><a name="line-168"></a><span class="hs-identifier">getLinkInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-169"></a><a name="getLinkInfo"><a href="SysTools.ExtraObj.html#getLinkInfo"><span class="hs-identifier">getLinkInfo</span></a></a><span> </span><a name="local-6989586621681248838"><a href="#local-6989586621681248838"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681248839"><a href="#local-6989586621681248839"><span class="hs-identifier">dep_packages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-170"></a><span>   </span><a name="local-6989586621681248840"><a href="#local-6989586621681248840"><span class="hs-identifier">package_link_opts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getPackageLinkOpts</span><span> </span><a href="#local-6989586621681248838"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681248839"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-171"></a><span>   </span><a name="local-6989586621681248841"><a href="#local-6989586621681248841"><span class="hs-identifier">pkg_frameworks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">platformUsesFrameworks</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681248838"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>                     </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">getPackageFrameworks</span><span> </span><a href="#local-6989586621681248838"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681248839"><span class="hs-identifier hs-var">dep_packages</span></a><span>
</span><a name="line-173"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-174"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681248842"><a href="#local-6989586621681248842"><span class="hs-identifier">extra_ld_inputs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ldInputs</span><span> </span><a href="#local-6989586621681248838"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-175"></a><span>   </span><span class="hs-keyword">let</span><span>
</span><a name="line-176"></a><span>      </span><a name="local-6989586621681248843"><a href="#local-6989586621681248843"><span class="hs-identifier">link_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681248840"><span class="hs-identifier hs-var">package_link_opts</span></a><span class="hs-special">,</span><span>
</span><a name="line-177"></a><span>                   </span><a href="#local-6989586621681248841"><span class="hs-identifier hs-var">pkg_frameworks</span></a><span class="hs-special">,</span><span>
</span><a name="line-178"></a><span>                   </span><span class="hs-identifier">rtsOpts</span><span> </span><a href="#local-6989586621681248838"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>
</span><a name="line-179"></a><span>                   </span><span class="hs-identifier">rtsOptsEnabled</span><span> </span><a href="#local-6989586621681248838"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>
</span><a name="line-180"></a><span>                   </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_NoHsMain</span><span> </span><a href="#local-6989586621681248838"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span>
</span><a name="line-181"></a><span>                   </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">showOpt</span><span> </span><a href="#local-6989586621681248842"><span class="hs-identifier hs-var">extra_ld_inputs</span></a><span class="hs-special">,</span><span>
</span><a name="line-182"></a><span>                   </span><span class="hs-identifier hs-var">getOpts</span><span> </span><a href="#local-6989586621681248838"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">opt_l</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>   </span><span class="hs-comment">--</span><span>
</span><a name="line-184"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681248843"><span class="hs-identifier hs-var">link_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-identifier">platformSupportsSavingLinkOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OS</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-187"></a><a name="platformSupportsSavingLinkOpts"><a href="SysTools.ExtraObj.html#platformSupportsSavingLinkOpts"><span class="hs-identifier">platformSupportsSavingLinkOpts</span></a></a><span> </span><a name="local-6989586621681248844"><a href="#local-6989586621681248844"><span class="hs-identifier">os</span></a></a><span>
</span><a name="line-188"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681248844"><span class="hs-identifier hs-var">os</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">OSSolaris2</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- see #5382</span><span>
</span><a name="line-189"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">osElfTarget</span><span> </span><a href="#local-6989586621681248844"><span class="hs-identifier hs-var">os</span></a><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-comment">-- See Note [LinkInfo section]</span><span>
</span><a name="line-192"></a><span class="hs-identifier">ghcLinkInfoSectionName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-193"></a><a name="ghcLinkInfoSectionName"><a href="SysTools.ExtraObj.html#ghcLinkInfoSectionName"><span class="hs-identifier">ghcLinkInfoSectionName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;.debug-ghc-link-info&quot;</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-comment">-- if we use the &quot;.debug&quot; prefix, then strip will strip it by default</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span class="hs-comment">-- Identifier for the note (see Note [LinkInfo section])</span><span>
</span><a name="line-197"></a><span class="hs-identifier">ghcLinkInfoNoteName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-198"></a><a name="ghcLinkInfoNoteName"><a href="SysTools.ExtraObj.html#ghcLinkInfoNoteName"><span class="hs-identifier">ghcLinkInfoNoteName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;GHC link info&quot;</span><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-comment">-- Returns 'False' if it was, and we can avoid linking, because the</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- previous binary was linked with &quot;the same options&quot;.</span><span>
</span><a name="line-202"></a><span class="hs-identifier">checkLinkInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InstalledUnitId</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-203"></a><a name="checkLinkInfo"><a href="SysTools.ExtraObj.html#checkLinkInfo"><span class="hs-identifier">checkLinkInfo</span></a></a><span> </span><a name="local-6989586621681248845"><a href="#local-6989586621681248845"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681248846"><a href="#local-6989586621681248846"><span class="hs-identifier">pkg_deps</span></a></a><span> </span><a name="local-6989586621681248847"><a href="#local-6989586621681248847"><span class="hs-identifier">exe_file</span></a></a><span>
</span><a name="line-204"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SysTools.ExtraObj.html#platformSupportsSavingLinkOpts"><span class="hs-identifier hs-var">platformSupportsSavingLinkOpts</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">targetPlatform</span><span> </span><a href="#local-6989586621681248845"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span> </span><span class="hs-comment">-- ToDo: Windows and OS X do not use the ELF binary format, so</span><span>
</span><a name="line-206"></a><span> </span><span class="hs-comment">-- readelf does not work there.  We need to find another way to do</span><span>
</span><a name="line-207"></a><span> </span><span class="hs-comment">-- this.</span><span>
</span><a name="line-208"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- conservatively we should return True, but not</span><span>
</span><a name="line-209"></a><span>                </span><span class="hs-comment">-- linking in this case was the behaviour for a long</span><span>
</span><a name="line-210"></a><span>                </span><span class="hs-comment">-- time so we leave it as-is.</span><span>
</span><a name="line-211"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-212"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-213"></a><span>   </span><a name="local-6989586621681248848"><a href="#local-6989586621681248848"><span class="hs-identifier">link_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.ExtraObj.html#getLinkInfo"><span class="hs-identifier hs-var">getLinkInfo</span></a><span> </span><a href="#local-6989586621681248845"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681248846"><span class="hs-identifier hs-var">pkg_deps</span></a><span>
</span><a name="line-214"></a><span>   </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621681248845"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Link info: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681248848"><span class="hs-identifier hs-var">link_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>   </span><a name="local-6989586621681248849"><a href="#local-6989586621681248849"><span class="hs-identifier">m_exe_link_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Elf.html#readElfNoteAsString"><span class="hs-identifier hs-var">readElfNoteAsString</span></a><span> </span><a href="#local-6989586621681248845"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681248847"><span class="hs-identifier hs-var">exe_file</span></a><span>
</span><a name="line-216"></a><span>                          </span><a href="SysTools.ExtraObj.html#ghcLinkInfoSectionName"><span class="hs-identifier hs-var">ghcLinkInfoSectionName</span></a><span> </span><a href="SysTools.ExtraObj.html#ghcLinkInfoNoteName"><span class="hs-identifier hs-var">ghcLinkInfoNoteName</span></a><span>
</span><a name="line-217"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681248850"><a href="#local-6989586621681248850"><span class="hs-identifier">sameLinkInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681248848"><span class="hs-identifier hs-var">link_info</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681248849"><span class="hs-identifier hs-var">m_exe_link_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>   </span><span class="hs-identifier hs-var">debugTraceMsg</span><span> </span><a href="#local-6989586621681248845"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681248849"><span class="hs-identifier hs-var">m_exe_link_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-219"></a><span>     </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Exe link info: Not found&quot;</span><span>
</span><a name="line-220"></a><span>     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681248851"><a href="#local-6989586621681248851"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-221"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681248850"><span class="hs-identifier hs-var">sameLinkInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Exe link info is the same&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Exe link info is different: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681248851"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681248850"><span class="hs-identifier hs-var">sameLinkInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">{- Note [LinkInfo section]
   ~~~~~~~~~~~~~~~~~~~~~~~

The &quot;link info&quot; is a string representing the parameters of the link. We save
this information in the binary, and the next time we link, if nothing else has
changed, we use the link info stored in the existing binary to decide whether
to re-link or not.

The &quot;link info&quot; string is stored in a ELF section called &quot;.debug-ghc-link-info&quot;
(see ghcLinkInfoSectionName) with the SHT_NOTE type.  For some time, it used to
not follow the specified record-based format (see #11022).

-}</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-identifier">haveRtsOptsFlags</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-240"></a><a name="haveRtsOptsFlags"><a href="SysTools.ExtraObj.html#haveRtsOptsFlags"><span class="hs-identifier">haveRtsOptsFlags</span></a></a><span> </span><a name="local-6989586621681248852"><a href="#local-6989586621681248852"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rtsOpts</span><span> </span><a href="#local-6989586621681248852"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">rtsOptsEnabled</span><span> </span><a href="#local-6989586621681248852"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-242"></a><span>                                       </span><span class="hs-identifier hs-var">RtsOptsSafeOnly</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-243"></a><span>                                       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-244"></a></pre></body></html>