<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-2"></a><span class="hs-comment">--</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- Stg to C-- code generation: bindings</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">-- (c) The University of Glasgow 2004-2006</span><span>
</span><a name="line-6"></a><span class="hs-comment">--</span><span>
</span><a name="line-7"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCmmBind</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-10"></a><span>        </span><a href="StgCmmBind.html#cgTopRhsClosure"><span class="hs-identifier hs-var">cgTopRhsClosure</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>        </span><a href="StgCmmBind.html#cgBind"><span class="hs-identifier hs-var">cgBind</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>        </span><a href="StgCmmBind.html#emitBlackHoleCode"><span class="hs-identifier hs-var">emitBlackHoleCode</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>        </span><a href="StgCmmBind.html#pushUpdateFrame"><span class="hs-identifier hs-var">pushUpdateFrame</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmBind.html#emitUpdateFrame"><span class="hs-identifier hs-var">emitUpdateFrame</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;*&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmExpr.html"><span class="hs-identifier">StgCmmExpr</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmMonad.html"><span class="hs-identifier">StgCmmMonad</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmEnv.html"><span class="hs-identifier">StgCmmEnv</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmCon.html"><span class="hs-identifier">StgCmmCon</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmHeap.html"><span class="hs-identifier">StgCmmHeap</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmProf.html"><span class="hs-identifier">StgCmmProf</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmProf.html#ldvEnterClosure"><span class="hs-identifier hs-var">ldvEnterClosure</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmProf.html#enterCostCentreFun"><span class="hs-identifier hs-var">enterCostCentreFun</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmProf.html#enterCostCentreThunk"><span class="hs-identifier hs-var">enterCostCentreThunk</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>                   </span><a href="StgCmmProf.html#initUpdFrameProf"><span class="hs-identifier hs-var">initUpdFrameProf</span></a><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmTicky.html"><span class="hs-identifier">StgCmmTicky</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmLayout.html"><span class="hs-identifier">StgCmmLayout</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmUtils.html"><span class="hs-identifier">StgCmmUtils</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmClosure.html"><span class="hs-identifier">StgCmmClosure</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="StgCmmForeign.html"><span class="hs-identifier">StgCmmForeign</span></a><span>    </span><span class="hs-special">(</span><a href="StgCmmForeign.html#emitPrimCall"><span class="hs-identifier hs-var">emitPrimCall</span></a><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="MkGraph.html"><span class="hs-identifier">MkGraph</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">AltCon</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">tickishIsCode</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="CmmInfo.html"><span class="hs-identifier">CmmInfo</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CostCentre</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-56"></a><span class="hs-comment">--              Top-level bindings</span><span>
</span><a name="line-57"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">-- For closures bound at top level, allocate in static space.</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- They should have no free variables.</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-identifier">cgTopRhsClosure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-63"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RecFlag</span><span>              </span><span class="hs-comment">-- member of a recursive group?</span><span>
</span><a name="line-64"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-65"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span>      </span><span class="hs-comment">-- Optional cost centre annotation</span><span>
</span><a name="line-66"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#UpdateFlag"><span class="hs-identifier hs-type">UpdateFlag</span></a><span>
</span><a name="line-67"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- Args</span><span>
</span><a name="line-68"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span>
</span><a name="line-69"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><a name="cgTopRhsClosure"><a href="StgCmmBind.html#cgTopRhsClosure"><span class="hs-identifier">cgTopRhsClosure</span></a></a><span> </span><a name="local-6989586621681542755"><a href="#local-6989586621681542755"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681542756"><a href="#local-6989586621681542756"><span class="hs-identifier">rec</span></a></a><span> </span><a name="local-6989586621681542757"><a href="#local-6989586621681542757"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621681542758"><a href="#local-6989586621681542758"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621681542759"><a href="#local-6989586621681542759"><span class="hs-identifier">upd_flag</span></a></a><span> </span><a name="local-6989586621681542760"><a href="#local-6989586621681542760"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681542761"><a href="#local-6989586621681542761"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-72"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542779"><a href="#local-6989586621681542779"><span class="hs-identifier">closure_label</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkLocalClosureLabel"><span class="hs-identifier hs-var">mkLocalClosureLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681542757"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idCafInfo</span><span> </span><a href="#local-6989586621681542757"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>      </span><a name="local-6989586621681542780"><a href="#local-6989586621681542780"><span class="hs-identifier">cg_id_info</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmEnv.html#litIdInfo"><span class="hs-identifier hs-var">litIdInfo</span></a><span> </span><a href="#local-6989586621681542755"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542757"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621681542781"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a href="#local-6989586621681542779"><span class="hs-identifier hs-var">closure_label</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>      </span><a name="local-6989586621681542781"><a href="#local-6989586621681542781"><span class="hs-identifier">lf_info</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmBind.html#mkClosureLFInfo"><span class="hs-identifier hs-var">mkClosureLFInfo</span></a><span> </span><a href="#local-6989586621681542755"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542757"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-identifier hs-var">TopLevel</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681542759"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621681542760"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-75"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681542780"><span class="hs-identifier hs-var">cg_id_info</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542762"><span class="hs-identifier hs-var">gen_code</span></a><span> </span><a href="#local-6989586621681542755"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542781"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542779"><span class="hs-identifier hs-var">closure_label</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-comment">-- special case for a indirection (f = g).  We create an IND_STATIC</span><span>
</span><a name="line-78"></a><span>  </span><span class="hs-comment">-- closure pointing directly to the indirectee.  This is exactly</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-comment">-- what the CAF will eventually evaluate to anyway, we're just</span><span>
</span><a name="line-80"></a><span>  </span><span class="hs-comment">-- shortcutting the whole process, and generating a lot less code</span><span>
</span><a name="line-81"></a><span>  </span><span class="hs-comment">-- (#7308)</span><span>
</span><a name="line-82"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-83"></a><span>  </span><span class="hs-comment">-- Note: we omit the optimisation when this binding is part of a</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-comment">-- recursive group, because the optimisation would inhibit the black</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-comment">-- hole detection from working in that case.  Test</span><span>
</span><a name="line-86"></a><span>  </span><span class="hs-comment">-- concurrent/should_run/4030 fails, for instance.</span><span>
</span><a name="line-87"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-88"></a><span>  </span><a name="local-6989586621681542762"><a href="#local-6989586621681542762"><span class="hs-identifier">gen_code</span></a></a><span> </span><a name="local-6989586621681542764"><a href="#local-6989586621681542764"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681542765"><a href="#local-6989586621681542765"><span class="hs-identifier">closure_label</span></a></a><span>
</span><a name="line-89"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621681542766"><a href="#local-6989586621681542766"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681542761"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681542760"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isNonRec</span><span> </span><a href="#local-6989586621681542756"><span class="hs-identifier hs-var">rec</span></a><span>
</span><a name="line-90"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-91"></a><span>         </span><a name="local-6989586621681542767"><a href="#local-6989586621681542767"><span class="hs-identifier">cg_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#getCgIdInfo"><span class="hs-identifier hs-var">getCgIdInfo</span></a><span> </span><a href="#local-6989586621681542766"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-92"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542768"><a href="#local-6989586621681542768"><span class="hs-identifier">closure_rep</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmHeap.html#mkStaticClosureFields"><span class="hs-identifier hs-var">mkStaticClosureFields</span></a><span> </span><a href="#local-6989586621681542764"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-93"></a><span>                                    </span><a href="StgCmmClosure.html#indStaticInfoTable"><span class="hs-identifier hs-var">indStaticInfoTable</span></a><span> </span><a href="#local-6989586621681542758"><span class="hs-identifier hs-var">ccs</span></a><span> </span><span class="hs-identifier hs-var">MayHaveCafRefs</span><span>
</span><a name="line-94"></a><span>                                    </span><span class="hs-special">[</span><a href="#local-6989586621681542763"><span class="hs-identifier hs-var">unLit</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmEnv.html#idInfoToAmode"><span class="hs-identifier hs-var">idInfoToAmode</span></a><span> </span><a href="#local-6989586621681542767"><span class="hs-identifier hs-var">cg_info</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-95"></a><span>         </span><a href="StgCmmUtils.html#emitDataLits"><span class="hs-identifier hs-var">emitDataLits</span></a><span> </span><a href="#local-6989586621681542765"><span class="hs-identifier hs-var">closure_label</span></a><span> </span><a href="#local-6989586621681542768"><span class="hs-identifier hs-var">closure_rep</span></a><span>
</span><a name="line-96"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>  </span><span class="hs-identifier">gen_code</span><span> </span><a name="local-6989586621681542769"><a href="#local-6989586621681542769"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681542770"><a href="#local-6989586621681542770"><span class="hs-identifier">lf_info</span></a></a><span> </span><a name="local-6989586621681542771"><a href="#local-6989586621681542771"><span class="hs-identifier">_closure_label</span></a></a><span>
</span><a name="line-99"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542772"><a href="#local-6989586621681542772"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681542757"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-100"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542773"><a href="#local-6989586621681542773"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getModuleName"><span class="hs-identifier hs-var">getModuleName</span></a><span>
</span><a name="line-101"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542774"><a href="#local-6989586621681542774"><span class="hs-identifier">descr</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmBind.html#closureDescription"><span class="hs-identifier hs-var">closureDescription</span></a><span> </span><a href="#local-6989586621681542769"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542773"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621681542772"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-102"></a><span>              </span><a name="local-6989586621681542775"><a href="#local-6989586621681542775"><span class="hs-identifier">closure_info</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkClosureInfo"><span class="hs-identifier hs-var">mkClosureInfo</span></a><span> </span><a href="#local-6989586621681542769"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621681542757"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621681542770"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621681542774"><span class="hs-identifier hs-var">descr</span></a><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span>        </span><span class="hs-comment">-- We don't generate the static closure here, because we might</span><span>
</span><a name="line-105"></a><span>        </span><span class="hs-comment">-- want to add references to static closures to it later.  The</span><span>
</span><a name="line-106"></a><span>        </span><span class="hs-comment">-- static closure is generated by CmmBuildInfoTables.updInfoSRTs,</span><span>
</span><a name="line-107"></a><span>        </span><span class="hs-comment">-- See Note [SRTs], specifically the [FUN] optimisation.</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">fv_details</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-110"></a><span>              </span><a name="local-6989586621681542776"><a href="#local-6989586621681542776"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="StgCmmClosure.html#isLFThunk"><span class="hs-identifier hs-var">isLFThunk</span></a><span> </span><a href="#local-6989586621681542770"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="StgCmmLayout.html#ThunkHeader"><span class="hs-identifier hs-var">ThunkHeader</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmLayout.html#StdHeader"><span class="hs-identifier hs-var">StdHeader</span></a><span>
</span><a name="line-111"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681542777"><a href="#local-6989586621681542777"><span class="hs-identifier">fv_details</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmLayout.html#mkVirtHeapOffsets"><span class="hs-identifier hs-var">mkVirtHeapOffsets</span></a><span> </span><a href="#local-6989586621681542769"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542776"><span class="hs-identifier hs-var">header</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-112"></a><span>        </span><span class="hs-comment">-- Don't drop the non-void args until the closure info has been made</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#forkClosureBody"><span class="hs-identifier hs-var">forkClosureBody</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmBind.html#closureCodeBody"><span class="hs-identifier hs-var">closureCodeBody</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621681542757"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621681542775"><span class="hs-identifier hs-var">closure_info</span></a><span> </span><a href="#local-6989586621681542758"><span class="hs-identifier hs-var">ccs</span></a><span>
</span><a name="line-114"></a><span>                                </span><span class="hs-special">(</span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">nonVoidIds</span></a><span> </span><a href="#local-6989586621681542760"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681542760"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542761"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621681542777"><span class="hs-identifier hs-var">fv_details</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span>  </span><a name="local-6989586621681542763"><a href="#local-6989586621681542763"><span class="hs-identifier">unLit</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><a name="local-6989586621681542778"><a href="#local-6989586621681542778"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681542778"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-119"></a><span>  </span><span class="hs-identifier">unLit</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;unLit&quot;</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-122"></a><span class="hs-comment">--              Non-top-level bindings</span><span>
</span><a name="line-123"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-identifier">cgBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#CgStgBinding"><span class="hs-identifier hs-type">CgStgBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><a name="cgBind"><a href="StgCmmBind.html#cgBind"><span class="hs-identifier">cgBind</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621681542782"><a href="#local-6989586621681542782"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621681542783"><a href="#local-6989586621681542783"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681542784"><a href="#local-6989586621681542784"><span class="hs-identifier">info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542785"><a href="#local-6989586621681542785"><span class="hs-identifier">fcode</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmBind.html#cgRhs"><span class="hs-identifier hs-var">cgRhs</span></a><span> </span><a href="#local-6989586621681542782"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621681542783"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-128"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmEnv.html#addBindC"><span class="hs-identifier hs-var">addBindC</span></a><span> </span><a href="#local-6989586621681542784"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-129"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542786"><a href="#local-6989586621681542786"><span class="hs-identifier">init</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681542785"><span class="hs-identifier hs-var">fcode</span></a><span>
</span><a name="line-130"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><a href="#local-6989586621681542786"><span class="hs-identifier hs-var">init</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-131"></a><span>        </span><span class="hs-comment">-- init cannot be used in body, so slightly better to sink it eagerly</span><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-identifier">cgBind</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621681542787"><a href="#local-6989586621681542787"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>  </span><a name="local-6989586621681542788"><a href="#local-6989586621681542788"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unzipWith</span><span> </span><a href="StgCmmBind.html#cgRhs"><span class="hs-identifier hs-var">cgRhs</span></a><span> </span><a href="#local-6989586621681542787"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-135"></a><span>        </span><span class="hs-special">;</span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681542789"><a href="#local-6989586621681542789"><span class="hs-identifier">id_infos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542790"><a href="#local-6989586621681542790"><span class="hs-identifier">fcodes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621681542788"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-136"></a><span>        </span><span class="hs-special">;</span><span>  </span><a href="StgCmmEnv.html#addBindsC"><span class="hs-identifier hs-var">addBindsC</span></a><span> </span><a href="#local-6989586621681542789"><span class="hs-identifier hs-var">id_infos</span></a><span>
</span><a name="line-137"></a><span>        </span><span class="hs-special">;</span><span>  </span><span class="hs-special">(</span><a name="local-6989586621681542791"><a href="#local-6989586621681542791"><span class="hs-identifier">inits</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542792"><a href="#local-6989586621681542792"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getCodeR"><span class="hs-identifier hs-var">getCodeR</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><a href="#local-6989586621681542790"><span class="hs-identifier hs-var">fcodes</span></a><span>
</span><a name="line-138"></a><span>        </span><span class="hs-special">;</span><span>  </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#catAGraphs"><span class="hs-identifier hs-var">catAGraphs</span></a><span> </span><a href="#local-6989586621681542791"><span class="hs-identifier hs-var">inits</span></a><span> </span><a href="MkGraph.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a><span> </span><a href="#local-6989586621681542792"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-comment">{- Note [cgBind rec]

   Recursive let-bindings are tricky.
   Consider the following pseudocode:

     let x = \_ -&gt;  ... y ...
         y = \_ -&gt;  ... z ...
         z = \_ -&gt;  ... x ...
     in ...

   For each binding, we need to allocate a closure, and each closure must
   capture the address of the other closures.
   We want to generate the following C-- code:
     // Initialization Code
     x = hp - 24; // heap address of x's closure
     y = hp - 40; // heap address of x's closure
     z = hp - 64; // heap address of x's closure
     // allocate and initialize x
     m[hp-8]   = ...
     m[hp-16]  = y       // the closure for x captures y
     m[hp-24] = x_info;
     // allocate and initialize y
     m[hp-32] = z;       // the closure for y captures z
     m[hp-40] = y_info;
     // allocate and initialize z
     ...

   For each closure, we must generate not only the code to allocate and
   initialize the closure itself, but also some initialization Code that
   sets a variable holding the closure pointer.

   We could generate a pair of the (init code, body code), but since
   the bindings are recursive we also have to initialise the
   environment with the CgIdInfo for all the bindings before compiling
   anything.  So we do this in 3 stages:

     1. collect all the CgIdInfos and initialise the environment
     2. compile each binding into (init, body) code
     3. emit all the inits, and then all the bodies

   We'd rather not have separate functions to do steps 1 and 2 for
   each binding, since in pratice they share a lot of code.  So we
   have just one function, cgRhs, that returns a pair of the CgIdInfo
   for step 1, and a monadic computation to generate the code in step
   2.

   The alternative to separating things in this way is to use a
   fixpoint.  That's what we used to do, but it introduces a
   maintenance nightmare because there is a subtle dependency on not
   being too strict everywhere.  Doing things this way means that the
   FCode monad can be strict, for example.
 -}</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-identifier">cgRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-194"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgRhs"><span class="hs-identifier hs-type">CgStgRhs</span></a><span>
</span><a name="line-195"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-196"></a><span>                 </span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span>         </span><span class="hs-comment">-- The info for this binding</span><span>
</span><a name="line-197"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span>  </span><span class="hs-comment">-- A computation which will generate the</span><span>
</span><a name="line-198"></a><span>                                  </span><span class="hs-comment">-- code for the binding, and return an</span><span>
</span><a name="line-199"></a><span>                                  </span><span class="hs-comment">-- assignent of the form &quot;x = Hp - n&quot;</span><span>
</span><a name="line-200"></a><span>                                  </span><span class="hs-comment">-- (see above)</span><span>
</span><a name="line-201"></a><span>               </span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>
</span><a name="line-203"></a><a name="cgRhs"><a href="StgCmmBind.html#cgRhs"><span class="hs-identifier">cgRhs</span></a></a><span> </span><a name="local-6989586621681542793"><a href="#local-6989586621681542793"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621681542794"><a href="#local-6989586621681542794"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681542795"><a href="#local-6989586621681542795"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621681542796"><a href="#local-6989586621681542796"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounterCon"><span class="hs-identifier hs-var">withNewTickyCounterCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681542793"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-205"></a><span>    </span><a href="StgCmmCon.html#buildDynCon"><span class="hs-identifier hs-var">buildDynCon</span></a><span> </span><a href="#local-6989586621681542793"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621681542794"><span class="hs-identifier hs-var">cc</span></a><span> </span><a href="#local-6989586621681542795"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#assertNonVoidStgArgs"><span class="hs-identifier hs-var">assertNonVoidStgArgs</span></a><span> </span><a href="#local-6989586621681542796"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>      </span><span class="hs-comment">-- con args are always non-void,</span><span>
</span><a name="line-207"></a><span>      </span><span class="hs-comment">-- see Note [Post-unarisation invariants] in UnariseStg</span><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-comment">{- See Note [GC recovery] in compiler/codeGen/StgCmmClosure.hs -}</span><span>
</span><a name="line-210"></a><span class="hs-identifier">cgRhs</span><span> </span><a name="local-6989586621681542797"><a href="#local-6989586621681542797"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621681542798"><a href="#local-6989586621681542798"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621681542799"><a href="#local-6989586621681542799"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681542800"><a href="#local-6989586621681542800"><span class="hs-identifier">upd_flag</span></a></a><span> </span><a name="local-6989586621681542801"><a href="#local-6989586621681542801"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681542802"><a href="#local-6989586621681542802"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681542803"><a href="#local-6989586621681542803"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-212"></a><span>       </span><a href="StgCmmBind.html#mkRhsClosure"><span class="hs-identifier hs-var">mkRhsClosure</span></a><span> </span><a href="#local-6989586621681542803"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542797"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621681542799"><span class="hs-identifier hs-var">cc</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">nonVoidIds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dVarSetElems</span><span> </span><a href="#local-6989586621681542798"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542800"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621681542801"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621681542802"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-215"></a><span class="hs-comment">--              Non-constructor right hand sides</span><span>
</span><a name="line-216"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-identifier">mkRhsClosure</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span>
</span><a name="line-219"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>                    </span><span class="hs-comment">-- Free vars</span><span>
</span><a name="line-220"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#UpdateFlag"><span class="hs-identifier hs-type">UpdateFlag</span></a><span>
</span><a name="line-221"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>                            </span><span class="hs-comment">-- Args</span><span>
</span><a name="line-222"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span>
</span><a name="line-223"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-comment">{- mkRhsClosure looks for two special forms of the right-hand side:
        a) selector thunks
        b) AP thunks

If neither happens, it just calls mkClosureLFInfo.  You might think
that mkClosureLFInfo should do all this, but it seems wrong for the
latter to look at the structure of an expression

Note [Selectors]
~~~~~~~~~~~~~~~~
We look at the body of the closure to see if it's a selector---turgid,
but nothing deep.  We are looking for a closure of {\em exactly} the
form:

...  = [the_fv] \ u [] -&gt;
         case the_fv of
           con a_1 ... a_n -&gt; a_i

Note [Ap thunks]
~~~~~~~~~~~~~~~~
A more generic AP thunk of the form

        x = [ x_1...x_n ] \.. [] -&gt; x_1 ... x_n

A set of these is compiled statically into the RTS, so we just use
those.  We could extend the idea to thunks where some of the x_i are
global ids (and hence not free variables), but this would entail
generating a larger thunk.  It might be an option for non-optimising
compilation, though.

We only generate an Ap thunk if all the free variables are pointers,
for semi-obvious reasons.

-}</span><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span class="hs-comment">---------- Note [Selectors] ------------------</span><span>
</span><a name="line-261"></a><a name="mkRhsClosure"><a href="StgCmmBind.html#mkRhsClosure"><span class="hs-identifier">mkRhsClosure</span></a></a><span>    </span><a name="local-6989586621681542804"><a href="#local-6989586621681542804"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681542805"><a href="#local-6989586621681542805"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681542806"><a href="#local-6989586621681542806"><span class="hs-identifier">_cc</span></a></a><span>
</span><a name="line-262"></a><span>                </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a name="local-6989586621681542807"><a href="#local-6989586621681542807"><span class="hs-identifier">the_fv</span></a></a><span class="hs-special">]</span><span>                </span><span class="hs-comment">-- Just one free var</span><span>
</span><a name="line-263"></a><span>                </span><a name="local-6989586621681542808"><a href="#local-6989586621681542808"><span class="hs-identifier">upd_flag</span></a></a><span>                </span><span class="hs-comment">-- Updatable thunk</span><span>
</span><a name="line-264"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                      </span><span class="hs-comment">-- A thunk</span><span>
</span><a name="line-265"></a><span>                </span><a name="local-6989586621681542809"><a href="#local-6989586621681542809"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542810"><a href="#local-6989586621681542810"><span class="hs-identifier">strip</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgSyn.html#stripStgTicksTop"><span class="hs-identifier hs-var">stripStgTicksTop</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">tickishIsCode</span><span class="hs-special">)</span><span>
</span><a name="line-267"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621681542811"><a href="#local-6989586621681542811"><span class="hs-identifier">scrutinee</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-comment">{-no args-}</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>         </span><span class="hs-identifier">_</span><span>   </span><span class="hs-comment">-- ignore bndr</span><span>
</span><a name="line-269"></a><span>         </span><span class="hs-special">(</span><a href="StgSyn.html#AlgAlt"><span class="hs-identifier hs-var">AlgAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>         </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681542812"><a href="#local-6989586621681542812"><span class="hs-identifier">params</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542813"><a href="#local-6989586621681542813"><span class="hs-identifier">sel_expr</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681542810"><span class="hs-identifier hs-var">strip</span></a><span> </span><a href="#local-6989586621681542809"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-271"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621681542814"><a href="#local-6989586621681542814"><span class="hs-identifier">selectee</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-comment">{-no args-}</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681542810"><span class="hs-identifier hs-var">strip</span></a><span> </span><a href="#local-6989586621681542813"><span class="hs-identifier hs-var">sel_expr</span></a><span>
</span><a name="line-272"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542807"><span class="hs-identifier hs-var">the_fv</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681542811"><span class="hs-identifier hs-var">scrutinee</span></a><span>                </span><span class="hs-comment">-- Scrutinee is the only free variable</span><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681542815"><a href="#local-6989586621681542815"><span class="hs-identifier">params_w_offsets</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmLayout.html#mkVirtConstrOffsets"><span class="hs-identifier hs-var">mkVirtConstrOffsets</span></a><span> </span><a href="#local-6989586621681542804"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#addIdReps"><span class="hs-identifier hs-var">addIdReps</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#assertNonVoidIds"><span class="hs-identifier hs-var">assertNonVoidIds</span></a><span> </span><a href="#local-6989586621681542812"><span class="hs-identifier hs-var">params</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>                                   </span><span class="hs-comment">-- pattern binders are always non-void,</span><span>
</span><a name="line-276"></a><span>                                   </span><span class="hs-comment">-- see Note [Post-unarisation invariants] in UnariseStg</span><span>
</span><a name="line-277"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681542816"><a href="#local-6989586621681542816"><span class="hs-identifier">the_offset</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">assocMaybe</span><span> </span><a href="#local-6989586621681542815"><span class="hs-identifier hs-var">params_w_offsets</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681542814"><span class="hs-identifier hs-var">selectee</span></a><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542817"><a href="#local-6989586621681542817"><span class="hs-identifier">offset_into_int</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#bytesToWordsRoundUp"><span class="hs-identifier hs-var">bytesToWordsRoundUp</span></a><span> </span><a href="#local-6989586621681542804"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542816"><span class="hs-identifier hs-var">the_offset</span></a><span>
</span><a name="line-280"></a><span>                          </span><span class="hs-glyph">-</span><span> </span><a href="SMRep.html#fixedHdrSizeW"><span class="hs-identifier hs-var">fixedHdrSizeW</span></a><span> </span><a href="#local-6989586621681542804"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-281"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542817"><span class="hs-identifier hs-var">offset_into_int</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier hs-var">mAX_SPEC_SELECTEE_SIZE</span><span> </span><a href="#local-6989586621681542804"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-comment">-- Offset is small enough</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- NOT TRUE: ASSERT(is_single_constructor)</span><span>
</span><a name="line-283"></a><span>    </span><span class="hs-comment">-- The simplifier may have statically determined that the single alternative</span><span>
</span><a name="line-284"></a><span>    </span><span class="hs-comment">-- is the only possible case and eliminated the others, even if there are</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-comment">-- other constructors in the datatype.  It's still ok to make a selector</span><span>
</span><a name="line-286"></a><span>    </span><span class="hs-comment">-- thunk in this case, because we *know* which constructor the scrutinee</span><span>
</span><a name="line-287"></a><span>    </span><span class="hs-comment">-- will evaluate to.</span><span>
</span><a name="line-288"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-289"></a><span>    </span><span class="hs-comment">-- srt is discarded; it must be empty</span><span>
</span><a name="line-290"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542818"><a href="#local-6989586621681542818"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkSelectorLFInfo"><span class="hs-identifier hs-var">mkSelectorLFInfo</span></a><span> </span><a href="#local-6989586621681542805"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542817"><span class="hs-identifier hs-var">offset_into_int</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#isUpdatable"><span class="hs-identifier hs-var">isUpdatable</span></a><span> </span><a href="#local-6989586621681542808"><span class="hs-identifier hs-var">upd_flag</span></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="StgCmmBind.html#cgRhsStdThunk"><span class="hs-identifier hs-var">cgRhsStdThunk</span></a><span> </span><a href="#local-6989586621681542805"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542818"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621681542807"><span class="hs-identifier hs-var">the_fv</span></a><span class="hs-special">]</span><span>
</span><a name="line-292"></a><span>
</span><a name="line-293"></a><span class="hs-comment">---------- Note [Ap thunks] ------------------</span><span>
</span><a name="line-294"></a><span class="hs-identifier">mkRhsClosure</span><span>    </span><a name="local-6989586621681542819"><a href="#local-6989586621681542819"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681542820"><a href="#local-6989586621681542820"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681542821"><a href="#local-6989586621681542821"><span class="hs-identifier">_cc</span></a></a><span>
</span><a name="line-295"></a><span>                </span><a name="local-6989586621681542822"><a href="#local-6989586621681542822"><span class="hs-identifier">fvs</span></a></a><span>
</span><a name="line-296"></a><span>                </span><a name="local-6989586621681542823"><a href="#local-6989586621681542823"><span class="hs-identifier">upd_flag</span></a></a><span>
</span><a name="line-297"></a><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                      </span><span class="hs-comment">-- No args; a thunk</span><span>
</span><a name="line-298"></a><span>                </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621681542824"><a href="#local-6989586621681542824"><span class="hs-identifier">fun_id</span></a></a><span> </span><a name="local-6989586621681542825"><a href="#local-6989586621681542825"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span>  </span><span class="hs-comment">-- We are looking for an &quot;ApThunk&quot;; see data con ApThunk in StgCmmClosure</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-comment">-- of form (x1 x2 .... xn), where all the xi are locals (not top-level)</span><span>
</span><a name="line-302"></a><span>  </span><span class="hs-comment">-- So the xi will all be free variables</span><span>
</span><a name="line-303"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681542825"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681542826"><span class="hs-identifier hs-var">n_fvs</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- This happens only if the fun_id and</span><span>
</span><a name="line-304"></a><span>                               </span><span class="hs-comment">-- args are all distinct local variables</span><span>
</span><a name="line-305"></a><span>                               </span><span class="hs-comment">-- The &quot;-1&quot; is for fun_id</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-comment">-- Missed opportunity:   (f x x) is not detected</span><span>
</span><a name="line-307"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isGcPtrRep</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmClosure.html#idPrimRep"><span class="hs-identifier hs-var">idPrimRep</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542822"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-308"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#isUpdatable"><span class="hs-identifier hs-var">isUpdatable</span></a><span> </span><a href="#local-6989586621681542823"><span class="hs-identifier hs-var">upd_flag</span></a><span>
</span><a name="line-309"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542826"><span class="hs-identifier hs-var">n_fvs</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier hs-var">mAX_SPEC_AP_SIZE</span><span> </span><a href="#local-6989586621681542819"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-310"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621681542819"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>                         </span><span class="hs-comment">-- not when profiling: we don't want to</span><span>
</span><a name="line-312"></a><span>                         </span><span class="hs-comment">-- lose information about this particular</span><span>
</span><a name="line-313"></a><span>                         </span><span class="hs-comment">-- thunk (e.g. its type) (#949)</span><span>
</span><a name="line-314"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idArity</span><span> </span><a href="#local-6989586621681542824"><span class="hs-identifier hs-var">fun_id</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">unknownArity</span><span> </span><span class="hs-comment">-- don't spoil a known call</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span>          </span><span class="hs-comment">-- Ha! an Ap thunk</span><span>
</span><a name="line-317"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmBind.html#cgRhsStdThunk"><span class="hs-identifier hs-var">cgRhsStdThunk</span></a><span> </span><a href="#local-6989586621681542820"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542827"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542828"><span class="hs-identifier hs-var">payload</span></a><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-320"></a><span>    </span><a name="local-6989586621681542826"><a href="#local-6989586621681542826"><span class="hs-identifier">n_fvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681542822"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-321"></a><span>    </span><a name="local-6989586621681542827"><a href="#local-6989586621681542827"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkApLFInfo"><span class="hs-identifier hs-var">mkApLFInfo</span></a><span> </span><a href="#local-6989586621681542820"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542823"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621681542826"><span class="hs-identifier hs-var">n_fvs</span></a><span>
</span><a name="line-322"></a><span>    </span><span class="hs-comment">-- the payload has to be in the correct order, hence we can't</span><span>
</span><a name="line-323"></a><span>    </span><span class="hs-comment">-- just use the fvs.</span><span>
</span><a name="line-324"></a><span>    </span><a name="local-6989586621681542828"><a href="#local-6989586621681542828"><span class="hs-identifier">payload</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621681542824"><span class="hs-identifier hs-var">fun_id</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681542825"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span class="hs-comment">---------- Default case ------------------</span><span>
</span><a name="line-327"></a><span class="hs-identifier">mkRhsClosure</span><span> </span><a name="local-6989586621681542829"><a href="#local-6989586621681542829"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681542830"><a href="#local-6989586621681542830"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681542831"><a href="#local-6989586621681542831"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681542832"><a href="#local-6989586621681542832"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621681542833"><a href="#local-6989586621681542833"><span class="hs-identifier">upd_flag</span></a></a><span> </span><a name="local-6989586621681542834"><a href="#local-6989586621681542834"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681542835"><a href="#local-6989586621681542835"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-328"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542856"><a href="#local-6989586621681542856"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmBind.html#mkClosureLFInfo"><span class="hs-identifier hs-var">mkClosureLFInfo</span></a><span> </span><a href="#local-6989586621681542829"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542830"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-identifier hs-var">NotTopLevel</span><span> </span><a href="#local-6989586621681542832"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621681542833"><span class="hs-identifier hs-var">upd_flag</span></a><span> </span><a href="#local-6989586621681542834"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-329"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681542857"><a href="#local-6989586621681542857"><span class="hs-identifier">id_info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542858"><a href="#local-6989586621681542858"><span class="hs-identifier">reg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#rhsIdInfo"><span class="hs-identifier hs-var">rhsIdInfo</span></a><span> </span><a href="#local-6989586621681542830"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542856"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-330"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681542857"><span class="hs-identifier hs-var">id_info</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542836"><span class="hs-identifier hs-var">gen_code</span></a><span> </span><a href="#local-6989586621681542856"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542858"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-331"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-332"></a><span> </span><a name="local-6989586621681542836"><a href="#local-6989586621681542836"><span class="hs-identifier">gen_code</span></a></a><span> </span><a name="local-6989586621681542837"><a href="#local-6989586621681542837"><span class="hs-identifier">lf_info</span></a></a><span> </span><a name="local-6989586621681542838"><a href="#local-6989586621681542838"><span class="hs-identifier">reg</span></a></a><span>
</span><a name="line-333"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>       </span><span class="hs-comment">-- LAY OUT THE OBJECT</span><span>
</span><a name="line-334"></a><span>        </span><span class="hs-comment">-- If the binder is itself a free variable, then don't store</span><span>
</span><a name="line-335"></a><span>        </span><span class="hs-comment">-- it in the closure.  Instead, just bind it to Node on entry.</span><span>
</span><a name="line-336"></a><span>        </span><span class="hs-comment">-- NB we can be sure that Node will point to it, because we</span><span>
</span><a name="line-337"></a><span>        </span><span class="hs-comment">-- haven't told mkClosureLFInfo about this; so if the binder</span><span>
</span><a name="line-338"></a><span>        </span><span class="hs-comment">-- _was_ a free var of its RHS, mkClosureLFInfo thinks it *is*</span><span>
</span><a name="line-339"></a><span>        </span><span class="hs-comment">-- stored in the closure itself, so it will make sure that</span><span>
</span><a name="line-340"></a><span>        </span><span class="hs-comment">-- Node points to it...</span><span>
</span><a name="line-341"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><a name="local-6989586621681542839"><a href="#local-6989586621681542839"><span class="hs-identifier">reduced_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681542830"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">/=</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542832"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span>        </span><span class="hs-comment">-- MAKE CLOSURE INFO FOR THIS CLOSURE</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542840"><a href="#local-6989586621681542840"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getModuleName"><span class="hs-identifier hs-var">getModuleName</span></a><span>
</span><a name="line-345"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542841"><a href="#local-6989586621681542841"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-346"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>   </span><a name="local-6989586621681542842"><a href="#local-6989586621681542842"><span class="hs-identifier">name</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681542830"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-347"></a><span>                </span><a name="local-6989586621681542843"><a href="#local-6989586621681542843"><span class="hs-identifier">descr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmBind.html#closureDescription"><span class="hs-identifier hs-var">closureDescription</span></a><span> </span><a href="#local-6989586621681542841"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542840"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><a href="#local-6989586621681542842"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-348"></a><span>                </span><span class="hs-identifier">fv_details</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-349"></a><span>                </span><a name="local-6989586621681542844"><a href="#local-6989586621681542844"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="StgCmmClosure.html#isLFThunk"><span class="hs-identifier hs-var">isLFThunk</span></a><span> </span><a href="#local-6989586621681542837"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="StgCmmLayout.html#ThunkHeader"><span class="hs-identifier hs-var">ThunkHeader</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmLayout.html#StdHeader"><span class="hs-identifier hs-var">StdHeader</span></a><span>
</span><a name="line-350"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621681542845"><a href="#local-6989586621681542845"><span class="hs-identifier">tot_wds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542846"><a href="#local-6989586621681542846"><span class="hs-identifier">ptr_wds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542847"><a href="#local-6989586621681542847"><span class="hs-identifier">fv_details</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmLayout.html#mkVirtHeapOffsets"><span class="hs-identifier hs-var">mkVirtHeapOffsets</span></a><span> </span><a href="#local-6989586621681542841"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542844"><span class="hs-identifier hs-var">header</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#addIdReps"><span class="hs-identifier hs-var">addIdReps</span></a><span> </span><a href="#local-6989586621681542839"><span class="hs-identifier hs-var">reduced_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>                </span><a name="local-6989586621681542848"><a href="#local-6989586621681542848"><span class="hs-identifier">closure_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkClosureInfo"><span class="hs-identifier hs-var">mkClosureInfo</span></a><span> </span><a href="#local-6989586621681542841"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>       </span><span class="hs-comment">-- Not static</span><span>
</span><a name="line-353"></a><span>                                             </span><a href="#local-6989586621681542830"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542837"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542845"><span class="hs-identifier hs-var">tot_wds</span></a><span> </span><a href="#local-6989586621681542846"><span class="hs-identifier hs-var">ptr_wds</span></a><span>
</span><a name="line-354"></a><span>                                             </span><a href="#local-6989586621681542843"><span class="hs-identifier hs-var">descr</span></a><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span>        </span><span class="hs-comment">-- BUILD ITS INFO TABLE AND CODE</span><span>
</span><a name="line-357"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#forkClosureBody"><span class="hs-identifier hs-var">forkClosureBody</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-358"></a><span>                </span><span class="hs-comment">-- forkClosureBody: (a) ensure that bindings in here are not seen elsewhere</span><span>
</span><a name="line-359"></a><span>                </span><span class="hs-comment">--                  (b) ignore Sequel from context; use empty Sequel</span><span>
</span><a name="line-360"></a><span>                </span><span class="hs-comment">-- And compile the body</span><span>
</span><a name="line-361"></a><span>                </span><a href="StgCmmBind.html#closureCodeBody"><span class="hs-identifier hs-var">closureCodeBody</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621681542830"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542848"><span class="hs-identifier hs-var">closure_info</span></a><span> </span><a href="#local-6989586621681542831"><span class="hs-identifier hs-var">cc</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#nonVoidIds"><span class="hs-identifier hs-var">nonVoidIds</span></a><span> </span><a href="#local-6989586621681542834"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621681542834"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542835"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621681542847"><span class="hs-identifier hs-var">fv_details</span></a><span>
</span><a name="line-363"></a><span>
</span><a name="line-364"></a><span>        </span><span class="hs-comment">-- BUILD THE OBJECT</span><span>
</span><a name="line-365"></a><span class="hs-comment">--      ; (use_cc, blame_cc) &lt;- chooseDynCostCentres cc args body</span><span>
</span><a name="line-366"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542849"><a href="#local-6989586621681542849"><span class="hs-identifier">use_cc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cccsExpr"><span class="hs-identifier hs-var">cccsExpr</span></a><span class="hs-special">;</span><span> </span><a name="local-6989586621681542850"><a href="#local-6989586621681542850"><span class="hs-identifier">blame_cc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cccsExpr"><span class="hs-identifier hs-var">cccsExpr</span></a><span>
</span><a name="line-367"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-special">(</span><a href="MkGraph.html#mkComment"><span class="hs-identifier hs-var">mkComment</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkFastString</span><span> </span><span class="hs-string">&quot;calling allocDynClosure&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542851"><a href="#local-6989586621681542851"><span class="hs-identifier">toVarArg</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a name="local-6989586621681542852"><a href="#local-6989586621681542852"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542853"><a href="#local-6989586621681542853"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621681542852"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542853"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span>
</span><a name="line-369"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542854"><a href="#local-6989586621681542854"><span class="hs-identifier">info_tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkCmmInfo"><span class="hs-identifier hs-var">mkCmmInfo</span></a><span> </span><a href="#local-6989586621681542848"><span class="hs-identifier hs-var">closure_info</span></a><span> </span><a href="#local-6989586621681542830"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-identifier hs-var">currentCCS</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542855"><a href="#local-6989586621681542855"><span class="hs-identifier">hp_plus_n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmHeap.html#allocDynClosure"><span class="hs-identifier hs-var">allocDynClosure</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681542830"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542854"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><a href="#local-6989586621681542837"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542849"><span class="hs-identifier hs-var">use_cc</span></a><span> </span><a href="#local-6989586621681542850"><span class="hs-identifier hs-var">blame_cc</span></a><span>
</span><a name="line-371"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681542851"><span class="hs-identifier hs-var">toVarArg</span></a><span> </span><a href="#local-6989586621681542847"><span class="hs-identifier hs-var">fv_details</span></a><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span>        </span><span class="hs-comment">-- RETURN</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgCmmEnv.html#mkRhsInit"><span class="hs-identifier hs-var">mkRhsInit</span></a><span> </span><a href="#local-6989586621681542841"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542838"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="#local-6989586621681542837"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542855"><span class="hs-identifier hs-var">hp_plus_n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-377"></a><span class="hs-identifier">cgRhsStdThunk</span><span>
</span><a name="line-378"></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-379"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-380"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- payload</span><span>
</span><a name="line-381"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmMonad.html#CgIdInfo"><span class="hs-identifier hs-type">CgIdInfo</span></a><span class="hs-special">,</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="MkGraph.html#CmmAGraph"><span class="hs-identifier hs-type">CmmAGraph</span></a><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><a name="cgRhsStdThunk"><a href="StgCmmBind.html#cgRhsStdThunk"><span class="hs-identifier">cgRhsStdThunk</span></a></a><span> </span><a name="local-6989586621681542859"><a href="#local-6989586621681542859"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681542860"><a href="#local-6989586621681542860"><span class="hs-identifier">lf_info</span></a></a><span> </span><a name="local-6989586621681542861"><a href="#local-6989586621681542861"><span class="hs-identifier">payload</span></a></a><span>
</span><a name="line-384"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681542876"><a href="#local-6989586621681542876"><span class="hs-identifier">id_info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542877"><a href="#local-6989586621681542877"><span class="hs-identifier">reg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#rhsIdInfo"><span class="hs-identifier hs-var">rhsIdInfo</span></a><span> </span><a href="#local-6989586621681542859"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542860"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-385"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681542876"><span class="hs-identifier hs-var">id_info</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542862"><span class="hs-identifier hs-var">gen_code</span></a><span> </span><a href="#local-6989586621681542877"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-387"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-388"></a><span> </span><a name="local-6989586621681542862"><a href="#local-6989586621681542862"><span class="hs-identifier">gen_code</span></a></a><span> </span><a name="local-6989586621681542863"><a href="#local-6989586621681542863"><span class="hs-identifier">reg</span></a></a><span>  </span><span class="hs-comment">-- AHA!  A STANDARD-FORM THUNK</span><span>
</span><a name="line-389"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounterStdThunk"><span class="hs-identifier hs-var">withNewTickyCounterStdThunk</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#lfUpdatable"><span class="hs-identifier hs-var">lfUpdatable</span></a><span> </span><a href="#local-6989586621681542860"><span class="hs-identifier hs-var">lf_info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681542859"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-390"></a><span>    </span><span class="hs-keyword">do</span><span>
</span><a name="line-391"></a><span>  </span><span class="hs-special">{</span><span>     </span><span class="hs-comment">-- LAY OUT THE OBJECT</span><span>
</span><a name="line-392"></a><span>    </span><a name="local-6989586621681542864"><a href="#local-6989586621681542864"><span class="hs-identifier">mod_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getModuleName"><span class="hs-identifier hs-var">getModuleName</span></a><span>
</span><a name="line-393"></a><span>  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542865"><a href="#local-6989586621681542865"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-394"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542866"><a href="#local-6989586621681542866"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="StgCmmClosure.html#isLFThunk"><span class="hs-identifier hs-var">isLFThunk</span></a><span> </span><a href="#local-6989586621681542860"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="StgCmmLayout.html#ThunkHeader"><span class="hs-identifier hs-var">ThunkHeader</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="StgCmmLayout.html#StdHeader"><span class="hs-identifier hs-var">StdHeader</span></a><span>
</span><a name="line-395"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681542867"><a href="#local-6989586621681542867"><span class="hs-identifier">tot_wds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542868"><a href="#local-6989586621681542868"><span class="hs-identifier">ptr_wds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542869"><a href="#local-6989586621681542869"><span class="hs-identifier">payload_w_offsets</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmLayout.html#mkVirtHeapOffsets"><span class="hs-identifier hs-var">mkVirtHeapOffsets</span></a><span> </span><a href="#local-6989586621681542865"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542866"><span class="hs-identifier hs-var">header</span></a><span>
</span><a name="line-397"></a><span>                </span><span class="hs-special">(</span><a href="StgCmmClosure.html#addArgReps"><span class="hs-identifier hs-var">addArgReps</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#nonVoidStgArgs"><span class="hs-identifier hs-var">nonVoidStgArgs</span></a><span> </span><a href="#local-6989586621681542861"><span class="hs-identifier hs-var">payload</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span>        </span><a name="local-6989586621681542870"><a href="#local-6989586621681542870"><span class="hs-identifier">descr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmBind.html#closureDescription"><span class="hs-identifier hs-var">closureDescription</span></a><span> </span><a href="#local-6989586621681542865"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542864"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621681542859"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>        </span><a name="local-6989586621681542871"><a href="#local-6989586621681542871"><span class="hs-identifier">closure_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkClosureInfo"><span class="hs-identifier hs-var">mkClosureInfo</span></a><span> </span><a href="#local-6989586621681542865"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>       </span><span class="hs-comment">-- Not static</span><span>
</span><a name="line-401"></a><span>                                     </span><a href="#local-6989586621681542859"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542860"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542867"><span class="hs-identifier hs-var">tot_wds</span></a><span> </span><a href="#local-6989586621681542868"><span class="hs-identifier hs-var">ptr_wds</span></a><span>
</span><a name="line-402"></a><span>                                     </span><a href="#local-6989586621681542870"><span class="hs-identifier hs-var">descr</span></a><span>
</span><a name="line-403"></a><span>
</span><a name="line-404"></a><span class="hs-comment">--  ; (use_cc, blame_cc) &lt;- chooseDynCostCentres cc [{- no args-}] body</span><span>
</span><a name="line-405"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542872"><a href="#local-6989586621681542872"><span class="hs-identifier">use_cc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cccsExpr"><span class="hs-identifier hs-var">cccsExpr</span></a><span class="hs-special">;</span><span> </span><a name="local-6989586621681542873"><a href="#local-6989586621681542873"><span class="hs-identifier">blame_cc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#cccsExpr"><span class="hs-identifier hs-var">cccsExpr</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span>        </span><span class="hs-comment">-- BUILD THE OBJECT</span><span>
</span><a name="line-409"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542874"><a href="#local-6989586621681542874"><span class="hs-identifier">info_tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkCmmInfo"><span class="hs-identifier hs-var">mkCmmInfo</span></a><span> </span><a href="#local-6989586621681542871"><span class="hs-identifier hs-var">closure_info</span></a><span> </span><a href="#local-6989586621681542859"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-identifier hs-var">currentCCS</span><span>
</span><a name="line-410"></a><span>  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542875"><a href="#local-6989586621681542875"><span class="hs-identifier">hp_plus_n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmHeap.html#allocDynClosure"><span class="hs-identifier hs-var">allocDynClosure</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681542859"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542874"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><a href="#local-6989586621681542860"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-411"></a><span>                                   </span><a href="#local-6989586621681542872"><span class="hs-identifier hs-var">use_cc</span></a><span> </span><a href="#local-6989586621681542873"><span class="hs-identifier hs-var">blame_cc</span></a><span> </span><a href="#local-6989586621681542869"><span class="hs-identifier hs-var">payload_w_offsets</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span>        </span><span class="hs-comment">-- RETURN</span><span>
</span><a name="line-414"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="StgCmmEnv.html#mkRhsInit"><span class="hs-identifier hs-var">mkRhsInit</span></a><span> </span><a href="#local-6989586621681542865"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542863"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="#local-6989586621681542860"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542875"><span class="hs-identifier hs-var">hp_plus_n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span class="hs-identifier">mkClosureLFInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-418"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>           </span><span class="hs-comment">-- The binder</span><span>
</span><a name="line-419"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TopLevelFlag</span><span> </span><span class="hs-comment">-- True of top level</span><span>
</span><a name="line-420"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Free vars</span><span>
</span><a name="line-421"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#UpdateFlag"><span class="hs-identifier hs-type">UpdateFlag</span></a><span>   </span><span class="hs-comment">-- Update flag</span><span>
</span><a name="line-422"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Args</span><span>
</span><a name="line-423"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span>
</span><a name="line-424"></a><a name="mkClosureLFInfo"><a href="StgCmmBind.html#mkClosureLFInfo"><span class="hs-identifier">mkClosureLFInfo</span></a></a><span> </span><a name="local-6989586621681542878"><a href="#local-6989586621681542878"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681542879"><a href="#local-6989586621681542879"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681542880"><a href="#local-6989586621681542880"><span class="hs-identifier">top</span></a></a><span> </span><a name="local-6989586621681542881"><a href="#local-6989586621681542881"><span class="hs-identifier">fvs</span></a></a><span> </span><a name="local-6989586621681542882"><a href="#local-6989586621681542882"><span class="hs-identifier">upd_flag</span></a></a><span> </span><a name="local-6989586621681542883"><a href="#local-6989586621681542883"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-425"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681542883"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-426"></a><span>        </span><a href="StgCmmClosure.html#mkLFThunk"><span class="hs-identifier hs-var">mkLFThunk</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621681542879"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542880"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span> </span><a href="#local-6989586621681542881"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542882"><span class="hs-identifier hs-var">upd_flag</span></a><span>
</span><a name="line-427"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-428"></a><span>        </span><a href="StgCmmClosure.html#mkLFReEntrant"><span class="hs-identifier hs-var">mkLFReEntrant</span></a><span> </span><a href="#local-6989586621681542880"><span class="hs-identifier hs-var">top</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgCmmClosure.html#fromNonVoid"><span class="hs-identifier hs-var">fromNonVoid</span></a><span> </span><a href="#local-6989586621681542881"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542883"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmLayout.html#mkArgDescr"><span class="hs-identifier hs-var">mkArgDescr</span></a><span> </span><a href="#local-6989586621681542878"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542883"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-432"></a><span class="hs-comment">--              The code for closures</span><span>
</span><a name="line-433"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span class="hs-identifier">closureCodeBody</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>            </span><span class="hs-comment">-- whether this is a top-level binding</span><span>
</span><a name="line-436"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span>              </span><span class="hs-comment">-- the closure's name</span><span>
</span><a name="line-437"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span>     </span><span class="hs-comment">-- Lots of information about this closure</span><span>
</span><a name="line-438"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span> </span><span class="hs-comment">-- Optional cost centre attached to closure</span><span>
</span><a name="line-439"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- incoming args to the closure</span><span>
</span><a name="line-440"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>             </span><span class="hs-comment">-- arity, including void args</span><span>
</span><a name="line-441"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span>
</span><a name="line-442"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- the closure's free vars</span><span>
</span><a name="line-443"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span>
</span><a name="line-445"></a><span class="hs-comment">{- There are two main cases for the code for closures.

* If there are *no arguments*, then the closure is a thunk, and not in
  normal form. So it should set up an update frame (if it is
  shared). NB: Thunks cannot have a primitive type!

* If there is *at least one* argument, then this closure is in
  normal form, so there is no need to set up an update frame.
-}</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><a name="closureCodeBody"><a href="StgCmmBind.html#closureCodeBody"><span class="hs-identifier">closureCodeBody</span></a></a><span> </span><a name="local-6989586621681542884"><a href="#local-6989586621681542884"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621681542885"><a href="#local-6989586621681542885"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681542886"><a href="#local-6989586621681542886"><span class="hs-identifier">cl_info</span></a></a><span> </span><a name="local-6989586621681542887"><a href="#local-6989586621681542887"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681542888"><a href="#local-6989586621681542888"><span class="hs-identifier">_args</span></a></a><span> </span><a name="local-6989586621681542889"><a href="#local-6989586621681542889"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621681542890"><a href="#local-6989586621681542890"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621681542891"><a href="#local-6989586621681542891"><span class="hs-identifier">fv_details</span></a></a><span>
</span><a name="line-456"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681542889"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-comment">-- No args i.e. thunk</span><span>
</span><a name="line-457"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmTicky.html#withNewTickyCounterThunk"><span class="hs-identifier hs-var">withNewTickyCounterThunk</span></a><span>
</span><a name="line-458"></a><span>        </span><span class="hs-special">(</span><a href="StgCmmClosure.html#isStaticClosure"><span class="hs-identifier hs-var">isStaticClosure</span></a><span> </span><a href="#local-6989586621681542886"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>        </span><span class="hs-special">(</span><a href="StgCmmClosure.html#closureUpdReqd"><span class="hs-identifier hs-var">closureUpdReqd</span></a><span> </span><a href="#local-6989586621681542886"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-460"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">closureName</span><span> </span><a href="#local-6989586621681542886"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-461"></a><span>    </span><a href="StgCmmLayout.html#emitClosureProcAndInfoTable"><span class="hs-identifier hs-var">emitClosureProcAndInfoTable</span></a><span> </span><a href="#local-6989586621681542884"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621681542885"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542892"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542893"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-462"></a><span>      </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681542894"><a href="#local-6989586621681542894"><span class="hs-identifier">node</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmBind.html#thunkCode"><span class="hs-identifier hs-var">thunkCode</span></a><span> </span><a href="#local-6989586621681542886"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><a href="#local-6989586621681542891"><span class="hs-identifier hs-var">fv_details</span></a><span> </span><a href="#local-6989586621681542887"><span class="hs-identifier hs-var">cc</span></a><span> </span><a href="#local-6989586621681542894"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621681542889"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621681542890"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-463"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-464"></a><span>     </span><a name="local-6989586621681542892"><a href="#local-6989586621681542892"><span class="hs-identifier">lf_info</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><a href="#local-6989586621681542886"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-465"></a><span>     </span><a name="local-6989586621681542893"><a href="#local-6989586621681542893"><span class="hs-identifier">info_tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkCmmInfo"><span class="hs-identifier hs-var">mkCmmInfo</span></a><span> </span><a href="#local-6989586621681542886"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><a href="#local-6989586621681542885"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542887"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-identifier">closureCodeBody</span><span> </span><a name="local-6989586621681542895"><a href="#local-6989586621681542895"><span class="hs-identifier">top_lvl</span></a></a><span> </span><a name="local-6989586621681542896"><a href="#local-6989586621681542896"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681542897"><a href="#local-6989586621681542897"><span class="hs-identifier">cl_info</span></a></a><span> </span><a name="local-6989586621681542898"><a href="#local-6989586621681542898"><span class="hs-identifier">cc</span></a></a><span> </span><a name="local-6989586621681542899"><a href="#local-6989586621681542899"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621681542900"><a href="#local-6989586621681542900"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621681542901"><a href="#local-6989586621681542901"><span class="hs-identifier">body</span></a></a><span> </span><a name="local-6989586621681542902"><a href="#local-6989586621681542902"><span class="hs-identifier">fv_details</span></a></a><span>
</span><a name="line-468"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Note: args may be [], if all args are Void</span><span>
</span><a name="line-469"></a><span>    </span><a href="StgCmmTicky.html#withNewTickyCounterFun"><span class="hs-identifier hs-var">withNewTickyCounterFun</span></a><span>
</span><a name="line-470"></a><span>        </span><span class="hs-special">(</span><a href="StgCmmClosure.html#closureSingleEntry"><span class="hs-identifier hs-var">closureSingleEntry</span></a><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-471"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">closureName</span><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>        </span><a href="#local-6989586621681542899"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-475"></a><span>             </span><a name="local-6989586621681542903"><a href="#local-6989586621681542903"><span class="hs-identifier">lf_info</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-476"></a><span>             </span><a name="local-6989586621681542904"><a href="#local-6989586621681542904"><span class="hs-identifier">info_tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#mkCmmInfo"><span class="hs-identifier hs-var">mkCmmInfo</span></a><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><a href="#local-6989586621681542896"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542898"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-477"></a><span>
</span><a name="line-478"></a><span>        </span><span class="hs-comment">-- Emit the main entry code</span><span>
</span><a name="line-479"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmLayout.html#emitClosureProcAndInfoTable"><span class="hs-identifier hs-var">emitClosureProcAndInfoTable</span></a><span> </span><a href="#local-6989586621681542895"><span class="hs-identifier hs-var">top_lvl</span></a><span> </span><a href="#local-6989586621681542896"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542903"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542904"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><a href="#local-6989586621681542899"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-480"></a><span>            </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681542905"><a href="#local-6989586621681542905"><span class="hs-identifier">_offset</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542906"><a href="#local-6989586621681542906"><span class="hs-identifier">node</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542907"><a href="#local-6989586621681542907"><span class="hs-identifier">arg_regs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-481"></a><span>                </span><span class="hs-comment">-- Emit slow-entry code (for entering a closure through a PAP)</span><span>
</span><a name="line-482"></a><span>                </span><span class="hs-special">{</span><span> </span><a href="StgCmmBind.html#mkSlowEntryCode"><span class="hs-identifier hs-var">mkSlowEntryCode</span></a><span> </span><a href="#local-6989586621681542896"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><a href="#local-6989586621681542907"><span class="hs-identifier hs-var">arg_regs</span></a><span>
</span><a name="line-483"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542908"><a href="#local-6989586621681542908"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-484"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542909"><a href="#local-6989586621681542909"><span class="hs-identifier">node_points</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#nodeMustPointToIt"><span class="hs-identifier hs-var">nodeMustPointToIt</span></a><span> </span><a href="#local-6989586621681542908"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542903"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-485"></a><span>                      </span><a name="local-6989586621681542910"><a href="#local-6989586621681542910"><span class="hs-identifier">node'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681542909"><span class="hs-identifier hs-var">node_points</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681542906"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-486"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542911"><a href="#local-6989586621681542911"><span class="hs-identifier">loop_header_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BlockId.html#newBlockId"><span class="hs-identifier hs-var">newBlockId</span></a><span>
</span><a name="line-487"></a><span>                </span><span class="hs-comment">-- Extend reader monad with information that</span><span>
</span><a name="line-488"></a><span>                </span><span class="hs-comment">-- self-recursive tail calls can be optimized into local</span><span>
</span><a name="line-489"></a><span>                </span><span class="hs-comment">-- jumps. See Note [Self-recursive tail calls] in StgCmmExpr.</span><span>
</span><a name="line-490"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#withSelfLoop"><span class="hs-identifier hs-var">withSelfLoop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681542896"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542911"><span class="hs-identifier hs-var">loop_header_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542907"><span class="hs-identifier hs-var">arg_regs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-491"></a><span>                </span><span class="hs-special">{</span><span>
</span><a name="line-492"></a><span>                </span><span class="hs-comment">-- Main payload</span><span>
</span><a name="line-493"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="StgCmmHeap.html#entryHeapCheck"><span class="hs-identifier hs-var">entryHeapCheck</span></a><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><a href="#local-6989586621681542910"><span class="hs-identifier hs-var">node'</span></a><span> </span><a href="#local-6989586621681542900"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621681542907"><span class="hs-identifier hs-var">arg_regs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-494"></a><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- emit LDV code when profiling</span><span>
</span><a name="line-495"></a><span>                  </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681542909"><span class="hs-identifier hs-var">node_points</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmProf.html#ldvEnterClosure"><span class="hs-identifier hs-var">ldvEnterClosure</span></a><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542906"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>                </span><span class="hs-comment">-- ticky after heap check to avoid double counting</span><span>
</span><a name="line-497"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#tickyEnterFun"><span class="hs-identifier hs-var">tickyEnterFun</span></a><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-498"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="StgCmmProf.html#enterCostCentreFun"><span class="hs-identifier hs-var">enterCostCentreFun</span></a><span> </span><a href="#local-6989586621681542898"><span class="hs-identifier hs-var">cc</span></a><span>
</span><a name="line-499"></a><span>                    </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmMachOp"><span class="hs-identifier hs-var">CmmMachOp</span></a><span> </span><span class="hs-special">(</span><a href="CmmMachOp.html#mo_wordSub"><span class="hs-identifier hs-var">mo_wordSub</span></a><span> </span><a href="#local-6989586621681542908"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-500"></a><span>                         </span><span class="hs-special">[</span><span> </span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542906"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See [NodeReg clobbered with loopification]</span><span>
</span><a name="line-501"></a><span>                         </span><span class="hs-special">,</span><span> </span><a href="CmmUtils.html#mkIntExpr"><span class="hs-identifier hs-var">mkIntExpr</span></a><span> </span><a href="#local-6989586621681542908"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#funTag"><span class="hs-identifier hs-var">funTag</span></a><span> </span><a href="#local-6989586621681542908"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542897"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542912"><a href="#local-6989586621681542912"><span class="hs-identifier">fv_bindings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="StgCmmBind.html#bind_fv"><span class="hs-identifier hs-var">bind_fv</span></a><span> </span><a href="#local-6989586621681542902"><span class="hs-identifier hs-var">fv_details</span></a><span>
</span><a name="line-503"></a><span>                </span><span class="hs-comment">-- Load free vars out of closure *after*</span><span>
</span><a name="line-504"></a><span>                </span><span class="hs-comment">-- heap check, to reduce live vars over check</span><span>
</span><a name="line-505"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681542909"><span class="hs-identifier hs-var">node_points</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmBind.html#load_fvs"><span class="hs-identifier hs-var">load_fvs</span></a><span> </span><a href="#local-6989586621681542906"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621681542903"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542912"><span class="hs-identifier hs-var">fv_bindings</span></a><span>
</span><a name="line-506"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681542901"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-507"></a><span>                </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-508"></a><span>
</span><a name="line-509"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-comment">-- Note [NodeReg clobbered with loopification]</span><span>
</span><a name="line-512"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-513"></a><span class="hs-comment">--</span><span>
</span><a name="line-514"></a><span class="hs-comment">-- Previously we used to pass nodeReg (aka R1) here. With profiling, upon</span><span>
</span><a name="line-515"></a><span class="hs-comment">-- entering a closure, enterFunCCS was called with R1 passed to it. But since R1</span><span>
</span><a name="line-516"></a><span class="hs-comment">-- may get clobbered inside the body of a closure, and since a self-recursive</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- tail call does not restore R1, a subsequent call to enterFunCCS received a</span><span>
</span><a name="line-518"></a><span class="hs-comment">-- possibly bogus value from R1. The solution is to not pass nodeReg (aka R1) to</span><span>
</span><a name="line-519"></a><span class="hs-comment">-- enterFunCCS. Instead, we pass node, the callee-saved temporary that stores</span><span>
</span><a name="line-520"></a><span class="hs-comment">-- the original value of R1. This way R1 may get modified but loopification will</span><span>
</span><a name="line-521"></a><span class="hs-comment">-- not care.</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-comment">-- A function closure pointer may be tagged, so we</span><span>
</span><a name="line-524"></a><span class="hs-comment">-- must take it into account when accessing the free variables.</span><span>
</span><a name="line-525"></a><span class="hs-identifier">bind_fv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><a name="bind_fv"><a href="StgCmmBind.html#bind_fv"><span class="hs-identifier">bind_fv</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681542913"><a href="#local-6989586621681542913"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542914"><a href="#local-6989586621681542914"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681542915"><a href="#local-6989586621681542915"><span class="hs-identifier">reg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmEnv.html#rebindToReg"><span class="hs-identifier hs-var">rebindToReg</span></a><span> </span><a href="#local-6989586621681542913"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681542915"><span class="hs-identifier hs-var">reg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542914"><span class="hs-identifier hs-var">off</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span class="hs-identifier">load_fvs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#LambdaFormInfo"><span class="hs-identifier hs-type">LambdaFormInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-529"></a><a name="load_fvs"><a href="StgCmmBind.html#load_fvs"><span class="hs-identifier">load_fvs</span></a></a><span> </span><a name="local-6989586621681542916"><a href="#local-6989586621681542916"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621681542917"><a href="#local-6989586621681542917"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681542918"><a href="#local-6989586621681542918"><span class="hs-identifier">reg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681542919"><a href="#local-6989586621681542919"><span class="hs-identifier">off</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-530"></a><span>   </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681542920"><a href="#local-6989586621681542920"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-531"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542921"><a href="#local-6989586621681542921"><span class="hs-identifier">tag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#lfDynTag"><span class="hs-identifier hs-var">lfDynTag</span></a><span> </span><a href="#local-6989586621681542920"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542917"><span class="hs-identifier hs-var">lf_info</span></a><span>
</span><a name="line-532"></a><span>      </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmUtils.html#mkTaggedObjectLoad"><span class="hs-identifier hs-var">mkTaggedObjectLoad</span></a><span> </span><a href="#local-6989586621681542920"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542918"><span class="hs-identifier hs-var">reg</span></a><span> </span><a href="#local-6989586621681542916"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621681542919"><span class="hs-identifier hs-var">off</span></a><span> </span><a href="#local-6989586621681542921"><span class="hs-identifier hs-var">tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>
</span><a name="line-534"></a><span class="hs-comment">-----------------------------------------</span><span>
</span><a name="line-535"></a><span class="hs-comment">-- The &quot;slow entry&quot; code for a function.  This entry point takes its</span><span>
</span><a name="line-536"></a><span class="hs-comment">-- arguments on the stack.  It loads the arguments into registers</span><span>
</span><a name="line-537"></a><span class="hs-comment">-- according to the calling convention, and jumps to the function's</span><span>
</span><a name="line-538"></a><span class="hs-comment">-- normal entry point.  The function's closure is assumed to be in</span><span>
</span><a name="line-539"></a><span class="hs-comment">-- R1/node.</span><span>
</span><a name="line-540"></a><span class="hs-comment">--</span><span>
</span><a name="line-541"></a><span class="hs-comment">-- The slow entry point is used for unknown calls: eg. stg_PAP_entry</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-identifier">mkSlowEntryCode</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span class="hs-comment">-- If this function doesn't have a specialised ArgDescr, we need</span><span>
</span><a name="line-545"></a><span class="hs-comment">-- to generate the function's arg bitmap and slow-entry code.</span><span>
</span><a name="line-546"></a><span class="hs-comment">-- Here, we emit the slow-entry code.</span><span>
</span><a name="line-547"></a><a name="mkSlowEntryCode"><a href="StgCmmBind.html#mkSlowEntryCode"><span class="hs-identifier">mkSlowEntryCode</span></a></a><span> </span><a name="local-6989586621681542922"><a href="#local-6989586621681542922"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621681542923"><a href="#local-6989586621681542923"><span class="hs-identifier">cl_info</span></a></a><span> </span><a name="local-6989586621681542924"><a href="#local-6989586621681542924"><span class="hs-identifier">arg_regs</span></a></a><span> </span><span class="hs-comment">-- function closure is already in `Node'</span><span>
</span><a name="line-548"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ArgGen"><span class="hs-identifier hs-var">ArgGen</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmClosure.html#closureFunInfo"><span class="hs-identifier hs-var">closureFunInfo</span></a><span> </span><a href="#local-6989586621681542923"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-549"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681542925"><a href="#local-6989586621681542925"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-550"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542926"><a href="#local-6989586621681542926"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmEnv.html#idToReg"><span class="hs-identifier hs-var">idToReg</span></a><span> </span><a href="#local-6989586621681542925"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-var">NonVoid</span></a><span> </span><a href="#local-6989586621681542922"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>           </span><a name="local-6989586621681542927"><a href="#local-6989586621681542927"><span class="hs-identifier">slow_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#closureSlowEntryLabel"><span class="hs-identifier hs-var">closureSlowEntryLabel</span></a><span>  </span><a href="#local-6989586621681542923"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-552"></a><span>           </span><a name="local-6989586621681542928"><a href="#local-6989586621681542928"><span class="hs-identifier">fast_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#closureLocalEntryLabel"><span class="hs-identifier hs-var">closureLocalEntryLabel</span></a><span> </span><a href="#local-6989586621681542925"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542923"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-553"></a><span>           </span><span class="hs-comment">-- mkDirectJump does not clobber `Node' containing function closure</span><span>
</span><a name="line-554"></a><span>           </span><a name="local-6989586621681542929"><a href="#local-6989586621681542929"><span class="hs-identifier">jump</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="MkGraph.html#mkJump"><span class="hs-identifier hs-var">mkJump</span></a><span> </span><a href="#local-6989586621681542925"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeNodeCall"><span class="hs-identifier hs-var">NativeNodeCall</span></a><span>
</span><a name="line-555"></a><span>                                </span><span class="hs-special">(</span><a href="CmmUtils.html#mkLblExpr"><span class="hs-identifier hs-var">mkLblExpr</span></a><span> </span><a href="#local-6989586621681542928"><span class="hs-identifier hs-var">fast_lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-556"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681542926"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681542924"><span class="hs-identifier hs-var">arg_regs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>                                </span><span class="hs-special">(</span><a href="StgCmmMonad.html#initUpdFrameOff"><span class="hs-identifier hs-var">initUpdFrameOff</span></a><span> </span><a href="#local-6989586621681542925"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-558"></a><span>       </span><a name="local-6989586621681542930"><a href="#local-6989586621681542930"><span class="hs-identifier">tscope</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getTickScope"><span class="hs-identifier hs-var">getTickScope</span></a><span>
</span><a name="line-559"></a><span>       </span><a href="StgCmmMonad.html#emitProcWithConvention"><span class="hs-identifier hs-var">emitProcWithConvention</span></a><span> </span><a href="CmmNode.html#Slow"><span class="hs-identifier hs-var">Slow</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621681542927"><span class="hs-identifier hs-var">slow_lbl</span></a><span>
</span><a name="line-560"></a><span>         </span><span class="hs-special">(</span><a href="#local-6989586621681542926"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681542924"><span class="hs-identifier hs-var">arg_regs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681542929"><span class="hs-identifier hs-var">jump</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681542930"><span class="hs-identifier hs-var">tscope</span></a><span class="hs-special">)</span><span>
</span><a name="line-561"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-comment">-----------------------------------------</span><span>
</span><a name="line-564"></a><span class="hs-identifier">thunkCode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="StgCmmClosure.html#NonVoid"><span class="hs-identifier hs-type">NonVoid</span></a><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><a href="SMRep.html#ByteOff"><span class="hs-identifier hs-type">ByteOff</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CostCentreStack</span><span>
</span><a name="line-565"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#CgStgExpr"><span class="hs-identifier hs-type">CgStgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-566"></a><a name="thunkCode"><a href="StgCmmBind.html#thunkCode"><span class="hs-identifier">thunkCode</span></a></a><span> </span><a name="local-6989586621681542931"><a href="#local-6989586621681542931"><span class="hs-identifier">cl_info</span></a></a><span> </span><a name="local-6989586621681542932"><a href="#local-6989586621681542932"><span class="hs-identifier">fv_details</span></a></a><span> </span><a name="local-6989586621681542933"><a href="#local-6989586621681542933"><span class="hs-identifier">_cc</span></a></a><span> </span><a name="local-6989586621681542934"><a href="#local-6989586621681542934"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621681542935"><a href="#local-6989586621681542935"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621681542936"><a href="#local-6989586621681542936"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-567"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681542937"><a href="#local-6989586621681542937"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-568"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542938"><a href="#local-6989586621681542938"><span class="hs-identifier">node_points</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#nodeMustPointToIt"><span class="hs-identifier hs-var">nodeMustPointToIt</span></a><span> </span><a href="#local-6989586621681542937"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">closureLFInfo</span><span> </span><a href="#local-6989586621681542931"><span class="hs-identifier hs-var">cl_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>             </span><a name="local-6989586621681542939"><a href="#local-6989586621681542939"><span class="hs-identifier">node'</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681542938"><span class="hs-identifier hs-var">node_points</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681542934"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-570"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmProf.html#ldvEnterClosure"><span class="hs-identifier hs-var">ldvEnterClosure</span></a><span> </span><a href="#local-6989586621681542931"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542934"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NB: Node always points when profiling</span><span>
</span><a name="line-571"></a><span>
</span><a name="line-572"></a><span>        </span><span class="hs-comment">-- Heap overflow check</span><span>
</span><a name="line-573"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmHeap.html#entryHeapCheck"><span class="hs-identifier hs-var">entryHeapCheck</span></a><span> </span><a href="#local-6989586621681542931"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><a href="#local-6989586621681542939"><span class="hs-identifier hs-var">node'</span></a><span> </span><a href="#local-6989586621681542935"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-574"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Overwrite with black hole if necessary</span><span>
</span><a name="line-575"></a><span>          </span><span class="hs-comment">-- but *after* the heap-overflow check</span><span>
</span><a name="line-576"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmTicky.html#tickyEnterThunk"><span class="hs-identifier hs-var">tickyEnterThunk</span></a><span> </span><a href="#local-6989586621681542931"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-577"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#blackHoleOnEntry"><span class="hs-identifier hs-var">blackHoleOnEntry</span></a><span> </span><a href="#local-6989586621681542931"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681542938"><span class="hs-identifier hs-var">node_points</span></a><span class="hs-special">)</span><span>
</span><a name="line-578"></a><span>                </span><span class="hs-special">(</span><a href="StgCmmBind.html#blackHoleIt"><span class="hs-identifier hs-var">blackHoleIt</span></a><span> </span><a href="#local-6989586621681542934"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span>          </span><span class="hs-comment">-- Push update frame</span><span>
</span><a name="line-581"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="StgCmmBind.html#setupUpdate"><span class="hs-identifier hs-var">setupUpdate</span></a><span> </span><a href="#local-6989586621681542931"><span class="hs-identifier hs-var">cl_info</span></a><span> </span><a href="#local-6989586621681542934"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-582"></a><span>            </span><span class="hs-comment">-- We only enter cc after setting up update so</span><span>
</span><a name="line-583"></a><span>            </span><span class="hs-comment">-- that cc of enclosing scope will be recorded</span><span>
</span><a name="line-584"></a><span>            </span><span class="hs-comment">-- in update frame CAF/DICT functions will be</span><span>
</span><a name="line-585"></a><span>            </span><span class="hs-comment">-- subsumed by this enclosing cc</span><span>
</span><a name="line-586"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="StgCmmProf.html#enterCostCentreThunk"><span class="hs-identifier hs-var">enterCostCentreThunk</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><a href="CmmExpr.html#nodeReg"><span class="hs-identifier hs-var">nodeReg</span></a><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542940"><a href="#local-6989586621681542940"><span class="hs-identifier">lf_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">closureLFInfo</span><span> </span><a href="#local-6989586621681542931"><span class="hs-identifier hs-var">cl_info</span></a><span>
</span><a name="line-588"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542941"><a href="#local-6989586621681542941"><span class="hs-identifier">fv_bindings</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="StgCmmBind.html#bind_fv"><span class="hs-identifier hs-var">bind_fv</span></a><span> </span><a href="#local-6989586621681542932"><span class="hs-identifier hs-var">fv_details</span></a><span>
</span><a name="line-589"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="StgCmmBind.html#load_fvs"><span class="hs-identifier hs-var">load_fvs</span></a><span> </span><a href="#local-6989586621681542934"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621681542940"><span class="hs-identifier hs-var">lf_info</span></a><span> </span><a href="#local-6989586621681542941"><span class="hs-identifier hs-var">fv_bindings</span></a><span>
</span><a name="line-590"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="StgCmmExpr.html#cgExpr"><span class="hs-identifier hs-var">cgExpr</span></a><span> </span><a href="#local-6989586621681542936"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-594"></a><span class="hs-comment">--              Update and black-hole wrappers</span><span>
</span><a name="line-595"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-596"></a><span>
</span><a name="line-597"></a><span class="hs-identifier">blackHoleIt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-598"></a><span class="hs-comment">-- Only called for closures with no args</span><span>
</span><a name="line-599"></a><span class="hs-comment">-- Node points to the closure</span><span>
</span><a name="line-600"></a><a name="blackHoleIt"><a href="StgCmmBind.html#blackHoleIt"><span class="hs-identifier">blackHoleIt</span></a></a><span> </span><a name="local-6989586621681542942"><a href="#local-6989586621681542942"><span class="hs-identifier">node_reg</span></a></a><span>
</span><a name="line-601"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmBind.html#emitBlackHoleCode"><span class="hs-identifier hs-var">emitBlackHoleCode</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542942"><span class="hs-identifier hs-var">node_reg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-identifier">emitBlackHoleCode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-604"></a><a name="emitBlackHoleCode"><a href="StgCmmBind.html#emitBlackHoleCode"><span class="hs-identifier">emitBlackHoleCode</span></a></a><span> </span><a name="local-6989586621681542943"><a href="#local-6989586621681542943"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-605"></a><span>  </span><a name="local-6989586621681542944"><a href="#local-6989586621681542944"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span>  </span><span class="hs-comment">-- Eager blackholing is normally disabled, but can be turned on with</span><span>
</span><a name="line-608"></a><span>  </span><span class="hs-comment">-- -feager-blackholing.  When it is on, we replace the info pointer</span><span>
</span><a name="line-609"></a><span>  </span><span class="hs-comment">-- of the thunk with stg_EAGER_BLACKHOLE_info on entry.</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span>  </span><span class="hs-comment">-- If we wanted to do eager blackholing with slop filling, we'd need</span><span>
</span><a name="line-612"></a><span>  </span><span class="hs-comment">-- to do it at the *end* of a basic block, otherwise we overwrite</span><span>
</span><a name="line-613"></a><span>  </span><span class="hs-comment">-- the free variables in the thunk that we still need.  We have a</span><span>
</span><a name="line-614"></a><span>  </span><span class="hs-comment">-- patch for this from Andy Cheadle, but not incorporated yet. --SDM</span><span>
</span><a name="line-615"></a><span>  </span><span class="hs-comment">-- [6/2004]</span><span>
</span><a name="line-616"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-617"></a><span>  </span><span class="hs-comment">-- Previously, eager blackholing was enabled when ticky-ticky was</span><span>
</span><a name="line-618"></a><span>  </span><span class="hs-comment">-- on. But it didn't work, and it wasn't strictly necessary to bring</span><span>
</span><a name="line-619"></a><span>  </span><span class="hs-comment">-- back minimal ticky-ticky, so now EAGER_BLACKHOLING is</span><span>
</span><a name="line-620"></a><span>  </span><span class="hs-comment">-- unconditionally disabled. -- krc 1/2007</span><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span>  </span><span class="hs-comment">-- Note the eager-blackholing check is here rather than in blackHoleOnEntry,</span><span>
</span><a name="line-623"></a><span>  </span><span class="hs-comment">-- because emitBlackHoleCode is called from CmmParse.</span><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span>  </span><span class="hs-keyword">let</span><span>  </span><a name="local-6989586621681542945"><a href="#local-6989586621681542945"><span class="hs-identifier">eager_blackholing</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621681542944"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-626"></a><span>                         </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_EagerBlackHoling</span><span> </span><a href="#local-6989586621681542944"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-627"></a><span>             </span><span class="hs-comment">-- Profiling needs slop filling (to support LDV</span><span>
</span><a name="line-628"></a><span>             </span><span class="hs-comment">-- profiling), so currently eager blackholing doesn't</span><span>
</span><a name="line-629"></a><span>             </span><span class="hs-comment">-- work with profiling.</span><span>
</span><a name="line-630"></a><span>
</span><a name="line-631"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621681542945"><span class="hs-identifier hs-var">eager_blackholing</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-632"></a><span>    </span><a href="StgCmmMonad.html#emitStore"><span class="hs-identifier hs-var">emitStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffsetW"><span class="hs-identifier hs-var">cmmOffsetW</span></a><span> </span><a href="#local-6989586621681542944"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542943"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-special">(</span><a href="SMRep.html#fixedHdrSizeW"><span class="hs-identifier hs-var">fixedHdrSizeW</span></a><span> </span><a href="#local-6989586621681542944"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="CmmUtils.html#currentTSOExpr"><span class="hs-identifier hs-var">currentTSOExpr</span></a><span>
</span><a name="line-633"></a><span>    </span><a href="StgCmmForeign.html#emitPrimCall"><span class="hs-identifier hs-var">emitPrimCall</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="CmmMachOp.html#MO_WriteBarrier"><span class="hs-identifier hs-var">MO_WriteBarrier</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-634"></a><span>    </span><a href="StgCmmMonad.html#emitStore"><span class="hs-identifier hs-var">emitStore</span></a><span> </span><a href="#local-6989586621681542943"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmGlobal"><span class="hs-identifier hs-var">CmmGlobal</span></a><span> </span><a href="CmmExpr.html#EagerBlackholeInfo"><span class="hs-identifier hs-var">EagerBlackholeInfo</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>
</span><a name="line-636"></a><span class="hs-identifier">setupUpdate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCmmClosure.html#ClosureInfo"><span class="hs-identifier hs-type">ClosureInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-637"></a><span>        </span><span class="hs-comment">-- Nota Bene: this function does not change Node (even if it's a CAF),</span><span>
</span><a name="line-638"></a><span>        </span><span class="hs-comment">-- so that the cost centre in the original closure can still be</span><span>
</span><a name="line-639"></a><span>        </span><span class="hs-comment">-- extracted by a subsequent enterCostCentre</span><span>
</span><a name="line-640"></a><a name="setupUpdate"><a href="StgCmmBind.html#setupUpdate"><span class="hs-identifier">setupUpdate</span></a></a><span> </span><a name="local-6989586621681542946"><a href="#local-6989586621681542946"><span class="hs-identifier">closure_info</span></a></a><span> </span><a name="local-6989586621681542947"><a href="#local-6989586621681542947"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621681542948"><a href="#local-6989586621681542948"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-641"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#lfUpdatable"><span class="hs-identifier hs-var">lfUpdatable</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">closureLFInfo</span><span> </span><a href="#local-6989586621681542946"><span class="hs-identifier hs-var">closure_info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-642"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681542948"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#isStaticClosure"><span class="hs-identifier hs-var">isStaticClosure</span></a><span> </span><a href="#local-6989586621681542946"><span class="hs-identifier hs-var">closure_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-645"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="StgCmmClosure.html#closureUpdReqd"><span class="hs-identifier hs-var">closureUpdReqd</span></a><span> </span><a href="#local-6989586621681542946"><span class="hs-identifier hs-var">closure_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="StgCmmTicky.html#tickyUpdateFrameOmitted"><span class="hs-identifier hs-var">tickyUpdateFrameOmitted</span></a><span class="hs-special">;</span><span> </span><a href="#local-6989586621681542948"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-647"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-648"></a><span>          </span><a href="StgCmmTicky.html#tickyPushUpdateFrame"><span class="hs-identifier hs-var">tickyPushUpdateFrame</span></a><span>
</span><a name="line-649"></a><span>          </span><a name="local-6989586621681542949"><a href="#local-6989586621681542949"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-650"></a><span>          </span><span class="hs-keyword">let</span><span>
</span><a name="line-651"></a><span>              </span><a name="local-6989586621681542950"><a href="#local-6989586621681542950"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCmmClosure.html#blackHoleOnEntry"><span class="hs-identifier hs-var">blackHoleOnEntry</span></a><span> </span><a href="#local-6989586621681542946"><span class="hs-identifier hs-var">closure_info</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-652"></a><span>                   </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_SccProfilingOn</span><span> </span><a href="#local-6989586621681542949"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-653"></a><span>                   </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_EagerBlackHoling</span><span> </span><a href="#local-6989586621681542949"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-654"></a><span>
</span><a name="line-655"></a><span>              </span><a name="local-6989586621681542951"><a href="#local-6989586621681542951"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681542950"><span class="hs-identifier hs-var">bh</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkBHUpdInfoLabel"><span class="hs-identifier hs-var">mkBHUpdInfoLabel</span></a><span>
</span><a name="line-656"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkUpdInfoLabel"><span class="hs-identifier hs-var">mkUpdInfoLabel</span></a><span>
</span><a name="line-657"></a><span>
</span><a name="line-658"></a><span>          </span><a href="StgCmmBind.html#pushUpdateFrame"><span class="hs-identifier hs-var">pushUpdateFrame</span></a><span> </span><a href="#local-6989586621681542951"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542947"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542948"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-659"></a><span>
</span><a name="line-660"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- A static closure</span><span>
</span><a name="line-661"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="StgCmmTicky.html#tickyUpdateBhCaf"><span class="hs-identifier hs-var">tickyUpdateBhCaf</span></a><span> </span><a href="#local-6989586621681542946"><span class="hs-identifier hs-var">closure_info</span></a><span>
</span><a name="line-662"></a><span>
</span><a name="line-663"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="StgCmmClosure.html#closureUpdReqd"><span class="hs-identifier hs-var">closureUpdReqd</span></a><span> </span><a href="#local-6989586621681542946"><span class="hs-identifier hs-var">closure_info</span></a><span>
</span><a name="line-664"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>       </span><span class="hs-comment">-- Blackhole the (updatable) CAF:</span><span>
</span><a name="line-665"></a><span>                </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681542952"><a href="#local-6989586621681542952"><span class="hs-identifier">upd_closure</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmBind.html#link_caf"><span class="hs-identifier hs-var">link_caf</span></a><span> </span><a href="#local-6989586621681542947"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-666"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="StgCmmBind.html#pushUpdateFrame"><span class="hs-identifier hs-var">pushUpdateFrame</span></a><span> </span><a href="CLabel.html#mkBHUpdInfoLabel"><span class="hs-identifier hs-var">mkBHUpdInfoLabel</span></a><span> </span><a href="#local-6989586621681542952"><span class="hs-identifier hs-var">upd_closure</span></a><span> </span><a href="#local-6989586621681542948"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-667"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><a href="StgCmmTicky.html#tickyUpdateFrameOmitted"><span class="hs-identifier hs-var">tickyUpdateFrameOmitted</span></a><span class="hs-special">;</span><span> </span><a href="#local-6989586621681542948"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">}</span><span>
</span><a name="line-668"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-669"></a><span>
</span><a name="line-670"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-671"></a><span class="hs-comment">-- Setting up update frames</span><span>
</span><a name="line-672"></a><span>
</span><a name="line-673"></a><span class="hs-comment">-- Push the update frame on the stack in the Entry area,</span><span>
</span><a name="line-674"></a><span class="hs-comment">-- leaving room for the return address that is already</span><span>
</span><a name="line-675"></a><span class="hs-comment">-- at the old end of the area.</span><span>
</span><a name="line-676"></a><span class="hs-comment">--</span><span>
</span><a name="line-677"></a><span class="hs-identifier">pushUpdateFrame</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-678"></a><a name="pushUpdateFrame"><a href="StgCmmBind.html#pushUpdateFrame"><span class="hs-identifier">pushUpdateFrame</span></a></a><span> </span><a name="local-6989586621681542953"><a href="#local-6989586621681542953"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621681542954"><a href="#local-6989586621681542954"><span class="hs-identifier">updatee</span></a></a><span> </span><a name="local-6989586621681542955"><a href="#local-6989586621681542955"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-679"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-680"></a><span>       </span><a name="local-6989586621681542956"><a href="#local-6989586621681542956"><span class="hs-identifier">updfr</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-681"></a><span>       </span><a name="local-6989586621681542957"><a href="#local-6989586621681542957"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-682"></a><span>       </span><span class="hs-keyword">let</span><span>
</span><a name="line-683"></a><span>           </span><a name="local-6989586621681542958"><a href="#local-6989586621681542958"><span class="hs-identifier">hdr</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#fixedHdrSize"><span class="hs-identifier hs-var">fixedHdrSize</span></a><span> </span><a href="#local-6989586621681542957"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-684"></a><span>           </span><a name="local-6989586621681542959"><a href="#local-6989586621681542959"><span class="hs-identifier">frame</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681542956"><span class="hs-identifier hs-var">updfr</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><a href="#local-6989586621681542958"><span class="hs-identifier hs-var">hdr</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">sIZEOF_StgUpdateFrame_NoHdr</span><span> </span><a href="#local-6989586621681542957"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-685"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-686"></a><span>       </span><a href="StgCmmBind.html#emitUpdateFrame"><span class="hs-identifier hs-var">emitUpdateFrame</span></a><span> </span><a href="#local-6989586621681542957"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><a href="CmmExpr.html#Old"><span class="hs-identifier hs-var">Old</span></a><span> </span><a href="#local-6989586621681542959"><span class="hs-identifier hs-var">frame</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542953"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621681542954"><span class="hs-identifier hs-var">updatee</span></a><span>
</span><a name="line-687"></a><span>       </span><a href="StgCmmMonad.html#withUpdFrameOff"><span class="hs-identifier hs-var">withUpdFrameOff</span></a><span> </span><a href="#local-6989586621681542959"><span class="hs-identifier hs-var">frame</span></a><span> </span><a href="#local-6989586621681542955"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span class="hs-identifier">emitUpdateFrame</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-690"></a><a name="emitUpdateFrame"><a href="StgCmmBind.html#emitUpdateFrame"><span class="hs-identifier">emitUpdateFrame</span></a></a><span> </span><a name="local-6989586621681542960"><a href="#local-6989586621681542960"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681542961"><a href="#local-6989586621681542961"><span class="hs-identifier">frame</span></a></a><span> </span><a name="local-6989586621681542962"><a href="#local-6989586621681542962"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621681542963"><a href="#local-6989586621681542963"><span class="hs-identifier">updatee</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-691"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-692"></a><span>           </span><a name="local-6989586621681542964"><a href="#local-6989586621681542964"><span class="hs-identifier">hdr</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="SMRep.html#fixedHdrSize"><span class="hs-identifier hs-var">fixedHdrSize</span></a><span> </span><a href="#local-6989586621681542960"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-693"></a><span>           </span><a name="local-6989586621681542965"><a href="#local-6989586621681542965"><span class="hs-identifier">off_updatee</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681542964"><span class="hs-identifier hs-var">hdr</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">oFFSET_StgUpdateFrame_updatee</span><span> </span><a href="#local-6989586621681542960"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-694"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-695"></a><span>  </span><a href="StgCmmMonad.html#emitStore"><span class="hs-identifier hs-var">emitStore</span></a><span> </span><a href="#local-6989586621681542961"><span class="hs-identifier hs-var">frame</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#mkLblExpr"><span class="hs-identifier hs-var">mkLblExpr</span></a><span> </span><a href="#local-6989586621681542962"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-696"></a><span>  </span><a href="StgCmmMonad.html#emitStore"><span class="hs-identifier hs-var">emitStore</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmOffset"><span class="hs-identifier hs-var">cmmOffset</span></a><span> </span><a href="#local-6989586621681542960"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681542961"><span class="hs-identifier hs-var">frame</span></a><span> </span><a href="#local-6989586621681542965"><span class="hs-identifier hs-var">off_updatee</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681542963"><span class="hs-identifier hs-var">updatee</span></a><span>
</span><a name="line-697"></a><span>  </span><a href="StgCmmProf.html#initUpdFrameProf"><span class="hs-identifier hs-var">initUpdFrameProf</span></a><span> </span><a href="#local-6989586621681542961"><span class="hs-identifier hs-var">frame</span></a><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span class="hs-comment">-----------------------------------------------------------------------------</span><span>
</span><a name="line-700"></a><span class="hs-comment">-- Entering a CAF</span><span>
</span><a name="line-701"></a><span class="hs-comment">--</span><span>
</span><a name="line-702"></a><span class="hs-comment">-- See Note [CAF management] in rts/sm/Storage.c</span><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span class="hs-identifier">link_caf</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#LocalReg"><span class="hs-identifier hs-type">LocalReg</span></a><span>           </span><span class="hs-comment">-- pointer to the closure</span><span>
</span><a name="line-705"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>               </span><span class="hs-comment">-- True &lt;=&gt; updatable, False &lt;=&gt; single-entry</span><span>
</span><a name="line-706"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCmmMonad.html#FCode"><span class="hs-identifier hs-type">FCode</span></a><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>      </span><span class="hs-comment">-- Returns amode for closure to be updated</span><span>
</span><a name="line-707"></a><span class="hs-comment">-- This function returns the address of the black hole, so it can be</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- updated with the new value when available.</span><span>
</span><a name="line-709"></a><a name="link_caf"><a href="StgCmmBind.html#link_caf"><span class="hs-identifier">link_caf</span></a></a><span> </span><a name="local-6989586621681542966"><a href="#local-6989586621681542966"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621681542967"><a href="#local-6989586621681542967"><span class="hs-identifier">_is_upd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-710"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621681542968"><a href="#local-6989586621681542968"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-711"></a><span>        </span><span class="hs-comment">-- Call the RTS function newCAF, returning the newly-allocated</span><span>
</span><a name="line-712"></a><span>        </span><span class="hs-comment">-- blackhole indirection closure</span><span>
</span><a name="line-713"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542969"><a href="#local-6989586621681542969"><span class="hs-identifier">newCAF_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkForeignLabel"><span class="hs-identifier hs-var">mkForeignLabel</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;newCAF&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-714"></a><span>                                    </span><a href="CLabel.html#ForeignLabelInExternalPackage"><span class="hs-identifier hs-var">ForeignLabelInExternalPackage</span></a><span> </span><span class="hs-identifier hs-var">IsFunction</span><span>
</span><a name="line-715"></a><span>  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542970"><a href="#local-6989586621681542970"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmUtils.html#newTemp"><span class="hs-identifier hs-var">newTemp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bWord</span><span> </span><a href="#local-6989586621681542968"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-716"></a><span>  </span><span class="hs-special">;</span><span> </span><a href="StgCmmUtils.html#emitRtsCallGen"><span class="hs-identifier hs-var">emitRtsCallGen</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681542970"><span class="hs-identifier hs-var">bh</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">AddrHint</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681542969"><span class="hs-identifier hs-var">newCAF_lbl</span></a><span>
</span><a name="line-717"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#baseExpr"><span class="hs-identifier hs-var">baseExpr</span></a><span class="hs-special">,</span><span>  </span><span class="hs-identifier hs-var">AddrHint</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-718"></a><span>        </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542966"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">AddrHint</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-719"></a><span>      </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><span>  </span><span class="hs-comment">-- see Note [atomic CAF entry] in rts/sm/Storage.c</span><span>
</span><a name="line-722"></a><span>  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621681542971"><a href="#local-6989586621681542971"><span class="hs-identifier">updfr</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCmmMonad.html#getUpdFrameOff"><span class="hs-identifier hs-var">getUpdFrameOff</span></a><span>
</span><a name="line-723"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681542972"><a href="#local-6989586621681542972"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmInfo.html#entryCode"><span class="hs-identifier hs-var">entryCode</span></a><span> </span><a href="#local-6989586621681542968"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmInfo.html#closureInfoPtr"><span class="hs-identifier hs-var">closureInfoPtr</span></a><span> </span><a href="#local-6989586621681542968"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542966"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-724"></a><span>  </span><span class="hs-special">;</span><span> </span><a href="StgCmmMonad.html#emit"><span class="hs-identifier hs-var">emit</span></a><span> </span><span class="hs-operator hs-var">=&lt;&lt;</span><span> </span><a href="StgCmmMonad.html#mkCmmIfThen"><span class="hs-identifier hs-var">mkCmmIfThen</span></a><span>
</span><a name="line-725"></a><span>      </span><span class="hs-special">(</span><a href="CmmUtils.html#cmmEqWord"><span class="hs-identifier hs-var">cmmEqWord</span></a><span> </span><a href="#local-6989586621681542968"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542970"><span class="hs-identifier hs-var">bh</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#zeroExpr"><span class="hs-identifier hs-var">zeroExpr</span></a><span> </span><a href="#local-6989586621681542968"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-726"></a><span>        </span><span class="hs-comment">-- re-enter the CAF</span><span>
</span><a name="line-727"></a><span>       </span><span class="hs-special">(</span><a href="MkGraph.html#mkJump"><span class="hs-identifier hs-var">mkJump</span></a><span> </span><a href="#local-6989586621681542968"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="CmmNode.html#NativeNodeCall"><span class="hs-identifier hs-var">NativeNodeCall</span></a><span> </span><a href="#local-6989586621681542972"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681542971"><span class="hs-identifier hs-var">updfr</span></a><span class="hs-special">)</span><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmReg"><span class="hs-identifier hs-var">CmmReg</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLocal"><span class="hs-identifier hs-var">CmmLocal</span></a><span> </span><a href="#local-6989586621681542970"><span class="hs-identifier hs-var">bh</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-730"></a><span>
</span><a name="line-731"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-732"></a><span class="hs-comment">--              Profiling</span><span>
</span><a name="line-733"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-734"></a><span>
</span><a name="line-735"></a><span class="hs-comment">-- For &quot;global&quot; data constructors the description is simply occurrence</span><span>
</span><a name="line-736"></a><span class="hs-comment">-- name of the data constructor itself.  Otherwise it is determined by</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- @closureDescription@ from the let binding information.</span><span>
</span><a name="line-738"></a><span>
</span><a name="line-739"></a><span class="hs-identifier">closureDescription</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span>
</span><a name="line-740"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span>            </span><span class="hs-comment">-- Module</span><span>
</span><a name="line-741"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>              </span><span class="hs-comment">-- Id of closure binding</span><span>
</span><a name="line-742"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-743"></a><span>        </span><span class="hs-comment">-- Not called for StgRhsCon which have global info tables built in</span><span>
</span><a name="line-744"></a><span>        </span><span class="hs-comment">-- CgConTbls.hs with a description generated from the data constructor</span><span>
</span><a name="line-745"></a><a name="closureDescription"><a href="StgCmmBind.html#closureDescription"><span class="hs-identifier">closureDescription</span></a></a><span> </span><a name="local-6989586621681542973"><a href="#local-6989586621681542973"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681542974"><a href="#local-6989586621681542974"><span class="hs-identifier">mod_name</span></a></a><span> </span><a name="local-6989586621681542975"><a href="#local-6989586621681542975"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-746"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">showSDocDump</span><span> </span><a href="#local-6989586621681542973"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'&lt;'</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-747"></a><span>                    </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621681542975"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-748"></a><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681542975"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-comment">-- ppr will include the module name prefix</span><span>
</span><a name="line-749"></a><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">pprModule</span><span> </span><a href="#local-6989586621681542974"><span class="hs-identifier hs-var">mod_name</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'.'</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621681542975"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span>
</span><a name="line-750"></a><span>                    </span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'&gt;'</span><span class="hs-special">)</span><span>
</span><a name="line-751"></a><span>   </span><span class="hs-comment">-- showSDocDump, because we want to see the unique on the Name.</span><span>
</span><a name="line-752"></a></pre></body></html>