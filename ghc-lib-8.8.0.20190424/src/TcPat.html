<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


TcPat: Typechecking patterns
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, RankNTypes, TupleSections #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcPat</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcPat.html#tcLetPat"><span class="hs-identifier hs-var">tcLetPat</span></a><span class="hs-special">,</span><span> </span><a href="TcPat.html#newLetBndr"><span class="hs-identifier hs-var">newLetBndr</span></a><span class="hs-special">,</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="TcPat.html#tcPat"><span class="hs-identifier hs-var">tcPat</span></a><span class="hs-special">,</span><span> </span><a href="TcPat.html#tcPat_O"><span class="hs-identifier hs-var">tcPat_O</span></a><span class="hs-special">,</span><span> </span><a href="TcPat.html#tcPats"><span class="hs-identifier hs-var">tcPats</span></a><span>
</span><a name="line-16"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="TcPat.html#addDataConStupidTheta"><span class="hs-identifier hs-var">addDataConStupidTheta</span></a><span class="hs-special">,</span><span> </span><a href="TcPat.html#badFieldCon"><span class="hs-identifier hs-var">badFieldCon</span></a><span class="hs-special">,</span><span> </span><a href="TcPat.html#polyPatSig"><span class="hs-identifier hs-var">polyPatSig</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span>   </span><a href="TcExpr.html"><span class="hs-identifier">TcExpr</span></a><span class="hs-special">(</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcSyntaxOpGen"><span class="hs-identifier hs-var">tcSyntaxOpGen</span></a><span class="hs-special">,</span><span> </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="TcSigs.html"><span class="hs-identifier">TcSigs</span></a><span class="hs-special">(</span><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#lookupPragEnv"><span class="hs-identifier hs-var">lookupPragEnv</span></a><span class="hs-special">,</span><span> </span><a href="TcSigs.html#addInlinePrags"><span class="hs-identifier hs-var">addInlinePrags</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Var</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="TcValidity.html"><span class="hs-identifier">TcValidity</span></a><span class="hs-special">(</span><span> </span><a href="TcValidity.html#arityErr"><span class="hs-identifier hs-var">arityErr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">pprTyVars</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarSet</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getNth</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                External interface
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-identifier">tcLetPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span>
</span><a name="line-67"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>
</span><a name="line-68"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211512"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-69"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211512"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><a name="tcLetPat"><a href="TcPat.html#tcLetPat"><span class="hs-identifier">tcLetPat</span></a></a><span> </span><a name="local-6989586621683211513"><a href="#local-6989586621683211513"><span class="hs-identifier">sig_fn</span></a></a><span> </span><a name="local-6989586621683211514"><a href="#local-6989586621683211514"><span class="hs-identifier">no_gen</span></a></a><span> </span><a name="local-6989586621683211515"><a href="#local-6989586621683211515"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683211516"><a href="#local-6989586621683211516"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211517"><a href="#local-6989586621683211517"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211518"><a href="#local-6989586621683211518"><span class="hs-identifier">bind_lvl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getTcLevel"><span class="hs-identifier hs-var">getTcLevel</span></a><span>
</span><a name="line-72"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211519"><a href="#local-6989586621683211519"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#LetPat"><span class="hs-identifier hs-var">LetPat</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pc_lvl</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211518"><span class="hs-identifier hs-var">bind_lvl</span></a><span>
</span><a name="line-73"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pc_sig_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211513"><span class="hs-identifier hs-var">sig_fn</span></a><span>
</span><a name="line-74"></a><span>                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pc_new</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211514"><span class="hs-identifier hs-var">no_gen</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-75"></a><span>             </span><a name="local-6989586621683211520"><a href="#local-6989586621683211520"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_lazy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-76"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211519"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-77"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pe_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PatOrigin</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211515"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683211516"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211520"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211517"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-82"></a><span class="hs-identifier">tcPats</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-83"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- Patterns,</span><span>
</span><a name="line-84"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExpSigmaType</span><span class="hs-special">]</span><span>         </span><span class="hs-comment">--   and their types</span><span>
</span><a name="line-85"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211511"><span class="hs-identifier hs-type">a</span></a><span>                  </span><span class="hs-comment">--   and the checker for the body</span><span>
</span><a name="line-86"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211511"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">-- This is the externally-callable wrapper function</span><span>
</span><a name="line-89"></a><span class="hs-comment">-- Typecheck the patterns, extend the environment to bind the variables,</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- do the thing inside, use any existentially-bound dictionaries to</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- discharge parts of the returning LIE, and deal with pattern type</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- signatures</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">--   1. Initialise the PatState</span><span>
</span><a name="line-95"></a><span class="hs-comment">--   2. Check the patterns</span><span>
</span><a name="line-96"></a><span class="hs-comment">--   3. Check the body</span><span>
</span><a name="line-97"></a><span class="hs-comment">--   4. Check that no existentials escape</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><a name="tcPats"><a href="TcPat.html#tcPats"><span class="hs-identifier">tcPats</span></a></a><span> </span><a name="local-6989586621683211521"><a href="#local-6989586621683211521"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683211522"><a href="#local-6989586621683211522"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621683211523"><a href="#local-6989586621683211523"><span class="hs-identifier">pat_tys</span></a></a><span> </span><a name="local-6989586621683211524"><a href="#local-6989586621683211524"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-100"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#tc_lpats"><span class="hs-identifier hs-var">tc_lpats</span></a><span> </span><a href="#local-6989586621683211525"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211522"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621683211523"><span class="hs-identifier hs-var">pat_tys</span></a><span> </span><a href="#local-6989586621683211524"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-101"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-102"></a><span>    </span><a name="local-6989586621683211525"><a href="#local-6989586621683211525"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_lazy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#LamPat"><span class="hs-identifier hs-var">LamPat</span></a><span> </span><a href="#local-6989586621683211521"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">pe_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PatOrigin</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-identifier">tcPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-105"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>
</span><a name="line-106"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211510"><span class="hs-identifier hs-type">a</span></a><span>                     </span><span class="hs-comment">-- Checker for body</span><span>
</span><a name="line-107"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211510"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><a name="tcPat"><a href="TcPat.html#tcPat"><span class="hs-identifier">tcPat</span></a></a><span> </span><a name="local-6989586621683211526"><a href="#local-6989586621683211526"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#tcPat_O"><span class="hs-identifier hs-var">tcPat_O</span></a><span> </span><a href="#local-6989586621683211526"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-identifier hs-var">PatOrigin</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">-- | A variant of 'tcPat' that takes a custom origin</span><span>
</span><a name="line-111"></a><span class="hs-identifier">tcPat_O</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-112"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>              </span><span class="hs-comment">-- ^ origin to use if the type needs inst'ing</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>
</span><a name="line-114"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211509"><span class="hs-identifier hs-type">a</span></a><span>                 </span><span class="hs-comment">-- Checker for body</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211509"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><a name="tcPat_O"><a href="TcPat.html#tcPat_O"><span class="hs-identifier">tcPat_O</span></a></a><span> </span><a name="local-6989586621683211527"><a href="#local-6989586621683211527"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621683211528"><a href="#local-6989586621683211528"><span class="hs-identifier">orig</span></a></a><span> </span><a name="local-6989586621683211529"><a href="#local-6989586621683211529"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683211530"><a href="#local-6989586621683211530"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211531"><a href="#local-6989586621683211531"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-117"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211529"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683211530"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211532"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211531"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-118"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-119"></a><span>    </span><a name="local-6989586621683211532"><a href="#local-6989586621683211532"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_lazy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#LamPat"><span class="hs-identifier hs-var">LamPat</span></a><span> </span><a href="#local-6989586621683211527"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">pe_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211528"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                PatEnv, PatCtxt, LetBndrSpec
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-keyword">data</span><span> </span><a name="PatEnv"><a href="TcPat.html#PatEnv"><span class="hs-identifier">PatEnv</span></a></a><span>
</span><a name="line-131"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="PE"><a href="TcPat.html#PE"><span class="hs-identifier">PE</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="pe_lazy"><a href="TcPat.html#pe_lazy"><span class="hs-identifier">pe_lazy</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>        </span><span class="hs-comment">-- True &lt;=&gt; lazy context, so no existentials allowed</span><span>
</span><a name="line-132"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="pe_ctxt"><a href="TcPat.html#pe_ctxt"><span class="hs-identifier">pe_ctxt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatCtxt"><span class="hs-identifier hs-type">PatCtxt</span></a><span>     </span><span class="hs-comment">-- Context in which the whole pattern appears</span><span>
</span><a name="line-133"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="pe_orig"><a href="TcPat.html#pe_orig"><span class="hs-identifier">pe_orig</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">CtOrigin</span><span>    </span><span class="hs-comment">-- origin to use if the pat_ty needs inst'ing</span><span>
</span><a name="line-134"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-keyword">data</span><span> </span><a name="PatCtxt"><a href="TcPat.html#PatCtxt"><span class="hs-identifier">PatCtxt</span></a></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="LamPat"><a href="TcPat.html#LamPat"><span class="hs-identifier">LamPat</span></a></a><span>   </span><span class="hs-comment">-- Used for lambdas, case etc</span><span>
</span><a name="line-138"></a><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsMatchContext</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LetPat"><a href="TcPat.html#LetPat"><span class="hs-identifier">LetPat</span></a></a><span>   </span><span class="hs-comment">-- Used only for let(rec) pattern bindings</span><span>
</span><a name="line-141"></a><span>             </span><span class="hs-comment">-- See Note [Typing patterns in pattern bindings]</span><span>
</span><a name="line-142"></a><span>       </span><span class="hs-special">{</span><span> </span><a name="pc_lvl"><a href="TcPat.html#pc_lvl"><span class="hs-identifier">pc_lvl</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcLevel</span><span>
</span><a name="line-143"></a><span>                   </span><span class="hs-comment">-- Level of the binding group</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="pc_sig_fn"><a href="TcPat.html#pc_sig_fn"><span class="hs-identifier">pc_sig_fn</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-146"></a><span>                   </span><span class="hs-comment">-- Tells the expected type</span><span>
</span><a name="line-147"></a><span>                   </span><span class="hs-comment">-- for binders with a signature</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="pc_new"><a href="TcPat.html#pc_new"><span class="hs-identifier">pc_new</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span>
</span><a name="line-150"></a><span>                </span><span class="hs-comment">-- How to make a new binder</span><span>
</span><a name="line-151"></a><span>       </span><span class="hs-special">}</span><span>        </span><span class="hs-comment">-- for binders without signatures</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-keyword">data</span><span> </span><a name="LetBndrSpec"><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier">LetBndrSpec</span></a></a><span>
</span><a name="line-154"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="LetLclBndr"><a href="TcPat.html#LetLclBndr"><span class="hs-identifier">LetLclBndr</span></a></a><span>            </span><span class="hs-comment">-- We are going to generalise, and wrap in an AbsBinds</span><span>
</span><a name="line-155"></a><span>                          </span><span class="hs-comment">-- so clone a fresh binder for the local monomorphic Id</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LetGblBndr"><a href="TcPat.html#LetGblBndr"><span class="hs-identifier">LetGblBndr</span></a></a><span> </span><a href="TcSigs.html#TcPragEnv"><span class="hs-identifier hs-type">TcPragEnv</span></a><span>  </span><span class="hs-comment">-- Generalisation plan is NoGen, so there isn't going</span><span>
</span><a name="line-158"></a><span>                          </span><span class="hs-comment">-- to be an AbsBinds; So we must bind the global version</span><span>
</span><a name="line-159"></a><span>                          </span><span class="hs-comment">-- of the binder right away.</span><span>
</span><a name="line-160"></a><span>                          </span><span class="hs-comment">-- And here is the inline-pragma information</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-163"></a><span>  </span><a name="local-8214565720323806217"><span class="hs-identifier">ppr</span></a><span> </span><a href="TcPat.html#LetLclBndr"><span class="hs-identifier hs-var">LetLclBndr</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;LetLclBndr&quot;</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="TcPat.html#LetGblBndr"><span class="hs-identifier hs-var">LetGblBndr</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;LetGblBndr&quot;</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-identifier">makeLazy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span>
</span><a name="line-167"></a><a name="makeLazy"><a href="TcPat.html#makeLazy"><span class="hs-identifier">makeLazy</span></a></a><span> </span><a name="local-6989586621683211533"><a href="#local-6989586621683211533"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211533"><span class="hs-identifier hs-var">penv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_lazy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">inPatBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-170"></a><a name="inPatBind"><a href="TcPat.html#inPatBind"><span class="hs-identifier">inPatBind</span></a></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#LetPat"><span class="hs-identifier hs-var">LetPat</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-171"></a><span class="hs-identifier">inPatBind</span><span> </span><span class="hs-special">(</span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#LamPat"><span class="hs-identifier hs-var">LamPat</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
                Binders
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-identifier">tcPatBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcId</span><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- (coi, xp) = tcPatBndr penv x pat_ty</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- Then coi : pat_ty ~ typeof(xp)</span><span>
</span><a name="line-182"></a><span class="hs-comment">--</span><span>
</span><a name="line-183"></a><a name="tcPatBndr"><a href="TcPat.html#tcPatBndr"><span class="hs-identifier">tcPatBndr</span></a></a><span> </span><a name="local-6989586621683211534"><a href="#local-6989586621683211534"><span class="hs-identifier">penv</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#LetPat"><span class="hs-identifier hs-var">LetPat</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pc_lvl</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683211535"><a href="#local-6989586621683211535"><span class="hs-identifier">bind_lvl</span></a></a><span>
</span><a name="line-184"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pc_sig_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683211536"><a href="#local-6989586621683211536"><span class="hs-identifier">sig_fn</span></a></a><span>
</span><a name="line-185"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pc_new</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683211537"><a href="#local-6989586621683211537"><span class="hs-identifier">no_gen</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><span>          </span><a name="local-6989586621683211538"><a href="#local-6989586621683211538"><span class="hs-identifier">bndr_name</span></a></a><span> </span><a name="local-6989586621683211539"><a href="#local-6989586621683211539"><span class="hs-identifier">exp_pat_ty</span></a></a><span>
</span><a name="line-187"></a><span>  </span><span class="hs-comment">-- For the LetPat cases, see</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-comment">-- Note [Typechecking pattern bindings] in TcBinds</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683211540"><a href="#local-6989586621683211540"><span class="hs-identifier">bndr_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683211536"><span class="hs-identifier hs-var">sig_fn</span></a><span> </span><a href="#local-6989586621683211538"><span class="hs-identifier hs-var">bndr_name</span></a><span>   </span><span class="hs-comment">-- There is a signature</span><span>
</span><a name="line-191"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211541"><a href="#local-6989586621683211541"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcSubTypePat"><span class="hs-identifier hs-var">tcSubTypePat</span></a><span> </span><a href="#local-6989586621683211534"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211539"><span class="hs-identifier hs-var">exp_pat_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683211540"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>           </span><span class="hs-comment">-- See Note [Subsumption check at pattern variables]</span><span>
</span><a name="line-193"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPatBndr(sig)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211540"><span class="hs-identifier hs-var">bndr_id</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683211540"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211539"><span class="hs-identifier hs-var">exp_pat_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211541"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211540"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-195"></a><span>
</span><a name="line-196"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                          </span><span class="hs-comment">-- No signature</span><span>
</span><a name="line-197"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211545"><a href="#local-6989586621683211545"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211546"><a href="#local-6989586621683211546"><span class="hs-identifier">bndr_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683211539"><span class="hs-identifier hs-var">exp_pat_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-198"></a><span>             </span><span class="hs-identifier hs-var">Check</span><span> </span><a name="local-6989586621683211542"><a href="#local-6989586621683211542"><span class="hs-identifier">pat_ty</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcUnify.html#promoteTcType"><span class="hs-identifier hs-var">promoteTcType</span></a><span> </span><a href="#local-6989586621683211535"><span class="hs-identifier hs-var">bind_lvl</span></a><span> </span><a href="#local-6989586621683211542"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-199"></a><span>             </span><span class="hs-identifier hs-var">Infer</span><span> </span><a name="local-6989586621683211543"><a href="#local-6989586621683211543"><span class="hs-identifier">infer_res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">bind_lvl</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">ir_lvl</span><span> </span><span class="hs-identifier">infer_res</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>                                </span><span class="hs-comment">-- If we were under a constructor that bumped</span><span>
</span><a name="line-201"></a><span>                                </span><span class="hs-comment">-- the level, we'd be in checking mode</span><span>
</span><a name="line-202"></a><span>                                </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211544"><a href="#local-6989586621683211544"><span class="hs-identifier">bndr_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#inferResultToType"><span class="hs-identifier hs-var">inferResultToType</span></a><span> </span><a href="#local-6989586621683211543"><span class="hs-identifier hs-var">infer_res</span></a><span>
</span><a name="line-203"></a><span>                                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcNomReflCo</span><span> </span><a href="#local-6989586621683211544"><span class="hs-identifier hs-var">bndr_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211544"><span class="hs-identifier hs-var">bndr_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-204"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211547"><a href="#local-6989586621683211547"><span class="hs-identifier">bndr_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#newLetBndr"><span class="hs-identifier hs-var">newLetBndr</span></a><span> </span><a href="#local-6989586621683211537"><span class="hs-identifier hs-var">no_gen</span></a><span> </span><a href="#local-6989586621683211538"><span class="hs-identifier hs-var">bndr_name</span></a><span> </span><a href="#local-6989586621683211546"><span class="hs-identifier hs-var">bndr_ty</span></a><span>
</span><a name="line-205"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPatBndr(nosig)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211535"><span class="hs-identifier hs-var">bind_lvl</span></a><span>
</span><a name="line-206"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211539"><span class="hs-identifier hs-var">exp_pat_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211546"><span class="hs-identifier hs-var">bndr_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211545"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-207"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211547"><span class="hs-identifier hs-var">bndr_id</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpCastN</span><span> </span><a href="#local-6989586621683211545"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211547"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-identifier">tcPatBndr</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211548"><a href="#local-6989586621683211548"><span class="hs-identifier">bndr_name</span></a></a><span> </span><a name="local-6989586621683211549"><a href="#local-6989586621683211549"><span class="hs-identifier">pat_ty</span></a></a><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211550"><a href="#local-6989586621683211550"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683211549"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-212"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPatBndr(not let)&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211548"><span class="hs-identifier hs-var">bndr_name</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211550"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idHsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621683211548"><span class="hs-identifier hs-var">bndr_name</span></a><span> </span><a href="#local-6989586621683211550"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-214"></a><span>               </span><span class="hs-comment">-- Whether or not there is a sig is irrelevant,</span><span>
</span><a name="line-215"></a><span>               </span><span class="hs-comment">-- as this is local</span><span>
</span><a name="line-216"></a><span>
</span><a name="line-217"></a><span class="hs-identifier">newLetBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#LetBndrSpec"><span class="hs-identifier hs-type">LetBndrSpec</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcId</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- Make up a suitable Id for the pattern-binder.</span><span>
</span><a name="line-219"></a><span class="hs-comment">-- See Note [Typechecking pattern bindings], item (4) in TcBinds</span><span>
</span><a name="line-220"></a><span class="hs-comment">--</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- In the polymorphic case when we are going to generalise</span><span>
</span><a name="line-222"></a><span class="hs-comment">--    (plan InferGen, no_gen = LetLclBndr), generate a &quot;monomorphic version&quot;</span><span>
</span><a name="line-223"></a><span class="hs-comment">--    of the Id; the original name will be bound to the polymorphic version</span><span>
</span><a name="line-224"></a><span class="hs-comment">--    by the AbsBinds</span><span>
</span><a name="line-225"></a><span class="hs-comment">-- In the monomorphic case when we are not going to generalise</span><span>
</span><a name="line-226"></a><span class="hs-comment">--    (plan NoGen, no_gen = LetGblBndr) there is no AbsBinds,</span><span>
</span><a name="line-227"></a><span class="hs-comment">--    and we use the original name directly</span><span>
</span><a name="line-228"></a><a name="newLetBndr"><a href="TcPat.html#newLetBndr"><span class="hs-identifier">newLetBndr</span></a></a><span> </span><a href="TcPat.html#LetLclBndr"><span class="hs-identifier hs-var">LetLclBndr</span></a><span> </span><a name="local-6989586621683211551"><a href="#local-6989586621683211551"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683211552"><a href="#local-6989586621683211552"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211553"><a href="#local-6989586621683211553"><span class="hs-identifier">mono_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#cloneLocalName"><span class="hs-identifier hs-var">cloneLocalName</span></a><span> </span><a href="#local-6989586621683211551"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-230"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621683211553"><span class="hs-identifier hs-var">mono_name</span></a><span> </span><a href="#local-6989586621683211552"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-231"></a><span class="hs-identifier">newLetBndr</span><span> </span><span class="hs-special">(</span><a href="TcPat.html#LetGblBndr"><span class="hs-identifier hs-var">LetGblBndr</span></a><span> </span><a name="local-6989586621683211554"><a href="#local-6989586621683211554"><span class="hs-identifier">prags</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211555"><a href="#local-6989586621683211555"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683211556"><a href="#local-6989586621683211556"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-232"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcSigs.html#addInlinePrags"><span class="hs-identifier hs-var">addInlinePrags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLocalId</span><span> </span><a href="#local-6989586621683211555"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683211556"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcSigs.html#lookupPragEnv"><span class="hs-identifier hs-var">lookupPragEnv</span></a><span> </span><a href="#local-6989586621683211554"><span class="hs-identifier hs-var">prags</span></a><span> </span><a href="#local-6989586621683211555"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">tcSubTypePat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">HsWrapper</span><span>
</span><a name="line-235"></a><span class="hs-comment">-- tcSubTypeET with the UserTypeCtxt specialised to GenSigCtxt</span><span>
</span><a name="line-236"></a><span class="hs-comment">-- Used when typechecking patterns</span><span>
</span><a name="line-237"></a><a name="tcSubTypePat"><a href="TcPat.html#tcSubTypePat"><span class="hs-identifier">tcSubTypePat</span></a></a><span> </span><a name="local-6989586621683211557"><a href="#local-6989586621683211557"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211558"><a href="#local-6989586621683211558"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621683211559"><a href="#local-6989586621683211559"><span class="hs-identifier">t2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcUnify.html#tcSubTypeET"><span class="hs-identifier hs-var">tcSubTypeET</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pe_orig</span><span> </span><a href="#local-6989586621683211557"><span class="hs-identifier hs-var">penv</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">GenSigCtxt</span><span> </span><a href="#local-6989586621683211558"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621683211559"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-comment">{- Note [Subsumption check at pattern variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we come across a variable with a type signature, we need to do a
subsumption, not equality, check against the context type.  e.g.

    data T = MkT (forall a. a-&gt;a)
      f :: forall b. [b]-&gt;[b]
      MkT f = blah

Since 'blah' returns a value of type T, its payload is a polymorphic
function of type (forall a. a-&gt;a).  And that's enough to bind the
less-polymorphic function 'f', but we need some impedance matching
to witness the instantiation.


************************************************************************
*                                                                      *
                The main worker functions
*                                                                      *
************************************************************************

Note [Nesting]
~~~~~~~~~~~~~~
tcPat takes a &quot;thing inside&quot; over which the pattern scopes.  This is partly
so that tcPat can extend the environment for the thing_inside, but also
so that constraints arising in the thing_inside can be discharged by the
pattern.

This does not work so well for the ErrCtxt carried by the monad: we don't
want the error-context for the pattern to scope over the RHS.
Hence the getErrCtxt/setErrCtxt stuff in tcMultiple
-}</span><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-273"></a><span class="hs-keyword">type</span><span> </span><a name="Checker"><a href="TcPat.html#Checker"><span class="hs-identifier">Checker</span></a></a><span> </span><a name="local-6989586621683211495"><a href="#local-6989586621683211495"><span class="hs-identifier">inp</span></a></a><span> </span><a name="local-6989586621683211496"><a href="#local-6989586621683211496"><span class="hs-identifier">out</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621683211497"><a href="#local-6989586621683211497"><span class="hs-identifier">r</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-274"></a><span>                          </span><a href="#local-6989586621683211495"><span class="hs-identifier hs-type">inp</span></a><span>
</span><a name="line-275"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span>
</span><a name="line-276"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211497"><span class="hs-identifier hs-type">r</span></a><span>
</span><a name="line-277"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211496"><span class="hs-identifier hs-type">out</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211497"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-identifier">tcMultiple</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#Checker"><span class="hs-identifier hs-type">Checker</span></a><span> </span><a href="#local-6989586621683211507"><span class="hs-identifier hs-type">inp</span></a><span> </span><a href="#local-6989586621683211508"><span class="hs-identifier hs-type">out</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#Checker"><span class="hs-identifier hs-type">Checker</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683211507"><span class="hs-identifier hs-type">inp</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683211508"><span class="hs-identifier hs-type">out</span></a><span class="hs-special">]</span><span>
</span><a name="line-280"></a><a name="tcMultiple"><a href="TcPat.html#tcMultiple"><span class="hs-identifier">tcMultiple</span></a></a><span> </span><a name="local-6989586621683211560"><a href="#local-6989586621683211560"><span class="hs-identifier">tc_pat</span></a></a><span> </span><a name="local-6989586621683211561"><a href="#local-6989586621683211561"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621683211562"><a href="#local-6989586621683211562"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211563"><a href="#local-6989586621683211563"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-281"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211564"><a href="#local-6989586621683211564"><span class="hs-identifier">err_ctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getErrCtxt"><span class="hs-identifier hs-var">getErrCtxt</span></a><span>
</span><a name="line-282"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211565"><a href="#local-6989586621683211565"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-283"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211566"><a href="#local-6989586621683211566"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683211563"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-284"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211566"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-285"></a><span>
</span><a name="line-286"></a><span>              </span><span class="hs-identifier">loop</span><span> </span><a name="local-6989586621683211567"><a href="#local-6989586621683211567"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683211568"><a href="#local-6989586621683211568"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683211569"><a href="#local-6989586621683211569"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211570"><a href="#local-6989586621683211570"><span class="hs-identifier">p'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211571"><a href="#local-6989586621683211571"><span class="hs-identifier">ps'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211572"><a href="#local-6989586621683211572"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>                                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683211560"><span class="hs-identifier hs-var">tc_pat</span></a><span> </span><a href="#local-6989586621683211568"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621683211567"><span class="hs-identifier hs-var">penv</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-289"></a><span>                                   </span><a href="TcRnMonad.html#setErrCtxt"><span class="hs-identifier hs-var">setErrCtxt</span></a><span> </span><a href="#local-6989586621683211564"><span class="hs-identifier hs-var">err_ctxt</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-290"></a><span>                                   </span><a href="#local-6989586621683211565"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621683211567"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211569"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-291"></a><span>                </span><span class="hs-comment">-- setErrCtxt: restore context before doing the next pattern</span><span>
</span><a name="line-292"></a><span>                </span><span class="hs-comment">-- See note [Nesting] above</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span>                     </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211570"><span class="hs-identifier hs-var">p'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683211571"><span class="hs-identifier hs-var">ps'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211572"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683211565"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621683211562"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211561"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-299"></a><span class="hs-identifier">tc_lpat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-300"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>
</span><a name="line-301"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span>
</span><a name="line-302"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211506"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-303"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211506"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-304"></a><a name="tc_lpat"><a href="TcPat.html#tc_lpat"><span class="hs-identifier">tc_lpat</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211573"><a href="#local-6989586621683211573"><span class="hs-identifier">span</span></a></a><span> </span><a name="local-6989586621683211574"><a href="#local-6989586621683211574"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211575"><a href="#local-6989586621683211575"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211576"><a href="#local-6989586621683211576"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211577"><a href="#local-6989586621683211577"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-305"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683211573"><span class="hs-identifier hs-var">span</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211578"><a href="#local-6989586621683211578"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211579"><a href="#local-6989586621683211579"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#maybeWrapPatCtxt"><span class="hs-identifier hs-var">maybeWrapPatCtxt</span></a><span> </span><a href="#local-6989586621683211574"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#tc_pat"><span class="hs-identifier hs-var">tc_pat</span></a><span> </span><a href="#local-6989586621683211576"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211574"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683211575"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>                                          </span><a href="#local-6989586621683211577"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-308"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211573"><span class="hs-identifier hs-var">span</span></a><span> </span><a href="#local-6989586621683211578"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211579"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-identifier">tc_lpats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span>
</span><a name="line-311"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ExpSigmaType</span><span class="hs-special">]</span><span>
</span><a name="line-312"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211505"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-313"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211505"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-314"></a><a name="tc_lpats"><a href="TcPat.html#tc_lpats"><span class="hs-identifier">tc_lpats</span></a></a><span> </span><a name="local-6989586621683211580"><a href="#local-6989586621683211580"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211581"><a href="#local-6989586621683211581"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621683211582"><a href="#local-6989586621683211582"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621683211583"><a href="#local-6989586621683211583"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-315"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">pats</span><span> </span><span class="hs-identifier hs-var">tys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">pats</span><span> </span><a href="#local-6989586621683211582"><span class="hs-operator hs-var">$$</span></a><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">tys</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>    </span><a href="TcPat.html#tcMultiple"><span class="hs-identifier hs-var">tcMultiple</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621683211584"><a href="#local-6989586621683211584"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><a name="local-6989586621683211585"><a href="#local-6989586621683211585"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211584"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683211585"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;tc_lpats&quot;</span><span> </span><a href="#local-6989586621683211581"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621683211582"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-318"></a><span>                </span><a href="#local-6989586621683211580"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211583"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-comment">--------------------</span><span>
</span><a name="line-321"></a><span class="hs-identifier">tc_pat</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span>
</span><a name="line-322"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-323"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>  </span><span class="hs-comment">-- Fully refined result type</span><span>
</span><a name="line-324"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211504"><span class="hs-identifier hs-type">a</span></a><span>                </span><span class="hs-comment">-- Thing inside</span><span>
</span><a name="line-325"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Translated pattern</span><span>
</span><a name="line-326"></a><span>                </span><a href="#local-6989586621683211504"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- Result of thing inside</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><a name="tc_pat"><a href="TcPat.html#tc_pat"><span class="hs-identifier">tc_pat</span></a></a><span> </span><a name="local-6989586621683211586"><a href="#local-6989586621683211586"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><a name="local-6989586621683211587"><a href="#local-6989586621683211587"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211588"><a href="#local-6989586621683211588"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683211589"><a href="#local-6989586621683211589"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683211590"><a href="#local-6989586621683211590"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211591"><a href="#local-6989586621683211591"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-329"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211592"><a href="#local-6989586621683211592"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211593"><a href="#local-6989586621683211593"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcPatBndr"><span class="hs-identifier hs-var">tcPatBndr</span></a><span> </span><a href="#local-6989586621683211586"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211589"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683211590"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-330"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211594"><a href="#local-6989586621683211594"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendIdEnv1"><span class="hs-identifier hs-var">tcExtendIdEnv1</span></a><span> </span><a href="#local-6989586621683211589"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683211593"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621683211591"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-331"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211595"><a href="#local-6989586621683211595"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211590"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-332"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211592"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><a href="#local-6989586621683211587"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211588"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683211593"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211595"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211594"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211596"><a href="#local-6989586621683211596"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><a name="local-6989586621683211597"><a href="#local-6989586621683211597"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683211598"><a href="#local-6989586621683211598"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211599"><a href="#local-6989586621683211599"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211600"><a href="#local-6989586621683211600"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-335"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211601"><a href="#local-6989586621683211601"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211602"><a href="#local-6989586621683211602"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211598"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683211599"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211596"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211600"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-336"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><a href="#local-6989586621683211597"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683211601"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211602"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211603"><a href="#local-6989586621683211603"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><a name="local-6989586621683211604"><a href="#local-6989586621683211604"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683211605"><a href="#local-6989586621683211605"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211606"><a href="#local-6989586621683211606"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211607"><a href="#local-6989586621683211607"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-339"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211608"><a href="#local-6989586621683211608"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211609"><a href="#local-6989586621683211609"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211605"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683211606"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211603"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211607"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-340"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BangPat</span><span> </span><a href="#local-6989586621683211604"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683211608"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211609"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211610"><a href="#local-6989586621683211610"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LazyPat</span><span> </span><a name="local-6989586621683211611"><a href="#local-6989586621683211611"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683211612"><a href="#local-6989586621683211612"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211613"><a href="#local-6989586621683211613"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211614"><a href="#local-6989586621683211614"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-343"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211615"><a href="#local-6989586621683211615"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211616"><a href="#local-6989586621683211616"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211617"><a href="#local-6989586621683211617"><span class="hs-identifier">pat_ct</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211612"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683211613"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#makeLazy"><span class="hs-identifier hs-var">makeLazy</span></a><span> </span><a href="#local-6989586621683211610"><span class="hs-identifier hs-var">penv</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-345"></a><span>                   </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><a href="#local-6989586621683211614"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-346"></a><span>                </span><span class="hs-comment">-- Ignore refined penv', revert to penv</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#emitConstraints"><span class="hs-identifier hs-var">emitConstraints</span></a><span> </span><a href="#local-6989586621683211617"><span class="hs-identifier hs-var">pat_ct</span></a><span>
</span><a name="line-349"></a><span>        </span><span class="hs-comment">-- captureConstraints/extendConstraints:</span><span>
</span><a name="line-350"></a><span>        </span><span class="hs-comment">--   see Note [Hopping the LIE in lazy patterns]</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span>        </span><span class="hs-comment">-- Check that the expected pattern type is itself lifted</span><span>
</span><a name="line-353"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211618"><a href="#local-6989586621683211618"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211613"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-354"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621683211618"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LazyPat</span><span> </span><a href="#local-6989586621683211611"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683211615"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211616"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span class="hs-identifier">tc_pat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WildPat</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683211619"><a href="#local-6989586621683211619"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211620"><a href="#local-6989586621683211620"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-359"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211621"><a href="#local-6989586621683211621"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683211620"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-360"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211622"><a href="#local-6989586621683211622"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683211619"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-361"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">WildPat</span><span> </span><a href="#local-6989586621683211622"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211621"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211623"><a href="#local-6989586621683211623"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AsPat</span><span> </span><a name="local-6989586621683211624"><a href="#local-6989586621683211624"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211625"><a href="#local-6989586621683211625"><span class="hs-identifier">nm_loc</span></a></a><span> </span><a name="local-6989586621683211626"><a href="#local-6989586621683211626"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211627"><a href="#local-6989586621683211627"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211628"><a href="#local-6989586621683211628"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211629"><a href="#local-6989586621683211629"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-364"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211630"><a href="#local-6989586621683211630"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211631"><a href="#local-6989586621683211631"><span class="hs-identifier">bndr_id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683211625"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#tcPatBndr"><span class="hs-identifier hs-var">tcPatBndr</span></a><span> </span><a href="#local-6989586621683211623"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211626"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683211628"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211632"><a href="#local-6989586621683211632"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211633"><a href="#local-6989586621683211633"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendIdEnv1"><span class="hs-identifier hs-var">tcExtendIdEnv1</span></a><span> </span><a href="#local-6989586621683211626"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683211631"><span class="hs-identifier hs-var">bndr_id</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-366"></a><span>                         </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211627"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683211631"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-367"></a><span>                                 </span><a href="#local-6989586621683211623"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211629"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-368"></a><span>            </span><span class="hs-comment">-- NB: if we do inference on:</span><span>
</span><a name="line-369"></a><span>            </span><span class="hs-comment">--          \ (y@(x::forall a. a-&gt;a)) = e</span><span>
</span><a name="line-370"></a><span>            </span><span class="hs-comment">-- we'll fail.  The as-pattern infers a monotype for 'y', which then</span><span>
</span><a name="line-371"></a><span>            </span><span class="hs-comment">-- fails to unify with the polymorphic type for 'x'.  This could</span><span>
</span><a name="line-372"></a><span>            </span><span class="hs-comment">-- perhaps be fixed, but only with a bit more work.</span><span>
</span><a name="line-373"></a><span>            </span><span class="hs-comment">--</span><span>
</span><a name="line-374"></a><span>            </span><span class="hs-comment">-- If you fix it, don't forget the bindInstsOfPatIds!</span><span>
</span><a name="line-375"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211634"><a href="#local-6989586621683211634"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211628"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-376"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211630"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AsPat</span><span> </span><a href="#local-6989586621683211624"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211625"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683211631"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211632"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211634"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span>
</span><a name="line-377"></a><span>                  </span><a href="#local-6989586621683211633"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211635"><a href="#local-6989586621683211635"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ViewPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211636"><a href="#local-6989586621683211636"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683211637"><a href="#local-6989586621683211637"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211638"><a href="#local-6989586621683211638"><span class="hs-identifier">overall_pat_ty</span></a></a><span> </span><a name="local-6989586621683211639"><a href="#local-6989586621683211639"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-380"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span>
</span><a name="line-381"></a><span>         </span><span class="hs-comment">-- Expr must have type `forall a1...aN. OPT' -&gt; B`</span><span>
</span><a name="line-382"></a><span>         </span><span class="hs-comment">-- where overall_pat_ty is an instance of OPT'.</span><span>
</span><a name="line-383"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211640"><a href="#local-6989586621683211640"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">,</span><a name="local-6989586621683211641"><a href="#local-6989586621683211641"><span class="hs-identifier">expr'_inferred</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span> </span><a href="#local-6989586621683211636"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span>         </span><span class="hs-comment">-- expression must be a function</span><span>
</span><a name="line-386"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211642"><a href="#local-6989586621683211642"><span class="hs-identifier">expr_orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lexprCtOrigin</span><span> </span><a href="#local-6989586621683211636"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-387"></a><span>              </span><a name="local-6989586621683211643"><a href="#local-6989586621683211643"><span class="hs-identifier">herald</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;A view pattern expression expects&quot;</span><span>
</span><a name="line-388"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211644"><a href="#local-6989586621683211644"><span class="hs-identifier">expr_wrap1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683211645"><a href="#local-6989586621683211645"><span class="hs-identifier">inf_arg_ty</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683211646"><a href="#local-6989586621683211646"><span class="hs-identifier">inf_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-389"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchActualFunTys"><span class="hs-identifier hs-var">matchActualFunTys</span></a><span> </span><a href="#local-6989586621683211643"><span class="hs-identifier hs-var">herald</span></a><span> </span><a href="#local-6989586621683211642"><span class="hs-identifier hs-var">expr_orig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683211636"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621683211641"><span class="hs-identifier hs-var">expr'_inferred</span></a><span>
</span><a name="line-390"></a><span>            </span><span class="hs-comment">-- expr_wrap1 :: expr'_inferred &quot;-&gt;&quot; (inf_arg_ty -&gt; inf_res_ty)</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span>         </span><span class="hs-comment">-- check that overall pattern is more polymorphic than arg type</span><span>
</span><a name="line-393"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211647"><a href="#local-6989586621683211647"><span class="hs-identifier">expr_wrap2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcSubTypePat"><span class="hs-identifier hs-var">tcSubTypePat</span></a><span> </span><a href="#local-6989586621683211635"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211638"><span class="hs-identifier hs-var">overall_pat_ty</span></a><span> </span><a href="#local-6989586621683211645"><span class="hs-identifier hs-var">inf_arg_ty</span></a><span>
</span><a name="line-394"></a><span>            </span><span class="hs-comment">-- expr_wrap2 :: overall_pat_ty &quot;-&gt;&quot; inf_arg_ty</span><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span>         </span><span class="hs-comment">-- pattern must have inf_res_ty</span><span>
</span><a name="line-397"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211648"><a href="#local-6989586621683211648"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211649"><a href="#local-6989586621683211649"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211637"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211646"><span class="hs-identifier hs-var">inf_res_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211635"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211639"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-398"></a><span>
</span><a name="line-399"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211650"><a href="#local-6989586621683211650"><span class="hs-identifier">overall_pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211638"><span class="hs-identifier hs-var">overall_pat_ty</span></a><span>
</span><a name="line-400"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211651"><a href="#local-6989586621683211651"><span class="hs-identifier">expr_wrap2'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWpFun</span><span> </span><a href="#local-6989586621683211647"><span class="hs-identifier hs-var">expr_wrap2</span></a><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span>
</span><a name="line-401"></a><span>                                    </span><a href="#local-6989586621683211650"><span class="hs-identifier hs-var">overall_pat_ty</span></a><span> </span><a href="#local-6989586621683211646"><span class="hs-identifier hs-var">inf_res_ty</span></a><span> </span><a href="#local-6989586621683211653"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-402"></a><span>               </span><span class="hs-comment">-- expr_wrap2' :: (inf_arg_ty -&gt; inf_res_ty) &quot;-&gt;&quot;</span><span>
</span><a name="line-403"></a><span>               </span><span class="hs-comment">--                (overall_pat_ty -&gt; inf_res_ty)</span><span>
</span><a name="line-404"></a><span>              </span><a name="local-6989586621683211652"><a href="#local-6989586621683211652"><span class="hs-identifier">expr_wrap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211651"><span class="hs-identifier hs-var">expr_wrap2'</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683211644"><span class="hs-identifier hs-var">expr_wrap1</span></a><span>
</span><a name="line-405"></a><span>              </span><a name="local-6989586621683211653"><a href="#local-6989586621683211653"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When checking the view pattern function:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211636"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-406"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ViewPat</span><span> </span><a href="#local-6989586621683211650"><span class="hs-identifier hs-var">overall_pat_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683211652"><span class="hs-identifier hs-var">expr_wrap</span></a><span> </span><a href="#local-6989586621683211640"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211648"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211649"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span class="hs-comment">-- Type signatures in patterns</span><span>
</span><a name="line-409"></a><span class="hs-comment">-- See Note [Pattern coercions] below</span><span>
</span><a name="line-410"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211654"><a href="#local-6989586621683211654"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211655"><a href="#local-6989586621683211655"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683211656"><a href="#local-6989586621683211656"><span class="hs-identifier">sig_ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211657"><a href="#local-6989586621683211657"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211658"><a href="#local-6989586621683211658"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-411"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211659"><a href="#local-6989586621683211659"><span class="hs-identifier">inner_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211660"><a href="#local-6989586621683211660"><span class="hs-identifier">tv_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211661"><a href="#local-6989586621683211661"><span class="hs-identifier">wcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211662"><a href="#local-6989586621683211662"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcPatSig"><span class="hs-identifier hs-var">tcPatSig</span></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#inPatBind"><span class="hs-identifier hs-var">inPatBind</span></a><span> </span><a href="#local-6989586621683211654"><span class="hs-identifier hs-var">penv</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>                                                            </span><a href="#local-6989586621683211656"><span class="hs-identifier hs-var">sig_ty</span></a><span> </span><a href="#local-6989586621683211657"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-413"></a><span>                </span><span class="hs-comment">-- Using tcExtendNameTyVarEnv is appropriate here</span><span>
</span><a name="line-414"></a><span>                </span><span class="hs-comment">-- because we're not really bringing fresh tyvars into scope.</span><span>
</span><a name="line-415"></a><span>                </span><span class="hs-comment">-- We're *naming* existing tyvars. Note that it is OK for a tyvar</span><span>
</span><a name="line-416"></a><span>                </span><span class="hs-comment">-- from an outer scope to mention one of these tyvars in its kind.</span><span>
</span><a name="line-417"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211663"><a href="#local-6989586621683211663"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211664"><a href="#local-6989586621683211664"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><a href="#local-6989586621683211661"><span class="hs-identifier hs-var">wcs</span></a><span>      </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-418"></a><span>                         </span><a href="TcEnv.html#tcExtendNameTyVarEnv"><span class="hs-identifier hs-var">tcExtendNameTyVarEnv</span></a><span> </span><a href="#local-6989586621683211660"><span class="hs-identifier hs-var">tv_binds</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-419"></a><span>                         </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211655"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211659"><span class="hs-identifier hs-var">inner_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211654"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211658"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-420"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211665"><a href="#local-6989586621683211665"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211657"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-421"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211662"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SigPat</span><span> </span><a href="#local-6989586621683211659"><span class="hs-identifier hs-var">inner_ty</span></a><span> </span><a href="#local-6989586621683211663"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683211656"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211665"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211664"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-424"></a><span class="hs-comment">-- Lists, tuples, arrays</span><span>
</span><a name="line-425"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211666"><a href="#local-6989586621683211666"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621683211667"><a href="#local-6989586621683211667"><span class="hs-identifier">pats</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211668"><a href="#local-6989586621683211668"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211669"><a href="#local-6989586621683211669"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-426"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211670"><a href="#local-6989586621683211670"><span class="hs-identifier">coi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211671"><a href="#local-6989586621683211671"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#matchExpectedPatTy"><span class="hs-identifier hs-var">matchExpectedPatTy</span></a><span> </span><a href="TcUnify.html#matchExpectedListTy"><span class="hs-identifier hs-var">matchExpectedListTy</span></a><span> </span><a href="#local-6989586621683211666"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211668"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-427"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211673"><a href="#local-6989586621683211673"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211674"><a href="#local-6989586621683211674"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcMultiple"><span class="hs-identifier hs-var">tcMultiple</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683211672"><a href="#local-6989586621683211672"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211672"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211671"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span>                                     </span><a href="#local-6989586621683211667"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621683211666"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211669"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-429"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211675"><a href="#local-6989586621683211675"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211668"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-430"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211670"><span class="hs-identifier hs-var">coi</span></a><span>
</span><a name="line-431"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPatTc</span><span> </span><a href="#local-6989586621683211671"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211673"><span class="hs-identifier hs-var">pats'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211675"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211674"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span class="hs-special">}</span><span>
</span><a name="line-433"></a><span>
</span><a name="line-434"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211676"><a href="#local-6989586621683211676"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683211677"><a href="#local-6989586621683211677"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211678"><a href="#local-6989586621683211678"><span class="hs-identifier">pats</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211679"><a href="#local-6989586621683211679"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211680"><a href="#local-6989586621683211680"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211681"><a href="#local-6989586621683211681"><span class="hs-identifier">tau_pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683211679"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-436"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683211686"><a href="#local-6989586621683211686"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211687"><a href="#local-6989586621683211687"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211688"><a href="#local-6989586621683211688"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683211689"><a href="#local-6989586621683211689"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOpGen"><span class="hs-identifier hs-var">tcSyntaxOpGen</span></a><span> </span><span class="hs-identifier hs-var">ListOrigin</span><span> </span><a href="#local-6989586621683211677"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211681"><span class="hs-identifier hs-var">tau_pat_ty</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-438"></a><span>                                          </span><span class="hs-identifier hs-var">SynList</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-439"></a><span>                 </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683211682"><a href="#local-6989586621683211682"><span class="hs-identifier">elt_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-440"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211684"><a href="#local-6989586621683211684"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211685"><a href="#local-6989586621683211685"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcMultiple"><span class="hs-identifier hs-var">tcMultiple</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683211683"><a href="#local-6989586621683211683"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211683"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211682"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-441"></a><span>                                                 </span><a href="#local-6989586621683211678"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621683211676"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211680"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-442"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211684"><span class="hs-identifier hs-var">pats'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211685"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211682"><span class="hs-identifier hs-var">elt_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-443"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ListPatTc</span><span> </span><a href="#local-6989586621683211688"><span class="hs-identifier hs-var">elt_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211681"><span class="hs-identifier hs-var">tau_pat_ty</span></a><span class="hs-special">,</span><a href="#local-6989586621683211689"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211686"><span class="hs-identifier hs-var">pats'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211687"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-444"></a><span class="hs-special">}</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211690"><a href="#local-6989586621683211690"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TuplePat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211691"><a href="#local-6989586621683211691"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621683211692"><a href="#local-6989586621683211692"><span class="hs-identifier">boxity</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211693"><a href="#local-6989586621683211693"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211694"><a href="#local-6989586621683211694"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-447"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211695"><a href="#local-6989586621683211695"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683211691"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-448"></a><span>              </span><a name="local-6989586621683211696"><a href="#local-6989586621683211696"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tupleTyCon</span><span> </span><a href="#local-6989586621683211692"><span class="hs-identifier hs-var">boxity</span></a><span> </span><a href="#local-6989586621683211695"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-449"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211697"><a href="#local-6989586621683211697"><span class="hs-identifier">coi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211698"><a href="#local-6989586621683211698"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#matchExpectedPatTy"><span class="hs-identifier hs-var">matchExpectedPatTy</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a><span> </span><a href="#local-6989586621683211696"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>                                               </span><a href="#local-6989586621683211690"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211693"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-451"></a><span>                     </span><span class="hs-comment">-- Unboxed tuples have RuntimeRep vars, which we discard:</span><span>
</span><a name="line-452"></a><span>                     </span><span class="hs-comment">-- See Note [Unboxed tuple RuntimeRep vars] in TyCon</span><span>
</span><a name="line-453"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211699"><a href="#local-6989586621683211699"><span class="hs-identifier">con_arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683211692"><span class="hs-identifier hs-var">boxity</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-identifier hs-var">Unboxed</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621683211695"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621683211698"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-454"></a><span>                                           </span><span class="hs-identifier hs-var">Boxed</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683211698"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-455"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211700"><a href="#local-6989586621683211700"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211701"><a href="#local-6989586621683211701"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tc_lpats"><span class="hs-identifier hs-var">tc_lpats</span></a><span> </span><a href="#local-6989586621683211690"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211691"><span class="hs-identifier hs-var">pats</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211699"><span class="hs-identifier hs-var">con_arg_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>                                   </span><a href="#local-6989586621683211694"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-457"></a><span>
</span><a name="line-458"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211702"><a href="#local-6989586621683211702"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span>        </span><span class="hs-comment">-- Under flag control turn a pattern (x,y,z) into ~(x,y,z)</span><span>
</span><a name="line-461"></a><span>        </span><span class="hs-comment">-- so that we can experiment with lazy tuple-matching.</span><span>
</span><a name="line-462"></a><span>        </span><span class="hs-comment">-- This is a pretty odd place to make the switch, but</span><span>
</span><a name="line-463"></a><span>        </span><span class="hs-comment">-- it was easy to do.</span><span>
</span><a name="line-464"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-465"></a><span>              </span><a name="local-6989586621683211703"><a href="#local-6989586621683211703"><span class="hs-identifier">unmangled_result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">TuplePat</span><span> </span><a href="#local-6989586621683211699"><span class="hs-identifier hs-var">con_arg_tys</span></a><span> </span><a href="#local-6989586621683211700"><span class="hs-identifier hs-var">pats'</span></a><span> </span><a href="#local-6989586621683211692"><span class="hs-identifier hs-var">boxity</span></a><span>
</span><a name="line-466"></a><span>                                 </span><span class="hs-comment">-- pat_ty /= pat_ty iff coi /= IdCo</span><span>
</span><a name="line-467"></a><span>              </span><a name="local-6989586621683211704"><a href="#local-6989586621683211704"><span class="hs-identifier">possibly_mangled_result</span></a></a><span>
</span><a name="line-468"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">gopt</span><span> </span><span class="hs-identifier hs-var">Opt_IrrefutableTuples</span><span> </span><a href="#local-6989586621683211702"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-469"></a><span>                  </span><span class="hs-identifier hs-var">isBoxed</span><span> </span><a href="#local-6989586621683211692"><span class="hs-identifier hs-var">boxity</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LazyPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683211703"><span class="hs-identifier hs-var">unmangled_result</span></a><span class="hs-special">)</span><span>
</span><a name="line-470"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211703"><span class="hs-identifier hs-var">unmangled_result</span></a><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211705"><a href="#local-6989586621683211705"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211693"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-473"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">con_arg_tys</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">pats</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Syntactically enforced</span><span>
</span><a name="line-474"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211697"><span class="hs-identifier hs-var">coi</span></a><span> </span><a href="#local-6989586621683211704"><span class="hs-identifier hs-var">possibly_mangled_result</span></a><span> </span><a href="#local-6989586621683211705"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211701"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211706"><a href="#local-6989586621683211706"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SumPat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211707"><a href="#local-6989586621683211707"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683211708"><a href="#local-6989586621683211708"><span class="hs-identifier">alt</span></a></a><span> </span><a name="local-6989586621683211709"><a href="#local-6989586621683211709"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-special">)</span><span> </span><a name="local-6989586621683211710"><a href="#local-6989586621683211710"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211711"><a href="#local-6989586621683211711"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-478"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211712"><a href="#local-6989586621683211712"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sumTyCon</span><span> </span><a href="#local-6989586621683211709"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-479"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211713"><a href="#local-6989586621683211713"><span class="hs-identifier">coi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211714"><a href="#local-6989586621683211714"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#matchExpectedPatTy"><span class="hs-identifier hs-var">matchExpectedPatTy</span></a><span> </span><span class="hs-special">(</span><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a><span> </span><a href="#local-6989586621683211712"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-480"></a><span>                                               </span><a href="#local-6989586621683211706"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211710"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-481"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- Drop levity vars, we don't care about them here</span><span>
</span><a name="line-482"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211715"><a href="#local-6989586621683211715"><span class="hs-identifier">con_arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621683211709"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621683211714"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-483"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211716"><a href="#local-6989586621683211716"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211717"><a href="#local-6989586621683211717"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211707"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211715"><span class="hs-identifier hs-var">con_arg_tys</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">getNth</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211708"><span class="hs-identifier hs-var">alt</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-484"></a><span>                                 </span><a href="#local-6989586621683211706"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211711"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-485"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211718"><a href="#local-6989586621683211718"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211710"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-486"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211713"><span class="hs-identifier hs-var">coi</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SumPat</span><span> </span><a href="#local-6989586621683211715"><span class="hs-identifier hs-var">con_arg_tys</span></a><span> </span><a href="#local-6989586621683211716"><span class="hs-identifier hs-var">pat'</span></a><span> </span><a href="#local-6989586621683211708"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621683211709"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211718"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-487"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211717"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-488"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-491"></a><span class="hs-comment">-- Data constructors</span><span>
</span><a name="line-492"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211719"><a href="#local-6989586621683211719"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConPatIn</span><span> </span><a name="local-6989586621683211720"><a href="#local-6989586621683211720"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621683211721"><a href="#local-6989586621683211721"><span class="hs-identifier">arg_pats</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211722"><a href="#local-6989586621683211722"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211723"><a href="#local-6989586621683211723"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-493"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#tcConPat"><span class="hs-identifier hs-var">tcConPat</span></a><span> </span><a href="#local-6989586621683211719"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211720"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621683211722"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211721"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><a href="#local-6989586621683211723"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-496"></a><span class="hs-comment">-- Literal patterns</span><span>
</span><a name="line-497"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211724"><a href="#local-6989586621683211724"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitPat</span><span> </span><a name="local-6989586621683211725"><a href="#local-6989586621683211725"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621683211726"><a href="#local-6989586621683211726"><span class="hs-identifier">simple_lit</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211727"><a href="#local-6989586621683211727"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211728"><a href="#local-6989586621683211728"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-498"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211729"><a href="#local-6989586621683211729"><span class="hs-identifier">lit_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcHsSyn.html#hsLitType"><span class="hs-identifier hs-var">hsLitType</span></a><span> </span><a href="#local-6989586621683211726"><span class="hs-identifier hs-var">simple_lit</span></a><span>
</span><a name="line-499"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211730"><a href="#local-6989586621683211730"><span class="hs-identifier">wrap</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcSubTypePat"><span class="hs-identifier hs-var">tcSubTypePat</span></a><span> </span><a href="#local-6989586621683211724"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211727"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211729"><span class="hs-identifier hs-var">lit_ty</span></a><span>
</span><a name="line-500"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211731"><a href="#local-6989586621683211731"><span class="hs-identifier">res</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683211728"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-501"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211732"><a href="#local-6989586621683211732"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211727"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-502"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211730"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LitPat</span><span> </span><a href="#local-6989586621683211725"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">convertLit</span><span> </span><a href="#local-6989586621683211726"><span class="hs-identifier hs-var">simple_lit</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211732"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-503"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211731"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span class="hs-comment">------------------------</span><span>
</span><a name="line-506"></a><span class="hs-comment">-- Overloaded patterns: n, and n+k</span><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- In the case of a negative literal (the more complicated case),</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- we get</span><span>
</span><a name="line-510"></a><span class="hs-comment">--</span><span>
</span><a name="line-511"></a><span class="hs-comment">--   case v of (-5) -&gt; blah</span><span>
</span><a name="line-512"></a><span class="hs-comment">--</span><span>
</span><a name="line-513"></a><span class="hs-comment">-- becoming</span><span>
</span><a name="line-514"></a><span class="hs-comment">--</span><span>
</span><a name="line-515"></a><span class="hs-comment">--   if v == (negate (fromInteger 5)) then blah else ...</span><span>
</span><a name="line-516"></a><span class="hs-comment">--</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- There are two bits of rebindable syntax:</span><span>
</span><a name="line-518"></a><span class="hs-comment">--   (==)   :: pat_ty -&gt; neg_lit_ty -&gt; Bool</span><span>
</span><a name="line-519"></a><span class="hs-comment">--   negate :: lit_ty -&gt; neg_lit_ty</span><span>
</span><a name="line-520"></a><span class="hs-comment">-- where lit_ty is the type of the overloaded literal 5.</span><span>
</span><a name="line-521"></a><span class="hs-comment">--</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- When there is no negation, neg_lit_ty and lit_ty are the same</span><span>
</span><a name="line-523"></a><span class="hs-identifier">tc_pat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211733"><a href="#local-6989586621683211733"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621683211734"><a href="#local-6989586621683211734"><span class="hs-identifier">over_lit</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211735"><a href="#local-6989586621683211735"><span class="hs-identifier">mb_neg</span></a></a><span> </span><a name="local-6989586621683211736"><a href="#local-6989586621683211736"><span class="hs-identifier">eq</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211737"><a href="#local-6989586621683211737"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211738"><a href="#local-6989586621683211738"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-524"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211739"><a href="#local-6989586621683211739"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LiteralOrigin</span><span> </span><a href="#local-6989586621683211734"><span class="hs-identifier hs-var">over_lit</span></a><span>
</span><a name="line-525"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683211745"><a href="#local-6989586621683211745"><span class="hs-identifier">lit'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211746"><a href="#local-6989586621683211746"><span class="hs-identifier">mb_neg'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683211747"><a href="#local-6989586621683211747"><span class="hs-identifier">eq'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><a href="#local-6989586621683211739"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683211736"><span class="hs-identifier hs-var">eq</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynType</span><span> </span><a href="#local-6989586621683211737"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynAny</span><span class="hs-special">]</span><span>
</span><a name="line-527"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-identifier hs-var">boolTy</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-528"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683211740"><a href="#local-6989586621683211740"><span class="hs-identifier">neg_lit_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-529"></a><span>               </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211741"><a href="#local-6989586621683211741"><span class="hs-identifier">new_over_lit</span></a></a><span> </span><a name="local-6989586621683211742"><a href="#local-6989586621683211742"><span class="hs-identifier">lit_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#newOverloadedLit"><span class="hs-identifier hs-var">newOverloadedLit</span></a><span> </span><a href="#local-6989586621683211734"><span class="hs-identifier hs-var">over_lit</span></a><span>
</span><a name="line-530"></a><span>                                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211742"><span class="hs-identifier hs-var">lit_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683211735"><span class="hs-identifier hs-var">mb_neg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-532"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621683211741"><span class="hs-identifier hs-var">new_over_lit</span></a><span> </span><a href="#local-6989586621683211740"><span class="hs-identifier hs-var">neg_lit_ty</span></a><span>
</span><a name="line-533"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683211743"><a href="#local-6989586621683211743"><span class="hs-identifier">neg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- Negative literal</span><span>
</span><a name="line-534"></a><span>                             </span><span class="hs-comment">-- The 'negate' is re-mappable syntax</span><span>
</span><a name="line-535"></a><span>                   </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span>
</span><a name="line-536"></a><span>                   </span><span class="hs-special">(</span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><a href="#local-6989586621683211739"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683211743"><span class="hs-identifier hs-var">neg</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211740"><span class="hs-identifier hs-var">neg_lit_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-537"></a><span>                    </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683211744"><a href="#local-6989586621683211744"><span class="hs-identifier">lit_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683211741"><span class="hs-identifier hs-var">new_over_lit</span></a><span> </span><a href="#local-6989586621683211744"><span class="hs-identifier hs-var">lit_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211748"><a href="#local-6989586621683211748"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683211738"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-540"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211749"><a href="#local-6989586621683211749"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211737"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-541"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NPat</span><span> </span><a href="#local-6989586621683211749"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211733"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621683211745"><span class="hs-identifier hs-var">lit'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211746"><span class="hs-identifier hs-var">mb_neg'</span></a><span> </span><a href="#local-6989586621683211747"><span class="hs-identifier hs-var">eq'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211748"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">{-
Note [NPlusK patterns]
~~~~~~~~~~~~~~~~~~~~~~
From

  case v of x + 5 -&gt; blah

we get

  if v &gt;= 5 then (\x -&gt; blah) (v - 5) else ...

There are two bits of rebindable syntax:
  (&gt;=) :: pat_ty -&gt; lit1_ty -&gt; Bool
  (-)  :: pat_ty -&gt; lit2_ty -&gt; var_ty

lit1_ty and lit2_ty could conceivably be different.
var_ty is the type inferred for x, the variable in the pattern.

If the pushed-down pattern type isn't a tau-type, the two pat_ty's above
could conceivably be different specializations. But this is very much
like the situation in Note [Case branches must be taus] in TcMatches.
So we tauify the pat_ty before proceeding.

Note that we need to type-check the literal twice, because it is used
twice, and may be used at different types. The second HsOverLit stored in the
AST is used for the subtraction operation.
-}</span><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span class="hs-comment">-- See Note [NPlusK patterns]</span><span>
</span><a name="line-572"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211750"><a href="#local-6989586621683211750"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NPlusKPat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211751"><a href="#local-6989586621683211751"><span class="hs-identifier">nm_loc</span></a></a><span> </span><a name="local-6989586621683211752"><a href="#local-6989586621683211752"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211753"><a href="#local-6989586621683211753"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683211754"><a href="#local-6989586621683211754"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211755"><a href="#local-6989586621683211755"><span class="hs-identifier">ge</span></a></a><span> </span><a name="local-6989586621683211756"><a href="#local-6989586621683211756"><span class="hs-identifier">minus</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211757"><a href="#local-6989586621683211757"><span class="hs-identifier">pat_ty</span></a></a><span>
</span><a name="line-574"></a><span>              </span><a name="local-6989586621683211758"><a href="#local-6989586621683211758"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-575"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211759"><a href="#local-6989586621683211759"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683211757"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-576"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211760"><a href="#local-6989586621683211760"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LiteralOrigin</span><span> </span><a href="#local-6989586621683211754"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-577"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211762"><a href="#local-6989586621683211762"><span class="hs-identifier">lit1'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211763"><a href="#local-6989586621683211763"><span class="hs-identifier">ge'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-578"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOp"><span class="hs-identifier hs-var">tcSyntaxOp</span></a><span> </span><a href="#local-6989586621683211760"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683211755"><span class="hs-identifier hs-var">ge</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683211759"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span>
</span><a name="line-579"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><span class="hs-identifier hs-var">boolTy</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-580"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683211761"><a href="#local-6989586621683211761"><span class="hs-identifier">lit1_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-581"></a><span>               </span><a href="Inst.html#newOverloadedLit"><span class="hs-identifier hs-var">newOverloadedLit</span></a><span> </span><a href="#local-6989586621683211754"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211761"><span class="hs-identifier hs-var">lit1_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683211769"><a href="#local-6989586621683211769"><span class="hs-identifier">lit2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211770"><a href="#local-6989586621683211770"><span class="hs-identifier">minus_wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211771"><a href="#local-6989586621683211771"><span class="hs-identifier">bndr_id</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683211772"><a href="#local-6989586621683211772"><span class="hs-identifier">minus'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcSyntaxOpGen"><span class="hs-identifier hs-var">tcSyntaxOpGen</span></a><span> </span><a href="#local-6989586621683211760"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683211756"><span class="hs-identifier hs-var">minus</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">synKnownType</span><span> </span><a href="#local-6989586621683211759"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">SynRho</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">SynAny</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-584"></a><span>               </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683211764"><a href="#local-6989586621683211764"><span class="hs-identifier">lit2_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211765"><a href="#local-6989586621683211765"><span class="hs-identifier">var_ty</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-585"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211766"><a href="#local-6989586621683211766"><span class="hs-identifier">lit2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#newOverloadedLit"><span class="hs-identifier hs-var">newOverloadedLit</span></a><span> </span><a href="#local-6989586621683211754"><span class="hs-identifier hs-var">lit</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211764"><span class="hs-identifier hs-var">lit2_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211767"><a href="#local-6989586621683211767"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211768"><a href="#local-6989586621683211768"><span class="hs-identifier">bndr_id</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683211751"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-587"></a><span>                                     </span><a href="TcPat.html#tcPatBndr"><span class="hs-identifier hs-var">tcPatBndr</span></a><span> </span><a href="#local-6989586621683211750"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211752"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211765"><span class="hs-identifier hs-var">var_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-588"></a><span>                           </span><span class="hs-comment">-- co :: var_ty ~ idType bndr_id</span><span>
</span><a name="line-589"></a><span>
</span><a name="line-590"></a><span>                           </span><span class="hs-comment">-- minus_wrap is applicable to minus'</span><span>
</span><a name="line-591"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211766"><span class="hs-identifier hs-var">lit2'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211767"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211768"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span>        </span><span class="hs-comment">-- The Report says that n+k patterns must be in Integral</span><span>
</span><a name="line-594"></a><span>        </span><span class="hs-comment">-- but it's silly to insist on this in the RebindableSyntax case</span><span>
</span><a name="line-595"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unlessM</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.RebindableSyntax</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-596"></a><span>          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211773"><a href="#local-6989586621683211773"><span class="hs-identifier">icls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><span class="hs-identifier hs-var">integralClassName</span><span>
</span><a name="line-597"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="Inst.html#instStupidTheta"><span class="hs-identifier hs-var">instStupidTheta</span></a><span> </span><a href="#local-6989586621683211760"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkClassPred</span><span> </span><a href="#local-6989586621683211773"><span class="hs-identifier hs-var">icls</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683211759"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211774"><a href="#local-6989586621683211774"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendIdEnv1"><span class="hs-identifier hs-var">tcExtendIdEnv1</span></a><span> </span><a href="#local-6989586621683211752"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683211771"><span class="hs-identifier hs-var">bndr_id</span></a><span> </span><a href="#local-6989586621683211758"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-600"></a><span>
</span><a name="line-601"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211775"><a href="#local-6989586621683211775"><span class="hs-identifier">minus''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211772"><span class="hs-identifier hs-var">minus'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">syn_res_wrap</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-602"></a><span>                                    </span><a href="#local-6989586621683211770"><span class="hs-identifier hs-var">minus_wrap</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-identifier">syn_res_wrap</span><span> </span><a href="#local-6989586621683211772"><span class="hs-identifier hs-var">minus'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-603"></a><span>              </span><a name="local-6989586621683211776"><a href="#local-6989586621683211776"><span class="hs-identifier">pat'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NPlusKPat</span><span> </span><a href="#local-6989586621683211759"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211751"><span class="hs-identifier hs-var">nm_loc</span></a><span> </span><a href="#local-6989586621683211771"><span class="hs-identifier hs-var">bndr_id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211753"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683211762"><span class="hs-identifier hs-var">lit1'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211769"><span class="hs-identifier hs-var">lit2'</span></a><span>
</span><a name="line-604"></a><span>                               </span><a href="#local-6989586621683211763"><span class="hs-identifier hs-var">ge'</span></a><span> </span><a href="#local-6989586621683211775"><span class="hs-identifier hs-var">minus''</span></a><span>
</span><a name="line-605"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211776"><span class="hs-identifier hs-var">pat'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211774"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span class="hs-comment">-- HsSpliced is an annotation produced by 'RnSplice.rnSplicePat'.</span><span>
</span><a name="line-608"></a><span class="hs-comment">-- Here we get rid of it and add the finalizers to the global environment.</span><span>
</span><a name="line-609"></a><span class="hs-comment">--</span><span>
</span><a name="line-610"></a><span class="hs-comment">-- See Note [Delaying modFinalizers in untyped splices] in RnSplice.</span><span>
</span><a name="line-611"></a><span class="hs-identifier">tc_pat</span><span> </span><a name="local-6989586621683211777"><a href="#local-6989586621683211777"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SplicePat</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSpliced</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211778"><a href="#local-6989586621683211778"><span class="hs-identifier">mod_finalizers</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsSplicedPat</span><span> </span><a name="local-6989586621683211779"><a href="#local-6989586621683211779"><span class="hs-identifier">pat</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-612"></a><span>            </span><a name="local-6989586621683211780"><a href="#local-6989586621683211780"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211781"><a href="#local-6989586621683211781"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-613"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="TcRnMonad.html#addModFinalizersWithLclEnv"><span class="hs-identifier hs-var">addModFinalizersWithLclEnv</span></a><span> </span><a href="#local-6989586621683211778"><span class="hs-identifier hs-var">mod_finalizers</span></a><span>
</span><a name="line-614"></a><span>       </span><a href="TcPat.html#tc_pat"><span class="hs-identifier hs-var">tc_pat</span></a><span> </span><a href="#local-6989586621683211777"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211779"><span class="hs-identifier hs-var">pat</span></a><span> </span><a href="#local-6989586621683211780"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211781"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span class="hs-identifier">tc_pat</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211782"><a href="#local-6989586621683211782"><span class="hs-identifier">_other_pat</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_pat&quot;</span><span>        </span><span class="hs-comment">-- ConPatOut, SigPatOut</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span>
</span><a name="line-619"></a><span class="hs-comment">{-
Note [Hopping the LIE in lazy patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In a lazy pattern, we must *not* discharge constraints from the RHS
from dictionaries bound in the pattern.  E.g.
        f ~(C x) = 3
We can't discharge the Num constraint from dictionaries bound by
the pattern C!

So we have to make the constraints from thing_inside &quot;hop around&quot;
the pattern.  Hence the captureConstraints and emitConstraints.

The same thing ensures that equality constraints in a lazy match
are not made available in the RHS of the match. For example
        data T a where { T1 :: Int -&gt; T Int; ... }
        f :: T a -&gt; Int -&gt; a
        f ~(T1 i) y = y
It's obviously not sound to refine a to Int in the right
hand side, because the argument might not match T1 at all!

Finally, a lazy pattern should not bind any existential type variables
because they won't be in scope when we do the desugaring


************************************************************************
*                                                                      *
        Most of the work for constructors is here
        (the rest is in the ConPatIn case of tc_pat)
*                                                                      *
************************************************************************

[Pattern matching indexed data types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following declarations:

  data family Map k :: * -&gt; *
  data instance Map (a, b) v = MapPair (Map a (Pair b v))

and a case expression

  case x :: Map (Int, c) w of MapPair m -&gt; ...

As explained by [Wrappers for data instance tycons] in MkIds.hs, the
worker/wrapper types for MapPair are

  $WMapPair :: forall a b v. Map a (Map a b v) -&gt; Map (a, b) v
  $wMapPair :: forall a b v. Map a (Map a b v) -&gt; :R123Map a b v

So, the type of the scrutinee is Map (Int, c) w, but the tycon of MapPair is
:R123Map, which means the straight use of boxySplitTyConApp would give a type
error.  Hence, the smart wrapper function boxySplitTyConAppWithFamily calls
boxySplitTyConApp with the family tycon Map instead, which gives us the family
type list {(Int, c), w}.  To get the correct split for :R123Map, we need to
unify the family type list {(Int, c), w} with the instance types {(a, b), v}
(provided by tyConFamInst_maybe together with the family tycon).  This
unification yields the substitution [a -&gt; Int, b -&gt; c, v -&gt; w], which gives us
the split arguments for the representation tycon :R123Map as {Int, c, w}

In other words, boxySplitTyConAppWithFamily implicitly takes the coercion

  Co123Map a b v :: {Map (a, b) v ~ :R123Map a b v}

moving between representation and family type into account.  To produce type
correct Core, this coercion needs to be used to case the type of the scrutinee
from the family to the representation type.  This is achieved by
unwrapFamInstScrutinee using a CoPat around the result pattern.

Now it might appear seem as if we could have used the previous GADT type
refinement infrastructure of refineAlt and friends instead of the explicit
unification and CoPat generation.  However, that would be wrong.  Why?  The
whole point of GADT refinement is that the refinement is local to the case
alternative.  In contrast, the substitution generated by the unification of
the family type list and instance types needs to be propagated to the outside.
Imagine that in the above example, the type of the scrutinee would have been
(Map x w), then we would have unified {x, w} with {(a, b), v}, yielding the
substitution [x -&gt; (a, b), v -&gt; w].  In contrast to GADT matching, the
instantiation of x with (a, b) must be global; ie, it must be valid in *all*
alternatives of the case expression, whereas in the GADT case it might vary
between alternatives.

RIP GADT refinement: refinements have been replaced by the use of explicit
equality constraints that are used in conjunction with implication constraints
to express the local scope of GADT refinements.
-}</span><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span class="hs-comment">--      Running example:</span><span>
</span><a name="line-705"></a><span class="hs-comment">-- MkT :: forall a b c. (a~[b]) =&gt; b -&gt; c -&gt; T a</span><span>
</span><a name="line-706"></a><span class="hs-comment">--       with scrutinee of type (T ty)</span><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span class="hs-identifier">tcConPat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-709"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>           </span><span class="hs-comment">-- Type of the pattern</span><span>
</span><a name="line-710"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsConPatDetails</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211503"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-711"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211503"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-712"></a><a name="tcConPat"><a href="TcPat.html#tcConPat"><span class="hs-identifier">tcConPat</span></a></a><span> </span><a name="local-6989586621683211783"><a href="#local-6989586621683211783"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211784"><a href="#local-6989586621683211784"><span class="hs-identifier">con_lname</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683211785"><a href="#local-6989586621683211785"><span class="hs-identifier">con_name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211786"><a href="#local-6989586621683211786"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211787"><a href="#local-6989586621683211787"><span class="hs-identifier">arg_pats</span></a></a><span> </span><a name="local-6989586621683211788"><a href="#local-6989586621683211788"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-713"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211789"><a href="#local-6989586621683211789"><span class="hs-identifier">con_like</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupConLike"><span class="hs-identifier hs-var">tcLookupConLike</span></a><span> </span><a href="#local-6989586621683211785"><span class="hs-identifier hs-var">con_name</span></a><span>
</span><a name="line-714"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683211789"><span class="hs-identifier hs-var">con_like</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-715"></a><span>            </span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621683211790"><a href="#local-6989586621683211790"><span class="hs-identifier">data_con</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#tcDataConPat"><span class="hs-identifier hs-var">tcDataConPat</span></a><span> </span><a href="#local-6989586621683211783"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211784"><span class="hs-identifier hs-var">con_lname</span></a><span> </span><a href="#local-6989586621683211790"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-716"></a><span>                                                 </span><a href="#local-6989586621683211786"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211787"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><a href="#local-6989586621683211788"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-717"></a><span>            </span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a name="local-6989586621683211791"><a href="#local-6989586621683211791"><span class="hs-identifier">pat_syn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#tcPatSynPat"><span class="hs-identifier hs-var">tcPatSynPat</span></a><span> </span><a href="#local-6989586621683211783"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211784"><span class="hs-identifier hs-var">con_lname</span></a><span> </span><a href="#local-6989586621683211791"><span class="hs-identifier hs-var">pat_syn</span></a><span>
</span><a name="line-718"></a><span>                                             </span><a href="#local-6989586621683211786"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211787"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><a href="#local-6989586621683211788"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-719"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><span class="hs-identifier">tcDataConPat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span>
</span><a name="line-722"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>               </span><span class="hs-comment">-- Type of the pattern</span><span>
</span><a name="line-723"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsConPatDetails</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211502"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-724"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211502"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-725"></a><a name="tcDataConPat"><a href="TcPat.html#tcDataConPat"><span class="hs-identifier">tcDataConPat</span></a></a><span> </span><a name="local-6989586621683211792"><a href="#local-6989586621683211792"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211793"><a href="#local-6989586621683211793"><span class="hs-identifier">con_span</span></a></a><span> </span><a name="local-6989586621683211794"><a href="#local-6989586621683211794"><span class="hs-identifier">con_name</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211795"><a href="#local-6989586621683211795"><span class="hs-identifier">data_con</span></a></a><span> </span><a name="local-6989586621683211796"><a href="#local-6989586621683211796"><span class="hs-identifier">pat_ty</span></a></a><span>
</span><a name="line-726"></a><span>             </span><a name="local-6989586621683211797"><a href="#local-6989586621683211797"><span class="hs-identifier">arg_pats</span></a></a><span> </span><a name="local-6989586621683211798"><a href="#local-6989586621683211798"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-727"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211799"><a href="#local-6989586621683211799"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621683211795"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-728"></a><span>                  </span><span class="hs-comment">-- For data families this is the representation tycon</span><span>
</span><a name="line-729"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621683211800"><a href="#local-6989586621683211800"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211801"><a href="#local-6989586621683211801"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211802"><a href="#local-6989586621683211802"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211803"><a href="#local-6989586621683211803"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211804"><a href="#local-6989586621683211804"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConFullSig</span><span> </span><a href="#local-6989586621683211795"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-731"></a><span>              </span><a name="local-6989586621683211805"><a href="#local-6989586621683211805"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211793"><span class="hs-identifier hs-var">con_span</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a href="#local-6989586621683211795"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span>
</span><a name="line-732"></a><span>
</span><a name="line-733"></a><span>          </span><span class="hs-comment">-- Instantiate the constructor type variables [a-&gt;ty]</span><span>
</span><a name="line-734"></a><span>          </span><span class="hs-comment">-- This may involve doing a family-instance coercion,</span><span>
</span><a name="line-735"></a><span>          </span><span class="hs-comment">-- and building a wrapper</span><span>
</span><a name="line-736"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211806"><a href="#local-6989586621683211806"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211807"><a href="#local-6989586621683211807"><span class="hs-identifier">ctxt_res_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#matchExpectedConTy"><span class="hs-identifier hs-var">matchExpectedConTy</span></a><span> </span><a href="#local-6989586621683211792"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211799"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621683211796"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-737"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211808"><a href="#local-6989586621683211808"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211796"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-738"></a><span>
</span><a name="line-739"></a><span>          </span><span class="hs-comment">-- Add the stupid theta</span><span>
</span><a name="line-740"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683211793"><span class="hs-identifier hs-var">con_span</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcPat.html#addDataConStupidTheta"><span class="hs-identifier hs-var">addDataConStupidTheta</span></a><span> </span><a href="#local-6989586621683211795"><span class="hs-identifier hs-var">data_con</span></a><span> </span><a href="#local-6989586621683211807"><span class="hs-identifier hs-var">ctxt_res_tys</span></a><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211809"><a href="#local-6989586621683211809"><span class="hs-identifier">all_arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqSpecPreds</span><span> </span><a href="#local-6989586621683211802"><span class="hs-identifier hs-var">eq_spec</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683211803"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683211804"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-743"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcPat.html#checkExistentials"><span class="hs-identifier hs-var">checkExistentials</span></a><span> </span><a href="#local-6989586621683211801"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><a href="#local-6989586621683211809"><span class="hs-identifier hs-var">all_arg_tys</span></a><span> </span><a href="#local-6989586621683211792"><span class="hs-identifier hs-var">penv</span></a><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211810"><a href="#local-6989586621683211810"><span class="hs-identifier">tenv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instTyVarsWith"><span class="hs-identifier hs-var">instTyVarsWith</span></a><span> </span><span class="hs-identifier hs-var">PatOrigin</span><span> </span><a href="#local-6989586621683211800"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-6989586621683211807"><span class="hs-identifier hs-var">ctxt_res_tys</span></a><span>
</span><a name="line-746"></a><span>                  </span><span class="hs-comment">-- NB: Do not use zipTvSubst!  See Trac #14154</span><span>
</span><a name="line-747"></a><span>                  </span><span class="hs-comment">-- We want to create a well-kinded substitution, so</span><span>
</span><a name="line-748"></a><span>                  </span><span class="hs-comment">-- that the instantiated type is well-kinded</span><span>
</span><a name="line-749"></a><span>
</span><a name="line-750"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211811"><a href="#local-6989586621683211811"><span class="hs-identifier">tenv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211812"><a href="#local-6989586621683211812"><span class="hs-identifier">ex_tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstSuperSkolTyVarsX"><span class="hs-identifier hs-var">tcInstSuperSkolTyVarsX</span></a><span> </span><a href="#local-6989586621683211810"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621683211801"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-751"></a><span>                     </span><span class="hs-comment">-- Get location from monad, not from ex_tvs</span><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- pat_ty' = mkTyConApp tycon ctxt_res_tys</span><span>
</span><a name="line-754"></a><span>              </span><span class="hs-comment">-- pat_ty' is type of the actual constructor application</span><span>
</span><a name="line-755"></a><span>              </span><span class="hs-comment">-- pat_ty' /= pat_ty iff coi /= IdCo</span><span>
</span><a name="line-756"></a><span>
</span><a name="line-757"></a><span>              </span><a name="local-6989586621683211813"><a href="#local-6989586621683211813"><span class="hs-identifier">arg_tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621683211811"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621683211804"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-758"></a><span>
</span><a name="line-759"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConPat&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211794"><span class="hs-identifier hs-var">con_name</span></a><span>
</span><a name="line-760"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pprTyVars</span><span> </span><a href="#local-6989586621683211800"><span class="hs-identifier hs-var">univ_tvs</span></a><span>
</span><a name="line-761"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pprTyVars</span><span> </span><a href="#local-6989586621683211801"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-762"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211802"><span class="hs-identifier hs-var">eq_spec</span></a><span>
</span><a name="line-763"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211803"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-764"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pprTyVars</span><span> </span><a href="#local-6989586621683211812"><span class="hs-identifier hs-var">ex_tvs'</span></a><span>
</span><a name="line-765"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211807"><span class="hs-identifier hs-var">ctxt_res_tys</span></a><span>
</span><a name="line-766"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211813"><span class="hs-identifier hs-var">arg_tys'</span></a><span>
</span><a name="line-767"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211797"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683211801"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683211802"><span class="hs-identifier hs-var">eq_spec</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683211803"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-769"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- The common case; no class bindings etc</span><span>
</span><a name="line-770"></a><span>                    </span><span class="hs-comment">-- (see Note [Arrows and patterns])</span><span>
</span><a name="line-771"></a><span>                    </span><span class="hs-special">(</span><a name="local-6989586621683211814"><a href="#local-6989586621683211814"><span class="hs-identifier">arg_pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211815"><a href="#local-6989586621683211815"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcConArgs"><span class="hs-identifier hs-var">tcConArgs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a href="#local-6989586621683211795"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211813"><span class="hs-identifier hs-var">arg_tys'</span></a><span>
</span><a name="line-772"></a><span>                                                  </span><a href="#local-6989586621683211797"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><a href="#local-6989586621683211792"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211798"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-773"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211816"><a href="#local-6989586621683211816"><span class="hs-identifier">res_pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ConPatOut</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_con</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211805"><span class="hs-identifier hs-var">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-774"></a><span>                                              </span><span class="hs-identifier">pat_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">pat_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-775"></a><span>                                              </span><span class="hs-identifier">pat_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyTcEvBinds</span><span class="hs-special">,</span><span>
</span><a name="line-776"></a><span>                                              </span><span class="hs-identifier">pat_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211814"><span class="hs-identifier hs-var">arg_pats'</span></a><span class="hs-special">,</span><span>
</span><a name="line-777"></a><span>                                              </span><span class="hs-identifier">pat_arg_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211807"><span class="hs-identifier hs-var">ctxt_res_tys</span></a><span class="hs-special">,</span><span>
</span><a name="line-778"></a><span>                                              </span><span class="hs-identifier">pat_wrap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211806"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621683211816"><span class="hs-identifier hs-var">res_pat</span></a><span> </span><a href="#local-6989586621683211808"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211815"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-781"></a><span>
</span><a name="line-782"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-comment">-- The general case, with existential,</span><span>
</span><a name="line-783"></a><span>                    </span><span class="hs-comment">-- and local equality constraints</span><span>
</span><a name="line-784"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211817"><a href="#local-6989586621683211817"><span class="hs-identifier">theta'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621683211811"><span class="hs-identifier hs-var">tenv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqSpecPreds</span><span> </span><a href="#local-6989586621683211802"><span class="hs-identifier hs-var">eq_spec</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683211803"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>                           </span><span class="hs-comment">-- order is *important* as we generate the list of</span><span>
</span><a name="line-786"></a><span>                           </span><span class="hs-comment">-- dictionary binders from theta'</span><span>
</span><a name="line-787"></a><span>              </span><a name="local-6989586621683211818"><a href="#local-6989586621683211818"><span class="hs-identifier">no_equalities</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-identifier hs-var">isNomEqPred</span><span> </span><a href="#local-6989586621683211817"><span class="hs-identifier hs-var">theta'</span></a><span class="hs-special">)</span><span>
</span><a name="line-788"></a><span>              </span><a name="local-6989586621683211819"><a href="#local-6989586621683211819"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PatSkol</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a href="#local-6989586621683211795"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211820"><span class="hs-identifier hs-var">mc</span></a><span>
</span><a name="line-789"></a><span>              </span><a name="local-6989586621683211820"><a href="#local-6989586621683211820"><span class="hs-identifier">mc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><a href="#local-6989586621683211792"><span class="hs-identifier hs-var">penv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-790"></a><span>                     </span><a href="TcPat.html#LamPat"><span class="hs-identifier hs-var">LamPat</span></a><span> </span><a name="local-6989586621683211821"><a href="#local-6989586621683211821"><span class="hs-identifier">mc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683211821"><span class="hs-identifier hs-var">mc</span></a><span>
</span><a name="line-791"></a><span>                     </span><a href="TcPat.html#LetPat"><span class="hs-identifier hs-var">LetPat</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">PatBindRhs</span><span>
</span><a name="line-792"></a><span>
</span><a name="line-793"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211822"><a href="#local-6989586621683211822"><span class="hs-identifier">gadts_on</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.GADTs</span><span>
</span><a name="line-794"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211823"><a href="#local-6989586621683211823"><span class="hs-identifier">families_on</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.TypeFamilies</span><span>
</span><a name="line-795"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211818"><span class="hs-identifier hs-var">no_equalities</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621683211822"><span class="hs-identifier hs-var">gadts_on</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621683211823"><span class="hs-identifier hs-var">families_on</span></a><span class="hs-special">)</span><span>
</span><a name="line-796"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;A pattern match on a GADT requires the&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-797"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;GADTs or TypeFamilies language extension&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span>                  </span><span class="hs-comment">-- Trac #2905 decided that a *pattern-match* of a GADT</span><span>
</span><a name="line-799"></a><span>                  </span><span class="hs-comment">-- should require the GADT language flag.</span><span>
</span><a name="line-800"></a><span>                  </span><span class="hs-comment">-- Re TypeFamilies see also #7156</span><span>
</span><a name="line-801"></a><span>
</span><a name="line-802"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211824"><a href="#local-6989586621683211824"><span class="hs-identifier">given</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newEvVars"><span class="hs-identifier hs-var">newEvVars</span></a><span> </span><a href="#local-6989586621683211817"><span class="hs-identifier hs-var">theta'</span></a><span>
</span><a name="line-803"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211825"><a href="#local-6989586621683211825"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211826"><a href="#local-6989586621683211826"><span class="hs-identifier">arg_pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211827"><a href="#local-6989586621683211827"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-804"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><a href="#local-6989586621683211819"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621683211812"><span class="hs-identifier hs-var">ex_tvs'</span></a><span> </span><a href="#local-6989586621683211824"><span class="hs-identifier hs-var">given</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-805"></a><span>                </span><a href="TcPat.html#tcConArgs"><span class="hs-identifier hs-var">tcConArgs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a href="#local-6989586621683211795"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211813"><span class="hs-identifier hs-var">arg_tys'</span></a><span> </span><a href="#local-6989586621683211797"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><a href="#local-6989586621683211792"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211798"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211828"><a href="#local-6989586621683211828"><span class="hs-identifier">res_pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ConPatOut</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_con</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211805"><span class="hs-identifier hs-var">header</span></a><span class="hs-special">,</span><span>
</span><a name="line-808"></a><span>                                    </span><span class="hs-identifier">pat_tvs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211812"><span class="hs-identifier hs-var">ex_tvs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-809"></a><span>                                    </span><span class="hs-identifier">pat_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211824"><span class="hs-identifier hs-var">given</span></a><span class="hs-special">,</span><span>
</span><a name="line-810"></a><span>                                    </span><span class="hs-identifier">pat_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211825"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">,</span><span>
</span><a name="line-811"></a><span>                                    </span><span class="hs-identifier">pat_args</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211826"><span class="hs-identifier hs-var">arg_pats'</span></a><span class="hs-special">,</span><span>
</span><a name="line-812"></a><span>                                    </span><span class="hs-identifier">pat_arg_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211807"><span class="hs-identifier hs-var">ctxt_res_tys</span></a><span class="hs-special">,</span><span>
</span><a name="line-813"></a><span>                                    </span><span class="hs-identifier">pat_wrap</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idHsWrapper</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-814"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211806"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621683211828"><span class="hs-identifier hs-var">res_pat</span></a><span> </span><a href="#local-6989586621683211808"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211827"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-815"></a><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-816"></a><span>
</span><a name="line-817"></a><span class="hs-identifier">tcPatSynPat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">PatSyn</span><span>
</span><a name="line-818"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>                </span><span class="hs-comment">-- Type of the pattern</span><span>
</span><a name="line-819"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsConPatDetails</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211501"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-820"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211501"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-821"></a><a name="tcPatSynPat"><a href="TcPat.html#tcPatSynPat"><span class="hs-identifier">tcPatSynPat</span></a></a><span> </span><a name="local-6989586621683211829"><a href="#local-6989586621683211829"><span class="hs-identifier">penv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211830"><a href="#local-6989586621683211830"><span class="hs-identifier">con_span</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683211831"><a href="#local-6989586621683211831"><span class="hs-identifier">pat_syn</span></a></a><span> </span><a name="local-6989586621683211832"><a href="#local-6989586621683211832"><span class="hs-identifier">pat_ty</span></a></a><span> </span><a name="local-6989586621683211833"><a href="#local-6989586621683211833"><span class="hs-identifier">arg_pats</span></a></a><span> </span><a name="local-6989586621683211834"><a href="#local-6989586621683211834"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-822"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211835"><a href="#local-6989586621683211835"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211836"><a href="#local-6989586621683211836"><span class="hs-identifier">req_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211837"><a href="#local-6989586621683211837"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211838"><a href="#local-6989586621683211838"><span class="hs-identifier">prov_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211839"><a href="#local-6989586621683211839"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211840"><a href="#local-6989586621683211840"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">patSynSig</span><span> </span><a href="#local-6989586621683211831"><span class="hs-identifier hs-var">pat_syn</span></a><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211841"><a href="#local-6989586621683211841"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211842"><a href="#local-6989586621683211842"><span class="hs-identifier">univ_tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVars"><span class="hs-identifier hs-var">newMetaTyVars</span></a><span> </span><a href="#local-6989586621683211835"><span class="hs-identifier hs-var">univ_tvs</span></a><span>
</span><a name="line-825"></a><span>
</span><a name="line-826"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211843"><a href="#local-6989586621683211843"><span class="hs-identifier">all_arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211840"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621683211838"><span class="hs-identifier hs-var">prov_theta</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683211839"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-827"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcPat.html#checkExistentials"><span class="hs-identifier hs-var">checkExistentials</span></a><span> </span><a href="#local-6989586621683211837"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><a href="#local-6989586621683211843"><span class="hs-identifier hs-var">all_arg_tys</span></a><span> </span><a href="#local-6989586621683211829"><span class="hs-identifier hs-var">penv</span></a><span>
</span><a name="line-828"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211844"><a href="#local-6989586621683211844"><span class="hs-identifier">tenv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211845"><a href="#local-6989586621683211845"><span class="hs-identifier">ex_tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstSuperSkolTyVarsX"><span class="hs-identifier hs-var">tcInstSuperSkolTyVarsX</span></a><span> </span><a href="#local-6989586621683211841"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683211837"><span class="hs-identifier hs-var">ex_tvs</span></a><span>
</span><a name="line-829"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211846"><a href="#local-6989586621683211846"><span class="hs-identifier">ty'</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTy</span><span> </span><a href="#local-6989586621683211844"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621683211840"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-830"></a><span>              </span><a name="local-6989586621683211847"><a href="#local-6989586621683211847"><span class="hs-identifier">arg_tys'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621683211844"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621683211839"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-831"></a><span>              </span><a name="local-6989586621683211848"><a href="#local-6989586621683211848"><span class="hs-identifier">prov_theta'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621683211844"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621683211838"><span class="hs-identifier hs-var">prov_theta</span></a><span>
</span><a name="line-832"></a><span>              </span><a name="local-6989586621683211849"><a href="#local-6989586621683211849"><span class="hs-identifier">req_theta'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621683211844"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621683211836"><span class="hs-identifier hs-var">req_theta</span></a><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211850"><a href="#local-6989586621683211850"><span class="hs-identifier">wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcSubTypePat"><span class="hs-identifier hs-var">tcSubTypePat</span></a><span> </span><a href="#local-6989586621683211829"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211832"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><a href="#local-6989586621683211846"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-835"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPatSynPat&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211831"><span class="hs-identifier hs-var">pat_syn</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-836"></a><span>                                 </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211832"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-837"></a><span>                                 </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211846"><span class="hs-identifier hs-var">ty'</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-838"></a><span>                                 </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211845"><span class="hs-identifier hs-var">ex_tvs'</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-839"></a><span>                                 </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211848"><span class="hs-identifier hs-var">prov_theta'</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-840"></a><span>                                 </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211849"><span class="hs-identifier hs-var">req_theta'</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-841"></a><span>                                 </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211847"><span class="hs-identifier hs-var">arg_tys'</span></a><span class="hs-special">)</span><span>
</span><a name="line-842"></a><span>
</span><a name="line-843"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211851"><a href="#local-6989586621683211851"><span class="hs-identifier">prov_dicts'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newEvVars"><span class="hs-identifier hs-var">newEvVars</span></a><span> </span><a href="#local-6989586621683211848"><span class="hs-identifier hs-var">prov_theta'</span></a><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211852"><a href="#local-6989586621683211852"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><a href="#local-6989586621683211829"><span class="hs-identifier hs-var">penv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-846"></a><span>                            </span><a href="TcPat.html#LamPat"><span class="hs-identifier hs-var">LamPat</span></a><span> </span><a name="local-6989586621683211853"><a href="#local-6989586621683211853"><span class="hs-identifier">mc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">PatSkol</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a href="#local-6989586621683211831"><span class="hs-identifier hs-var">pat_syn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211853"><span class="hs-identifier hs-var">mc</span></a><span>
</span><a name="line-847"></a><span>                            </span><a href="TcPat.html#LetPat"><span class="hs-identifier hs-var">LetPat</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">UnkSkol</span><span> </span><span class="hs-comment">-- Doesn't matter</span><span>
</span><a name="line-848"></a><span>
</span><a name="line-849"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211854"><a href="#local-6989586621683211854"><span class="hs-identifier">req_wrap</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#instCall"><span class="hs-identifier hs-var">instCall</span></a><span> </span><span class="hs-identifier hs-var">PatOrigin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683211842"><span class="hs-identifier hs-var">univ_tvs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211849"><span class="hs-identifier hs-var">req_theta'</span></a><span>
</span><a name="line-850"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;instCall&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211854"><span class="hs-identifier hs-var">req_wrap</span></a><span class="hs-special">)</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkConstraints {&quot;</span><span> </span><span class="hs-identifier hs-var">Outputable.empty</span><span>
</span><a name="line-853"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211855"><a href="#local-6989586621683211855"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211856"><a href="#local-6989586621683211856"><span class="hs-identifier">arg_pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211857"><a href="#local-6989586621683211857"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-854"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><a href="#local-6989586621683211852"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621683211845"><span class="hs-identifier hs-var">ex_tvs'</span></a><span> </span><a href="#local-6989586621683211851"><span class="hs-identifier hs-var">prov_dicts'</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-855"></a><span>                </span><a href="TcPat.html#tcConArgs"><span class="hs-identifier hs-var">tcConArgs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a href="#local-6989586621683211831"><span class="hs-identifier hs-var">pat_syn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211847"><span class="hs-identifier hs-var">arg_tys'</span></a><span> </span><a href="#local-6989586621683211833"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><a href="#local-6989586621683211829"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211834"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-856"></a><span>
</span><a name="line-857"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkConstraints }&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211855"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-858"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211858"><a href="#local-6989586621683211858"><span class="hs-identifier">res_pat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ConPatOut</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pat_con</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211830"><span class="hs-identifier hs-var">con_span</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">PatSynCon</span><span> </span><a href="#local-6989586621683211831"><span class="hs-identifier hs-var">pat_syn</span></a><span class="hs-special">,</span><span>
</span><a name="line-859"></a><span>                                    </span><span class="hs-identifier">pat_tvs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211845"><span class="hs-identifier hs-var">ex_tvs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-860"></a><span>                                    </span><span class="hs-identifier">pat_dicts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211851"><span class="hs-identifier hs-var">prov_dicts'</span></a><span class="hs-special">,</span><span>
</span><a name="line-861"></a><span>                                    </span><span class="hs-identifier">pat_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211855"><span class="hs-identifier hs-var">ev_binds</span></a><span class="hs-special">,</span><span>
</span><a name="line-862"></a><span>                                    </span><span class="hs-identifier">pat_args</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211856"><span class="hs-identifier hs-var">arg_pats'</span></a><span class="hs-special">,</span><span>
</span><a name="line-863"></a><span>                                    </span><span class="hs-identifier">pat_arg_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683211842"><span class="hs-identifier hs-var">univ_tvs'</span></a><span class="hs-special">,</span><span>
</span><a name="line-864"></a><span>                                    </span><span class="hs-identifier">pat_wrap</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211854"><span class="hs-identifier hs-var">req_wrap</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-865"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211859"><a href="#local-6989586621683211859"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#readExpType"><span class="hs-identifier hs-var">readExpType</span></a><span> </span><a href="#local-6989586621683211832"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-866"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWrapPat</span><span> </span><a href="#local-6989586621683211850"><span class="hs-identifier hs-var">wrap</span></a><span> </span><a href="#local-6989586621683211858"><span class="hs-identifier hs-var">res_pat</span></a><span> </span><a href="#local-6989586621683211859"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211857"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-867"></a><span>
</span><a name="line-868"></a><span class="hs-comment">----------------------------</span><span>
</span><a name="line-869"></a><span class="hs-comment">-- | Convenient wrapper for calling a matchExpectedXXX function</span><span>
</span><a name="line-870"></a><span class="hs-identifier">matchExpectedPatTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcRhoType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcCoercionN</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211500"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-871"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211500"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-872"></a><span class="hs-comment">-- See Note [Matching polytyped patterns]</span><span>
</span><a name="line-873"></a><span class="hs-comment">-- Returns a wrapper : pat_ty ~R inner_ty</span><span>
</span><a name="line-874"></a><a name="matchExpectedPatTy"><a href="TcPat.html#matchExpectedPatTy"><span class="hs-identifier">matchExpectedPatTy</span></a></a><span> </span><a name="local-6989586621683211860"><a href="#local-6989586621683211860"><span class="hs-identifier">inner_match</span></a></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683211861"><a href="#local-6989586621683211861"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683211862"><a href="#local-6989586621683211862"><span class="hs-identifier">pat_ty</span></a></a><span>
</span><a name="line-875"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211863"><a href="#local-6989586621683211863"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683211862"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-876"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211864"><a href="#local-6989586621683211864"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211865"><a href="#local-6989586621683211865"><span class="hs-identifier">pat_rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><a href="#local-6989586621683211861"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683211863"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-877"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211866"><a href="#local-6989586621683211866"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211867"><a href="#local-6989586621683211867"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683211860"><span class="hs-identifier hs-var">inner_match</span></a><span> </span><a href="#local-6989586621683211865"><span class="hs-identifier hs-var">pat_rho</span></a><span>
</span><a name="line-878"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;matchExpectedPatTy&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211863"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211864"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">)</span><span>
</span><a name="line-879"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpCastN</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621683211866"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683211864"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211867"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span class="hs-comment">----------------------------</span><span>
</span><a name="line-882"></a><span class="hs-identifier">matchExpectedConTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span>
</span><a name="line-883"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span>      </span><span class="hs-comment">-- The TyCon that this data</span><span>
</span><a name="line-884"></a><span>                                 </span><span class="hs-comment">-- constructor actually returns</span><span>
</span><a name="line-885"></a><span>                                 </span><span class="hs-comment">-- In the case of a data family this is</span><span>
</span><a name="line-886"></a><span>                                 </span><span class="hs-comment">-- the /representation/ TyCon</span><span>
</span><a name="line-887"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpSigmaType</span><span>  </span><span class="hs-comment">-- The type of the pattern; in the case</span><span>
</span><a name="line-888"></a><span>                                    </span><span class="hs-comment">-- of a data family this would mention</span><span>
</span><a name="line-889"></a><span>                                    </span><span class="hs-comment">-- the /family/ TyCon</span><span>
</span><a name="line-890"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsWrapper</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-891"></a><span class="hs-comment">-- See Note [Matching constructor patterns]</span><span>
</span><a name="line-892"></a><span class="hs-comment">-- Returns a wrapper : pat_ty &quot;-&gt;&quot; T ty1 ... tyn</span><span>
</span><a name="line-893"></a><a name="matchExpectedConTy"><a href="TcPat.html#matchExpectedConTy"><span class="hs-identifier">matchExpectedConTy</span></a></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_orig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683211868"><a href="#local-6989586621683211868"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683211869"><a href="#local-6989586621683211869"><span class="hs-identifier">data_tc</span></a></a><span> </span><a name="local-6989586621683211870"><a href="#local-6989586621683211870"><span class="hs-identifier">exp_pat_ty</span></a></a><span>
</span><a name="line-894"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211871"><a href="#local-6989586621683211871"><span class="hs-identifier">fam_tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211872"><a href="#local-6989586621683211872"><span class="hs-identifier">fam_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211873"><a href="#local-6989586621683211873"><span class="hs-identifier">co_tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConFamInstSig_maybe</span><span> </span><a href="#local-6989586621683211869"><span class="hs-identifier hs-var">data_tc</span></a><span>
</span><a name="line-895"></a><span>         </span><span class="hs-comment">-- Comments refer to Note [Matching constructor patterns]</span><span>
</span><a name="line-896"></a><span>         </span><span class="hs-comment">-- co_tc :: forall a. T [a] ~ T7 a</span><span>
</span><a name="line-897"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211874"><a href="#local-6989586621683211874"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683211870"><span class="hs-identifier hs-var">exp_pat_ty</span></a><span>
</span><a name="line-898"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211875"><a href="#local-6989586621683211875"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211876"><a href="#local-6989586621683211876"><span class="hs-identifier">pat_rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><a href="#local-6989586621683211868"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683211874"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-899"></a><span>
</span><a name="line-900"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211877"><a href="#local-6989586621683211877"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211878"><a href="#local-6989586621683211878"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newMetaTyVars"><span class="hs-identifier hs-var">newMetaTyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683211869"><span class="hs-identifier hs-var">data_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-901"></a><span>             </span><span class="hs-comment">-- tys = [ty1,ty2]</span><span>
</span><a name="line-902"></a><span>
</span><a name="line-903"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;matchExpectedConTy&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211869"><span class="hs-identifier hs-var">data_tc</span></a><span class="hs-special">,</span><span>
</span><a name="line-904"></a><span>                                             </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683211869"><span class="hs-identifier hs-var">data_tc</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-905"></a><span>                                             </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211871"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211872"><span class="hs-identifier hs-var">fam_args</span></a><span class="hs-special">,</span><span>
</span><a name="line-906"></a><span>                                             </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211870"><span class="hs-identifier hs-var">exp_pat_ty</span></a><span class="hs-special">,</span><span>
</span><a name="line-907"></a><span>                                             </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211874"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">,</span><span>
</span><a name="line-908"></a><span>                                             </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211876"><span class="hs-identifier hs-var">pat_rho</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211875"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-909"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211879"><a href="#local-6989586621683211879"><span class="hs-identifier">co1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#unifyType"><span class="hs-identifier hs-var">unifyType</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683211871"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">substTys</span><span> </span><a href="#local-6989586621683211877"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621683211872"><span class="hs-identifier hs-var">fam_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211876"><span class="hs-identifier hs-var">pat_rho</span></a><span>
</span><a name="line-910"></a><span>             </span><span class="hs-comment">-- co1 : T (ty1,ty2) ~N pat_rho</span><span>
</span><a name="line-911"></a><span>             </span><span class="hs-comment">-- could use tcSubType here... but it's the wrong way round</span><span>
</span><a name="line-912"></a><span>             </span><span class="hs-comment">-- for actual vs. expected in error messages.</span><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211880"><a href="#local-6989586621683211880"><span class="hs-identifier">tys'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683211878"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-915"></a><span>             </span><a name="local-6989586621683211881"><a href="#local-6989586621683211881"><span class="hs-identifier">co2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcUnbranchedAxInstCo</span><span> </span><a href="#local-6989586621683211873"><span class="hs-identifier hs-var">co_tc</span></a><span> </span><a href="#local-6989586621683211880"><span class="hs-identifier hs-var">tys'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-916"></a><span>             </span><span class="hs-comment">-- co2 : T (ty1,ty2) ~R T7 ty1 ty2</span><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span>             </span><a name="local-6989586621683211882"><a href="#local-6989586621683211882"><span class="hs-identifier">full_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTcSubCo</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621683211879"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">mkTcTransCo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683211881"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-919"></a><span>             </span><span class="hs-comment">-- full_co :: pat_rho ~R T7 ty1 ty2</span><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkWpCastR</span><span> </span><a href="#local-6989586621683211882"><span class="hs-identifier hs-var">full_co</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683211875"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211880"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-924"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211883"><a href="#local-6989586621683211883"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#expTypeToType"><span class="hs-identifier hs-var">expTypeToType</span></a><span> </span><a href="#local-6989586621683211870"><span class="hs-identifier hs-var">exp_pat_ty</span></a><span>
</span><a name="line-925"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211884"><a href="#local-6989586621683211884"><span class="hs-identifier">wrap</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211885"><a href="#local-6989586621683211885"><span class="hs-identifier">pat_rho</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#topInstantiate"><span class="hs-identifier hs-var">topInstantiate</span></a><span> </span><a href="#local-6989586621683211868"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683211883"><span class="hs-identifier hs-var">pat_ty</span></a><span>
</span><a name="line-926"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211886"><a href="#local-6989586621683211886"><span class="hs-identifier">coi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211887"><a href="#local-6989586621683211887"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#matchExpectedTyConApp"><span class="hs-identifier hs-var">matchExpectedTyConApp</span></a><span> </span><a href="#local-6989586621683211869"><span class="hs-identifier hs-var">data_tc</span></a><span> </span><a href="#local-6989586621683211885"><span class="hs-identifier hs-var">pat_rho</span></a><span>
</span><a name="line-927"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkWpCastN</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTcSymCo</span><span> </span><a href="#local-6989586621683211886"><span class="hs-identifier hs-var">coi</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621683211884"><span class="hs-identifier hs-var">wrap</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211887"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-928"></a><span>
</span><a name="line-929"></a><span class="hs-comment">{-
Note [Matching constructor patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose (coi, tys) = matchExpectedConType data_tc pat_ty

 * In the simple case, pat_ty = tc tys

 * If pat_ty is a polytype, we want to instantiate it
   This is like part of a subsumption check.  Eg
      f :: (forall a. [a]) -&gt; blah
      f [] = blah

 * In a type family case, suppose we have
          data family T a
          data instance T (p,q) = A p | B q
       Then we'll have internally generated
              data T7 p q = A p | B q
              axiom coT7 p q :: T (p,q) ~ T7 p q

       So if pat_ty = T (ty1,ty2), we return (coi, [ty1,ty2]) such that
           coi = coi2 . coi1 : T7 t ~ pat_ty
           coi1 : T (ty1,ty2) ~ pat_ty
           coi2 : T7 ty1 ty2 ~ T (ty1,ty2)

   For families we do all this matching here, not in the unifier,
   because we never want a whisper of the data_tycon to appear in
   error messages; it's a purely internal thing
-}</span><span>
</span><a name="line-957"></a><span>
</span><a name="line-958"></a><span class="hs-identifier">tcConArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">]</span><span>
</span><a name="line-959"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#Checker"><span class="hs-identifier hs-type">Checker</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsConPatDetails</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsConPatDetails</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-960"></a><span>
</span><a name="line-961"></a><a name="tcConArgs"><a href="TcPat.html#tcConArgs"><span class="hs-identifier">tcConArgs</span></a></a><span> </span><a name="local-6989586621683211888"><a href="#local-6989586621683211888"><span class="hs-identifier">con_like</span></a></a><span> </span><a name="local-6989586621683211889"><a href="#local-6989586621683211889"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><a name="local-6989586621683211890"><a href="#local-6989586621683211890"><span class="hs-identifier">arg_pats</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211891"><a href="#local-6989586621683211891"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211892"><a href="#local-6989586621683211892"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-962"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211893"><span class="hs-identifier hs-var">con_arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683211894"><span class="hs-identifier hs-var">no_of_args</span></a><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- Check correct arity</span><span>
</span><a name="line-963"></a><span>                  </span><span class="hs-special">(</span><a href="TcValidity.html#arityErr"><span class="hs-identifier hs-var">arityErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;constructor&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211888"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683211893"><span class="hs-identifier hs-var">con_arity</span></a><span> </span><a href="#local-6989586621683211894"><span class="hs-identifier hs-var">no_of_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-964"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683211895"><a href="#local-6989586621683211895"><span class="hs-identifier">pats_w_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipEqual</span><span> </span><span class="hs-string">&quot;tcConArgs&quot;</span><span> </span><a href="#local-6989586621683211890"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><a href="#local-6989586621683211889"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-965"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211896"><a href="#local-6989586621683211896"><span class="hs-identifier">arg_pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211897"><a href="#local-6989586621683211897"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcMultiple"><span class="hs-identifier hs-var">tcMultiple</span></a><span> </span><a href="TcPat.html#tcConArg"><span class="hs-identifier hs-var">tcConArg</span></a><span> </span><a href="#local-6989586621683211895"><span class="hs-identifier hs-var">pats_w_tys</span></a><span>
</span><a name="line-966"></a><span>                                              </span><a href="#local-6989586621683211891"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211892"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-967"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">PrefixCon</span><span> </span><a href="#local-6989586621683211896"><span class="hs-identifier hs-var">arg_pats'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211897"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-968"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-969"></a><span>    </span><a name="local-6989586621683211893"><a href="#local-6989586621683211893"><span class="hs-identifier">con_arity</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeArity</span><span> </span><a href="#local-6989586621683211888"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-970"></a><span>    </span><a name="local-6989586621683211894"><a href="#local-6989586621683211894"><span class="hs-identifier">no_of_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683211890"><span class="hs-identifier hs-var">arg_pats</span></a><span>
</span><a name="line-971"></a><span>
</span><a name="line-972"></a><span class="hs-identifier">tcConArgs</span><span> </span><a name="local-6989586621683211898"><a href="#local-6989586621683211898"><span class="hs-identifier">con_like</span></a></a><span> </span><a name="local-6989586621683211899"><a href="#local-6989586621683211899"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InfixCon</span><span> </span><a name="local-6989586621683211900"><a href="#local-6989586621683211900"><span class="hs-identifier">p1</span></a></a><span> </span><a name="local-6989586621683211901"><a href="#local-6989586621683211901"><span class="hs-identifier">p2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211902"><a href="#local-6989586621683211902"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211903"><a href="#local-6989586621683211903"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-973"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211904"><span class="hs-identifier hs-var">con_arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Check correct arity</span><span>
</span><a name="line-974"></a><span>                  </span><span class="hs-special">(</span><a href="TcValidity.html#arityErr"><span class="hs-identifier hs-var">arityErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;constructor&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211898"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683211904"><span class="hs-identifier hs-var">con_arity</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-975"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683211905"><a href="#local-6989586621683211905"><span class="hs-identifier">arg_ty1</span></a></a><span class="hs-special">,</span><a name="local-6989586621683211906"><a href="#local-6989586621683211906"><span class="hs-identifier">arg_ty2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211899"><span class="hs-identifier hs-var">arg_tys</span></a><span>       </span><span class="hs-comment">-- This can't fail after the arity check</span><span>
</span><a name="line-976"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621683211907"><a href="#local-6989586621683211907"><span class="hs-identifier">p1'</span></a></a><span class="hs-special">,</span><a name="local-6989586621683211908"><a href="#local-6989586621683211908"><span class="hs-identifier">p2'</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683211909"><a href="#local-6989586621683211909"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcMultiple"><span class="hs-identifier hs-var">tcMultiple</span></a><span> </span><a href="TcPat.html#tcConArg"><span class="hs-identifier hs-var">tcConArg</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683211900"><span class="hs-identifier hs-var">p1</span></a><span class="hs-special">,</span><a href="#local-6989586621683211905"><span class="hs-identifier hs-var">arg_ty1</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">(</span><a href="#local-6989586621683211901"><span class="hs-identifier hs-var">p2</span></a><span class="hs-special">,</span><a href="#local-6989586621683211906"><span class="hs-identifier hs-var">arg_ty2</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-977"></a><span>                                              </span><a href="#local-6989586621683211902"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211903"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-978"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InfixCon</span><span> </span><a href="#local-6989586621683211907"><span class="hs-identifier hs-var">p1'</span></a><span> </span><a href="#local-6989586621683211908"><span class="hs-identifier hs-var">p2'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211909"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-979"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-980"></a><span>    </span><a name="local-6989586621683211904"><a href="#local-6989586621683211904"><span class="hs-identifier">con_arity</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">conLikeArity</span><span> </span><a href="#local-6989586621683211898"><span class="hs-identifier hs-var">con_like</span></a><span>
</span><a name="line-981"></a><span>
</span><a name="line-982"></a><span class="hs-identifier">tcConArgs</span><span> </span><a name="local-6989586621683211910"><a href="#local-6989586621683211910"><span class="hs-identifier">con_like</span></a></a><span> </span><a name="local-6989586621683211911"><a href="#local-6989586621683211911"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><a name="local-6989586621683211912"><a href="#local-6989586621683211912"><span class="hs-identifier">rpats</span></a></a><span> </span><a name="local-6989586621683211913"><a href="#local-6989586621683211913"><span class="hs-identifier">dd</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683211914"><a href="#local-6989586621683211914"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211915"><a href="#local-6989586621683211915"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-983"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211938"><a href="#local-6989586621683211938"><span class="hs-identifier">rpats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211939"><a href="#local-6989586621683211939"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcMultiple"><span class="hs-identifier hs-var">tcMultiple</span></a><span> </span><a href="#local-6989586621683211916"><span class="hs-identifier hs-var">tc_field</span></a><span> </span><a href="#local-6989586621683211912"><span class="hs-identifier hs-var">rpats</span></a><span> </span><a href="#local-6989586621683211914"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211915"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-984"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RecCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecFields</span><span> </span><a href="#local-6989586621683211938"><span class="hs-identifier hs-var">rpats'</span></a><span> </span><a href="#local-6989586621683211913"><span class="hs-identifier hs-var">dd</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211939"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-985"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-986"></a><span>    </span><span class="hs-identifier">tc_field</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#Checker"><span class="hs-identifier hs-type">Checker</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecField</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-987"></a><span>                        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsRecField</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTcId</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>    </span><a name="local-6989586621683211916"><a href="#local-6989586621683211916"><span class="hs-identifier">tc_field</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211919"><a href="#local-6989586621683211919"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecField</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211920"><a href="#local-6989586621683211920"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-989"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><a name="local-6989586621683211921"><a href="#local-6989586621683211921"><span class="hs-identifier">sel</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683211922"><a href="#local-6989586621683211922"><span class="hs-identifier">lr</span></a></a><span> </span><a name="local-6989586621683211923"><a href="#local-6989586621683211923"><span class="hs-identifier">rdr</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621683211924"><a href="#local-6989586621683211924"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683211925"><a href="#local-6989586621683211925"><span class="hs-identifier">pun</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span>             </span><a name="local-6989586621683211926"><a href="#local-6989586621683211926"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211927"><a href="#local-6989586621683211927"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-991"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683211928"><a href="#local-6989586621683211928"><span class="hs-identifier">sel'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683211921"><span class="hs-identifier hs-var">sel</span></a><span>
</span><a name="line-992"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683211929"><a href="#local-6989586621683211929"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683211920"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683211917"><span class="hs-identifier hs-var">find_field_ty</span></a><span> </span><a href="#local-6989586621683211921"><span class="hs-identifier hs-var">sel</span></a><span>
</span><a name="line-993"></a><span>                                          </span><span class="hs-special">(</span><span class="hs-identifier">occNameFS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><a href="#local-6989586621683211923"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211930"><a href="#local-6989586621683211930"><span class="hs-identifier">pat'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211931"><a href="#local-6989586621683211931"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcPat.html#tcConArg"><span class="hs-identifier hs-var">tcConArg</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211924"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211929"><span class="hs-identifier hs-var">pat_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211926"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211927"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-995"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211919"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecField</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211920"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FieldOcc</span><span> </span><a href="#local-6989586621683211928"><span class="hs-identifier hs-var">sel'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683211922"><span class="hs-identifier hs-var">lr</span></a><span> </span><a href="#local-6989586621683211923"><span class="hs-identifier hs-var">rdr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211930"><span class="hs-identifier hs-var">pat'</span></a><span>
</span><a name="line-996"></a><span>                                                                    </span><a href="#local-6989586621683211925"><span class="hs-identifier hs-var">pun</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683211931"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-997"></a><span>    </span><span class="hs-identifier">tc_field</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsRecField</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XFieldOcc</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-998"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcConArgs&quot;</span><span>
</span><a name="line-999"></a><span>    </span><span class="hs-identifier">tc_field</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_field: Impossible Match&quot;</span><span>
</span><a name="line-1000"></a><span>                             </span><span class="hs-comment">-- due to #15884</span><span>
</span><a name="line-1001"></a><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span>    </span><span class="hs-identifier">find_field_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FieldLabelString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcType</span><span>
</span><a name="line-1004"></a><span>    </span><a name="local-6989586621683211917"><a href="#local-6989586621683211917"><span class="hs-identifier">find_field_ty</span></a></a><span> </span><a name="local-6989586621683211932"><a href="#local-6989586621683211932"><span class="hs-identifier">sel</span></a></a><span> </span><a name="local-6989586621683211933"><a href="#local-6989586621683211933"><span class="hs-identifier">lbl</span></a></a><span>
</span><a name="line-1005"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683211935"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683211934"><a href="#local-6989586621683211934"><span class="hs-identifier">fl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211935"><a href="#local-6989586621683211935"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683211918"><span class="hs-identifier hs-var">field_tys</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621683211934"><span class="hs-identifier hs-var">fl</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683211932"><span class="hs-identifier hs-var">sel</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1006"></a><span>
</span><a name="line-1007"></a><span>                </span><span class="hs-comment">-- No matching field; chances are this field label comes from some</span><span>
</span><a name="line-1008"></a><span>                </span><span class="hs-comment">-- other record type (or maybe none).  If this happens, just fail,</span><span>
</span><a name="line-1009"></a><span>                </span><span class="hs-comment">-- otherwise we get crashes later (Trac #8570), and similar:</span><span>
</span><a name="line-1010"></a><span>                </span><span class="hs-comment">--      f (R { foo = (a,b) }) = a+b</span><span>
</span><a name="line-1011"></a><span>                </span><span class="hs-comment">-- If foo isn't one of R's fields, we don't want to crash when</span><span>
</span><a name="line-1012"></a><span>                </span><span class="hs-comment">-- typechecking the &quot;a+b&quot;.</span><span>
</span><a name="line-1013"></a><span>           </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWith"><span class="hs-identifier hs-var">failWith</span></a><span> </span><span class="hs-special">(</span><a href="TcPat.html#badFieldCon"><span class="hs-identifier hs-var">badFieldCon</span></a><span> </span><a href="#local-6989586621683211910"><span class="hs-identifier hs-var">con_like</span></a><span> </span><a href="#local-6989586621683211933"><span class="hs-identifier hs-var">lbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1014"></a><span>
</span><a name="line-1015"></a><span>                </span><span class="hs-comment">-- The normal case, when the field comes from the right constructor</span><span>
</span><a name="line-1016"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621683211936"><a href="#local-6989586621683211936"><span class="hs-identifier">pat_ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621683211937"><a href="#local-6989586621683211937"><span class="hs-identifier">extras</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1017"></a><span>                </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;find_field&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211936"><span class="hs-identifier hs-var">pat_ty</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211937"><span class="hs-identifier hs-var">extras</span></a><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><span>                </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">extras</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">pat_ty</span><span class="hs-special">)</span><span>
</span><a name="line-1019"></a><span>
</span><a name="line-1020"></a><span>    </span><span class="hs-identifier">field_tys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">FieldLabel</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1021"></a><span>    </span><a name="local-6989586621683211918"><a href="#local-6989586621683211918"><span class="hs-identifier">field_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">conLikeFieldLabels</span><span> </span><a href="#local-6989586621683211910"><span class="hs-identifier hs-var">con_like</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211911"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-1022"></a><span>          </span><span class="hs-comment">-- Don't use zipEqual! If the constructor isn't really a record, then</span><span>
</span><a name="line-1023"></a><span>          </span><span class="hs-comment">-- dataConFieldLabels will be empty (and each field in the pattern</span><span>
</span><a name="line-1024"></a><span>          </span><span class="hs-comment">-- will generate an error below).</span><span>
</span><a name="line-1025"></a><span>
</span><a name="line-1026"></a><span class="hs-identifier">tcConArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcPat.html#Checker"><span class="hs-identifier hs-type">Checker</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcSigmaType</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LPat</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><a name="tcConArg"><a href="TcPat.html#tcConArg"><span class="hs-identifier">tcConArg</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683211940"><a href="#local-6989586621683211940"><span class="hs-identifier">arg_pat</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683211941"><a href="#local-6989586621683211941"><span class="hs-identifier">arg_ty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621683211942"><a href="#local-6989586621683211942"><span class="hs-identifier">penv</span></a></a><span> </span><a name="local-6989586621683211943"><a href="#local-6989586621683211943"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1028"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#tc_lpat"><span class="hs-identifier hs-var">tc_lpat</span></a><span> </span><a href="#local-6989586621683211940"><span class="hs-identifier hs-var">arg_pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683211941"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211942"><span class="hs-identifier hs-var">penv</span></a><span> </span><a href="#local-6989586621683211943"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1029"></a><span>
</span><a name="line-1030"></a><span class="hs-identifier">addDataConStupidTheta</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcType</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1031"></a><span class="hs-comment">-- Instantiate the &quot;stupid theta&quot; of the data con, and throw</span><span>
</span><a name="line-1032"></a><span class="hs-comment">-- the constraints into the constraint set</span><span>
</span><a name="line-1033"></a><a name="addDataConStupidTheta"><a href="TcPat.html#addDataConStupidTheta"><span class="hs-identifier">addDataConStupidTheta</span></a></a><span> </span><a name="local-6989586621683211944"><a href="#local-6989586621683211944"><span class="hs-identifier">data_con</span></a></a><span> </span><a name="local-6989586621683211945"><a href="#local-6989586621683211945"><span class="hs-identifier">inst_tys</span></a></a><span>
</span><a name="line-1034"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683211947"><span class="hs-identifier hs-var">stupid_theta</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1035"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Inst.html#instStupidTheta"><span class="hs-identifier hs-var">instStupidTheta</span></a><span> </span><a href="#local-6989586621683211946"><span class="hs-identifier hs-var">origin</span></a><span> </span><a href="#local-6989586621683211950"><span class="hs-identifier hs-var">inst_theta</span></a><span>
</span><a name="line-1036"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1037"></a><span>    </span><a name="local-6989586621683211946"><a href="#local-6989586621683211946"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">OccurrenceOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621683211944"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span>
</span><a name="line-1038"></a><span>        </span><span class="hs-comment">-- The origin should always report &quot;occurrence of C&quot;</span><span>
</span><a name="line-1039"></a><span>        </span><span class="hs-comment">-- even when C occurs in a pattern</span><span>
</span><a name="line-1040"></a><span>    </span><a name="local-6989586621683211947"><a href="#local-6989586621683211947"><span class="hs-identifier">stupid_theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConStupidTheta</span><span> </span><a href="#local-6989586621683211944"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-1041"></a><span>    </span><a name="local-6989586621683211948"><a href="#local-6989586621683211948"><span class="hs-identifier">univ_tvs</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConUnivTyVars</span><span> </span><a href="#local-6989586621683211944"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-1042"></a><span>    </span><a name="local-6989586621683211949"><a href="#local-6989586621683211949"><span class="hs-identifier">tenv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipTvSubst</span><span> </span><a href="#local-6989586621683211948"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeList</span><span> </span><a href="#local-6989586621683211948"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-6989586621683211945"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1043"></a><span>         </span><span class="hs-comment">-- NB: inst_tys can be longer than the univ tyvars</span><span>
</span><a name="line-1044"></a><span>         </span><span class="hs-comment">--     because the constructor might have existentials</span><span>
</span><a name="line-1045"></a><span>    </span><a name="local-6989586621683211950"><a href="#local-6989586621683211950"><span class="hs-identifier">inst_theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">substTheta</span><span> </span><a href="#local-6989586621683211949"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621683211947"><span class="hs-identifier hs-var">stupid_theta</span></a><span>
</span><a name="line-1046"></a><span>
</span><a name="line-1047"></a><span class="hs-comment">{-
Note [Arrows and patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~
(Oct 07) Arrow notation has the odd property that it involves
&quot;holes in the scope&quot;. For example:
  expr :: Arrow a =&gt; a () Int
  expr = proc (y,z) -&gt; do
          x &lt;- term -&lt; y
          expr' -&lt; x

Here the 'proc (y,z)' binding scopes over the arrow tails but not the
arrow body (e.g 'term').  As things stand (bogusly) all the
constraints from the proc body are gathered together, so constraints
from 'term' will be seen by the tcPat for (y,z).  But we must *not*
bind constraints from 'term' here, because the desugarer will not make
these bindings scope over 'term'.

The Right Thing is not to confuse these constraints together. But for
now the Easy Thing is to ensure that we do not have existential or
GADT constraints in a 'proc', and to short-cut the constraint
simplification for such vanilla patterns so that it binds no
constraints. Hence the 'fast path' in tcConPat; but it's also a good
plan for ordinary vanilla patterns to bypass the constraint
simplification step.

************************************************************************
*                                                                      *
                Note [Pattern coercions]
*                                                                      *
************************************************************************

In principle, these program would be reasonable:

        f :: (forall a. a-&gt;a) -&gt; Int
        f (x :: Int-&gt;Int) = x 3

        g :: (forall a. [a]) -&gt; Bool
        g [] = True

In both cases, the function type signature restricts what arguments can be passed
in a call (to polymorphic ones).  The pattern type signature then instantiates this
type.  For example, in the first case,  (forall a. a-&gt;a) &lt;= Int -&gt; Int, and we
generate the translated term
        f = \x' :: (forall a. a-&gt;a).  let x = x' Int in x 3

From a type-system point of view, this is perfectly fine, but it's *very* seldom useful.
And it requires a significant amount of code to implement, because we need to decorate
the translated pattern with coercion functions (generated from the subsumption check
by tcSub).

So for now I'm just insisting on type *equality* in patterns.  No subsumption.

Old notes about desugaring, at a time when pattern coercions were handled:

A SigPat is a type coercion and must be handled one at at time.  We can't
combine them unless the type of the pattern inside is identical, and we don't
bother to check for that.  For example:

        data T = T1 Int | T2 Bool
        f :: (forall a. a -&gt; a) -&gt; T -&gt; t
        f (g::Int-&gt;Int)   (T1 i) = T1 (g i)
        f (g::Bool-&gt;Bool) (T2 b) = T2 (g b)

We desugar this as follows:

        f = \ g::(forall a. a-&gt;a) t::T -&gt;
            let gi = g Int
            in case t of { T1 i -&gt; T1 (gi i)
                           other -&gt;
            let gb = g Bool
            in case t of { T2 b -&gt; T2 (gb b)
                           other -&gt; fail }}

Note that we do not treat the first column of patterns as a
column of variables, because the coerced variables (gi, gb)
would be of different types.  So we get rather grotty code.
But I don't think this is a common case, and if it was we could
doubtless improve it.

Meanwhile, the strategy is:
        * treat each SigPat coercion (always non-identity coercions)
                as a separate block
        * deal with the stuff inside, and then wrap a binding round
                the result to bind the new variable (gi, gb, etc)


************************************************************************
*                                                                      *
\subsection{Errors and contexts}
*                                                                      *
************************************************************************

Note [Existential check]
~~~~~~~~~~~~~~~~~~~~~~~~
Lazy patterns can't bind existentials.  They arise in two ways:
  * Let bindings      let { C a b = e } in b
  * Twiddle patterns  f ~(C a b) = e
The pe_lazy field of PatEnv says whether we are inside a lazy
pattern (perhaps deeply)

See also Note [Typechecking pattern bindings] in TcBinds
-}</span><span>
</span><a name="line-1149"></a><span>
</span><a name="line-1150"></a><span class="hs-identifier">maybeWrapPatCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Pat</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211498"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211499"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211498"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683211499"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1151"></a><span class="hs-comment">-- Not all patterns are worth pushing a context</span><span>
</span><a name="line-1152"></a><a name="maybeWrapPatCtxt"><a href="TcPat.html#maybeWrapPatCtxt"><span class="hs-identifier">maybeWrapPatCtxt</span></a></a><span> </span><a name="local-6989586621683211951"><a href="#local-6989586621683211951"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683211952"><a href="#local-6989586621683211952"><span class="hs-identifier">tcm</span></a></a><span> </span><a name="local-6989586621683211953"><a href="#local-6989586621683211953"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1153"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683211954"><span class="hs-identifier hs-var">worth_wrapping</span></a><span> </span><a href="#local-6989586621683211951"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683211952"><span class="hs-identifier hs-var">tcm</span></a><span> </span><a href="#local-6989586621683211953"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1154"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><a href="#local-6989586621683211955"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683211952"><span class="hs-identifier hs-var">tcm</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#popErrCtxt"><span class="hs-identifier hs-var">popErrCtxt</span></a><span> </span><a href="#local-6989586621683211953"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-1155"></a><span>                               </span><span class="hs-comment">-- Remember to pop before doing thing_inside</span><span>
</span><a name="line-1156"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1157"></a><span>   </span><a name="local-6989586621683211954"><a href="#local-6989586621683211954"><span class="hs-identifier">worth_wrapping</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1158"></a><span>   </span><span class="hs-identifier">worth_wrapping</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ParPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1159"></a><span>   </span><span class="hs-identifier">worth_wrapping</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AsPat</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1160"></a><span>   </span><span class="hs-identifier">worth_wrapping</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1161"></a><span>   </span><a name="local-6989586621683211955"><a href="#local-6989586621683211955"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;In the pattern:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211951"><span class="hs-identifier hs-var">pat</span></a><span class="hs-special">)</span><span>
</span><a name="line-1162"></a><span>
</span><a name="line-1163"></a><span class="hs-comment">-----------------------------------------------</span><span>
</span><a name="line-1164"></a><span class="hs-identifier">checkExistentials</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- existentials</span><span>
</span><a name="line-1165"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- argument types</span><span>
</span><a name="line-1166"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcPat.html#PatEnv"><span class="hs-identifier hs-type">PatEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1167"></a><span>    </span><span class="hs-comment">-- See Note [Existential check]]</span><span>
</span><a name="line-1168"></a><span>    </span><span class="hs-comment">-- See Note [Arrows and patterns]</span><span>
</span><a name="line-1169"></a><a name="checkExistentials"><a href="TcPat.html#checkExistentials"><span class="hs-identifier">checkExistentials</span></a></a><span> </span><a name="local-6989586621683211956"><a href="#local-6989586621683211956"><span class="hs-identifier">ex_tvs</span></a></a><span> </span><a name="local-6989586621683211957"><a href="#local-6989586621683211957"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1170"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">tyCoVarsOfTypes</span><span> </span><a href="#local-6989586621683211957"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683211956"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1171"></a><span class="hs-identifier">checkExistentials</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#LetPat"><span class="hs-identifier hs-var">LetPat</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1172"></a><span class="hs-identifier">checkExistentials</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcPat.html#LamPat"><span class="hs-identifier hs-var">LamPat</span></a><span> </span><span class="hs-identifier hs-var">ProcExpr</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="TcPat.html#existentialProcPat"><span class="hs-identifier hs-var">existentialProcPat</span></a><span>
</span><a name="line-1173"></a><span class="hs-identifier">checkExistentials</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TcPat.html#PE"><span class="hs-identifier hs-var">PE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pe_lazy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><a href="TcPat.html#existentialLazyPat"><span class="hs-identifier hs-var">existentialLazyPat</span></a><span>
</span><a name="line-1174"></a><span class="hs-identifier">checkExistentials</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>                                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1175"></a><span>
</span><a name="line-1176"></a><span class="hs-identifier">existentialLazyPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1177"></a><a name="existentialLazyPat"><a href="TcPat.html#existentialLazyPat"><span class="hs-identifier">existentialLazyPat</span></a></a><span>
</span><a name="line-1178"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;An existential or GADT data constructor cannot be used&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1179"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;inside a lazy (~) pattern&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1180"></a><span>
</span><a name="line-1181"></a><span class="hs-identifier">existentialProcPat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1182"></a><a name="existentialProcPat"><a href="TcPat.html#existentialProcPat"><span class="hs-identifier">existentialProcPat</span></a></a><span>
</span><a name="line-1183"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Proc patterns cannot use existential or GADT data constructors&quot;</span><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span class="hs-identifier">badFieldCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ConLike</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FieldLabelString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1186"></a><a name="badFieldCon"><a href="TcPat.html#badFieldCon"><span class="hs-identifier">badFieldCon</span></a></a><span> </span><a name="local-6989586621683211958"><a href="#local-6989586621683211958"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621683211959"><a href="#local-6989586621683211959"><span class="hs-identifier">field</span></a></a><span>
</span><a name="line-1187"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Constructor&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211958"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1188"></a><span>          </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;does not have field&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211959"><span class="hs-identifier hs-var">field</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1189"></a><span>
</span><a name="line-1190"></a><span class="hs-identifier">polyPatSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcType</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1191"></a><a name="polyPatSig"><a href="TcPat.html#polyPatSig"><span class="hs-identifier">polyPatSig</span></a></a><span> </span><a name="local-6989586621683211960"><a href="#local-6989586621683211960"><span class="hs-identifier">sig_ty</span></a></a><span>
</span><a name="line-1192"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal polymorphic type signature in pattern:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1193"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683211960"><span class="hs-identifier hs-var">sig_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1194"></a></pre></body></html>