<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[TcRnDriver]{Typechecking a whole module}

https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/TypeChecker
-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE NondecreasingIndentation #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-18"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcRnDriver</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-21"></a><span>        </span><a href="TcRnDriver.html#tcRnStmt"><span class="hs-identifier hs-var">tcRnStmt</span></a><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#tcRnExpr"><span class="hs-identifier hs-var">tcRnExpr</span></a><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#TcRnExprMode"><span class="hs-identifier hs-type">TcRnExprMode</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#tcRnType"><span class="hs-identifier hs-var">tcRnType</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="TcRnDriver.html#tcRnImportDecls"><span class="hs-identifier hs-var">tcRnImportDecls</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="TcRnDriver.html#tcRnLookupRdrName"><span class="hs-identifier hs-var">tcRnLookupRdrName</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="TcRnDriver.html#getModuleInterface"><span class="hs-identifier hs-var">getModuleInterface</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="TcRnDriver.html#tcRnDeclsi"><span class="hs-identifier hs-var">tcRnDeclsi</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="TcRnDriver.html#isGHCiMonad"><span class="hs-identifier hs-var">isGHCiMonad</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Used by GHC API clients (Trac #8878)</span><span>
</span><a name="line-28"></a><span>        </span><a href="TcRnDriver.html#tcRnLookupName"><span class="hs-identifier hs-var">tcRnLookupName</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="TcRnDriver.html#tcRnGetInfo"><span class="hs-identifier hs-var">tcRnGetInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="TcRnDriver.html#tcRnModule"><span class="hs-identifier hs-var">tcRnModule</span></a><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#tcRnModuleTcRnM"><span class="hs-identifier hs-var">tcRnModuleTcRnM</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="TcRnDriver.html#tcTopSrcDecls"><span class="hs-identifier hs-var">tcTopSrcDecls</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="TcRnDriver.html#rnTopSrcDecls"><span class="hs-identifier hs-var">rnTopSrcDecls</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="TcRnDriver.html#checkBootDecl"><span class="hs-identifier hs-var">checkBootDecl</span></a><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#checkHiBootIface%27"><span class="hs-identifier hs-var">checkHiBootIface'</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="TcBackpack.html#findExtraSigImports"><span class="hs-identifier hs-var">findExtraSigImports</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>        </span><a href="TcBackpack.html#implicitRequirements"><span class="hs-identifier hs-var">implicitRequirements</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="TcBackpack.html#checkUnitId"><span class="hs-identifier hs-var">checkUnitId</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>        </span><a href="TcBackpack.html#mergeSignatures"><span class="hs-identifier hs-var">mergeSignatures</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="TcBackpack.html#tcRnMergeSignatures"><span class="hs-identifier hs-var">tcRnMergeSignatures</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="TcBackpack.html#instantiateSignature"><span class="hs-identifier hs-var">instantiateSignature</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="TcBackpack.html#tcRnInstantiateSignature"><span class="hs-identifier hs-var">tcRnInstantiateSignature</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="TcRnDriver.html#loadUnqualIfaces"><span class="hs-identifier hs-var">loadUnqualIfaces</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><span class="hs-comment">-- More private...</span><span>
</span><a name="line-43"></a><span>        </span><a href="TcRnDriver.html#badReexportedBootThing"><span class="hs-identifier hs-var">badReexportedBootThing</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>        </span><a href="TcRnDriver.html#checkBootDeclM"><span class="hs-identifier hs-var">checkBootDeclM</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>        </span><a href="TcRnDriver.html#missingBootThing"><span class="hs-identifier hs-var">missingBootThing</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>        </span><a href="TcRnDriver.html#getRenamedStuff"><span class="hs-identifier hs-var">getRenamedStuff</span></a><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#RenamedStuff"><span class="hs-identifier hs-type">RenamedStuff</span></a><span>
</span><a name="line-47"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="TcSplice.html"><span class="hs-identifier">TcSplice</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcSplice.html#finishTH"><span class="hs-identifier hs-var">finishTH</span></a><span class="hs-special">,</span><span> </span><a href="TcSplice.html#runRemoteModFinalizers"><span class="hs-identifier hs-var">runRemoteModFinalizers</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="RnSplice.html"><span class="hs-identifier">RnSplice</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="RnSplice.html#rnTopSpliceDecls"><span class="hs-identifier hs-var">rnTopSpliceDecls</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#traceSplice"><span class="hs-identifier hs-var">traceSplice</span></a><span class="hs-special">,</span><span> </span><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier hs-type">SpliceInfo</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="IfaceEnv.html"><span class="hs-identifier">IfaceEnv</span></a><span class="hs-special">(</span><span> </span><a href="IfaceEnv.html#externaliseName"><span class="hs-identifier hs-var">externaliseName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="TcValidity.html"><span class="hs-identifier">TcValidity</span></a><span class="hs-special">(</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="TcMatches.html"><span class="hs-identifier">TcMatches</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span class="hs-special">(</span><span> </span><a href="Inst.html#deeplyInstantiate"><span class="hs-identifier hs-var">deeplyInstantiate</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span class="hs-special">(</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="RnTypes.html"><span class="hs-identifier">RnTypes</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="RnExpr.html"><span class="hs-identifier">RnExpr</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="RnUtils.html"><span class="hs-identifier">RnUtils</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="RnUtils.html#HsDocContext"><span class="hs-identifier hs-type">HsDocContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="RnFixity.html"><span class="hs-identifier">RnFixity</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="RnFixity.html#lookupFixityRn"><span class="hs-identifier hs-var">lookupFixityRn</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">MkId</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="TidyPgm.html"><span class="hs-identifier">TidyPgm</span></a><span>    </span><span class="hs-special">(</span><span> </span><a href="TidyPgm.html#globaliseAndTidyId"><span class="hs-identifier hs-var">globaliseAndTidyId</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TysWiredIn</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Plugins</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DynFlags</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HsSyn</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IfaceSyn</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">ShowSub</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">showToHeader</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IfaceType</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">ShowForAllFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PatSyn</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">pprPatSynType</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">PrelNames</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="PrelInfo.html"><span class="hs-identifier">PrelInfo</span></a><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">RdrName</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="TcExpr.html"><span class="hs-identifier">TcExpr</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnExports.html"><span class="hs-identifier">TcRnExports</span></a><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcEvidence</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">BooleanFormula</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BF</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><a href="PprTyThing.html"><span class="hs-identifier">PprTyThing</span></a><span class="hs-special">(</span><span> </span><a href="PprTyThing.html#pprTyThingInContext"><span class="hs-identifier hs-var">pprTyThingInContext</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreFVs</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">orphNamesOfFamInst</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">InstEnv</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FamInstEnv</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pprFamInst</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">famInstsRepTyCons</span><span>
</span><a name="line-86"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">famInstEnvElts</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">extendFamInstEnvList</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">normaliseType</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><a href="TcAnnotations.html"><span class="hs-identifier">TcAnnotations</span></a><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span> </span><a href="TcBinds.html"><span class="hs-identifier">TcBinds</span></a><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><a href="MkIface.html"><span class="hs-identifier">MkIface</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="MkIface.html#coAxiomToIfaceDecl"><span class="hs-identifier hs-var">coAxiomToIfaceDecl</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HeaderInfo</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkPrelImports</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><a href="TcDefaults.html"><span class="hs-identifier">TcDefaults</span></a><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><a href="TcRules.html"><span class="hs-identifier">TcRules</span></a><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><a href="TcForeign.html"><span class="hs-identifier">TcForeign</span></a><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><a href="TcInstDcls.html"><span class="hs-identifier">TcInstDcls</span></a><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><a href="TcIface.html"><span class="hs-identifier">TcIface</span></a><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TcType</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><a href="TcSimplify.html"><span class="hs-identifier">TcSimplify</span></a><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><a href="TcTyClsDecls.html"><span class="hs-identifier">TcTyClsDecls</span></a><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><a href="TcTypeable.html"><span class="hs-identifier">TcTypeable</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcTypeable.html#mkTypeableBinds"><span class="hs-identifier hs-var">mkTypeableBinds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><a href="TcBackpack.html"><span class="hs-identifier">TcBackpack</span></a><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><a href="LoadIface.html"><span class="hs-identifier">LoadIface</span></a><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><a href="RnNames.html"><span class="hs-identifier">RnNames</span></a><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><a href="RnSource.html"><span class="hs-identifier">RnSource</span></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ErrUtils</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">IdInfo</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">IdDetails</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Module</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UniqFM</span><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Name</span><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameSet</span><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Avail</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">TyCon</span><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">SrcLoc</span><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">HscTypes</span><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ListSetOps</span><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">ConLike</span><span>
</span><a name="line-123"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Type</span><span>
</span><a name="line-125"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Class</span><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">BasicTypes</span><span> </span><span class="hs-keyword">hiding</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SuccessFlag</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoAxiom</span><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Annotations</span><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sort</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Bag</span><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><a href="Inst.html"><span class="hs-identifier">Inst</span></a><span> </span><span class="hs-special">(</span><a href="Inst.html#tcGetInsts"><span class="hs-identifier hs-var">tcGetInsts</span></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.LanguageExtensions</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-137"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Data</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span class="hs-keyword">import</span><span> </span><a href="HsDumpAst.html"><span class="hs-identifier">HsDumpAst</span></a><span>
</span><a name="line-139"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">S</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.DeepSeq</span><span>
</span><a name="line-142"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-146"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Typecheck and rename a module
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-comment">-- | Top level entry point for typechecker and renamer</span><span>
</span><a name="line-155"></a><span class="hs-identifier">tcRnModule</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-156"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-157"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>              </span><span class="hs-comment">-- True &lt;=&gt; save renamed syntax</span><span>
</span><a name="line-158"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsParsedModule</span><span>
</span><a name="line-159"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><a name="tcRnModule"><a href="TcRnDriver.html#tcRnModule"><span class="hs-identifier">tcRnModule</span></a></a><span> </span><a name="local-6989586621683872486"><a href="#local-6989586621683872486"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683872487"><a href="#local-6989586621683872487"><span class="hs-identifier">mod_sum</span></a></a><span> </span><a name="local-6989586621683872488"><a href="#local-6989586621683872488"><span class="hs-identifier">save_rn_syntax</span></a></a><span>
</span><a name="line-162"></a><span>   </span><a name="local-6989586621683872489"><a href="#local-6989586621683872489"><span class="hs-identifier">parsedModule</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">HsParsedModule</span><span> </span><span class="hs-special">{</span><span class="hs-identifier">hpm_module</span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683872490"><a href="#local-6989586621683872490"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683872491"><a href="#local-6989586621683872491"><span class="hs-identifier">this_module</span></a></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-163"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">RealSrcSpan</span><span> </span><a name="local-6989586621683872500"><a href="#local-6989586621683872500"><span class="hs-identifier">real_loc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872490"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-164"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withTiming</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621683872493"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Renamer/typechecker&quot;</span><span class="hs-operator hs-var">&lt;+&gt;</span><span class="hs-identifier hs-var">brackets</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872497"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-167"></a><span>   </span><a href="TcRnMonad.html#initTc"><span class="hs-identifier hs-var">initTc</span></a><span> </span><a href="#local-6989586621683872486"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683872492"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621683872488"><span class="hs-identifier hs-var">save_rn_syntax</span></a><span> </span><a href="#local-6989586621683872497"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><a href="#local-6989586621683872500"><span class="hs-identifier hs-var">real_loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-168"></a><span>          </span><a href="TcRnDriver.html#withTcPlugins"><span class="hs-identifier hs-var">withTcPlugins</span></a><span> </span><a href="#local-6989586621683872486"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span>          </span><a href="TcRnDriver.html#tcRnModuleTcRnM"><span class="hs-identifier hs-var">tcRnModuleTcRnM</span></a><span> </span><a href="#local-6989586621683872486"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683872487"><span class="hs-identifier hs-var">mod_sum</span></a><span> </span><a href="#local-6989586621683872489"><span class="hs-identifier hs-var">parsedModule</span></a><span> </span><a href="#local-6989586621683872496"><span class="hs-identifier hs-var">pair</span></a><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621683872494"><span class="hs-identifier hs-var">err_msg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-176"></a><span>    </span><a name="local-6989586621683872492"><a href="#local-6989586621683872492"><span class="hs-identifier">hsc_src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621683872487"><span class="hs-identifier hs-var">mod_sum</span></a><span>
</span><a name="line-177"></a><span>    </span><a name="local-6989586621683872493"><a href="#local-6989586621683872493"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621683872486"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-178"></a><span>    </span><a name="local-6989586621683872494"><a href="#local-6989586621683872494"><span class="hs-identifier">err_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPlainErrMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621683872486"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872490"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-179"></a><span>              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module does not have a RealSrcSpan:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872497"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span>    </span><a name="local-6989586621683872495"><a href="#local-6989586621683872495"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621683872486"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier">pair</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>    </span><a name="local-6989586621683872496"><a href="#local-6989586621683872496"><span class="hs-identifier">pair</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683872497"><a href="#local-6989586621683872497"><span class="hs-identifier">this_mod</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683872498"><a href="#local-6989586621683872498"><span class="hs-identifier">mod_loc</span></a></a><span> </span><a name="local-6989586621683872499"><a href="#local-6989586621683872499"><span class="hs-identifier">mod</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">hsmodName</span><span> </span><a href="#local-6989586621683872491"><span class="hs-identifier hs-var">this_module</span></a><span>
</span><a name="line-186"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModule</span><span> </span><a href="#local-6989586621683872495"><span class="hs-identifier hs-var">this_pkg</span></a><span> </span><a href="#local-6989586621683872499"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872498"><span class="hs-identifier hs-var">mod_loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- 'module M where' is omitted</span><span>
</span><a name="line-189"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mAIN</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">srcLocSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">srcSpanStart</span><span> </span><a href="#local-6989586621683872490"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-identifier">tcRnModuleTcRnM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-195"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span>
</span><a name="line-196"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsParsedModule</span><span>
</span><a name="line-197"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Module</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SrcSpan</span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- Factored out separately from tcRnModule so that a Core plugin can</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- call the type checker directly</span><span>
</span><a name="line-201"></a><a name="tcRnModuleTcRnM"><a href="TcRnDriver.html#tcRnModuleTcRnM"><span class="hs-identifier">tcRnModuleTcRnM</span></a></a><span> </span><a name="local-6989586621683872501"><a href="#local-6989586621683872501"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683872502"><a href="#local-6989586621683872502"><span class="hs-identifier">mod_sum</span></a></a><span>
</span><a name="line-202"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsParsedModule</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-203"></a><span>                   </span><span class="hs-identifier">hpm_module</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-204"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683872503"><a href="#local-6989586621683872503"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsModule</span><span> </span><a name="local-6989586621683872504"><a href="#local-6989586621683872504"><span class="hs-identifier">maybe_mod</span></a></a><span> </span><a name="local-6989586621683872505"><a href="#local-6989586621683872505"><span class="hs-identifier">export_ies</span></a></a><span>
</span><a name="line-205"></a><span>                                       </span><a name="local-6989586621683872506"><a href="#local-6989586621683872506"><span class="hs-identifier">import_decls</span></a></a><span> </span><a name="local-6989586621683872507"><a href="#local-6989586621683872507"><span class="hs-identifier">local_decls</span></a></a><span> </span><a name="local-6989586621683872508"><a href="#local-6989586621683872508"><span class="hs-identifier">mod_deprec</span></a></a><span>
</span><a name="line-206"></a><span>                                       </span><a name="local-6989586621683872509"><a href="#local-6989586621683872509"><span class="hs-identifier">maybe_doc_hdr</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-207"></a><span>                   </span><span class="hs-identifier">hpm_src_files</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872510"><a href="#local-6989586621683872510"><span class="hs-identifier">src_files</span></a></a><span>
</span><a name="line-208"></a><span>                </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621683872511"><a href="#local-6989586621683872511"><span class="hs-identifier">this_mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872512"><a href="#local-6989586621683872512"><span class="hs-identifier">prel_imp_loc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683872503"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-211"></a><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872513"><a href="#local-6989586621683872513"><span class="hs-identifier">explicit_mod_hdr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621683872504"><span class="hs-identifier hs-var">maybe_mod</span></a><span>
</span><a name="line-212"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872514"><a href="#local-6989586621683872514"><span class="hs-identifier">hsc_src</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ms_hsc_src</span><span> </span><a href="#local-6989586621683872502"><span class="hs-identifier hs-var">mod_sum</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-213"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- Load the hi-boot interface for this module, if any</span><span>
</span><a name="line-214"></a><span>        </span><span class="hs-comment">-- We do this now so that the boot_names can be passed</span><span>
</span><a name="line-215"></a><span>        </span><span class="hs-comment">-- to tcTyAndClassDecls, because the boot_names are</span><span>
</span><a name="line-216"></a><span>        </span><span class="hs-comment">-- automatically considered to be loop breakers</span><span>
</span><a name="line-217"></a><span>        </span><a name="local-6989586621683872515"><a href="#local-6989586621683872515"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-218"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872516"><a href="#local-6989586621683872516"><span class="hs-identifier">boot_info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcIface.html#tcHiBootIface"><span class="hs-identifier hs-var">tcHiBootIface</span></a><span> </span><a href="#local-6989586621683872514"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621683872511"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-219"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872515"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_self_boot</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872516"><span class="hs-identifier hs-var">boot_info</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>        </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-221"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Deal with imports; first add implicit prelude</span><span>
</span><a name="line-222"></a><span>          </span><a name="local-6989586621683872517"><a href="#local-6989586621683872517"><span class="hs-identifier">implicit_prelude</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.ImplicitPrelude</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872518"><a href="#local-6989586621683872518"><span class="hs-identifier">prel_imports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkPrelImports</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621683872511"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872512"><span class="hs-identifier hs-var">prel_imp_loc</span></a><span>
</span><a name="line-224"></a><span>                               </span><a href="#local-6989586621683872517"><span class="hs-identifier hs-var">implicit_prelude</span></a><span> </span><a href="#local-6989586621683872506"><span class="hs-identifier hs-var">import_decls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#whenWOptM"><span class="hs-identifier hs-var">whenWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnImplicitPrelude</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-227"></a><span>             </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">notNull</span><span> </span><a href="#local-6989586621683872518"><span class="hs-identifier hs-var">prel_imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-228"></a><span>                </span><a href="TcRnMonad.html#addWarn"><span class="hs-identifier hs-var">addWarn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><span class="hs-identifier hs-var">Opt_WarnImplicitPrelude</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#implicitPreludeWarn"><span class="hs-identifier hs-var">implicitPreludeWarn</span></a><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- TODO This is a little skeevy; maybe handle a bit more directly</span><span>
</span><a name="line-231"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872519"><a href="#local-6989586621683872519"><span class="hs-identifier">simplifyImport</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683872520"><a href="#local-6989586621683872520"><span class="hs-identifier">idecl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-232"></a><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">sl_fs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ideclPkgQual</span><span> </span><a href="#local-6989586621683872520"><span class="hs-identifier hs-var">idecl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ideclName</span><span> </span><a href="#local-6989586621683872520"><span class="hs-identifier hs-var">idecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872521"><a href="#local-6989586621683872521"><span class="hs-identifier">raw_sig_imports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span>
</span><a name="line-235"></a><span>                             </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcBackpack.html#findExtraSigImports"><span class="hs-identifier hs-var">findExtraSigImports</span></a><span> </span><a href="#local-6989586621683872501"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683872514"><span class="hs-identifier hs-var">hsc_src</span></a><span>
</span><a name="line-236"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621683872511"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872522"><a href="#local-6989586621683872522"><span class="hs-identifier">raw_req_imports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span>
</span><a name="line-238"></a><span>                             </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcBackpack.html#implicitRequirements"><span class="hs-identifier hs-var">implicitRequirements</span></a><span> </span><a href="#local-6989586621683872501"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-239"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683872519"><span class="hs-identifier hs-var">simplifyImport</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872518"><span class="hs-identifier hs-var">prel_imports</span></a><span>
</span><a name="line-240"></a><span>                                                     </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872506"><span class="hs-identifier hs-var">import_decls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872523"><a href="#local-6989586621683872523"><span class="hs-identifier">mkImport</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683872524"><a href="#local-6989586621683872524"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span>
</span><a name="line-242"></a><span>                </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">simpleImportDecl</span><span> </span><a href="#local-6989586621683872524"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>                  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ideclHiding</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-244"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">mkImport</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;mkImport&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872525"><a href="#local-6989586621683872525"><span class="hs-identifier">all_imports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872518"><span class="hs-identifier hs-var">prel_imports</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872506"><span class="hs-identifier hs-var">import_decls</span></a><span>
</span><a name="line-246"></a><span>                       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683872523"><span class="hs-identifier hs-var">mkImport</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872521"><span class="hs-identifier hs-var">raw_sig_imports</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872522"><span class="hs-identifier hs-var">raw_req_imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-247"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- OK now finally rename the imports</span><span>
</span><a name="line-248"></a><span>          </span><a name="local-6989586621683872526"><a href="#local-6989586621683872526"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;tcRnImports&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-249"></a><span>                     </span><a href="TcRnDriver.html#tcRnImports"><span class="hs-identifier hs-var">tcRnImports</span></a><span> </span><a href="#local-6989586621683872501"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683872525"><span class="hs-identifier hs-var">all_imports</span></a><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- If the whole module is warned about or deprecated</span><span>
</span><a name="line-252"></a><span>          </span><span class="hs-comment">-- (via mod_deprec) record that in tcg_warns. If we do thereby add</span><span>
</span><a name="line-253"></a><span>          </span><span class="hs-comment">-- a WarnAll, it will override any subsequent deprecations added to tcg_warns</span><span>
</span><a name="line-254"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872527"><a href="#local-6989586621683872527"><span class="hs-identifier">tcg_env1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683872508"><span class="hs-identifier hs-var">mod_deprec</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-255"></a><span>                             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683872528"><a href="#local-6989586621683872528"><span class="hs-identifier">txt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-256"></a><span>                               </span><a href="#local-6989586621683872526"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">tcg_warns</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">WarnAll</span><span> </span><a href="#local-6989586621683872528"><span class="hs-identifier hs-var">txt</span></a><span class="hs-special">}</span><span>
</span><a name="line-257"></a><span>                             </span><span class="hs-identifier hs-var">Nothing</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683872526"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-258"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-259"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872527"><span class="hs-identifier hs-var">tcg_env1</span></a><span>
</span><a name="line-260"></a><span>          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Rename and type check the declarations</span><span>
</span><a name="line-261"></a><span>                 </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn1a&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-262"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872529"><a href="#local-6989586621683872529"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isHsBootOrSig</span><span> </span><a href="#local-6989586621683872514"><span class="hs-identifier hs-var">hsc_src</span></a><span>
</span><a name="line-263"></a><span>                            </span><span class="hs-keyword">then</span><span> </span><a href="TcRnDriver.html#tcRnHsBootDecls"><span class="hs-identifier hs-var">tcRnHsBootDecls</span></a><span> </span><a href="#local-6989586621683872514"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621683872507"><span class="hs-identifier hs-var">local_decls</span></a><span>
</span><a name="line-264"></a><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;tcRnSrcDecls&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-265"></a><span>                                 </span><a href="TcRnDriver.html#tcRnSrcDecls"><span class="hs-identifier hs-var">tcRnSrcDecls</span></a><span> </span><a href="#local-6989586621683872513"><span class="hs-identifier hs-var">explicit_mod_hdr</span></a><span> </span><a href="#local-6989586621683872507"><span class="hs-identifier hs-var">local_decls</span></a><span>
</span><a name="line-266"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872529"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-267"></a><span>                 </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Process the export list</span><span>
</span><a name="line-268"></a><span>                        </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn4a: before exports&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-269"></a><span>                      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872530"><a href="#local-6989586621683872530"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnExports.html#tcRnExports"><span class="hs-identifier hs-var">tcRnExports</span></a><span> </span><a href="#local-6989586621683872513"><span class="hs-identifier hs-var">explicit_mod_hdr</span></a><span> </span><a href="#local-6989586621683872505"><span class="hs-identifier hs-var">export_ies</span></a><span>
</span><a name="line-270"></a><span>                                     </span><a href="#local-6989586621683872529"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-271"></a><span>                      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn4b: after exports&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-272"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- Check main is exported(must be after tcRnExports)</span><span>
</span><a name="line-273"></a><span>                        </span><a href="TcRnDriver.html#checkMainExported"><span class="hs-identifier hs-var">checkMainExported</span></a><span> </span><a href="#local-6989586621683872530"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-274"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- Compare hi-boot iface (if any) with the real thing</span><span>
</span><a name="line-275"></a><span>                        </span><span class="hs-comment">-- Must be done after processing the exports</span><span>
</span><a name="line-276"></a><span>                        </span><a name="local-6989586621683872531"><a href="#local-6989586621683872531"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#checkHiBootIface"><span class="hs-identifier hs-var">checkHiBootIface</span></a><span> </span><a href="#local-6989586621683872530"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><a href="#local-6989586621683872516"><span class="hs-identifier hs-var">boot_info</span></a><span>
</span><a name="line-277"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- The new type env is already available to stuff</span><span>
</span><a name="line-278"></a><span>                        </span><span class="hs-comment">-- slurped from interface files, via</span><span>
</span><a name="line-279"></a><span>                        </span><span class="hs-comment">-- TcEnv.setGlobalTypeEnv. It's important that this</span><span>
</span><a name="line-280"></a><span>                        </span><span class="hs-comment">-- includes the stuff in checkHiBootIface,</span><span>
</span><a name="line-281"></a><span>                        </span><span class="hs-comment">-- because the latter might add new bindings for</span><span>
</span><a name="line-282"></a><span>                        </span><span class="hs-comment">-- boot_dfuns, which may be mentioned in imported</span><span>
</span><a name="line-283"></a><span>                        </span><span class="hs-comment">-- unfoldings.</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span>                        </span><span class="hs-comment">-- Don't need to rename the Haddock documentation,</span><span>
</span><a name="line-286"></a><span>                        </span><span class="hs-comment">-- it's not parsed by GHC anymore.</span><span>
</span><a name="line-287"></a><span>                        </span><a name="local-6989586621683872532"><a href="#local-6989586621683872532"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872531"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-288"></a><span>                                           </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_doc_hdr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872509"><span class="hs-identifier hs-var">maybe_doc_hdr</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- Report unused names</span><span>
</span><a name="line-290"></a><span>                        </span><span class="hs-comment">-- Do this /after/ typeinference, so that when reporting</span><span>
</span><a name="line-291"></a><span>                        </span><span class="hs-comment">-- a function with no type signature we can give the</span><span>
</span><a name="line-292"></a><span>                        </span><span class="hs-comment">-- inferred type</span><span>
</span><a name="line-293"></a><span>                        </span><a href="RnNames.html#reportUnusedNames"><span class="hs-identifier hs-var">reportUnusedNames</span></a><span> </span><a href="#local-6989586621683872505"><span class="hs-identifier hs-var">export_ies</span></a><span> </span><a href="#local-6989586621683872532"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-294"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- add extra source files to tcg_dependent_files</span><span>
</span><a name="line-295"></a><span>                        </span><a href="TcRnMonad.html#addDependentFiles"><span class="hs-identifier hs-var">addDependentFiles</span></a><span> </span><a href="#local-6989586621683872510"><span class="hs-identifier hs-var">src_files</span></a><span>
</span><a name="line-296"></a><span>                      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872533"><a href="#local-6989586621683872533"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#runTypecheckerPlugin"><span class="hs-identifier hs-var">runTypecheckerPlugin</span></a><span> </span><a href="#local-6989586621683872502"><span class="hs-identifier hs-var">mod_sum</span></a><span> </span><a href="#local-6989586621683872501"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683872532"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-297"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- Dump output and return</span><span>
</span><a name="line-298"></a><span>                        </span><a href="TcRnDriver.html#tcDump"><span class="hs-identifier hs-var">tcDump</span></a><span> </span><a href="#local-6989586621683872533"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-299"></a><span>                      </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683872533"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-300"></a><span>               </span><span class="hs-special">}</span><span>
</span><a name="line-301"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-302"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-identifier">implicitPreludeWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-305"></a><a name="implicitPreludeWarn"><a href="TcRnDriver.html#implicitPreludeWarn"><span class="hs-identifier">implicitPreludeWarn</span></a></a><span>
</span><a name="line-306"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Module `Prelude' implicitly imported&quot;</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Import declarations
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-identifier">tcRnImports</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-317"></a><a name="tcRnImports"><a href="TcRnDriver.html#tcRnImports"><span class="hs-identifier">tcRnImports</span></a></a><span> </span><a name="local-6989586621683872534"><a href="#local-6989586621683872534"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683872535"><a href="#local-6989586621683872535"><span class="hs-identifier">import_decls</span></a></a><span>
</span><a name="line-318"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872536"><a href="#local-6989586621683872536"><span class="hs-identifier">rn_imports</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872537"><a href="#local-6989586621683872537"><span class="hs-identifier">rdr_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872538"><a href="#local-6989586621683872538"><span class="hs-identifier">imports</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872539"><a href="#local-6989586621683872539"><span class="hs-identifier">hpc_info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnNames.html#rnImports"><span class="hs-identifier hs-var">rnImports</span></a><span> </span><a href="#local-6989586621683872535"><span class="hs-identifier hs-var">import_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872540"><a href="#local-6989586621683872540"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span>
</span><a name="line-321"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dep_mods</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ModuleName</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IsBootInterface</span><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872541"><a href="#local-6989586621683872541"><span class="hs-identifier">dep_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">imp_dep_mods</span><span> </span><a href="#local-6989586621683872538"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span>                </span><span class="hs-comment">-- We want instance declarations from all home-package</span><span>
</span><a name="line-325"></a><span>                </span><span class="hs-comment">-- modules below this one, including boot modules, except</span><span>
</span><a name="line-326"></a><span>                </span><span class="hs-comment">-- ourselves.  The 'except ourselves' is so that we don't</span><span>
</span><a name="line-327"></a><span>                </span><span class="hs-comment">-- get the instances from this module's hs-boot file.  This</span><span>
</span><a name="line-328"></a><span>                </span><span class="hs-comment">-- filtering also ensures that we don't see instances from</span><span>
</span><a name="line-329"></a><span>                </span><span class="hs-comment">-- modules batch (@--make@) compiled before this one, but</span><span>
</span><a name="line-330"></a><span>                </span><span class="hs-comment">-- which are not below this one.</span><span>
</span><a name="line-331"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">want_instances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModuleName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-332"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872542"><a href="#local-6989586621683872542"><span class="hs-identifier">want_instances</span></a></a><span> </span><a name="local-6989586621683872545"><a href="#local-6989586621683872545"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872545"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemUFM</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872541"><span class="hs-identifier hs-var">dep_mods</span></a><span>
</span><a name="line-333"></a><span>                                   </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683872545"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621683872540"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-334"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872543"><a href="#local-6989586621683872543"><span class="hs-identifier">home_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872544"><a href="#local-6989586621683872544"><span class="hs-identifier">home_fam_insts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hptInstances</span><span> </span><a href="#local-6989586621683872534"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-335"></a><span>                                                            </span><a href="#local-6989586621683872542"><span class="hs-identifier hs-var">want_instances</span></a><span>
</span><a name="line-336"></a><span>              </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-337"></a><span>
</span><a name="line-338"></a><span>                </span><span class="hs-comment">-- Record boot-file info in the EPS, so that it's</span><span>
</span><a name="line-339"></a><span>                </span><span class="hs-comment">-- visible to loadHiBootInterface in tcRnSrcDecls,</span><span>
</span><a name="line-340"></a><span>                </span><span class="hs-comment">-- and any other incrementally-performed imports</span><span>
</span><a name="line-341"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updateEps_"><span class="hs-identifier hs-var">updateEps_</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683872546"><a href="#local-6989586621683872546"><span class="hs-identifier">eps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683872546"><span class="hs-identifier hs-var">eps</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">eps_is_boot</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872541"><span class="hs-identifier hs-var">dep_mods</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span>                </span><span class="hs-comment">-- Update the gbl env</span><span>
</span><a name="line-344"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier hs-var">updGblEnv</span></a><span> </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683872547"><a href="#local-6989586621683872547"><span class="hs-identifier">gbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-345"></a><span>            </span><a href="#local-6989586621683872547"><span class="hs-identifier hs-var">gbl</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-346"></a><span>              </span><span class="hs-identifier">tcg_rdr_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_rdr_env</span><span> </span><a href="#local-6989586621683872547"><span class="hs-identifier hs-var">gbl</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusGlobalRdrEnv</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872537"><span class="hs-identifier hs-var">rdr_env</span></a><span class="hs-special">,</span><span>
</span><a name="line-347"></a><span>              </span><span class="hs-identifier">tcg_imports</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_imports</span><span> </span><a href="#local-6989586621683872547"><span class="hs-identifier hs-var">gbl</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusImportAvails</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872538"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">,</span><span>
</span><a name="line-348"></a><span>              </span><span class="hs-identifier">tcg_rn_imports</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872536"><span class="hs-identifier hs-var">rn_imports</span></a><span class="hs-special">,</span><span>
</span><a name="line-349"></a><span>              </span><span class="hs-identifier">tcg_inst_env</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInstEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_inst_env</span><span> </span><a href="#local-6989586621683872547"><span class="hs-identifier hs-var">gbl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872543"><span class="hs-identifier hs-var">home_insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-350"></a><span>              </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendFamInstEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><a href="#local-6989586621683872547"><span class="hs-identifier hs-var">gbl</span></a><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>                                                      </span><a href="#local-6989586621683872544"><span class="hs-identifier hs-var">home_fam_insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-352"></a><span>              </span><span class="hs-identifier">tcg_hpc</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872539"><span class="hs-identifier hs-var">hpc_info</span></a><span>
</span><a name="line-353"></a><span>            </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn1&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_dep_mods</span><span> </span><a href="#local-6989586621683872538"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>                </span><span class="hs-comment">-- Fail if there are any errors so far</span><span>
</span><a name="line-357"></a><span>                </span><span class="hs-comment">-- The error printing (if needed) takes advantage</span><span>
</span><a name="line-358"></a><span>                </span><span class="hs-comment">-- of the tcg_env we have now set</span><span>
</span><a name="line-359"></a><span class="hs-comment">--      ; traceIf (text &quot;rdr_env: &quot; &lt;+&gt; ppr rdr_env)</span><span>
</span><a name="line-360"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span>                </span><span class="hs-comment">-- Load any orphan-module (including orphan family</span><span>
</span><a name="line-363"></a><span>                </span><span class="hs-comment">-- instance-module) interfaces, so that their rules and</span><span>
</span><a name="line-364"></a><span>                </span><span class="hs-comment">-- instance decls will be found.  But filter out a</span><span>
</span><a name="line-365"></a><span>                </span><span class="hs-comment">-- self hs-boot: these instances will be checked when</span><span>
</span><a name="line-366"></a><span>                </span><span class="hs-comment">-- we define them locally.</span><span>
</span><a name="line-367"></a><span>                </span><span class="hs-comment">-- (We don't need to load non-orphan family instance</span><span>
</span><a name="line-368"></a><span>                </span><span class="hs-comment">-- modules until we either try to use the instances they</span><span>
</span><a name="line-369"></a><span>                </span><span class="hs-comment">-- define, or define our own family instances, at which</span><span>
</span><a name="line-370"></a><span>                </span><span class="hs-comment">-- point we need to check them for consistency.)</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="LoadIface.html#loadModuleInterfaces"><span class="hs-identifier hs-var">loadModuleInterfaces</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Loading orphan modules&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-372"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621683872540"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_orphs</span><span> </span><a href="#local-6989586621683872538"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span>                </span><span class="hs-comment">-- Check type-family consistency between imports.</span><span>
</span><a name="line-375"></a><span>                </span><span class="hs-comment">-- See Note [The type family instance consistency story]</span><span>
</span><a name="line-376"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn1: checking family instance consistency {&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-377"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872548"><a href="#local-6989586621683872548"><span class="hs-identifier">dir_imp_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">moduleEnvKeys</span><span>
</span><a name="line-378"></a><span>                             </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">imp_mods</span><span>
</span><a name="line-379"></a><span>                             </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683872538"><span class="hs-identifier hs-var">imports</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-380"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="FamInst.html#checkFamInstConsistency"><span class="hs-identifier hs-var">checkFamInstConsistency</span></a><span> </span><a href="#local-6989586621683872548"><span class="hs-identifier hs-var">dir_imp_mods</span></a><span>
</span><a name="line-381"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn1: } checking family instance consistency&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Type-checking the top level of a module
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span class="hs-identifier">tcRnSrcDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- False =&gt; no 'module M(..) where' header at all</span><span>
</span><a name="line-394"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- Declarations</span><span>
</span><a name="line-395"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-396"></a><a name="tcRnSrcDecls"><a href="TcRnDriver.html#tcRnSrcDecls"><span class="hs-identifier">tcRnSrcDecls</span></a></a><span> </span><a name="local-6989586621683872549"><a href="#local-6989586621683872549"><span class="hs-identifier">explicit_mod_hdr</span></a></a><span> </span><a name="local-6989586621683872550"><a href="#local-6989586621683872550"><span class="hs-identifier">decls</span></a></a><span>
</span><a name="line-397"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Do all the declarations</span><span>
</span><a name="line-398"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872551"><a href="#local-6989586621683872551"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872552"><a href="#local-6989586621683872552"><span class="hs-identifier">tcl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872553"><a href="#local-6989586621683872553"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#tc_rn_src_decls"><span class="hs-identifier hs-var">tc_rn_src_decls</span></a><span> </span><a href="#local-6989586621683872550"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span>        </span><span class="hs-comment">-- Check for the 'main' declaration</span><span>
</span><a name="line-401"></a><span>        </span><span class="hs-comment">-- Must do this inside the captureTopConstraints</span><span>
</span><a name="line-402"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872554"><a href="#local-6989586621683872554"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872555"><a href="#local-6989586621683872555"><span class="hs-identifier">lie_main</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872551"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872552"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-403"></a><span>                               </span><span class="hs-comment">-- always set envs *before* captureTopConstraints</span><span>
</span><a name="line-404"></a><span>                               </span><a href="TcSimplify.html#captureTopConstraints"><span class="hs-identifier hs-var">captureTopConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-405"></a><span>                               </span><a href="TcRnDriver.html#checkMain"><span class="hs-identifier hs-var">checkMain</span></a><span> </span><a href="#local-6989586621683872549"><span class="hs-identifier hs-var">explicit_mod_hdr</span></a><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872554"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872552"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span>             </span><span class="hs-comment">--         Simplify constraints</span><span>
</span><a name="line-410"></a><span>             </span><span class="hs-comment">--</span><span>
</span><a name="line-411"></a><span>             </span><span class="hs-comment">-- We do this after checkMain, so that we use the type info</span><span>
</span><a name="line-412"></a><span>             </span><span class="hs-comment">-- that checkMain adds</span><span>
</span><a name="line-413"></a><span>             </span><span class="hs-comment">--</span><span>
</span><a name="line-414"></a><span>             </span><span class="hs-comment">-- We do it with both global and local env in scope:</span><span>
</span><a name="line-415"></a><span>             </span><span class="hs-comment">--  * the global env exposes the instances to simplifyTop</span><span>
</span><a name="line-416"></a><span>             </span><span class="hs-comment">--  * the local env exposes the local Ids to simplifyTop,</span><span>
</span><a name="line-417"></a><span>             </span><span class="hs-comment">--    so that we get better error messages (monomorphism restriction)</span><span>
</span><a name="line-418"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872556"><a href="#local-6989586621683872556"><span class="hs-identifier">new_ev_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;simplifyTop&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-419"></a><span>                        </span><a href="TcSimplify.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872553"><span class="hs-identifier hs-var">lie</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andWC</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872555"><span class="hs-identifier hs-var">lie_main</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span>        </span><span class="hs-comment">-- Emit Typeable bindings</span><span>
</span><a name="line-422"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872557"><a href="#local-6989586621683872557"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#mkTypeableBinds"><span class="hs-identifier hs-var">mkTypeableBinds</span></a><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span>
</span><a name="line-425"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc9&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span>     </span><span class="hs-comment">-- Don't zonk if there have been errors</span><span>
</span><a name="line-428"></a><span>                        </span><span class="hs-comment">-- It's a waste of time; and we may get debug warnings</span><span>
</span><a name="line-429"></a><span>                        </span><span class="hs-comment">-- about strangely-typed TyCons!</span><span>
</span><a name="line-430"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc10&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span>        </span><span class="hs-comment">-- Zonk the final code.  This must be done last.</span><span>
</span><a name="line-433"></a><span>        </span><span class="hs-comment">-- Even simplifyTop may do some unification.</span><span>
</span><a name="line-434"></a><span>        </span><span class="hs-comment">-- This pass also warns about missing type signatures</span><span>
</span><a name="line-435"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872558"><a href="#local-6989586621683872558"><span class="hs-identifier">bind_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872559"><a href="#local-6989586621683872559"><span class="hs-identifier">ev_binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872560"><a href="#local-6989586621683872560"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872561"><a href="#local-6989586621683872561"><span class="hs-identifier">fords'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872562"><a href="#local-6989586621683872562"><span class="hs-identifier">imp_specs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872563"><a href="#local-6989586621683872563"><span class="hs-identifier">rules'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-436"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#zonkTcGblEnv"><span class="hs-identifier hs-var">zonkTcGblEnv</span></a><span> </span><a href="#local-6989586621683872556"><span class="hs-identifier hs-var">new_ev_binds</span></a><span> </span><a href="#local-6989586621683872557"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span>        </span><span class="hs-comment">-- Finalizers must run after constraints are simplified, or some types</span><span>
</span><a name="line-439"></a><span>        </span><span class="hs-comment">-- might not be complete when using reify (see #12777).</span><span>
</span><a name="line-440"></a><span>        </span><span class="hs-comment">-- and also after we zonk the first time because we run typed splices</span><span>
</span><a name="line-441"></a><span>        </span><span class="hs-comment">-- in the zonker which gives rise to the finalisers.</span><span>
</span><a name="line-442"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872564"><a href="#local-6989586621683872564"><span class="hs-identifier">tcg_env_mf</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#clearTcGblEnv"><span class="hs-identifier hs-var">clearTcGblEnv</span></a><span> </span><a href="#local-6989586621683872557"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-443"></a><span>                                     </span><a href="TcRnDriver.html#run_th_modfinalizers"><span class="hs-identifier hs-var">run_th_modfinalizers</span></a><span>
</span><a name="line-444"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcSplice.html#finishTH"><span class="hs-identifier hs-var">finishTH</span></a><span>
</span><a name="line-445"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc11&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-comment">-- zonk the new bindings arising from running the finalisers.</span><span>
</span><a name="line-448"></a><span>        </span><span class="hs-comment">-- This won't give rise to any more finalisers as you can't nest</span><span>
</span><a name="line-449"></a><span>        </span><span class="hs-comment">-- finalisers inside finalisers.</span><span>
</span><a name="line-450"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872565"><a href="#local-6989586621683872565"><span class="hs-identifier">bind_env_mf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872566"><a href="#local-6989586621683872566"><span class="hs-identifier">ev_binds_mf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872567"><a href="#local-6989586621683872567"><span class="hs-identifier">binds_mf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872568"><a href="#local-6989586621683872568"><span class="hs-identifier">fords_mf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872569"><a href="#local-6989586621683872569"><span class="hs-identifier">imp_specs_mf</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872570"><a href="#local-6989586621683872570"><span class="hs-identifier">rules_mf</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#zonkTcGblEnv"><span class="hs-identifier hs-var">zonkTcGblEnv</span></a><span> </span><span class="hs-identifier hs-var">emptyBag</span><span> </span><a href="#local-6989586621683872564"><span class="hs-identifier hs-var">tcg_env_mf</span></a><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872571"><a href="#local-6989586621683872571"><span class="hs-identifier">final_type_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">plusTypeEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_type_env</span><span> </span><a href="#local-6989586621683872557"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-455"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">plusTypeEnv</span><span> </span><a href="#local-6989586621683872565"><span class="hs-identifier hs-var">bind_env_mf</span></a><span> </span><a href="#local-6989586621683872558"><span class="hs-identifier hs-var">bind_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872572"><a href="#local-6989586621683872572"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872564"><span class="hs-identifier hs-var">tcg_env_mf</span></a><span>
</span><a name="line-457"></a><span>                          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_binds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872560"><span class="hs-identifier hs-var">binds'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872567"><span class="hs-identifier hs-var">binds_mf</span></a><span class="hs-special">,</span><span>
</span><a name="line-458"></a><span>                            </span><span class="hs-identifier">tcg_ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872559"><span class="hs-identifier hs-var">ev_binds'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872566"><span class="hs-identifier hs-var">ev_binds_mf</span></a><span> </span><span class="hs-special">,</span><span>
</span><a name="line-459"></a><span>                            </span><span class="hs-identifier">tcg_imp_specs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872562"><span class="hs-identifier hs-var">imp_specs'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872569"><span class="hs-identifier hs-var">imp_specs_mf</span></a><span> </span><span class="hs-special">,</span><span>
</span><a name="line-460"></a><span>                            </span><span class="hs-identifier">tcg_rules</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872563"><span class="hs-identifier hs-var">rules'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872570"><span class="hs-identifier hs-var">rules_mf</span></a><span> </span><span class="hs-special">,</span><span>
</span><a name="line-461"></a><span>                            </span><span class="hs-identifier">tcg_fords</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872561"><span class="hs-identifier hs-var">fords'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872568"><span class="hs-identifier hs-var">fords_mf</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-462"></a><span>
</span><a name="line-463"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#setGlobalTypeEnv"><span class="hs-identifier hs-var">setGlobalTypeEnv</span></a><span> </span><a href="#local-6989586621683872572"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><a href="#local-6989586621683872571"><span class="hs-identifier hs-var">final_type_env</span></a><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span>   </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-identifier">zonkTcGblEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">EvBind</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-468"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TypeEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bag</span><span> </span><span class="hs-identifier hs-type">EvBind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">,</span><span>
</span><a name="line-469"></a><span>                       </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LForeignDecl</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LTcSpecPrag</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LRuleDecl</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-470"></a><a name="zonkTcGblEnv"><a href="TcRnDriver.html#zonkTcGblEnv"><span class="hs-identifier">zonkTcGblEnv</span></a></a><span> </span><a name="local-6989586621683872573"><a href="#local-6989586621683872573"><span class="hs-identifier">new_ev_binds</span></a></a><span> </span><a name="local-6989586621683872574"><a href="#local-6989586621683872574"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-471"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier hs-var">TcGblEnv</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-identifier">tcg_binds</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872575"><a href="#local-6989586621683872575"><span class="hs-identifier">binds</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-472"></a><span>                   </span><span class="hs-identifier">tcg_ev_binds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872576"><a href="#local-6989586621683872576"><span class="hs-identifier">cur_ev_binds</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-473"></a><span>                   </span><span class="hs-identifier">tcg_imp_specs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872577"><a href="#local-6989586621683872577"><span class="hs-identifier">imp_specs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-474"></a><span>                   </span><span class="hs-identifier">tcg_rules</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872578"><a href="#local-6989586621683872578"><span class="hs-identifier">rules</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-475"></a><span>                   </span><span class="hs-identifier">tcg_fords</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872579"><a href="#local-6989586621683872579"><span class="hs-identifier">fords</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872574"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span>      </span><a name="local-6989586621683872580"><a href="#local-6989586621683872580"><span class="hs-identifier">all_ev_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872576"><span class="hs-identifier hs-var">cur_ev_binds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872573"><span class="hs-identifier hs-var">new_ev_binds</span></a><span>
</span><a name="line-478"></a><span>
</span><a name="line-479"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;zonkTopDecls&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-480"></a><span>      </span><a href="TcHsSyn.html#zonkTopDecls"><span class="hs-identifier hs-var">zonkTopDecls</span></a><span> </span><a href="#local-6989586621683872580"><span class="hs-identifier hs-var">all_ev_binds</span></a><span> </span><a href="#local-6989586621683872575"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621683872578"><span class="hs-identifier hs-var">rules</span></a><span> </span><a href="#local-6989586621683872577"><span class="hs-identifier hs-var">imp_specs</span></a><span> </span><a href="#local-6989586621683872579"><span class="hs-identifier hs-var">fords</span></a><span>
</span><a name="line-481"></a><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span class="hs-comment">-- | Remove accumulated bindings, rules and so on from TcGblEnv</span><span>
</span><a name="line-484"></a><span class="hs-identifier">clearTcGblEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-485"></a><a name="clearTcGblEnv"><a href="TcRnDriver.html#clearTcGblEnv"><span class="hs-identifier">clearTcGblEnv</span></a></a><span> </span><a name="local-6989586621683872581"><a href="#local-6989586621683872581"><span class="hs-identifier">tcg_env</span></a></a><span>
</span><a name="line-486"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872581"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_binds</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span class="hs-special">,</span><span>
</span><a name="line-487"></a><span>              </span><span class="hs-identifier">tcg_ev_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyBag</span><span> </span><span class="hs-special">,</span><span>
</span><a name="line-488"></a><span>              </span><span class="hs-identifier">tcg_imp_specs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-489"></a><span>              </span><span class="hs-identifier">tcg_rules</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-490"></a><span>              </span><span class="hs-identifier">tcg_fords</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-comment">-- | Runs TH finalizers and renames and typechecks the top-level declarations</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- that they could introduce.</span><span>
</span><a name="line-494"></a><span class="hs-identifier">run_th_modfinalizers</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span class="hs-special">)</span><span>
</span><a name="line-495"></a><a name="run_th_modfinalizers"><a href="TcRnDriver.html#run_th_modfinalizers"><span class="hs-identifier">run_th_modfinalizers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-496"></a><span>  </span><a name="local-6989586621683872582"><a href="#local-6989586621683872582"><span class="hs-identifier">th_modfinalizers_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_modfinalizers</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-497"></a><span>  </span><a name="local-6989586621683872583"><a href="#local-6989586621683872583"><span class="hs-identifier">th_modfinalizers</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621683872582"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a><span>
</span><a name="line-498"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683872583"><span class="hs-identifier hs-var">th_modfinalizers</span></a><span>
</span><a name="line-499"></a><span>  </span><span class="hs-keyword">then</span><span> </span><a href="TcRnMonad.html#getEnvs"><span class="hs-identifier hs-var">getEnvs</span></a><span>
</span><a name="line-500"></a><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-501"></a><span>    </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621683872582"><span class="hs-identifier hs-var">th_modfinalizers_var</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-502"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872584"><a href="#local-6989586621683872584"><span class="hs-identifier">run_finalizer</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683872585"><a href="#local-6989586621683872585"><span class="hs-identifier">lcl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872586"><a href="#local-6989586621683872586"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-503"></a><span>            </span><a href="TcRnMonad.html#setLclEnv"><span class="hs-identifier hs-var">setLclEnv</span></a><span> </span><a href="#local-6989586621683872585"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><span class="hs-special">(</span><a href="TcSplice.html#runRemoteModFinalizers"><span class="hs-identifier hs-var">runRemoteModFinalizers</span></a><span> </span><a href="#local-6989586621683872586"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872587"><a href="#local-6989586621683872587"><span class="hs-identifier">lie_th</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#captureTopConstraints"><span class="hs-identifier hs-var">captureTopConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683872584"><span class="hs-identifier hs-var">run_finalizer</span></a><span> </span><a href="#local-6989586621683872583"><span class="hs-identifier hs-var">th_modfinalizers</span></a><span>
</span><a name="line-506"></a><span>      </span><span class="hs-comment">-- Finalizers can add top-level declarations with addTopDecls, so</span><span>
</span><a name="line-507"></a><span>      </span><span class="hs-comment">-- we have to run tc_rn_src_decls to get them</span><span>
</span><a name="line-508"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683872588"><a href="#local-6989586621683872588"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872589"><a href="#local-6989586621683872589"><span class="hs-identifier">tcl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872590"><a href="#local-6989586621683872590"><span class="hs-identifier">lie_top_decls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#tc_rn_src_decls"><span class="hs-identifier hs-var">tc_rn_src_decls</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-509"></a><span>    </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872588"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872589"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-510"></a><span>      </span><span class="hs-comment">-- Subsequent rounds of finalizers run after any new constraints are</span><span>
</span><a name="line-511"></a><span>      </span><span class="hs-comment">-- simplified, or some types might not be complete when using reify</span><span>
</span><a name="line-512"></a><span>      </span><span class="hs-comment">-- (see #12777).</span><span>
</span><a name="line-513"></a><span>      </span><a name="local-6989586621683872591"><a href="#local-6989586621683872591"><span class="hs-identifier">new_ev_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;simplifyTop2&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-514"></a><span>                      </span><a href="TcSimplify.html#simplifyTop"><span class="hs-identifier hs-var">simplifyTop</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872587"><span class="hs-identifier hs-var">lie_th</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andWC</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872590"><span class="hs-identifier hs-var">lie_top_decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span>      </span><a href="TcRnMonad.html#addTopEvBinds"><span class="hs-identifier hs-var">addTopEvBinds</span></a><span> </span><a href="#local-6989586621683872591"><span class="hs-identifier hs-var">new_ev_binds</span></a><span> </span><a href="TcRnDriver.html#run_th_modfinalizers"><span class="hs-identifier hs-var">run_th_modfinalizers</span></a><span>
</span><a name="line-516"></a><span>        </span><span class="hs-comment">-- addTopDecls can add declarations which add new finalizers.</span><span>
</span><a name="line-517"></a><span>
</span><a name="line-518"></a><span class="hs-identifier">tc_rn_src_decls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-519"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">WantedConstraints</span><span class="hs-special">)</span><span>
</span><a name="line-520"></a><span class="hs-comment">-- Loops around dealing with each top level inter-splice group</span><span>
</span><a name="line-521"></a><span class="hs-comment">-- in turn, until it's dealt with the entire module</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- Never emits constraints; calls captureTopConstraints internally</span><span>
</span><a name="line-523"></a><a name="tc_rn_src_decls"><a href="TcRnDriver.html#tc_rn_src_decls"><span class="hs-identifier">tc_rn_src_decls</span></a></a><span> </span><a name="local-6989586621683872592"><a href="#local-6989586621683872592"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-524"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;tc_rn_src_decls&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-525"></a><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872593"><a href="#local-6989586621683872593"><span class="hs-identifier">first_group</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872594"><a href="#local-6989586621683872594"><span class="hs-identifier">group_tail</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#findSplice"><span class="hs-identifier hs-var">findSplice</span></a><span> </span><a href="#local-6989586621683872592"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-526"></a><span>                </span><span class="hs-comment">-- If ds is [] we get ([], Nothing)</span><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span>        </span><span class="hs-comment">-- Deal with decls up to, but not including, the first splice</span><span>
</span><a name="line-529"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872595"><a href="#local-6989586621683872595"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872596"><a href="#local-6989586621683872596"><span class="hs-identifier">rn_decls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#rnTopSrcDecls"><span class="hs-identifier hs-var">rnTopSrcDecls</span></a><span> </span><a href="#local-6989586621683872593"><span class="hs-identifier hs-var">first_group</span></a><span>
</span><a name="line-530"></a><span>                </span><span class="hs-comment">-- rnTopSrcDecls fails if there are any errors</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span>        </span><span class="hs-comment">-- Get TH-generated top-level declarations and make sure they don't</span><span>
</span><a name="line-533"></a><span>        </span><span class="hs-comment">-- contain any splices since we don't handle that at the moment</span><span>
</span><a name="line-534"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-535"></a><span>        </span><span class="hs-comment">-- The plumbing here is a bit odd: see Trac #10853</span><span>
</span><a name="line-536"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872597"><a href="#local-6989586621683872597"><span class="hs-identifier">th_topdecls_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">tcg_th_topdecls</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-537"></a><span>      </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872598"><a href="#local-6989586621683872598"><span class="hs-identifier">th_ds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#readTcRef"><span class="hs-identifier hs-var">readTcRef</span></a><span> </span><a href="#local-6989586621683872597"><span class="hs-identifier hs-var">th_topdecls_var</span></a><span>
</span><a name="line-538"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#writeTcRef"><span class="hs-identifier hs-var">writeTcRef</span></a><span> </span><a href="#local-6989586621683872597"><span class="hs-identifier hs-var">th_topdecls_var</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872605"><a href="#local-6989586621683872605"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872606"><a href="#local-6989586621683872606"><span class="hs-identifier">rn_decls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-541"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683872598"><span class="hs-identifier hs-var">th_ds</span></a><span>
</span><a name="line-542"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872595"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872596"><span class="hs-identifier hs-var">rn_decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872599"><a href="#local-6989586621683872599"><span class="hs-identifier">th_group</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872600"><a href="#local-6989586621683872600"><span class="hs-identifier">th_group_tail</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#findSplice"><span class="hs-identifier hs-var">findSplice</span></a><span> </span><a href="#local-6989586621683872598"><span class="hs-identifier hs-var">th_ds</span></a><span>
</span><a name="line-544"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683872600"><span class="hs-identifier hs-var">th_group_tail</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-545"></a><span>                        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-546"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683872601"><a href="#local-6989586621683872601"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-547"></a><span>                            </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683872601"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-548"></a><span>                            </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span>
</span><a name="line-549"></a><span>                                </span><span class="hs-special">(</span><span class="hs-string">&quot;Declaration splices are not &quot;</span><span>
</span><a name="line-550"></a><span>                                  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;permitted inside top-level &quot;</span><span>
</span><a name="line-551"></a><span>                                  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;declarations added with addTopDecls&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XSpliceDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_rn_src_decls&quot;</span><span>
</span><a name="line-553"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-554"></a><span>                      </span><span class="hs-comment">-- Rename TH-generated top-level declarations</span><span>
</span><a name="line-555"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872602"><a href="#local-6989586621683872602"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872603"><a href="#local-6989586621683872603"><span class="hs-identifier">th_rn_decls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872595"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-556"></a><span>                        </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#rnTopSrcDecls"><span class="hs-identifier hs-var">rnTopSrcDecls</span></a><span> </span><a href="#local-6989586621683872599"><span class="hs-identifier hs-var">th_group</span></a><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span>                      </span><span class="hs-comment">-- Dump generated top-level declarations</span><span>
</span><a name="line-559"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872604"><a href="#local-6989586621683872604"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;top-level declarations added with addTopDecls&quot;</span><span>
</span><a name="line-560"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="RnSplice.html#traceSplice"><span class="hs-identifier hs-var">traceSplice</span></a><span>
</span><a name="line-561"></a><span>                        </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnSplice.html#SpliceInfo"><span class="hs-identifier hs-var">SpliceInfo</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">spliceDescription</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872604"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-562"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceIsDecl</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-563"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceSource</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-564"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">spliceGenerated</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872603"><span class="hs-identifier hs-var">th_rn_decls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-565"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872602"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">appendGroups</span><span> </span><a href="#local-6989586621683872596"><span class="hs-identifier hs-var">rn_decls</span></a><span> </span><a href="#local-6989586621683872603"><span class="hs-identifier hs-var">th_rn_decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-566"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-567"></a><span>
</span><a name="line-568"></a><span>      </span><span class="hs-comment">-- Type check all declarations</span><span>
</span><a name="line-569"></a><span>      </span><span class="hs-comment">-- NB: set the env **before** captureTopConstraints so that error messages</span><span>
</span><a name="line-570"></a><span>      </span><span class="hs-comment">-- get reported w.r.t. the right GlobalRdrEnv. It is for this reason that</span><span>
</span><a name="line-571"></a><span>      </span><span class="hs-comment">-- the captureTopConstraints must go here, not in tcRnSrcDecls.</span><span>
</span><a name="line-572"></a><span>      </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683872607"><a href="#local-6989586621683872607"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872608"><a href="#local-6989586621683872608"><span class="hs-identifier">tcl_env</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872609"><a href="#local-6989586621683872609"><span class="hs-identifier">lie1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872605"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-573"></a><span>                                      </span><a href="TcSimplify.html#captureTopConstraints"><span class="hs-identifier hs-var">captureTopConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-574"></a><span>                                      </span><a href="TcRnDriver.html#tcTopSrcDecls"><span class="hs-identifier hs-var">tcTopSrcDecls</span></a><span> </span><a href="#local-6989586621683872606"><span class="hs-identifier hs-var">rn_decls</span></a><span>
</span><a name="line-575"></a><span>
</span><a name="line-576"></a><span>        </span><span class="hs-comment">-- If there is no splice, we're nearly done</span><span>
</span><a name="line-577"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872607"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872608"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-578"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683872594"><span class="hs-identifier hs-var">group_tail</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-579"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872607"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872608"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872609"><span class="hs-identifier hs-var">lie1</span></a><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span>            </span><span class="hs-comment">-- If there's a splice, we must carry on</span><span>
</span><a name="line-582"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683872610"><a href="#local-6989586621683872610"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683872611"><a href="#local-6989586621683872611"><span class="hs-identifier">splice</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872612"><a href="#local-6989586621683872612"><span class="hs-identifier">rest_ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-583"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#recordTopLevelSpliceLoc"><span class="hs-identifier hs-var">recordTopLevelSpliceLoc</span></a><span> </span><a href="#local-6989586621683872610"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span>                 </span><span class="hs-comment">-- Rename the splice expression, and get its supporting decls</span><span>
</span><a name="line-586"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872613"><a href="#local-6989586621683872613"><span class="hs-identifier">spliced_decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872614"><a href="#local-6989586621683872614"><span class="hs-identifier">splice_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSplice.html#rnTopSpliceDecls"><span class="hs-identifier hs-var">rnTopSpliceDecls</span></a><span> </span><a href="#local-6989586621683872611"><span class="hs-identifier hs-var">splice</span></a><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span>                 </span><span class="hs-comment">-- Glue them on the front of the remaining decls and loop</span><span>
</span><a name="line-589"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872615"><a href="#local-6989586621683872615"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872616"><a href="#local-6989586621683872616"><span class="hs-identifier">tcl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872617"><a href="#local-6989586621683872617"><span class="hs-identifier">lie2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-590"></a><span>                   </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872607"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">`</span><a href="RnSource.html#addTcgDUs"><span class="hs-identifier hs-var">addTcgDUs</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">usesOnly</span><span> </span><a href="#local-6989586621683872614"><span class="hs-identifier hs-var">splice_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-591"></a><span>                   </span><a href="TcRnDriver.html#tc_rn_src_decls"><span class="hs-identifier hs-var">tc_rn_src_decls</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872613"><span class="hs-identifier hs-var">spliced_decls</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872612"><span class="hs-identifier hs-var">rest_ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-592"></a><span>
</span><a name="line-593"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872615"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872616"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872609"><span class="hs-identifier hs-var">lie1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andWC</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872617"><span class="hs-identifier hs-var">lie2</span></a><span class="hs-special">)</span><span>
</span><a name="line-594"></a><span>               </span><span class="hs-special">}</span><span>
</span><a name="line-595"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XSpliceDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tc_rn_src_decls&quot;</span><span>
</span><a name="line-596"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-597"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Compiling hs-boot source files, and
        comparing the hi-boot interface with the real thing
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span class="hs-identifier">tcRnHsBootDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-609"></a><a name="tcRnHsBootDecls"><a href="TcRnDriver.html#tcRnHsBootDecls"><span class="hs-identifier">tcRnHsBootDecls</span></a></a><span> </span><a name="local-6989586621683872618"><a href="#local-6989586621683872618"><span class="hs-identifier">hsc_src</span></a></a><span> </span><a name="local-6989586621683872619"><a href="#local-6989586621683872619"><span class="hs-identifier">decls</span></a></a><span>
</span><a name="line-610"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872620"><a href="#local-6989586621683872620"><span class="hs-identifier">first_group</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872621"><a href="#local-6989586621683872621"><span class="hs-identifier">group_tail</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnSource.html#findSplice"><span class="hs-identifier hs-var">findSplice</span></a><span> </span><a href="#local-6989586621683872619"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-611"></a><span>
</span><a name="line-612"></a><span>                </span><span class="hs-comment">-- Rename the declarations</span><span>
</span><a name="line-613"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872622"><a href="#local-6989586621683872622"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872623"><a href="#local-6989586621683872623"><span class="hs-identifier">tycl_decls</span></a></a><span>
</span><a name="line-614"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hs_derivds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872624"><a href="#local-6989586621683872624"><span class="hs-identifier">deriv_decls</span></a></a><span>
</span><a name="line-615"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hs_fords</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872625"><a href="#local-6989586621683872625"><span class="hs-identifier">for_decls</span></a></a><span>
</span><a name="line-616"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hs_defds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872626"><a href="#local-6989586621683872626"><span class="hs-identifier">def_decls</span></a></a><span>
</span><a name="line-617"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hs_ruleds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872627"><a href="#local-6989586621683872627"><span class="hs-identifier">rule_decls</span></a></a><span>
</span><a name="line-618"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hs_annds</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-619"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hs_valds</span><span>
</span><a name="line-620"></a><span>                                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">XValBindsLR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NValBinds</span><span> </span><a name="local-6989586621683872628"><a href="#local-6989586621683872628"><span class="hs-identifier">val_binds</span></a></a><span> </span><a name="local-6989586621683872629"><a href="#local-6989586621683872629"><span class="hs-identifier">val_sigs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#rnTopSrcDecls"><span class="hs-identifier hs-var">rnTopSrcDecls</span></a><span> </span><a href="#local-6989586621683872620"><span class="hs-identifier hs-var">first_group</span></a><span>
</span><a name="line-622"></a><span>        </span><span class="hs-comment">-- The empty list is for extra dependencies coming from .hs-boot files</span><span>
</span><a name="line-623"></a><span>        </span><span class="hs-comment">-- See Note [Extra dependencies from .hs-boot files] in RnSource</span><span>
</span><a name="line-624"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872641"><a href="#local-6989586621683872641"><span class="hs-identifier">gbl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872642"><a href="#local-6989586621683872642"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872622"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcSimplify.html#captureTopConstraints"><span class="hs-identifier hs-var">captureTopConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-625"></a><span>              </span><span class="hs-comment">-- NB: setGblEnv **before** captureTopConstraints so that</span><span>
</span><a name="line-626"></a><span>              </span><span class="hs-comment">-- if the latter reports errors, it knows what's in scope</span><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><span>                </span><span class="hs-comment">-- Check for illegal declarations</span><span>
</span><a name="line-629"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683872621"><span class="hs-identifier hs-var">group_tail</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-630"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SpliceDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683872630"><a href="#local-6989586621683872630"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnDriver.html#badBootDecl"><span class="hs-identifier hs-var">badBootDecl</span></a><span> </span><a href="#local-6989586621683872618"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-string">&quot;splice&quot;</span><span> </span><a href="#local-6989586621683872630"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-631"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">XSpliceDecl</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcRnHsBootDecls&quot;</span><span>
</span><a name="line-632"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#badBootDecl"><span class="hs-identifier hs-var">badBootDecl</span></a><span> </span><a href="#local-6989586621683872618"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-string">&quot;foreign&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872625"><span class="hs-identifier hs-var">for_decls</span></a><span>
</span><a name="line-634"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#badBootDecl"><span class="hs-identifier hs-var">badBootDecl</span></a><span> </span><a href="#local-6989586621683872618"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-string">&quot;default&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872626"><span class="hs-identifier hs-var">def_decls</span></a><span>
</span><a name="line-635"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#badBootDecl"><span class="hs-identifier hs-var">badBootDecl</span></a><span> </span><a href="#local-6989586621683872618"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-string">&quot;rule&quot;</span><span class="hs-special">)</span><span>    </span><a href="#local-6989586621683872627"><span class="hs-identifier hs-var">rule_decls</span></a><span>
</span><a name="line-636"></a><span>
</span><a name="line-637"></a><span>                </span><span class="hs-comment">-- Typecheck type/class/instance decls</span><span>
</span><a name="line-638"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc2 (boot)&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-639"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872631"><a href="#local-6989586621683872631"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872632"><a href="#local-6989586621683872632"><span class="hs-identifier">inst_infos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872633"><a href="#local-6989586621683872633"><span class="hs-identifier">_deriv_binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-640"></a><span>             </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#tcTyClsInstDecls"><span class="hs-identifier hs-var">tcTyClsInstDecls</span></a><span> </span><a href="#local-6989586621683872623"><span class="hs-identifier hs-var">tycl_decls</span></a><span> </span><a href="#local-6989586621683872624"><span class="hs-identifier hs-var">deriv_decls</span></a><span> </span><a href="#local-6989586621683872628"><span class="hs-identifier hs-var">val_binds</span></a><span>
</span><a name="line-641"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872631"><span class="hs-identifier hs-var">tcg_env</span></a><span>     </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-642"></a><span>
</span><a name="line-643"></a><span>        </span><span class="hs-comment">-- Emit Typeable bindings</span><span>
</span><a name="line-644"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872634"><a href="#local-6989586621683872634"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTypeable.html#mkTypeableBinds"><span class="hs-identifier hs-var">mkTypeableBinds</span></a><span>
</span><a name="line-645"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872634"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-646"></a><span>
</span><a name="line-647"></a><span>                </span><span class="hs-comment">-- Typecheck value declarations</span><span>
</span><a name="line-648"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc5&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-649"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872635"><a href="#local-6989586621683872635"><span class="hs-identifier">val_ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcHsBootSigs"><span class="hs-identifier hs-var">tcHsBootSigs</span></a><span> </span><a href="#local-6989586621683872628"><span class="hs-identifier hs-var">val_binds</span></a><span> </span><a href="#local-6989586621683872629"><span class="hs-identifier hs-var">val_sigs</span></a><span>
</span><a name="line-650"></a><span>
</span><a name="line-651"></a><span>                </span><span class="hs-comment">-- Wrap up</span><span>
</span><a name="line-652"></a><span>                </span><span class="hs-comment">-- No simplification or zonking to do</span><span>
</span><a name="line-653"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc7a&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-654"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872636"><a href="#local-6989586621683872636"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span>                </span><span class="hs-comment">-- Make the final type-env</span><span>
</span><a name="line-657"></a><span>                </span><span class="hs-comment">-- Include the dfun_ids so that their type sigs</span><span>
</span><a name="line-658"></a><span>                </span><span class="hs-comment">-- are written into the interface file.</span><span>
</span><a name="line-659"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872637"><a href="#local-6989586621683872637"><span class="hs-identifier">type_env0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_type_env</span><span> </span><a href="#local-6989586621683872636"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-660"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872638"><a href="#local-6989586621683872638"><span class="hs-identifier">type_env1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTypeEnvWithIds</span><span> </span><a href="#local-6989586621683872637"><span class="hs-identifier hs-var">type_env0</span></a><span> </span><a href="#local-6989586621683872635"><span class="hs-identifier hs-var">val_ids</span></a><span>
</span><a name="line-661"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872639"><a href="#local-6989586621683872639"><span class="hs-identifier">type_env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTypeEnvWithIds</span><span> </span><a href="#local-6989586621683872638"><span class="hs-identifier hs-var">type_env1</span></a><span> </span><a href="#local-6989586621683872640"><span class="hs-identifier hs-var">dfun_ids</span></a><span>
</span><a name="line-662"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872640"><a href="#local-6989586621683872640"><span class="hs-identifier">dfun_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="TcEnv.html#iDFunId"><span class="hs-identifier hs-var">iDFunId</span></a><span> </span><a href="#local-6989586621683872632"><span class="hs-identifier hs-var">inst_infos</span></a><span>
</span><a name="line-663"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-664"></a><span>
</span><a name="line-665"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#setGlobalTypeEnv"><span class="hs-identifier hs-var">setGlobalTypeEnv</span></a><span> </span><a href="#local-6989586621683872636"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><a href="#local-6989586621683872639"><span class="hs-identifier hs-var">type_env2</span></a><span>
</span><a name="line-666"></a><span>   </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-667"></a><span>   </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;boot&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872642"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683872641"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span class="hs-identifier">badBootDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscSource</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><a href="#local-6989586621683872485"><span class="hs-identifier hs-type">decl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-670"></a><a name="badBootDecl"><a href="TcRnDriver.html#badBootDecl"><span class="hs-identifier">badBootDecl</span></a></a><span> </span><a name="local-6989586621683872643"><a href="#local-6989586621683872643"><span class="hs-identifier">hsc_src</span></a></a><span> </span><a name="local-6989586621683872644"><a href="#local-6989586621683872644"><span class="hs-identifier">what</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683872645"><a href="#local-6989586621683872645"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-671"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621683872645"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">char</span><span> </span><span class="hs-char">'A'</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683872644"><span class="hs-identifier hs-var">what</span></a><span>
</span><a name="line-672"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;declaration is not (currently) allowed in a&quot;</span><span>
</span><a name="line-673"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683872643"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-674"></a><span>            </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hs-boot&quot;</span><span>
</span><a name="line-675"></a><span>            </span><span class="hs-identifier hs-var">HsigFile</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hsig&quot;</span><span>
</span><a name="line-676"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;badBootDecl: should be an hsig or hs-boot file&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-677"></a><span>      </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;file&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span class="hs-comment">{-
Once we've typechecked the body of the module, we want to compare what
we've found (gathered in a TypeEnv) with the hi-boot details (if any).
-}</span><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span class="hs-identifier">checkHiBootIface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SelfBootInfo</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-685"></a><span class="hs-comment">-- Compare the hi-boot file for this module (if there is one)</span><span>
</span><a name="line-686"></a><span class="hs-comment">-- with the type environment we've just come up with</span><span>
</span><a name="line-687"></a><span class="hs-comment">-- In the common case where there is no hi-boot file, the list</span><span>
</span><a name="line-688"></a><span class="hs-comment">-- of boot_names is empty.</span><span>
</span><a name="line-689"></a><span>
</span><a name="line-690"></a><a name="checkHiBootIface"><a href="TcRnDriver.html#checkHiBootIface"><span class="hs-identifier">checkHiBootIface</span></a></a><span> </span><a name="local-6989586621683872646"><a href="#local-6989586621683872646"><span class="hs-identifier">tcg_env</span></a></a><span> </span><a name="local-6989586621683872647"><a href="#local-6989586621683872647"><span class="hs-identifier">boot_info</span></a></a><span>
</span><a name="line-691"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">NoSelfBoot</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872647"><span class="hs-identifier hs-var">boot_info</span></a><span>  </span><span class="hs-comment">-- Common case</span><span>
</span><a name="line-692"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683872646"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-693"></a><span>
</span><a name="line-694"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">HsBootFile</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">tcg_src</span><span> </span><a href="#local-6989586621683872646"><span class="hs-identifier hs-var">tcg_env</span></a><span>   </span><span class="hs-comment">-- Current module is already a hs-boot file!</span><span>
</span><a name="line-695"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683872646"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">SelfBoot</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sb_mds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872648"><a href="#local-6989586621683872648"><span class="hs-identifier">boot_details</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872647"><span class="hs-identifier hs-var">boot_info</span></a><span>
</span><a name="line-698"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">TcGblEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_binds</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872649"><a href="#local-6989586621683872649"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-699"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_insts</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872650"><a href="#local-6989586621683872650"><span class="hs-identifier">local_insts</span></a></a><span>
</span><a name="line-700"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_type_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872651"><a href="#local-6989586621683872651"><span class="hs-identifier">local_type_env</span></a></a><span>
</span><a name="line-701"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_exports</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872652"><a href="#local-6989586621683872652"><span class="hs-identifier">local_exports</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872646"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-702"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- This code is tricky, see Note [DFun knot-tying]</span><span>
</span><a name="line-703"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872653"><a href="#local-6989586621683872653"><span class="hs-identifier">dfun_prs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#checkHiBootIface%27"><span class="hs-identifier hs-var">checkHiBootIface'</span></a><span> </span><a href="#local-6989586621683872650"><span class="hs-identifier hs-var">local_insts</span></a><span> </span><a href="#local-6989586621683872651"><span class="hs-identifier hs-var">local_type_env</span></a><span>
</span><a name="line-704"></a><span>                                        </span><a href="#local-6989586621683872652"><span class="hs-identifier hs-var">local_exports</span></a><span> </span><a href="#local-6989586621683872648"><span class="hs-identifier hs-var">boot_details</span></a><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span>        </span><span class="hs-comment">-- Now add the boot-dfun bindings  $fxblah = $fblah</span><span>
</span><a name="line-707"></a><span>        </span><span class="hs-comment">-- to (a) the type envt, and (b) the top-level bindings</span><span>
</span><a name="line-708"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872654"><a href="#local-6989586621683872654"><span class="hs-identifier">boot_dfuns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621683872653"><span class="hs-identifier hs-var">dfun_prs</span></a><span>
</span><a name="line-709"></a><span>              </span><a name="local-6989586621683872655"><a href="#local-6989586621683872655"><span class="hs-identifier">type_env'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTypeEnvWithIds</span><span> </span><a href="#local-6989586621683872651"><span class="hs-identifier hs-var">local_type_env</span></a><span> </span><a href="#local-6989586621683872654"><span class="hs-identifier hs-var">boot_dfuns</span></a><span>
</span><a name="line-710"></a><span>              </span><a name="local-6989586621683872656"><a href="#local-6989586621683872656"><span class="hs-identifier">dfun_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToBag</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">mkVarBind</span><span> </span><a href="#local-6989586621683872658"><span class="hs-identifier hs-var">boot_dfun</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683872659"><span class="hs-identifier hs-var">dfun</span></a><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>                                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872658"><a href="#local-6989586621683872658"><span class="hs-identifier">boot_dfun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872659"><a href="#local-6989586621683872659"><span class="hs-identifier">dfun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872653"><span class="hs-identifier hs-var">dfun_prs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-712"></a><span>              </span><a name="local-6989586621683872657"><a href="#local-6989586621683872657"><span class="hs-identifier">tcg_env_w_binds</span></a></a><span>
</span><a name="line-713"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872646"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872649"><span class="hs-identifier hs-var">binds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872656"><span class="hs-identifier hs-var">dfun_binds</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-714"></a><span>
</span><a name="line-715"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683872655"><span class="hs-identifier hs-var">type_env'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>
</span><a name="line-716"></a><span>             </span><span class="hs-comment">-- Why the seq?  Without, we will put a TypeEnv thunk in</span><span>
</span><a name="line-717"></a><span>             </span><span class="hs-comment">-- tcg_type_env_var.  That thunk will eventually get</span><span>
</span><a name="line-718"></a><span>             </span><span class="hs-comment">-- forced if we are typechecking interfaces, but that</span><span>
</span><a name="line-719"></a><span>             </span><span class="hs-comment">-- is no good if we are trying to typecheck the very</span><span>
</span><a name="line-720"></a><span>             </span><span class="hs-comment">-- DFun we were going to put in.</span><span>
</span><a name="line-721"></a><span>             </span><span class="hs-comment">-- TODO: Maybe setGlobalTypeEnv should be strict.</span><span>
</span><a name="line-722"></a><span>          </span><a href="TcEnv.html#setGlobalTypeEnv"><span class="hs-identifier hs-var">setGlobalTypeEnv</span></a><span> </span><a href="#local-6989586621683872657"><span class="hs-identifier hs-var">tcg_env_w_binds</span></a><span> </span><a href="#local-6989586621683872655"><span class="hs-identifier hs-var">type_env'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-723"></a><span>
</span><a name="line-724"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;checkHiBootIface: unreachable code&quot;</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span class="hs-comment">{- Note [DFun impedance matching]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We return a list of &quot;impedance-matching&quot; bindings for the dfuns
defined in the hs-boot file, such as
          $fxEqT = $fEqT
We need these because the module and hi-boot file might differ in
the name it chose for the dfun: the name of a dfun is not
uniquely determined by its type; there might be multiple dfuns
which, individually, would map to the same name (in which case
we have to disambiguate them.)  There's no way for the hi file
to know exactly what disambiguation to use... without looking
at the hi-boot file itself.

In fact, the names will always differ because we always pick names
prefixed with &quot;$fx&quot; for boot dfuns, and &quot;$f&quot; for real dfuns
(so that this impedance matching is always possible).

Note [DFun knot-tying]
~~~~~~~~~~~~~~~~~~~~~~
The 'SelfBootInfo' that is fed into 'checkHiBootIface' comes from
typechecking the hi-boot file that we are presently implementing.
Suppose we are typechecking the module A: when we typecheck the
hi-boot file, whenever we see an identifier A.T, we knot-tie this
identifier to the *local* type environment (via if_rec_types.)  The
contract then is that we don't *look* at 'SelfBootInfo' until we've
finished typechecking the module and updated the type environment with
the new tycons and ids.

This most works well, but there is one problem: DFuns!  We do not want
to look at the mb_insts of the ModDetails in SelfBootInfo, because a
dfun in one of those ClsInsts is gotten (in TcIface.tcIfaceInst) by a
(lazily evaluated) lookup in the if_rec_types.  We could extend the
type env, do a setGloblaTypeEnv etc; but that all seems very indirect.
It is much more directly simply to extract the DFunIds from the
md_types of the SelfBootInfo.

See Trac #4003, #16038 for why we need to take care here.
-}</span><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><span class="hs-identifier">checkHiBootIface'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">AvailInfo</span><span class="hs-special">]</span><span>
</span><a name="line-766"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ModDetails</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-767"></a><span class="hs-comment">-- Variant which doesn't require a full TcGblEnv; you could get the</span><span>
</span><a name="line-768"></a><span class="hs-comment">-- local components from another ModDetails.</span><span>
</span><a name="line-769"></a><a name="checkHiBootIface%27"><a href="TcRnDriver.html#checkHiBootIface%27"><span class="hs-identifier">checkHiBootIface'</span></a></a><span>
</span><a name="line-770"></a><span>        </span><a name="local-6989586621683872660"><a href="#local-6989586621683872660"><span class="hs-identifier">local_insts</span></a></a><span> </span><a name="local-6989586621683872661"><a href="#local-6989586621683872661"><span class="hs-identifier">local_type_env</span></a></a><span> </span><a name="local-6989586621683872662"><a href="#local-6989586621683872662"><span class="hs-identifier">local_exports</span></a></a><span>
</span><a name="line-771"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ModDetails</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">md_types</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872663"><a href="#local-6989586621683872663"><span class="hs-identifier">boot_type_env</span></a></a><span>
</span><a name="line-772"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">md_fam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872664"><a href="#local-6989586621683872664"><span class="hs-identifier">boot_fam_insts</span></a></a><span>
</span><a name="line-773"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">md_exports</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872665"><a href="#local-6989586621683872665"><span class="hs-identifier">boot_exports</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-774"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkHiBootIface&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-775"></a><span>             </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872663"><span class="hs-identifier hs-var">boot_type_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872665"><span class="hs-identifier hs-var">boot_exports</span></a><span class="hs-special">]</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span>                </span><span class="hs-comment">-- Check the exports of the boot module, one by one</span><span>
</span><a name="line-778"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683872668"><span class="hs-identifier hs-var">check_export</span></a><span> </span><a href="#local-6989586621683872665"><span class="hs-identifier hs-var">boot_exports</span></a><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span>                </span><span class="hs-comment">-- Check for no family instances</span><span>
</span><a name="line-781"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683872664"><span class="hs-identifier hs-var">boot_fam_insts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-782"></a><span>            </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;TcRnDriver.checkHiBootIface: Cannot handle family &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-783"></a><span>                   </span><span class="hs-string">&quot;instances in boot files yet...&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>            </span><span class="hs-comment">-- FIXME: Why?  The actual comparison is not hard, but what would</span><span>
</span><a name="line-785"></a><span>            </span><span class="hs-comment">--        be the equivalent to the dfun bindings returned for class</span><span>
</span><a name="line-786"></a><span>            </span><span class="hs-comment">--        instances?  We can't easily equate tycons...</span><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><span>                </span><span class="hs-comment">-- Check instance declarations</span><span>
</span><a name="line-789"></a><span>                </span><span class="hs-comment">-- and generate an impedance-matching binding</span><span>
</span><a name="line-790"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872686"><a href="#local-6989586621683872686"><span class="hs-identifier">mb_dfun_prs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="#local-6989586621683872670"><span class="hs-identifier hs-var">check_cls_inst</span></a><span> </span><a href="#local-6989586621683872667"><span class="hs-identifier hs-var">boot_dfuns</span></a><span>
</span><a name="line-791"></a><span>
</span><a name="line-792"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621683872686"><span class="hs-identifier hs-var">mb_dfun_prs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-797"></a><span>    </span><a name="local-6989586621683872666"><a href="#local-6989586621683872666"><span class="hs-identifier">boot_dfun_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683872667"><span class="hs-identifier hs-var">boot_dfuns</span></a><span>
</span><a name="line-798"></a><span>    </span><a name="local-6989586621683872667"><a href="#local-6989586621683872667"><span class="hs-identifier">boot_dfuns</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isDFunId</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">typeEnvIds</span><span> </span><a href="#local-6989586621683872663"><span class="hs-identifier hs-var">boot_type_env</span></a><span>
</span><a name="line-799"></a><span>       </span><span class="hs-comment">-- NB: boot_dfuns is /not/ defined thus: map instanceDFunId md_insts</span><span>
</span><a name="line-800"></a><span>       </span><span class="hs-comment">--     We don't want to look at md_insts!</span><span>
</span><a name="line-801"></a><span>       </span><span class="hs-comment">--     Why not?  See Note [DFun knot-tying]</span><span>
</span><a name="line-802"></a><span>
</span><a name="line-803"></a><span>    </span><a name="local-6989586621683872668"><a href="#local-6989586621683872668"><span class="hs-identifier">check_export</span></a></a><span> </span><a name="local-6989586621683872672"><a href="#local-6989586621683872672"><span class="hs-identifier">boot_avail</span></a></a><span>     </span><span class="hs-comment">-- boot_avail is exported by the boot iface</span><span>
</span><a name="line-804"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683872673"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872666"><span class="hs-identifier hs-var">boot_dfun_names</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-805"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isWiredInName</span><span> </span><a href="#local-6989586621683872673"><span class="hs-identifier hs-var">name</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- No checking for wired-in names.  In particular,</span><span>
</span><a name="line-806"></a><span>                                                </span><span class="hs-comment">-- 'error' is handled by a rather gross hack</span><span>
</span><a name="line-807"></a><span>                                                </span><span class="hs-comment">-- (see comments in GHC.Err.hs-boot)</span><span>
</span><a name="line-808"></a><span>
</span><a name="line-809"></a><span>        </span><span class="hs-comment">-- Check that the actual module exports the same thing</span><span>
</span><a name="line-810"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683872675"><span class="hs-identifier hs-var">missing_names</span></a><span class="hs-special">)</span><span>
</span><a name="line-811"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621683872675"><span class="hs-identifier hs-var">missing_names</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>                 </span><span class="hs-special">(</span><a href="TcRnDriver.html#missingBootThing"><span class="hs-identifier hs-var">missingBootThing</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621683872675"><span class="hs-identifier hs-var">missing_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;exported by&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-813"></a><span>
</span><a name="line-814"></a><span>        </span><span class="hs-comment">-- If the boot module does not *define* the thing, we are done</span><span>
</span><a name="line-815"></a><span>        </span><span class="hs-comment">-- (it simply re-exports it, and names match, so nothing further to do)</span><span>
</span><a name="line-816"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isNothing</span><span> </span><a href="#local-6989586621683872674"><span class="hs-identifier hs-var">mb_boot_thing</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span>        </span><span class="hs-comment">-- Check that the actual module also defines the thing, and</span><span>
</span><a name="line-819"></a><span>        </span><span class="hs-comment">-- then compare the definitions</span><span>
</span><a name="line-820"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872677"><a href="#local-6989586621683872677"><span class="hs-identifier">real_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupTypeEnv</span><span> </span><a href="#local-6989586621683872661"><span class="hs-identifier hs-var">local_type_env</span></a><span> </span><a href="#local-6989586621683872673"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span>
</span><a name="line-821"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872678"><a href="#local-6989586621683872678"><span class="hs-identifier">boot_thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872674"><span class="hs-identifier hs-var">mb_boot_thing</span></a><span>
</span><a name="line-822"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#checkBootDeclM"><span class="hs-identifier hs-var">checkBootDeclM</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621683872678"><span class="hs-identifier hs-var">boot_thing</span></a><span> </span><a href="#local-6989586621683872677"><span class="hs-identifier hs-var">real_thing</span></a><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-825"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#missingBootThing"><span class="hs-identifier hs-var">missingBootThing</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621683872673"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-string">&quot;defined in&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-827"></a><span>        </span><a name="local-6989586621683872673"><a href="#local-6989586621683872673"><span class="hs-identifier">name</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">availName</span><span> </span><a href="#local-6989586621683872672"><span class="hs-identifier hs-var">boot_avail</span></a><span>
</span><a name="line-828"></a><span>        </span><a name="local-6989586621683872674"><a href="#local-6989586621683872674"><span class="hs-identifier">mb_boot_thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupTypeEnv</span><span> </span><a href="#local-6989586621683872663"><span class="hs-identifier hs-var">boot_type_env</span></a><span> </span><a href="#local-6989586621683872673"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-829"></a><span>        </span><a name="local-6989586621683872675"><a href="#local-6989586621683872675"><span class="hs-identifier">missing_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">lookupNameEnv</span><span> </span><a href="#local-6989586621683872669"><span class="hs-identifier hs-var">local_export_env</span></a><span> </span><a href="#local-6989586621683872673"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-830"></a><span>                          </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683872673"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span>
</span><a name="line-831"></a><span>                          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872676"><a href="#local-6989586621683872676"><span class="hs-identifier">avail</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">availNames</span><span> </span><a href="#local-6989586621683872672"><span class="hs-identifier hs-var">boot_avail</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusList</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">availNames</span><span> </span><a href="#local-6989586621683872676"><span class="hs-identifier hs-var">avail</span></a><span>
</span><a name="line-832"></a><span>
</span><a name="line-833"></a><span>    </span><span class="hs-identifier">local_export_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NameEnv</span><span> </span><span class="hs-identifier hs-type">AvailInfo</span><span>
</span><a name="line-834"></a><span>    </span><a name="local-6989586621683872669"><a href="#local-6989586621683872669"><span class="hs-identifier">local_export_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">availsToNameEnv</span><span> </span><a href="#local-6989586621683872662"><span class="hs-identifier hs-var">local_exports</span></a><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span>    </span><span class="hs-identifier">check_cls_inst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DFunId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Id</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>        </span><span class="hs-comment">-- Returns a pair of the boot dfun in terms of the equivalent</span><span>
</span><a name="line-838"></a><span>        </span><span class="hs-comment">-- real dfun. Delicate (like checkBootDecl) because it depends</span><span>
</span><a name="line-839"></a><span>        </span><span class="hs-comment">-- on the types lining up precisely even to the ordering of</span><span>
</span><a name="line-840"></a><span>        </span><span class="hs-comment">-- the type variables in the foralls.</span><span>
</span><a name="line-841"></a><span>    </span><a name="local-6989586621683872670"><a href="#local-6989586621683872670"><span class="hs-identifier">check_cls_inst</span></a></a><span> </span><a name="local-6989586621683872679"><a href="#local-6989586621683872679"><span class="hs-identifier">boot_dfun</span></a></a><span>
</span><a name="line-842"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872680"><a href="#local-6989586621683872680"><span class="hs-identifier">real_dfun</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872671"><span class="hs-identifier hs-var">find_real_dfun</span></a><span> </span><a href="#local-6989586621683872679"><span class="hs-identifier hs-var">boot_dfun</span></a><span>
</span><a name="line-843"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872681"><a href="#local-6989586621683872681"><span class="hs-identifier">local_boot_dfun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Id.mkExportedVanillaId</span><span>
</span><a name="line-844"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683872679"><span class="hs-identifier hs-var">boot_dfun</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872680"><span class="hs-identifier hs-var">real_dfun</span></a><span class="hs-special">)</span><span>
</span><a name="line-845"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872681"><span class="hs-identifier hs-var">local_boot_dfun</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872680"><span class="hs-identifier hs-var">real_dfun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-846"></a><span>          </span><span class="hs-comment">-- Two tricky points here:</span><span>
</span><a name="line-847"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-848"></a><span>          </span><span class="hs-comment">--  * The local_boot_fun should have a Name from the /boot-file/,</span><span>
</span><a name="line-849"></a><span>          </span><span class="hs-comment">--    but type from the dfun defined in /this module/.</span><span>
</span><a name="line-850"></a><span>          </span><span class="hs-comment">--    That ensures that the TyCon etc inside the type are</span><span>
</span><a name="line-851"></a><span>          </span><span class="hs-comment">--    the ones defined in this module, not the ones gotten</span><span>
</span><a name="line-852"></a><span>          </span><span class="hs-comment">--    from the hi-boot file, which may have a lot less info</span><span>
</span><a name="line-853"></a><span>          </span><span class="hs-comment">--    (Trac #8743, comment:10).</span><span>
</span><a name="line-854"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-855"></a><span>          </span><span class="hs-comment">--  * The DFunIds from boot_details are /GlobalIds/, because</span><span>
</span><a name="line-856"></a><span>          </span><span class="hs-comment">--    they come from typechecking M.hi-boot.</span><span>
</span><a name="line-857"></a><span>          </span><span class="hs-comment">--    But all bindings in this module should be for /LocalIds/,</span><span>
</span><a name="line-858"></a><span>          </span><span class="hs-comment">--    otherwise dependency analysis fails (Trac #16038). This</span><span>
</span><a name="line-859"></a><span>          </span><span class="hs-comment">--    is another reason for using mkExportedVanillaId, rather</span><span>
</span><a name="line-860"></a><span>          </span><span class="hs-comment">--    that modifying boot_dfun, to make local_boot_fun.</span><span>
</span><a name="line-861"></a><span>
</span><a name="line-862"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-863"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621683872679"><span class="hs-identifier hs-var">boot_dfun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-864"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;check_cls_inst&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-865"></a><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;local_insts&quot;</span><span>  </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-866"></a><span>                     </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">instanceDFunId</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872660"><span class="hs-identifier hs-var">local_insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-867"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;boot_dfun_ty&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872679"><span class="hs-identifier hs-var">boot_dfun</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-868"></a><span>
</span><a name="line-869"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#instMisMatch"><span class="hs-identifier hs-var">instMisMatch</span></a><span> </span><a href="#local-6989586621683872679"><span class="hs-identifier hs-var">boot_dfun</span></a><span class="hs-special">)</span><span>
</span><a name="line-870"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-871"></a><span>
</span><a name="line-872"></a><span>    </span><span class="hs-identifier">find_real_dfun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DFunId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">DFunId</span><span class="hs-special">]</span><span>
</span><a name="line-873"></a><span>    </span><a name="local-6989586621683872671"><a href="#local-6989586621683872671"><span class="hs-identifier">find_real_dfun</span></a></a><span> </span><a name="local-6989586621683872682"><a href="#local-6989586621683872682"><span class="hs-identifier">boot_dfun</span></a></a><span>
</span><a name="line-874"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683872685"><span class="hs-identifier hs-var">dfun</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683872684"><a href="#local-6989586621683872684"><span class="hs-identifier">inst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872660"><span class="hs-identifier hs-var">local_insts</span></a><span>
</span><a name="line-875"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872685"><a href="#local-6989586621683872685"><span class="hs-identifier">dfun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">instanceDFunId</span><span> </span><a href="#local-6989586621683872684"><span class="hs-identifier hs-var">inst</span></a><span>
</span><a name="line-876"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872685"><span class="hs-identifier hs-var">dfun</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872683"><span class="hs-identifier hs-var">boot_dfun_ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-877"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-878"></a><span>          </span><a name="local-6989586621683872683"><a href="#local-6989586621683872683"><span class="hs-identifier">boot_dfun_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872682"><span class="hs-identifier hs-var">boot_dfun</span></a><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span class="hs-comment">-- In general, to perform these checks we have to</span><span>
</span><a name="line-882"></a><span class="hs-comment">-- compare the TyThing from the .hi-boot file to the TyThing</span><span>
</span><a name="line-883"></a><span class="hs-comment">-- in the current source file.  We must be careful to allow alpha-renaming</span><span>
</span><a name="line-884"></a><span class="hs-comment">-- where appropriate, and also the boot declaration is allowed to omit</span><span>
</span><a name="line-885"></a><span class="hs-comment">-- constructors and class methods.</span><span>
</span><a name="line-886"></a><span class="hs-comment">--</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- See rnfail055 for a good test of this stuff.</span><span>
</span><a name="line-888"></a><span>
</span><a name="line-889"></a><span class="hs-comment">-- | Compares two things for equivalence between boot-file and normal code,</span><span>
</span><a name="line-890"></a><span class="hs-comment">-- reporting an error if they don't match up.</span><span>
</span><a name="line-891"></a><span class="hs-identifier">checkBootDeclM</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- ^ True &lt;=&gt; an hs-boot file (could also be a sig)</span><span>
</span><a name="line-892"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-893"></a><a name="checkBootDeclM"><a href="TcRnDriver.html#checkBootDeclM"><span class="hs-identifier">checkBootDeclM</span></a></a><span> </span><a name="local-6989586621683872687"><a href="#local-6989586621683872687"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-6989586621683872688"><a href="#local-6989586621683872688"><span class="hs-identifier">boot_thing</span></a></a><span> </span><a name="local-6989586621683872689"><a href="#local-6989586621683872689"><span class="hs-identifier">real_thing</span></a></a><span>
</span><a name="line-894"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">whenIsJust</span><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#checkBootDecl"><span class="hs-identifier hs-var">checkBootDecl</span></a><span> </span><a href="#local-6989586621683872687"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><a href="#local-6989586621683872688"><span class="hs-identifier hs-var">boot_thing</span></a><span> </span><a href="#local-6989586621683872689"><span class="hs-identifier hs-var">real_thing</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683872692"><a href="#local-6989586621683872692"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-895"></a><span>       </span><a href="TcRnMonad.html#addErrAt"><span class="hs-identifier hs-var">addErrAt</span></a><span> </span><a href="#local-6989586621683872690"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-896"></a><span>                </span><span class="hs-special">(</span><a href="TcRnDriver.html#bootMisMatch"><span class="hs-identifier hs-var">bootMisMatch</span></a><span> </span><a href="#local-6989586621683872687"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><a href="#local-6989586621683872692"><span class="hs-identifier hs-var">err</span></a><span> </span><a href="#local-6989586621683872689"><span class="hs-identifier hs-var">real_thing</span></a><span> </span><a href="#local-6989586621683872688"><span class="hs-identifier hs-var">boot_thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-897"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-898"></a><span>    </span><span class="hs-comment">-- Here we use the span of the boot thing or, if it doesn't have a sensible</span><span>
</span><a name="line-899"></a><span>    </span><span class="hs-comment">-- span, that of the real thing,</span><span>
</span><a name="line-900"></a><span>    </span><a name="local-6989586621683872690"><a href="#local-6989586621683872690"><span class="hs-identifier">span</span></a></a><span>
</span><a name="line-901"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872691"><a href="#local-6989586621683872691"><span class="hs-identifier">span</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621683872688"><span class="hs-identifier hs-var">boot_thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isGoodSrcSpan</span><span> </span><a href="#local-6989586621683872691"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-903"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872691"><span class="hs-identifier hs-var">span</span></a><span>
</span><a name="line-904"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-905"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621683872689"><span class="hs-identifier hs-var">real_thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>
</span><a name="line-907"></a><span class="hs-comment">-- | Compares the two things for equivalence between boot-file and normal</span><span>
</span><a name="line-908"></a><span class="hs-comment">-- code. Returns @Nothing@ on success or @Just &quot;some helpful info for user&quot;@</span><span>
</span><a name="line-909"></a><span class="hs-comment">-- failure. If the difference will be apparent to the user, @Just empty@ is</span><span>
</span><a name="line-910"></a><span class="hs-comment">-- perfectly suitable.</span><span>
</span><a name="line-911"></a><span class="hs-identifier">checkBootDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><a name="checkBootDecl"><a href="TcRnDriver.html#checkBootDecl"><span class="hs-identifier">checkBootDecl</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621683872693"><a href="#local-6989586621683872693"><span class="hs-identifier">id1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621683872694"><a href="#local-6989586621683872694"><span class="hs-identifier">id2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-914"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">id1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">id2</span><span class="hs-special">)</span><span>
</span><a name="line-915"></a><span>    </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872693"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872694"><span class="hs-identifier hs-var">id2</span></a><span class="hs-special">)</span><span>
</span><a name="line-916"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The two types are different&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-identifier">checkBootDecl</span><span> </span><a name="local-6989586621683872695"><a href="#local-6989586621683872695"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621683872696"><a href="#local-6989586621683872696"><span class="hs-identifier">tc1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621683872697"><a href="#local-6989586621683872697"><span class="hs-identifier">tc2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#checkBootTyCon"><span class="hs-identifier hs-var">checkBootTyCon</span></a><span> </span><a href="#local-6989586621683872695"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><a href="#local-6989586621683872696"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-6989586621683872697"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span class="hs-identifier">checkBootDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><a name="local-6989586621683872698"><a href="#local-6989586621683872698"><span class="hs-identifier">dc1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AConLike</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">RealDataCon</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;checkBootDecl&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872698"><span class="hs-identifier hs-var">dc1</span></a><span class="hs-special">)</span><span>
</span><a name="line-923"></a><span>
</span><a name="line-924"></a><span class="hs-identifier">checkBootDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-comment">-- probably shouldn't happen</span><span>
</span><a name="line-925"></a><span>
</span><a name="line-926"></a><span class="hs-comment">-- | Combines two potential error messages</span><span>
</span><a name="line-927"></a><span class="hs-identifier">andThenCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-928"></a><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">`</span><a name="andThenCheck"><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier">andThenCheck</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621683872699"><a href="#local-6989586621683872699"><span class="hs-identifier">msg</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872699"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-929"></a><a name="local-6989586621683872700"><a href="#local-6989586621683872700"><span class="hs-identifier">msg</span></a></a><span>     </span><span class="hs-special">`</span><span class="hs-identifier">andThenCheck</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872700"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-930"></a><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872701"><a href="#local-6989586621683872701"><span class="hs-identifier">d1</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">andThenCheck</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872702"><a href="#local-6989586621683872702"><span class="hs-identifier">d2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872701"><span class="hs-identifier hs-var">d1</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><a href="#local-6989586621683872702"><span class="hs-identifier hs-var">d2</span></a><span class="hs-special">)</span><span>
</span><a name="line-931"></a><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-932"></a><span>
</span><a name="line-933"></a><span class="hs-comment">-- | If the test in the first parameter is True, succeed with @Nothing@;</span><span>
</span><a name="line-934"></a><span class="hs-comment">-- otherwise, return the provided check</span><span>
</span><a name="line-935"></a><span class="hs-identifier">checkUnless</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-936"></a><a name="checkUnless"><a href="TcRnDriver.html#checkUnless"><span class="hs-identifier">checkUnless</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-937"></a><span class="hs-identifier">checkUnless</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621683872703"><a href="#local-6989586621683872703"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872703"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-938"></a><span>
</span><a name="line-939"></a><span class="hs-comment">-- | Run the check provided for every pair of elements in the lists.</span><span>
</span><a name="line-940"></a><span class="hs-comment">-- The provided SDoc should name the element type, in the plural.</span><span>
</span><a name="line-941"></a><span class="hs-identifier">checkListBy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872484"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683872484"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683872484"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683872484"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-942"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-943"></a><a name="checkListBy"><a href="TcRnDriver.html#checkListBy"><span class="hs-identifier">checkListBy</span></a></a><span> </span><a name="local-6989586621683872704"><a href="#local-6989586621683872704"><span class="hs-identifier">check_fun</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621683872706"><a href="#local-6989586621683872706"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621683872707"><a href="#local-6989586621683872707"><span class="hs-identifier">whats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872709"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621683872706"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-944"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-945"></a><span>    </span><a name="local-6989586621683872708"><a href="#local-6989586621683872708"><span class="hs-identifier">herald</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872707"><span class="hs-identifier hs-var">whats</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;do not match&quot;</span><span>
</span><a name="line-946"></a><span>
</span><a name="line-947"></a><span>    </span><a name="local-6989586621683872709"><a href="#local-6989586621683872709"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-948"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683872710"><a href="#local-6989586621683872710"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872708"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621683872710"><span class="hs-identifier hs-var">docs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-949"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621683872711"><a href="#local-6989586621683872711"><span class="hs-identifier">docs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683872712"><a href="#local-6989586621683872712"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683872713"><a href="#local-6989586621683872713"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872714"><a href="#local-6989586621683872714"><span class="hs-identifier">y</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683872715"><a href="#local-6989586621683872715"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683872704"><span class="hs-identifier hs-var">check_fun</span></a><span> </span><a href="#local-6989586621683872712"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621683872714"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-950"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872716"><a href="#local-6989586621683872716"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683872709"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872716"><span class="hs-identifier hs-var">doc</span></a><span class="hs-glyph">:</span><a href="#local-6989586621683872711"><span class="hs-identifier hs-var">docs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872713"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621683872715"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-951"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683872709"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621683872711"><span class="hs-identifier hs-var">docs</span></a><span>       </span><a href="#local-6989586621683872713"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621683872715"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-952"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872708"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">colon</span><span class="hs-special">)</span><span>
</span><a name="line-953"></a><span>                            </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;There are different numbers of&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872707"><span class="hs-identifier hs-var">whats</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-954"></a><span>
</span><a name="line-955"></a><span class="hs-comment">-- | If the test in the first parameter is True, succeed with @Nothing@;</span><span>
</span><a name="line-956"></a><span class="hs-comment">-- otherwise, fail with the given SDoc.</span><span>
</span><a name="line-957"></a><span class="hs-identifier">check</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-958"></a><a name="check"><a href="TcRnDriver.html#check"><span class="hs-identifier">check</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-959"></a><span class="hs-identifier">check</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621683872717"><a href="#local-6989586621683872717"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683872717"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-960"></a><span>
</span><a name="line-961"></a><span class="hs-comment">-- | A more perspicuous name for @Nothing@, for @checkBootDecl@ and friends.</span><span>
</span><a name="line-962"></a><span class="hs-identifier">checkSuccess</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-963"></a><a name="checkSuccess"><a href="TcRnDriver.html#checkSuccess"><span class="hs-identifier">checkSuccess</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-964"></a><span>
</span><a name="line-965"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-966"></a><span class="hs-identifier">checkBootTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-967"></a><a name="checkBootTyCon"><a href="TcRnDriver.html#checkBootTyCon"><span class="hs-identifier">checkBootTyCon</span></a></a><span> </span><a name="local-6989586621683872718"><a href="#local-6989586621683872718"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-6989586621683872719"><a href="#local-6989586621683872719"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-6989586621683872720"><a href="#local-6989586621683872720"><span class="hs-identifier">tc2</span></a></a><span>
</span><a name="line-968"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-969"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The types have different kinds&quot;</span><span>    </span><span class="hs-comment">-- First off, check the kind</span><span>
</span><a name="line-970"></a><span>
</span><a name="line-971"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872767"><a href="#local-6989586621683872767"><span class="hs-identifier">c1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span>
</span><a name="line-972"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872768"><a href="#local-6989586621683872768"><span class="hs-identifier">c2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-973"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872769"><a href="#local-6989586621683872769"><span class="hs-identifier">clas_tvs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872770"><a href="#local-6989586621683872770"><span class="hs-identifier">clas_fds1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872771"><a href="#local-6989586621683872771"><span class="hs-identifier">sc_theta1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872772"><a href="#local-6989586621683872772"><span class="hs-identifier">ats1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872773"><a href="#local-6989586621683872773"><span class="hs-identifier">op_stuff1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">classExtraBigSig</span><span> </span><a href="#local-6989586621683872767"><span class="hs-identifier hs-var">c1</span></a><span>
</span><a name="line-975"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683872774"><a href="#local-6989586621683872774"><span class="hs-identifier">clas_tvs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872775"><a href="#local-6989586621683872775"><span class="hs-identifier">clas_fds2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872776"><a href="#local-6989586621683872776"><span class="hs-identifier">sc_theta2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872777"><a href="#local-6989586621683872777"><span class="hs-identifier">ats2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872778"><a href="#local-6989586621683872778"><span class="hs-identifier">op_stuff2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">classExtraBigSig</span><span> </span><a href="#local-6989586621683872768"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-977"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872779"><a href="#local-6989586621683872779"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">eqVarBndrs</span><span> </span><a href="TcRnDriver.html#emptyRnEnv2"><span class="hs-identifier hs-var">emptyRnEnv2</span></a><span> </span><a href="#local-6989586621683872769"><span class="hs-identifier hs-var">clas_tvs1</span></a><span> </span><a href="#local-6989586621683872774"><span class="hs-identifier hs-var">clas_tvs2</span></a><span>
</span><a name="line-978"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-979"></a><span>       </span><a name="local-6989586621683872780"><a href="#local-6989586621683872780"><span class="hs-identifier">eqSig</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683872786"><a href="#local-6989586621683872786"><span class="hs-identifier">id1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872787"><a href="#local-6989586621683872787"><span class="hs-identifier">def_meth1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872788"><a href="#local-6989586621683872788"><span class="hs-identifier">id2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872789"><a href="#local-6989586621683872789"><span class="hs-identifier">def_meth2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-980"></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872790"><span class="hs-identifier hs-var">name1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683872791"><span class="hs-identifier hs-var">name2</span></a><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The names&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872792"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;and&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872793"><span class="hs-identifier hs-var">pname2</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-982"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;are different&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-983"></a><span>           </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683872795"><span class="hs-identifier hs-var">op_ty1</span></a><span> </span><a href="#local-6989586621683872797"><span class="hs-identifier hs-var">op_ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The types of&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872792"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-985"></a><span>                  </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;are different&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-986"></a><span>           </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683872718"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-987"></a><span>               </span><span class="hs-keyword">then</span><span> </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqMaybeBy</span><span> </span><a href="#local-6989586621683872782"><span class="hs-identifier hs-var">eqDM</span></a><span> </span><a href="#local-6989586621683872787"><span class="hs-identifier hs-var">def_meth1</span></a><span> </span><a href="#local-6989586621683872789"><span class="hs-identifier hs-var">def_meth2</span></a><span class="hs-special">)</span><span>
</span><a name="line-988"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The default methods associated with&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872792"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-989"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;are different&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-990"></a><span>               </span><span class="hs-keyword">else</span><span> </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872783"><span class="hs-identifier hs-var">subDM</span></a><span> </span><a href="#local-6989586621683872795"><span class="hs-identifier hs-var">op_ty1</span></a><span> </span><a href="#local-6989586621683872787"><span class="hs-identifier hs-var">def_meth1</span></a><span> </span><a href="#local-6989586621683872789"><span class="hs-identifier hs-var">def_meth2</span></a><span class="hs-special">)</span><span>
</span><a name="line-991"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The default methods associated with&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872792"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-992"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;are not compatible&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-993"></a><span>         </span><span class="hs-keyword">where</span><span>
</span><a name="line-994"></a><span>          </span><a name="local-6989586621683872790"><a href="#local-6989586621683872790"><span class="hs-identifier">name1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683872786"><span class="hs-identifier hs-var">id1</span></a><span>
</span><a name="line-995"></a><span>          </span><a name="local-6989586621683872791"><a href="#local-6989586621683872791"><span class="hs-identifier">name2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683872788"><span class="hs-identifier hs-var">id2</span></a><span>
</span><a name="line-996"></a><span>          </span><a name="local-6989586621683872792"><a href="#local-6989586621683872792"><span class="hs-identifier">pname1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872790"><span class="hs-identifier hs-var">name1</span></a><span class="hs-special">)</span><span>
</span><a name="line-997"></a><span>          </span><a name="local-6989586621683872793"><a href="#local-6989586621683872793"><span class="hs-identifier">pname2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872791"><span class="hs-identifier hs-var">name2</span></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872794"><a href="#local-6989586621683872794"><span class="hs-identifier">rho_ty1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitForAllTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872786"><span class="hs-identifier hs-var">id1</span></a><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span>          </span><a name="local-6989586621683872795"><a href="#local-6989586621683872795"><span class="hs-identifier">op_ty1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">funResultTy</span><span> </span><a href="#local-6989586621683872794"><span class="hs-identifier hs-var">rho_ty1</span></a><span>
</span><a name="line-1000"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872796"><a href="#local-6989586621683872796"><span class="hs-identifier">rho_ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitForAllTys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872788"><span class="hs-identifier hs-var">id2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1001"></a><span>          </span><a name="local-6989586621683872797"><a href="#local-6989586621683872797"><span class="hs-identifier">op_ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">funResultTy</span><span> </span><a href="#local-6989586621683872796"><span class="hs-identifier hs-var">rho_ty2</span></a><span>
</span><a name="line-1002"></a><span>
</span><a name="line-1003"></a><span>       </span><a name="local-6989586621683872781"><a href="#local-6989586621683872781"><span class="hs-identifier">eqAT</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATI</span><span> </span><a name="local-6989586621683872798"><a href="#local-6989586621683872798"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-6989586621683872799"><a href="#local-6989586621683872799"><span class="hs-identifier">def_ats1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATI</span><span> </span><a name="local-6989586621683872800"><a href="#local-6989586621683872800"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-6989586621683872801"><a href="#local-6989586621683872801"><span class="hs-identifier">def_ats2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1004"></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#checkBootTyCon"><span class="hs-identifier hs-var">checkBootTyCon</span></a><span> </span><a href="#local-6989586621683872718"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><a href="#local-6989586621683872798"><span class="hs-identifier hs-var">tc1</span></a><span> </span><a href="#local-6989586621683872800"><span class="hs-identifier hs-var">tc2</span></a><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1005"></a><span>           </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872784"><span class="hs-identifier hs-var">eqATDef</span></a><span> </span><a href="#local-6989586621683872799"><span class="hs-identifier hs-var">def_ats1</span></a><span> </span><a href="#local-6989586621683872801"><span class="hs-identifier hs-var">def_ats2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1006"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The associated type defaults differ&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><span>
</span><a name="line-1008"></a><span>       </span><a name="local-6989586621683872782"><a href="#local-6989586621683872782"><span class="hs-identifier">eqDM</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span class="hs-special">)</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1009"></a><span>       </span><span class="hs-identifier">eqDM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621683872802"><a href="#local-6989586621683872802"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621683872803"><a href="#local-6989586621683872803"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683872802"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621683872803"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1010"></a><span>       </span><span class="hs-identifier">eqDM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1011"></a><span>
</span><a name="line-1012"></a><span>       </span><span class="hs-comment">-- NB: first argument is from hsig, second is from real impl.</span><span>
</span><a name="line-1013"></a><span>       </span><span class="hs-comment">-- Order of pattern matching matters.</span><span>
</span><a name="line-1014"></a><span>       </span><a name="local-6989586621683872783"><a href="#local-6989586621683872783"><span class="hs-identifier">subDM</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1015"></a><span>       </span><span class="hs-identifier">subDM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1016"></a><span>       </span><span class="hs-comment">-- If the hsig wrote:</span><span>
</span><a name="line-1017"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-1018"></a><span>       </span><span class="hs-comment">--   f :: a -&gt; a</span><span>
</span><a name="line-1019"></a><span>       </span><span class="hs-comment">--   default f :: a -&gt; a</span><span>
</span><a name="line-1020"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-1021"></a><span>       </span><span class="hs-comment">-- this should be validly implementable using an old-fashioned</span><span>
</span><a name="line-1022"></a><span>       </span><span class="hs-comment">-- vanilla default method.</span><span>
</span><a name="line-1023"></a><span>       </span><span class="hs-identifier">subDM</span><span> </span><a name="local-6989586621683872804"><a href="#local-6989586621683872804"><span class="hs-identifier">t1</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621683872805"><a href="#local-6989586621683872805"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683872804"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621683872805"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1025"></a><span>       </span><span class="hs-comment">-- This case can occur when merging signatures</span><span>
</span><a name="line-1026"></a><span>       </span><span class="hs-identifier">subDM</span><span> </span><a name="local-6989586621683872806"><a href="#local-6989586621683872806"><span class="hs-identifier">t1</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621683872807"><a href="#local-6989586621683872807"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683872806"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621683872807"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1028"></a><span>       </span><span class="hs-identifier">subDM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">VanillaDM</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1029"></a><span>       </span><span class="hs-identifier">subDM</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621683872808"><a href="#local-6989586621683872808"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GenericDM</span><span> </span><a name="local-6989586621683872809"><a href="#local-6989586621683872809"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1030"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683872808"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621683872809"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span>       </span><span class="hs-comment">-- Ignore the location of the defaults</span><span>
</span><a name="line-1033"></a><span>       </span><a name="local-6989586621683872784"><a href="#local-6989586621683872784"><span class="hs-identifier">eqATDef</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>             </span><span class="hs-identifier hs-var">Nothing</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1034"></a><span>       </span><span class="hs-identifier">eqATDef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872810"><a href="#local-6989586621683872810"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872811"><a href="#local-6989586621683872811"><span class="hs-identifier">_loc1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872812"><a href="#local-6989586621683872812"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872813"><a href="#local-6989586621683872813"><span class="hs-identifier">_loc2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683872810"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621683872812"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1035"></a><span>       </span><span class="hs-identifier">eqATDef</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1036"></a><span>
</span><a name="line-1037"></a><span>       </span><a name="local-6989586621683872785"><a href="#local-6989586621683872785"><span class="hs-identifier">eqFD</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683872814"><a href="#local-6989586621683872814"><span class="hs-identifier">as1</span></a></a><span class="hs-special">,</span><a name="local-6989586621683872815"><a href="#local-6989586621683872815"><span class="hs-identifier">bs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872816"><a href="#local-6989586621683872816"><span class="hs-identifier">as2</span></a></a><span class="hs-special">,</span><a name="local-6989586621683872817"><a href="#local-6989586621683872817"><span class="hs-identifier">bs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1038"></a><span>         </span><span class="hs-identifier hs-var">eqListBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683872814"><span class="hs-identifier hs-var">as1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683872816"><span class="hs-identifier hs-var">as2</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1039"></a><span>         </span><span class="hs-identifier hs-var">eqListBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683872815"><span class="hs-identifier hs-var">bs1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarTys</span><span> </span><a href="#local-6989586621683872817"><span class="hs-identifier hs-var">bs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1040"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-1041"></a><span>    </span><a href="#local-6989586621683872725"><span class="hs-identifier hs-var">checkRoles</span></a><span> </span><a href="#local-6989586621683872721"><span class="hs-identifier hs-var">roles1</span></a><span> </span><a href="#local-6989586621683872722"><span class="hs-identifier hs-var">roles2</span></a><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1042"></a><span>          </span><span class="hs-comment">-- Checks kind of class</span><span>
</span><a name="line-1043"></a><span>    </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqListBy</span><span> </span><a href="#local-6989586621683872785"><span class="hs-identifier hs-var">eqFD</span></a><span> </span><a href="#local-6989586621683872770"><span class="hs-identifier hs-var">clas_fds1</span></a><span> </span><a href="#local-6989586621683872775"><span class="hs-identifier hs-var">clas_fds2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1044"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The functional dependencies do not match&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1045"></a><span>    </span><a href="TcRnDriver.html#checkUnless"><span class="hs-identifier hs-var">checkUnless</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isAbstractTyCon</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1046"></a><span>    </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqListBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872779"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872771"><span class="hs-identifier hs-var">sc_theta1</span></a><span> </span><a href="#local-6989586621683872776"><span class="hs-identifier hs-var">sc_theta2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1047"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The class constraints do not match&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1048"></a><span>    </span><a href="TcRnDriver.html#checkListBy"><span class="hs-identifier hs-var">checkListBy</span></a><span> </span><a href="#local-6989586621683872780"><span class="hs-identifier hs-var">eqSig</span></a><span> </span><a href="#local-6989586621683872773"><span class="hs-identifier hs-var">op_stuff1</span></a><span> </span><a href="#local-6989586621683872778"><span class="hs-identifier hs-var">op_stuff2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;methods&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1049"></a><span>    </span><a href="TcRnDriver.html#checkListBy"><span class="hs-identifier hs-var">checkListBy</span></a><span> </span><a href="#local-6989586621683872781"><span class="hs-identifier hs-var">eqAT</span></a><span> </span><a href="#local-6989586621683872772"><span class="hs-identifier hs-var">ats1</span></a><span> </span><a href="#local-6989586621683872777"><span class="hs-identifier hs-var">ats2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;associated types&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1050"></a><span>    </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">classMinimalDef</span><span> </span><a href="#local-6989586621683872767"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">BF.implies</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">classMinimalDef</span><span> </span><a href="#local-6989586621683872768"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1051"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The MINIMAL pragmas are not compatible&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>
</span><a name="line-1053"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872818"><a href="#local-6989586621683872818"><span class="hs-identifier">syn_rhs1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">synTyConRhs_maybe</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span>
</span><a name="line-1054"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872819"><a href="#local-6989586621683872819"><span class="hs-identifier">syn_rhs2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">synTyConRhs_maybe</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1055"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872820"><a href="#local-6989586621683872820"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">eqVarBndrs</span><span> </span><a href="TcRnDriver.html#emptyRnEnv2"><span class="hs-identifier hs-var">emptyRnEnv2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1056"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">tc1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">tc2</span><span class="hs-special">)</span><span>
</span><a name="line-1057"></a><span>    </span><a href="#local-6989586621683872725"><span class="hs-identifier hs-var">checkRoles</span></a><span> </span><a href="#local-6989586621683872721"><span class="hs-identifier hs-var">roles1</span></a><span> </span><a href="#local-6989586621683872722"><span class="hs-identifier hs-var">roles2</span></a><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1058"></a><span>    </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872820"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683872818"><span class="hs-identifier hs-var">syn_rhs1</span></a><span> </span><a href="#local-6989586621683872819"><span class="hs-identifier hs-var">syn_rhs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">empty</span><span>   </span><span class="hs-comment">-- nothing interesting to say</span><span>
</span><a name="line-1059"></a><span>  </span><span class="hs-comment">-- This allows abstract 'data T a' to be implemented using 'type T = ...'</span><span>
</span><a name="line-1060"></a><span>  </span><span class="hs-comment">-- and abstract 'class K a' to be implement using 'type K = ...'</span><span>
</span><a name="line-1061"></a><span>  </span><span class="hs-comment">-- See Note [Synonyms implement abstract data]</span><span>
</span><a name="line-1062"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621683872718"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-comment">-- don't support for hs-boot yet</span><span>
</span><a name="line-1063"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isAbstractTyCon</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span>
</span><a name="line-1064"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872821"><a href="#local-6989586621683872821"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872822"><a href="#local-6989586621683872822"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">synTyConDefn_maybe</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1065"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872823"><a href="#local-6989586621683872823"><span class="hs-identifier">tc2'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872824"><a href="#local-6989586621683872824"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span><span> </span><a href="#local-6989586621683872822"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872727"><span class="hs-identifier hs-var">checkSynAbsData</span></a><span> </span><a href="#local-6989586621683872821"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621683872822"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683872823"><span class="hs-identifier hs-var">tc2'</span></a><span> </span><a href="#local-6989586621683872824"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1067"></a><span>    </span><span class="hs-comment">-- TODO: When it's a synonym implementing a class, we really</span><span>
</span><a name="line-1068"></a><span>    </span><span class="hs-comment">-- should check if the fundeps are satisfied, but</span><span>
</span><a name="line-1069"></a><span>    </span><span class="hs-comment">-- there is not an obvious way to do this for a constraint synonym.</span><span>
</span><a name="line-1070"></a><span>    </span><span class="hs-comment">-- So for now, let it all through (it won't cause segfaults, anyway).</span><span>
</span><a name="line-1071"></a><span>    </span><span class="hs-comment">-- Tracked at #12704.</span><span>
</span><a name="line-1072"></a><span>
</span><a name="line-1073"></a><span>  </span><span class="hs-comment">-- This allows abstract 'data T :: Nat' to be implemented using</span><span>
</span><a name="line-1074"></a><span>  </span><span class="hs-comment">-- 'type T = 42' Since the kinds already match (we have checked this</span><span>
</span><a name="line-1075"></a><span>  </span><span class="hs-comment">-- upfront) all we need to check is that the implementation 'type T</span><span>
</span><a name="line-1076"></a><span>  </span><span class="hs-comment">-- = ...' defined an actual literal.  See #15138 for the case this</span><span>
</span><a name="line-1077"></a><span>  </span><span class="hs-comment">-- handles.</span><span>
</span><a name="line-1078"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621683872718"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isAbstractTyCon</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span>
</span><a name="line-1080"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621683872825"><a href="#local-6989586621683872825"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">synTyConDefn_maybe</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1081"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isLitTy</span><span> </span><a href="#local-6989586621683872825"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1082"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1083"></a><span>
</span><a name="line-1084"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872826"><a href="#local-6989586621683872826"><span class="hs-identifier">fam_flav1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">famTyConFlav_maybe</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span>
</span><a name="line-1085"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872827"><a href="#local-6989586621683872827"><span class="hs-identifier">fam_flav2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">famTyConFlav_maybe</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1086"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">tc1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">tc2</span><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872828"><a href="#local-6989586621683872828"><span class="hs-identifier">eqFamFlav</span></a></a><span> </span><span class="hs-identifier hs-var">OpenSynFamilyTyCon</span><span>   </span><span class="hs-identifier hs-var">OpenSynFamilyTyCon</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1088"></a><span>        </span><span class="hs-identifier">eqFamFlav</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamilyTyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataFamilyTyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1089"></a><span>        </span><span class="hs-comment">-- This case only happens for hsig merging:</span><span>
</span><a name="line-1090"></a><span>        </span><span class="hs-identifier">eqFamFlav</span><span> </span><span class="hs-identifier hs-var">AbstractClosedSynFamilyTyCon</span><span> </span><span class="hs-identifier hs-var">AbstractClosedSynFamilyTyCon</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1091"></a><span>        </span><span class="hs-identifier">eqFamFlav</span><span> </span><span class="hs-identifier hs-var">AbstractClosedSynFamilyTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1092"></a><span>        </span><span class="hs-identifier">eqFamFlav</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">AbstractClosedSynFamilyTyCon</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1093"></a><span>        </span><span class="hs-identifier">eqFamFlav</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span><span> </span><a name="local-6989586621683872831"><a href="#local-6989586621683872831"><span class="hs-identifier">ax1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span><span> </span><a name="local-6989586621683872832"><a href="#local-6989586621683872832"><span class="hs-identifier">ax2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1094"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872730"><span class="hs-identifier hs-var">eqClosedFamilyAx</span></a><span> </span><a href="#local-6989586621683872831"><span class="hs-identifier hs-var">ax1</span></a><span> </span><a href="#local-6989586621683872832"><span class="hs-identifier hs-var">ax2</span></a><span>
</span><a name="line-1095"></a><span>        </span><span class="hs-identifier">eqFamFlav</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BuiltInSynFamTyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BuiltInSynFamTyCon</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1096"></a><span>        </span><span class="hs-identifier">eqFamFlav</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1097"></a><span>        </span><a name="local-6989586621683872829"><a href="#local-6989586621683872829"><span class="hs-identifier">injInfo1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConInjectivityInfo</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span>
</span><a name="line-1098"></a><span>        </span><a name="local-6989586621683872830"><a href="#local-6989586621683872830"><span class="hs-identifier">injInfo2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConInjectivityInfo</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1099"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-1100"></a><span>    </span><span class="hs-comment">-- check equality of roles, family flavours and injectivity annotations</span><span>
</span><a name="line-1101"></a><span>    </span><span class="hs-comment">-- (NB: Type family roles are always nominal. But the check is</span><span>
</span><a name="line-1102"></a><span>    </span><span class="hs-comment">-- harmless enough.)</span><span>
</span><a name="line-1103"></a><span>    </span><a href="#local-6989586621683872725"><span class="hs-identifier hs-var">checkRoles</span></a><span> </span><a href="#local-6989586621683872721"><span class="hs-identifier hs-var">roles1</span></a><span> </span><a href="#local-6989586621683872722"><span class="hs-identifier hs-var">roles2</span></a><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1104"></a><span>    </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872828"><span class="hs-identifier hs-var">eqFamFlav</span></a><span> </span><a href="#local-6989586621683872826"><span class="hs-identifier hs-var">fam_flav1</span></a><span> </span><a href="#local-6989586621683872827"><span class="hs-identifier hs-var">fam_flav2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1105"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">whenPprDebug</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1106"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Family flavours&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872826"><span class="hs-identifier hs-var">fam_flav1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;and&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872827"><span class="hs-identifier hs-var">fam_flav2</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1107"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;do not match&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1108"></a><span>    </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872829"><span class="hs-identifier hs-var">injInfo1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683872830"><span class="hs-identifier hs-var">injInfo2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Injectivities do not match&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1109"></a><span>
</span><a name="line-1110"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isAlgTyCon</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1111"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872833"><a href="#local-6989586621683872833"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">eqVarBndrs</span><span> </span><a href="TcRnDriver.html#emptyRnEnv2"><span class="hs-identifier hs-var">emptyRnEnv2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1112"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier hs-var">tc1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">tc2</span><span class="hs-special">)</span><span>
</span><a name="line-1113"></a><span>    </span><a href="#local-6989586621683872725"><span class="hs-identifier hs-var">checkRoles</span></a><span> </span><a href="#local-6989586621683872721"><span class="hs-identifier hs-var">roles1</span></a><span> </span><a href="#local-6989586621683872722"><span class="hs-identifier hs-var">roles2</span></a><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1114"></a><span>    </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqListBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872833"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1115"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConStupidTheta</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConStupidTheta</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1116"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The datatype contexts do not match&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1117"></a><span>    </span><a href="#local-6989586621683872728"><span class="hs-identifier hs-var">eqAlgRhs</span></a><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">algTyConRhs</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">algTyConRhs</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1118"></a><span>
</span><a name="line-1119"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">empty</span><span>   </span><span class="hs-comment">-- two very different types -- should be obvious</span><span>
</span><a name="line-1120"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1121"></a><span>    </span><a name="local-6989586621683872721"><a href="#local-6989586621683872721"><span class="hs-identifier">roles1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-comment">-- the abstract one</span><span>
</span><a name="line-1122"></a><span>    </span><a name="local-6989586621683872722"><a href="#local-6989586621683872722"><span class="hs-identifier">roles2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621683872720"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1123"></a><span>    </span><a name="local-6989586621683872723"><a href="#local-6989586621683872723"><span class="hs-identifier">roles_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The roles do not match.&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1124"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Roles on abstract types default to&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1125"></a><span>                 </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;representational&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;in boot files.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span>    </span><a name="local-6989586621683872724"><a href="#local-6989586621683872724"><span class="hs-identifier">roles_subtype_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The roles are not compatible:&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1128"></a><span>                        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Main module:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872722"><span class="hs-identifier hs-var">roles2</span></a><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1129"></a><span>                        </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Hsig file:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872721"><span class="hs-identifier hs-var">roles1</span></a><span>
</span><a name="line-1130"></a><span>
</span><a name="line-1131"></a><span>    </span><a name="local-6989586621683872725"><a href="#local-6989586621683872725"><span class="hs-identifier">checkRoles</span></a></a><span> </span><a name="local-6989586621683872732"><a href="#local-6989586621683872732"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-6989586621683872733"><a href="#local-6989586621683872733"><span class="hs-identifier">r2</span></a></a><span>
</span><a name="line-1132"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683872718"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isInjectiveTyCon</span><span> </span><a href="#local-6989586621683872719"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-identifier hs-var">Representational</span><span> </span><span class="hs-comment">-- See Note [Role subtyping]</span><span>
</span><a name="line-1133"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872732"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683872733"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872723"><span class="hs-identifier hs-var">roles_msg</span></a><span>
</span><a name="line-1134"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872733"><span class="hs-identifier hs-var">r2</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621683872726"><span class="hs-identifier hs-var">rolesSubtypeOf</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872732"><span class="hs-identifier hs-var">r1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872724"><span class="hs-identifier hs-var">roles_subtype_msg</span></a><span>
</span><a name="line-1135"></a><span>
</span><a name="line-1136"></a><span>    </span><span class="hs-comment">-- Note [Role subtyping]</span><span>
</span><a name="line-1137"></a><span>    </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1138"></a><span>    </span><span class="hs-comment">-- In the current formulation of roles, role subtyping is only OK if the</span><span>
</span><a name="line-1139"></a><span>    </span><span class="hs-comment">-- &quot;abstract&quot; TyCon was not representationally injective.  Among the most</span><span>
</span><a name="line-1140"></a><span>    </span><span class="hs-comment">-- notable examples of non representationally injective TyCons are abstract</span><span>
</span><a name="line-1141"></a><span>    </span><span class="hs-comment">-- data, which can be implemented via newtypes (which are not</span><span>
</span><a name="line-1142"></a><span>    </span><span class="hs-comment">-- representationally injective).  The key example is</span><span>
</span><a name="line-1143"></a><span>    </span><span class="hs-comment">-- in this example from #13140:</span><span>
</span><a name="line-1144"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1145"></a><span>    </span><span class="hs-comment">--      -- In an hsig file</span><span>
</span><a name="line-1146"></a><span>    </span><span class="hs-comment">--      data T a -- abstract!</span><span>
</span><a name="line-1147"></a><span>    </span><span class="hs-comment">--      type role T nominal</span><span>
</span><a name="line-1148"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1149"></a><span>    </span><span class="hs-comment">--      -- Elsewhere</span><span>
</span><a name="line-1150"></a><span>    </span><span class="hs-comment">--      foo :: Coercible (T a) (T b) =&gt; a -&gt; b</span><span>
</span><a name="line-1151"></a><span>    </span><span class="hs-comment">--      foo x = x</span><span>
</span><a name="line-1152"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1153"></a><span>    </span><span class="hs-comment">-- We must NOT allow foo to typecheck, because if we instantiate</span><span>
</span><a name="line-1154"></a><span>    </span><span class="hs-comment">-- T with a concrete data type with a phantom role would cause</span><span>
</span><a name="line-1155"></a><span>    </span><span class="hs-comment">-- Coercible (T a) (T b) to be provable.  Fortunately, if T is not</span><span>
</span><a name="line-1156"></a><span>    </span><span class="hs-comment">-- representationally injective, we cannot make the inference that a ~N b if</span><span>
</span><a name="line-1157"></a><span>    </span><span class="hs-comment">-- T a ~R T b.</span><span>
</span><a name="line-1158"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1159"></a><span>    </span><span class="hs-comment">-- Unconditional role subtyping would be possible if we setup</span><span>
</span><a name="line-1160"></a><span>    </span><span class="hs-comment">-- an extra set of roles saying when we can project out coercions</span><span>
</span><a name="line-1161"></a><span>    </span><span class="hs-comment">-- (we call these proj-roles); then it would NOT be valid to instantiate T</span><span>
</span><a name="line-1162"></a><span>    </span><span class="hs-comment">-- with a data type at phantom since the proj-role subtyping check</span><span>
</span><a name="line-1163"></a><span>    </span><span class="hs-comment">-- would fail.  See #13140 for more details.</span><span>
</span><a name="line-1164"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1165"></a><span>    </span><span class="hs-comment">-- One consequence of this is we get no role subtyping for non-abstract</span><span>
</span><a name="line-1166"></a><span>    </span><span class="hs-comment">-- data types in signatures. Suppose you have:</span><span>
</span><a name="line-1167"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1168"></a><span>    </span><span class="hs-comment">--      signature A where</span><span>
</span><a name="line-1169"></a><span>    </span><span class="hs-comment">--          type role T nominal</span><span>
</span><a name="line-1170"></a><span>    </span><span class="hs-comment">--          data T a = MkT</span><span>
</span><a name="line-1171"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1172"></a><span>    </span><span class="hs-comment">-- If you write this, we'll treat T as injective, and make inferences</span><span>
</span><a name="line-1173"></a><span>    </span><span class="hs-comment">-- like T a ~R T b ==&gt; a ~N b (mkNthCo).  But if we can</span><span>
</span><a name="line-1174"></a><span>    </span><span class="hs-comment">-- subsequently replace T with one at phantom role, we would then be able to</span><span>
</span><a name="line-1175"></a><span>    </span><span class="hs-comment">-- infer things like T Int ~R T Bool which is bad news.</span><span>
</span><a name="line-1176"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1177"></a><span>    </span><span class="hs-comment">-- We could allow role subtyping here if we didn't treat *any* data types</span><span>
</span><a name="line-1178"></a><span>    </span><span class="hs-comment">-- defined in signatures as injective.  But this would be a bit surprising,</span><span>
</span><a name="line-1179"></a><span>    </span><span class="hs-comment">-- replacing a data type in a module with one in a signature could cause</span><span>
</span><a name="line-1180"></a><span>    </span><span class="hs-comment">-- your code to stop typechecking (whereas if you made the type abstract,</span><span>
</span><a name="line-1181"></a><span>    </span><span class="hs-comment">-- it is more understandable that the type checker knows less).</span><span>
</span><a name="line-1182"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1183"></a><span>    </span><span class="hs-comment">-- It would have been best if this was purely a question of defaults</span><span>
</span><a name="line-1184"></a><span>    </span><span class="hs-comment">-- (i.e., a user could explicitly ask for one behavior or another) but</span><span>
</span><a name="line-1185"></a><span>    </span><span class="hs-comment">-- the current role system isn't expressive enough to do this.</span><span>
</span><a name="line-1186"></a><span>    </span><span class="hs-comment">-- Having explict proj-roles would solve this problem.</span><span>
</span><a name="line-1187"></a><span>
</span><a name="line-1188"></a><span>    </span><a name="local-6989586621683872726"><a href="#local-6989586621683872726"><span class="hs-identifier">rolesSubtypeOf</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1189"></a><span>    </span><span class="hs-comment">-- NB: this relation is the OPPOSITE of the subroling relation</span><span>
</span><a name="line-1190"></a><span>    </span><span class="hs-identifier">rolesSubtypeOf</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872734"><a href="#local-6989586621683872734"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683872735"><a href="#local-6989586621683872735"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872736"><a href="#local-6989586621683872736"><span class="hs-identifier">y</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683872737"><a href="#local-6989586621683872737"><span class="hs-identifier">ys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872734"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621683872736"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683872726"><span class="hs-identifier hs-var">rolesSubtypeOf</span></a><span> </span><a href="#local-6989586621683872735"><span class="hs-identifier hs-var">xs</span></a><span> </span><a href="#local-6989586621683872737"><span class="hs-identifier hs-var">ys</span></a><span>
</span><a name="line-1191"></a><span>    </span><span class="hs-identifier">rolesSubtypeOf</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1192"></a><span>
</span><a name="line-1193"></a><span>    </span><span class="hs-comment">-- Note [Synonyms implement abstract data]</span><span>
</span><a name="line-1194"></a><span>    </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-1195"></a><span>    </span><span class="hs-comment">-- An abstract data type or class can be implemented using a type synonym,</span><span>
</span><a name="line-1196"></a><span>    </span><span class="hs-comment">-- but ONLY if the type synonym is nullary and has no type family</span><span>
</span><a name="line-1197"></a><span>    </span><span class="hs-comment">-- applications.  This arises from two properties of skolem abstract data:</span><span>
</span><a name="line-1198"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1199"></a><span>    </span><span class="hs-comment">--    For any T (with some number of paramaters),</span><span>
</span><a name="line-1200"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1201"></a><span>    </span><span class="hs-comment">--    1. T is a valid type (it is &quot;curryable&quot;), and</span><span>
</span><a name="line-1202"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1203"></a><span>    </span><span class="hs-comment">--    2. T is valid in an instance head (no type families).</span><span>
</span><a name="line-1204"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1205"></a><span>    </span><span class="hs-comment">-- See also 'HowAbstract' and Note [Skolem abstract data].</span><span>
</span><a name="line-1206"></a><span>
</span><a name="line-1207"></a><span>    </span><span class="hs-comment">-- | Given @type T tvs = ty@, where @ty@ decomposes into @tc2' args@,</span><span>
</span><a name="line-1208"></a><span>    </span><span class="hs-comment">-- check that this synonym is an acceptable implementation of @tc1@.</span><span>
</span><a name="line-1209"></a><span>    </span><span class="hs-comment">-- See Note [Synonyms implement abstract data]</span><span>
</span><a name="line-1210"></a><span>    </span><span class="hs-identifier">checkSynAbsData</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1211"></a><span>    </span><a name="local-6989586621683872727"><a href="#local-6989586621683872727"><span class="hs-identifier">checkSynAbsData</span></a></a><span> </span><a name="local-6989586621683872738"><a href="#local-6989586621683872738"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621683872739"><a href="#local-6989586621683872739"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683872740"><a href="#local-6989586621683872740"><span class="hs-identifier">tc2'</span></a></a><span> </span><a name="local-6989586621683872741"><a href="#local-6989586621683872741"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1212"></a><span>        </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTyFamInsts</span><span> </span><a href="#local-6989586621683872739"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1213"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal type family application in implementation of abstract data.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1214"></a><span>                </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1215"></a><span>        </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683872738"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1216"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Illegal parameterized type synonym in implementation of abstract data.&quot;</span><span> </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1217"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;(Try eta reducing your type synonym so that it is nullary.)&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1218"></a><span>                </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1219"></a><span>        </span><span class="hs-comment">-- Don't report roles errors unless the type synonym is nullary</span><span>
</span><a name="line-1220"></a><span>        </span><a href="TcRnDriver.html#checkUnless"><span class="hs-identifier hs-var">checkUnless</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683872738"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1221"></a><span>            </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-identifier">roles2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span>            </span><span class="hs-comment">-- If we have something like:</span><span>
</span><a name="line-1223"></a><span>            </span><span class="hs-comment">--</span><span>
</span><a name="line-1224"></a><span>            </span><span class="hs-comment">--  signature H where</span><span>
</span><a name="line-1225"></a><span>            </span><span class="hs-comment">--      data T a</span><span>
</span><a name="line-1226"></a><span>            </span><span class="hs-comment">--  module H where</span><span>
</span><a name="line-1227"></a><span>            </span><span class="hs-comment">--      data K a b = ...</span><span>
</span><a name="line-1228"></a><span>            </span><span class="hs-comment">--      type T = K Int</span><span>
</span><a name="line-1229"></a><span>            </span><span class="hs-comment">--</span><span>
</span><a name="line-1230"></a><span>            </span><span class="hs-comment">-- we need to drop the first role of K when comparing!</span><span>
</span><a name="line-1231"></a><span>            </span><a href="#local-6989586621683872725"><span class="hs-identifier hs-var">checkRoles</span></a><span> </span><a href="#local-6989586621683872721"><span class="hs-identifier hs-var">roles1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621683872741"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621683872740"><span class="hs-identifier hs-var">tc2'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1232"></a><span class="hs-comment">{-
        -- Hypothetically, if we were allow to non-nullary type synonyms, here
        -- is how you would check the roles
        if length tvs == length roles1
            then checkRoles roles1 roles2
            else case tcSplitTyConApp_maybe ty of
                    Just (tc2', args) -&gt;
                        checkRoles roles1 (drop (length args) (tyConRoles tc2') ++ roles2)
                    Nothing -&gt; Just roles_msg
-}</span><span>
</span><a name="line-1242"></a><span>
</span><a name="line-1243"></a><span>    </span><a name="local-6989586621683872728"><a href="#local-6989586621683872728"><span class="hs-identifier">eqAlgRhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier hs-var">AbstractTyCon</span><span> </span><a name="local-6989586621683872742"><a href="#local-6989586621683872742"><span class="hs-identifier">_rhs2</span></a></a><span>
</span><a name="line-1244"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#checkSuccess"><span class="hs-identifier hs-var">checkSuccess</span></a><span> </span><span class="hs-comment">-- rhs2 is guaranteed to be injective, since it's an AlgTyCon</span><span>
</span><a name="line-1245"></a><span>    </span><span class="hs-identifier">eqAlgRhs</span><span> </span><span class="hs-identifier">_</span><span>  </span><a name="local-6989586621683872743"><a href="#local-6989586621683872743"><span class="hs-identifier">tc1</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">DataTyCon</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><a name="local-6989586621683872744"><a href="#local-6989586621683872744"><span class="hs-identifier">tc2</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">DataTyCon</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1246"></a><span>        </span><a href="TcRnDriver.html#checkListBy"><span class="hs-identifier hs-var">checkListBy</span></a><span> </span><a href="#local-6989586621683872729"><span class="hs-identifier hs-var">eqCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">data_cons</span><span> </span><a href="#local-6989586621683872743"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">data_cons</span><span> </span><a href="#local-6989586621683872744"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;constructors&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1247"></a><span>    </span><span class="hs-identifier">eqAlgRhs</span><span> </span><span class="hs-identifier">_</span><span>  </span><a name="local-6989586621683872745"><a href="#local-6989586621683872745"><span class="hs-identifier">tc1</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">NewTyCon</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><a name="local-6989586621683872746"><a href="#local-6989586621683872746"><span class="hs-identifier">tc2</span></a></a><span class="hs-glyph">@</span><span class="hs-identifier hs-var">NewTyCon</span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1248"></a><span>        </span><a href="#local-6989586621683872729"><span class="hs-identifier hs-var">eqCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">data_con</span><span> </span><a href="#local-6989586621683872745"><span class="hs-identifier hs-var">tc1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">data_con</span><span> </span><a href="#local-6989586621683872746"><span class="hs-identifier hs-var">tc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1249"></a><span>    </span><span class="hs-identifier">eqAlgRhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Cannot match a&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;data&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1250"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;definition with a&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;newtype&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1251"></a><span>                           </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;definition&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><span>
</span><a name="line-1253"></a><span>    </span><a name="local-6989586621683872729"><a href="#local-6989586621683872729"><span class="hs-identifier">eqCon</span></a></a><span> </span><a name="local-6989586621683872747"><a href="#local-6989586621683872747"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621683872748"><a href="#local-6989586621683872748"><span class="hs-identifier">c2</span></a></a><span>
</span><a name="line-1254"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872749"><span class="hs-identifier hs-var">name1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683872750"><span class="hs-identifier hs-var">name2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1255"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The names&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872751"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;and&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872752"><span class="hs-identifier hs-var">pname2</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1256"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;differ&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1257"></a><span>         </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConIsInfix</span><span> </span><a href="#local-6989586621683872747"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">dataConIsInfix</span><span> </span><a href="#local-6989586621683872748"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1258"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The fixities of&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872751"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1259"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;differ&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1260"></a><span>         </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqListBy</span><span> </span><span class="hs-identifier hs-var">eqHsBang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConImplBangs</span><span> </span><a href="#local-6989586621683872747"><span class="hs-identifier hs-var">c1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConImplBangs</span><span> </span><a href="#local-6989586621683872748"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1261"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The strictness annotations for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872751"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1262"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;differ&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1263"></a><span>         </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConFieldLabels</span><span> </span><a href="#local-6989586621683872747"><span class="hs-identifier hs-var">c1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConFieldLabels</span><span> </span><a href="#local-6989586621683872748"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1264"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The record label lists for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872751"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1265"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;differ&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="TcRnDriver.html#andThenCheck"><span class="hs-identifier hs-var">andThenCheck</span></a><span class="hs-special">`</span><span>
</span><a name="line-1266"></a><span>         </span><a href="TcRnDriver.html#check"><span class="hs-identifier hs-var">check</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConUserType</span><span> </span><a href="#local-6989586621683872747"><span class="hs-identifier hs-var">c1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConUserType</span><span> </span><a href="#local-6989586621683872748"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1267"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The types for&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872751"><span class="hs-identifier hs-var">pname1</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;differ&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1268"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1269"></a><span>        </span><a name="local-6989586621683872749"><a href="#local-6989586621683872749"><span class="hs-identifier">name1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621683872747"><span class="hs-identifier hs-var">c1</span></a><span>
</span><a name="line-1270"></a><span>        </span><a name="local-6989586621683872750"><a href="#local-6989586621683872750"><span class="hs-identifier">name2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621683872748"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-1271"></a><span>        </span><a name="local-6989586621683872751"><a href="#local-6989586621683872751"><span class="hs-identifier">pname1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872749"><span class="hs-identifier hs-var">name1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1272"></a><span>        </span><a name="local-6989586621683872752"><a href="#local-6989586621683872752"><span class="hs-identifier">pname2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872750"><span class="hs-identifier hs-var">name2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1273"></a><span>
</span><a name="line-1274"></a><span>    </span><a name="local-6989586621683872730"><a href="#local-6989586621683872730"><span class="hs-identifier">eqClosedFamilyAx</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1275"></a><span>    </span><span class="hs-identifier">eqClosedFamilyAx</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1276"></a><span>    </span><span class="hs-identifier">eqClosedFamilyAx</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1277"></a><span>    </span><span class="hs-identifier">eqClosedFamilyAx</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxiom</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872753"><a href="#local-6989586621683872753"><span class="hs-identifier">branches1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1278"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxiom</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872754"><a href="#local-6989586621683872754"><span class="hs-identifier">branches2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1279"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">numBranches</span><span> </span><a href="#local-6989586621683872753"><span class="hs-identifier hs-var">branches1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">numBranches</span><span> </span><a href="#local-6989586621683872754"><span class="hs-identifier hs-var">branches2</span></a><span>
</span><a name="line-1280"></a><span>      </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">and</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621683872731"><span class="hs-identifier hs-var">eqClosedFamilyBranch</span></a><span> </span><a href="#local-6989586621683872755"><span class="hs-identifier hs-var">branch_list1</span></a><span> </span><a href="#local-6989586621683872756"><span class="hs-identifier hs-var">branch_list2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1281"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1282"></a><span>        </span><a name="local-6989586621683872755"><a href="#local-6989586621683872755"><span class="hs-identifier">branch_list1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromBranches</span><span> </span><a href="#local-6989586621683872753"><span class="hs-identifier hs-var">branches1</span></a><span>
</span><a name="line-1283"></a><span>        </span><a name="local-6989586621683872756"><a href="#local-6989586621683872756"><span class="hs-identifier">branch_list2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromBranches</span><span> </span><a href="#local-6989586621683872754"><span class="hs-identifier hs-var">branches2</span></a><span>
</span><a name="line-1284"></a><span>
</span><a name="line-1285"></a><span>    </span><a name="local-6989586621683872731"><a href="#local-6989586621683872731"><span class="hs-identifier">eqClosedFamilyBranch</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxBranch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872757"><a href="#local-6989586621683872757"><span class="hs-identifier">tvs1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872758"><a href="#local-6989586621683872758"><span class="hs-identifier">cvs1</span></a></a><span>
</span><a name="line-1286"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872759"><a href="#local-6989586621683872759"><span class="hs-identifier">lhs1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872760"><a href="#local-6989586621683872760"><span class="hs-identifier">rhs1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1287"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CoAxBranch</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872761"><a href="#local-6989586621683872761"><span class="hs-identifier">tvs2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872762"><a href="#local-6989586621683872762"><span class="hs-identifier">cvs2</span></a></a><span>
</span><a name="line-1288"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872763"><a href="#local-6989586621683872763"><span class="hs-identifier">lhs2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872764"><a href="#local-6989586621683872764"><span class="hs-identifier">rhs2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1289"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872765"><a href="#local-6989586621683872765"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">eqVarBndrs</span><span> </span><a href="TcRnDriver.html#emptyRnEnv2"><span class="hs-identifier hs-var">emptyRnEnv2</span></a><span> </span><a href="#local-6989586621683872757"><span class="hs-identifier hs-var">tvs1</span></a><span> </span><a href="#local-6989586621683872761"><span class="hs-identifier hs-var">tvs2</span></a><span>
</span><a name="line-1290"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872766"><a href="#local-6989586621683872766"><span class="hs-identifier">env</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">eqVarBndrs</span><span> </span><a href="#local-6989586621683872765"><span class="hs-identifier hs-var">env1</span></a><span>        </span><a href="#local-6989586621683872758"><span class="hs-identifier hs-var">cvs1</span></a><span> </span><a href="#local-6989586621683872762"><span class="hs-identifier hs-var">cvs2</span></a><span>
</span><a name="line-1291"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">eqListBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872766"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872759"><span class="hs-identifier hs-var">lhs1</span></a><span> </span><a href="#local-6989586621683872763"><span class="hs-identifier hs-var">lhs2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-1292"></a><span>        </span><span class="hs-identifier hs-var">eqTypeX</span><span> </span><a href="#local-6989586621683872766"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621683872760"><span class="hs-identifier hs-var">rhs1</span></a><span> </span><a href="#local-6989586621683872764"><span class="hs-identifier hs-var">rhs2</span></a><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1295"></a><span>
</span><a name="line-1296"></a><span class="hs-identifier">emptyRnEnv2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RnEnv2</span><span>
</span><a name="line-1297"></a><a name="emptyRnEnv2"><a href="TcRnDriver.html#emptyRnEnv2"><span class="hs-identifier">emptyRnEnv2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkRnEnv2</span><span> </span><span class="hs-identifier hs-var">emptyInScopeSet</span><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span class="hs-comment">----------------</span><span>
</span><a name="line-1300"></a><span class="hs-identifier">missingBootThing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1301"></a><a name="missingBootThing"><a href="TcRnDriver.html#missingBootThing"><span class="hs-identifier">missingBootThing</span></a></a><span> </span><a name="local-6989586621683872834"><a href="#local-6989586621683872834"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-6989586621683872835"><a href="#local-6989586621683872835"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683872836"><a href="#local-6989586621683872836"><span class="hs-identifier">what</span></a></a><span>
</span><a name="line-1302"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872835"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is exported by the&quot;</span><span>
</span><a name="line-1303"></a><span>    </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683872834"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hs-boot&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hsig&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1304"></a><span>    </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;file, but not&quot;</span><span>
</span><a name="line-1305"></a><span>    </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683872836"><span class="hs-identifier hs-var">what</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;the module&quot;</span><span>
</span><a name="line-1306"></a><span>
</span><a name="line-1307"></a><span class="hs-identifier">badReexportedBootThing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1308"></a><a name="badReexportedBootThing"><a href="TcRnDriver.html#badReexportedBootThing"><span class="hs-identifier">badReexportedBootThing</span></a></a><span> </span><a name="local-6989586621683872837"><a href="#local-6989586621683872837"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621683872838"><a href="#local-6989586621683872838"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-6989586621683872839"><a href="#local-6989586621683872839"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621683872840"><a href="#local-6989586621683872840"><span class="hs-identifier">name'</span></a></a><span>
</span><a name="line-1309"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withPprStyle</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkUserStyle</span><span> </span><a href="#local-6989586621683872837"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">alwaysQualify</span><span> </span><span class="hs-identifier hs-var">AllTheWay</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-1310"></a><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683872838"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hs-boot&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hsig&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1311"></a><span>           </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;file (re)exports&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872839"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1312"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but the implementing module exports a different identifier&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872840"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1313"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-1314"></a><span>
</span><a name="line-1315"></a><span class="hs-identifier">bootMisMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1316"></a><a name="bootMisMatch"><a href="TcRnDriver.html#bootMisMatch"><span class="hs-identifier">bootMisMatch</span></a></a><span> </span><a name="local-6989586621683872841"><a href="#local-6989586621683872841"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-6989586621683872842"><a href="#local-6989586621683872842"><span class="hs-identifier">extra_info</span></a></a><span> </span><a name="local-6989586621683872843"><a href="#local-6989586621683872843"><span class="hs-identifier">real_thing</span></a></a><span> </span><a name="local-6989586621683872844"><a href="#local-6989586621683872844"><span class="hs-identifier">boot_thing</span></a></a><span>
</span><a name="line-1317"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872848"><span class="hs-identifier hs-var">pprBootMisMatch</span></a><span> </span><a href="#local-6989586621683872841"><span class="hs-identifier hs-var">is_boot</span></a><span> </span><a href="#local-6989586621683872842"><span class="hs-identifier hs-var">extra_info</span></a><span> </span><a href="#local-6989586621683872843"><span class="hs-identifier hs-var">real_thing</span></a><span> </span><a href="#local-6989586621683872846"><span class="hs-identifier hs-var">real_doc</span></a><span> </span><a href="#local-6989586621683872847"><span class="hs-identifier hs-var">boot_doc</span></a><span>
</span><a name="line-1318"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1319"></a><span>    </span><a name="local-6989586621683872845"><a href="#local-6989586621683872845"><span class="hs-identifier">to_doc</span></a></a><span>
</span><a name="line-1320"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="PprTyThing.html#pprTyThingInContext"><span class="hs-identifier hs-var">pprTyThingInContext</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">showToHeader</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ss_forall</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1321"></a><span>                                              </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683872841"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-1322"></a><span>                                                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">ShowForAllMust</span><span>
</span><a name="line-1323"></a><span>                                                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">ShowForAllWhen</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span>    </span><a name="local-6989586621683872846"><a href="#local-6989586621683872846"><span class="hs-identifier">real_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872845"><span class="hs-identifier hs-var">to_doc</span></a><span> </span><a href="#local-6989586621683872843"><span class="hs-identifier hs-var">real_thing</span></a><span>
</span><a name="line-1326"></a><span>    </span><a name="local-6989586621683872847"><a href="#local-6989586621683872847"><span class="hs-identifier">boot_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872845"><span class="hs-identifier hs-var">to_doc</span></a><span> </span><a href="#local-6989586621683872844"><span class="hs-identifier hs-var">boot_thing</span></a><span>
</span><a name="line-1327"></a><span>
</span><a name="line-1328"></a><span>    </span><span class="hs-identifier">pprBootMisMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1329"></a><span>    </span><a name="local-6989586621683872848"><a href="#local-6989586621683872848"><span class="hs-identifier">pprBootMisMatch</span></a></a><span> </span><a name="local-6989586621683872849"><a href="#local-6989586621683872849"><span class="hs-identifier">is_boot</span></a></a><span> </span><a name="local-6989586621683872850"><a href="#local-6989586621683872850"><span class="hs-identifier">extra_info</span></a></a><span> </span><a name="local-6989586621683872851"><a href="#local-6989586621683872851"><span class="hs-identifier">real_thing</span></a></a><span> </span><a name="local-6989586621683872852"><a href="#local-6989586621683872852"><span class="hs-identifier">real_doc</span></a></a><span> </span><a name="local-6989586621683872853"><a href="#local-6989586621683872853"><span class="hs-identifier">boot_doc</span></a></a><span>
</span><a name="line-1330"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span>
</span><a name="line-1331"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872851"><span class="hs-identifier hs-var">real_thing</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1332"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;has conflicting definitions in the module&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1333"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;and its&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1334"></a><span>              </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683872849"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-1335"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hs-boot file&quot;</span><span>
</span><a name="line-1336"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;hsig file&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1337"></a><span>            </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Main module:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872852"><span class="hs-identifier hs-var">real_doc</span></a><span class="hs-special">,</span><span>
</span><a name="line-1338"></a><span>              </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683872849"><span class="hs-identifier hs-var">is_boot</span></a><span>
</span><a name="line-1339"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Boot file:  &quot;</span><span>
</span><a name="line-1340"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Hsig file: &quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1341"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872853"><span class="hs-identifier hs-var">boot_doc</span></a><span class="hs-special">,</span><span>
</span><a name="line-1342"></a><span>            </span><a href="#local-6989586621683872850"><span class="hs-identifier hs-var">extra_info</span></a><span>
</span><a name="line-1343"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-1344"></a><span>
</span><a name="line-1345"></a><span class="hs-identifier">instMisMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DFunId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1346"></a><a name="instMisMatch"><a href="TcRnDriver.html#instMisMatch"><span class="hs-identifier">instMisMatch</span></a></a><span> </span><a name="local-6989586621683872854"><a href="#local-6989586621683872854"><span class="hs-identifier">dfun</span></a></a><span>
</span><a name="line-1347"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;instance&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683872854"><span class="hs-identifier hs-var">dfun</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1348"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is defined in the hs-boot file, but not in the module itself&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Type-checking the top level of a module (continued)
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1357"></a><span>
</span><a name="line-1358"></a><span class="hs-identifier">rnTopSrcDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-1359"></a><span class="hs-comment">-- Fails if there are any errors</span><span>
</span><a name="line-1360"></a><a name="rnTopSrcDecls"><a href="TcRnDriver.html#rnTopSrcDecls"><span class="hs-identifier">rnTopSrcDecls</span></a></a><span> </span><a name="local-6989586621683872855"><a href="#local-6989586621683872855"><span class="hs-identifier">group</span></a></a><span>
</span><a name="line-1361"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Rename the source decls</span><span>
</span><a name="line-1362"></a><span>        </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn12&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1363"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683872856"><a href="#local-6989586621683872856"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872857"><a href="#local-6989586621683872857"><span class="hs-identifier">rn_decls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="RnSource.html#rnSrcDecls"><span class="hs-identifier hs-var">rnSrcDecls</span></a><span> </span><a href="#local-6989586621683872855"><span class="hs-identifier hs-var">group</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1364"></a><span>        </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn13&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1365"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683872858"><a href="#local-6989586621683872858"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872859"><a href="#local-6989586621683872859"><span class="hs-identifier">rn_decls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#runRenamerPlugin"><span class="hs-identifier hs-var">runRenamerPlugin</span></a><span> </span><a href="#local-6989586621683872856"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><a href="#local-6989586621683872857"><span class="hs-identifier hs-var">rn_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1366"></a><span>        </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;rn13-plugin&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1367"></a><span>
</span><a name="line-1368"></a><span>        </span><span class="hs-comment">-- save the renamed syntax, if we want it</span><span>
</span><a name="line-1369"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872860"><a href="#local-6989586621683872860"><span class="hs-identifier">tcg_env'</span></a></a><span>
</span><a name="line-1370"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872861"><a href="#local-6989586621683872861"><span class="hs-identifier">grp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">tcg_rn_decls</span><span> </span><a href="#local-6989586621683872858"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1371"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872858"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_rn_decls</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">appendGroups</span><span> </span><a href="#local-6989586621683872861"><span class="hs-identifier hs-var">grp</span></a><span> </span><a href="#local-6989586621683872859"><span class="hs-identifier hs-var">rn_decls</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1372"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1373"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872858"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">;</span><span>
</span><a name="line-1374"></a><span>
</span><a name="line-1375"></a><span>                </span><span class="hs-comment">-- Dump trace of renaming part</span><span>
</span><a name="line-1376"></a><span>        </span><a href="TcRnDriver.html#rnDump"><span class="hs-identifier hs-var">rnDump</span></a><span> </span><a href="#local-6989586621683872859"><span class="hs-identifier hs-var">rn_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1377"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872860"><span class="hs-identifier hs-var">tcg_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872859"><span class="hs-identifier hs-var">rn_decls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1378"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-1379"></a><span>
</span><a name="line-1380"></a><span class="hs-identifier">tcTopSrcDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcLclEnv</span><span class="hs-special">)</span><span>
</span><a name="line-1381"></a><a name="tcTopSrcDecls"><a href="TcRnDriver.html#tcTopSrcDecls"><span class="hs-identifier">tcTopSrcDecls</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsGroup</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hs_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872862"><a href="#local-6989586621683872862"><span class="hs-identifier">tycl_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1382"></a><span>                         </span><span class="hs-identifier">hs_derivds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872863"><a href="#local-6989586621683872863"><span class="hs-identifier">deriv_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1383"></a><span>                         </span><span class="hs-identifier">hs_fords</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872864"><a href="#local-6989586621683872864"><span class="hs-identifier">foreign_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1384"></a><span>                         </span><span class="hs-identifier">hs_defds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872865"><a href="#local-6989586621683872865"><span class="hs-identifier">default_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1385"></a><span>                         </span><span class="hs-identifier">hs_annds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872866"><a href="#local-6989586621683872866"><span class="hs-identifier">annotation_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1386"></a><span>                         </span><span class="hs-identifier">hs_ruleds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872867"><a href="#local-6989586621683872867"><span class="hs-identifier">rule_decls</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1387"></a><span>                         </span><span class="hs-identifier">hs_valds</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683872868"><a href="#local-6989586621683872868"><span class="hs-identifier">hs_val_binds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">XValBindsLR</span><span>
</span><a name="line-1388"></a><span>                                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NValBinds</span><span> </span><a name="local-6989586621683872869"><a href="#local-6989586621683872869"><span class="hs-identifier">val_binds</span></a></a><span> </span><a name="local-6989586621683872870"><a href="#local-6989586621683872870"><span class="hs-identifier">val_sigs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1389"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>         </span><span class="hs-comment">-- Type-check the type and class decls, and all imported decls</span><span>
</span><a name="line-1390"></a><span>                </span><span class="hs-comment">-- The latter come in via tycl_decls</span><span>
</span><a name="line-1391"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc2 (src)&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1392"></a><span>
</span><a name="line-1393"></a><span>                </span><span class="hs-comment">-- Source-language instances, including derivings,</span><span>
</span><a name="line-1394"></a><span>                </span><span class="hs-comment">-- and import the supporting declarations</span><span>
</span><a name="line-1395"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc3&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1396"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683872871"><a href="#local-6989586621683872871"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872872"><a href="#local-6989586621683872872"><span class="hs-identifier">inst_infos</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">XValBindsLR</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NValBinds</span><span> </span><a name="local-6989586621683872873"><a href="#local-6989586621683872873"><span class="hs-identifier">deriv_binds</span></a></a><span> </span><a name="local-6989586621683872874"><a href="#local-6989586621683872874"><span class="hs-identifier">deriv_sigs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1397"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#tcTyClsInstDecls"><span class="hs-identifier hs-var">tcTyClsInstDecls</span></a><span> </span><a href="#local-6989586621683872862"><span class="hs-identifier hs-var">tycl_decls</span></a><span> </span><a href="#local-6989586621683872863"><span class="hs-identifier hs-var">deriv_decls</span></a><span> </span><a href="#local-6989586621683872869"><span class="hs-identifier hs-var">val_binds</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1398"></a><span>
</span><a name="line-1399"></a><span>        </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872871"><span class="hs-identifier hs-var">tcg_env</span></a><span>       </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1400"></a><span>
</span><a name="line-1401"></a><span>                </span><span class="hs-comment">-- Generate Applicative/Monad proposal (AMP) warnings</span><span>
</span><a name="line-1402"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc3b&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1403"></a><span>
</span><a name="line-1404"></a><span>                </span><span class="hs-comment">-- Generate Semigroup/Monoid warnings</span><span>
</span><a name="line-1405"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc3c&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1406"></a><span>        </span><a href="TcRnDriver.html#tcSemigroupWarnings"><span class="hs-identifier hs-var">tcSemigroupWarnings</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1407"></a><span>
</span><a name="line-1408"></a><span>                </span><span class="hs-comment">-- Foreign import declarations next.</span><span>
</span><a name="line-1409"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc4&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1410"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683872875"><a href="#local-6989586621683872875"><span class="hs-identifier">fi_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872876"><a href="#local-6989586621683872876"><span class="hs-identifier">fi_decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872877"><a href="#local-6989586621683872877"><span class="hs-identifier">fi_gres</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcForeign.html#tcForeignImports"><span class="hs-identifier hs-var">tcForeignImports</span></a><span> </span><a href="#local-6989586621683872864"><span class="hs-identifier hs-var">foreign_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1411"></a><span>        </span><a href="TcEnv.html#tcExtendGlobalValEnv"><span class="hs-identifier hs-var">tcExtendGlobalValEnv</span></a><span> </span><a href="#local-6989586621683872875"><span class="hs-identifier hs-var">fi_ids</span></a><span>     </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1412"></a><span>
</span><a name="line-1413"></a><span>                </span><span class="hs-comment">-- Default declarations</span><span>
</span><a name="line-1414"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc4a&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1415"></a><span>        </span><a name="local-6989586621683872878"><a href="#local-6989586621683872878"><span class="hs-identifier">default_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcDefaults.html#tcDefaults"><span class="hs-identifier hs-var">tcDefaults</span></a><span> </span><a href="#local-6989586621683872865"><span class="hs-identifier hs-var">default_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1416"></a><span>        </span><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier hs-var">updGblEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683872879"><a href="#local-6989586621683872879"><span class="hs-identifier">gbl</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683872879"><span class="hs-identifier hs-var">gbl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_default</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872878"><span class="hs-identifier hs-var">default_tys</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1417"></a><span>
</span><a name="line-1418"></a><span>                </span><span class="hs-comment">-- Value declarations next.</span><span>
</span><a name="line-1419"></a><span>                </span><span class="hs-comment">-- It is important that we check the top-level value bindings</span><span>
</span><a name="line-1420"></a><span>                </span><span class="hs-comment">-- before the GHC-generated derived bindings, since the latter</span><span>
</span><a name="line-1421"></a><span>                </span><span class="hs-comment">-- may be defined in terms of the former. (For instance,</span><span>
</span><a name="line-1422"></a><span>                </span><span class="hs-comment">-- the bindings produced in a Data instance.)</span><span>
</span><a name="line-1423"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc5&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1424"></a><span>        </span><a name="local-6989586621683872880"><a href="#local-6989586621683872880"><span class="hs-identifier">tc_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcBinds.html#tcTopBinds"><span class="hs-identifier hs-var">tcTopBinds</span></a><span> </span><a href="#local-6989586621683872869"><span class="hs-identifier hs-var">val_binds</span></a><span> </span><a href="#local-6989586621683872870"><span class="hs-identifier hs-var">val_sigs</span></a><span class="hs-special">;</span><span>
</span><a name="line-1425"></a><span>        </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><a href="#local-6989586621683872880"><span class="hs-identifier hs-var">tc_envs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1426"></a><span>
</span><a name="line-1427"></a><span>                </span><span class="hs-comment">-- Now GHC-generated derived bindings, generics, and selectors</span><span>
</span><a name="line-1428"></a><span>                </span><span class="hs-comment">-- Do not generate warnings from compiler-generated code;</span><span>
</span><a name="line-1429"></a><span>                </span><span class="hs-comment">-- hence the use of discardWarnings</span><span>
</span><a name="line-1430"></a><span>        </span><a name="local-6989586621683872881"><a href="#local-6989586621683872881"><span class="hs-identifier">tc_envs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621683872882"><a href="#local-6989586621683872882"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872883"><a href="#local-6989586621683872883"><span class="hs-identifier">tcl_env</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1431"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#discardWarnings"><span class="hs-identifier hs-var">discardWarnings</span></a><span> </span><span class="hs-special">(</span><a href="TcBinds.html#tcTopBinds"><span class="hs-identifier hs-var">tcTopBinds</span></a><span> </span><a href="#local-6989586621683872873"><span class="hs-identifier hs-var">deriv_binds</span></a><span> </span><a href="#local-6989586621683872874"><span class="hs-identifier hs-var">deriv_sigs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1432"></a><span>        </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><a href="#local-6989586621683872881"><span class="hs-identifier hs-var">tc_envs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Environment doesn't change now</span><span>
</span><a name="line-1433"></a><span>
</span><a name="line-1434"></a><span>                </span><span class="hs-comment">-- Second pass over class and instance declarations,</span><span>
</span><a name="line-1435"></a><span>                </span><span class="hs-comment">-- now using the kind-checked decls</span><span>
</span><a name="line-1436"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc6&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1437"></a><span>        </span><a name="local-6989586621683872884"><a href="#local-6989586621683872884"><span class="hs-identifier">inst_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInstDcls.html#tcInstDecls2"><span class="hs-identifier hs-var">tcInstDecls2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyClGroupTyClDecls</span><span> </span><a href="#local-6989586621683872862"><span class="hs-identifier hs-var">tycl_decls</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872872"><span class="hs-identifier hs-var">inst_infos</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1438"></a><span>
</span><a name="line-1439"></a><span>                </span><span class="hs-comment">-- Foreign exports</span><span>
</span><a name="line-1440"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc7&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1441"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621683872885"><a href="#local-6989586621683872885"><span class="hs-identifier">foe_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872886"><a href="#local-6989586621683872886"><span class="hs-identifier">foe_decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872887"><a href="#local-6989586621683872887"><span class="hs-identifier">foe_gres</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcForeign.html#tcForeignExports"><span class="hs-identifier hs-var">tcForeignExports</span></a><span> </span><a href="#local-6989586621683872864"><span class="hs-identifier hs-var">foreign_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1442"></a><span>
</span><a name="line-1443"></a><span>                </span><span class="hs-comment">-- Annotations</span><span>
</span><a name="line-1444"></a><span>        </span><a name="local-6989586621683872888"><a href="#local-6989586621683872888"><span class="hs-identifier">annotations</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcAnnotations.html#tcAnnotations"><span class="hs-identifier hs-var">tcAnnotations</span></a><span> </span><a href="#local-6989586621683872866"><span class="hs-identifier hs-var">annotation_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1445"></a><span>
</span><a name="line-1446"></a><span>                </span><span class="hs-comment">-- Rules</span><span>
</span><a name="line-1447"></a><span>        </span><a name="local-6989586621683872889"><a href="#local-6989586621683872889"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRules.html#tcRules"><span class="hs-identifier hs-var">tcRules</span></a><span> </span><a href="#local-6989586621683872867"><span class="hs-identifier hs-var">rule_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1448"></a><span>
</span><a name="line-1449"></a><span>                </span><span class="hs-comment">-- Wrap up</span><span>
</span><a name="line-1450"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Tc7a&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1451"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872890"><a href="#local-6989586621683872890"><span class="hs-identifier">all_binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872884"><span class="hs-identifier hs-var">inst_binds</span></a><span>     </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span>
</span><a name="line-1452"></a><span>                          </span><a href="#local-6989586621683872885"><span class="hs-identifier hs-var">foe_binds</span></a><span>
</span><a name="line-1453"></a><span>
</span><a name="line-1454"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872891"><a href="#local-6989586621683872891"><span class="hs-identifier">fo_gres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872877"><span class="hs-identifier hs-var">fi_gres</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872887"><span class="hs-identifier hs-var">foe_gres</span></a><span>
</span><a name="line-1455"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872892"><a href="#local-6989586621683872892"><span class="hs-identifier">fo_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldrBag</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683872895"><a href="#local-6989586621683872895"><span class="hs-identifier">gre</span></a></a><span> </span><a name="local-6989586621683872896"><a href="#local-6989586621683872896"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683872896"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">addOneFV</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683872895"><span class="hs-identifier hs-var">gre</span></a><span class="hs-special">)</span><span>
</span><a name="line-1456"></a><span>                                </span><span class="hs-identifier hs-var">emptyFVs</span><span> </span><a href="#local-6989586621683872891"><span class="hs-identifier hs-var">fo_gres</span></a><span>
</span><a name="line-1457"></a><span>
</span><a name="line-1458"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872893"><a href="#local-6989586621683872893"><span class="hs-identifier">sig_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameSet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">collectHsValBinders</span><span> </span><a href="#local-6989586621683872868"><span class="hs-identifier hs-var">hs_val_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1459"></a><span>                          </span><span class="hs-special">`</span><span class="hs-identifier hs-var">minusNameSet</span><span class="hs-special">`</span><span> </span><a href="TcEnv.html#getTypeSigNames"><span class="hs-identifier hs-var">getTypeSigNames</span></a><span> </span><a href="#local-6989586621683872870"><span class="hs-identifier hs-var">val_sigs</span></a><span>
</span><a name="line-1460"></a><span>
</span><a name="line-1461"></a><span>                </span><span class="hs-comment">-- Extend the GblEnv with the (as yet un-zonked)</span><span>
</span><a name="line-1462"></a><span>                </span><span class="hs-comment">-- bindings, rules, foreign decls</span><span>
</span><a name="line-1463"></a><span>            </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872894"><a href="#local-6989586621683872894"><span class="hs-identifier">tcg_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872882"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_binds</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_binds</span><span> </span><a href="#local-6989586621683872882"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionBags</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872890"><span class="hs-identifier hs-var">all_binds</span></a><span>
</span><a name="line-1464"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_sigs</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_sigs</span><span> </span><a href="#local-6989586621683872882"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unionNameSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872893"><span class="hs-identifier hs-var">sig_names</span></a><span>
</span><a name="line-1465"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_rules</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_rules</span><span> </span><a href="#local-6989586621683872882"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1466"></a><span>                                                      </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">flattenRuleDecls</span><span> </span><a href="#local-6989586621683872889"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-1467"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_anns</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_anns</span><span> </span><a href="#local-6989586621683872882"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872888"><span class="hs-identifier hs-var">annotations</span></a><span>
</span><a name="line-1468"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_ann_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendAnnEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_ann_env</span><span> </span><a href="#local-6989586621683872882"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872888"><span class="hs-identifier hs-var">annotations</span></a><span>
</span><a name="line-1469"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fords</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_fords</span><span> </span><a href="#local-6989586621683872882"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872886"><span class="hs-identifier hs-var">foe_decls</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872876"><span class="hs-identifier hs-var">fi_decls</span></a><span>
</span><a name="line-1470"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_dus</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_dus</span><span> </span><a href="#local-6989586621683872882"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusDU</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">usesOnly</span><span> </span><a href="#local-6989586621683872892"><span class="hs-identifier hs-var">fo_fvs</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1471"></a><span>                                 </span><span class="hs-comment">-- tcg_dus: see Note [Newtype constructor usage in foreign declarations]</span><span>
</span><a name="line-1472"></a><span>
</span><a name="line-1473"></a><span>        </span><span class="hs-comment">-- See Note [Newtype constructor usage in foreign declarations]</span><span>
</span><a name="line-1474"></a><span>        </span><a href="RnEnv.html#addUsedGREs"><span class="hs-identifier hs-var">addUsedGREs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">bagToList</span><span> </span><a href="#local-6989586621683872891"><span class="hs-identifier hs-var">fo_gres</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1475"></a><span>
</span><a name="line-1476"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872894"><span class="hs-identifier hs-var">tcg_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872883"><span class="hs-identifier hs-var">tcl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1477"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1478"></a><span>
</span><a name="line-1479"></a><span class="hs-identifier">tcTopSrcDecls</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcTopSrcDecls: ValBindsIn&quot;</span><span>
</span><a name="line-1480"></a><span>
</span><a name="line-1481"></a><span>
</span><a name="line-1482"></a><span class="hs-identifier">tcSemigroupWarnings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1483"></a><a name="tcSemigroupWarnings"><a href="TcRnDriver.html#tcSemigroupWarnings"><span class="hs-identifier">tcSemigroupWarnings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1484"></a><span>    </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcSemigroupWarnings&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1485"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872897"><a href="#local-6989586621683872897"><span class="hs-identifier">warnFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Opt_WarnSemigroup</span><span>
</span><a name="line-1486"></a><span>    </span><a href="TcRnDriver.html#tcPreludeClashWarn"><span class="hs-identifier hs-var">tcPreludeClashWarn</span></a><span> </span><a href="#local-6989586621683872897"><span class="hs-identifier hs-var">warnFlag</span></a><span> </span><span class="hs-identifier hs-var">sappendName</span><span>
</span><a name="line-1487"></a><span>    </span><a href="TcRnDriver.html#tcMissingParentClassWarn"><span class="hs-identifier hs-var">tcMissingParentClassWarn</span></a><span> </span><a href="#local-6989586621683872897"><span class="hs-identifier hs-var">warnFlag</span></a><span> </span><span class="hs-identifier hs-var">monoidClassName</span><span> </span><span class="hs-identifier hs-var">semigroupClassName</span><span>
</span><a name="line-1488"></a><span>
</span><a name="line-1489"></a><span>
</span><a name="line-1490"></a><span class="hs-comment">-- | Warn on local definitions of names that would clash with future Prelude</span><span>
</span><a name="line-1491"></a><span class="hs-comment">-- elements.</span><span>
</span><a name="line-1492"></a><span class="hs-comment">--</span><span>
</span><a name="line-1493"></a><span class="hs-comment">--   A name clashes if the following criteria are met:</span><span>
</span><a name="line-1494"></a><span class="hs-comment">--       1. It would is imported (unqualified) from Prelude</span><span>
</span><a name="line-1495"></a><span class="hs-comment">--       2. It is locally defined in the current module</span><span>
</span><a name="line-1496"></a><span class="hs-comment">--       3. It has the same literal name as the reference function</span><span>
</span><a name="line-1497"></a><span class="hs-comment">--       4. It is not identical to the reference function</span><span>
</span><a name="line-1498"></a><span class="hs-identifier">tcPreludeClashWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span>
</span><a name="line-1499"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1500"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1501"></a><a name="tcPreludeClashWarn"><a href="TcRnDriver.html#tcPreludeClashWarn"><span class="hs-identifier">tcPreludeClashWarn</span></a></a><span> </span><a name="local-6989586621683872898"><a href="#local-6989586621683872898"><span class="hs-identifier">warnFlag</span></a></a><span> </span><a name="local-6989586621683872899"><a href="#local-6989586621683872899"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1502"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872916"><a href="#local-6989586621683872916"><span class="hs-identifier">warn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><a href="#local-6989586621683872898"><span class="hs-identifier hs-var">warnFlag</span></a><span>
</span><a name="line-1503"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621683872916"><span class="hs-identifier hs-var">warn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1504"></a><span>    </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPreludeClashWarn/wouldBeImported&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1505"></a><span>    </span><span class="hs-comment">-- Is the name imported (unqualified) from Prelude? (Point 4 above)</span><span>
</span><a name="line-1506"></a><span>    </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872917"><a href="#local-6989586621683872917"><span class="hs-identifier">rnImports</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">tcg_rn_imports</span><span class="hs-special">)</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1507"></a><span>    </span><span class="hs-comment">-- (Note that this automatically handles -XNoImplicitPrelude, as Prelude</span><span>
</span><a name="line-1508"></a><span>    </span><span class="hs-comment">-- will not appear in rnImports automatically if it is set.)</span><span>
</span><a name="line-1509"></a><span>
</span><a name="line-1510"></a><span>    </span><span class="hs-comment">-- Continue only the name is imported from Prelude</span><span>
</span><a name="line-1511"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872900"><span class="hs-identifier hs-var">importedViaPrelude</span></a><span> </span><a href="#local-6989586621683872899"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621683872917"><span class="hs-identifier hs-var">rnImports</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1512"></a><span>      </span><span class="hs-comment">-- Handle 2.-4.</span><span>
</span><a name="line-1513"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872918"><a href="#local-6989586621683872918"><span class="hs-identifier">rdrElts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">occEnvElts</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">tcg_rdr_env</span><span class="hs-special">)</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1514"></a><span>
</span><a name="line-1515"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">clashes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GlobalRdrElt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1516"></a><span>          </span><a name="local-6989586621683872919"><a href="#local-6989586621683872919"><span class="hs-identifier">clashes</span></a></a><span> </span><a name="local-6989586621683872921"><a href="#local-6989586621683872921"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872922"><span class="hs-identifier hs-var">isLocalDef</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683872923"><span class="hs-identifier hs-var">nameClashes</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683872924"><span class="hs-identifier hs-var">isNotInProperModule</span></a><span>
</span><a name="line-1517"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-1518"></a><span>              </span><a name="local-6989586621683872922"><a href="#local-6989586621683872922"><span class="hs-identifier">isLocalDef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gre_lcl</span><span> </span><a href="#local-6989586621683872921"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1519"></a><span>              </span><span class="hs-comment">-- Names are identical ...</span><span>
</span><a name="line-1520"></a><span>              </span><a name="local-6989586621683872923"><a href="#local-6989586621683872923"><span class="hs-identifier">nameClashes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683872921"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683872899"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1521"></a><span>              </span><span class="hs-comment">-- ... but not the actual definitions, because we don't want to</span><span>
</span><a name="line-1522"></a><span>              </span><span class="hs-comment">-- warn about a bad definition of e.g. &lt;&gt; in Data.Semigroup, which</span><span>
</span><a name="line-1523"></a><span>              </span><span class="hs-comment">-- is the (only) proper place where this should be defined</span><span>
</span><a name="line-1524"></a><span>              </span><a name="local-6989586621683872924"><a href="#local-6989586621683872924"><span class="hs-identifier">isNotInProperModule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683872921"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621683872899"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1525"></a><span>
</span><a name="line-1526"></a><span>          </span><span class="hs-comment">-- List of all offending definitions</span><span>
</span><a name="line-1527"></a><span>          </span><span class="hs-identifier">clashingElts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GlobalRdrElt</span><span class="hs-special">]</span><span>
</span><a name="line-1528"></a><span>          </span><a name="local-6989586621683872920"><a href="#local-6989586621683872920"><span class="hs-identifier">clashingElts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621683872919"><span class="hs-identifier hs-var">clashes</span></a><span> </span><a href="#local-6989586621683872918"><span class="hs-identifier hs-var">rdrElts</span></a><span>
</span><a name="line-1529"></a><span>
</span><a name="line-1530"></a><span>    </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcPreludeClashWarn/prelude_functions&quot;</span><span>
</span><a name="line-1531"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872899"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872920"><span class="hs-identifier hs-var">clashingElts</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1532"></a><span>
</span><a name="line-1533"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872925"><a href="#local-6989586621683872925"><span class="hs-identifier">warn_msg</span></a></a><span> </span><a name="local-6989586621683872926"><a href="#local-6989586621683872926"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier hs-var">addWarnAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621683872898"><span class="hs-identifier hs-var">warnFlag</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameSrcSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683872926"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span>
</span><a name="line-1534"></a><span>              </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Local definition of&quot;</span><span>
</span><a name="line-1535"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">gre_name</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872926"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1536"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;clashes with a future Prelude name.&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1537"></a><span>              </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1538"></a><span>              </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;This will become an error in a future release.&quot;</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1539"></a><span>    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683872925"><span class="hs-identifier hs-var">warn_msg</span></a><span> </span><a href="#local-6989586621683872920"><span class="hs-identifier hs-var">clashingElts</span></a><span>
</span><a name="line-1540"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1541"></a><span>
</span><a name="line-1542"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1543"></a><span>
</span><a name="line-1544"></a><span>    </span><span class="hs-comment">-- Is the given name imported via Prelude?</span><span>
</span><a name="line-1545"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1546"></a><span>    </span><span class="hs-comment">-- Possible scenarios:</span><span>
</span><a name="line-1547"></a><span>    </span><span class="hs-comment">--   a) Prelude is imported implicitly, issue warnings.</span><span>
</span><a name="line-1548"></a><span>    </span><span class="hs-comment">--   b) Prelude is imported explicitly, but without mentioning the name in</span><span>
</span><a name="line-1549"></a><span>    </span><span class="hs-comment">--      question. Issue no warnings.</span><span>
</span><a name="line-1550"></a><span>    </span><span class="hs-comment">--   c) Prelude is imported hiding the name in question. Issue no warnings.</span><span>
</span><a name="line-1551"></a><span>    </span><span class="hs-comment">--   d) Qualified import of Prelude, no warnings.</span><span>
</span><a name="line-1552"></a><span>    </span><span class="hs-identifier">importedViaPrelude</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-1553"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1554"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1555"></a><span>    </span><a name="local-6989586621683872900"><a href="#local-6989586621683872900"><span class="hs-identifier">importedViaPrelude</span></a></a><span> </span><a name="local-6989586621683872901"><a href="#local-6989586621683872901"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="#local-6989586621683872907"><span class="hs-identifier hs-var">importViaPrelude</span></a><span>
</span><a name="line-1556"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1557"></a><span>        </span><span class="hs-identifier">isPrelude</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1558"></a><span>        </span><a name="local-6989586621683872902"><a href="#local-6989586621683872902"><span class="hs-identifier">isPrelude</span></a></a><span> </span><a name="local-6989586621683872908"><a href="#local-6989586621683872908"><span class="hs-identifier">imp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ideclName</span><span> </span><a href="#local-6989586621683872908"><span class="hs-identifier hs-var">imp</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">pRELUDE_NAME</span><span>
</span><a name="line-1559"></a><span>
</span><a name="line-1560"></a><span>        </span><span class="hs-comment">-- Implicit (Prelude) import?</span><span>
</span><a name="line-1561"></a><span>        </span><span class="hs-identifier">isImplicit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1562"></a><span>        </span><a name="local-6989586621683872903"><a href="#local-6989586621683872903"><span class="hs-identifier">isImplicit</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ideclImplicit</span><span>
</span><a name="line-1563"></a><span>
</span><a name="line-1564"></a><span>        </span><span class="hs-comment">-- Unqualified import?</span><span>
</span><a name="line-1565"></a><span>        </span><span class="hs-identifier">isUnqualified</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1566"></a><span>        </span><a name="local-6989586621683872904"><a href="#local-6989586621683872904"><span class="hs-identifier">isUnqualified</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ideclQualified</span><span>
</span><a name="line-1567"></a><span>
</span><a name="line-1568"></a><span>        </span><span class="hs-comment">-- List of explicitly imported (or hidden) Names from a single import.</span><span>
</span><a name="line-1569"></a><span>        </span><span class="hs-comment">--   Nothing -&gt; No explicit imports</span><span>
</span><a name="line-1570"></a><span>        </span><span class="hs-comment">--   Just (False, &lt;names&gt;) -&gt; Explicit import list of &lt;names&gt;</span><span>
</span><a name="line-1571"></a><span>        </span><span class="hs-comment">--   Just (True , &lt;names&gt;) -&gt; Explicit hiding of &lt;names&gt;</span><span>
</span><a name="line-1572"></a><span>        </span><span class="hs-identifier">importListOf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1573"></a><span>        </span><a name="local-6989586621683872905"><a href="#local-6989586621683872905"><span class="hs-identifier">importListOf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621683872909"><span class="hs-identifier hs-var">toImportList</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ideclHiding</span><span>
</span><a name="line-1574"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-1575"></a><span>            </span><a name="local-6989586621683872909"><a href="#local-6989586621683872909"><span class="hs-identifier">toImportList</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683872910"><a href="#local-6989586621683872910"><span class="hs-identifier">h</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872911"><a href="#local-6989586621683872911"><span class="hs-identifier">loc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872910"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ieName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">unLoc</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><a href="#local-6989586621683872911"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1576"></a><span>
</span><a name="line-1577"></a><span>        </span><span class="hs-identifier">isExplicit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1578"></a><span>        </span><a name="local-6989586621683872906"><a href="#local-6989586621683872906"><span class="hs-identifier">isExplicit</span></a></a><span> </span><a name="local-6989586621683872912"><a href="#local-6989586621683872912"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683872905"><span class="hs-identifier hs-var">importListOf</span></a><span> </span><a href="#local-6989586621683872912"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1579"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1580"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872913"><a href="#local-6989586621683872913"><span class="hs-identifier">explicit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1581"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683872901"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683872913"><span class="hs-identifier hs-var">explicit</span></a><span>
</span><a name="line-1582"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683872914"><a href="#local-6989586621683872914"><span class="hs-identifier">hidden</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1583"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683872901"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683872914"><span class="hs-identifier hs-var">hidden</span></a><span>
</span><a name="line-1584"></a><span>
</span><a name="line-1585"></a><span>        </span><span class="hs-comment">-- Check whether the given name would be imported (unqualified) from</span><span>
</span><a name="line-1586"></a><span>        </span><span class="hs-comment">-- an import declaration.</span><span>
</span><a name="line-1587"></a><span>        </span><span class="hs-identifier">importViaPrelude</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1588"></a><span>        </span><a name="local-6989586621683872907"><a href="#local-6989586621683872907"><span class="hs-identifier">importViaPrelude</span></a></a><span> </span><a name="local-6989586621683872915"><a href="#local-6989586621683872915"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872902"><span class="hs-identifier hs-var">isPrelude</span></a><span> </span><a href="#local-6989586621683872915"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1589"></a><span>                          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621683872904"><span class="hs-identifier hs-var">isUnqualified</span></a><span> </span><a href="#local-6989586621683872915"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1590"></a><span>                          </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872903"><span class="hs-identifier hs-var">isImplicit</span></a><span> </span><a href="#local-6989586621683872915"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621683872906"><span class="hs-identifier hs-var">isExplicit</span></a><span> </span><a href="#local-6989586621683872915"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1591"></a><span>
</span><a name="line-1592"></a><span>
</span><a name="line-1593"></a><span class="hs-comment">-- Notation: is* is for classes the type is an instance of, should* for those</span><span>
</span><a name="line-1594"></a><span class="hs-comment">--           that it should also be an instance of based on the corresponding</span><span>
</span><a name="line-1595"></a><span class="hs-comment">--           is*.</span><span>
</span><a name="line-1596"></a><span class="hs-identifier">tcMissingParentClassWarn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">WarningFlag</span><span>
</span><a name="line-1597"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-comment">-- ^ Instances of this ...</span><span>
</span><a name="line-1598"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-comment">-- ^ should also be instances of this</span><span>
</span><a name="line-1599"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1600"></a><a name="tcMissingParentClassWarn"><a href="TcRnDriver.html#tcMissingParentClassWarn"><span class="hs-identifier">tcMissingParentClassWarn</span></a></a><span> </span><a name="local-6989586621683872927"><a href="#local-6989586621683872927"><span class="hs-identifier">warnFlag</span></a></a><span> </span><a name="local-6989586621683872928"><a href="#local-6989586621683872928"><span class="hs-identifier">isName</span></a></a><span> </span><a name="local-6989586621683872929"><a href="#local-6989586621683872929"><span class="hs-identifier">shouldName</span></a></a><span>
</span><a name="line-1601"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872945"><a href="#local-6989586621683872945"><span class="hs-identifier">warn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#woptM"><span class="hs-identifier hs-var">woptM</span></a><span> </span><a href="#local-6989586621683872927"><span class="hs-identifier hs-var">warnFlag</span></a><span>
</span><a name="line-1602"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621683872945"><span class="hs-identifier hs-var">warn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1603"></a><span>       </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcMissingParentClassWarn&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-1604"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872946"><a href="#local-6989586621683872946"><span class="hs-identifier">isClass'</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872931"><span class="hs-identifier hs-var">tcLookupClass_maybe</span></a><span> </span><a href="#local-6989586621683872928"><span class="hs-identifier hs-var">isName</span></a><span>
</span><a name="line-1605"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872947"><a href="#local-6989586621683872947"><span class="hs-identifier">shouldClass'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683872931"><span class="hs-identifier hs-var">tcLookupClass_maybe</span></a><span> </span><a href="#local-6989586621683872929"><span class="hs-identifier hs-var">shouldName</span></a><span>
</span><a name="line-1606"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872946"><span class="hs-identifier hs-var">isClass'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872947"><span class="hs-identifier hs-var">shouldClass'</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1607"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872948"><a href="#local-6989586621683872948"><span class="hs-identifier">isClass</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872949"><a href="#local-6989586621683872949"><span class="hs-identifier">shouldClass</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1608"></a><span>                  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872950"><a href="#local-6989586621683872950"><span class="hs-identifier">localInstances</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Inst.html#tcGetInsts"><span class="hs-identifier hs-var">tcGetInsts</span></a><span>
</span><a name="line-1609"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872951"><a href="#local-6989586621683872951"><span class="hs-identifier">isInstance</span></a></a><span> </span><a name="local-6989586621683872953"><a href="#local-6989586621683872953"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">is_cls</span><span> </span><a href="#local-6989586621683872953"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683872948"><span class="hs-identifier hs-var">isClass</span></a><span>
</span><a name="line-1610"></a><span>                        </span><a name="local-6989586621683872952"><a href="#local-6989586621683872952"><span class="hs-identifier">isInsts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621683872951"><span class="hs-identifier hs-var">isInstance</span></a><span> </span><a href="#local-6989586621683872950"><span class="hs-identifier hs-var">localInstances</span></a><span>
</span><a name="line-1611"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcMissingParentClassWarn/isInsts&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872952"><span class="hs-identifier hs-var">isInsts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1612"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">forM_</span><span> </span><a href="#local-6989586621683872952"><span class="hs-identifier hs-var">isInsts</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872930"><span class="hs-identifier hs-var">checkShouldInst</span></a><span> </span><a href="#local-6989586621683872948"><span class="hs-identifier hs-var">isClass</span></a><span> </span><a href="#local-6989586621683872949"><span class="hs-identifier hs-var">shouldClass</span></a><span class="hs-special">)</span><span>
</span><a name="line-1613"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-1614"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621683872954"><a href="#local-6989586621683872954"><span class="hs-identifier">is'</span></a></a><span class="hs-special">,</span><a name="local-6989586621683872955"><a href="#local-6989586621683872955"><span class="hs-identifier">should'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1615"></a><span>                  </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcMissingParentClassWarn/notIsShould&quot;</span><span>
</span><a name="line-1616"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872928"><span class="hs-identifier hs-var">isName</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;/&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872929"><span class="hs-identifier hs-var">shouldName</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-1617"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Is&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;lookup for&quot;</span><span>
</span><a name="line-1618"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872928"><span class="hs-identifier hs-var">isName</span></a><span>
</span><a name="line-1619"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;resulted in&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872954"><span class="hs-identifier hs-var">is'</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1620"></a><span>                            </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1621"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Should&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;lookup for&quot;</span><span>
</span><a name="line-1622"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872929"><span class="hs-identifier hs-var">shouldName</span></a><span>
</span><a name="line-1623"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;resulted in&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872955"><span class="hs-identifier hs-var">should'</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1624"></a><span>       </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1625"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1626"></a><span>    </span><span class="hs-comment">-- Check whether the desired superclass exists in a given environment.</span><span>
</span><a name="line-1627"></a><span>    </span><span class="hs-identifier">checkShouldInst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Class</span><span>   </span><span class="hs-comment">-- ^ Class of existing instance</span><span>
</span><a name="line-1628"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Class</span><span>   </span><span class="hs-comment">-- ^ Class there should be an instance of</span><span>
</span><a name="line-1629"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ClsInst</span><span> </span><span class="hs-comment">-- ^ Existing instance</span><span>
</span><a name="line-1630"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1631"></a><span>    </span><a name="local-6989586621683872930"><a href="#local-6989586621683872930"><span class="hs-identifier">checkShouldInst</span></a></a><span> </span><a name="local-6989586621683872932"><a href="#local-6989586621683872932"><span class="hs-identifier">isClass</span></a></a><span> </span><a name="local-6989586621683872933"><a href="#local-6989586621683872933"><span class="hs-identifier">shouldClass</span></a></a><span> </span><a name="local-6989586621683872934"><a href="#local-6989586621683872934"><span class="hs-identifier">isInst</span></a></a><span>
</span><a name="line-1632"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872935"><a href="#local-6989586621683872935"><span class="hs-identifier">instEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span>
</span><a name="line-1633"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872936"><a href="#local-6989586621683872936"><span class="hs-identifier">instanceMatches</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872937"><a href="#local-6989586621683872937"><span class="hs-identifier">shouldInsts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1634"></a><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupInstEnv</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621683872935"><span class="hs-identifier hs-var">instEnv</span></a><span> </span><a href="#local-6989586621683872933"><span class="hs-identifier hs-var">shouldClass</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_tys</span><span> </span><a href="#local-6989586621683872934"><span class="hs-identifier hs-var">isInst</span></a><span class="hs-special">)</span><span>
</span><a name="line-1635"></a><span>
</span><a name="line-1636"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcMissingParentClassWarn/checkShouldInst&quot;</span><span>
</span><a name="line-1637"></a><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872934"><span class="hs-identifier hs-var">isInst</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-1638"></a><span>                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872936"><span class="hs-identifier hs-var">instanceMatches</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872937"><span class="hs-identifier hs-var">shouldInsts</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1639"></a><span>
</span><a name="line-1640"></a><span>           </span><span class="hs-comment">-- &quot;&lt;location&gt;: Warning: &lt;type&gt; is an instance of &lt;is&gt; but not</span><span>
</span><a name="line-1641"></a><span>           </span><span class="hs-comment">-- &lt;should&gt;&quot; e.g. &quot;Foo is an instance of Monad but not Applicative&quot;</span><span>
</span><a name="line-1642"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872938"><a href="#local-6989586621683872938"><span class="hs-identifier">instLoc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">srcLocSpan</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameSrcLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621683872934"><span class="hs-identifier hs-var">isInst</span></a><span>
</span><a name="line-1643"></a><span>                 </span><a name="local-6989586621683872939"><a href="#local-6989586621683872939"><span class="hs-identifier">warnMsg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872940"><a href="#local-6989586621683872940"><span class="hs-identifier">name</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1644"></a><span>                      </span><a href="TcRnMonad.html#addWarnAt"><span class="hs-identifier hs-var">addWarnAt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Reason</span><span> </span><a href="#local-6989586621683872927"><span class="hs-identifier hs-var">warnFlag</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872938"><span class="hs-identifier hs-var">instLoc</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1645"></a><span>                           </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872940"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1646"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is an instance of&quot;</span><span>
</span><a name="line-1647"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">className</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872932"><span class="hs-identifier hs-var">isClass</span></a><span>
</span><a name="line-1648"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;but not&quot;</span><span>
</span><a name="line-1649"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">nameOccName</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">className</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872933"><span class="hs-identifier hs-var">shouldClass</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1650"></a><span>                                </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-1651"></a><span>                           </span><span class="hs-operator hs-var">$$</span><span>
</span><a name="line-1652"></a><span>                           </span><span class="hs-identifier hs-var">hsep</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;This will become an error in&quot;</span><span>
</span><a name="line-1653"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;a future release.&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1654"></a><span>                 </span><span class="hs-identifier">warnMsg</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1655"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683872937"><span class="hs-identifier hs-var">shouldInsts</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683872936"><span class="hs-identifier hs-var">instanceMatches</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1656"></a><span>                  </span><a href="#local-6989586621683872939"><span class="hs-identifier hs-var">warnMsg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">is_tcs</span><span> </span><a href="#local-6989586621683872934"><span class="hs-identifier hs-var">isInst</span></a><span class="hs-special">)</span><span>
</span><a name="line-1657"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-1658"></a><span>
</span><a name="line-1659"></a><span>    </span><span class="hs-identifier">tcLookupClass_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Class</span><span class="hs-special">)</span><span>
</span><a name="line-1660"></a><span>    </span><a name="local-6989586621683872931"><a href="#local-6989586621683872931"><span class="hs-identifier">tcLookupClass_maybe</span></a></a><span> </span><a name="local-6989586621683872941"><a href="#local-6989586621683872941"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="LoadIface.html#tcLookupImported_maybe"><span class="hs-identifier hs-var">tcLookupImported_maybe</span></a><span> </span><a href="#local-6989586621683872941"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-1661"></a><span>        </span><span class="hs-identifier hs-var">Succeeded</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621683872942"><a href="#local-6989586621683872942"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683872943"><a href="#local-6989586621683872943"><span class="hs-identifier">cls</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConClass_maybe</span><span> </span><a href="#local-6989586621683872942"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621683872943"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-1662"></a><span>        </span><a name="local-6989586621683872944"><a href="#local-6989586621683872944"><span class="hs-identifier">_else</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1663"></a><span>
</span><a name="line-1664"></a><span>
</span><a name="line-1665"></a><span class="hs-comment">---------------------------</span><span>
</span><a name="line-1666"></a><span class="hs-identifier">tcTyClsInstDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TyClGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1667"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LDerivDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span>
</span><a name="line-1668"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">RecFlag</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1669"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- The full inst env</span><span>
</span><a name="line-1670"></a><span>                         </span><span class="hs-special">[</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- Source-code instance decls to</span><span>
</span><a name="line-1671"></a><span>                                              </span><span class="hs-comment">-- process; contains all dfuns for</span><span>
</span><a name="line-1672"></a><span>                                              </span><span class="hs-comment">-- this module</span><span>
</span><a name="line-1673"></a><span>                          </span><span class="hs-identifier hs-type">HsValBinds</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Supporting bindings for derived</span><span>
</span><a name="line-1674"></a><span>                                              </span><span class="hs-comment">-- instances</span><span>
</span><a name="line-1675"></a><span>
</span><a name="line-1676"></a><a name="tcTyClsInstDecls"><a href="TcRnDriver.html#tcTyClsInstDecls"><span class="hs-identifier">tcTyClsInstDecls</span></a></a><span> </span><a name="local-6989586621683872956"><a href="#local-6989586621683872956"><span class="hs-identifier">tycl_decls</span></a></a><span> </span><a name="local-6989586621683872957"><a href="#local-6989586621683872957"><span class="hs-identifier">deriv_decls</span></a></a><span> </span><a name="local-6989586621683872958"><a href="#local-6989586621683872958"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-1677"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcAddDataFamConPlaceholders"><span class="hs-identifier hs-var">tcAddDataFamConPlaceholders</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872956"><span class="hs-identifier hs-var">tycl_decls</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier">group_instds</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1678"></a><span>   </span><a href="TcEnv.html#tcAddPatSynPlaceholders"><span class="hs-identifier hs-var">tcAddPatSynPlaceholders</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getPatSynBinds</span><span> </span><a href="#local-6989586621683872958"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1679"></a><span>   </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872959"><a href="#local-6989586621683872959"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872960"><a href="#local-6989586621683872960"><span class="hs-identifier">inst_info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872961"><a href="#local-6989586621683872961"><span class="hs-identifier">datafam_deriv_info</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1680"></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcTyAndClassDecls"><span class="hs-identifier hs-var">tcTyAndClassDecls</span></a><span> </span><a href="#local-6989586621683872956"><span class="hs-identifier hs-var">tycl_decls</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1681"></a><span>      </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872959"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1682"></a><span>          </span><span class="hs-comment">-- With the @TyClDecl@s and @InstDecl@s checked we're ready to</span><span>
</span><a name="line-1683"></a><span>          </span><span class="hs-comment">-- process the deriving clauses, including data family deriving</span><span>
</span><a name="line-1684"></a><span>          </span><span class="hs-comment">-- clauses discovered in @tcTyAndClassDecls@.</span><span>
</span><a name="line-1685"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-1686"></a><span>          </span><span class="hs-comment">-- Careful to quit now in case there were instance errors, so that</span><span>
</span><a name="line-1687"></a><span>          </span><span class="hs-comment">-- the deriving errors don't pile up as well.</span><span>
</span><a name="line-1688"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span>
</span><a name="line-1689"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872962"><a href="#local-6989586621683872962"><span class="hs-identifier">tyclds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683872956"><span class="hs-identifier hs-var">tycl_decls</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier">group_tyclds</span><span>
</span><a name="line-1690"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872963"><a href="#local-6989586621683872963"><span class="hs-identifier">tcg_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872964"><a href="#local-6989586621683872964"><span class="hs-identifier">inst_info'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872965"><a href="#local-6989586621683872965"><span class="hs-identifier">val_binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>              </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInstDcls.html#tcInstDeclsDeriv"><span class="hs-identifier hs-var">tcInstDeclsDeriv</span></a><span> </span><a href="#local-6989586621683872961"><span class="hs-identifier hs-var">datafam_deriv_info</span></a><span> </span><a href="#local-6989586621683872962"><span class="hs-identifier hs-var">tyclds</span></a><span> </span><a href="#local-6989586621683872957"><span class="hs-identifier hs-var">deriv_decls</span></a><span>
</span><a name="line-1692"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621683872963"><span class="hs-identifier hs-var">tcg_env'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1693"></a><span>                </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span>
</span><a name="line-1694"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872963"><span class="hs-identifier hs-var">tcg_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872964"><span class="hs-identifier hs-var">inst_info'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683872960"><span class="hs-identifier hs-var">inst_info</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683872965"><span class="hs-identifier hs-var">val_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1695"></a><span>      </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1696"></a><span>
</span><a name="line-1697"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
        Checking for 'main'
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1703"></a><span>
</span><a name="line-1704"></a><span class="hs-identifier">checkMain</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- False =&gt; no 'module M(..) where' header at all</span><span>
</span><a name="line-1705"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-1706"></a><span class="hs-comment">-- If we are in module Main, check that 'main' is defined.</span><span>
</span><a name="line-1707"></a><a name="checkMain"><a href="TcRnDriver.html#checkMain"><span class="hs-identifier">checkMain</span></a></a><span> </span><a name="local-6989586621683872966"><a href="#local-6989586621683872966"><span class="hs-identifier">explicit_mod_hdr</span></a></a><span>
</span><a name="line-1708"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872967"><a href="#local-6989586621683872967"><span class="hs-identifier">dflags</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1709"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872968"><a href="#local-6989586621683872968"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1710"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnDriver.html#check_main"><span class="hs-identifier hs-var">check_main</span></a><span> </span><a href="#local-6989586621683872967"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621683872968"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><a href="#local-6989586621683872966"><span class="hs-identifier hs-var">explicit_mod_hdr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1711"></a><span>
</span><a name="line-1712"></a><span class="hs-identifier">check_main</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-1713"></a><a name="check_main"><a href="TcRnDriver.html#check_main"><span class="hs-identifier">check_main</span></a></a><span> </span><a name="local-6989586621683872969"><a href="#local-6989586621683872969"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621683872970"><a href="#local-6989586621683872970"><span class="hs-identifier">tcg_env</span></a></a><span> </span><a name="local-6989586621683872971"><a href="#local-6989586621683872971"><span class="hs-identifier">explicit_mod_hdr</span></a></a><span>
</span><a name="line-1714"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683872972"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621683872973"><span class="hs-identifier hs-var">main_mod</span></a><span>
</span><a name="line-1715"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkMain not&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872973"><span class="hs-identifier hs-var">main_mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872972"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span>
</span><a name="line-1716"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683872970"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1717"></a><span>
</span><a name="line-1718"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1719"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872980"><a href="#local-6989586621683872980"><span class="hs-identifier">mb_main</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupGlobalOccRn_maybe"><span class="hs-identifier hs-var">lookupGlobalOccRn_maybe</span></a><span> </span><a href="#local-6989586621683872974"><span class="hs-identifier hs-var">main_fn</span></a><span>
</span><a name="line-1720"></a><span>                </span><span class="hs-comment">-- Check that 'main' is in scope</span><span>
</span><a name="line-1721"></a><span>                </span><span class="hs-comment">-- It might be imported from another module!</span><span>
</span><a name="line-1722"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683872980"><span class="hs-identifier hs-var">mb_main</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1723"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkMain fail&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872973"><span class="hs-identifier hs-var">main_mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872974"><span class="hs-identifier hs-var">main_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1724"></a><span>                           </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621683872976"><span class="hs-identifier hs-var">complain_no_main</span></a><span>
</span><a name="line-1725"></a><span>                           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683872970"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1726"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872981"><a href="#local-6989586621683872981"><span class="hs-identifier">main_name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1727"></a><span>
</span><a name="line-1728"></a><span>        </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkMain found&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872973"><span class="hs-identifier hs-var">main_mod</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872974"><span class="hs-identifier hs-var">main_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1729"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872982"><a href="#local-6989586621683872982"><span class="hs-identifier">loc</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">srcLocSpan</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcLoc</span><span> </span><a href="#local-6989586621683872981"><span class="hs-identifier hs-var">main_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1730"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872983"><a href="#local-6989586621683872983"><span class="hs-identifier">ioTyCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">ioTyConName</span><span>
</span><a name="line-1731"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872984"><a href="#local-6989586621683872984"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#newFlexiTyVarTy"><span class="hs-identifier hs-var">newFlexiTyVarTy</span></a><span> </span><span class="hs-identifier hs-var">liftedTypeKind</span><span>
</span><a name="line-1732"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683872985"><a href="#local-6989586621683872985"><span class="hs-identifier">io_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683872983"><span class="hs-identifier hs-var">ioTyCon</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683872984"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1733"></a><span>              </span><a name="local-6989586621683872986"><a href="#local-6989586621683872986"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SigSkol</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FunSigCtxt</span><span> </span><a href="#local-6989586621683872981"><span class="hs-identifier hs-var">main_name</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683872985"><span class="hs-identifier hs-var">io_ty</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1734"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683872987"><a href="#local-6989586621683872987"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683872988"><a href="#local-6989586621683872988"><span class="hs-identifier">main_expr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1735"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><a href="#local-6989586621683872986"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1736"></a><span>                  </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><a href="#local-6989586621683872977"><span class="hs-identifier hs-var">mainCtxt</span></a><span>    </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1737"></a><span>                  </span><a href="TcExpr.html#tcMonoExpr"><span class="hs-identifier hs-var">tcMonoExpr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683872982"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683872982"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683872981"><span class="hs-identifier hs-var">main_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1738"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683872985"><span class="hs-identifier hs-var">io_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1739"></a><span>
</span><a name="line-1740"></a><span>                </span><span class="hs-comment">-- See Note [Root-main Id]</span><span>
</span><a name="line-1741"></a><span>                </span><span class="hs-comment">-- Construct the binding</span><span>
</span><a name="line-1742"></a><span>                </span><span class="hs-comment">--      :Main.main :: IO res_ty = runMainIO res_ty main</span><span>
</span><a name="line-1743"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872989"><a href="#local-6989586621683872989"><span class="hs-identifier">run_main_id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><span class="hs-identifier hs-var">runMainIOName</span><span>
</span><a name="line-1744"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872990"><a href="#local-6989586621683872990"><span class="hs-identifier">root_main_name</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">mkExternalName</span><span> </span><span class="hs-identifier hs-var">rootMainKey</span><span> </span><span class="hs-identifier hs-var">rOOT_MAIN</span><span>
</span><a name="line-1745"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarOccFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;main&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1746"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getSrcSpan</span><span> </span><a href="#local-6989586621683872981"><span class="hs-identifier hs-var">main_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1747"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872991"><a href="#local-6989586621683872991"><span class="hs-identifier">root_main_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Id.mkExportedVanillaId</span><span> </span><a href="#local-6989586621683872990"><span class="hs-identifier hs-var">root_main_name</span></a><span>
</span><a name="line-1748"></a><span>                                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683872983"><span class="hs-identifier hs-var">ioTyCon</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683872984"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1749"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872992"><a href="#local-6989586621683872992"><span class="hs-identifier">co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkWpTyApps</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683872984"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-1750"></a><span>              </span><span class="hs-comment">-- The ev_binds of the `main` function may contain deferred</span><span>
</span><a name="line-1751"></a><span>              </span><span class="hs-comment">-- type error when type of `main` is not `IO a`. The `ev_binds`</span><span>
</span><a name="line-1752"></a><span>              </span><span class="hs-comment">-- must be put inside `runMainIO` to ensure the deferred type</span><span>
</span><a name="line-1753"></a><span>              </span><span class="hs-comment">-- error can be emitted correctly. See Trac #13838.</span><span>
</span><a name="line-1754"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872993"><a href="#local-6989586621683872993"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLHsWrap</span><span> </span><a href="#local-6989586621683872992"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683872989"><span class="hs-identifier hs-var">run_main_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1755"></a><span>                        </span><span class="hs-identifier hs-var">mkHsDictLet</span><span> </span><a href="#local-6989586621683872987"><span class="hs-identifier hs-var">ev_binds</span></a><span> </span><a href="#local-6989586621683872988"><span class="hs-identifier hs-var">main_expr</span></a><span>
</span><a name="line-1756"></a><span>              </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683872994"><a href="#local-6989586621683872994"><span class="hs-identifier">main_bind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarBind</span><span> </span><a href="#local-6989586621683872991"><span class="hs-identifier hs-var">root_main_id</span></a><span> </span><a href="#local-6989586621683872993"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1757"></a><span>
</span><a name="line-1758"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872970"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_main</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621683872981"><span class="hs-identifier hs-var">main_name</span></a><span class="hs-special">,</span><span>
</span><a name="line-1759"></a><span>                            </span><span class="hs-identifier">tcg_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_binds</span><span> </span><a href="#local-6989586621683872970"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1760"></a><span>                                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">snocBag</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683872994"><span class="hs-identifier hs-var">main_bind</span></a><span class="hs-special">,</span><span>
</span><a name="line-1761"></a><span>                            </span><span class="hs-identifier">tcg_dus</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_dus</span><span> </span><a href="#local-6989586621683872970"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1762"></a><span>                                        </span><span class="hs-special">`</span><span class="hs-identifier hs-var">plusDU</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">usesOnly</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unitFV</span><span> </span><a href="#local-6989586621683872981"><span class="hs-identifier hs-var">main_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1763"></a><span>                        </span><span class="hs-comment">-- Record the use of 'main', so that we don't</span><span>
</span><a name="line-1764"></a><span>                        </span><span class="hs-comment">-- complain about it being defined but not used</span><span>
</span><a name="line-1765"></a><span>                 </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1766"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1767"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1768"></a><span>    </span><a name="local-6989586621683872972"><a href="#local-6989586621683872972"><span class="hs-identifier">mod</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_mod</span><span> </span><a href="#local-6989586621683872970"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1769"></a><span>    </span><a name="local-6989586621683872973"><a href="#local-6989586621683872973"><span class="hs-identifier">main_mod</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mainModIs</span><span> </span><a href="#local-6989586621683872969"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1770"></a><span>    </span><a name="local-6989586621683872974"><a href="#local-6989586621683872974"><span class="hs-identifier">main_fn</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#getMainFun"><span class="hs-identifier hs-var">getMainFun</span></a><span> </span><a href="#local-6989586621683872969"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1771"></a><span>    </span><a name="local-6989586621683872975"><a href="#local-6989586621683872975"><span class="hs-identifier">interactive</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621683872969"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">LinkInMemory</span><span>
</span><a name="line-1772"></a><span>
</span><a name="line-1773"></a><span>    </span><a name="local-6989586621683872976"><a href="#local-6989586621683872976"><span class="hs-identifier">complain_no_main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872975"><span class="hs-identifier hs-var">interactive</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621683872971"><span class="hs-identifier hs-var">explicit_mod_hdr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1774"></a><span>                              </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><a href="#local-6989586621683872978"><span class="hs-identifier hs-var">noMainMsg</span></a><span class="hs-special">)</span><span>                  </span><span class="hs-comment">-- #12906</span><span>
</span><a name="line-1775"></a><span>        </span><span class="hs-comment">-- Without an explicit module header...</span><span>
</span><a name="line-1776"></a><span>          </span><span class="hs-comment">-- in interactive mode, don't worry about the absence of 'main'.</span><span>
</span><a name="line-1777"></a><span>          </span><span class="hs-comment">-- in other modes, add error message and go on with typechecking.</span><span>
</span><a name="line-1778"></a><span>
</span><a name="line-1779"></a><span>    </span><a name="local-6989586621683872977"><a href="#local-6989586621683872977"><span class="hs-identifier">mainCtxt</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;When checking the type of the&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872979"><span class="hs-identifier hs-var">pp_main_fn</span></a><span>
</span><a name="line-1780"></a><span>    </span><a name="local-6989586621683872978"><a href="#local-6989586621683872978"><span class="hs-identifier">noMainMsg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="#local-6989586621683872979"><span class="hs-identifier hs-var">pp_main_fn</span></a><span>
</span><a name="line-1781"></a><span>                </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not defined in module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683872973"><span class="hs-identifier hs-var">main_mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1782"></a><span>    </span><a name="local-6989586621683872979"><a href="#local-6989586621683872979"><span class="hs-identifier">pp_main_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#ppMainFn"><span class="hs-identifier hs-var">ppMainFn</span></a><span> </span><a href="#local-6989586621683872974"><span class="hs-identifier hs-var">main_fn</span></a><span>
</span><a name="line-1783"></a><span>
</span><a name="line-1784"></a><span class="hs-comment">-- | Get the unqualified name of the function to use as the \&quot;main\&quot; for the main module.</span><span>
</span><a name="line-1785"></a><span class="hs-comment">-- Either returns the default name or the one configured on the command line with -main-is</span><span>
</span><a name="line-1786"></a><span class="hs-identifier">getMainFun</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-1787"></a><a name="getMainFun"><a href="TcRnDriver.html#getMainFun"><span class="hs-identifier">getMainFun</span></a></a><span> </span><a name="local-6989586621683872995"><a href="#local-6989586621683872995"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">mainFunIs</span><span> </span><a href="#local-6989586621683872995"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1788"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872996"><a href="#local-6989586621683872996"><span class="hs-identifier">fn</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">mkRdrUnqual</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkVarOccFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkFastString</span><span> </span><a href="#local-6989586621683872996"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1789"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">main_RDR_Unqual</span><span>
</span><a name="line-1790"></a><span>
</span><a name="line-1791"></a><span class="hs-comment">-- If we are in module Main, check that 'main' is exported.</span><span>
</span><a name="line-1792"></a><span class="hs-identifier">checkMainExported</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1793"></a><a name="checkMainExported"><a href="TcRnDriver.html#checkMainExported"><span class="hs-identifier">checkMainExported</span></a></a><span> </span><a name="local-6989586621683872997"><a href="#local-6989586621683872997"><span class="hs-identifier">tcg_env</span></a></a><span>
</span><a name="line-1794"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">tcg_main</span><span> </span><a href="#local-6989586621683872997"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1795"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- not the main module</span><span>
</span><a name="line-1796"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621683872998"><a href="#local-6989586621683872998"><span class="hs-identifier">main_name</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1797"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683872999"><a href="#local-6989586621683872999"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-1798"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873000"><a href="#local-6989586621683873000"><span class="hs-identifier">main_mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mainModIs</span><span> </span><a href="#local-6989586621683872999"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1799"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ghcLink</span><span> </span><a href="#local-6989586621683872999"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier hs-var">LinkInMemory</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>      </span><span class="hs-comment">-- #11647</span><span>
</span><a name="line-1800"></a><span>                </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872998"><span class="hs-identifier hs-var">main_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span>
</span><a name="line-1801"></a><span>                           </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier hs-var">availNames</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_exports</span><span> </span><a href="#local-6989586621683872997"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1802"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;The&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><a href="TcRnDriver.html#ppMainFn"><span class="hs-identifier hs-var">ppMainFn</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameRdrName</span><span> </span><a href="#local-6989586621683872998"><span class="hs-identifier hs-var">main_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1803"></a><span>                   </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;is not exported by module&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873000"><span class="hs-identifier hs-var">main_mod</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1804"></a><span>
</span><a name="line-1805"></a><span class="hs-identifier">ppMainFn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-1806"></a><a name="ppMainFn"><a href="TcRnDriver.html#ppMainFn"><span class="hs-identifier">ppMainFn</span></a></a><span> </span><a name="local-6989586621683873001"><a href="#local-6989586621683873001"><span class="hs-identifier">main_fn</span></a></a><span>
</span><a name="line-1807"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">rdrNameOcc</span><span> </span><a href="#local-6989586621683873001"><span class="hs-identifier hs-var">main_fn</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="TcRnDriver.html#mainOcc"><span class="hs-identifier hs-var">mainOcc</span></a><span>
</span><a name="line-1808"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;IO action&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873001"><span class="hs-identifier hs-var">main_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1809"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1810"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;main IO action&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873001"><span class="hs-identifier hs-var">main_fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1811"></a><span>
</span><a name="line-1812"></a><span class="hs-identifier">mainOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OccName</span><span>
</span><a name="line-1813"></a><a name="mainOcc"><a href="TcRnDriver.html#mainOcc"><span class="hs-identifier">mainOcc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkVarOccFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;main&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1814"></a><span>
</span><a name="line-1815"></a><span class="hs-comment">{-
Note [Root-main Id]
~~~~~~~~~~~~~~~~~~~
The function that the RTS invokes is always :Main.main, which we call
root_main_id.  (Because GHC allows the user to have a module not
called Main as the main module, we can't rely on the main function
being called &quot;Main.main&quot;.  That's why root_main_id has a fixed module
&quot;:Main&quot;.)

This is unusual: it's a LocalId whose Name has a Module from another
module.  Tiresomely, we must filter it out again in MkIface, les we
get two defns for 'main' in the interface file!


*********************************************************
*                                                       *
                GHCi stuff
*                                                       *
*********************************************************
-}</span><span>
</span><a name="line-1835"></a><span>
</span><a name="line-1836"></a><span class="hs-identifier">runTcInteractive</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><a href="#local-6989586621683872483"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621683872483"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1837"></a><span class="hs-comment">-- Initialise the tcg_inst_env with instances from all home modules.</span><span>
</span><a name="line-1838"></a><span class="hs-comment">-- This mimics the more selective call to hptInstances in tcRnImports</span><span>
</span><a name="line-1839"></a><a name="runTcInteractive"><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier">runTcInteractive</span></a></a><span> </span><a name="local-6989586621683873002"><a href="#local-6989586621683873002"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873003"><a href="#local-6989586621683873003"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1840"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#initTcInteractive"><span class="hs-identifier hs-var">initTcInteractive</span></a><span> </span><a href="#local-6989586621683873002"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TcRnDriver.html#withTcPlugins"><span class="hs-identifier hs-var">withTcPlugins</span></a><span> </span><a href="#local-6989586621683873002"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1841"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;setInteractiveContext&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1842"></a><span>            </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ic_tythings:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_tythings</span><span> </span><a href="#local-6989586621683873006"><span class="hs-identifier hs-var">icxt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1843"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ic_insts:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pprBndr</span><span> </span><span class="hs-identifier hs-var">LetBind</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">instanceDFunId</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873007"><span class="hs-identifier hs-var">ic_insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1844"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;ic_rn_gbl_env (LocalDef)&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-1845"></a><span>                      </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683873020"><span class="hs-identifier hs-var">local_gres</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683873019"><a href="#local-6989586621683873019"><span class="hs-identifier">gres</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">occEnvElts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><a href="#local-6989586621683873006"><span class="hs-identifier hs-var">icxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1846"></a><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873020"><a href="#local-6989586621683873020"><span class="hs-identifier">local_gres</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">isLocalGRE</span><span> </span><a href="#local-6989586621683873019"><span class="hs-identifier hs-var">gres</span></a><span>
</span><a name="line-1847"></a><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683873020"><span class="hs-identifier hs-var">local_gres</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1848"></a><span>
</span><a name="line-1849"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873021"><a href="#local-6989586621683873021"><span class="hs-identifier">getOrphans</span></a></a><span> </span><a name="local-6989586621683873022"><a href="#local-6989586621683873022"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621683873023"><a href="#local-6989586621683873023"><span class="hs-identifier">mb_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683873024"><a href="#local-6989586621683873024"><span class="hs-identifier">iface</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">mi_module</span><span> </span><a href="#local-6989586621683873024"><span class="hs-identifier hs-var">iface</span></a><span>
</span><a name="line-1850"></a><span>                                          </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">dep_orphs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mi_deps</span><span> </span><a href="#local-6989586621683873024"><span class="hs-identifier hs-var">iface</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1851"></a><span>                                 </span><span class="hs-special">(</span><a href="LoadIface.html#loadSrcInterface"><span class="hs-identifier hs-var">loadSrcInterface</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;runTcInteractive&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873022"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1852"></a><span>                                                   </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621683873023"><span class="hs-identifier hs-var">mb_pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1853"></a><span>
</span><a name="line-1854"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621683873029"><a href="#local-6989586621683873029"><span class="hs-identifier">orphs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">force</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concat</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_imports</span><span> </span><a href="#local-6989586621683873006"><span class="hs-identifier hs-var">icxt</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683873025"><a href="#local-6989586621683873025"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1855"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683873025"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-keyword">of</span><span>                   </span><span class="hs-comment">-- force above: see #15111</span><span>
</span><a name="line-1856"></a><span>                </span><span class="hs-identifier hs-var">IIModule</span><span> </span><a name="local-6989586621683873026"><a href="#local-6989586621683873026"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683873021"><span class="hs-identifier hs-var">getOrphans</span></a><span> </span><a href="#local-6989586621683873026"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1857"></a><span>                </span><span class="hs-identifier hs-var">IIDecl</span><span> </span><a name="local-6989586621683873027"><a href="#local-6989586621683873027"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1858"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873028"><a href="#local-6989586621683873028"><span class="hs-identifier">mb_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sl_fs</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">ideclPkgQual</span><span> </span><a href="#local-6989586621683873027"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1859"></a><span>                  </span><a href="#local-6989586621683873021"><span class="hs-identifier hs-var">getOrphans</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ideclName</span><span> </span><a href="#local-6989586621683873027"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873028"><span class="hs-identifier hs-var">mb_pkg</span></a><span>
</span><a name="line-1860"></a><span>
</span><a name="line-1861"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873030"><a href="#local-6989586621683873030"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyImportAvails</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1862"></a><span>                            </span><span class="hs-identifier">imp_orphs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873029"><span class="hs-identifier hs-var">orphs</span></a><span>
</span><a name="line-1863"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-1864"></a><span>
</span><a name="line-1865"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683873031"><a href="#local-6989586621683873031"><span class="hs-identifier">gbl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873032"><a href="#local-6989586621683873032"><span class="hs-identifier">lcl_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getEnvs"><span class="hs-identifier hs-var">getEnvs</span></a><span>
</span><a name="line-1866"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873033"><a href="#local-6989586621683873033"><span class="hs-identifier">gbl_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873031"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1867"></a><span>                           </span><span class="hs-identifier">tcg_rdr_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><a href="#local-6989586621683873006"><span class="hs-identifier hs-var">icxt</span></a><span>
</span><a name="line-1868"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_type_env</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873013"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-1869"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_inst_env</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendInstEnvList</span><span>
</span><a name="line-1870"></a><span>                                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendInstEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_inst_env</span><span> </span><a href="#local-6989586621683873031"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873007"><span class="hs-identifier hs-var">ic_insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1871"></a><span>                                               </span><a href="#local-6989586621683873004"><span class="hs-identifier hs-var">home_insts</span></a><span>
</span><a name="line-1872"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendFamInstEnvList</span><span>
</span><a name="line-1873"></a><span>                                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">extendFamInstEnvList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_fam_inst_env</span><span> </span><a href="#local-6989586621683873031"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1874"></a><span>                                                                     </span><a href="#local-6989586621683873008"><span class="hs-identifier hs-var">ic_finsts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1875"></a><span>                                               </span><a href="#local-6989586621683873005"><span class="hs-identifier hs-var">home_fam_insts</span></a><span>
</span><a name="line-1876"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_field_env</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNameEnv</span><span> </span><a href="#local-6989586621683873014"><span class="hs-identifier hs-var">con_fields</span></a><span>
</span><a name="line-1877"></a><span>                              </span><span class="hs-comment">-- setting tcg_field_env is necessary</span><span>
</span><a name="line-1878"></a><span>                              </span><span class="hs-comment">-- to make RecordWildCards work (test: ghci049)</span><span>
</span><a name="line-1879"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_fix_env</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_fix_env</span><span> </span><a href="#local-6989586621683873006"><span class="hs-identifier hs-var">icxt</span></a><span>
</span><a name="line-1880"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_default</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_default</span><span> </span><a href="#local-6989586621683873006"><span class="hs-identifier hs-var">icxt</span></a><span>
</span><a name="line-1881"></a><span>                              </span><span class="hs-comment">-- must calculate imp_orphs of the ImportAvails</span><span>
</span><a name="line-1882"></a><span>                              </span><span class="hs-comment">-- so that instance visibility is done correctly</span><span>
</span><a name="line-1883"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_imports</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873030"><span class="hs-identifier hs-var">imports</span></a><span>
</span><a name="line-1884"></a><span>                         </span><span class="hs-special">}</span><span>
</span><a name="line-1885"></a><span>
</span><a name="line-1886"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873034"><a href="#local-6989586621683873034"><span class="hs-identifier">lcl_env'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcExtendLocalTypeEnv"><span class="hs-identifier hs-var">tcExtendLocalTypeEnv</span></a><span> </span><a href="#local-6989586621683873032"><span class="hs-identifier hs-var">lcl_env</span></a><span> </span><a href="#local-6989586621683873009"><span class="hs-identifier hs-var">lcl_ids</span></a><span>
</span><a name="line-1887"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setEnvs"><span class="hs-identifier hs-var">setEnvs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873033"><span class="hs-identifier hs-var">gbl_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873034"><span class="hs-identifier hs-var">lcl_env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873003"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1888"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1889"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683873004"><a href="#local-6989586621683873004"><span class="hs-identifier">home_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873005"><a href="#local-6989586621683873005"><span class="hs-identifier">home_fam_insts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hptInstances</span><span> </span><a href="#local-6989586621683873002"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-1890"></a><span>
</span><a name="line-1891"></a><span>    </span><a name="local-6989586621683873006"><a href="#local-6989586621683873006"><span class="hs-identifier">icxt</span></a></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621683873002"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-1892"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683873007"><a href="#local-6989586621683873007"><span class="hs-identifier">ic_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873008"><a href="#local-6989586621683873008"><span class="hs-identifier">ic_finsts</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ic_instances</span><span> </span><a href="#local-6989586621683873006"><span class="hs-identifier hs-var">icxt</span></a><span>
</span><a name="line-1893"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683873009"><a href="#local-6989586621683873009"><span class="hs-identifier">lcl_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873010"><a href="#local-6989586621683873010"><span class="hs-identifier">top_ty_things</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partitionWith</span><span> </span><a href="#local-6989586621683873011"><span class="hs-identifier hs-var">is_closed</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_tythings</span><span> </span><a href="#local-6989586621683873006"><span class="hs-identifier hs-var">icxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-1894"></a><span>
</span><a name="line-1895"></a><span>    </span><span class="hs-identifier">is_closed</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">TcTyThing</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span>
</span><a name="line-1896"></a><span>    </span><span class="hs-comment">-- Put Ids with free type variables (always RuntimeUnks)</span><span>
</span><a name="line-1897"></a><span>    </span><span class="hs-comment">-- in the *local* type environment</span><span>
</span><a name="line-1898"></a><span>    </span><span class="hs-comment">-- See Note [Initialising the type environment for GHCi]</span><span>
</span><a name="line-1899"></a><span>    </span><a name="local-6989586621683873011"><a href="#local-6989586621683873011"><span class="hs-identifier">is_closed</span></a></a><span> </span><a name="local-6989586621683873015"><a href="#local-6989586621683873015"><span class="hs-identifier">thing</span></a></a><span>
</span><a name="line-1900"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">AnId</span><span> </span><a name="local-6989586621683873016"><a href="#local-6989586621683873016"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683873015"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1901"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TcEnv.html#isTypeClosedLetBndr"><span class="hs-identifier hs-var">isTypeClosedLetBndr</span></a><span> </span><a href="#local-6989586621683873016"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-1902"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683873016"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ATcId</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tct_id</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873016"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1903"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tct_info</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NotLetBound</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1904"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1905"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><a href="#local-6989586621683873015"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-1906"></a><span>
</span><a name="line-1907"></a><span>    </span><a name="local-6989586621683873012"><a href="#local-6989586621683873012"><span class="hs-identifier">type_env1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTypeEnvWithImplicits</span><span> </span><a href="#local-6989586621683873010"><span class="hs-identifier hs-var">top_ty_things</span></a><span>
</span><a name="line-1908"></a><span>    </span><a name="local-6989586621683873013"><a href="#local-6989586621683873013"><span class="hs-identifier">type_env</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendTypeEnvWithIds</span><span> </span><a href="#local-6989586621683873012"><span class="hs-identifier hs-var">type_env1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">instanceDFunId</span><span> </span><a href="#local-6989586621683873007"><span class="hs-identifier hs-var">ic_insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1909"></a><span>                </span><span class="hs-comment">-- Putting the dfuns in the type_env</span><span>
</span><a name="line-1910"></a><span>                </span><span class="hs-comment">-- is just to keep Core Lint happy</span><span>
</span><a name="line-1911"></a><span>
</span><a name="line-1912"></a><span>    </span><a name="local-6989586621683873014"><a href="#local-6989586621683873014"><span class="hs-identifier">con_fields</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConName</span><span> </span><a href="#local-6989586621683873018"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">dataConFieldLabels</span><span> </span><a href="#local-6989586621683873018"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-1913"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621683873017"><a href="#local-6989586621683873017"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683873010"><span class="hs-identifier hs-var">top_ty_things</span></a><span>
</span><a name="line-1914"></a><span>                 </span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873018"><a href="#local-6989586621683873018"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tyConDataCons</span><span> </span><a href="#local-6989586621683873017"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1915"></a><span>
</span><a name="line-1916"></a><span>
</span><a name="line-1917"></a><span class="hs-comment">{- Note [Initialising the type environment for GHCi]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Most of the Ids in ic_things, defined by the user in 'let' stmts,
have closed types. E.g.
   ghci&gt; let foo x y = x &amp;&amp; not y

However the GHCi debugger creates top-level bindings for Ids whose
types have free RuntimeUnk skolem variables, standing for unknown
types.  If we don't register these free TyVars as global TyVars then
the typechecker will try to quantify over them and fall over in
skolemiseQuantifiedTyVar. so we must add any free TyVars to the
typechecker's global TyVar set.  That is most conveniently by using
tcExtendLocalTypeEnv, which automatically extends the global TyVar
set.

We do this by splitting out the Ids with open types, using 'is_closed'
to do the partition.  The top-level things go in the global TypeEnv;
the open, NotTopLevel, Ids, with free RuntimeUnk tyvars, go in the
local TypeEnv.

Note that we don't extend the local RdrEnv (tcl_rdr); all the in-scope
things are already in the interactive context's GlobalRdrEnv.
Extending the local RdrEnv isn't terrible, but it means there is an
entry for the same Name in both global and local RdrEnvs, and that
lead to duplicate &quot;perhaps you meant...&quot; suggestions (e.g. T5564).

We don't bother with the tcl_th_bndrs environment either.
-}</span><span>
</span><a name="line-1945"></a><span>
</span><a name="line-1946"></a><span class="hs-comment">-- | The returned [Id] is the list of new Ids bound by this statement. It can</span><span>
</span><a name="line-1947"></a><span class="hs-comment">-- be used to extend the InteractiveContext via extendInteractiveContext.</span><span>
</span><a name="line-1948"></a><span class="hs-comment">--</span><span>
</span><a name="line-1949"></a><span class="hs-comment">-- The returned TypecheckedHsExpr is of type IO [ () ], a list of the bound</span><span>
</span><a name="line-1950"></a><span class="hs-comment">-- values, coerced to ().</span><span>
</span><a name="line-1951"></a><span class="hs-identifier">tcRnStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">GhciLStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-1952"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FixityEnv</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1953"></a><a name="tcRnStmt"><a href="TcRnDriver.html#tcRnStmt"><span class="hs-identifier">tcRnStmt</span></a></a><span> </span><a name="local-6989586621683873035"><a href="#local-6989586621683873035"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873036"><a href="#local-6989586621683873036"><span class="hs-identifier">rdr_stmt</span></a></a><span>
</span><a name="line-1954"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873035"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1955"></a><span>
</span><a name="line-1956"></a><span>    </span><span class="hs-comment">-- The real work is done here</span><span>
</span><a name="line-1957"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683873039"><a href="#local-6989586621683873039"><span class="hs-identifier">bound_ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873040"><a href="#local-6989586621683873040"><span class="hs-identifier">tc_expr</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873041"><a href="#local-6989586621683873041"><span class="hs-identifier">fix_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#tcUserStmt"><span class="hs-identifier hs-var">tcUserStmt</span></a><span> </span><a href="#local-6989586621683873036"><span class="hs-identifier hs-var">rdr_stmt</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1958"></a><span>    </span><a name="local-6989586621683873042"><a href="#local-6989586621683873042"><span class="hs-identifier">zonked_expr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTopLExpr"><span class="hs-identifier hs-var">zonkTopLExpr</span></a><span> </span><a href="#local-6989586621683873040"><span class="hs-identifier hs-var">tc_expr</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1959"></a><span>    </span><a name="local-6989586621683873043"><a href="#local-6989586621683873043"><span class="hs-identifier">zonked_ids</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTopBndrs"><span class="hs-identifier hs-var">zonkTopBndrs</span></a><span> </span><a href="#local-6989586621683873039"><span class="hs-identifier hs-var">bound_ids</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1960"></a><span>
</span><a name="line-1961"></a><span>    </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span> </span><span class="hs-special">;</span><span>  </span><span class="hs-comment">-- we can't do the next step if there are levity polymorphism errors</span><span>
</span><a name="line-1962"></a><span>                   </span><span class="hs-comment">-- test case: ghci/scripts/T13202{,a}</span><span>
</span><a name="line-1963"></a><span>
</span><a name="line-1964"></a><span>        </span><span class="hs-comment">-- None of the Ids should be of unboxed type, because we</span><span>
</span><a name="line-1965"></a><span>        </span><span class="hs-comment">-- cast them all to HValues in the end!</span><span>
</span><a name="line-1966"></a><span>    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621683873037"><span class="hs-identifier hs-var">bad_unboxed</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnliftedType</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">idType</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873043"><span class="hs-identifier hs-var">zonked_ids</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1967"></a><span>
</span><a name="line-1968"></a><span>    </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcs 1&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1969"></a><span>    </span><a name="local-6989586621683873044"><a href="#local-6989586621683873044"><span class="hs-identifier">this_mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getModule</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1970"></a><span>    </span><a name="local-6989586621683873045"><a href="#local-6989586621683873045"><span class="hs-identifier">global_ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#externaliseAndTidyId"><span class="hs-identifier hs-var">externaliseAndTidyId</span></a><span> </span><a href="#local-6989586621683873044"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873043"><span class="hs-identifier hs-var">zonked_ids</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1971"></a><span>        </span><span class="hs-comment">-- Note [Interactively-bound Ids in GHCi] in HscTypes</span><span>
</span><a name="line-1972"></a><span>
</span><a name="line-1973"></a><span class="hs-comment">{- ---------------------------------------------
   At one stage I removed any shadowed bindings from the type_env;
   they are inaccessible but might, I suppose, cause a space leak if we leave them there.
   However, with Template Haskell they aren't necessarily inaccessible.  Consider this
   GHCi session
         Prelude&gt; let f n = n * 2 :: Int
         Prelude&gt; fName &lt;- runQ [| f |]
         Prelude&gt; $(return $ AppE fName (LitE (IntegerL 7)))
         14
         Prelude&gt; let f n = n * 3 :: Int
         Prelude&gt; $(return $ AppE fName (LitE (IntegerL 7)))
   In the last line we use 'fName', which resolves to the *first* 'f'
   in scope. If we delete it from the type env, GHCi crashes because
   it doesn't expect that.

   Hence this code is commented out

-------------------------------------------------- -}</span><span>
</span><a name="line-1991"></a><span>
</span><a name="line-1992"></a><span>    </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_tc</span><span>
</span><a name="line-1993"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Bound Ids&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprWithCommas</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873045"><span class="hs-identifier hs-var">global_ids</span></a><span class="hs-special">,</span><span>
</span><a name="line-1994"></a><span>               </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Typechecked expr&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873042"><span class="hs-identifier hs-var">zonked_expr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-1995"></a><span>
</span><a name="line-1996"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873045"><span class="hs-identifier hs-var">global_ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873042"><span class="hs-identifier hs-var">zonked_expr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873041"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1997"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1998"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1999"></a><span>    </span><a name="local-6989586621683873037"><a href="#local-6989586621683873037"><span class="hs-identifier">bad_unboxed</span></a></a><span> </span><a name="local-6989586621683873038"><a href="#local-6989586621683873038"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErr"><span class="hs-identifier hs-var">addErr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;GHCi can't bind a variable of unlifted type:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-2000"></a><span>                                  </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873038"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683873038"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2001"></a><span>
</span><a name="line-2002"></a><span class="hs-comment">{-
--------------------------------------------------------------------------
                Typechecking Stmts in GHCi

Here is the grand plan, implemented in tcUserStmt

        What you type                   The IO [HValue] that hscStmt returns
        -------------                   ------------------------------------
        let pat = expr          ==&gt;     let pat = expr in return [coerce HVal x, coerce HVal y, ...]
                                        bindings: [x,y,...]

        pat &lt;- expr             ==&gt;     expr &gt;&gt;= \ pat -&gt; return [coerce HVal x, coerce HVal y, ...]
                                        bindings: [x,y,...]

        expr (of IO type)       ==&gt;     expr &gt;&gt;= \ it -&gt; return [coerce HVal it]
          [NB: result not printed]      bindings: [it]

        expr (of non-IO type,   ==&gt;     let it = expr in print it &gt;&gt; return [coerce HVal it]
          result showable)              bindings: [it]

        expr (of non-IO type,
          result not showable)  ==&gt;     error
-}</span><span>
</span><a name="line-2025"></a><span>
</span><a name="line-2026"></a><span class="hs-comment">-- | A plan is an attempt to lift some code into the IO monad.</span><span>
</span><a name="line-2027"></a><span class="hs-keyword">type</span><span> </span><a name="PlanResult"><a href="TcRnDriver.html#PlanResult"><span class="hs-identifier">PlanResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Id</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">)</span><span>
</span><a name="line-2028"></a><span class="hs-keyword">type</span><span> </span><a name="Plan"><a href="TcRnDriver.html#Plan"><span class="hs-identifier">Plan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcRnDriver.html#PlanResult"><span class="hs-identifier hs-type">PlanResult</span></a><span>
</span><a name="line-2029"></a><span>
</span><a name="line-2030"></a><span class="hs-comment">-- | Try the plans in order. If one fails (by raising an exn), try the next.</span><span>
</span><a name="line-2031"></a><span class="hs-comment">-- If one succeeds, take it.</span><span>
</span><a name="line-2032"></a><span class="hs-identifier">runPlans</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcRnDriver.html#Plan"><span class="hs-identifier hs-type">Plan</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcRnDriver.html#PlanResult"><span class="hs-identifier hs-type">PlanResult</span></a><span>
</span><a name="line-2033"></a><a name="runPlans"><a href="TcRnDriver.html#runPlans"><span class="hs-identifier">runPlans</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;runPlans&quot;</span><span>
</span><a name="line-2034"></a><span class="hs-identifier">runPlans</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683873046"><a href="#local-6989586621683873046"><span class="hs-identifier">p</span></a></a><span class="hs-special">]</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873046"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-2035"></a><span class="hs-identifier">runPlans</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683873047"><a href="#local-6989586621683873047"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621683873048"><a href="#local-6989586621683873048"><span class="hs-identifier">ps</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#tryTcDiscardingErrs"><span class="hs-identifier hs-var">tryTcDiscardingErrs</span></a><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#runPlans"><span class="hs-identifier hs-var">runPlans</span></a><span> </span><a href="#local-6989586621683873048"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873047"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-2036"></a><span>
</span><a name="line-2037"></a><span class="hs-comment">-- | Typecheck (and 'lift') a stmt entered by the user in GHCi into the</span><span>
</span><a name="line-2038"></a><span class="hs-comment">-- GHCi 'environment'.</span><span>
</span><a name="line-2039"></a><span class="hs-comment">--</span><span>
</span><a name="line-2040"></a><span class="hs-comment">-- By 'lift' and 'environment we mean that the code is changed to</span><span>
</span><a name="line-2041"></a><span class="hs-comment">-- execute properly in an IO monad. See Note [Interactively-bound Ids</span><span>
</span><a name="line-2042"></a><span class="hs-comment">-- in GHCi] in HscTypes for more details. We do this lifting by trying</span><span>
</span><a name="line-2043"></a><span class="hs-comment">-- different ways ('plans') of lifting the code into the IO monad and</span><span>
</span><a name="line-2044"></a><span class="hs-comment">-- type checking each plan until one succeeds.</span><span>
</span><a name="line-2045"></a><span class="hs-identifier">tcUserStmt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GhciLStmt</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#PlanResult"><span class="hs-identifier hs-type">PlanResult</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FixityEnv</span><span class="hs-special">)</span><span>
</span><a name="line-2046"></a><span>
</span><a name="line-2047"></a><span class="hs-comment">-- An expression typed at the prompt is treated very specially</span><span>
</span><a name="line-2048"></a><a name="tcUserStmt"><a href="TcRnDriver.html#tcUserStmt"><span class="hs-identifier">tcUserStmt</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683873049"><a href="#local-6989586621683873049"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621683873050"><a href="#local-6989586621683873050"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2049"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683873051"><a href="#local-6989586621683873051"><span class="hs-identifier">rn_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873052"><a href="#local-6989586621683873052"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621683873050"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2050"></a><span>               </span><span class="hs-comment">-- Don't try to typecheck if the renamer fails!</span><span>
</span><a name="line-2051"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873053"><a href="#local-6989586621683873053"><span class="hs-identifier">ghciStep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#getGhciStepIO"><span class="hs-identifier hs-var">getGhciStepIO</span></a><span>
</span><a name="line-2052"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873054"><a href="#local-6989586621683873054"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span>
</span><a name="line-2053"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873055"><a href="#local-6989586621683873055"><span class="hs-identifier">interPrintName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getInteractivePrintName"><span class="hs-identifier hs-var">getInteractivePrintName</span></a><span>
</span><a name="line-2054"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873056"><a href="#local-6989586621683873056"><span class="hs-identifier">fresh_it</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">itName</span><span> </span><a href="#local-6989586621683873054"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-2055"></a><span>              </span><a name="local-6989586621683873057"><a href="#local-6989586621683873057"><span class="hs-identifier">matches</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">mkMatch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkPrefixFunRhs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683873056"><span class="hs-identifier hs-var">fresh_it</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621683873051"><span class="hs-identifier hs-var">rn_expr</span></a><span>
</span><a name="line-2056"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-identifier hs-var">emptyLocalBinds</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2057"></a><span>              </span><span class="hs-comment">-- [it = expr]</span><span>
</span><a name="line-2058"></a><span>              </span><a name="local-6989586621683873058"><a href="#local-6989586621683873058"><span class="hs-identifier">the_bind</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTopFunBind</span><span> </span><span class="hs-identifier hs-var">FromSource</span><span>
</span><a name="line-2059"></a><span>                                     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683873056"><span class="hs-identifier hs-var">fresh_it</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873057"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">)</span><span>
</span><a name="line-2060"></a><span>                                         </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fun_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873052"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2061"></a><span>              </span><span class="hs-comment">-- Care here!  In GHCi the expression might have</span><span>
</span><a name="line-2062"></a><span>              </span><span class="hs-comment">-- free variables, and they in turn may have free type variables</span><span>
</span><a name="line-2063"></a><span>              </span><span class="hs-comment">-- (if we are at a breakpoint, say).  We must put those free vars</span><span>
</span><a name="line-2064"></a><span>
</span><a name="line-2065"></a><span>              </span><span class="hs-comment">-- [let it = expr]</span><span>
</span><a name="line-2066"></a><span>              </span><a name="local-6989586621683873059"><a href="#local-6989586621683873059"><span class="hs-identifier">let_stmt</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">LetStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsValBinds</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2067"></a><span>                           </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">XValBindsLR</span><span>
</span><a name="line-2068"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NValBinds</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-var">NonRecursive</span><span class="hs-special">,</span><span class="hs-identifier hs-var">unitBag</span><span> </span><a href="#local-6989586621683873058"><span class="hs-identifier hs-var">the_bind</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2069"></a><span>
</span><a name="line-2070"></a><span>              </span><span class="hs-comment">-- [it &lt;- e]</span><span>
</span><a name="line-2071"></a><span>              </span><a name="local-6989586621683873060"><a href="#local-6989586621683873060"><span class="hs-identifier">bind_stmt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BindStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2072"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarPat</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621683873056"><span class="hs-identifier hs-var">fresh_it</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2073"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><a href="#local-6989586621683873053"><span class="hs-identifier hs-var">ghciStep</span></a><span> </span><a href="#local-6989586621683873051"><span class="hs-identifier hs-var">rn_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2074"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><span class="hs-identifier hs-var">bindIOName</span><span class="hs-special">)</span><span>
</span><a name="line-2075"></a><span>                                       </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-2076"></a><span>
</span><a name="line-2077"></a><span>              </span><span class="hs-comment">-- [; print it]</span><span>
</span><a name="line-2078"></a><span>              </span><a name="local-6989586621683873061"><a href="#local-6989586621683873061"><span class="hs-identifier">print_it</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2079"></a><span>                                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683873055"><span class="hs-identifier hs-var">interPrintName</span></a><span class="hs-special">)</span><span>
</span><a name="line-2080"></a><span>                                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683873056"><span class="hs-identifier hs-var">fresh_it</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2081"></a><span>                                           </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><span class="hs-identifier hs-var">thenIOName</span><span class="hs-special">)</span><span>
</span><a name="line-2082"></a><span>                                                  </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-2083"></a><span>
</span><a name="line-2084"></a><span>              </span><span class="hs-comment">-- NewA</span><span>
</span><a name="line-2085"></a><span>              </span><a name="local-6989586621683873062"><a href="#local-6989586621683873062"><span class="hs-identifier">no_it_a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsApps</span><span> </span><span class="hs-identifier hs-var">bindIOName</span><span>
</span><a name="line-2086"></a><span>                                       </span><span class="hs-special">[</span><a href="#local-6989586621683873051"><span class="hs-identifier hs-var">rn_expr</span></a><span> </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683873055"><span class="hs-identifier hs-var">interPrintName</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2087"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><span class="hs-identifier hs-var">thenIOName</span><span class="hs-special">)</span><span>
</span><a name="line-2088"></a><span>                                       </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-2089"></a><span>
</span><a name="line-2090"></a><span>              </span><a name="local-6989586621683873063"><a href="#local-6989586621683873063"><span class="hs-identifier">no_it_b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873051"><span class="hs-identifier hs-var">rn_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2091"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><span class="hs-identifier hs-var">thenIOName</span><span class="hs-special">)</span><span>
</span><a name="line-2092"></a><span>                                       </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-2093"></a><span>
</span><a name="line-2094"></a><span>              </span><a name="local-6989586621683873064"><a href="#local-6989586621683873064"><span class="hs-identifier">no_it_c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873049"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2095"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683873055"><span class="hs-identifier hs-var">interPrintName</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873051"><span class="hs-identifier hs-var">rn_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2096"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><span class="hs-identifier hs-var">thenIOName</span><span class="hs-special">)</span><span>
</span><a name="line-2097"></a><span>                                      </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-2098"></a><span>
</span><a name="line-2099"></a><span>              </span><span class="hs-comment">-- See Note [GHCi Plans]</span><span>
</span><a name="line-2100"></a><span>
</span><a name="line-2101"></a><span>              </span><a name="local-6989586621683873065"><a href="#local-6989586621683873065"><span class="hs-identifier">it_plans</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-2102"></a><span>                    </span><span class="hs-comment">-- Plan A</span><span>
</span><a name="line-2103"></a><span>                    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873067"><a href="#local-6989586621683873067"><span class="hs-identifier">stuff</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621683873068"><a href="#local-6989586621683873068"><span class="hs-identifier">it_id</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873060"><span class="hs-identifier hs-var">bind_stmt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873061"><span class="hs-identifier hs-var">print_it</span></a><span class="hs-special">]</span><span>
</span><a name="line-2104"></a><span>                       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873069"><a href="#local-6989586621683873069"><span class="hs-identifier">it_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683873068"><span class="hs-identifier hs-var">it_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-2105"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnitTy</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621683873069"><span class="hs-identifier hs-var">it_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-2106"></a><span>                       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873067"><span class="hs-identifier hs-var">stuff</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-2107"></a><span>
</span><a name="line-2108"></a><span>                        </span><span class="hs-comment">-- Plan B; a naked bind statement</span><span>
</span><a name="line-2109"></a><span>                    </span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873060"><span class="hs-identifier hs-var">bind_stmt</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-2110"></a><span>
</span><a name="line-2111"></a><span>                        </span><span class="hs-comment">-- Plan C; check that the let-binding is typeable all by itself.</span><span>
</span><a name="line-2112"></a><span>                        </span><span class="hs-comment">-- If not, fail; if so, try to print it.</span><span>
</span><a name="line-2113"></a><span>                        </span><span class="hs-comment">-- The two-step process avoids getting two errors: one from</span><span>
</span><a name="line-2114"></a><span>                        </span><span class="hs-comment">-- the expression itself, and one from the 'print it' part</span><span>
</span><a name="line-2115"></a><span>                        </span><span class="hs-comment">-- This two-step story is very clunky, alas</span><span>
</span><a name="line-2116"></a><span>                    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873059"><span class="hs-identifier hs-var">let_stmt</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2117"></a><span>                                </span><span class="hs-comment">--- checkNoErrs defeats the error recovery of let-bindings</span><span>
</span><a name="line-2118"></a><span>                       </span><span class="hs-special">;</span><span> </span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873059"><span class="hs-identifier hs-var">let_stmt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873061"><span class="hs-identifier hs-var">print_it</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2119"></a><span>
</span><a name="line-2120"></a><span>              </span><span class="hs-comment">-- Plans where we don't bind &quot;it&quot;</span><span>
</span><a name="line-2121"></a><span>              </span><a name="local-6989586621683873066"><a href="#local-6989586621683873066"><span class="hs-identifier">no_it_plans</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span>
</span><a name="line-2122"></a><span>                    </span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873062"><span class="hs-identifier hs-var">no_it_a</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">,</span><span>
</span><a name="line-2123"></a><span>                    </span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873063"><span class="hs-identifier hs-var">no_it_b</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">,</span><span>
</span><a name="line-2124"></a><span>                    </span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873064"><span class="hs-identifier hs-var">no_it_c</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2125"></a><span>
</span><a name="line-2126"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873070"><a href="#local-6989586621683873070"><span class="hs-identifier">generate_it</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_NoIt</span><span>
</span><a name="line-2127"></a><span>
</span><a name="line-2128"></a><span>        </span><span class="hs-comment">-- We disable `-fdefer-type-errors` in GHCi for naked expressions.</span><span>
</span><a name="line-2129"></a><span>        </span><span class="hs-comment">-- See Note [Deferred type errors in GHCi]</span><span>
</span><a name="line-2130"></a><span>
</span><a name="line-2131"></a><span>        </span><span class="hs-comment">-- NB: The flag `-fdefer-type-errors` implies `-fdefer-type-holes`</span><span>
</span><a name="line-2132"></a><span>        </span><span class="hs-comment">-- and `-fdefer-out-of-scope-variables`. However the flag</span><span>
</span><a name="line-2133"></a><span>        </span><span class="hs-comment">-- `-fno-defer-type-errors` doesn't imply `-fdefer-type-holes` and</span><span>
</span><a name="line-2134"></a><span>        </span><span class="hs-comment">-- `-fno-defer-out-of-scope-variables`. Thus the later two flags</span><span>
</span><a name="line-2135"></a><span>        </span><span class="hs-comment">-- also need to be unset here.</span><span>
</span><a name="line-2136"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873071"><a href="#local-6989586621683873071"><span class="hs-identifier">plan</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#unsetGOptM"><span class="hs-identifier hs-var">unsetGOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_DeferTypeErrors</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2137"></a><span>                  </span><a href="TcRnMonad.html#unsetGOptM"><span class="hs-identifier hs-var">unsetGOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_DeferTypedHoles</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2138"></a><span>                  </span><a href="TcRnMonad.html#unsetGOptM"><span class="hs-identifier hs-var">unsetGOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_DeferOutOfScopeVariables</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2139"></a><span>                    </span><a href="TcRnDriver.html#runPlans"><span class="hs-identifier hs-var">runPlans</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683873070"><span class="hs-identifier hs-var">generate_it</span></a><span>
</span><a name="line-2140"></a><span>                                 </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621683873066"><span class="hs-identifier hs-var">no_it_plans</span></a><span>
</span><a name="line-2141"></a><span>                                 </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621683873065"><span class="hs-identifier hs-var">it_plans</span></a><span>
</span><a name="line-2142"></a><span>
</span><a name="line-2143"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873072"><a href="#local-6989586621683873072"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier hs-var">getFixityEnv</span></a><span>
</span><a name="line-2144"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873071"><span class="hs-identifier hs-var">plan</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873072"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2145"></a><span>
</span><a name="line-2146"></a><span class="hs-comment">{- Note [Deferred type errors in GHCi]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In GHCi, we ensure that type errors don't get deferred when type checking the
naked expressions. Deferring type errors here is unhelpful because the
expression gets evaluated right away anyway. It also would potentially emit
two redundant type-error warnings, one from each plan.

Trac #14963 reveals another bug that when deferred type errors is enabled
in GHCi, any reference of imported/loaded variables (directly or indirectly)
in interactively issued naked expressions will cause ghc panic. See more
detailed dicussion in Trac #14963.

The interactively issued declarations, statements, as well as the modules
loaded into GHCi, are not affected. That means, for declaration, you could
have

    Prelude&gt; :set -fdefer-type-errors
    Prelude&gt; x :: IO (); x = putStrLn True
    &lt;interactive&gt;:14:26: warning: [-Wdeferred-type-errors]
        ? Couldn't match type &#8216;Bool&#8217; with &#8216;[Char]&#8217;
          Expected type: String
            Actual type: Bool
        ? In the first argument of &#8216;putStrLn&#8217;, namely &#8216;True&#8217;
          In the expression: putStrLn True
          In an equation for &#8216;x&#8217;: x = putStrLn True

But for naked expressions, you will have

    Prelude&gt; :set -fdefer-type-errors
    Prelude&gt; putStrLn True
    &lt;interactive&gt;:2:10: error:
        ? Couldn't match type &#8216;Bool&#8217; with &#8216;[Char]&#8217;
          Expected type: String
            Actual type: Bool
        ? In the first argument of &#8216;putStrLn&#8217;, namely &#8216;True&#8217;
          In the expression: putStrLn True
          In an equation for &#8216;it&#8217;: it = putStrLn True

    Prelude&gt; let x = putStrLn True
    &lt;interactive&gt;:2:18: warning: [-Wdeferred-type-errors]
        ? Couldn't match type &#8216;Bool&#8217; with &#8216;[Char]&#8217;
          Expected type: String
            Actual type: Bool
        ? In the first argument of &#8216;putStrLn&#8217;, namely &#8216;True&#8217;
          In the expression: putStrLn True
          In an equation for &#8216;x&#8217;: x = putStrLn True
-}</span><span>
</span><a name="line-2193"></a><span>
</span><a name="line-2194"></a><span class="hs-identifier">tcUserStmt</span><span> </span><a name="local-6989586621683873073"><a href="#local-6989586621683873073"><span class="hs-identifier">rdr_stmt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683873074"><a href="#local-6989586621683873074"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-2195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621683873083"><a href="#local-6989586621683873083"><span class="hs-identifier">rn_stmt</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873084"><a href="#local-6989586621683873084"><span class="hs-identifier">fix_env</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873085"><a href="#local-6989586621683873085"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2196"></a><span>           </span><a href="RnExpr.html#rnStmts"><span class="hs-identifier hs-var">rnStmts</span></a><span> </span><span class="hs-identifier hs-var">GhciStmtCtxt</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873073"><span class="hs-identifier hs-var">rdr_stmt</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2197"></a><span>             </span><a name="local-6989586621683873082"><a href="#local-6989586621683873082"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier hs-var">getFixityEnv</span></a><span>
</span><a name="line-2198"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873082"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">emptyFVs</span><span class="hs-special">)</span><span>
</span><a name="line-2199"></a><span>            </span><span class="hs-comment">-- Don't try to typecheck if the renamer fails!</span><span>
</span><a name="line-2200"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceRn"><span class="hs-identifier hs-var">traceRn</span></a><span> </span><span class="hs-string">&quot;tcRnStmt&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873073"><span class="hs-identifier hs-var">rdr_stmt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873083"><span class="hs-identifier hs-var">rn_stmt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873085"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2201"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnDriver.html#rnDump"><span class="hs-identifier hs-var">rnDump</span></a><span> </span><a href="#local-6989586621683873083"><span class="hs-identifier hs-var">rn_stmt</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2202"></a><span>
</span><a name="line-2203"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873086"><a href="#local-6989586621683873086"><span class="hs-identifier">ghciStep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#getGhciStepIO"><span class="hs-identifier hs-var">getGhciStepIO</span></a><span>
</span><a name="line-2204"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873087"><a href="#local-6989586621683873087"><span class="hs-identifier">gi_stmt</span></a></a><span>
</span><a name="line-2205"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683873088"><a href="#local-6989586621683873088"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BindStmt</span><span> </span><a name="local-6989586621683873089"><a href="#local-6989586621683873089"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621683873090"><a href="#local-6989586621683873090"><span class="hs-identifier">pat</span></a></a><span> </span><a name="local-6989586621683873091"><a href="#local-6989586621683873091"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621683873092"><a href="#local-6989586621683873092"><span class="hs-identifier">op1</span></a></a><span> </span><a name="local-6989586621683873093"><a href="#local-6989586621683873093"><span class="hs-identifier">op2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683873083"><span class="hs-identifier hs-var">rn_stmt</span></a><span>
</span><a name="line-2206"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873088"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BindStmt</span><span> </span><a href="#local-6989586621683873089"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621683873090"><span class="hs-identifier hs-var">pat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><a href="#local-6989586621683873086"><span class="hs-identifier hs-var">ghciStep</span></a><span> </span><a href="#local-6989586621683873091"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873092"><span class="hs-identifier hs-var">op1</span></a><span> </span><a href="#local-6989586621683873093"><span class="hs-identifier hs-var">op2</span></a><span>
</span><a name="line-2207"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873083"><span class="hs-identifier hs-var">rn_stmt</span></a><span>
</span><a name="line-2208"></a><span>
</span><a name="line-2209"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873094"><a href="#local-6989586621683873094"><span class="hs-identifier">opt_pr_flag</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_PrintBindResult</span><span>
</span><a name="line-2210"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873095"><a href="#local-6989586621683873095"><span class="hs-identifier">print_result_plan</span></a></a><span>
</span><a name="line-2211"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683873094"><span class="hs-identifier hs-var">opt_pr_flag</span></a><span>                         </span><span class="hs-comment">-- The flag says &quot;print result&quot;</span><span>
</span><a name="line-2212"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683873096"><a href="#local-6989586621683873096"><span class="hs-identifier">v</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">collectLStmtBinders</span><span> </span><a href="#local-6989586621683873087"><span class="hs-identifier hs-var">gi_stmt</span></a><span>  </span><span class="hs-comment">-- One binder</span><span>
</span><a name="line-2213"></a><span>                           </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">[</span><a href="#local-6989586621683873075"><span class="hs-identifier hs-var">mk_print_result_plan</span></a><span> </span><a href="#local-6989586621683873087"><span class="hs-identifier hs-var">gi_stmt</span></a><span> </span><a href="#local-6989586621683873096"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>
</span><a name="line-2214"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2215"></a><span>
</span><a name="line-2216"></a><span>        </span><span class="hs-comment">-- The plans are:</span><span>
</span><a name="line-2217"></a><span>        </span><span class="hs-comment">--      [stmt; print v]         if one binder and not v::()</span><span>
</span><a name="line-2218"></a><span>        </span><span class="hs-comment">--      [stmt]                  otherwise</span><span>
</span><a name="line-2219"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873097"><a href="#local-6989586621683873097"><span class="hs-identifier">plan</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#runPlans"><span class="hs-identifier hs-var">runPlans</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873095"><span class="hs-identifier hs-var">print_result_plan</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873087"><span class="hs-identifier hs-var">gi_stmt</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2220"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873097"><span class="hs-identifier hs-var">plan</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873084"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2221"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2222"></a><span>    </span><a name="local-6989586621683873075"><a href="#local-6989586621683873075"><span class="hs-identifier">mk_print_result_plan</span></a></a><span> </span><a name="local-6989586621683873076"><a href="#local-6989586621683873076"><span class="hs-identifier">stmt</span></a></a><span> </span><a name="local-6989586621683873077"><a href="#local-6989586621683873077"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-2223"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873079"><a href="#local-6989586621683873079"><span class="hs-identifier">stuff</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">[</span><a name="local-6989586621683873080"><a href="#local-6989586621683873080"><span class="hs-identifier">v_id</span></a></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier hs-var">tcGhciStmts</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873076"><span class="hs-identifier hs-var">stmt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873078"><span class="hs-identifier hs-var">print_v</span></a><span class="hs-special">]</span><span>
</span><a name="line-2224"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873081"><a href="#local-6989586621683873081"><span class="hs-identifier">v_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683873080"><span class="hs-identifier hs-var">v_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-2225"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isUnitTy</span><span> </span><a href="#local-6989586621683873081"><span class="hs-identifier hs-var">v_ty</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isTauTy</span><span> </span><a href="#local-6989586621683873081"><span class="hs-identifier hs-var">v_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-2226"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873079"><span class="hs-identifier hs-var">stuff</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2227"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2228"></a><span>        </span><a name="local-6989586621683873078"><a href="#local-6989586621683873078"><span class="hs-identifier">print_v</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">cL</span><span> </span><a href="#local-6989586621683873074"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BodyStmt</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">printName</span><span class="hs-special">)</span><span>
</span><a name="line-2229"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683873077"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2230"></a><span>                                    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkRnSyntaxExpr</span><span> </span><span class="hs-identifier hs-var">thenIOName</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">noSyntaxExpr</span><span>
</span><a name="line-2231"></a><span>
</span><a name="line-2232"></a><span class="hs-comment">{-
Note [GHCi Plans]
~~~~~~~~~~~~~~~~~
When a user types an expression in the repl we try to print it in three different
ways. Also, depending on whether -fno-it is set, we bind a variable called `it`
which can be used to refer to the result of the expression subsequently in the repl.

The normal plans are :
  A. [it &lt;- e; print e]     but not if it::()
  B. [it &lt;- e]
  C. [let it = e; print it]

When -fno-it is set, the plans are:
  A. [e &gt;&gt;= print]
  B. [e]
  C. [let it = e in print it]

The reason for -fno-it is explained in #14336. `it` can lead to the repl
leaking memory as it is repeatedly queried.
-}</span><span>
</span><a name="line-2252"></a><span>
</span><a name="line-2253"></a><span class="hs-comment">-- | Typecheck the statements given and then return the results of the</span><span>
</span><a name="line-2254"></a><span class="hs-comment">-- statement in the form 'IO [()]'.</span><span>
</span><a name="line-2255"></a><span class="hs-identifier">tcGhciStmts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">GhciLStmt</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="TcRnDriver.html#PlanResult"><span class="hs-identifier hs-type">PlanResult</span></a><span>
</span><a name="line-2256"></a><a name="tcGhciStmts"><a href="TcRnDriver.html#tcGhciStmts"><span class="hs-identifier">tcGhciStmts</span></a></a><span> </span><a name="local-6989586621683873098"><a href="#local-6989586621683873098"><span class="hs-identifier">stmts</span></a></a><span>
</span><a name="line-2257"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873099"><a href="#local-6989586621683873099"><span class="hs-identifier">ioTyCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><span class="hs-identifier hs-var">ioTyConName</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2258"></a><span>        </span><a name="local-6989586621683873100"><a href="#local-6989586621683873100"><span class="hs-identifier">ret_id</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><span class="hs-identifier hs-var">returnIOName</span><span> </span><span class="hs-special">;</span><span>            </span><span class="hs-comment">-- return @ IO</span><span>
</span><a name="line-2259"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-2260"></a><span>            </span><a name="local-6989586621683873101"><a href="#local-6989586621683873101"><span class="hs-identifier">ret_ty</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkListTy</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2261"></a><span>            </span><a name="local-6989586621683873102"><a href="#local-6989586621683873102"><span class="hs-identifier">io_ret_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683873099"><span class="hs-identifier hs-var">ioTyCon</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873101"><span class="hs-identifier hs-var">ret_ty</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2262"></a><span>            </span><a name="local-6989586621683873103"><a href="#local-6989586621683873103"><span class="hs-identifier">tc_io_stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcMatches.html#tcStmtsAndThen"><span class="hs-identifier hs-var">tcStmtsAndThen</span></a><span> </span><span class="hs-identifier hs-var">GhciStmtCtxt</span><span> </span><a href="TcMatches.html#tcDoStmt"><span class="hs-identifier hs-var">tcDoStmt</span></a><span> </span><a href="#local-6989586621683873098"><span class="hs-identifier hs-var">stmts</span></a><span>
</span><a name="line-2263"></a><span>                                         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkCheckExpType</span><span> </span><a href="#local-6989586621683873102"><span class="hs-identifier hs-var">io_ret_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2264"></a><span>            </span><a name="local-6989586621683873104"><a href="#local-6989586621683873104"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">collectLStmtsBinders</span><span> </span><a href="#local-6989586621683873098"><span class="hs-identifier hs-var">stmts</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2265"></a><span>         </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2266"></a><span>
</span><a name="line-2267"></a><span>        </span><span class="hs-comment">-- OK, we're ready to typecheck the stmts</span><span>
</span><a name="line-2268"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;TcRnDriver.tcGhciStmts: tc stmts&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2269"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683873105"><a href="#local-6989586621683873105"><span class="hs-identifier">tc_stmts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873106"><a href="#local-6989586621683873106"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873107"><a href="#local-6989586621683873107"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#captureTopConstraints"><span class="hs-identifier hs-var">captureTopConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2270"></a><span>                                  </span><a href="#local-6989586621683873103"><span class="hs-identifier hs-var">tc_io_stmts</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2271"></a><span>                                  </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="TcEnv.html#tcLookupId"><span class="hs-identifier hs-var">tcLookupId</span></a><span> </span><a href="#local-6989586621683873104"><span class="hs-identifier hs-var">names</span></a><span>  </span><span class="hs-special">;</span><span>
</span><a name="line-2272"></a><span>                        </span><span class="hs-comment">-- Look up the names right in the middle,</span><span>
</span><a name="line-2273"></a><span>                        </span><span class="hs-comment">-- where they will all be in scope</span><span>
</span><a name="line-2274"></a><span>
</span><a name="line-2275"></a><span>        </span><span class="hs-comment">-- Simplify the context</span><span>
</span><a name="line-2276"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;TcRnDriver.tcGhciStmts: simplify ctxt&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2277"></a><span>        </span><a name="local-6989586621683873108"><a href="#local-6989586621683873108"><span class="hs-identifier">const_binds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#simplifyInteractive"><span class="hs-identifier hs-var">simplifyInteractive</span></a><span> </span><a href="#local-6989586621683873107"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2278"></a><span>                </span><span class="hs-comment">-- checkNoErrs ensures that the plan fails if context redn fails</span><span>
</span><a name="line-2279"></a><span>
</span><a name="line-2280"></a><span>        </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;TcRnDriver.tcGhciStmts: done&quot;</span><span> </span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2281"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- mk_return builds the expression</span><span>
</span><a name="line-2282"></a><span>                </span><span class="hs-comment">--      returnIO @ [()] [coerce () x, ..,  coerce () z]</span><span>
</span><a name="line-2283"></a><span>                </span><span class="hs-comment">--</span><span>
</span><a name="line-2284"></a><span>                </span><span class="hs-comment">-- Despite the inconvenience of building the type applications etc,</span><span>
</span><a name="line-2285"></a><span>                </span><span class="hs-comment">-- this *has* to be done in type-annotated post-typecheck form</span><span>
</span><a name="line-2286"></a><span>                </span><span class="hs-comment">-- because we are going to return a list of *polymorphic* values</span><span>
</span><a name="line-2287"></a><span>                </span><span class="hs-comment">-- coerced to type (). If we built a *source* stmt</span><span>
</span><a name="line-2288"></a><span>                </span><span class="hs-comment">--      return [coerce x, ..., coerce z]</span><span>
</span><a name="line-2289"></a><span>                </span><span class="hs-comment">-- then the type checker would instantiate x..z, and we wouldn't</span><span>
</span><a name="line-2290"></a><span>                </span><span class="hs-comment">-- get their *polymorphic* values.  (And we'd get ambiguity errs</span><span>
</span><a name="line-2291"></a><span>                </span><span class="hs-comment">-- if they were overloaded, since they aren't applied to anything.)</span><span>
</span><a name="line-2292"></a><span>            </span><a name="local-6989586621683873109"><a href="#local-6989586621683873109"><span class="hs-identifier">ret_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsTyApp</span><span> </span><a href="#local-6989586621683873100"><span class="hs-identifier hs-var">ret_id</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873101"><span class="hs-identifier hs-var">ret_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2293"></a><span>                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ExplicitList</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2294"></a><span>                                                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683873110"><span class="hs-identifier hs-var">mk_item</span></a><span> </span><a href="#local-6989586621683873106"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2295"></a><span>            </span><a name="local-6989586621683873110"><a href="#local-6989586621683873110"><span class="hs-identifier">mk_item</span></a></a><span> </span><a name="local-6989586621683873112"><a href="#local-6989586621683873112"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873113"><a href="#local-6989586621683873113"><span class="hs-identifier">ty_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683873112"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unitTy</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-2296"></a><span>                         </span><span class="hs-identifier hs-var">nlHsApp</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsTyApp</span><span> </span><span class="hs-identifier hs-var">unsafeCoerceId</span><span>
</span><a name="line-2297"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">getRuntimeRep</span><span> </span><a href="#local-6989586621683873113"><span class="hs-identifier hs-var">ty_args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683873113"><span class="hs-identifier hs-var">ty_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2298"></a><span>                                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><a href="#local-6989586621683873112"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2299"></a><span>            </span><a name="local-6989586621683873111"><a href="#local-6989586621683873111"><span class="hs-identifier">stmts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873105"><span class="hs-identifier hs-var">tc_stmts</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLastStmt</span><span> </span><a href="#local-6989586621683873109"><span class="hs-identifier hs-var">ret_expr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2300"></a><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2301"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873106"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkHsDictLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">EvBinds</span><span> </span><a href="#local-6989586621683873108"><span class="hs-identifier hs-var">const_binds</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2302"></a><span>                     </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsDo</span><span> </span><a href="#local-6989586621683873102"><span class="hs-identifier hs-var">io_ret_ty</span></a><span> </span><span class="hs-identifier hs-var">GhciStmtCtxt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683873111"><span class="hs-identifier hs-var">stmts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2303"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-2304"></a><span>
</span><a name="line-2305"></a><span class="hs-comment">-- | Generate a typed ghciStepIO expression (ghciStep :: Ty a -&gt; IO a)</span><span>
</span><a name="line-2306"></a><span class="hs-identifier">getGhciStepIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-2307"></a><a name="getGhciStepIO"><a href="TcRnDriver.html#getGhciStepIO"><span class="hs-identifier">getGhciStepIO</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2308"></a><span>    </span><a name="local-6989586621683873114"><a href="#local-6989586621683873114"><span class="hs-identifier">ghciTy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGHCiMonad"><span class="hs-identifier hs-var">getGHCiMonad</span></a><span>
</span><a name="line-2309"></a><span>    </span><a name="local-6989586621683873115"><a href="#local-6989586621683873115"><span class="hs-identifier">a_tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newName"><span class="hs-identifier hs-var">newName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkTyVarOccFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fsLit</span><span> </span><span class="hs-string">&quot;a&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2310"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873116"><a href="#local-6989586621683873116"><span class="hs-identifier">ghciM</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsAppTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsTyVar</span><span> </span><a href="#local-6989586621683873114"><span class="hs-identifier hs-var">ghciTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsTyVar</span><span> </span><a href="#local-6989586621683873115"><span class="hs-identifier hs-var">a_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-2311"></a><span>        </span><a name="local-6989586621683873117"><a href="#local-6989586621683873117"><span class="hs-identifier">ioM</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsAppTy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsTyVar</span><span> </span><span class="hs-identifier hs-var">ioTyConName</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsTyVar</span><span> </span><a href="#local-6989586621683873115"><span class="hs-identifier hs-var">a_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-2312"></a><span>
</span><a name="line-2313"></a><span>        </span><a name="local-6989586621683873118"><a href="#local-6989586621683873118"><span class="hs-identifier">step_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">HsForAllTy</span><span>
</span><a name="line-2314"></a><span>                     </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hst_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">UserTyVar</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><a href="#local-6989586621683873115"><span class="hs-identifier hs-var">a_tv</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2315"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hst_xforall</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">noExt</span><span>
</span><a name="line-2316"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hst_body</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nlHsFunTy</span><span> </span><a href="#local-6989586621683873116"><span class="hs-identifier hs-var">ghciM</span></a><span> </span><a href="#local-6989586621683873117"><span class="hs-identifier hs-var">ioM</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2317"></a><span>
</span><a name="line-2318"></a><span>        </span><span class="hs-identifier">stepTy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LHsSigWcType</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-2319"></a><span>        </span><a name="local-6989586621683873119"><a href="#local-6989586621683873119"><span class="hs-identifier">stepTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkEmptyWildCardBndrs</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkEmptyImplicitBndrs</span><span> </span><a href="#local-6989586621683873118"><span class="hs-identifier hs-var">step_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2320"></a><span>
</span><a name="line-2321"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">noLoc</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ExprWithTySig</span><span> </span><span class="hs-identifier hs-var">noExt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nlHsVar</span><span> </span><span class="hs-identifier hs-var">ghciStepIoMName</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873119"><span class="hs-identifier hs-var">stepTy</span></a><span class="hs-special">)</span><span>
</span><a name="line-2322"></a><span>
</span><a name="line-2323"></a><span class="hs-identifier">isGHCiMonad</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Name</span><span class="hs-special">)</span><span>
</span><a name="line-2324"></a><a name="isGHCiMonad"><a href="TcRnDriver.html#isGHCiMonad"><span class="hs-identifier">isGHCiMonad</span></a></a><span> </span><a name="local-6989586621683873120"><a href="#local-6989586621683873120"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873121"><a href="#local-6989586621683873121"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-2325"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873120"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2326"></a><span>        </span><a name="local-6989586621683873122"><a href="#local-6989586621683873122"><span class="hs-identifier">rdrEnv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGlobalRdrEnv"><span class="hs-identifier hs-var">getGlobalRdrEnv</span></a><span>
</span><a name="line-2327"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873123"><a href="#local-6989586621683873123"><span class="hs-identifier">occIO</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupOccEnv</span><span> </span><a href="#local-6989586621683873122"><span class="hs-identifier hs-var">rdrEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkOccName</span><span> </span><span class="hs-identifier hs-var">tcName</span><span> </span><a href="#local-6989586621683873121"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2328"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683873123"><span class="hs-identifier hs-var">occIO</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2329"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><a name="local-6989586621683873124"><a href="#local-6989586621683873124"><span class="hs-identifier">n</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2330"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873125"><a href="#local-6989586621683873125"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683873124"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-2331"></a><span>                </span><a name="local-6989586621683873126"><a href="#local-6989586621683873126"><span class="hs-identifier">ghciClass</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupClass"><span class="hs-identifier hs-var">tcLookupClass</span></a><span> </span><span class="hs-identifier hs-var">ghciIoClassName</span><span>
</span><a name="line-2332"></a><span>                </span><a name="local-6989586621683873127"><a href="#local-6989586621683873127"><span class="hs-identifier">userTyCon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupTyCon"><span class="hs-identifier hs-var">tcLookupTyCon</span></a><span> </span><a href="#local-6989586621683873125"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2333"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873128"><a href="#local-6989586621683873128"><span class="hs-identifier">userTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkTyConApp</span><span> </span><a href="#local-6989586621683873127"><span class="hs-identifier hs-var">userTyCon</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2334"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookupInstance"><span class="hs-identifier hs-var">tcLookupInstance</span></a><span> </span><a href="#local-6989586621683873126"><span class="hs-identifier hs-var">ghciClass</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873128"><span class="hs-identifier hs-var">userTy</span></a><span class="hs-special">]</span><span>
</span><a name="line-2335"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873125"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2336"></a><span>
</span><a name="line-2337"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Ambiguous type!&quot;</span><span>
</span><a name="line-2338"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Can't find type:&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621683873121"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2339"></a><span>
</span><a name="line-2340"></a><span class="hs-comment">-- | How should we infer a type? See Note [TcRnExprMode]</span><span>
</span><a name="line-2341"></a><span class="hs-keyword">data</span><span> </span><a name="TcRnExprMode"><a href="TcRnDriver.html#TcRnExprMode"><span class="hs-identifier">TcRnExprMode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TM_Inst"><a href="TcRnDriver.html#TM_Inst"><span class="hs-identifier">TM_Inst</span></a></a><span>    </span><span class="hs-comment">-- ^ Instantiate the type fully (:type)</span><span>
</span><a name="line-2342"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a name="TM_NoInst"><a href="TcRnDriver.html#TM_NoInst"><span class="hs-identifier">TM_NoInst</span></a></a><span>  </span><span class="hs-comment">-- ^ Do not instantiate the type (:type +v)</span><span>
</span><a name="line-2343"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a name="TM_Default"><a href="TcRnDriver.html#TM_Default"><span class="hs-identifier">TM_Default</span></a></a><span> </span><span class="hs-comment">-- ^ Default the type eagerly (:type +d)</span><span>
</span><a name="line-2344"></a><span>
</span><a name="line-2345"></a><span class="hs-comment">-- | tcRnExpr just finds the type of an expression</span><span>
</span><a name="line-2346"></a><span class="hs-identifier">tcRnExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-2347"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnDriver.html#TcRnExprMode"><span class="hs-identifier hs-type">TcRnExprMode</span></a><span>
</span><a name="line-2348"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsExpr</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-2349"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Type</span><span class="hs-special">)</span><span>
</span><a name="line-2350"></a><a name="tcRnExpr"><a href="TcRnDriver.html#tcRnExpr"><span class="hs-identifier">tcRnExpr</span></a></a><span> </span><a name="local-6989586621683873129"><a href="#local-6989586621683873129"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873130"><a href="#local-6989586621683873130"><span class="hs-identifier">mode</span></a></a><span> </span><a name="local-6989586621683873131"><a href="#local-6989586621683873131"><span class="hs-identifier">rdr_expr</span></a></a><span>
</span><a name="line-2351"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873129"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2352"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-2353"></a><span>
</span><a name="line-2354"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683873135"><a href="#local-6989586621683873135"><span class="hs-identifier">rn_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873136"><a href="#local-6989586621683873136"><span class="hs-identifier">_fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnExpr.html#rnLExpr"><span class="hs-identifier hs-var">rnLExpr</span></a><span> </span><a href="#local-6989586621683873131"><span class="hs-identifier hs-var">rdr_expr</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2355"></a><span>    </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2356"></a><span>
</span><a name="line-2357"></a><span>        </span><span class="hs-comment">-- Now typecheck the expression, and generalise its type</span><span>
</span><a name="line-2358"></a><span>        </span><span class="hs-comment">-- it might have a rank-2 type (e.g. :t runST)</span><span>
</span><a name="line-2359"></a><span>    </span><a name="local-6989586621683873137"><a href="#local-6989586621683873137"><span class="hs-identifier">uniq</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newUnique"><span class="hs-identifier hs-var">newUnique</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2360"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873138"><a href="#local-6989586621683873138"><span class="hs-identifier">fresh_it</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">itName</span><span> </span><a href="#local-6989586621683873137"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getLoc</span><span> </span><a href="#local-6989586621683873131"><span class="hs-identifier hs-var">rdr_expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2361"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873139"><a href="#local-6989586621683873139"><span class="hs-identifier">orig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lexprCtOrigin</span><span> </span><a href="#local-6989586621683873135"><span class="hs-identifier hs-var">rn_expr</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2362"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683873142"><a href="#local-6989586621683873142"><span class="hs-identifier">tclvl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873143"><a href="#local-6989586621683873143"><span class="hs-identifier">lie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873144"><a href="#local-6989586621683873144"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2363"></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#pushLevelAndCaptureConstraints"><span class="hs-identifier hs-var">pushLevelAndCaptureConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2364"></a><span>             </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683873140"><a href="#local-6989586621683873140"><span class="hs-identifier">_tc_expr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873141"><a href="#local-6989586621683873141"><span class="hs-identifier">expr_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcExpr.html#tcInferSigma"><span class="hs-identifier hs-var">tcInferSigma</span></a><span> </span><a href="#local-6989586621683873135"><span class="hs-identifier hs-var">rn_expr</span></a><span>
</span><a name="line-2365"></a><span>                </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683873132"><span class="hs-identifier hs-var">inst</span></a><span>
</span><a name="line-2366"></a><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Inst.html#deeplyInstantiate"><span class="hs-identifier hs-var">deeplyInstantiate</span></a><span> </span><a href="#local-6989586621683873139"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="#local-6989586621683873141"><span class="hs-identifier hs-var">expr_ty</span></a><span>
</span><a name="line-2367"></a><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873141"><span class="hs-identifier hs-var">expr_ty</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2368"></a><span>
</span><a name="line-2369"></a><span>    </span><span class="hs-comment">-- Generalise</span><span>
</span><a name="line-2370"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683873145"><a href="#local-6989586621683873145"><span class="hs-identifier">qtvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873146"><a href="#local-6989586621683873146"><span class="hs-identifier">dicts</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873147"><a href="#local-6989586621683873147"><span class="hs-identifier">residual</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-2371"></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#simplifyInfer"><span class="hs-identifier hs-var">simplifyInfer</span></a><span> </span><a href="#local-6989586621683873142"><span class="hs-identifier hs-var">tclvl</span></a><span> </span><a href="#local-6989586621683873133"><span class="hs-identifier hs-var">infer_mode</span></a><span>
</span><a name="line-2372"></a><span>                          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">{- No sig vars -}</span><span>
</span><a name="line-2373"></a><span>                          </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621683873138"><span class="hs-identifier hs-var">fresh_it</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873144"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2374"></a><span>                          </span><a href="#local-6989586621683873143"><span class="hs-identifier hs-var">lie</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2375"></a><span>
</span><a name="line-2376"></a><span>    </span><span class="hs-comment">-- Ignore the dictionary bindings</span><span>
</span><a name="line-2377"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621683873134"><span class="hs-identifier hs-var">perhaps_disable_default_warnings</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2378"></a><span>         </span><a href="TcSimplify.html#simplifyInteractive"><span class="hs-identifier hs-var">simplifyInteractive</span></a><span> </span><a href="#local-6989586621683873147"><span class="hs-identifier hs-var">residual</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2379"></a><span>
</span><a name="line-2380"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873148"><a href="#local-6989586621683873148"><span class="hs-identifier">all_expr_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkInvForAllTys</span><span> </span><a href="#local-6989586621683873145"><span class="hs-identifier hs-var">qtvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkLamTypes</span><span> </span><a href="#local-6989586621683873146"><span class="hs-identifier hs-var">dicts</span></a><span> </span><a href="#local-6989586621683873144"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2381"></a><span>    </span><a name="local-6989586621683873149"><a href="#local-6989586621683873149"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683873148"><span class="hs-identifier hs-var">all_expr_ty</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2382"></a><span>
</span><a name="line-2383"></a><span>    </span><span class="hs-comment">-- We normalise type families, so that the type of an expression is the</span><span>
</span><a name="line-2384"></a><span>    </span><span class="hs-comment">-- same as of a bound expression (TcBinds.mkInferredPolyId). See Trac</span><span>
</span><a name="line-2385"></a><span>    </span><span class="hs-comment">-- #10321 for further discussion.</span><span>
</span><a name="line-2386"></a><span>    </span><a name="local-6989586621683873150"><a href="#local-6989586621683873150"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2387"></a><span>    </span><span class="hs-comment">-- normaliseType returns a coercion which we discard, so the Role is</span><span>
</span><a name="line-2388"></a><span>    </span><span class="hs-comment">-- irrelevant</span><span>
</span><a name="line-2389"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normaliseType</span><span> </span><a href="#local-6989586621683873150"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621683873149"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2390"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-2391"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2392"></a><span>    </span><span class="hs-comment">-- See Note [TcRnExprMode]</span><span>
</span><a name="line-2393"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621683873132"><a href="#local-6989586621683873132"><span class="hs-identifier">inst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873133"><a href="#local-6989586621683873133"><span class="hs-identifier">infer_mode</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873134"><a href="#local-6989586621683873134"><span class="hs-identifier">perhaps_disable_default_warnings</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683873130"><span class="hs-identifier hs-var">mode</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2394"></a><span>      </span><a href="TcRnDriver.html#TM_Inst"><span class="hs-identifier hs-var">TM_Inst</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>  </span><a href="TcSimplify.html#NoRestrictions"><span class="hs-identifier hs-var">NoRestrictions</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span>
</span><a name="line-2395"></a><span>      </span><a href="TcRnDriver.html#TM_NoInst"><span class="hs-identifier hs-var">TM_NoInst</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span> </span><a href="TcSimplify.html#NoRestrictions"><span class="hs-identifier hs-var">NoRestrictions</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span>
</span><a name="line-2396"></a><span>      </span><a href="TcRnDriver.html#TM_Default"><span class="hs-identifier hs-var">TM_Default</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>  </span><a href="TcSimplify.html#EagerDefaulting"><span class="hs-identifier hs-var">EagerDefaulting</span></a><span class="hs-special">,</span><span> </span><a href="TcRnMonad.html#unsetWOptM"><span class="hs-identifier hs-var">unsetWOptM</span></a><span> </span><span class="hs-identifier hs-var">Opt_WarnTypeDefaults</span><span class="hs-special">)</span><span>
</span><a name="line-2397"></a><span>
</span><a name="line-2398"></a><span class="hs-comment">--------------------------</span><span>
</span><a name="line-2399"></a><span class="hs-identifier">tcRnImportDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-2400"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-2401"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">GlobalRdrEnv</span><span class="hs-special">)</span><span>
</span><a name="line-2402"></a><span class="hs-comment">-- Find the new chunk of GlobalRdrEnv created by this list of import</span><span>
</span><a name="line-2403"></a><span class="hs-comment">-- decls.  In contract tcRnImports *extends* the TcGblEnv.</span><span>
</span><a name="line-2404"></a><a name="tcRnImportDecls"><a href="TcRnDriver.html#tcRnImportDecls"><span class="hs-identifier">tcRnImportDecls</span></a></a><span> </span><a name="local-6989586621683873151"><a href="#local-6989586621683873151"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873152"><a href="#local-6989586621683873152"><span class="hs-identifier">import_decls</span></a></a><span>
</span><a name="line-2405"></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873151"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2406"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873155"><a href="#local-6989586621683873155"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier hs-var">updGblEnv</span></a><span> </span><a href="#local-6989586621683873153"><span class="hs-identifier hs-var">zap_rdr_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2407"></a><span>                    </span><a href="TcRnDriver.html#tcRnImports"><span class="hs-identifier hs-var">tcRnImports</span></a><span> </span><a href="#local-6989586621683873151"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><a href="#local-6989586621683873152"><span class="hs-identifier hs-var">import_decls</span></a><span>
</span><a name="line-2408"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_rdr_env</span><span> </span><a href="#local-6989586621683873155"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2409"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2410"></a><span>    </span><a name="local-6989586621683873153"><a href="#local-6989586621683873153"><span class="hs-identifier">zap_rdr_env</span></a></a><span> </span><a name="local-6989586621683873154"><a href="#local-6989586621683873154"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873154"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_rdr_env</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyGlobalRdrEnv</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2411"></a><span>
</span><a name="line-2412"></a><span class="hs-comment">-- tcRnType just finds the kind of a type</span><span>
</span><a name="line-2413"></a><span class="hs-identifier">tcRnType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-2414"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>        </span><span class="hs-comment">-- Normalise the returned type</span><span>
</span><a name="line-2415"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">LHsType</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span>
</span><a name="line-2416"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Type</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Kind</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2417"></a><a name="tcRnType"><a href="TcRnDriver.html#tcRnType"><span class="hs-identifier">tcRnType</span></a></a><span> </span><a name="local-6989586621683873156"><a href="#local-6989586621683873156"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873157"><a href="#local-6989586621683873157"><span class="hs-identifier">normalise</span></a></a><span> </span><a name="local-6989586621683873158"><a href="#local-6989586621683873158"><span class="hs-identifier">rdr_type</span></a></a><span>
</span><a name="line-2418"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873156"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2419"></a><span>    </span><a href="TcRnMonad.html#setXOptM"><span class="hs-identifier hs-var">setXOptM</span></a><span> </span><span class="hs-identifier hs-var">LangExt.PolyKinds</span><span> </span><span class="hs-operator hs-var">$</span><span>   </span><span class="hs-comment">-- See Note [Kind-generalise in tcRnType]</span><span>
</span><a name="line-2420"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">HsWC</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hswc_ext</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873159"><a href="#local-6989586621683873159"><span class="hs-identifier">wcs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hswc_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873160"><a href="#local-6989586621683873160"><span class="hs-identifier">rn_type</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873161"><a href="#local-6989586621683873161"><span class="hs-identifier">_fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2421"></a><span>               </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnTypes.html#rnHsWcType"><span class="hs-identifier hs-var">rnHsWcType</span></a><span> </span><a href="RnUtils.html#GHCiCtx"><span class="hs-identifier hs-var">GHCiCtx</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkHsWildCardBndrs</span><span> </span><a href="#local-6989586621683873158"><span class="hs-identifier hs-var">rdr_type</span></a><span class="hs-special">)</span><span>
</span><a name="line-2422"></a><span>                  </span><span class="hs-comment">-- The type can have wild cards, but no implicit</span><span>
</span><a name="line-2423"></a><span>                  </span><span class="hs-comment">-- generalisation; e.g.   :kind (T _)</span><span>
</span><a name="line-2424"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#failIfErrsM"><span class="hs-identifier hs-var">failIfErrsM</span></a><span>
</span><a name="line-2425"></a><span>
</span><a name="line-2426"></a><span>        </span><span class="hs-comment">-- Now kind-check the type</span><span>
</span><a name="line-2427"></a><span>        </span><span class="hs-comment">-- It can have any rank or kind</span><span>
</span><a name="line-2428"></a><span>        </span><span class="hs-comment">-- First bring into scope any wildcards</span><span>
</span><a name="line-2429"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcRnType&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873159"><span class="hs-identifier hs-var">wcs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873160"><span class="hs-identifier hs-var">rn_type</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2430"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621683873163"><a href="#local-6989586621683873163"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873164"><a href="#local-6989586621683873164"><span class="hs-identifier">kind</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873165"><a href="#local-6989586621683873165"><span class="hs-identifier">lie</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-2431"></a><span>                       </span><a href="TcRnMonad.html#captureConstraints"><span class="hs-identifier hs-var">captureConstraints</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2432"></a><span>                       </span><a href="TcHsType.html#tcWildCardBinders"><span class="hs-identifier hs-var">tcWildCardBinders</span></a><span> </span><a href="#local-6989586621683873159"><span class="hs-identifier hs-var">wcs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621683873162"><a href="#local-6989586621683873162"><span class="hs-identifier">wcs'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2433"></a><span>                       </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#emitWildCardHoleConstraints"><span class="hs-identifier hs-var">emitWildCardHoleConstraints</span></a><span> </span><a href="#local-6989586621683873162"><span class="hs-identifier hs-var">wcs'</span></a><span>
</span><a name="line-2434"></a><span>                          </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#tcLHsTypeUnsaturated"><span class="hs-identifier hs-var">tcLHsTypeUnsaturated</span></a><span> </span><a href="#local-6989586621683873160"><span class="hs-identifier hs-var">rn_type</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2435"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><span class="hs-special">(</span><a href="TcSimplify.html#simplifyInteractive"><span class="hs-identifier hs-var">simplifyInteractive</span></a><span> </span><a href="#local-6989586621683873165"><span class="hs-identifier hs-var">lie</span></a><span class="hs-special">)</span><span>
</span><a name="line-2436"></a><span>
</span><a name="line-2437"></a><span>       </span><span class="hs-comment">-- Do kind generalisation; see Note [Kind-generalise in tcRnType]</span><span>
</span><a name="line-2438"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873166"><a href="#local-6989586621683873166"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621683873164"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-2439"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873167"><a href="#local-6989586621683873167"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kindGeneralize"><span class="hs-identifier hs-var">kindGeneralize</span></a><span> </span><a href="#local-6989586621683873166"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-2440"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873168"><a href="#local-6989586621683873168"><span class="hs-identifier">ty</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToType"><span class="hs-identifier hs-var">zonkTcTypeToType</span></a><span> </span><a href="#local-6989586621683873163"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2441"></a><span>
</span><a name="line-2442"></a><span>       </span><span class="hs-comment">-- Do validity checking on type</span><span>
</span><a name="line-2443"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">GhciCtxt</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873168"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2444"></a><span>
</span><a name="line-2445"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873171"><a href="#local-6989586621683873171"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621683873157"><span class="hs-identifier hs-var">normalise</span></a><span>
</span><a name="line-2446"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873169"><a href="#local-6989586621683873169"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-2447"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621683873170"><a href="#local-6989586621683873170"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2448"></a><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">normaliseType</span><span> </span><a href="#local-6989586621683873169"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><span class="hs-identifier hs-var">Nominal</span><span> </span><a href="#local-6989586621683873168"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2449"></a><span>                        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873170"><span class="hs-identifier hs-var">ty'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2450"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873168"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2451"></a><span>
</span><a name="line-2452"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873171"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mkInvForAllTys</span><span> </span><a href="#local-6989586621683873167"><span class="hs-identifier hs-var">kvs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tcTypeKind</span><span> </span><a href="#local-6989586621683873171"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2453"></a><span>
</span><a name="line-2454"></a><span class="hs-comment">{- Note [TcRnExprMode]
~~~~~~~~~~~~~~~~~~~~~~
How should we infer a type when a user asks for the type of an expression e
at the GHCi prompt? We offer 3 different possibilities, described below. Each
considers this example, with -fprint-explicit-foralls enabled:

  foo :: forall a f b. (Show a, Num b, Foldable f) =&gt; a -&gt; f b -&gt; String
  :type{,-spec,-def} foo @Int

:type / TM_Inst

  In this mode, we report the type that would be inferred if a variable
  were assigned to expression e, without applying the monomorphism restriction.
  This means we deeply instantiate the type and then regeneralize, as discussed
  in #11376.

  &gt; :type foo @Int
  forall {b} {f :: * -&gt; *}. (Foldable f, Num b) =&gt; Int -&gt; f b -&gt; String

  Note that the variables and constraints are reordered here, because this
  is possible during regeneralization. Also note that the variables are
  reported as Inferred instead of Specified.

:type +v / TM_NoInst

  This mode is for the benefit of users using TypeApplications. It does no
  instantiation whatsoever, sometimes meaning that class constraints are not
  solved.

  &gt; :type +v foo @Int
  forall f b. (Show Int, Num b, Foldable f) =&gt; Int -&gt; f b -&gt; String

  Note that Show Int is still reported, because the solver never got a chance
  to see it.

:type +d / TM_Default

  This mode is for the benefit of users who wish to see instantiations of
  generalized types, and in particular to instantiate Foldable and Traversable.
  In this mode, any type variable that can be defaulted is defaulted. Because
  GHCi uses -XExtendedDefaultRules, this means that Foldable and Traversable are
  defaulted.

  &gt; :type +d foo @Int
  Int -&gt; [Integer] -&gt; String

  Note that this mode can sometimes lead to a type error, if a type variable is
  used with a defaultable class but cannot actually be defaulted:

  bar :: (Num a, Monoid a) =&gt; a -&gt; a
  &gt; :type +d bar
  ** error **

  The error arises because GHC tries to default a but cannot find a concrete
  type in the defaulting list that is both Num and Monoid. (If this list is
  modified to include an element that is both Num and Monoid, the defaulting
  would succeed, of course.)

Note [Kind-generalise in tcRnType]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We switch on PolyKinds when kind-checking a user type, so that we will
kind-generalise the type, even when PolyKinds is not otherwise on.
This gives the right default behaviour at the GHCi prompt, where if
you say &quot;:k T&quot;, and T has a polymorphic kind, you'd like to see that
polymorphism. Of course.  If T isn't kind-polymorphic you won't get
anything unexpected, but the apparent *loss* of polymorphism, for
types that you know are polymorphic, is quite surprising.  See Trac
#7688 for a discussion.

Note that the goal is to generalise the *kind of the type*, not
the type itself! Example:
  ghci&gt; data SameKind :: k -&gt; k -&gt; Type
  ghci&gt; :k SameKind _

We want to get `k -&gt; Type`, not `Any -&gt; Type`, which is what we would
get without kind-generalisation. Note that `:k SameKind` is OK, as
GHC will not instantiate SameKind here, and so we see its full kind
of `forall k. k -&gt; k -&gt; Type`.

************************************************************************
*                                                                      *
                 tcRnDeclsi
*                                                                      *
************************************************************************

tcRnDeclsi exists to allow class, data, and other declarations in GHCi.
-}</span><span>
</span><a name="line-2541"></a><span>
</span><a name="line-2542"></a><span class="hs-identifier">tcRnDeclsi</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-2543"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LHsDecl</span><span> </span><span class="hs-identifier hs-type">GhcPs</span><span class="hs-special">]</span><span>
</span><a name="line-2544"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">)</span><span>
</span><a name="line-2545"></a><a name="tcRnDeclsi"><a href="TcRnDriver.html#tcRnDeclsi"><span class="hs-identifier">tcRnDeclsi</span></a></a><span> </span><a name="local-6989586621683873172"><a href="#local-6989586621683873172"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873173"><a href="#local-6989586621683873173"><span class="hs-identifier">local_decls</span></a></a><span>
</span><a name="line-2546"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873172"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2547"></a><span>    </span><a href="TcRnDriver.html#tcRnSrcDecls"><span class="hs-identifier hs-var">tcRnSrcDecls</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621683873173"><span class="hs-identifier hs-var">local_decls</span></a><span>
</span><a name="line-2548"></a><span>
</span><a name="line-2549"></a><span class="hs-identifier">externaliseAndTidyId</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Id</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">Id</span><span>
</span><a name="line-2550"></a><a name="externaliseAndTidyId"><a href="TcRnDriver.html#externaliseAndTidyId"><span class="hs-identifier">externaliseAndTidyId</span></a></a><span> </span><a name="local-6989586621683873174"><a href="#local-6989586621683873174"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621683873175"><a href="#local-6989586621683873175"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-2551"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873176"><a href="#local-6989586621683873176"><span class="hs-identifier">name'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IfaceEnv.html#externaliseName"><span class="hs-identifier hs-var">externaliseName</span></a><span> </span><a href="#local-6989586621683873174"><span class="hs-identifier hs-var">this_mod</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idName</span><span> </span><a href="#local-6989586621683873175"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-2552"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="TidyPgm.html#globaliseAndTidyId"><span class="hs-identifier hs-var">globaliseAndTidyId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">setIdName</span><span> </span><a href="#local-6989586621683873175"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621683873176"><span class="hs-identifier hs-var">name'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2553"></a><span>
</span><a name="line-2554"></a><span>
</span><a name="line-2555"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        More GHCi stuff, to do with browsing and getting info
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2562"></a><span>
</span><a name="line-2563"></a><span class="hs-comment">-- | ASSUMES that the module is either in the 'HomePackageTable' or is</span><span>
</span><a name="line-2564"></a><span class="hs-comment">-- a package module with an interface on disk.  If neither of these is</span><span>
</span><a name="line-2565"></a><span class="hs-comment">-- true, then the result will be an error indicating the interface</span><span>
</span><a name="line-2566"></a><span class="hs-comment">-- could not be found.</span><span>
</span><a name="line-2567"></a><span class="hs-identifier">getModuleInterface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Module</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">ModIface</span><span class="hs-special">)</span><span>
</span><a name="line-2568"></a><a name="getModuleInterface"><a href="TcRnDriver.html#getModuleInterface"><span class="hs-identifier">getModuleInterface</span></a></a><span> </span><a name="local-6989586621683873177"><a href="#local-6989586621683873177"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873178"><a href="#local-6989586621683873178"><span class="hs-identifier">mod</span></a></a><span>
</span><a name="line-2569"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873177"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2570"></a><span>    </span><a href="LoadIface.html#loadModuleInterface"><span class="hs-identifier hs-var">loadModuleInterface</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;getModuleInterface&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873178"><span class="hs-identifier hs-var">mod</span></a><span>
</span><a name="line-2571"></a><span>
</span><a name="line-2572"></a><span class="hs-identifier">tcRnLookupRdrName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Located</span><span> </span><span class="hs-identifier hs-type">RdrName</span><span>
</span><a name="line-2573"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Name</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2574"></a><span class="hs-comment">-- ^ Find all the Names that this RdrName could mean, in GHCi</span><span>
</span><a name="line-2575"></a><a name="tcRnLookupRdrName"><a href="TcRnDriver.html#tcRnLookupRdrName"><span class="hs-identifier">tcRnLookupRdrName</span></a></a><span> </span><a name="local-6989586621683873179"><a href="#local-6989586621683873179"><span class="hs-identifier">hsc_env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dL</span><span class="hs-glyph">-&gt;</span><span class="hs-identifier hs-var">L</span><span> </span><a name="local-6989586621683873180"><a href="#local-6989586621683873180"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621683873181"><a href="#local-6989586621683873181"><span class="hs-identifier">rdr_name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2576"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873179"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2577"></a><span>    </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621683873180"><span class="hs-identifier hs-var">loc</span></a><span>           </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2578"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- If the identifier is a constructor (begins with an</span><span>
</span><a name="line-2579"></a><span>           </span><span class="hs-comment">-- upper-case letter), then we need to consider both</span><span>
</span><a name="line-2580"></a><span>           </span><span class="hs-comment">-- constructor and type class identifiers.</span><span>
</span><a name="line-2581"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873182"><a href="#local-6989586621683873182"><span class="hs-identifier">rdr_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="RnEnv.html#dataTcOccs"><span class="hs-identifier hs-var">dataTcOccs</span></a><span> </span><a href="#local-6989586621683873181"><span class="hs-identifier hs-var">rdr_name</span></a><span>
</span><a name="line-2582"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873183"><a href="#local-6989586621683873183"><span class="hs-identifier">names_s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><a href="RnEnv.html#lookupInfoOccRn"><span class="hs-identifier hs-var">lookupInfoOccRn</span></a><span> </span><a href="#local-6989586621683873182"><span class="hs-identifier hs-var">rdr_names</span></a><span>
</span><a name="line-2583"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873184"><a href="#local-6989586621683873184"><span class="hs-identifier">names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><a href="#local-6989586621683873183"><span class="hs-identifier hs-var">names_s</span></a><span>
</span><a name="line-2584"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683873184"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Not in scope:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">quotes</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873181"><span class="hs-identifier hs-var">rdr_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2585"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873184"><span class="hs-identifier hs-var">names</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2586"></a><span>
</span><a name="line-2587"></a><span class="hs-identifier">tcRnLookupName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Messages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">)</span><span>
</span><a name="line-2588"></a><a name="tcRnLookupName"><a href="TcRnDriver.html#tcRnLookupName"><span class="hs-identifier">tcRnLookupName</span></a></a><span> </span><a name="local-6989586621683873185"><a href="#local-6989586621683873185"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873186"><a href="#local-6989586621683873186"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-2589"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873185"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2590"></a><span>    </span><a href="TcRnDriver.html#tcRnLookupName%27"><span class="hs-identifier hs-var">tcRnLookupName'</span></a><span> </span><a href="#local-6989586621683873186"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2591"></a><span>
</span><a name="line-2592"></a><span class="hs-comment">-- To look up a name we have to look in the local environment (tcl_lcl)</span><span>
</span><a name="line-2593"></a><span class="hs-comment">-- as well as the global environment, which is what tcLookup does.</span><span>
</span><a name="line-2594"></a><span class="hs-comment">-- But we also want a TyThing, so we have to convert:</span><span>
</span><a name="line-2595"></a><span>
</span><a name="line-2596"></a><span class="hs-identifier">tcRnLookupName'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span>
</span><a name="line-2597"></a><a name="tcRnLookupName%27"><a href="TcRnDriver.html#tcRnLookupName%27"><span class="hs-identifier">tcRnLookupName'</span></a></a><span> </span><a name="local-6989586621683873187"><a href="#local-6989586621683873187"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2598"></a><span>   </span><a name="local-6989586621683873188"><a href="#local-6989586621683873188"><span class="hs-identifier">tcthing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcLookup"><span class="hs-identifier hs-var">tcLookup</span></a><span> </span><a href="#local-6989586621683873187"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2599"></a><span>   </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683873188"><span class="hs-identifier hs-var">tcthing</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2600"></a><span>     </span><span class="hs-identifier hs-var">AGlobal</span><span> </span><a name="local-6989586621683873189"><a href="#local-6989586621683873189"><span class="hs-identifier">thing</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873189"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-2601"></a><span>     </span><span class="hs-identifier hs-var">ATcId</span><span class="hs-special">{</span><span class="hs-identifier">tct_id</span><span class="hs-glyph">=</span><a name="local-6989586621683873190"><a href="#local-6989586621683873190"><span class="hs-identifier">id</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AnId</span><span> </span><a href="#local-6989586621683873190"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-2602"></a><span>     </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;tcRnLookupName'&quot;</span><span>
</span><a name="line-2603"></a><span>
</span><a name="line-2604"></a><span class="hs-identifier">tcRnGetInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span>
</span><a name="line-2605"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-2606"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Messages</span><span>
</span><a name="line-2607"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyThing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Fixity</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2608"></a><span>
</span><a name="line-2609"></a><span class="hs-comment">-- Used to implement :info in GHCi</span><span>
</span><a name="line-2610"></a><span class="hs-comment">--</span><span>
</span><a name="line-2611"></a><span class="hs-comment">-- Look up a RdrName and return all the TyThings it might be</span><span>
</span><a name="line-2612"></a><span class="hs-comment">-- A capitalised RdrName is given to us in the DataName namespace,</span><span>
</span><a name="line-2613"></a><span class="hs-comment">-- but we want to treat it as *both* a data constructor</span><span>
</span><a name="line-2614"></a><span class="hs-comment">--  *and* as a type or class constructor;</span><span>
</span><a name="line-2615"></a><span class="hs-comment">-- hence the call to dataTcOccs, and we return up to two results</span><span>
</span><a name="line-2616"></a><a name="tcRnGetInfo"><a href="TcRnDriver.html#tcRnGetInfo"><span class="hs-identifier">tcRnGetInfo</span></a></a><span> </span><a name="local-6989586621683873191"><a href="#local-6989586621683873191"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873192"><a href="#local-6989586621683873192"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-2617"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#runTcInteractive"><span class="hs-identifier hs-var">runTcInteractive</span></a><span> </span><a href="#local-6989586621683873191"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2618"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnDriver.html#loadUnqualIfaces"><span class="hs-identifier hs-var">loadUnqualIfaces</span></a><span> </span><a href="#local-6989586621683873191"><span class="hs-identifier hs-var">hsc_env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_IC</span><span> </span><a href="#local-6989586621683873191"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2619"></a><span>           </span><span class="hs-comment">-- Load the interface for all unqualified types and classes</span><span>
</span><a name="line-2620"></a><span>           </span><span class="hs-comment">-- That way we will find all the instance declarations</span><span>
</span><a name="line-2621"></a><span>           </span><span class="hs-comment">-- (Packages have not orphan modules, and we assume that</span><span>
</span><a name="line-2622"></a><span>           </span><span class="hs-comment">--  in the home package all relevant modules are loaded.)</span><span>
</span><a name="line-2623"></a><span>
</span><a name="line-2624"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873193"><a href="#local-6989586621683873193"><span class="hs-identifier">thing</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#tcRnLookupName%27"><span class="hs-identifier hs-var">tcRnLookupName'</span></a><span> </span><a href="#local-6989586621683873192"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2625"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621683873194"><a href="#local-6989586621683873194"><span class="hs-identifier">fixity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnFixity.html#lookupFixityRn"><span class="hs-identifier hs-var">lookupFixityRn</span></a><span> </span><a href="#local-6989586621683873192"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2626"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683873195"><a href="#local-6989586621683873195"><span class="hs-identifier">cls_insts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873196"><a href="#local-6989586621683873196"><span class="hs-identifier">fam_insts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnDriver.html#lookupInsts"><span class="hs-identifier hs-var">lookupInsts</span></a><span> </span><a href="#local-6989586621683873193"><span class="hs-identifier hs-var">thing</span></a><span>
</span><a name="line-2627"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873197"><a href="#local-6989586621683873197"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PrelInfo.html#lookupKnownNameInfo"><span class="hs-identifier hs-var">lookupKnownNameInfo</span></a><span> </span><a href="#local-6989586621683873192"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2628"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873193"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873194"><span class="hs-identifier hs-var">fixity</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873195"><span class="hs-identifier hs-var">cls_insts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873196"><span class="hs-identifier hs-var">fam_insts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873197"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2629"></a><span>
</span><a name="line-2630"></a><span>
</span><a name="line-2631"></a><span class="hs-comment">-- Lookup all class and family instances for a type constructor.</span><span>
</span><a name="line-2632"></a><span class="hs-comment">--</span><span>
</span><a name="line-2633"></a><span class="hs-comment">-- This function filters all instances in the type environment, so there</span><span>
</span><a name="line-2634"></a><span class="hs-comment">-- is a lot of duplicated work if it is called many times in the same</span><span>
</span><a name="line-2635"></a><span class="hs-comment">-- type environment. If this becomes a problem, the NameEnv computed</span><span>
</span><a name="line-2636"></a><span class="hs-comment">-- in GHC.getNameToInstancesIndex could be cached in TcM and both functions</span><span>
</span><a name="line-2637"></a><span class="hs-comment">-- could be changed to consult that index.</span><span>
</span><a name="line-2638"></a><span class="hs-identifier">lookupInsts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TyThing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2639"></a><a name="lookupInsts"><a href="TcRnDriver.html#lookupInsts"><span class="hs-identifier">lookupInsts</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ATyCon</span><span> </span><a name="local-6989586621683873198"><a href="#local-6989586621683873198"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2640"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">InstEnvs</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ie_global</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873200"><a href="#local-6989586621683873200"><span class="hs-identifier">pkg_ie</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ie_local</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873201"><a href="#local-6989586621683873201"><span class="hs-identifier">home_ie</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ie_visible</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873202"><a href="#local-6989586621683873202"><span class="hs-identifier">vis_mods</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#tcGetInstEnvs"><span class="hs-identifier hs-var">tcGetInstEnvs</span></a><span>
</span><a name="line-2641"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621683873203"><a href="#local-6989586621683873203"><span class="hs-identifier">pkg_fie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873204"><a href="#local-6989586621683873204"><span class="hs-identifier">home_fie</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-2642"></a><span>                </span><span class="hs-comment">-- Load all instances for all classes that are</span><span>
</span><a name="line-2643"></a><span>                </span><span class="hs-comment">-- in the type environment (which are all the ones</span><span>
</span><a name="line-2644"></a><span>                </span><span class="hs-comment">-- we've seen in any interface file so far)</span><span>
</span><a name="line-2645"></a><span>
</span><a name="line-2646"></a><span>          </span><span class="hs-comment">-- Return only the instances relevant to the given thing, i.e.</span><span>
</span><a name="line-2647"></a><span>          </span><span class="hs-comment">-- the instances whose head contains the thing's name.</span><span>
</span><a name="line-2648"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873205"><a href="#local-6989586621683873205"><span class="hs-identifier">cls_insts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2649"></a><span>                 </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683873206"><span class="hs-identifier hs-var">ispec</span></a><span>        </span><span class="hs-comment">-- Search all</span><span>
</span><a name="line-2650"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683873206"><a href="#local-6989586621683873206"><span class="hs-identifier">ispec</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">instEnvElts</span><span> </span><a href="#local-6989586621683873201"><span class="hs-identifier hs-var">home_ie</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">instEnvElts</span><span> </span><a href="#local-6989586621683873200"><span class="hs-identifier hs-var">pkg_ie</span></a><span>
</span><a name="line-2651"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">instIsVisible</span><span> </span><a href="#local-6989586621683873202"><span class="hs-identifier hs-var">vis_mods</span></a><span> </span><a href="#local-6989586621683873206"><span class="hs-identifier hs-var">ispec</span></a><span>
</span><a name="line-2652"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873199"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">orphNamesOfClsInst</span><span> </span><a href="#local-6989586621683873206"><span class="hs-identifier hs-var">ispec</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2653"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873207"><a href="#local-6989586621683873207"><span class="hs-identifier">fam_insts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2654"></a><span>                 </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621683873208"><span class="hs-identifier hs-var">fispec</span></a><span>
</span><a name="line-2655"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683873208"><a href="#local-6989586621683873208"><span class="hs-identifier">fispec</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">famInstEnvElts</span><span> </span><a href="#local-6989586621683873204"><span class="hs-identifier hs-var">home_fie</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">famInstEnvElts</span><span> </span><a href="#local-6989586621683873203"><span class="hs-identifier hs-var">pkg_fie</span></a><span>
</span><a name="line-2656"></a><span>                 </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873199"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elemNameSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">orphNamesOfFamInst</span><span> </span><a href="#local-6989586621683873208"><span class="hs-identifier hs-var">fispec</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2657"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873205"><span class="hs-identifier hs-var">cls_insts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873207"><span class="hs-identifier hs-var">fam_insts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2658"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2659"></a><span>    </span><a name="local-6989586621683873199"><a href="#local-6989586621683873199"><span class="hs-identifier">tc_name</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683873198"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2660"></a><span>
</span><a name="line-2661"></a><span class="hs-identifier">lookupInsts</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2662"></a><span>
</span><a name="line-2663"></a><span class="hs-identifier">loadUnqualIfaces</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InteractiveContext</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2664"></a><span class="hs-comment">-- Load the interface for everything that is in scope unqualified</span><span>
</span><a name="line-2665"></a><span class="hs-comment">-- This is so that we can accurately report the instances for</span><span>
</span><a name="line-2666"></a><span class="hs-comment">-- something</span><span>
</span><a name="line-2667"></a><a name="loadUnqualIfaces"><a href="TcRnDriver.html#loadUnqualIfaces"><span class="hs-identifier">loadUnqualIfaces</span></a></a><span> </span><a name="local-6989586621683873209"><a href="#local-6989586621683873209"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873210"><a href="#local-6989586621683873210"><span class="hs-identifier">ictxt</span></a></a><span>
</span><a name="line-2668"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#initIfaceTcRn"><span class="hs-identifier hs-var">initIfaceTcRn</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2669"></a><span>    </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="LoadIface.html#loadSysInterface"><span class="hs-identifier hs-var">loadSysInterface</span></a><span> </span><a href="#local-6989586621683873213"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">moduleSetElts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkModuleSet</span><span> </span><a href="#local-6989586621683873212"><span class="hs-identifier hs-var">unqual_mods</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2670"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2671"></a><span>    </span><a name="local-6989586621683873211"><a href="#local-6989586621683873211"><span class="hs-identifier">this_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">thisPackage</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621683873209"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2672"></a><span>
</span><a name="line-2673"></a><span>    </span><a name="local-6989586621683873212"><a href="#local-6989586621683873212"><span class="hs-identifier">unqual_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">nameModule</span><span> </span><a href="#local-6989586621683873215"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2674"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683873214"><a href="#local-6989586621683873214"><span class="hs-identifier">gre</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">globalRdrEnvElts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ic_rn_gbl_env</span><span> </span><a href="#local-6989586621683873210"><span class="hs-identifier hs-var">ictxt</span></a><span class="hs-special">)</span><span>
</span><a name="line-2675"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873215"><a href="#local-6989586621683873215"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gre_name</span><span> </span><a href="#local-6989586621683873214"><span class="hs-identifier hs-var">gre</span></a><span>
</span><a name="line-2676"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nameIsFromExternalPackage</span><span> </span><a href="#local-6989586621683873211"><span class="hs-identifier hs-var">this_pkg</span></a><span> </span><a href="#local-6989586621683873215"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2677"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">isTcOcc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683873215"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Types and classes only</span><span>
</span><a name="line-2678"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unQualOK</span><span> </span><a href="#local-6989586621683873214"><span class="hs-identifier hs-var">gre</span></a><span> </span><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- In scope unqualified</span><span>
</span><a name="line-2679"></a><span>    </span><a name="local-6989586621683873213"><a href="#local-6989586621683873213"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Need interface for module whose export(s) are in scope unqualified&quot;</span><span>
</span><a name="line-2680"></a><span>
</span><a name="line-2681"></a><span>
</span><a name="line-2682"></a><span>
</span><a name="line-2683"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Debugging output
      This is what happens when you do -ddump-types
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2691"></a><span>
</span><a name="line-2692"></a><span class="hs-identifier">rnDump</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Outputable</span><span> </span><a href="#local-6989586621683872482"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><a href="#local-6989586621683872482"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621683872482"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2693"></a><span class="hs-comment">-- Dump, with a banner, if -ddump-rn</span><span>
</span><a name="line-2694"></a><a name="rnDump"><a href="TcRnDriver.html#rnDump"><span class="hs-identifier">rnDump</span></a></a><span> </span><a name="local-6989586621683873216"><a href="#local-6989586621683873216"><span class="hs-identifier">rn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_rn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkDumpDoc</span><span> </span><span class="hs-string">&quot;Renamer&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873216"><span class="hs-identifier hs-var">rn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2695"></a><span>
</span><a name="line-2696"></a><span class="hs-identifier">tcDump</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcRn</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2697"></a><a name="tcDump"><a href="TcRnDriver.html#tcDump"><span class="hs-identifier">tcDump</span></a></a><span> </span><a name="local-6989586621683873217"><a href="#local-6989586621683873217"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-2698"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621683873221"><a href="#local-6989586621683873221"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2699"></a><span>
</span><a name="line-2700"></a><span>        </span><span class="hs-comment">-- Dump short output if -ddump-types or -ddump-tc</span><span>
</span><a name="line-2701"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_types</span><span> </span><a href="#local-6989586621683873221"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">dopt</span><span> </span><span class="hs-identifier hs-var">Opt_D_dump_tc</span><span> </span><a href="#local-6989586621683873221"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2702"></a><span>          </span><span class="hs-special">(</span><a href="TcRnMonad.html#traceTcRnForUser"><span class="hs-identifier hs-var">traceTcRnForUser</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_types</span><span> </span><a href="#local-6989586621683873218"><span class="hs-identifier hs-var">short_dump</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span>
</span><a name="line-2703"></a><span>
</span><a name="line-2704"></a><span>        </span><span class="hs-comment">-- Dump bindings if -ddump-tc</span><span>
</span><a name="line-2705"></a><span>        </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_tc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkDumpDoc</span><span> </span><span class="hs-string">&quot;Typechecker&quot;</span><span> </span><a href="#local-6989586621683873219"><span class="hs-identifier hs-var">full_dump</span></a><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><a name="line-2706"></a><span>
</span><a name="line-2707"></a><span>        </span><span class="hs-comment">-- Dump bindings as an hsSyn AST if -ddump-tc-ast</span><span>
</span><a name="line-2708"></a><span>        </span><a href="TcRnMonad.html#traceOptTcRn"><span class="hs-identifier hs-var">traceOptTcRn</span></a><span> </span><span class="hs-identifier hs-var">Opt_D_dump_tc_ast</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkDumpDoc</span><span> </span><span class="hs-string">&quot;Typechecker&quot;</span><span> </span><a href="#local-6989586621683873220"><span class="hs-identifier hs-var">ast_dump</span></a><span class="hs-special">)</span><span>
</span><a name="line-2709"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-2710"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2711"></a><span>    </span><a name="local-6989586621683873218"><a href="#local-6989586621683873218"><span class="hs-identifier">short_dump</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#pprTcGblEnv"><span class="hs-identifier hs-var">pprTcGblEnv</span></a><span> </span><a href="#local-6989586621683873217"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2712"></a><span>    </span><a name="local-6989586621683873219"><a href="#local-6989586621683873219"><span class="hs-identifier">full_dump</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprLHsBinds</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_binds</span><span> </span><a href="#local-6989586621683873217"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2713"></a><span>        </span><span class="hs-comment">-- NB: foreign x-d's have undefined's in their types;</span><span>
</span><a name="line-2714"></a><span>        </span><span class="hs-comment">--     hence can't show the tc_fords</span><span>
</span><a name="line-2715"></a><span>    </span><a name="local-6989586621683873220"><a href="#local-6989586621683873220"><span class="hs-identifier">ast_dump</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsDumpAst.html#showAstData"><span class="hs-identifier hs-var">showAstData</span></a><span> </span><a href="HsDumpAst.html#NoBlankSrcSpan"><span class="hs-identifier hs-var">NoBlankSrcSpan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_binds</span><span> </span><a href="#local-6989586621683873217"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2716"></a><span>
</span><a name="line-2717"></a><span class="hs-comment">-- It's unpleasant having both pprModGuts and pprModDetails here</span><span>
</span><a name="line-2718"></a><span class="hs-identifier">pprTcGblEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2719"></a><a name="pprTcGblEnv"><a href="TcRnDriver.html#pprTcGblEnv"><span class="hs-identifier">pprTcGblEnv</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcGblEnv</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_type_env</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873222"><a href="#local-6989586621683873222"><span class="hs-identifier">type_env</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-2720"></a><span>                        </span><span class="hs-identifier">tcg_insts</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873223"><a href="#local-6989586621683873223"><span class="hs-identifier">insts</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-2721"></a><span>                        </span><span class="hs-identifier">tcg_fam_insts</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873224"><a href="#local-6989586621683873224"><span class="hs-identifier">fam_insts</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-2722"></a><span>                        </span><span class="hs-identifier">tcg_rules</span><span>     </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873225"><a href="#local-6989586621683873225"><span class="hs-identifier">rules</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-2723"></a><span>                        </span><span class="hs-identifier">tcg_imports</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621683873226"><a href="#local-6989586621683873226"><span class="hs-identifier">imports</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2724"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getPprDebug</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621683873227"><a href="#local-6989586621683873227"><span class="hs-identifier">debug</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2725"></a><span>    </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnDriver.html#ppr_types"><span class="hs-identifier hs-var">ppr_types</span></a><span> </span><a href="#local-6989586621683873227"><span class="hs-identifier hs-var">debug</span></a><span> </span><a href="#local-6989586621683873222"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-2726"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#ppr_tycons"><span class="hs-identifier hs-var">ppr_tycons</span></a><span> </span><a href="#local-6989586621683873227"><span class="hs-identifier hs-var">debug</span></a><span> </span><a href="#local-6989586621683873224"><span class="hs-identifier hs-var">fam_insts</span></a><span> </span><a href="#local-6989586621683873222"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-2727"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#ppr_datacons"><span class="hs-identifier hs-var">ppr_datacons</span></a><span> </span><a href="#local-6989586621683873227"><span class="hs-identifier hs-var">debug</span></a><span> </span><a href="#local-6989586621683873222"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-2728"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#ppr_patsyns"><span class="hs-identifier hs-var">ppr_patsyns</span></a><span> </span><a href="#local-6989586621683873222"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-2729"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#ppr_insts"><span class="hs-identifier hs-var">ppr_insts</span></a><span> </span><a href="#local-6989586621683873223"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-2730"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#ppr_fam_insts"><span class="hs-identifier hs-var">ppr_fam_insts</span></a><span> </span><a href="#local-6989586621683873224"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-2731"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#ppr_rules"><span class="hs-identifier hs-var">ppr_rules</span></a><span> </span><a href="#local-6989586621683873225"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-2732"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Dependent modules:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2733"></a><span>                </span><span class="hs-identifier hs-var">pprUFM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">imp_dep_mods</span><span> </span><a href="#local-6989586621683873226"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">sort</span><span class="hs-special">)</span><span>
</span><a name="line-2734"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;Dependent packages:&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span>
</span><a name="line-2735"></a><span>                </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">S.toList</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">imp_dep_pkgs</span><span> </span><a href="#local-6989586621683873226"><span class="hs-identifier hs-var">imports</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2736"></a><span>  </span><span class="hs-keyword">where</span><span>         </span><span class="hs-comment">-- The use of sort is just to reduce unnecessary</span><span>
</span><a name="line-2737"></a><span>                </span><span class="hs-comment">-- wobbling in testsuite output</span><span>
</span><a name="line-2738"></a><span>
</span><a name="line-2739"></a><span class="hs-identifier">ppr_rules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LRuleDecl</span><span> </span><span class="hs-identifier hs-type">GhcTc</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2740"></a><a name="ppr_rules"><a href="TcRnDriver.html#ppr_rules"><span class="hs-identifier">ppr_rules</span></a></a><span> </span><a name="local-6989586621683873228"><a href="#local-6989586621683873228"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-2741"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppUnless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683873228"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2742"></a><span>    </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;RULES&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2743"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873228"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2744"></a><span>
</span><a name="line-2745"></a><span class="hs-identifier">ppr_types</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2746"></a><a name="ppr_types"><a href="TcRnDriver.html#ppr_types"><span class="hs-identifier">ppr_types</span></a></a><span> </span><a name="local-6989586621683873229"><a href="#local-6989586621683873229"><span class="hs-identifier">debug</span></a></a><span> </span><a name="local-6989586621683873230"><a href="#local-6989586621683873230"><span class="hs-identifier">type_env</span></a></a><span>
</span><a name="line-2747"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#ppr_things"><span class="hs-identifier hs-var">ppr_things</span></a><span> </span><span class="hs-string">&quot;TYPE SIGNATURES&quot;</span><span> </span><a href="#local-6989586621683873233"><span class="hs-identifier hs-var">ppr_sig</span></a><span>
</span><a name="line-2748"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873231"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-2749"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2750"></a><span>    </span><a name="local-6989586621683873231"><a href="#local-6989586621683873231"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683873234"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683873234"><a href="#local-6989586621683873234"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">typeEnvIds</span><span> </span><a href="#local-6989586621683873230"><span class="hs-identifier hs-var">type_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873232"><span class="hs-identifier hs-var">want_sig</span></a><span> </span><a href="#local-6989586621683873234"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">]</span><span>
</span><a name="line-2751"></a><span>    </span><a name="local-6989586621683873232"><a href="#local-6989586621683873232"><span class="hs-identifier">want_sig</span></a></a><span> </span><a name="local-6989586621683873235"><a href="#local-6989586621683873235"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-2752"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683873229"><span class="hs-identifier hs-var">debug</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2753"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#hasTopUserName"><span class="hs-identifier hs-var">hasTopUserName</span></a><span> </span><a href="#local-6989586621683873235"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-2754"></a><span>                    </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">idDetails</span><span> </span><a href="#local-6989586621683873235"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2755"></a><span>                         </span><span class="hs-identifier hs-var">VanillaId</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2756"></a><span>                         </span><span class="hs-identifier hs-var">RecSelId</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2757"></a><span>                         </span><span class="hs-identifier hs-var">ClassOpId</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2758"></a><span>                         </span><span class="hs-identifier hs-var">FCallId</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2759"></a><span>                         </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2760"></a><span>             </span><span class="hs-comment">-- Data cons (workers and wrappers), pattern synonyms,</span><span>
</span><a name="line-2761"></a><span>             </span><span class="hs-comment">-- etc are suppressed (unless -dppr-debug),</span><span>
</span><a name="line-2762"></a><span>             </span><span class="hs-comment">-- because they appear elsehwere</span><span>
</span><a name="line-2763"></a><span>
</span><a name="line-2764"></a><span>    </span><a name="local-6989586621683873233"><a href="#local-6989586621683873233"><span class="hs-identifier">ppr_sig</span></a></a><span> </span><a name="local-6989586621683873236"><a href="#local-6989586621683873236"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873236"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyTopType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">idType</span><span> </span><a href="#local-6989586621683873236"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2765"></a><span>
</span><a name="line-2766"></a><span class="hs-identifier">ppr_tycons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2767"></a><a name="ppr_tycons"><a href="TcRnDriver.html#ppr_tycons"><span class="hs-identifier">ppr_tycons</span></a></a><span> </span><a name="local-6989586621683873237"><a href="#local-6989586621683873237"><span class="hs-identifier">debug</span></a></a><span> </span><a name="local-6989586621683873238"><a href="#local-6989586621683873238"><span class="hs-identifier">fam_insts</span></a></a><span> </span><a name="local-6989586621683873239"><a href="#local-6989586621683873239"><span class="hs-identifier">type_env</span></a></a><span>
</span><a name="line-2768"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnDriver.html#ppr_things"><span class="hs-identifier hs-var">ppr_things</span></a><span> </span><span class="hs-string">&quot;TYPE CONSTRUCTORS&quot;</span><span> </span><a href="#local-6989586621683873243"><span class="hs-identifier hs-var">ppr_tc</span></a><span> </span><a href="#local-6989586621683873241"><span class="hs-identifier hs-var">tycons</span></a><span>
</span><a name="line-2769"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="TcRnDriver.html#ppr_things"><span class="hs-identifier hs-var">ppr_things</span></a><span> </span><span class="hs-string">&quot;COERCION AXIOMS&quot;</span><span> </span><a href="#local-6989586621683873244"><span class="hs-identifier hs-var">ppr_ax</span></a><span>
</span><a name="line-2770"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeEnvCoAxioms</span><span> </span><a href="#local-6989586621683873239"><span class="hs-identifier hs-var">type_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2771"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2772"></a><span>    </span><a name="local-6989586621683873240"><a href="#local-6989586621683873240"><span class="hs-identifier">fi_tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">famInstsRepTyCons</span><span> </span><a href="#local-6989586621683873238"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-2773"></a><span>
</span><a name="line-2774"></a><span>    </span><a name="local-6989586621683873241"><a href="#local-6989586621683873241"><span class="hs-identifier">tycons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><span class="hs-identifier hs-var">getOccName</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2775"></a><span>             </span><span class="hs-special">[</span><a href="#local-6989586621683873245"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621683873245"><a href="#local-6989586621683873245"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">typeEnvTyCons</span><span> </span><a href="#local-6989586621683873239"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-2776"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873242"><span class="hs-identifier hs-var">want_tycon</span></a><span> </span><a href="#local-6989586621683873245"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">]</span><span>
</span><a name="line-2777"></a><span>             </span><span class="hs-comment">-- Sort by OccName to reduce unnecessary changes</span><span>
</span><a name="line-2778"></a><span>    </span><a name="local-6989586621683873242"><a href="#local-6989586621683873242"><span class="hs-identifier">want_tycon</span></a></a><span> </span><a name="local-6989586621683873246"><a href="#local-6989586621683873246"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683873237"><span class="hs-identifier hs-var">debug</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2779"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621683873246"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-2780"></a><span>                                    </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873246"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621683873240"><span class="hs-identifier hs-var">fi_tycons</span></a><span class="hs-special">)</span><span>
</span><a name="line-2781"></a><span>    </span><a name="local-6989586621683873243"><a href="#local-6989586621683873243"><span class="hs-identifier">ppr_tc</span></a></a><span> </span><a name="local-6989586621683873247"><a href="#local-6989586621683873247"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-2782"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tyConFlavour</span><span> </span><a href="#local-6989586621683873247"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873247"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2783"></a><span>                      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">braces</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621683873247"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span class="hs-special">)</span><span>
</span><a name="line-2784"></a><span>                   </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">tidyTopType</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621683873247"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2785"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2786"></a><span>                </span><span class="hs-identifier hs-var">ppWhen</span><span> </span><a href="#local-6989586621683873248"><span class="hs-identifier hs-var">show_roles</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2787"></a><span>                </span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;roles&quot;</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sep</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873249"><span class="hs-identifier hs-var">roles</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2788"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-2789"></a><span>         </span><a name="local-6989586621683873248"><a href="#local-6989586621683873248"><span class="hs-identifier">show_roles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873237"><span class="hs-identifier hs-var">debug</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621683873250"><span class="hs-identifier hs-var">boring_role</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873249"><span class="hs-identifier hs-var">roles</span></a><span class="hs-special">)</span><span>
</span><a name="line-2790"></a><span>         </span><a name="local-6989586621683873249"><a href="#local-6989586621683873249"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">tyConRoles</span><span> </span><a href="#local-6989586621683873247"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2791"></a><span>         </span><a name="local-6989586621683873250"><a href="#local-6989586621683873250"><span class="hs-identifier">boring_role</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isClassTyCon</span><span> </span><a href="#local-6989586621683873247"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nominal</span><span>
</span><a name="line-2792"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Representational</span><span>
</span><a name="line-2793"></a><span>            </span><span class="hs-comment">-- Matches the choice in IfaceSyn, calls to pprRoles</span><span>
</span><a name="line-2794"></a><span>
</span><a name="line-2795"></a><span>    </span><a name="local-6989586621683873244"><a href="#local-6989586621683873244"><span class="hs-identifier">ppr_ax</span></a></a><span> </span><a name="local-6989586621683873251"><a href="#local-6989586621683873251"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><a href="MkIface.html#coAxiomToIfaceDecl"><span class="hs-identifier hs-var">coAxiomToIfaceDecl</span></a><span> </span><a href="#local-6989586621683873251"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span>
</span><a name="line-2796"></a><span>      </span><span class="hs-comment">-- We go via IfaceDecl rather than using pprCoAxiom</span><span>
</span><a name="line-2797"></a><span>      </span><span class="hs-comment">-- This way we get the full axiom (both LHS and RHS) with</span><span>
</span><a name="line-2798"></a><span>      </span><span class="hs-comment">-- wildcard binders tidied to _1, _2, etc.</span><span>
</span><a name="line-2799"></a><span>
</span><a name="line-2800"></a><span class="hs-identifier">ppr_datacons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2801"></a><a name="ppr_datacons"><a href="TcRnDriver.html#ppr_datacons"><span class="hs-identifier">ppr_datacons</span></a></a><span> </span><a name="local-6989586621683873252"><a href="#local-6989586621683873252"><span class="hs-identifier">debug</span></a></a><span> </span><a name="local-6989586621683873253"><a href="#local-6989586621683873253"><span class="hs-identifier">type_env</span></a></a><span>
</span><a name="line-2802"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#ppr_things"><span class="hs-identifier hs-var">ppr_things</span></a><span> </span><span class="hs-string">&quot;DATA CONSTRUCTORS&quot;</span><span> </span><a href="#local-6989586621683873254"><span class="hs-identifier hs-var">ppr_dc</span></a><span> </span><a href="#local-6989586621683873256"><span class="hs-identifier hs-var">wanted_dcs</span></a><span>
</span><a name="line-2803"></a><span>      </span><span class="hs-comment">-- The filter gets rid of class data constructors</span><span>
</span><a name="line-2804"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2805"></a><span>    </span><a name="local-6989586621683873254"><a href="#local-6989586621683873254"><span class="hs-identifier">ppr_dc</span></a></a><span> </span><a name="local-6989586621683873258"><a href="#local-6989586621683873258"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873258"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConUserType</span><span> </span><a href="#local-6989586621683873258"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2806"></a><span>    </span><a name="local-6989586621683873255"><a href="#local-6989586621683873255"><span class="hs-identifier">all_dcs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">typeEnvDataCons</span><span> </span><a href="#local-6989586621683873253"><span class="hs-identifier hs-var">type_env</span></a><span>
</span><a name="line-2807"></a><span>    </span><a name="local-6989586621683873256"><a href="#local-6989586621683873256"><span class="hs-identifier">wanted_dcs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621683873252"><span class="hs-identifier hs-var">debug</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873255"><span class="hs-identifier hs-var">all_dcs</span></a><span>
</span><a name="line-2808"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filterOut</span><span> </span><a href="#local-6989586621683873257"><span class="hs-identifier hs-var">is_cls_dc</span></a><span> </span><a href="#local-6989586621683873255"><span class="hs-identifier hs-var">all_dcs</span></a><span>
</span><a name="line-2809"></a><span>    </span><a name="local-6989586621683873257"><a href="#local-6989586621683873257"><span class="hs-identifier">is_cls_dc</span></a></a><span> </span><a name="local-6989586621683873259"><a href="#local-6989586621683873259"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isClassTyCon</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">dataConTyCon</span><span> </span><a href="#local-6989586621683873259"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2810"></a><span>
</span><a name="line-2811"></a><span class="hs-identifier">ppr_patsyns</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TypeEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2812"></a><a name="ppr_patsyns"><a href="TcRnDriver.html#ppr_patsyns"><span class="hs-identifier">ppr_patsyns</span></a></a><span> </span><a name="local-6989586621683873260"><a href="#local-6989586621683873260"><span class="hs-identifier">type_env</span></a></a><span>
</span><a name="line-2813"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#ppr_things"><span class="hs-identifier hs-var">ppr_things</span></a><span> </span><span class="hs-string">&quot;PATTERN SYNONYMS&quot;</span><span> </span><a href="#local-6989586621683873261"><span class="hs-identifier hs-var">ppr_ps</span></a><span>
</span><a name="line-2814"></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">typeEnvPatSyns</span><span> </span><a href="#local-6989586621683873260"><span class="hs-identifier hs-var">type_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2815"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2816"></a><span>    </span><a name="local-6989586621683873261"><a href="#local-6989586621683873261"><span class="hs-identifier">ppr_ps</span></a></a><span> </span><a name="local-6989586621683873262"><a href="#local-6989586621683873262"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ppr</span><span> </span><a href="#local-6989586621683873262"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">dcolon</span><span> </span><span class="hs-operator hs-var">&lt;+&gt;</span><span> </span><span class="hs-identifier hs-var">pprPatSynType</span><span> </span><a href="#local-6989586621683873262"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-2817"></a><span>
</span><a name="line-2818"></a><span class="hs-identifier">ppr_insts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">ClsInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2819"></a><a name="ppr_insts"><a href="TcRnDriver.html#ppr_insts"><span class="hs-identifier">ppr_insts</span></a></a><span> </span><a name="local-6989586621683873263"><a href="#local-6989586621683873263"><span class="hs-identifier">ispecs</span></a></a><span>
</span><a name="line-2820"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#ppr_things"><span class="hs-identifier hs-var">ppr_things</span></a><span> </span><span class="hs-string">&quot;CLASS INSTANCES&quot;</span><span> </span><span class="hs-identifier hs-var">pprInstance</span><span> </span><a href="#local-6989586621683873263"><span class="hs-identifier hs-var">ispecs</span></a><span>
</span><a name="line-2821"></a><span>
</span><a name="line-2822"></a><span class="hs-identifier">ppr_fam_insts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FamInst</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2823"></a><a name="ppr_fam_insts"><a href="TcRnDriver.html#ppr_fam_insts"><span class="hs-identifier">ppr_fam_insts</span></a></a><span> </span><a name="local-6989586621683873264"><a href="#local-6989586621683873264"><span class="hs-identifier">fam_insts</span></a></a><span>
</span><a name="line-2824"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#ppr_things"><span class="hs-identifier hs-var">ppr_things</span></a><span> </span><span class="hs-string">&quot;FAMILY INSTANCES&quot;</span><span> </span><span class="hs-identifier hs-var">pprFamInst</span><span> </span><a href="#local-6989586621683873264"><span class="hs-identifier hs-var">fam_insts</span></a><span>
</span><a name="line-2825"></a><span>
</span><a name="line-2826"></a><span class="hs-identifier">ppr_things</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683872481"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621683872481"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SDoc</span><span>
</span><a name="line-2827"></a><a name="ppr_things"><a href="TcRnDriver.html#ppr_things"><span class="hs-identifier">ppr_things</span></a></a><span> </span><a name="local-6989586621683873265"><a href="#local-6989586621683873265"><span class="hs-identifier">herald</span></a></a><span> </span><a name="local-6989586621683873266"><a href="#local-6989586621683873266"><span class="hs-identifier">ppr_one</span></a></a><span> </span><a name="local-6989586621683873267"><a href="#local-6989586621683873267"><span class="hs-identifier">things</span></a></a><span>
</span><a name="line-2828"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621683873267"><span class="hs-identifier hs-var">things</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">empty</span><span>
</span><a name="line-2829"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">text</span><span> </span><a href="#local-6989586621683873265"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-operator hs-var">$$</span><span> </span><span class="hs-identifier hs-var">nest</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">vcat</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621683873266"><span class="hs-identifier hs-var">ppr_one</span></a><span> </span><a href="#local-6989586621683873267"><span class="hs-identifier hs-var">things</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2830"></a><span>
</span><a name="line-2831"></a><span class="hs-identifier">hasTopUserName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">NamedThing</span><span> </span><a href="#local-6989586621683872480"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621683872480"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2832"></a><span class="hs-comment">-- A top-level thing whose name is not &quot;derived&quot;</span><span>
</span><a name="line-2833"></a><span class="hs-comment">-- Thus excluding things like $tcX, from Typeable boilerplate</span><span>
</span><a name="line-2834"></a><span class="hs-comment">-- and C:Coll from class-dictionary data constructors</span><span>
</span><a name="line-2835"></a><a name="hasTopUserName"><a href="TcRnDriver.html#hasTopUserName"><span class="hs-identifier">hasTopUserName</span></a></a><span> </span><a name="local-6989586621683873268"><a href="#local-6989586621683873268"><span class="hs-identifier">x</span></a></a><span>
</span><a name="line-2836"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isExternalName</span><span> </span><a href="#local-6989586621683873269"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isDerivedOccName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nameOccName</span><span> </span><a href="#local-6989586621683873269"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2837"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2838"></a><span>    </span><a name="local-6989586621683873269"><a href="#local-6989586621683873269"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">getName</span><span> </span><a href="#local-6989586621683873268"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-2839"></a><span>
</span><a name="line-2840"></a><span class="hs-comment">{-
********************************************************************************

Type Checker Plugins

********************************************************************************
-}</span><span>
</span><a name="line-2847"></a><span>
</span><a name="line-2848"></a><span class="hs-identifier">withTcPlugins</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683872479"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><a href="#local-6989586621683872479"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2849"></a><a name="withTcPlugins"><a href="TcRnDriver.html#withTcPlugins"><span class="hs-identifier">withTcPlugins</span></a></a><span> </span><a name="local-6989586621683873270"><a href="#local-6989586621683873270"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873271"><a href="#local-6989586621683873271"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2850"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873278"><a href="#local-6989586621683873278"><span class="hs-identifier">plugins</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnDriver.html#getTcPlugins"><span class="hs-identifier hs-var">getTcPlugins</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621683873270"><span class="hs-identifier hs-var">hsc_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2851"></a><span>     </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683873278"><span class="hs-identifier hs-var">plugins</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2852"></a><span>       </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683873271"><span class="hs-identifier hs-var">m</span></a><span>  </span><span class="hs-comment">-- Common fast case</span><span>
</span><a name="line-2853"></a><span>       </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621683873279"><a href="#local-6989586621683873279"><span class="hs-identifier">ev_binds_var</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#newTcEvBinds"><span class="hs-identifier hs-var">newTcEvBinds</span></a><span>
</span><a name="line-2854"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621683873280"><a href="#local-6989586621683873280"><span class="hs-identifier">solvers</span></a></a><span class="hs-special">,</span><a name="local-6989586621683873281"><a href="#local-6989586621683873281"><span class="hs-identifier">stops</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873272"><span class="hs-identifier hs-var">startPlugin</span></a><span> </span><a href="#local-6989586621683873279"><span class="hs-identifier hs-var">ev_binds_var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873278"><span class="hs-identifier hs-var">plugins</span></a><span>
</span><a name="line-2855"></a><span>                </span><span class="hs-comment">-- This ensures that tcPluginStop is called even if a type</span><span>
</span><a name="line-2856"></a><span>                </span><span class="hs-comment">-- error occurs during compilation (Fix of #10078)</span><span>
</span><a name="line-2857"></a><span>                </span><a name="local-6989586621683873283"><a href="#local-6989586621683873283"><span class="hs-identifier">eitherRes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">tryM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2858"></a><span>                  </span><a href="TcRnMonad.html#updGblEnv"><span class="hs-identifier hs-var">updGblEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683873282"><a href="#local-6989586621683873282"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621683873282"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcg_tc_plugins</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621683873280"><span class="hs-identifier hs-var">solvers</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873271"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-2859"></a><span>                </span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">runTcPluginM</span><span> </span><a href="#local-6989586621683873279"><span class="hs-identifier hs-var">ev_binds_var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621683873281"><span class="hs-identifier hs-var">stops</span></a><span>
</span><a name="line-2860"></a><span>                </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621683873283"><span class="hs-identifier hs-var">eitherRes</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2861"></a><span>                  </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">failM</span><span>
</span><a name="line-2862"></a><span>                  </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621683873284"><a href="#local-6989586621683873284"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621683873284"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-2863"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2864"></a><span>  </span><a name="local-6989586621683873272"><a href="#local-6989586621683873272"><span class="hs-identifier">startPlugin</span></a></a><span> </span><a name="local-6989586621683873273"><a href="#local-6989586621683873273"><span class="hs-identifier">ev_binds_var</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TcPlugin</span><span> </span><a name="local-6989586621683873274"><a href="#local-6989586621683873274"><span class="hs-identifier">start</span></a></a><span> </span><a name="local-6989586621683873275"><a href="#local-6989586621683873275"><span class="hs-identifier">solve</span></a></a><span> </span><a name="local-6989586621683873276"><a href="#local-6989586621683873276"><span class="hs-identifier">stop</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2865"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621683873277"><a href="#local-6989586621683873277"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">runTcPluginM</span><span> </span><a href="#local-6989586621683873274"><span class="hs-identifier hs-var">start</span></a><span> </span><a href="#local-6989586621683873273"><span class="hs-identifier hs-var">ev_binds_var</span></a><span>
</span><a name="line-2866"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621683873275"><span class="hs-identifier hs-var">solve</span></a><span> </span><a href="#local-6989586621683873277"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873276"><span class="hs-identifier hs-var">stop</span></a><span> </span><a href="#local-6989586621683873277"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-2867"></a><span>
</span><a name="line-2868"></a><span class="hs-identifier">getTcPlugins</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TcRnMonad.TcPlugin</span><span class="hs-special">]</span><span>
</span><a name="line-2869"></a><a name="getTcPlugins"><a href="TcRnDriver.html#getTcPlugins"><span class="hs-identifier">getTcPlugins</span></a></a><span> </span><a name="local-6989586621683873285"><a href="#local-6989586621683873285"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapPlugins</span><span> </span><a href="#local-6989586621683873285"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683873286"><a href="#local-6989586621683873286"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621683873287"><a href="#local-6989586621683873287"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">tcPlugin</span><span> </span><a href="#local-6989586621683873286"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683873287"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-2870"></a><span>
</span><a name="line-2871"></a><span class="hs-identifier">runRenamerPlugin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-2872"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span>
</span><a name="line-2873"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TcGblEnv</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">)</span><span>
</span><a name="line-2874"></a><a name="runRenamerPlugin"><a href="TcRnDriver.html#runRenamerPlugin"><span class="hs-identifier">runRenamerPlugin</span></a></a><span> </span><a name="local-6989586621683873288"><a href="#local-6989586621683873288"><span class="hs-identifier">gbl_env</span></a></a><span> </span><a name="local-6989586621683873289"><a href="#local-6989586621683873289"><span class="hs-identifier">hs_group</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2875"></a><span>    </span><a name="local-6989586621683873290"><a href="#local-6989586621683873290"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getDynFlags</span><span>
</span><a name="line-2876"></a><span>    </span><span class="hs-identifier hs-var">withPlugins</span><span> </span><a href="#local-6989586621683873290"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2877"></a><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683873291"><a href="#local-6989586621683873291"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621683873292"><a href="#local-6989586621683873292"><span class="hs-identifier">opts</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621683873293"><a href="#local-6989586621683873293"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621683873294"><a href="#local-6989586621683873294"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="TcRnDriver.html#mark_plugin_unsafe"><span class="hs-identifier hs-var">mark_plugin_unsafe</span></a><span> </span><a href="#local-6989586621683873290"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier">renamedResultAction</span><span> </span><a href="#local-6989586621683873291"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683873292"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621683873293"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621683873294"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2878"></a><span>      </span><span class="hs-special">(</span><a href="#local-6989586621683873288"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621683873289"><span class="hs-identifier hs-var">hs_group</span></a><span class="hs-special">)</span><span>
</span><a name="line-2879"></a><span>
</span><a name="line-2880"></a><span>
</span><a name="line-2881"></a><span class="hs-comment">-- XXX: should this really be a Maybe X?  Check under which circumstances this</span><span>
</span><a name="line-2882"></a><span class="hs-comment">-- can become a Nothing and decide whether this should instead throw an</span><span>
</span><a name="line-2883"></a><span class="hs-comment">-- exception/signal an error.</span><span>
</span><a name="line-2884"></a><span class="hs-keyword">type</span><span> </span><a name="RenamedStuff"><a href="TcRnDriver.html#RenamedStuff"><span class="hs-identifier">RenamedStuff</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2885"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">HsGroup</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">LImportDecl</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">LIE</span><span> </span><span class="hs-identifier hs-type">GhcRn</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Avails</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-2886"></a><span>                </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">LHsDocString</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2887"></a><span>
</span><a name="line-2888"></a><span class="hs-comment">-- | Extract the renamed information from TcGblEnv.</span><span>
</span><a name="line-2889"></a><span class="hs-identifier">getRenamedStuff</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnDriver.html#RenamedStuff"><span class="hs-identifier hs-type">RenamedStuff</span></a><span>
</span><a name="line-2890"></a><a name="getRenamedStuff"><a href="TcRnDriver.html#getRenamedStuff"><span class="hs-identifier">getRenamedStuff</span></a></a><span> </span><a name="local-6989586621683873295"><a href="#local-6989586621683873295"><span class="hs-identifier">tc_result</span></a></a><span>
</span><a name="line-2891"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683873296"><a href="#local-6989586621683873296"><span class="hs-identifier">decls</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621683873296"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_rn_imports</span><span> </span><a href="#local-6989586621683873295"><span class="hs-identifier hs-var">tc_result</span></a><span>
</span><a name="line-2892"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_rn_exports</span><span> </span><a href="#local-6989586621683873295"><span class="hs-identifier hs-var">tc_result</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcg_doc_hdr</span><span> </span><a href="#local-6989586621683873295"><span class="hs-identifier hs-var">tc_result</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2893"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier">tcg_rn_decls</span><span> </span><a href="#local-6989586621683873295"><span class="hs-identifier hs-var">tc_result</span></a><span class="hs-special">)</span><span>
</span><a name="line-2894"></a><span>
</span><a name="line-2895"></a><span class="hs-identifier">runTypecheckerPlugin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ModSummary</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">HscEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-identifier hs-type">TcGblEnv</span><span>
</span><a name="line-2896"></a><a name="runTypecheckerPlugin"><a href="TcRnDriver.html#runTypecheckerPlugin"><span class="hs-identifier">runTypecheckerPlugin</span></a></a><span> </span><a name="local-6989586621683873297"><a href="#local-6989586621683873297"><span class="hs-identifier">sum</span></a></a><span> </span><a name="local-6989586621683873298"><a href="#local-6989586621683873298"><span class="hs-identifier">hsc_env</span></a></a><span> </span><a name="local-6989586621683873299"><a href="#local-6989586621683873299"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2897"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621683873300"><a href="#local-6989586621683873300"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hsc_dflags</span><span> </span><a href="#local-6989586621683873298"><span class="hs-identifier hs-var">hsc_env</span></a><span>
</span><a name="line-2898"></a><span>    </span><span class="hs-identifier hs-var">withPlugins</span><span> </span><a href="#local-6989586621683873300"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2899"></a><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621683873301"><a href="#local-6989586621683873301"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621683873302"><a href="#local-6989586621683873302"><span class="hs-identifier">opts</span></a></a><span> </span><a name="local-6989586621683873303"><a href="#local-6989586621683873303"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnDriver.html#mark_plugin_unsafe"><span class="hs-identifier hs-var">mark_plugin_unsafe</span></a><span> </span><a href="#local-6989586621683873300"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2900"></a><span>                        </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier">typeCheckResultAction</span><span> </span><a href="#local-6989586621683873301"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621683873302"><span class="hs-identifier hs-var">opts</span></a><span> </span><a href="#local-6989586621683873297"><span class="hs-identifier hs-var">sum</span></a><span> </span><a href="#local-6989586621683873303"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2901"></a><span>      </span><a href="#local-6989586621683873299"><span class="hs-identifier hs-var">gbl_env</span></a><span>
</span><a name="line-2902"></a><span>
</span><a name="line-2903"></a><span class="hs-identifier">mark_plugin_unsafe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DynFlags</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TcM</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2904"></a><a name="mark_plugin_unsafe"><a href="TcRnDriver.html#mark_plugin_unsafe"><span class="hs-identifier">mark_plugin_unsafe</span></a></a><span> </span><a name="local-6989586621683873304"><a href="#local-6989586621683873304"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#recordUnsafeInfer"><span class="hs-identifier hs-var">recordUnsafeInfer</span></a><span> </span><a href="#local-6989586621683873306"><span class="hs-identifier hs-var">pluginUnsafe</span></a><span>
</span><a name="line-2905"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2906"></a><span>    </span><a name="local-6989586621683873305"><a href="#local-6989586621683873305"><span class="hs-identifier">unsafeText</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Use of plugins makes the module unsafe&quot;</span><span>
</span><a name="line-2907"></a><span>    </span><a name="local-6989586621683873306"><a href="#local-6989586621683873306"><span class="hs-identifier">pluginUnsafe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unitBag</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mkPlainWarnMsg</span><span> </span><a href="#local-6989586621683873304"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">noSrcSpan</span><span>
</span><a name="line-2908"></a><span>                                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Outputable.text</span><span> </span><a href="#local-6989586621683873305"><span class="hs-identifier hs-var">unsafeText</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2909"></a></pre></body></html>