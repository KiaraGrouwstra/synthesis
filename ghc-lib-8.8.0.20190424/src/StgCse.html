<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">{-|
Note [CSE for Stg]
~~~~~~~~~~~~~~~~~~
This module implements a simple common subexpression elimination pass for STG.
This is useful because there are expressions that we want to common up (because
they are operationally equivalent), but that we cannot common up in Core, because
their types differ.
This was originally reported as #9291.

There are two types of common code occurrences that we aim for, see
note [Case 1: CSEing allocated closures] and
note [Case 2: CSEing case binders] below.


Note [Case 1: CSEing allocated closures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The first kind of CSE opportunity we aim for is generated by this Haskell code:

    bar :: a -&gt; (Either Int a, Either Bool a)
    bar x = (Right x, Right x)

which produces this Core:

    bar :: forall a. a -&gt; (Either Int a, Either Bool a)
    bar @a x = (Right @Int @a x, Right @Bool @a x)

where the two components of the tuple are different terms, and cannot be
commoned up (easily). On the STG level we have

    bar [x] = let c1 = Right [x]
                  c2 = Right [x]
              in (c1,c2)

and now it is obvious that we can write

    bar [x] = let c1 = Right [x]
              in (c1,c1)

instead.


Note [Case 2: CSEing case binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The second kind of CSE opportunity we aim for is more interesting, and
came up in #9291 and #5344: The Haskell code

    foo :: Either Int a -&gt; Either Bool a
    foo (Right x) = Right x
    foo _         = Left False

produces this Core

    foo :: forall a. Either Int a -&gt; Either Bool a
    foo @a e = case e of b { Left n -&gt; &#8230;
                           , Right x -&gt; Right @Bool @a x }

where we cannot CSE `Right @Bool @a x` with the case binder `b` as they have
different types. But in STG we have

    foo [e] = case e of b { Left [n] -&gt; &#8230;
                          , Right [x] -&gt; Right [x] }

and nothing stops us from transforming that to

    foo [e] = case e of b { Left [n] -&gt; &#8230;
                          , Right [x] -&gt; b}


Note [StgCse after unarisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider two unboxed sum terms:

    (# 1 | #) :: (# Int | Int# #)
    (# 1 | #) :: (# Int | Int  #)

These two terms are not equal as they unarise to different unboxed
tuples. However if we run StgCse before Unarise, it'll think the two
terms (# 1 | #) are equal, and replace one of these with a binder to
the other. That's bad -- Trac #15300.

Solution: do unarise first.

-}</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">StgCse</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#stgCse"><span class="hs-identifier hs-var">stgCse</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">DataCon</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Id</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><a href="StgSyn.html"><span class="hs-identifier">StgSyn</span></a><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Outputable</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">VarEnv</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreSyn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">AltCon</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapAccumL</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">CoreMap</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">NameEnv</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;=&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>
</span><a name="line-103"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- The Trie --</span><span>
</span><a name="line-105"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">-- A lookup trie for data constructor applications, i.e.</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- keys of type `(DataCon, [StgArg])`, following the patterns in TrieMap.</span><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-keyword">data</span><span> </span><a name="StgArgMap"><a href="StgCse.html#StgArgMap"><span class="hs-identifier">StgArgMap</span></a></a><span> </span><a name="local-6989586621680676367"><a href="#local-6989586621680676367"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SAM"><a href="StgCse.html#SAM"><span class="hs-identifier">SAM</span></a></a><span>
</span><a name="line-111"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="sam_var"><a href="StgCse.html#sam_var"><span class="hs-identifier">sam_var</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DVarEnv</span><span> </span><a href="#local-6989586621680676367"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-112"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sam_lit"><a href="StgCse.html#sam_lit"><span class="hs-identifier">sam_lit</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">LiteralMap</span><span> </span><a href="#local-6989586621680676367"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">TrieMap</span><span> </span><a href="StgCse.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-116"></a><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Key</span><span> </span><a href="StgCse.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span>
</span><a name="line-117"></a><span>    </span><a name="local-8214565720323799152"><span class="hs-identifier">emptyTM</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#SAM"><span class="hs-identifier hs-var">SAM</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyTM</span><span>
</span><a name="line-118"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyTM</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-119"></a><span>    </span><a name="local-8214565720323799151"><span class="hs-identifier">lookupTM</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621680676376"><a href="#local-6989586621680676376"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-operator hs-var">&gt;.&gt;</span><span> </span><span class="hs-identifier hs-var">lkDFreeVar</span><span> </span><a href="#local-6989586621680676376"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-120"></a><span>    </span><span class="hs-identifier">lookupTM</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621680676377"><a href="#local-6989586621680676377"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-operator hs-var">&gt;.&gt;</span><span> </span><span class="hs-identifier hs-var">lookupTM</span><span> </span><a href="#local-6989586621680676377"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-121"></a><span>    </span><a name="local-8214565720323799150"><span class="hs-identifier">alterTM</span></a><span>  </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621680676378"><a href="#local-6989586621680676378"><span class="hs-identifier">var</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680676379"><a href="#local-6989586621680676379"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680676380"><a href="#local-6989586621680676380"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676380"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><a href="#local-6989586621680676380"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">|&gt;</span><span> </span><span class="hs-identifier hs-var">xtDFreeVar</span><span> </span><a href="#local-6989586621680676378"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680676379"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-122"></a><span>    </span><span class="hs-identifier">alterTM</span><span>  </span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621680676381"><a href="#local-6989586621680676381"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680676382"><a href="#local-6989586621680676382"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680676383"><a href="#local-6989586621680676383"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676383"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><a href="#local-6989586621680676383"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">|&gt;</span><span> </span><span class="hs-identifier hs-var">alterTM</span><span> </span><a href="#local-6989586621680676381"><span class="hs-identifier hs-var">lit</span></a><span> </span><a href="#local-6989586621680676382"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-123"></a><span>    </span><a name="local-8214565720323799148"><span class="hs-identifier">foldTM</span></a><span> </span><a name="local-6989586621680676384"><a href="#local-6989586621680676384"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621680676385"><a href="#local-6989586621680676385"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldTM</span><span> </span><a href="#local-6989586621680676384"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sam_var</span><span> </span><a href="#local-6989586621680676385"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">foldTM</span><span> </span><a href="#local-6989586621680676384"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">sam_lit</span><span> </span><a href="#local-6989586621680676385"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>    </span><a name="local-8214565720323799149"><span class="hs-identifier">mapTM</span></a><span> </span><a name="local-6989586621680676386"><a href="#local-6989586621680676386"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#SAM"><span class="hs-identifier hs-var">SAM</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680676387"><a href="#local-6989586621680676387"><span class="hs-identifier">varm</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680676388"><a href="#local-6989586621680676388"><span class="hs-identifier">litm</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-125"></a><span>        </span><a href="StgCse.html#SAM"><span class="hs-identifier hs-var">SAM</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sam_var</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapTM</span><span> </span><a href="#local-6989586621680676386"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680676387"><span class="hs-identifier hs-var">varm</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">sam_lit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapTM</span><span> </span><a href="#local-6989586621680676386"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680676388"><span class="hs-identifier hs-var">litm</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-keyword">newtype</span><span> </span><a name="ConAppMap"><a href="StgCse.html#ConAppMap"><span class="hs-identifier">ConAppMap</span></a></a><span> </span><a name="local-6989586621680676366"><a href="#local-6989586621680676366"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CAM"><a href="StgCse.html#CAM"><span class="hs-identifier">CAM</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="un_cam"><a href="StgCse.html#un_cam"><span class="hs-identifier">un_cam</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DNameEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ListMap</span><span> </span><a href="StgCse.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a><span> </span><a href="#local-6989586621680676366"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">TrieMap</span><span> </span><a href="StgCse.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-130"></a><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-identifier">Key</span><span> </span><a href="StgCse.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">DataCon</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span>    </span><a name="local-8214565720323799152"><span class="hs-identifier">emptyTM</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#CAM"><span class="hs-identifier hs-var">CAM</span></a><span> </span><span class="hs-identifier hs-var">emptyTM</span><span>
</span><a name="line-132"></a><span>    </span><a name="local-8214565720323799151"><span class="hs-identifier">lookupTM</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680676368"><a href="#local-6989586621680676368"><span class="hs-identifier">dataCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676369"><a href="#local-6989586621680676369"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><span class="hs-operator hs-var">&gt;.&gt;</span><span> </span><span class="hs-identifier hs-var">lkDNamed</span><span> </span><a href="#local-6989586621680676368"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><span class="hs-operator hs-var">&gt;=&gt;</span><span> </span><span class="hs-identifier hs-var">lookupTM</span><span> </span><a href="#local-6989586621680676369"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-133"></a><span>    </span><a name="local-8214565720323799150"><span class="hs-identifier">alterTM</span></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621680676370"><a href="#local-6989586621680676370"><span class="hs-identifier">dataCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676371"><a href="#local-6989586621680676371"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680676372"><a href="#local-6989586621680676372"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680676373"><a href="#local-6989586621680676373"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-134"></a><span>        </span><a href="#local-6989586621680676373"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><a href="#local-6989586621680676373"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">|&gt;</span><span> </span><span class="hs-identifier hs-var">xtDNamed</span><span> </span><a href="#local-6989586621680676370"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><span class="hs-operator hs-var">|&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">alterTM</span><span> </span><a href="#local-6989586621680676371"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680676372"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-135"></a><span>    </span><a name="local-8214565720323799148"><span class="hs-identifier">foldTM</span></a><span> </span><a name="local-6989586621680676374"><a href="#local-6989586621680676374"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><span class="hs-operator hs-var">&gt;.&gt;</span><span> </span><span class="hs-identifier hs-var">foldTM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldTM</span><span> </span><a href="#local-6989586621680676374"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>    </span><a name="local-8214565720323799149"><span class="hs-identifier">mapTM</span></a><span> </span><a name="local-6989586621680676375"><a href="#local-6989586621680676375"><span class="hs-identifier">f</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">un_cam</span><span> </span><span class="hs-operator hs-var">&gt;.&gt;</span><span> </span><span class="hs-identifier hs-var">mapTM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapTM</span><span> </span><a href="#local-6989586621680676375"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&gt;.&gt;</span><span> </span><a href="StgCse.html#CAM"><span class="hs-identifier hs-var">CAM</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- The CSE Env --</span><span>
</span><a name="line-140"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-comment">-- | The CSE environment. See note [CseEnv Example]</span><span>
</span><a name="line-143"></a><span class="hs-keyword">data</span><span> </span><a name="CseEnv"><a href="StgCse.html#CseEnv"><span class="hs-identifier">CseEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CseEnv"><a href="StgCse.html#CseEnv"><span class="hs-identifier">CseEnv</span></a></a><span>
</span><a name="line-144"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="ce_conAppMap"><a href="StgCse.html#ce_conAppMap"><span class="hs-identifier">ce_conAppMap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a><span> </span><span class="hs-identifier hs-type">OutId</span><span>
</span><a name="line-145"></a><span>        </span><span class="hs-comment">-- ^ The main component of the environment is the trie that maps</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-comment">--   data constructor applications (with their `OutId` arguments)</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-comment">--   to an in-scope name that can be used instead.</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-comment">--   This name is always either a let-bound variable or a case binder.</span><span>
</span><a name="line-149"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="ce_subst"><a href="StgCse.html#ce_subst"><span class="hs-identifier">ce_subst</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-identifier hs-type">OutId</span><span>
</span><a name="line-150"></a><span>        </span><span class="hs-comment">-- ^ This substitution is applied to the code as we traverse it.</span><span>
</span><a name="line-151"></a><span>        </span><span class="hs-comment">--   Entries have one of two reasons:</span><span>
</span><a name="line-152"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-153"></a><span>        </span><span class="hs-comment">--   * The input might have shadowing (see Note [Shadowing]), so we have</span><span>
</span><a name="line-154"></a><span>        </span><span class="hs-comment">--     to rename some binders as we traverse the tree.</span><span>
</span><a name="line-155"></a><span>        </span><span class="hs-comment">--   * If we remove `let x = Con z` because  `let y = Con z` is in scope,</span><span>
</span><a name="line-156"></a><span>        </span><span class="hs-comment">--     we note this here as x &#8614; y.</span><span>
</span><a name="line-157"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="ce_bndrMap"><a href="StgCse.html#ce_bndrMap"><span class="hs-identifier">ce_bndrMap</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IdEnv</span><span> </span><span class="hs-identifier hs-type">OutId</span><span>
</span><a name="line-158"></a><span>        </span><span class="hs-comment">-- ^ If we come across a case expression case x as b of &#8230; with a trivial</span><span>
</span><a name="line-159"></a><span>        </span><span class="hs-comment">--   binder, we add b &#8614; x to this.</span><span>
</span><a name="line-160"></a><span>        </span><span class="hs-comment">--   This map is *only* used when looking something up in the ce_conAppMap.</span><span>
</span><a name="line-161"></a><span>        </span><span class="hs-comment">--   See Note [Trivial case scrutinee]</span><span>
</span><a name="line-162"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="ce_in_scope"><a href="StgCse.html#ce_in_scope"><span class="hs-identifier">ce_in_scope</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span>
</span><a name="line-163"></a><span>        </span><span class="hs-comment">-- ^ The third component is an in-scope set, to rename away any</span><span>
</span><a name="line-164"></a><span>        </span><span class="hs-comment">--   shadowing binders</span><span>
</span><a name="line-165"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-comment">{-|
Note [CseEnv Example]
~~~~~~~~~~~~~~~~~~~~~
The following tables shows how the CseEnvironment changes as code is traversed,
as well as the changes to that code.

  InExpr                         OutExpr
     conAppMap                   subst          in_scope
  &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;
  -- empty                       {}             {}
  case &#8230; as a of {Con x y -&gt;     case &#8230; as a of {Con x y -&gt;
  -- Con x y &#8614; a                 {}             {a,x,y}
  let b = Con x y                (removed)
  -- Con x y &#8614; a                 b&#8614;a            {a,x,y,b}
  let c = Bar a                  let c = Bar a
  -- Con x y &#8614; a, Bar a &#8614; c      b&#8614;a            {a,x,y,b,c}
  let c = some expression        let c' = some expression
  -- Con x y &#8614; a, Bar a &#8614; c      b&#8614;a, c&#8614;c',     {a,x,y,b,c,c'}
  let d = Bar b                  (removed)
  -- Con x y &#8614; a, Bar a &#8614; c      b&#8614;a, c&#8614;c', d&#8614;c {a,x,y,b,c,c',d}
  (a, b, c d)                    (a, a, c' c)
-}</span><span>
</span><a name="line-189"></a><span>
</span><a name="line-190"></a><span class="hs-identifier">initEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-191"></a><a name="initEnv"><a href="StgCse.html#initEnv"><span class="hs-identifier">initEnv</span></a></a><span> </span><a name="local-6989586621680676392"><a href="#local-6989586621680676392"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-var">CseEnv</span></a><span>
</span><a name="line-192"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_conAppMap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyTM</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ce_subst</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span>
</span><a name="line-194"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ce_bndrMap</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyVarEnv</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ce_in_scope</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676392"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-196"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-identifier">envLookup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">OutId</span><span>
</span><a name="line-199"></a><a name="envLookup"><a href="StgCse.html#envLookup"><span class="hs-identifier">envLookup</span></a></a><span> </span><a name="local-6989586621680676393"><a href="#local-6989586621680676393"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621680676394"><a href="#local-6989586621680676394"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680676395"><a href="#local-6989586621680676395"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lookupTM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676393"><span class="hs-identifier hs-var">dataCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676396"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_conAppMap</span><span> </span><a href="#local-6989586621680676395"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680676396"><a href="#local-6989586621680676396"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680676397"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680676394"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-comment">-- See Note [Trivial case scrutinee]</span><span>
</span><a name="line-201"></a><span>        </span><a name="local-6989586621680676397"><a href="#local-6989586621680676397"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621680676398"><a href="#local-6989586621680676398"><span class="hs-identifier">v</span></a></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621680676398"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_bndrMap</span><span> </span><a href="#local-6989586621680676395"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676398"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621680676399"><a href="#local-6989586621680676399"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a href="#local-6989586621680676399"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-identifier">addDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DataCon</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- do not bother with nullary data constructors, they are static anyways</span><span>
</span><a name="line-206"></a><a name="addDataCon"><a href="StgCse.html#addDataCon"><span class="hs-identifier">addDataCon</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621680676400"><a href="#local-6989586621680676400"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676400"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-207"></a><span class="hs-identifier">addDataCon</span><span> </span><a name="local-6989586621680676401"><a href="#local-6989586621680676401"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680676402"><a href="#local-6989586621680676402"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621680676403"><a href="#local-6989586621680676403"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680676404"><a href="#local-6989586621680676404"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676404"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_conAppMap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676405"><span class="hs-identifier hs-var">new_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-208"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-209"></a><span>    </span><a name="local-6989586621680676405"><a href="#local-6989586621680676405"><span class="hs-identifier">new_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">insertTM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676402"><span class="hs-identifier hs-var">dataCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676403"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676401"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_conAppMap</span><span> </span><a href="#local-6989586621680676404"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-identifier">forgetCse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-212"></a><a name="forgetCse"><a href="StgCse.html#forgetCse"><span class="hs-identifier">forgetCse</span></a></a><span> </span><a name="local-6989586621680676406"><a href="#local-6989586621680676406"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676406"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_conAppMap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">emptyTM</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-comment">-- See note [Free variables of an StgClosure]</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-identifier">addSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-216"></a><a name="addSubst"><a href="StgCse.html#addSubst"><span class="hs-identifier">addSubst</span></a></a><span> </span><a name="local-6989586621680676407"><a href="#local-6989586621680676407"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680676408"><a href="#local-6989586621680676408"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680676409"><a href="#local-6989586621680676409"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-217"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676409"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_subst</span><span> </span><a href="#local-6989586621680676409"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676407"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680676408"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-identifier">addTrivCaseBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span>
</span><a name="line-220"></a><a name="addTrivCaseBndr"><a href="StgCse.html#addTrivCaseBndr"><span class="hs-identifier">addTrivCaseBndr</span></a></a><span> </span><a name="local-6989586621680676410"><a href="#local-6989586621680676410"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621680676411"><a href="#local-6989586621680676411"><span class="hs-identifier">to</span></a></a><span> </span><a name="local-6989586621680676412"><a href="#local-6989586621680676412"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-221"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676412"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_bndrMap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_bndrMap</span><span> </span><a href="#local-6989586621680676412"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676410"><span class="hs-identifier hs-var">from</span></a><span> </span><a href="#local-6989586621680676411"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-identifier">substArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span class="hs-special">]</span><span>
</span><a name="line-224"></a><a name="substArgs"><a href="StgCse.html#substArgs"><span class="hs-identifier">substArgs</span></a></a><span> </span><a name="local-6989586621680676413"><a href="#local-6989586621680676413"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#substArg"><span class="hs-identifier hs-var">substArg</span></a><span> </span><a href="#local-6989586621680676413"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-identifier">substArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a><span>
</span><a name="line-227"></a><a name="substArg"><a href="StgCse.html#substArg"><span class="hs-identifier">substArg</span></a></a><span> </span><a name="local-6989586621680676414"><a href="#local-6989586621680676414"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a name="local-6989586621680676415"><a href="#local-6989586621680676415"><span class="hs-identifier">from</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#substVar"><span class="hs-identifier hs-var">substVar</span></a><span> </span><a href="#local-6989586621680676414"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676415"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span class="hs-identifier">substArg</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a name="local-6989586621680676416"><a href="#local-6989586621680676416"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a><span> </span><a href="#local-6989586621680676416"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-identifier">substVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span>
</span><a name="line-231"></a><a name="substVar"><a href="StgCse.html#substVar"><span class="hs-identifier">substVar</span></a></a><span> </span><a name="local-6989586621680676417"><a href="#local-6989586621680676417"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680676418"><a href="#local-6989586621680676418"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621680676418"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">lookupVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_subst</span><span> </span><a href="#local-6989586621680676417"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676418"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-232"></a><span>
</span><a name="line-233"></a><span class="hs-comment">-- Functions to enter binders</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span class="hs-comment">-- This is much simpler than the equivalent code in CoreSubst:</span><span>
</span><a name="line-236"></a><span class="hs-comment">--  * We do not substitute type variables, and</span><span>
</span><a name="line-237"></a><span class="hs-comment">--  * There is nothing relevant in IdInfo at this stage</span><span>
</span><a name="line-238"></a><span class="hs-comment">--    that needs substitutions.</span><span>
</span><a name="line-239"></a><span class="hs-comment">-- Therefore, no special treatment for a recursive group is required.</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-identifier">substBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">InId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">OutId</span><span class="hs-special">)</span><span>
</span><a name="line-242"></a><a name="substBndr"><a href="StgCse.html#substBndr"><span class="hs-identifier">substBndr</span></a></a><span> </span><a name="local-6989586621680676419"><a href="#local-6989586621680676419"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680676420"><a href="#local-6989586621680676420"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-243"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676424"><span class="hs-identifier hs-var">new_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676421"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-245"></a><span>    </span><a name="local-6989586621680676421"><a href="#local-6989586621680676421"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">uniqAway</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_in_scope</span><span> </span><a href="#local-6989586621680676419"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676420"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621680676422"><a href="#local-6989586621680676422"><span class="hs-identifier">no_change</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676421"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680676420"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-247"></a><span>    </span><a name="local-6989586621680676423"><a href="#local-6989586621680676423"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676419"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_in_scope</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ce_in_scope</span><span> </span><a href="#local-6989586621680676419"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendInScopeSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680676421"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-248"></a><span>    </span><a name="local-6989586621680676424"><a href="#local-6989586621680676424"><span class="hs-identifier">new_env</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680676422"><span class="hs-identifier hs-var">no_change</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676423"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ce_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">extendVarEnv</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ce_subst</span><span> </span><a href="#local-6989586621680676419"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676420"><span class="hs-identifier hs-var">old_id</span></a><span> </span><a href="#local-6989586621680676421"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-249"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676423"><span class="hs-identifier hs-var">env'</span></a><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-identifier">substBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">InVar</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">OutVar</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-252"></a><a name="substBndrs"><a href="StgCse.html#substBndrs"><span class="hs-identifier">substBndrs</span></a></a><span> </span><a name="local-6989586621680676425"><a href="#local-6989586621680676425"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680676426"><a href="#local-6989586621680676426"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="StgCse.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621680676425"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676426"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span class="hs-identifier">substPairs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">InVar</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676391"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutVar</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676391"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><a name="substPairs"><a href="StgCse.html#substPairs"><span class="hs-identifier">substPairs</span></a></a><span> </span><a name="local-6989586621680676427"><a href="#local-6989586621680676427"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680676428"><a href="#local-6989586621680676428"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621680676429"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680676427"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676428"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680676429"><a href="#local-6989586621680676429"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621680676430"><a href="#local-6989586621680676430"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680676431"><a href="#local-6989586621680676431"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676432"><a href="#local-6989586621680676432"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676433"><a href="#local-6989586621680676433"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676434"><a href="#local-6989586621680676434"><span class="hs-identifier">id'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621680676430"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676431"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-257"></a><span>                         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676433"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676434"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676432"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-comment">-- Main entry point</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-identifier">stgCse</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#InStgTopBinding"><span class="hs-identifier hs-type">InStgTopBinding</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#OutStgTopBinding"><span class="hs-identifier hs-type">OutStgTopBinding</span></a><span class="hs-special">]</span><span>
</span><a name="line-262"></a><a name="stgCse"><a href="StgCse.html#stgCse"><span class="hs-identifier">stgCse</span></a></a><span> </span><a name="local-6989586621680676435"><a href="#local-6989586621680676435"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="StgCse.html#stgCseTopLvl"><span class="hs-identifier hs-var">stgCseTopLvl</span></a><span> </span><span class="hs-identifier hs-var">emptyInScopeSet</span><span> </span><a href="#local-6989586621680676435"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-comment">-- Top level bindings.</span><span>
</span><a name="line-265"></a><span class="hs-comment">--</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- We do not CSE these, as top-level closures are allocated statically anyways.</span><span>
</span><a name="line-267"></a><span class="hs-comment">-- Also, they might be exported.</span><span>
</span><a name="line-268"></a><span class="hs-comment">-- But we still have to collect the set of in-scope variables, otherwise</span><span>
</span><a name="line-269"></a><span class="hs-comment">-- uniqAway might shadow a top-level closure.</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span class="hs-identifier">stgCseTopLvl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgTopBinding"><span class="hs-identifier hs-type">InStgTopBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">InScopeSet</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#OutStgTopBinding"><span class="hs-identifier hs-type">OutStgTopBinding</span></a><span class="hs-special">)</span><span>
</span><a name="line-272"></a><a name="stgCseTopLvl"><a href="StgCse.html#stgCseTopLvl"><span class="hs-identifier">stgCseTopLvl</span></a></a><span> </span><a name="local-6989586621680676436"><a href="#local-6989586621680676436"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621680676437"><a href="#local-6989586621680676437"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="StgSyn.html#StgTopStringLit"><span class="hs-identifier hs-var">StgTopStringLit</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676436"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676437"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span class="hs-identifier">stgCseTopLvl</span><span> </span><a name="local-6989586621680676438"><a href="#local-6989586621680676438"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621680676439"><a href="#local-6989586621680676439"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680676440"><a href="#local-6989586621680676440"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-274"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676441"><span class="hs-identifier hs-var">in_scope'</span></a><span>
</span><a name="line-275"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a href="#local-6989586621680676439"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#stgCseTopLvlRhs"><span class="hs-identifier hs-var">stgCseTopLvlRhs</span></a><span> </span><a href="#local-6989586621680676438"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621680676440"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680676441"><a href="#local-6989586621680676441"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676438"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendInScopeSet</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680676439"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-identifier">stgCseTopLvl</span><span> </span><a name="local-6989586621680676442"><a href="#local-6989586621680676442"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621680676443"><a href="#local-6989586621680676443"><span class="hs-identifier">eqs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-279"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680676444"><span class="hs-identifier hs-var">in_scope'</span></a><span>
</span><a name="line-280"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676446"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="StgCse.html#stgCseTopLvlRhs"><span class="hs-identifier hs-var">stgCseTopLvlRhs</span></a><span> </span><a href="#local-6989586621680676444"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><a href="#local-6989586621680676447"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676446"><a href="#local-6989586621680676446"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676447"><a href="#local-6989586621680676447"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680676443"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680676444"><a href="#local-6989586621680676444"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676442"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">extendInScopeSetList</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621680676445"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676445"><a href="#local-6989586621680676445"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680676443"><span class="hs-identifier hs-var">eqs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-identifier">stgCseTopLvlRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">InScopeSet</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a><span>
</span><a name="line-284"></a><a name="stgCseTopLvlRhs"><a href="StgCse.html#stgCseTopLvlRhs"><span class="hs-identifier">stgCseTopLvlRhs</span></a></a><span> </span><a name="local-6989586621680676448"><a href="#local-6989586621680676448"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621680676449"><a href="#local-6989586621680676449"><span class="hs-identifier">ext</span></a></a><span> </span><a name="local-6989586621680676450"><a href="#local-6989586621680676450"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621680676451"><a href="#local-6989586621680676451"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621680676452"><a href="#local-6989586621680676452"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680676453"><a href="#local-6989586621680676453"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680676454"><a href="#local-6989586621680676454"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><span class="hs-special">(</span><a href="StgCse.html#initEnv"><span class="hs-identifier hs-var">initEnv</span></a><span> </span><a href="#local-6989586621680676448"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676453"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-286"></a><span>      </span><span class="hs-keyword">in</span><span>  </span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a href="#local-6989586621680676449"><span class="hs-identifier hs-var">ext</span></a><span> </span><a href="#local-6989586621680676450"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621680676451"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621680676452"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621680676454"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-287"></a><span class="hs-identifier">stgCseTopLvlRhs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621680676455"><a href="#local-6989586621680676455"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621680676456"><a href="#local-6989586621680676456"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621680676457"><a href="#local-6989586621680676457"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a href="#local-6989586621680676455"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621680676456"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621680676457"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-291"></a><span class="hs-comment">-- The actual AST traversal --</span><span>
</span><a name="line-292"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">-- Trivial cases</span><span>
</span><a name="line-295"></a><span class="hs-identifier">stgCseExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgExpr"><span class="hs-identifier hs-type">InStgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#OutStgExpr"><span class="hs-identifier hs-type">OutStgExpr</span></a><span>
</span><a name="line-296"></a><a name="stgCseExpr"><a href="StgCse.html#stgCseExpr"><span class="hs-identifier">stgCseExpr</span></a></a><span> </span><a name="local-6989586621680676458"><a href="#local-6989586621680676458"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621680676459"><a href="#local-6989586621680676459"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621680676460"><a href="#local-6989586621680676460"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621680676461"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621680676462"><span class="hs-identifier hs-var">args'</span></a><span>
</span><a name="line-298"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680676461"><a href="#local-6989586621680676461"><span class="hs-identifier">fun'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substVar"><span class="hs-identifier hs-var">substVar</span></a><span> </span><a href="#local-6989586621680676458"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676459"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-299"></a><span>        </span><a name="local-6989586621680676462"><a href="#local-6989586621680676462"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a><span> </span><a href="#local-6989586621680676458"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676460"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-300"></a><span class="hs-identifier">stgCseExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a name="local-6989586621680676463"><a href="#local-6989586621680676463"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a><span> </span><a href="#local-6989586621680676463"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-302"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621680676464"><a href="#local-6989586621680676464"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a name="local-6989586621680676465"><a href="#local-6989586621680676465"><span class="hs-identifier">op</span></a></a><span> </span><a name="local-6989586621680676466"><a href="#local-6989586621680676466"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680676467"><a href="#local-6989586621680676467"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a><span> </span><a href="#local-6989586621680676465"><span class="hs-identifier hs-var">op</span></a><span> </span><a href="#local-6989586621680676468"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621680676467"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-304"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680676468"><a href="#local-6989586621680676468"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a><span> </span><a href="#local-6989586621680676464"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676466"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-305"></a><span class="hs-identifier">stgCseExpr</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLam"><span class="hs-identifier hs-var">StgLam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pprPanic</span><span> </span><span class="hs-string">&quot;stgCseExp&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">text</span><span> </span><span class="hs-string">&quot;StgLam&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621680676469"><a href="#local-6989586621680676469"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a name="local-6989586621680676470"><a href="#local-6989586621680676470"><span class="hs-identifier">tick</span></a></a><span> </span><a name="local-6989586621680676471"><a href="#local-6989586621680676471"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680676472"><a href="#local-6989586621680676472"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621680676469"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676471"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-309"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="StgSyn.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a><span> </span><a href="#local-6989586621680676470"><span class="hs-identifier hs-var">tick</span></a><span> </span><a href="#local-6989586621680676472"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-310"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621680676473"><a href="#local-6989586621680676473"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a name="local-6989586621680676474"><a href="#local-6989586621680676474"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680676475"><a href="#local-6989586621680676475"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680676476"><a href="#local-6989586621680676476"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680676477"><a href="#local-6989586621680676477"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#mkStgCase"><span class="hs-identifier hs-var">mkStgCase</span></a><span> </span><a href="#local-6989586621680676478"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621680676480"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621680676476"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680676482"><span class="hs-identifier hs-var">alts'</span></a><span>
</span><a name="line-312"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-313"></a><span>    </span><a name="local-6989586621680676478"><a href="#local-6989586621680676478"><span class="hs-identifier">scrut'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621680676473"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676474"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-314"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680676479"><a href="#local-6989586621680676479"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676480"><a href="#local-6989586621680676480"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621680676473"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676475"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-315"></a><span>    </span><a name="local-6989586621680676481"><a href="#local-6989586621680676481"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621680676483"><a href="#local-6989586621680676483"><span class="hs-identifier">trivial_scrut</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680676478"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#addTrivCaseBndr"><span class="hs-identifier hs-var">addTrivCaseBndr</span></a><span> </span><a href="#local-6989586621680676475"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680676483"><span class="hs-identifier hs-var">trivial_scrut</span></a><span> </span><a href="#local-6989586621680676479"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-316"></a><span>                 </span><span class="hs-comment">-- See Note [Trivial case scrutinee]</span><span>
</span><a name="line-317"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676479"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-318"></a><span>    </span><a name="local-6989586621680676482"><a href="#local-6989586621680676482"><span class="hs-identifier">alts'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#stgCseAlt"><span class="hs-identifier hs-var">stgCseAlt</span></a><span> </span><a href="#local-6989586621680676481"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621680676476"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680676480"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676477"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-comment">-- A constructor application.</span><span>
</span><a name="line-322"></a><span class="hs-comment">-- To be removed by a variable use when found in the CSE environment</span><span>
</span><a name="line-323"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621680676484"><a href="#local-6989586621680676484"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a name="local-6989586621680676485"><a href="#local-6989586621680676485"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621680676486"><a href="#local-6989586621680676486"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680676487"><a href="#local-6989586621680676487"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680676489"><a href="#local-6989586621680676489"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCse.html#envLookup"><span class="hs-identifier hs-var">envLookup</span></a><span> </span><a href="#local-6989586621680676485"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621680676488"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621680676484"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-325"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a href="#local-6989586621680676489"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-326"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-327"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a><span> </span><a href="#local-6989586621680676485"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621680676488"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621680676487"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-328"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680676488"><a href="#local-6989586621680676488"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a><span> </span><a href="#local-6989586621680676484"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676486"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span class="hs-comment">-- Let bindings</span><span>
</span><a name="line-331"></a><span class="hs-comment">-- The binding might be removed due to CSE (we do not want trivial bindings on</span><span>
</span><a name="line-332"></a><span class="hs-comment">-- the STG level), so use the smart constructor `mkStgLet` to remove the binding</span><span>
</span><a name="line-333"></a><span class="hs-comment">-- if empty.</span><span>
</span><a name="line-334"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621680676490"><a href="#local-6989586621680676490"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span> </span><a name="local-6989586621680676491"><a href="#local-6989586621680676491"><span class="hs-identifier">ext</span></a></a><span> </span><a name="local-6989586621680676492"><a href="#local-6989586621680676492"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621680676493"><a href="#local-6989586621680676493"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676494"><a href="#local-6989586621680676494"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676495"><a href="#local-6989586621680676495"><span class="hs-identifier">env'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseBind"><span class="hs-identifier hs-var">stgCseBind</span></a><span> </span><a href="#local-6989586621680676490"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676492"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-336"></a><span>          </span><a name="local-6989586621680676496"><a href="#local-6989586621680676496"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621680676495"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621680676493"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-337"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="StgCse.html#mkStgLet"><span class="hs-identifier hs-var">mkStgLet</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a><span> </span><a href="#local-6989586621680676491"><span class="hs-identifier hs-var">ext</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676494"><span class="hs-identifier hs-var">binds'</span></a><span> </span><a href="#local-6989586621680676496"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-338"></a><span class="hs-identifier">stgCseExpr</span><span> </span><a name="local-6989586621680676497"><a href="#local-6989586621680676497"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span> </span><a name="local-6989586621680676498"><a href="#local-6989586621680676498"><span class="hs-identifier">ext</span></a></a><span> </span><a name="local-6989586621680676499"><a href="#local-6989586621680676499"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621680676500"><a href="#local-6989586621680676500"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676501"><a href="#local-6989586621680676501"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676502"><a href="#local-6989586621680676502"><span class="hs-identifier">env'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseBind"><span class="hs-identifier hs-var">stgCseBind</span></a><span> </span><a href="#local-6989586621680676497"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676499"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-340"></a><span>          </span><a name="local-6989586621680676503"><a href="#local-6989586621680676503"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621680676502"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621680676500"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-341"></a><span>      </span><span class="hs-keyword">in</span><span> </span><a href="StgCse.html#mkStgLet"><span class="hs-identifier hs-var">mkStgLet</span></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a><span> </span><a href="#local-6989586621680676498"><span class="hs-identifier hs-var">ext</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676501"><span class="hs-identifier hs-var">binds'</span></a><span> </span><a href="#local-6989586621680676503"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-comment">-- Case alternatives</span><span>
</span><a name="line-344"></a><span class="hs-comment">-- Extend the CSE environment</span><span>
</span><a name="line-345"></a><span class="hs-identifier">stgCseAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgAlt"><span class="hs-identifier hs-type">InStgAlt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#OutStgAlt"><span class="hs-identifier hs-type">OutStgAlt</span></a><span>
</span><a name="line-346"></a><a name="stgCseAlt"><a href="StgCse.html#stgCseAlt"><span class="hs-identifier">stgCseAlt</span></a></a><span> </span><a name="local-6989586621680676504"><a href="#local-6989586621680676504"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680676505"><a href="#local-6989586621680676505"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680676506"><a href="#local-6989586621680676506"><span class="hs-identifier">case_bndr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a name="local-6989586621680676507"><a href="#local-6989586621680676507"><span class="hs-identifier">dataCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676508"><a href="#local-6989586621680676508"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676509"><a href="#local-6989586621680676509"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676510"><a href="#local-6989586621680676510"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676511"><a href="#local-6989586621680676511"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621680676504"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676508"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-348"></a><span>          </span><a name="local-6989586621680676512"><a href="#local-6989586621680676512"><span class="hs-identifier">env2</span></a></a><span>
</span><a name="line-349"></a><span>            </span><span class="hs-comment">-- To avoid dealing with unboxed sums StgCse runs after unarise and</span><span>
</span><a name="line-350"></a><span>            </span><span class="hs-comment">-- should maintain invariants listed in Note [Post-unarisation</span><span>
</span><a name="line-351"></a><span>            </span><span class="hs-comment">-- invariants]. One of the invariants is that some binders are not</span><span>
</span><a name="line-352"></a><span>            </span><span class="hs-comment">-- used (unboxed tuple case binders) which is what we check with</span><span>
</span><a name="line-353"></a><span>            </span><span class="hs-comment">-- `stgCaseBndrInScope` here. If the case binder is not in scope we</span><span>
</span><a name="line-354"></a><span>            </span><span class="hs-comment">-- don't add it to the CSE env. See also #15300.</span><span>
</span><a name="line-355"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="StgSyn.html#stgCaseBndrInScope"><span class="hs-identifier hs-var">stgCaseBndrInScope</span></a><span> </span><a href="#local-6989586621680676505"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- CSE runs after unarise</span><span>
</span><a name="line-356"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#addDataCon"><span class="hs-identifier hs-var">addDataCon</span></a><span> </span><a href="#local-6989586621680676506"><span class="hs-identifier hs-var">case_bndr</span></a><span> </span><a href="#local-6989586621680676507"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="StgSyn.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a><span> </span><a href="#local-6989586621680676511"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680676510"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-357"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-358"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676510"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-359"></a><span>            </span><span class="hs-comment">-- see note [Case 2: CSEing case binders]</span><span>
</span><a name="line-360"></a><span>          </span><a name="local-6989586621680676513"><a href="#local-6989586621680676513"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621680676512"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621680676509"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-361"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DataAlt</span><span> </span><a href="#local-6989586621680676507"><span class="hs-identifier hs-var">dataCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676511"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676513"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span class="hs-identifier">stgCseAlt</span><span> </span><a name="local-6989586621680676514"><a href="#local-6989586621680676514"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676515"><a href="#local-6989586621680676515"><span class="hs-identifier">altCon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676516"><a href="#local-6989586621680676516"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676517"><a href="#local-6989586621680676517"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-363"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676518"><a href="#local-6989586621680676518"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676519"><a href="#local-6989586621680676519"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621680676514"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676516"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-364"></a><span>          </span><a name="local-6989586621680676520"><a href="#local-6989586621680676520"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621680676518"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621680676517"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-365"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676515"><span class="hs-identifier hs-var">altCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676519"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676520"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-comment">-- Bindings</span><span>
</span><a name="line-368"></a><span class="hs-identifier">stgCseBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgBinding"><span class="hs-identifier hs-type">InStgBinding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="StgSyn.html#OutStgBinding"><span class="hs-identifier hs-type">OutStgBinding</span></a><span class="hs-special">,</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-369"></a><a name="stgCseBind"><a href="StgCse.html#stgCseBind"><span class="hs-identifier">stgCseBind</span></a></a><span> </span><a name="local-6989586621680676521"><a href="#local-6989586621680676521"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a name="local-6989586621680676522"><a href="#local-6989586621680676522"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621680676523"><a href="#local-6989586621680676523"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676524"><a href="#local-6989586621680676524"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676525"><a href="#local-6989586621680676525"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621680676521"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676522"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-371"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="StgCse.html#stgCseRhs"><span class="hs-identifier hs-var">stgCseRhs</span></a><span> </span><a href="#local-6989586621680676524"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621680676525"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621680676523"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-372"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>      </span><a name="local-6989586621680676526"><a href="#local-6989586621680676526"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>                </span><a href="#local-6989586621680676526"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676527"><a href="#local-6989586621680676527"><span class="hs-identifier">b2</span></a></a><span class="hs-special">,</span><a name="local-6989586621680676528"><a href="#local-6989586621680676528"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680676529"><a href="#local-6989586621680676529"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a><span> </span><a href="#local-6989586621680676527"><span class="hs-identifier hs-var">b2</span></a><span> </span><a href="#local-6989586621680676528"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676529"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span class="hs-identifier">stgCseBind</span><span> </span><a name="local-6989586621680676530"><a href="#local-6989586621680676530"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a name="local-6989586621680676531"><a href="#local-6989586621680676531"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676532"><a href="#local-6989586621680676532"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676533"><a href="#local-6989586621680676533"><span class="hs-identifier">pairs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substPairs"><span class="hs-identifier hs-var">substPairs</span></a><span> </span><a href="#local-6989586621680676530"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676531"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-376"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="StgCse.html#stgCsePairs"><span class="hs-identifier hs-var">stgCsePairs</span></a><span> </span><a href="#local-6989586621680676532"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621680676533"><span class="hs-identifier hs-var">pairs1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-377"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><a name="local-6989586621680676534"><a href="#local-6989586621680676534"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676534"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680676535"><a href="#local-6989586621680676535"><span class="hs-identifier">pairs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676536"><a href="#local-6989586621680676536"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a><span> </span><a href="#local-6989586621680676535"><span class="hs-identifier hs-var">pairs2</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676536"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span class="hs-identifier">stgCsePairs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutId</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutId</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><a name="stgCsePairs"><a href="StgCse.html#stgCsePairs"><span class="hs-identifier">stgCsePairs</span></a></a><span> </span><a name="local-6989586621680676537"><a href="#local-6989586621680676537"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676537"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span class="hs-identifier">stgCsePairs</span><span> </span><a name="local-6989586621680676538"><a href="#local-6989586621680676538"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621680676539"><a href="#local-6989586621680676539"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621680676540"><a href="#local-6989586621680676540"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621680676541"><a href="#local-6989586621680676541"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676543"><a href="#local-6989586621680676543"><span class="hs-identifier">pairMB</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676544"><a href="#local-6989586621680676544"><span class="hs-identifier">env1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseRhs"><span class="hs-identifier hs-var">stgCseRhs</span></a><span> </span><a href="#local-6989586621680676538"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621680676539"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621680676540"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-384"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680676545"><a href="#local-6989586621680676545"><span class="hs-identifier">pairs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676546"><a href="#local-6989586621680676546"><span class="hs-identifier">env2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCsePairs"><span class="hs-identifier hs-var">stgCsePairs</span></a><span> </span><a href="#local-6989586621680676544"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621680676541"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-385"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676543"><span class="hs-identifier hs-var">pairMB</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621680676542"><span class="hs-identifier hs-var">mbCons</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680676545"><span class="hs-identifier hs-var">pairs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676546"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">)</span><span>
</span><a name="line-386"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-387"></a><span>    </span><a name="local-6989586621680676542"><a href="#local-6989586621680676542"><span class="hs-identifier">mbCons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span class="hs-comment">-- The RHS of a binding.</span><span>
</span><a name="line-390"></a><span class="hs-comment">-- If it is a constructor application, either short-cut it or extend the environment</span><span>
</span><a name="line-391"></a><span class="hs-identifier">stgCseRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">OutId</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="StgCse.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-392"></a><a name="stgCseRhs"><a href="StgCse.html#stgCseRhs"><span class="hs-identifier">stgCseRhs</span></a></a><span> </span><a name="local-6989586621680676547"><a href="#local-6989586621680676547"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680676548"><a href="#local-6989586621680676548"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a name="local-6989586621680676549"><a href="#local-6989586621680676549"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621680676550"><a href="#local-6989586621680676550"><span class="hs-identifier">dataCon</span></a></a><span> </span><a name="local-6989586621680676551"><a href="#local-6989586621680676551"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680676553"><a href="#local-6989586621680676553"><span class="hs-identifier">other_bndr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="StgCse.html#envLookup"><span class="hs-identifier hs-var">envLookup</span></a><span> </span><a href="#local-6989586621680676550"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621680676552"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621680676547"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-394"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680676554"><a href="#local-6989586621680676554"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#addSubst"><span class="hs-identifier hs-var">addSubst</span></a><span> </span><a href="#local-6989586621680676548"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680676553"><span class="hs-identifier hs-var">other_bndr</span></a><span> </span><a href="#local-6989586621680676547"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-395"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676554"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-397"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680676555"><a href="#local-6989586621680676555"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#addDataCon"><span class="hs-identifier hs-var">addDataCon</span></a><span> </span><a href="#local-6989586621680676548"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680676550"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621680676552"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621680676547"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-398"></a><span>            </span><span class="hs-comment">-- see note [Case 1: CSEing allocated closures]</span><span>
</span><a name="line-399"></a><span>          </span><a name="local-6989586621680676556"><a href="#local-6989586621680676556"><span class="hs-identifier">pair</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676548"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a><span> </span><a href="#local-6989586621680676549"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621680676550"><span class="hs-identifier hs-var">dataCon</span></a><span> </span><a href="#local-6989586621680676552"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680676556"><span class="hs-identifier hs-var">pair</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676555"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680676552"><a href="#local-6989586621680676552"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a><span> </span><a href="#local-6989586621680676547"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676551"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-402"></a><span class="hs-identifier">stgCseRhs</span><span> </span><a name="local-6989586621680676557"><a href="#local-6989586621680676557"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680676558"><a href="#local-6989586621680676558"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-special">(</span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a name="local-6989586621680676559"><a href="#local-6989586621680676559"><span class="hs-identifier">ext</span></a></a><span> </span><a name="local-6989586621680676560"><a href="#local-6989586621680676560"><span class="hs-identifier">ccs</span></a></a><span> </span><a name="local-6989586621680676561"><a href="#local-6989586621680676561"><span class="hs-identifier">upd</span></a></a><span> </span><a name="local-6989586621680676562"><a href="#local-6989586621680676562"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621680676563"><a href="#local-6989586621680676563"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680676564"><a href="#local-6989586621680676564"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680676565"><a href="#local-6989586621680676565"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621680676557"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676562"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-404"></a><span>          </span><a name="local-6989586621680676566"><a href="#local-6989586621680676566"><span class="hs-identifier">env2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#forgetCse"><span class="hs-identifier hs-var">forgetCse</span></a><span> </span><a href="#local-6989586621680676564"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-comment">-- See note [Free variables of an StgClosure]</span><span>
</span><a name="line-405"></a><span>          </span><a name="local-6989586621680676567"><a href="#local-6989586621680676567"><span class="hs-identifier">body'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="StgCse.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a><span> </span><a href="#local-6989586621680676566"><span class="hs-identifier hs-var">env2</span></a><span> </span><a href="#local-6989586621680676563"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-406"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="StgCse.html#substVar"><span class="hs-identifier hs-var">substVar</span></a><span> </span><a href="#local-6989586621680676557"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680676558"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a><span> </span><a href="#local-6989586621680676559"><span class="hs-identifier hs-var">ext</span></a><span> </span><a href="#local-6989586621680676560"><span class="hs-identifier hs-var">ccs</span></a><span> </span><a href="#local-6989586621680676561"><span class="hs-identifier hs-var">upd</span></a><span> </span><a href="#local-6989586621680676565"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621680676567"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680676557"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span class="hs-identifier">mkStgCase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="StgSyn.html#StgExpr"><span class="hs-identifier hs-type">StgExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">OutId</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#AltType"><span class="hs-identifier hs-type">AltType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="StgSyn.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="StgSyn.html#StgExpr"><span class="hs-identifier hs-type">StgExpr</span></a><span>
</span><a name="line-410"></a><a name="mkStgCase"><a href="StgCse.html#mkStgCase"><span class="hs-identifier">mkStgCase</span></a></a><span> </span><a name="local-6989586621680676568"><a href="#local-6989586621680676568"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621680676569"><a href="#local-6989586621680676569"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621680676570"><a href="#local-6989586621680676570"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621680676571"><a href="#local-6989586621680676571"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621680676572"><span class="hs-identifier hs-var">isBndr</span></a><span> </span><a href="#local-6989586621680676571"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676568"><span class="hs-identifier hs-var">scrut</span></a><span>
</span><a name="line-411"></a><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="StgSyn.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a><span> </span><a href="#local-6989586621680676568"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621680676569"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621680676570"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621680676571"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-414"></a><span>    </span><span class="hs-comment">-- see Note [All alternatives are the binder]</span><span>
</span><a name="line-415"></a><span>    </span><a name="local-6989586621680676572"><a href="#local-6989586621680676572"><span class="hs-identifier">isBndr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="StgSyn.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a><span> </span><a name="local-6989586621680676573"><a href="#local-6989586621680676573"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676573"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680676569"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-416"></a><span>    </span><span class="hs-identifier">isBndr</span><span> </span><span class="hs-identifier">_</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-417"></a><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span class="hs-comment">-- Utilities</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-comment">-- | This function short-cuts let-bindings that are now obsolete</span><span>
</span><a name="line-422"></a><span class="hs-identifier">mkStgLet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680676389"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680676390"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680676390"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621680676389"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680676390"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680676390"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-423"></a><a name="mkStgLet"><a href="StgCse.html#mkStgLet"><span class="hs-identifier">mkStgLet</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><a name="local-6989586621680676574"><a href="#local-6989586621680676574"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676574"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-424"></a><span class="hs-identifier">mkStgLet</span><span> </span><a name="local-6989586621680676575"><a href="#local-6989586621680676575"><span class="hs-identifier">stgLet</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680676576"><a href="#local-6989586621680676576"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680676577"><a href="#local-6989586621680676577"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680676575"><span class="hs-identifier hs-var">stgLet</span></a><span> </span><a href="#local-6989586621680676576"><span class="hs-identifier hs-var">binds</span></a><span> </span><a href="#local-6989586621680676577"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span>
</span><a name="line-427"></a><span class="hs-comment">{-
Note [All alternatives are the binder]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When all alternatives simply refer to the case binder, then we do not have
to bother with the case expression at all (#13588). CoreSTG does this as well,
but sometimes, types get into the way:

    newtype T = MkT Int
    f :: (Int, Int) -&gt; (T, Int)
    f (x, y) = (MkT x, y)

Core cannot just turn this into

    f p = p

as this would not be well-typed. But to STG, where MkT is no longer in the way,
we can.

Note [Trivial case scrutinee]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to be able to handle nested reconstruction of constructors as in

    nested :: Either Int (Either Int a) -&gt; Either Bool (Either Bool a)
    nested (Right (Right v)) = Right (Right v)
    nested _ = Left True

So if we come across

    case x of r1
      Right a -&gt; case a of r2
              Right b -&gt; let v = Right b
                         in Right v

we first replace v with r2. Next we want to replace Right r2 with r1. But the
ce_conAppMap contains Right a!

Therefore, we add r1 &#8614; x to ce_bndrMap when analysing the outer case, and use
this substitution before looking Right r2 up in ce_conAppMap, and everything
works out.

Note [Free variables of an StgClosure]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
StgClosures (function and thunks) have an explicit list of free variables:

foo [x] =
    let not_a_free_var = Left [x]
    let a_free_var = Right [x]
    let closure = \[x a_free_var] -&gt; \[y] -&gt; bar y (Left [x]) a_free_var
    in closure

If we were to CSE `Left [x]` in the body of `closure` with `not_a_free_var`,
then the list of free variables would be wrong, so for now, we do not CSE
across such a closure, simply because I (Joachim) was not sure about possible
knock-on effects. If deemed safe and worth the slight code complication of
re-calculating this list during or after this pass, this can surely be done.
-}</span><span>
</span><a name="line-484"></a></pre></body></html>