<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-incomplete-patterns #-}</span><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CmmContFlowOpt</span><span>
</span><a name="line-5"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="CmmContFlowOpt.html#cmmCfgOpts"><span class="hs-identifier hs-var">cmmCfgOpts</span></a><span>
</span><a name="line-6"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CmmContFlowOpt.html#cmmCfgOptsProc"><span class="hs-identifier hs-var">cmmCfgOptsProc</span></a><span>
</span><a name="line-7"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CmmContFlowOpt.html#removeUnreachableBlocksProc"><span class="hs-identifier hs-var">removeUnreachableBlocksProc</span></a><span>
</span><a name="line-8"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CmmContFlowOpt.html#replaceLabels"><span class="hs-identifier hs-var">replaceLabels</span></a><span>
</span><a name="line-9"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-10"></a><span class="hs-keyword">where</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GhcPrelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">succ</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unzip</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zip</span><span class="hs-special">)</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Block.html"><span class="hs-identifier">Hoopl.Block</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl.Collections</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Graph.html"><span class="hs-identifier">Hoopl.Graph</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl.Label</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="BlockId.html"><span class="hs-identifier">BlockId</span></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="CmmSwitch.html"><span class="hs-identifier">CmmSwitch</span></a><span> </span><span class="hs-special">(</span><a href="CmmSwitch.html#mapSwitchTargets"><span class="hs-identifier hs-var">mapSwitchTargets</span></a><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Maybes</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Panic</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-comment">-- Note [What is shortcutting]</span><span>
</span><a name="line-30"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-31"></a><span class="hs-comment">--</span><span>
</span><a name="line-32"></a><span class="hs-comment">-- Consider this Cmm code:</span><span>
</span><a name="line-33"></a><span class="hs-comment">--</span><span>
</span><a name="line-34"></a><span class="hs-comment">-- L1: ...</span><span>
</span><a name="line-35"></a><span class="hs-comment">--     goto L2;</span><span>
</span><a name="line-36"></a><span class="hs-comment">-- L2: goto L3;</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- L3: ...</span><span>
</span><a name="line-38"></a><span class="hs-comment">--</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- Here L2 is an empty block and contains only an unconditional branch</span><span>
</span><a name="line-40"></a><span class="hs-comment">-- to L3. In this situation any block that jumps to L2 can jump</span><span>
</span><a name="line-41"></a><span class="hs-comment">-- directly to L3:</span><span>
</span><a name="line-42"></a><span class="hs-comment">--</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- L1: ...</span><span>
</span><a name="line-44"></a><span class="hs-comment">--     goto L3;</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- L2: goto L3;</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- L3: ...</span><span>
</span><a name="line-47"></a><span class="hs-comment">--</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- In this situation we say that we shortcut L2 to L3. One of</span><span>
</span><a name="line-49"></a><span class="hs-comment">-- consequences of shortcutting is that some blocks of code may become</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- unreachable (in the example above this is true for L2).</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-comment">-- Note [Control-flow optimisations]</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-55"></a><span class="hs-comment">--</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- This optimisation does three things:</span><span>
</span><a name="line-57"></a><span class="hs-comment">--</span><span>
</span><a name="line-58"></a><span class="hs-comment">--   - If a block finishes in an unconditional branch to another block</span><span>
</span><a name="line-59"></a><span class="hs-comment">--     and that is the only jump to that block we concatenate the</span><span>
</span><a name="line-60"></a><span class="hs-comment">--     destination block at the end of the current one.</span><span>
</span><a name="line-61"></a><span class="hs-comment">--</span><span>
</span><a name="line-62"></a><span class="hs-comment">--   - If a block finishes in a call whose continuation block is a</span><span>
</span><a name="line-63"></a><span class="hs-comment">--     goto, then we can shortcut the destination, making the</span><span>
</span><a name="line-64"></a><span class="hs-comment">--     continuation block the destination of the goto - but see Note</span><span>
</span><a name="line-65"></a><span class="hs-comment">--     [Shortcut call returns].</span><span>
</span><a name="line-66"></a><span class="hs-comment">--</span><span>
</span><a name="line-67"></a><span class="hs-comment">--   - For any block that is not a call we try to shortcut the</span><span>
</span><a name="line-68"></a><span class="hs-comment">--     destination(s). Additionally, if a block ends with a</span><span>
</span><a name="line-69"></a><span class="hs-comment">--     conditional branch we try to invert the condition.</span><span>
</span><a name="line-70"></a><span class="hs-comment">--</span><span>
</span><a name="line-71"></a><span class="hs-comment">-- Blocks are processed using postorder DFS traversal. A side effect</span><span>
</span><a name="line-72"></a><span class="hs-comment">-- of determining traversal order with a graph search is elimination</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- of any blocks that are unreachable.</span><span>
</span><a name="line-74"></a><span class="hs-comment">--</span><span>
</span><a name="line-75"></a><span class="hs-comment">-- Transformations are improved by working from the end of the graph</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- towards the beginning, because we may be able to perform many</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- shortcuts in one go.</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-comment">-- Note [Shortcut call returns]</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-82"></a><span class="hs-comment">--</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- We are going to maintain the &quot;current&quot; graph (LabelMap CmmBlock) as</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- we go, and also a mapping from BlockId to BlockId, representing</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- continuation labels that we have renamed.  This latter mapping is</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- important because we might shortcut a CmmCall continuation.  For</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- example:</span><span>
</span><a name="line-88"></a><span class="hs-comment">--</span><span>
</span><a name="line-89"></a><span class="hs-comment">--    Sp[0] = L</span><span>
</span><a name="line-90"></a><span class="hs-comment">--    call g returns to L</span><span>
</span><a name="line-91"></a><span class="hs-comment">--    L: goto M</span><span>
</span><a name="line-92"></a><span class="hs-comment">--    M: ...</span><span>
</span><a name="line-93"></a><span class="hs-comment">--</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- So when we shortcut the L block, we need to replace not only</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- the continuation of the call, but also references to L in the</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- code (e.g. the assignment Sp[0] = L):</span><span>
</span><a name="line-97"></a><span class="hs-comment">--</span><span>
</span><a name="line-98"></a><span class="hs-comment">--    Sp[0] = M</span><span>
</span><a name="line-99"></a><span class="hs-comment">--    call g returns to M</span><span>
</span><a name="line-100"></a><span class="hs-comment">--    M: ...</span><span>
</span><a name="line-101"></a><span class="hs-comment">--</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- So we keep track of which labels we have renamed and apply the mapping</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- at the end with replaceLabels.</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-comment">-- Note [Shortcut call returns and proc-points]</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-108"></a><span class="hs-comment">--</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- Consider this code that you might get from a recursive</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- let-no-escape:</span><span>
</span><a name="line-111"></a><span class="hs-comment">--</span><span>
</span><a name="line-112"></a><span class="hs-comment">--       goto L1</span><span>
</span><a name="line-113"></a><span class="hs-comment">--      L1:</span><span>
</span><a name="line-114"></a><span class="hs-comment">--       if (Hp &gt; HpLim) then L2 else L3</span><span>
</span><a name="line-115"></a><span class="hs-comment">--      L2:</span><span>
</span><a name="line-116"></a><span class="hs-comment">--       call stg_gc_noregs returns to L4</span><span>
</span><a name="line-117"></a><span class="hs-comment">--      L4:</span><span>
</span><a name="line-118"></a><span class="hs-comment">--       goto L1</span><span>
</span><a name="line-119"></a><span class="hs-comment">--      L3:</span><span>
</span><a name="line-120"></a><span class="hs-comment">--       ...</span><span>
</span><a name="line-121"></a><span class="hs-comment">--       goto L1</span><span>
</span><a name="line-122"></a><span class="hs-comment">--</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- Then the control-flow optimiser shortcuts L4.  But that turns L1</span><span>
</span><a name="line-124"></a><span class="hs-comment">-- into the call-return proc point, and every iteration of the loop</span><span>
</span><a name="line-125"></a><span class="hs-comment">-- has to shuffle variables to and from the stack.  So we must *not*</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- shortcut L4.</span><span>
</span><a name="line-127"></a><span class="hs-comment">--</span><span>
</span><a name="line-128"></a><span class="hs-comment">-- Moreover not shortcutting call returns is probably fine.  If L4 can</span><span>
</span><a name="line-129"></a><span class="hs-comment">-- concat with its branch target then it will still do so.  And we</span><span>
</span><a name="line-130"></a><span class="hs-comment">-- save some compile time because we don't have to traverse all the</span><span>
</span><a name="line-131"></a><span class="hs-comment">-- code in replaceLabels.</span><span>
</span><a name="line-132"></a><span class="hs-comment">--</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- However, we probably do want to do this if we are splitting proc</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- points, because L1 will be a proc-point anyway, so merging it with</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- L4 reduces the number of proc points.  Unfortunately recursive</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- let-no-escapes won't generate very good code with proc-point</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- splitting on - we should probably compile them to explicitly use</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- the native calling convention instead.</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span class="hs-identifier">cmmCfgOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span>
</span><a name="line-141"></a><a name="cmmCfgOpts"><a href="CmmContFlowOpt.html#cmmCfgOpts"><span class="hs-identifier">cmmCfgOpts</span></a></a><span> </span><a name="local-6989586621680288382"><a href="#local-6989586621680288382"><span class="hs-identifier">split</span></a></a><span> </span><a name="local-6989586621680288383"><a href="#local-6989586621680288383"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><a href="CmmContFlowOpt.html#blockConcat"><span class="hs-identifier hs-var">blockConcat</span></a><span> </span><a href="#local-6989586621680288382"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621680288383"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-identifier">cmmCfgOptsProc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span>
</span><a name="line-144"></a><a name="cmmCfgOptsProc"><a href="CmmContFlowOpt.html#cmmCfgOptsProc"><span class="hs-identifier">cmmCfgOptsProc</span></a></a><span> </span><a name="local-6989586621680288384"><a href="#local-6989586621680288384"><span class="hs-identifier">split</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680288385"><a href="#local-6989586621680288385"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621680288386"><a href="#local-6989586621680288386"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680288387"><a href="#local-6989586621680288387"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621680288388"><a href="#local-6989586621680288388"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621680288391"><span class="hs-identifier hs-var">info'</span></a><span> </span><a href="#local-6989586621680288386"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680288387"><span class="hs-identifier hs-var">live</span></a><span> </span><a href="#local-6989586621680288389"><span class="hs-identifier hs-var">g'</span></a><span>
</span><a name="line-145"></a><span>    </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680288389"><a href="#local-6989586621680288389"><span class="hs-identifier">g'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680288390"><a href="#local-6989586621680288390"><span class="hs-identifier">env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmContFlowOpt.html#blockConcat"><span class="hs-identifier hs-var">blockConcat</span></a><span> </span><a href="#local-6989586621680288384"><span class="hs-identifier hs-var">split</span></a><span> </span><a href="#local-6989586621680288388"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-146"></a><span>          </span><a name="local-6989586621680288391"><a href="#local-6989586621680288391"><span class="hs-identifier">info'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288385"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">info_tbls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288392"><span class="hs-identifier hs-var">new_info_tbls</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-147"></a><span>          </span><a name="local-6989586621680288392"><a href="#local-6989586621680288392"><span class="hs-identifier">new_info_tbls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFromList"><span class="hs-identifier hs-var">mapFromList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680288393"><span class="hs-identifier hs-var">upd_info</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680288385"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span>          </span><span class="hs-comment">-- If we changed any labels, then we have to update the info tables</span><span>
</span><a name="line-150"></a><span>          </span><span class="hs-comment">-- too, except for the top-level info table because that might be</span><span>
</span><a name="line-151"></a><span>          </span><span class="hs-comment">-- referred to by other procs.</span><span>
</span><a name="line-152"></a><span>          </span><a name="local-6989586621680288393"><a href="#local-6989586621680288393"><span class="hs-identifier">upd_info</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680288394"><a href="#local-6989586621680288394"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621680288395"><a href="#local-6989586621680288395"><span class="hs-identifier">info</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288396"><a href="#local-6989586621680288396"><span class="hs-identifier">k'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680288394"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621680288390"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-154"></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288396"><span class="hs-identifier hs-var">k'</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680288396"><span class="hs-identifier hs-var">k'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680288389"><span class="hs-identifier hs-var">g'</span></a><span>
</span><a name="line-155"></a><span>                       </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680288395"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-156"></a><span>                       </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621680288395"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_lbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BlockId.html#infoTblLbl"><span class="hs-identifier hs-var">infoTblLbl</span></a><span> </span><a href="#local-6989586621680288396"><span class="hs-identifier hs-var">k'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-158"></a><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288394"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621680288395"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span class="hs-identifier">cmmCfgOptsProc</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680288397"><a href="#local-6989586621680288397"><span class="hs-identifier">top</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288397"><span class="hs-identifier hs-var">top</span></a><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-identifier">blockConcat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">)</span><span>
</span><a name="line-163"></a><a name="blockConcat"><a href="CmmContFlowOpt.html#blockConcat"><span class="hs-identifier">blockConcat</span></a></a><span> </span><a name="local-6989586621680288398"><a href="#local-6989586621680288398"><span class="hs-identifier">splitting_procs</span></a></a><span> </span><a name="local-6989586621680288399"><a href="#local-6989586621680288399"><span class="hs-identifier">g</span></a></a><span class="hs-glyph">@</span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-var">CmmGraph</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">g_entry</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680288400"><a href="#local-6989586621680288400"><span class="hs-identifier">entry_id</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-164"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CmmContFlowOpt.html#replaceLabels"><span class="hs-identifier hs-var">replaceLabels</span></a><span> </span><a href="#local-6989586621680288406"><span class="hs-identifier hs-var">shortcut_map</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmUtils.html#ofBlockMap"><span class="hs-identifier hs-var">ofBlockMap</span></a><span> </span><a href="#local-6989586621680288401"><span class="hs-identifier hs-var">new_entry</span></a><span> </span><a href="#local-6989586621680288405"><span class="hs-identifier hs-var">new_blocks</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288402"><span class="hs-identifier hs-var">shortcut_map'</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-166"></a><span>     </span><span class="hs-comment">-- We might be able to shortcut the entry BlockId itself.</span><span>
</span><a name="line-167"></a><span>     </span><span class="hs-comment">-- Remember to update the shortcut_map, since we also have to</span><span>
</span><a name="line-168"></a><span>     </span><span class="hs-comment">-- update the info_tbls mapping now.</span><span>
</span><a name="line-169"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621680288401"><a href="#local-6989586621680288401"><span class="hs-identifier">new_entry</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680288402"><a href="#local-6989586621680288402"><span class="hs-identifier">shortcut_map'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288409"><a href="#local-6989586621680288409"><span class="hs-identifier">entry_blk</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680288400"><span class="hs-identifier hs-var">entry_id</span></a><span> </span><a href="#local-6989586621680288405"><span class="hs-identifier hs-var">new_blocks</span></a><span>
</span><a name="line-171"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288410"><a href="#local-6989586621680288410"><span class="hs-identifier">dest</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmContFlowOpt.html#canShortcut"><span class="hs-identifier hs-var">canShortcut</span></a><span> </span><a href="#local-6989586621680288409"><span class="hs-identifier hs-var">entry_blk</span></a><span>
</span><a name="line-172"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288410"><span class="hs-identifier hs-var">dest</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680288400"><span class="hs-identifier hs-var">entry_id</span></a><span> </span><a href="#local-6989586621680288410"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-6989586621680288406"><span class="hs-identifier hs-var">shortcut_map</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-174"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288400"><span class="hs-identifier hs-var">entry_id</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288406"><span class="hs-identifier hs-var">shortcut_map</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span>     </span><span class="hs-comment">-- blocks are sorted in reverse postorder, but we want to go from the exit</span><span>
</span><a name="line-177"></a><span>     </span><span class="hs-comment">-- towards beginning, so we use foldr below.</span><span>
</span><a name="line-178"></a><span>     </span><a name="local-6989586621680288403"><a href="#local-6989586621680288403"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#revPostorder"><span class="hs-identifier hs-var">revPostorder</span></a><span> </span><a href="#local-6989586621680288399"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-179"></a><span>     </span><a name="local-6989586621680288404"><a href="#local-6989586621680288404"><span class="hs-identifier">blockmap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Hoopl.Graph.html#addBlock"><span class="hs-identifier hs-var">addBlock</span></a><span class="hs-special">)</span><span> </span><a href="Hoopl.Graph.html#emptyBody"><span class="hs-identifier hs-var">emptyBody</span></a><span> </span><a href="#local-6989586621680288403"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span>     </span><span class="hs-comment">-- Accumulator contains three components:</span><span>
</span><a name="line-182"></a><span>     </span><span class="hs-comment">--  * map of blocks in a graph</span><span>
</span><a name="line-183"></a><span>     </span><span class="hs-comment">--  * map of shortcut labels. See Note [Shortcut call returns]</span><span>
</span><a name="line-184"></a><span>     </span><span class="hs-comment">--  * map containing number of predecessors for each block. We discard</span><span>
</span><a name="line-185"></a><span>     </span><span class="hs-comment">--    it after we process all blocks.</span><span>
</span><a name="line-186"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621680288405"><a href="#local-6989586621680288405"><span class="hs-identifier">new_blocks</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680288406"><a href="#local-6989586621680288406"><span class="hs-identifier">shortcut_map</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-187"></a><span>           </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621680288408"><span class="hs-identifier hs-var">maybe_concat</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288404"><span class="hs-identifier hs-var">blockmap</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288407"><span class="hs-identifier hs-var">initialBackEdges</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288403"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span>     </span><span class="hs-comment">-- Map of predecessors for initial graph. We increase number of</span><span>
</span><a name="line-190"></a><span>     </span><span class="hs-comment">-- predecessors for entry block by one to denote that it is</span><span>
</span><a name="line-191"></a><span>     </span><span class="hs-comment">-- target of a jump, even if no block in the current graph jumps</span><span>
</span><a name="line-192"></a><span>     </span><span class="hs-comment">-- to it.</span><span>
</span><a name="line-193"></a><span>     </span><a name="local-6989586621680288407"><a href="#local-6989586621680288407"><span class="hs-identifier">initialBackEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmContFlowOpt.html#incPreds"><span class="hs-identifier hs-var">incPreds</span></a><span> </span><a href="#local-6989586621680288400"><span class="hs-identifier hs-var">entry_id</span></a><span> </span><span class="hs-special">(</span><a href="CmmContFlowOpt.html#predMap"><span class="hs-identifier hs-var">predMap</span></a><span> </span><a href="#local-6989586621680288403"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span>     </span><span class="hs-identifier">maybe_concat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span>
</span><a name="line-196"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>     </span><a name="local-6989586621680288408"><a href="#local-6989586621680288408"><span class="hs-identifier">maybe_concat</span></a></a><span> </span><a name="local-6989586621680288411"><a href="#local-6989586621680288411"><span class="hs-identifier">block</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><a name="local-6989586621680288412"><a href="#local-6989586621680288412"><span class="hs-identifier">blocks</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680288413"><a href="#local-6989586621680288413"><span class="hs-identifier">shortcut_map</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680288414"><a href="#local-6989586621680288414"><span class="hs-identifier">backEdges</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-comment">-- If:</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-comment">--   (1) current block ends with unconditional branch to b' and</span><span>
</span><a name="line-201"></a><span>        </span><span class="hs-comment">--   (2) it has exactly one predecessor (namely, current block)</span><span>
</span><a name="line-202"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-203"></a><span>        </span><span class="hs-comment">-- Then:</span><span>
</span><a name="line-204"></a><span>        </span><span class="hs-comment">--   (1) append b' block at the end of current block</span><span>
</span><a name="line-205"></a><span>        </span><span class="hs-comment">--   (2) remove b' from the map of blocks</span><span>
</span><a name="line-206"></a><span>        </span><span class="hs-comment">--   (3) remove information about b' from predecessors map</span><span>
</span><a name="line-207"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-208"></a><span>        </span><span class="hs-comment">-- Since we know that the block has only one predecessor we call</span><span>
</span><a name="line-209"></a><span>        </span><span class="hs-comment">-- mapDelete directly instead of calling decPreds.</span><span>
</span><a name="line-210"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-211"></a><span>        </span><span class="hs-comment">-- Note that we always maintain an up-to-date list of predecessors, so</span><span>
</span><a name="line-212"></a><span>        </span><span class="hs-comment">-- we can ignore the contents of shortcut_map</span><span>
</span><a name="line-213"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a name="local-6989586621680288442"><a href="#local-6989586621680288442"><span class="hs-identifier">b'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680288416"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-214"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288424"><span class="hs-identifier hs-var">hasOnePredecessor</span></a><span> </span><a href="#local-6989586621680288442"><span class="hs-identifier hs-var">b'</span></a><span>
</span><a name="line-215"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288443"><a href="#local-6989586621680288443"><span class="hs-identifier">blk'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680288442"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621680288412"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-216"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680288444"><a href="#local-6989586621680288444"><span class="hs-identifier">bid'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier hs-var">entryLabel</span></a><span> </span><a href="#local-6989586621680288443"><span class="hs-identifier hs-var">blk'</span></a><span>
</span><a name="line-217"></a><span>          </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621680288444"><span class="hs-identifier hs-var">bid'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680288417"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-special">(</span><a href="CmmContFlowOpt.html#splice"><span class="hs-identifier hs-var">splice</span></a><span> </span><a href="#local-6989586621680288415"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-6989586621680288443"><span class="hs-identifier hs-var">blk'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288412"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-218"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288413"><span class="hs-identifier hs-var">shortcut_map</span></a><span>
</span><a name="line-219"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621680288442"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621680288414"><span class="hs-identifier hs-var">backEdges</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span>        </span><span class="hs-comment">-- If:</span><span>
</span><a name="line-222"></a><span>        </span><span class="hs-comment">--   (1) we are splitting proc points (see Note</span><span>
</span><a name="line-223"></a><span>        </span><span class="hs-comment">--       [Shortcut call returns and proc-points]) and</span><span>
</span><a name="line-224"></a><span>        </span><span class="hs-comment">--   (2) current block is a CmmCall or CmmForeignCall with</span><span>
</span><a name="line-225"></a><span>        </span><span class="hs-comment">--       continuation b' and</span><span>
</span><a name="line-226"></a><span>        </span><span class="hs-comment">--   (3) we can shortcut that continuation to dest</span><span>
</span><a name="line-227"></a><span>        </span><span class="hs-comment">-- Then:</span><span>
</span><a name="line-228"></a><span>        </span><span class="hs-comment">--   (1) we change continuation to point to b'</span><span>
</span><a name="line-229"></a><span>        </span><span class="hs-comment">--   (2) create mapping from b' to dest</span><span>
</span><a name="line-230"></a><span>        </span><span class="hs-comment">--   (3) increase number of predecessors of dest by 1</span><span>
</span><a name="line-231"></a><span>        </span><span class="hs-comment">--   (4) decrease number of predecessors of b' by 1</span><span>
</span><a name="line-232"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-233"></a><span>        </span><span class="hs-comment">-- Later we will use replaceLabels to substitute all occurrences of b'</span><span>
</span><a name="line-234"></a><span>        </span><span class="hs-comment">-- with dest.</span><span>
</span><a name="line-235"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680288398"><span class="hs-identifier hs-var">splitting_procs</span></a><span>
</span><a name="line-236"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288445"><a href="#local-6989586621680288445"><span class="hs-identifier">b'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmContFlowOpt.html#callContinuation_maybe"><span class="hs-identifier hs-var">callContinuation_maybe</span></a><span> </span><a href="#local-6989586621680288416"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-237"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288446"><a href="#local-6989586621680288446"><span class="hs-identifier">blk'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680288445"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621680288412"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-238"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288447"><a href="#local-6989586621680288447"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmContFlowOpt.html#canShortcut"><span class="hs-identifier hs-var">canShortcut</span></a><span> </span><a href="#local-6989586621680288446"><span class="hs-identifier hs-var">blk'</span></a><span>
</span><a name="line-239"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680288417"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Block.html#blockJoinTail"><span class="hs-identifier hs-var">blockJoinTail</span></a><span> </span><a href="#local-6989586621680288415"><span class="hs-identifier hs-var">head</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288418"><span class="hs-identifier hs-var">update_cont</span></a><span> </span><a href="#local-6989586621680288447"><span class="hs-identifier hs-var">dest</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288412"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-240"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680288445"><span class="hs-identifier hs-var">b'</span></a><span> </span><a href="#local-6989586621680288447"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-6989586621680288413"><span class="hs-identifier hs-var">shortcut_map</span></a><span>
</span><a name="line-241"></a><span>          </span><span class="hs-special">,</span><span> </span><a href="CmmContFlowOpt.html#decPreds"><span class="hs-identifier hs-var">decPreds</span></a><span> </span><a href="#local-6989586621680288445"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmContFlowOpt.html#incPreds"><span class="hs-identifier hs-var">incPreds</span></a><span> </span><a href="#local-6989586621680288447"><span class="hs-identifier hs-var">dest</span></a><span> </span><a href="#local-6989586621680288414"><span class="hs-identifier hs-var">backEdges</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>        </span><span class="hs-comment">-- If:</span><span>
</span><a name="line-244"></a><span>        </span><span class="hs-comment">--   (1) a block does not end with a call</span><span>
</span><a name="line-245"></a><span>        </span><span class="hs-comment">-- Then:</span><span>
</span><a name="line-246"></a><span>        </span><span class="hs-comment">--   (1) if it ends with a conditional attempt to invert the</span><span>
</span><a name="line-247"></a><span>        </span><span class="hs-comment">--       conditional</span><span>
</span><a name="line-248"></a><span>        </span><span class="hs-comment">--   (2) attempt to shortcut all destination blocks</span><span>
</span><a name="line-249"></a><span>        </span><span class="hs-comment">--   (3) if new successors of a block are different from the old ones</span><span>
</span><a name="line-250"></a><span>        </span><span class="hs-comment">--       update the of predecessors accordingly</span><span>
</span><a name="line-251"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-252"></a><span>        </span><span class="hs-comment">-- A special case of this is a situation when a block ends with an</span><span>
</span><a name="line-253"></a><span>        </span><span class="hs-comment">-- unconditional jump to a block that can be shortcut.</span><span>
</span><a name="line-254"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmContFlowOpt.html#callContinuation_maybe"><span class="hs-identifier hs-var">callContinuation_maybe</span></a><span> </span><a href="#local-6989586621680288416"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-255"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680288448"><a href="#local-6989586621680288448"><span class="hs-identifier">oldSuccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Graph.html#successors"><span class="hs-identifier hs-var">successors</span></a><span> </span><a href="#local-6989586621680288416"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-256"></a><span>              </span><a name="local-6989586621680288449"><a href="#local-6989586621680288449"><span class="hs-identifier">newSuccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Graph.html#successors"><span class="hs-identifier hs-var">successors</span></a><span> </span><a href="#local-6989586621680288420"><span class="hs-identifier hs-var">rewrite_last</span></a><span>
</span><a name="line-257"></a><span>          </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680288417"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Block.html#blockJoinTail"><span class="hs-identifier hs-var">blockJoinTail</span></a><span> </span><a href="#local-6989586621680288415"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-6989586621680288420"><span class="hs-identifier hs-var">rewrite_last</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288412"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-258"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288413"><span class="hs-identifier hs-var">shortcut_map</span></a><span>
</span><a name="line-259"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680288448"><span class="hs-identifier hs-var">oldSuccs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680288449"><span class="hs-identifier hs-var">newSuccs</span></a><span>
</span><a name="line-260"></a><span>               </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680288414"><span class="hs-identifier hs-var">backEdges</span></a><span>
</span><a name="line-261"></a><span>               </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="CmmContFlowOpt.html#incPreds"><span class="hs-identifier hs-var">incPreds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="CmmContFlowOpt.html#decPreds"><span class="hs-identifier hs-var">decPreds</span></a><span> </span><a href="#local-6989586621680288414"><span class="hs-identifier hs-var">backEdges</span></a><span> </span><a href="#local-6989586621680288448"><span class="hs-identifier hs-var">oldSuccs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288449"><span class="hs-identifier hs-var">newSuccs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span>        </span><span class="hs-comment">-- Otherwise don't do anything</span><span>
</span><a name="line-264"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-265"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680288412"><span class="hs-identifier hs-var">blocks</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288413"><span class="hs-identifier hs-var">shortcut_map</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288414"><span class="hs-identifier hs-var">backEdges</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-267"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621680288415"><a href="#local-6989586621680288415"><span class="hs-identifier">head</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680288416"><a href="#local-6989586621680288416"><span class="hs-identifier">last</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockSplitTail"><span class="hs-identifier hs-var">blockSplitTail</span></a><span> </span><a href="#local-6989586621680288411"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-268"></a><span>          </span><a name="local-6989586621680288417"><a href="#local-6989586621680288417"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier hs-var">entryLabel</span></a><span> </span><a href="#local-6989586621680288411"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span>          </span><span class="hs-comment">-- Changes continuation of a call to a specified label</span><span>
</span><a name="line-271"></a><span>          </span><a name="local-6989586621680288418"><a href="#local-6989586621680288418"><span class="hs-identifier">update_cont</span></a></a><span> </span><a name="local-6989586621680288425"><a href="#local-6989586621680288425"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-272"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680288416"><span class="hs-identifier hs-var">last</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-273"></a><span>                </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680288416"><span class="hs-identifier hs-var">last</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680288425"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-274"></a><span>                </span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680288416"><span class="hs-identifier hs-var">last</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">succ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288425"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-275"></a><span>                </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">panic</span><span> </span><span class="hs-string">&quot;Can't shortcut continuation.&quot;</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span>          </span><span class="hs-comment">-- Attempts to shortcut successors of last node</span><span>
</span><a name="line-278"></a><span>          </span><a name="local-6989586621680288419"><a href="#local-6989586621680288419"><span class="hs-identifier">shortcut_last</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#mapSuccessors"><span class="hs-identifier hs-var">mapSuccessors</span></a><span> </span><a href="#local-6989586621680288426"><span class="hs-identifier hs-var">shortcut</span></a><span> </span><a href="#local-6989586621680288416"><span class="hs-identifier hs-var">last</span></a><span>
</span><a name="line-279"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-280"></a><span>              </span><a name="local-6989586621680288426"><a href="#local-6989586621680288426"><span class="hs-identifier">shortcut</span></a></a><span> </span><a name="local-6989586621680288427"><a href="#local-6989586621680288427"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-281"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680288427"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680288412"><span class="hs-identifier hs-var">blocks</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-282"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288428"><a href="#local-6989586621680288428"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288429"><a href="#local-6989586621680288429"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmContFlowOpt.html#canShortcut"><span class="hs-identifier hs-var">canShortcut</span></a><span> </span><a href="#local-6989586621680288428"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680288429"><span class="hs-identifier hs-var">dest</span></a><span>
</span><a name="line-283"></a><span>                   </span><a name="local-6989586621680288430"><a href="#local-6989586621680288430"><span class="hs-identifier">_otherwise</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680288427"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span>          </span><a name="local-6989586621680288420"><a href="#local-6989586621680288420"><span class="hs-identifier">rewrite_last</span></a></a><span>
</span><a name="line-286"></a><span>            </span><span class="hs-comment">-- Sometimes we can get rid of the conditional completely.</span><span>
</span><a name="line-287"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680288431"><a href="#local-6989586621680288431"><span class="hs-identifier">_cond</span></a></a><span> </span><a name="local-6989586621680288432"><a href="#local-6989586621680288432"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680288433"><a href="#local-6989586621680288433"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680288434"><a href="#local-6989586621680288434"><span class="hs-identifier">_l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680288419"><span class="hs-identifier hs-var">shortcut_last</span></a><span>
</span><a name="line-288"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288432"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680288433"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-289"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a href="#local-6989586621680288432"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span>            </span><span class="hs-comment">-- See Note [Invert Cmm conditionals]</span><span>
</span><a name="line-292"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680288435"><a href="#local-6989586621680288435"><span class="hs-identifier">cond</span></a></a><span> </span><a name="local-6989586621680288436"><a href="#local-6989586621680288436"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680288437"><a href="#local-6989586621680288437"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680288438"><a href="#local-6989586621680288438"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680288419"><span class="hs-identifier hs-var">shortcut_last</span></a><span>
</span><a name="line-293"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288424"><span class="hs-identifier hs-var">hasOnePredecessor</span></a><span> </span><a href="#local-6989586621680288436"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-comment">-- inverting will make t a fallthrough</span><span>
</span><a name="line-294"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680288421"><span class="hs-identifier hs-var">likelyTrue</span></a><span> </span><a href="#local-6989586621680288438"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288423"><span class="hs-identifier hs-var">numPreds</span></a><span> </span><a href="#local-6989586621680288437"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288439"><a href="#local-6989586621680288439"><span class="hs-identifier">cond'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmExpr.html#maybeInvertCmmExpr"><span class="hs-identifier hs-var">maybeInvertCmmExpr</span></a><span> </span><a href="#local-6989586621680288435"><span class="hs-identifier hs-var">cond</span></a><span>
</span><a name="line-296"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a href="#local-6989586621680288439"><span class="hs-identifier hs-var">cond'</span></a><span> </span><a href="#local-6989586621680288437"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680288436"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288422"><span class="hs-identifier hs-var">invertLikeliness</span></a><span> </span><a href="#local-6989586621680288438"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-299"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288419"><span class="hs-identifier hs-var">shortcut_last</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span>          </span><a name="local-6989586621680288421"><a href="#local-6989586621680288421"><span class="hs-identifier">likelyTrue</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-302"></a><span>          </span><span class="hs-identifier">likelyTrue</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>          </span><span class="hs-identifier">invertLikeliness</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-305"></a><span>          </span><a name="local-6989586621680288422"><a href="#local-6989586621680288422"><span class="hs-identifier">invertLikeliness</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">not</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span>          </span><span class="hs-comment">-- Number of predecessors for a block</span><span>
</span><a name="line-308"></a><span>          </span><a name="local-6989586621680288423"><a href="#local-6989586621680288423"><span class="hs-identifier">numPreds</span></a></a><span> </span><a name="local-6989586621680288440"><a href="#local-6989586621680288440"><span class="hs-identifier">bid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680288440"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621680288414"><span class="hs-identifier hs-var">backEdges</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span>          </span><a name="local-6989586621680288424"><a href="#local-6989586621680288424"><span class="hs-identifier">hasOnePredecessor</span></a></a><span> </span><a name="local-6989586621680288441"><a href="#local-6989586621680288441"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288423"><span class="hs-identifier hs-var">numPreds</span></a><span> </span><a href="#local-6989586621680288441"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">{-
  Note [Invert Cmm conditionals]
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  The native code generator always produces jumps to the true branch.
  Falling through to the false branch is however faster. So we try to
  arrange for that to happen.
  This means we invert the condition if:
  * The likely path will become a fallthrough.
  * We can't guarantee a fallthrough for the false branch but for the
    true branch.

  In some cases it's faster to avoid inverting when the false branch is likely.
  However determining when that is the case is neither easy nor cheap so for
  now we always invert as this produces smaller binaries and code that is
  equally fast on average. (On an i7-6700K)

  TODO:
  There is also the edge case when both branches have multiple predecessors.
  In this case we could assume that we will end up with a jump for BOTH
  branches. In this case it might be best to put the likely path in the true
  branch especially if there are large numbers of predecessors as this saves
  us the jump thats not taken. However I haven't tested this and as of early
  2018 we almost never generate cmm where this would apply.
-}</span><span>
</span><a name="line-336"></a><span>
</span><a name="line-337"></a><span class="hs-comment">-- Functions for incrementing and decrementing number of predecessors. If</span><span>
</span><a name="line-338"></a><span class="hs-comment">-- decrementing would set the predecessor count to 0, we remove entry from the</span><span>
</span><a name="line-339"></a><span class="hs-comment">-- map.</span><span>
</span><a name="line-340"></a><span class="hs-comment">-- Invariant: if a block has no predecessors it should be dropped from the</span><span>
</span><a name="line-341"></a><span class="hs-comment">-- graph because it is unreachable. maybe_concat is constructed to maintain</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- that invariant, but calling replaceLabels may introduce unreachable blocks.</span><span>
</span><a name="line-343"></a><span class="hs-comment">-- We rely on subsequent passes in the Cmm pipeline to remove unreachable</span><span>
</span><a name="line-344"></a><span class="hs-comment">-- blocks.</span><span>
</span><a name="line-345"></a><span class="hs-identifier">incPreds</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">decPreds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-346"></a><a name="incPreds"><a href="CmmContFlowOpt.html#incPreds"><span class="hs-identifier">incPreds</span></a></a><span> </span><a name="local-6989586621680288450"><a href="#local-6989586621680288450"><span class="hs-identifier">bid</span></a></a><span> </span><a name="local-6989586621680288451"><a href="#local-6989586621680288451"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapInsertWith"><span class="hs-identifier hs-var">mapInsertWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288450"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621680288451"><span class="hs-identifier hs-var">edges</span></a><span>
</span><a name="line-347"></a><a name="decPreds"><a href="CmmContFlowOpt.html#decPreds"><span class="hs-identifier">decPreds</span></a></a><span> </span><a name="local-6989586621680288452"><a href="#local-6989586621680288452"><span class="hs-identifier">bid</span></a></a><span> </span><a name="local-6989586621680288453"><a href="#local-6989586621680288453"><span class="hs-identifier">edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680288452"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621680288453"><span class="hs-identifier hs-var">edges</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-348"></a><span>                       </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288454"><a href="#local-6989586621680288454"><span class="hs-identifier">preds</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680288454"><span class="hs-identifier hs-var">preds</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680288452"><span class="hs-identifier hs-var">bid</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288454"><span class="hs-identifier hs-var">preds</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288453"><span class="hs-identifier hs-var">edges</span></a><span>
</span><a name="line-349"></a><span>                       </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Collections.html#mapDelete"><span class="hs-identifier hs-var">mapDelete</span></a><span> </span><a href="#local-6989586621680288452"><span class="hs-identifier hs-var">bid</span></a><span> </span><a href="#local-6989586621680288453"><span class="hs-identifier hs-var">edges</span></a><span>
</span><a name="line-350"></a><span>                       </span><span class="hs-identifier">_</span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680288453"><span class="hs-identifier hs-var">edges</span></a><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-comment">-- Checks if a block consists only of &quot;goto dest&quot;. If it does than we return</span><span>
</span><a name="line-354"></a><span class="hs-comment">-- &quot;Just dest&quot; label. See Note [What is shortcutting]</span><span>
</span><a name="line-355"></a><span class="hs-identifier">canShortcut</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-356"></a><a name="canShortcut"><a href="CmmContFlowOpt.html#canShortcut"><span class="hs-identifier">canShortcut</span></a></a><span> </span><a name="local-6989586621680288455"><a href="#local-6989586621680288455"><span class="hs-identifier">block</span></a></a><span>
</span><a name="line-357"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680288458"><a href="#local-6989586621680288458"><span class="hs-identifier">middle</span></a></a><span class="hs-special">,</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a name="local-6989586621680288459"><a href="#local-6989586621680288459"><span class="hs-identifier">dest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Block.html#blockSplit"><span class="hs-identifier hs-var">blockSplit</span></a><span> </span><a href="#local-6989586621680288455"><span class="hs-identifier hs-var">block</span></a><span>
</span><a name="line-358"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621680288456"><span class="hs-identifier hs-var">dont_care</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hoopl.Block.html#blockToList"><span class="hs-identifier hs-var">blockToList</span></a><span> </span><a href="#local-6989586621680288458"><span class="hs-identifier hs-var">middle</span></a><span>
</span><a name="line-359"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680288459"><span class="hs-identifier hs-var">dest</span></a><span>
</span><a name="line-360"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-361"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-362"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680288456"><a href="#local-6989586621680288456"><span class="hs-identifier">dont_care</span></a></a><span> </span><a href="CmmNode.html#CmmComment"><span class="hs-identifier hs-var">CmmComment</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-363"></a><span>          </span><span class="hs-identifier">dont_care</span><span> </span><a href="CmmNode.html#CmmTick"><span class="hs-identifier hs-var">CmmTick</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-364"></a><span>          </span><span class="hs-identifier">dont_care</span><span> </span><a name="local-6989586621680288457"><a href="#local-6989586621680288457"><span class="hs-identifier">_other</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span class="hs-comment">-- Concatenates two blocks. First one is assumed to be open on exit, the second</span><span>
</span><a name="line-367"></a><span class="hs-comment">-- is assumed to be closed on entry (i.e. it has a label attached to it, which</span><span>
</span><a name="line-368"></a><span class="hs-comment">-- the splice function removes by calling snd on result of blockSplitHead).</span><span>
</span><a name="line-369"></a><span class="hs-identifier">splice</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Block.html#Block"><span class="hs-identifier hs-type">Block</span></a><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span>
</span><a name="line-370"></a><a name="splice"><a href="CmmContFlowOpt.html#splice"><span class="hs-identifier">splice</span></a></a><span> </span><a name="local-6989586621680288460"><a href="#local-6989586621680288460"><span class="hs-identifier">head</span></a></a><span> </span><a name="local-6989586621680288461"><a href="#local-6989586621680288461"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288467"><span class="hs-identifier hs-var">entry</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Block.html#blockJoinHead"><span class="hs-identifier hs-var">blockJoinHead</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680288464"><span class="hs-identifier hs-var">code0</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Block.html#blockAppend"><span class="hs-identifier hs-var">blockAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680288466"><span class="hs-identifier hs-var">code1</span></a><span>
</span><a name="line-371"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span> </span><a name="local-6989586621680288462"><a href="#local-6989586621680288462"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680288463"><a href="#local-6989586621680288463"><span class="hs-identifier">sc0</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680288464"><a href="#local-6989586621680288464"><span class="hs-identifier">code0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockSplitHead"><span class="hs-identifier hs-var">blockSplitHead</span></a><span> </span><a href="#local-6989586621680288460"><span class="hs-identifier hs-var">head</span></a><span>
</span><a name="line-372"></a><span>        </span><span class="hs-special">(</span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621680288465"><a href="#local-6989586621680288465"><span class="hs-identifier">sc1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680288466"><a href="#local-6989586621680288466"><span class="hs-identifier">code1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Block.html#blockSplitHead"><span class="hs-identifier hs-var">blockSplitHead</span></a><span> </span><a href="#local-6989586621680288461"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-373"></a><span>        </span><a name="local-6989586621680288467"><a href="#local-6989586621680288467"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmEntry"><span class="hs-identifier hs-var">CmmEntry</span></a><span> </span><a href="#local-6989586621680288462"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#combineTickScopes"><span class="hs-identifier hs-var">combineTickScopes</span></a><span> </span><a href="#local-6989586621680288463"><span class="hs-identifier hs-var">sc0</span></a><span> </span><a href="#local-6989586621680288465"><span class="hs-identifier hs-var">sc1</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-comment">-- If node is a call with continuation call return Just label of that</span><span>
</span><a name="line-376"></a><span class="hs-comment">-- continuation. Otherwise return Nothing.</span><span>
</span><a name="line-377"></a><span class="hs-identifier">callContinuation_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span>
</span><a name="line-378"></a><a name="callContinuation_maybe"><a href="CmmContFlowOpt.html#callContinuation_maybe"><span class="hs-identifier">callContinuation_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cml_cont</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680288468"><a href="#local-6989586621680288468"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680288468"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-379"></a><span class="hs-identifier">callContinuation_maybe</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">succ</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680288469"><a href="#local-6989586621680288469"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680288469"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-380"></a><span class="hs-identifier">callContinuation_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">-- Map over the CmmGraph, replacing each label with its mapping in the</span><span>
</span><a name="line-384"></a><span class="hs-comment">-- supplied LabelMap.</span><span>
</span><a name="line-385"></a><span class="hs-identifier">replaceLabels</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="BlockId.html#BlockId"><span class="hs-identifier hs-type">BlockId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span>
</span><a name="line-386"></a><a name="replaceLabels"><a href="CmmContFlowOpt.html#replaceLabels"><span class="hs-identifier">replaceLabels</span></a></a><span> </span><a name="local-6989586621680288470"><a href="#local-6989586621680288470"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680288471"><a href="#local-6989586621680288471"><span class="hs-identifier">g</span></a></a><span>
</span><a name="line-387"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Hoopl.Collections.html#mapNull"><span class="hs-identifier hs-var">mapNull</span></a><span> </span><a href="#local-6989586621680288470"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288471"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-388"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288472"><span class="hs-identifier hs-var">replace_eid</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CmmUtils.html#mapGraphNodes1"><span class="hs-identifier hs-var">mapGraphNodes1</span></a><span> </span><a href="#local-6989586621680288474"><span class="hs-identifier hs-var">txnode</span></a><span> </span><a href="#local-6989586621680288471"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-389"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-390"></a><span>     </span><a name="local-6989586621680288472"><a href="#local-6989586621680288472"><span class="hs-identifier">replace_eid</span></a></a><span> </span><a name="local-6989586621680288478"><a href="#local-6989586621680288478"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288478"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">g_entry</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680288478"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><a name="line-391"></a><span>     </span><a name="local-6989586621680288473"><a href="#local-6989586621680288473"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621680288479"><a href="#local-6989586621680288479"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680288479"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621680288470"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">orElse</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680288479"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-392"></a><span>
</span><a name="line-393"></a><span>     </span><span class="hs-identifier">txnode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680288476"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680288477"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680288476"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680288477"><span class="hs-identifier hs-type">x</span></a><span>
</span><a name="line-394"></a><span>     </span><a name="local-6989586621680288474"><a href="#local-6989586621680288474"><span class="hs-identifier">txnode</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a name="local-6989586621680288480"><a href="#local-6989586621680288480"><span class="hs-identifier">bid</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680288480"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">)</span><span>
</span><a name="line-395"></a><span>     </span><span class="hs-identifier">txnode</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a name="local-6989586621680288481"><a href="#local-6989586621680288481"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621680288482"><a href="#local-6989586621680288482"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680288483"><a href="#local-6989586621680288483"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680288484"><a href="#local-6989586621680288484"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-396"></a><span>       </span><a href="CmmContFlowOpt.html#mkCmmCondBranch"><span class="hs-identifier hs-var">mkCmmCondBranch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288475"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621680288481"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680288482"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680288483"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288484"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-397"></a><span>     </span><span class="hs-identifier">txnode</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><a name="local-6989586621680288485"><a href="#local-6989586621680288485"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621680288486"><a href="#local-6989586621680288486"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-398"></a><span>       </span><a href="CmmNode.html#CmmSwitch"><span class="hs-identifier hs-var">CmmSwitch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288475"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621680288485"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CmmSwitch.html#mapSwitchTargets"><span class="hs-identifier hs-var">mapSwitchTargets</span></a><span> </span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680288486"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>     </span><span class="hs-identifier">txnode</span><span> </span><span class="hs-special">(</span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><a name="local-6989586621680288487"><a href="#local-6989586621680288487"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680288488"><a href="#local-6989586621680288488"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621680288489"><a href="#local-6989586621680288489"><span class="hs-identifier">rg</span></a></a><span> </span><a name="local-6989586621680288490"><a href="#local-6989586621680288490"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680288491"><a href="#local-6989586621680288491"><span class="hs-identifier">res</span></a></a><span> </span><a name="local-6989586621680288492"><a href="#local-6989586621680288492"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-400"></a><span>       </span><a href="CmmNode.html#CmmCall"><span class="hs-identifier hs-var">CmmCall</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288475"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621680288487"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftM</span><span> </span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680288488"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288489"><span class="hs-identifier hs-var">rg</span></a><span> </span><a href="#local-6989586621680288490"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680288491"><span class="hs-identifier hs-var">res</span></a><span> </span><a href="#local-6989586621680288492"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-401"></a><span>     </span><span class="hs-identifier">txnode</span><span> </span><a name="local-6989586621680288493"><a href="#local-6989586621680288493"><span class="hs-identifier">fc</span></a></a><span class="hs-glyph">@</span><a href="CmmNode.html#CmmForeignCall"><span class="hs-identifier hs-var">CmmForeignCall</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-402"></a><span>       </span><a href="#local-6989586621680288493"><span class="hs-identifier hs-var">fc</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621680288475"><span class="hs-identifier hs-var">exp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">args</span><span> </span><a href="#local-6989586621680288493"><span class="hs-identifier hs-var">fc</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">succ</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">succ</span><span> </span><a href="#local-6989586621680288493"><span class="hs-identifier hs-var">fc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-403"></a><span>     </span><span class="hs-identifier">txnode</span><span> </span><a name="local-6989586621680288494"><a href="#local-6989586621680288494"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#mapExpDeep"><span class="hs-identifier hs-var">mapExpDeep</span></a><span> </span><a href="#local-6989586621680288475"><span class="hs-identifier hs-var">exp</span></a><span> </span><a href="#local-6989586621680288494"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span>     </span><span class="hs-identifier">exp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span>
</span><a name="line-406"></a><span>     </span><a name="local-6989586621680288475"><a href="#local-6989586621680288475"><span class="hs-identifier">exp</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmBlock"><span class="hs-identifier hs-var">CmmBlock</span></a><span> </span><a name="local-6989586621680288495"><a href="#local-6989586621680288495"><span class="hs-identifier">bid</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmBlock"><span class="hs-identifier hs-var">CmmBlock</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680288495"><span class="hs-identifier hs-var">bid</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>     </span><span class="hs-identifier">exp</span><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><a name="local-6989586621680288496"><a href="#local-6989586621680288496"><span class="hs-identifier">id</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680288497"><a href="#local-6989586621680288497"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmExpr.html#CmmStackSlot"><span class="hs-identifier hs-var">CmmStackSlot</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#Young"><span class="hs-identifier hs-var">Young</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680288473"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680288496"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288497"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-408"></a><span>     </span><span class="hs-identifier">exp</span><span> </span><a name="local-6989586621680288498"><a href="#local-6989586621680288498"><span class="hs-identifier">e</span></a></a><span>                                      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288498"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-409"></a><span>
</span><a name="line-410"></a><span class="hs-identifier">mkCmmCondBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmExpr.html#CmmExpr"><span class="hs-identifier hs-type">CmmExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="Hoopl.Block.html#O"><span class="hs-identifier hs-type">O</span></a><span> </span><a href="Hoopl.Block.html#C"><span class="hs-identifier hs-type">C</span></a><span>
</span><a name="line-411"></a><a name="mkCmmCondBranch"><a href="CmmContFlowOpt.html#mkCmmCondBranch"><span class="hs-identifier">mkCmmCondBranch</span></a></a><span> </span><a name="local-6989586621680288499"><a href="#local-6989586621680288499"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621680288500"><a href="#local-6989586621680288500"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621680288501"><a href="#local-6989586621680288501"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621680288502"><a href="#local-6989586621680288502"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-412"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680288500"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680288501"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="CmmNode.html#CmmBranch"><span class="hs-identifier hs-var">CmmBranch</span></a><span> </span><a href="#local-6989586621680288500"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="CmmNode.html#CmmCondBranch"><span class="hs-identifier hs-var">CmmCondBranch</span></a><span> </span><a href="#local-6989586621680288499"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621680288500"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621680288501"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621680288502"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-comment">-- Build a map from a block to its set of predecessors.</span><span>
</span><a name="line-415"></a><span class="hs-identifier">predMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-416"></a><a name="predMap"><a href="CmmContFlowOpt.html#predMap"><span class="hs-identifier">predMap</span></a></a><span> </span><a name="local-6989586621680288503"><a href="#local-6989586621680288503"><span class="hs-identifier">blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621680288504"><span class="hs-identifier hs-var">add_preds</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621680288503"><span class="hs-identifier hs-var">blocks</span></a><span>
</span><a name="line-417"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-418"></a><span>    </span><a name="local-6989586621680288504"><a href="#local-6989586621680288504"><span class="hs-identifier">add_preds</span></a></a><span> </span><a name="local-6989586621680288505"><a href="#local-6989586621680288505"><span class="hs-identifier">block</span></a></a><span> </span><a name="local-6989586621680288506"><a href="#local-6989586621680288506"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621680288507"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680288506"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Graph.html#successors"><span class="hs-identifier hs-var">successors</span></a><span> </span><a href="#local-6989586621680288505"><span class="hs-identifier hs-var">block</span></a><span class="hs-special">)</span><span>
</span><a name="line-419"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680288507"><a href="#local-6989586621680288507"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621680288508"><a href="#local-6989586621680288508"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680288509"><a href="#local-6989586621680288509"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapInsertWith"><span class="hs-identifier hs-var">mapInsertWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288508"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-number">1</span><span> </span><a href="#local-6989586621680288509"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-comment">-- Removing unreachable blocks</span><span>
</span><a name="line-422"></a><span class="hs-identifier">removeUnreachableBlocksProc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span>
</span><a name="line-423"></a><a name="removeUnreachableBlocksProc"><a href="CmmContFlowOpt.html#removeUnreachableBlocksProc"><span class="hs-identifier">removeUnreachableBlocksProc</span></a></a><span> </span><a name="local-6989586621680288510"><a href="#local-6989586621680288510"><span class="hs-identifier">proc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680288511"><a href="#local-6989586621680288511"><span class="hs-identifier">info</span></a></a><span> </span><a name="local-6989586621680288512"><a href="#local-6989586621680288512"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680288513"><a href="#local-6989586621680288513"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621680288514"><a href="#local-6989586621680288514"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680288519"><span class="hs-identifier hs-var">used_blocks</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">lengthLessThan</span><span class="hs-special">`</span><span> </span><a href="Hoopl.Collections.html#mapSize"><span class="hs-identifier hs-var">mapSize</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#toBlockMap"><span class="hs-identifier hs-var">toBlockMap</span></a><span> </span><a href="#local-6989586621680288514"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-425"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a href="#local-6989586621680288516"><span class="hs-identifier hs-var">info'</span></a><span> </span><a href="#local-6989586621680288512"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680288513"><span class="hs-identifier hs-var">live</span></a><span> </span><a href="#local-6989586621680288515"><span class="hs-identifier hs-var">g'</span></a><span>
</span><a name="line-426"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-427"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288510"><span class="hs-identifier hs-var">proc</span></a><span>
</span><a name="line-428"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-429"></a><span>     </span><a name="local-6989586621680288515"><a href="#local-6989586621680288515"><span class="hs-identifier">g'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#ofBlockList"><span class="hs-identifier hs-var">ofBlockList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680288514"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680288519"><span class="hs-identifier hs-var">used_blocks</span></a><span>
</span><a name="line-430"></a><span>     </span><a name="local-6989586621680288516"><a href="#local-6989586621680288516"><span class="hs-identifier">info'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288511"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">info_tbls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288517"><span class="hs-identifier hs-var">keep_used</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680288511"><span class="hs-identifier hs-var">info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-431"></a><span>             </span><span class="hs-comment">-- Remove any info_tbls for unreachable</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span>     </span><span class="hs-identifier">keep_used</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>
</span><a name="line-434"></a><span>     </span><a name="local-6989586621680288517"><a href="#local-6989586621680288517"><span class="hs-identifier">keep_used</span></a></a><span> </span><a name="local-6989586621680288521"><a href="#local-6989586621680288521"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapFoldlWithKey"><span class="hs-identifier hs-var">mapFoldlWithKey</span></a><span> </span><a href="#local-6989586621680288518"><span class="hs-identifier hs-var">keep</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span> </span><a href="#local-6989586621680288521"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span>     </span><span class="hs-identifier">keep</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#Label"><span class="hs-identifier hs-type">Label</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-type">CmmInfoTable</span></a><span>
</span><a name="line-437"></a><span>     </span><a name="local-6989586621680288518"><a href="#local-6989586621680288518"><span class="hs-identifier">keep</span></a></a><span> </span><a name="local-6989586621680288522"><a href="#local-6989586621680288522"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680288523"><a href="#local-6989586621680288523"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680288524"><a href="#local-6989586621680288524"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680288523"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><a href="Hoopl.Collections.html#setMember"><span class="hs-identifier hs-var">setMember</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680288520"><span class="hs-identifier hs-var">used_lbls</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680288523"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680288524"><span class="hs-identifier hs-var">i</span></a><span> </span><a href="#local-6989586621680288522"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-438"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680288522"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-439"></a><span>
</span><a name="line-440"></a><span>     </span><span class="hs-identifier">used_blocks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmBlock"><span class="hs-identifier hs-type">CmmBlock</span></a><span class="hs-special">]</span><span>
</span><a name="line-441"></a><span>     </span><a name="local-6989586621680288519"><a href="#local-6989586621680288519"><span class="hs-identifier">used_blocks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmUtils.html#revPostorder"><span class="hs-identifier hs-var">revPostorder</span></a><span> </span><a href="#local-6989586621680288514"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>     </span><span class="hs-identifier">used_lbls</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelSet"><span class="hs-identifier hs-type">LabelSet</span></a><span>
</span><a name="line-444"></a><span>     </span><a name="local-6989586621680288520"><a href="#local-6989586621680288520"><span class="hs-identifier">used_lbls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#setFromList"><span class="hs-identifier hs-var">setFromList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier hs-var">entryLabel</span></a><span> </span><a href="#local-6989586621680288519"><span class="hs-identifier hs-var">used_blocks</span></a><span>
</span><a name="line-445"></a></pre></body></html>