<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-comment">{-
-----------------------------------------------------------------------------
--
-- (c) The University of Glasgow 2001-2017
--
-- Finding the compiler's base directory.
--
-----------------------------------------------------------------------------
-}</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">SysTools.BaseDir</span><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="SysTools.BaseDir.html#expandTopDir"><span class="hs-identifier hs-var">expandTopDir</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.BaseDir.html#expandToolDir"><span class="hs-identifier hs-var">expandToolDir</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="SysTools.BaseDir.html#findTopDir"><span class="hs-identifier hs-var">findTopDir</span></a><span class="hs-special">,</span><span> </span><a href="SysTools.BaseDir.html#findToolDir"><span class="hs-identifier hs-var">findToolDir</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="Panic.html"><span class="hs-identifier">Panic</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Environment</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookupEnv</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-comment">-- POSIX</span><span>
</span><a name="line-30"></a><span class="hs-cpp">#if defined(darwin_HOST_OS) || defined(linux_HOST_OS) || defined(freebsd_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Environment</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getExecutablePath</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-34"></a><span class="hs-comment">-- Windows</span><span>
</span><a name="line-35"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Environment</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">getExecutablePath</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">doesDirectoryExist</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-40"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
# if defined(i386_HOST_ARCH)
#  define WINDOWS_CCONV stdcall
# elif defined(x86_64_HOST_ARCH)
#  define WINDOWS_CCONV ccall
# else
#  error Unknown mingw32 arch
# endif
#endif
</span><span>
</span><a name="line-50"></a><span class="hs-comment">{-
Note [topdir: How GHC finds its files]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

GHC needs various support files (library packages, RTS etc), plus
various auxiliary programs (cp, gcc, etc).  It starts by finding topdir,
the root of GHC's support files

On Unix:
  - ghc always has a shell wrapper that passes a -B&lt;dir&gt; option

On Windows:
  - ghc never has a shell wrapper.
  - we can find the location of the ghc binary, which is
        $topdir/&lt;foo&gt;/&lt;something&gt;.exe
    where &lt;something&gt; may be &quot;ghc&quot;, &quot;ghc-stage2&quot;, or similar
  - we strip off the &quot;&lt;foo&gt;/&lt;something&gt;.exe&quot; to leave $topdir.

from topdir we can find package.conf, ghc-asm, etc.


Note [tooldir: How GHC finds mingw and perl on Windows]

GHC has some custom logic on Windows for finding the mingw
toolchain and perl. Depending on whether GHC is built
with the make build system or Hadrian, and on whether we're
running a bindist, we might find the mingw toolchain and perl
either under $topdir/../{mingw, perl}/ or
$topdir/../../{mingw, perl}/.

-}</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-comment">-- | Expand occurrences of the @$topdir@ interpolation in a string.</span><span>
</span><a name="line-83"></a><span class="hs-identifier">expandTopDir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-84"></a><a name="expandTopDir"><a href="SysTools.BaseDir.html#expandTopDir"><span class="hs-identifier">expandTopDir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SysTools.BaseDir.html#expandPathVar"><span class="hs-identifier hs-var">expandPathVar</span></a><span> </span><span class="hs-string">&quot;topdir&quot;</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">-- | Expand occurrences of the @$tooldir@ interpolation in a string</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- on Windows, leave the string untouched otherwise.</span><span>
</span><a name="line-88"></a><span class="hs-identifier">expandToolDir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-89"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">expandToolDir</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">tool_dir</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">expandPathVar</span><span> </span><span class="hs-string">&quot;tooldir&quot;</span><span> </span><span class="hs-identifier">tool_dir</span><span> </span><span class="hs-identifier">s</span><span>
</span><a name="line-91"></a><span class="hs-identifier">expandToolDir</span><span> </span><span class="hs-identifier">Nothing</span><span>         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">panic</span><span> </span><span class="hs-string">&quot;Could not determine $tooldir&quot;</span><span>
</span><a name="line-92"></a><span class="hs-cpp">#else
</span><a name="expandToolDir"><a href="SysTools.BaseDir.html#expandToolDir"><span class="hs-identifier">expandToolDir</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680015071"><a href="#local-6989586621680015071"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680015071"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-94"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- | @expandPathVar var value str@</span><span>
</span><a name="line-97"></a><span class="hs-comment">--</span><span>
</span><a name="line-98"></a><span class="hs-comment">--   replaces occurences of variable @$var@ with @value@ in str.</span><span>
</span><a name="line-99"></a><span class="hs-identifier">expandPathVar</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-100"></a><a name="expandPathVar"><a href="SysTools.BaseDir.html#expandPathVar"><span class="hs-identifier">expandPathVar</span></a></a><span> </span><a name="local-6989586621680015072"><a href="#local-6989586621680015072"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680015073"><a href="#local-6989586621680015073"><span class="hs-identifier">value</span></a></a><span> </span><a name="local-6989586621680015074"><a href="#local-6989586621680015074"><span class="hs-identifier">str</span></a></a><span>
</span><a name="line-101"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680015075"><a href="#local-6989586621680015075"><span class="hs-identifier">str'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">stripPrefix</span><span> </span><span class="hs-special">(</span><span class="hs-char">'$'</span><span class="hs-glyph">:</span><a href="#local-6989586621680015072"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680015074"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-102"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621680015075"><span class="hs-identifier hs-var">str'</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isPathSeparator</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621680015075"><span class="hs-identifier hs-var">str'</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680015073"><span class="hs-identifier hs-var">value</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="SysTools.BaseDir.html#expandPathVar"><span class="hs-identifier hs-var">expandPathVar</span></a><span> </span><a href="#local-6989586621680015072"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680015073"><span class="hs-identifier hs-var">value</span></a><span> </span><a href="#local-6989586621680015075"><span class="hs-identifier hs-var">str'</span></a><span>
</span><a name="line-104"></a><span class="hs-identifier">expandPathVar</span><span> </span><a name="local-6989586621680015076"><a href="#local-6989586621680015076"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680015077"><a href="#local-6989586621680015077"><span class="hs-identifier">value</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680015078"><a href="#local-6989586621680015078"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680015079"><a href="#local-6989586621680015079"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680015078"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="SysTools.BaseDir.html#expandPathVar"><span class="hs-identifier hs-var">expandPathVar</span></a><span> </span><a href="#local-6989586621680015076"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621680015077"><span class="hs-identifier hs-var">value</span></a><span> </span><a href="#local-6989586621680015079"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-105"></a><span class="hs-identifier">expandPathVar</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-comment">-- | Returns a Unix-format path pointing to TopDir.</span><span>
</span><a name="line-108"></a><span class="hs-identifier">findTopDir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-comment">-- Maybe TopDir path (without the '-B' prefix).</span><span>
</span><a name="line-109"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">String</span><span>    </span><span class="hs-comment">-- TopDir (in Unix format '/' separated)</span><span>
</span><a name="line-110"></a><a name="findTopDir"><a href="SysTools.BaseDir.html#findTopDir"><span class="hs-identifier">findTopDir</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680015080"><a href="#local-6989586621680015080"><span class="hs-identifier">minusb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">normalise</span><span> </span><a href="#local-6989586621680015080"><span class="hs-identifier hs-var">minusb</span></a><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span class="hs-identifier">findTopDir</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-112"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- The _GHC_TOP_DIR environment variable can be used to specify</span><span>
</span><a name="line-113"></a><span>         </span><span class="hs-comment">-- the top dir when the -B argument is not specified. It is not</span><span>
</span><a name="line-114"></a><span>         </span><span class="hs-comment">-- intended for use by users, it was added specifically for the</span><span>
</span><a name="line-115"></a><span>         </span><span class="hs-comment">-- purpose of running GHC within GHCi.</span><span>
</span><a name="line-116"></a><span>         </span><a name="local-6989586621680015081"><a href="#local-6989586621680015081"><span class="hs-identifier">maybe_env_top_dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">lookupEnv</span><span> </span><span class="hs-string">&quot;_GHC_TOP_DIR&quot;</span><span>
</span><a name="line-117"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680015081"><span class="hs-identifier hs-var">maybe_env_top_dir</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-118"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680015082"><a href="#local-6989586621680015082"><span class="hs-identifier">env_top_dir</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680015082"><span class="hs-identifier hs-var">env_top_dir</span></a><span>
</span><a name="line-119"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-120"></a><span>                 </span><span class="hs-comment">-- Get directory of executable</span><span>
</span><a name="line-121"></a><span>                 </span><a name="local-6989586621680015083"><a href="#local-6989586621680015083"><span class="hs-identifier">maybe_exec_dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="SysTools.BaseDir.html#getBaseDir"><span class="hs-identifier hs-var">getBaseDir</span></a><span>
</span><a name="line-122"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680015083"><span class="hs-identifier hs-var">maybe_exec_dir</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-123"></a><span>                     </span><span class="hs-comment">-- &quot;Just&quot; on Windows, &quot;Nothing&quot; on unix</span><span>
</span><a name="line-124"></a><span>                     </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-125"></a><span>                         </span><a href="Panic.html#InstallationError"><span class="hs-identifier hs-var">InstallationError</span></a><span> </span><span class="hs-string">&quot;missing -B&lt;dir&gt; option&quot;</span><span>
</span><a name="line-126"></a><span>                     </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680015084"><a href="#local-6989586621680015084"><span class="hs-identifier">dir</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680015084"><span class="hs-identifier hs-var">dir</span></a><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">getBaseDir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span>
</span><a name="line-132"></a><span class="hs-comment">-- locate the &quot;base dir&quot; when given the path</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- to the real ghc executable (as opposed to symlink)</span><span>
</span><a name="line-134"></a><span class="hs-comment">-- that is running this function.</span><span>
</span><a name="line-135"></a><span class="hs-identifier">rootDir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FilePath</span><span>
</span><a name="line-136"></a><span class="hs-identifier">rootDir</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">takeDirectory</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">takeDirectory</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">normalise</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-identifier">getBaseDir</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">p</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-operator">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">rootDir</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">getExecutablePath</span><span>
</span><a name="line-139"></a><span class="hs-cpp">#elif defined(darwin_HOST_OS) || defined(linux_HOST_OS) || defined(freebsd_HOST_OS)
</span><span class="hs-comment">-- on unix, this is a bit more confusing.</span><span>
</span><a name="line-141"></a><span class="hs-comment">-- The layout right now is something like</span><span>
</span><a name="line-142"></a><span class="hs-comment">--</span><span>
</span><a name="line-143"></a><span class="hs-comment">--   /bin/ghc-X.Y.Z &lt;- wrapper script (1)</span><span>
</span><a name="line-144"></a><span class="hs-comment">--   /bin/ghc       &lt;- symlink to wrapper script (2)</span><span>
</span><a name="line-145"></a><span class="hs-comment">--   /lib/ghc-X.Y.Z/bin/ghc &lt;- ghc executable (3)</span><span>
</span><a name="line-146"></a><span class="hs-comment">--   /lib/ghc-X.Y.Z &lt;- $topdir (4)</span><span>
</span><a name="line-147"></a><span class="hs-comment">--</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- As such, we first need to find the absolute location to the</span><span>
</span><a name="line-149"></a><span class="hs-comment">-- binary.</span><span>
</span><a name="line-150"></a><span class="hs-comment">--</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- getExecutablePath will return (3). One takeDirectory will</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- give use /lib/ghc-X.Y.Z/bin, and another will give us (4).</span><span>
</span><a name="line-153"></a><span class="hs-comment">--</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- This of course only works due to the current layout. If</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- the layout is changed, such that we have ghc-X.Y.Z/{bin,lib}</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- this would need to be changed accordingly.</span><span>
</span><a name="line-157"></a><span class="hs-comment">--</span><span>
</span><a name="line-158"></a><a name="getBaseDir"><a href="SysTools.BaseDir.html#getBaseDir"><span class="hs-identifier">getBaseDir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680015085"><a href="#local-6989586621680015085"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680015085"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getExecutablePath</span><span>
</span><a name="line-159"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">getBaseDir</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-161"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- See Note [tooldir: How GHC finds mingw and perl on Windows]</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- Returns @Nothing@ when not on Windows.</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- When called on Windows, it either throws an error when the</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- tooldir can't be located, or returns @Just tooldirpath@.</span><span>
</span><a name="line-167"></a><span class="hs-identifier">findToolDir</span><span>
</span><a name="line-168"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-comment">-- ^ topdir</span><span>
</span><a name="line-169"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">findToolDir</span><span> </span><span class="hs-identifier">top_dir</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">top_dir</span><span> </span><span class="hs-operator">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;..&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">maxDepth</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">3</span><span>
</span><a name="line-173"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>        </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-identifier">path</span><span>
</span><a name="line-175"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">k</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">maxDepth</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">throwGhcExceptionIO</span><span> </span><span class="hs-operator">$</span><span>
</span><a name="line-176"></a><span>              </span><span class="hs-identifier">InstallationError</span><span> </span><span class="hs-string">&quot;could not detect mingw toolchain&quot;</span><span>
</span><a name="line-177"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-178"></a><span>              </span><span class="hs-identifier">oneLevel</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">doesDirectoryExist</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">path</span><span> </span><span class="hs-operator">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;mingw&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>              </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">oneLevel</span><span>
</span><a name="line-180"></a><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">path</span><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">k</span><span class="hs-operator">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">path</span><span> </span><span class="hs-operator">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;..&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span class="hs-cpp">#else
</span><a name="findToolDir"><a href="SysTools.BaseDir.html#findToolDir"><span class="hs-identifier">findToolDir</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-184"></a><span class="hs-cpp">#endif
</span></pre></body></html>