<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- (c) The University of Glasgow, 1997-2006</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns, CPP, MagicHash, UnboxedTuples,
    GeneralizedNewtypeDeriving #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# OPTIONS_GHC -O2 -funbox-strict-fields #-}</span><span>
</span><a name="line-6"></a><span class="hs-comment">-- We always optimise this, otherwise performance of a non-optimised</span><span>
</span><a name="line-7"></a><span class="hs-comment">-- compiler is severely affected</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-comment">-- |</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- There are two principal string types used internally by GHC:</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-comment">-- ['FastString']</span><span>
</span><a name="line-13"></a><span class="hs-comment">--</span><span>
</span><a name="line-14"></a><span class="hs-comment">--   * A compact, hash-consed, representation of character strings.</span><span>
</span><a name="line-15"></a><span class="hs-comment">--   * Comparison is O(1), and you can get a 'Unique.Unique' from them.</span><span>
</span><a name="line-16"></a><span class="hs-comment">--   * Generated by 'fsLit'.</span><span>
</span><a name="line-17"></a><span class="hs-comment">--   * Turn into 'Outputable.SDoc' with 'Outputable.ftext'.</span><span>
</span><a name="line-18"></a><span class="hs-comment">--</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- ['PtrString']</span><span>
</span><a name="line-20"></a><span class="hs-comment">--</span><span>
</span><a name="line-21"></a><span class="hs-comment">--   * Pointer and size of a Latin-1 encoded string.</span><span>
</span><a name="line-22"></a><span class="hs-comment">--   * Practically no operations.</span><span>
</span><a name="line-23"></a><span class="hs-comment">--   * Outputing them is fast.</span><span>
</span><a name="line-24"></a><span class="hs-comment">--   * Generated by 'sLit'.</span><span>
</span><a name="line-25"></a><span class="hs-comment">--   * Turn into 'Outputable.SDoc' with 'Outputable.ptext'</span><span>
</span><a name="line-26"></a><span class="hs-comment">--   * Requires manual memory management.</span><span>
</span><a name="line-27"></a><span class="hs-comment">--     Improper use may lead to memory leaks or dangling pointers.</span><span>
</span><a name="line-28"></a><span class="hs-comment">--   * It assumes Latin-1 as the encoding, therefore it cannot represent</span><span>
</span><a name="line-29"></a><span class="hs-comment">--     arbitrary Unicode strings.</span><span>
</span><a name="line-30"></a><span class="hs-comment">--</span><span>
</span><a name="line-31"></a><span class="hs-comment">-- Use 'PtrString' unless you want the facilities of 'FastString'.</span><span>
</span><a name="line-32"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FastString</span><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-34"></a><span>        </span><span class="hs-comment">-- * ByteString</span><span>
</span><a name="line-35"></a><span>        </span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>        </span><a href="FastString.html#fastZStringToByteString"><span class="hs-identifier hs-var">fastZStringToByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="FastString.html#unsafeMkByteString"><span class="hs-identifier hs-var">unsafeMkByteString</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>        </span><span class="hs-comment">-- * FastZString</span><span>
</span><a name="line-41"></a><span>        </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><a href="FastString.html#hPutFZS"><span class="hs-identifier hs-var">hPutFZS</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>        </span><a href="FastString.html#zString"><span class="hs-identifier hs-var">zString</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>        </span><a href="FastString.html#lengthFZS"><span class="hs-identifier hs-var">lengthFZS</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span>        </span><span class="hs-comment">-- * FastStrings</span><span>
</span><a name="line-47"></a><span>        </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- not abstract, for now.</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span>        </span><span class="hs-comment">-- ** Construction</span><span>
</span><a name="line-50"></a><span>        </span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span class="hs-special">,</span><span>
</span><a name="line-51"></a><span>        </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>        </span><a href="FastString.html#mkFastStringBytes"><span class="hs-identifier hs-var">mkFastStringBytes</span></a><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>        </span><a href="FastString.html#mkFastStringByteList"><span class="hs-identifier hs-var">mkFastStringByteList</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>        </span><a href="FastString.html#mkFastStringForeignPtr"><span class="hs-identifier hs-var">mkFastStringForeignPtr</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>        </span><a href="FastString.html#mkFastString%23"><span class="hs-identifier hs-var">mkFastString#</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>
</span><a name="line-57"></a><span>        </span><span class="hs-comment">-- ** Deconstruction</span><span>
</span><a name="line-58"></a><span>        </span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span class="hs-special">,</span><span>           </span><span class="hs-comment">-- :: FastString -&gt; String</span><span>
</span><a name="line-59"></a><span>        </span><a href="FastString.html#bytesFS"><span class="hs-identifier hs-var">bytesFS</span></a><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- :: FastString -&gt; [Word8]</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span>        </span><span class="hs-comment">-- ** Encoding</span><span>
</span><a name="line-62"></a><span>        </span><a href="FastString.html#zEncodeFS"><span class="hs-identifier hs-var">zEncodeFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span>        </span><span class="hs-comment">-- ** Operations</span><span>
</span><a name="line-65"></a><span>        </span><a href="FastString.html#uniqueOfFS"><span class="hs-identifier hs-var">uniqueOfFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>        </span><a href="FastString.html#lengthFS"><span class="hs-identifier hs-var">lengthFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-67"></a><span>        </span><a href="FastString.html#nullFS"><span class="hs-identifier hs-var">nullFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>        </span><a href="FastString.html#appendFS"><span class="hs-identifier hs-var">appendFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>        </span><a href="FastString.html#headFS"><span class="hs-identifier hs-var">headFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>        </span><a href="FastString.html#tailFS"><span class="hs-identifier hs-var">tailFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>        </span><a href="FastString.html#concatFS"><span class="hs-identifier hs-var">concatFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>        </span><a href="FastString.html#consFS"><span class="hs-identifier hs-var">consFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>        </span><a href="FastString.html#nilFS"><span class="hs-identifier hs-var">nilFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>        </span><a href="FastString.html#isUnderscoreFS"><span class="hs-identifier hs-var">isUnderscoreFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span>        </span><span class="hs-comment">-- ** Outputing</span><span>
</span><a name="line-77"></a><span>        </span><a href="FastString.html#hPutFS"><span class="hs-identifier hs-var">hPutFS</span></a><span class="hs-special">,</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>        </span><span class="hs-comment">-- ** Internal</span><span>
</span><a name="line-80"></a><span>        </span><a href="FastString.html#getFastStringTable"><span class="hs-identifier hs-var">getFastStringTable</span></a><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>        </span><a href="FastString.html#hasZEncoding"><span class="hs-identifier hs-var">hasZEncoding</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>        </span><span class="hs-comment">-- * PtrStrings</span><span>
</span><a name="line-84"></a><span>        </span><a href="FastString.html#PtrString"><span class="hs-identifier hs-type">PtrString</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span>        </span><span class="hs-comment">-- ** Construction</span><span>
</span><a name="line-87"></a><span>        </span><a href="FastString.html#sLit"><span class="hs-identifier hs-var">sLit</span></a><span class="hs-special">,</span><span>
</span><a name="line-88"></a><span>        </span><a href="FastString.html#mkPtrString%23"><span class="hs-identifier hs-var">mkPtrString#</span></a><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>        </span><a href="FastString.html#mkPtrString"><span class="hs-identifier hs-var">mkPtrString</span></a><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>        </span><span class="hs-comment">-- ** Deconstruction</span><span>
</span><a name="line-92"></a><span>        </span><a href="FastString.html#unpackPtrString"><span class="hs-identifier hs-var">unpackPtrString</span></a><span class="hs-special">,</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>        </span><span class="hs-comment">-- ** Operations</span><span>
</span><a name="line-95"></a><span>        </span><a href="FastString.html#lengthPS"><span class="hs-identifier hs-var">lengthPS</span></a><span>
</span><a name="line-96"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><a href="Encoding.html"><span class="hs-identifier">Encoding</span></a><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><a href="FastFunctions.html"><span class="hs-identifier">FastFunctions</span></a><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><a href="Panic.html"><span class="hs-identifier">Panic</span></a><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent.MVar</span><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.DeepSeq</span><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString</span><span>          </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Char8</span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BSC</span><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Internal</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString.Unsafe</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.C</span><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Exts</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO</span><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Data</span><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-120"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>       </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Semigroup</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Semi</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO</span><span>
</span><a name="line-125"></a><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-cpp">#if 0
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Conc.Sync</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">sharedCAF</span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.Base</span><span>         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">unpackCString#</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unpackNBytes#</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">fastStringToByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-136"></a><a name="fastStringToByteString"><a href="FastString.html#fastStringToByteString"><span class="hs-identifier">fastStringToByteString</span></a></a><span> </span><a name="local-6989586621680059228"><a href="#local-6989586621680059228"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fs_bs</span><span> </span><a href="#local-6989586621680059228"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-identifier">fastZStringToByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-139"></a><a name="fastZStringToByteString"><a href="FastString.html#fastZStringToByteString"><span class="hs-identifier">fastZStringToByteString</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><a name="local-6989586621680059229"><a href="#local-6989586621680059229"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059229"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-comment">-- This will drop information if any character &gt; '\xFF'</span><span>
</span><a name="line-142"></a><span class="hs-identifier">unsafeMkByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-143"></a><a name="unsafeMkByteString"><a href="FastString.html#unsafeMkByteString"><span class="hs-identifier">unsafeMkByteString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BSC.pack</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">hashFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-146"></a><a name="hashFastString"><a href="FastString.html#hashFastString"><span class="hs-identifier">hashFastString</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059230"><a href="#local-6989586621680059230"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BS.unsafeUseAsCStringLen</span><span> </span><a href="#local-6989586621680059230"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680059231"><a href="#local-6989586621680059231"><span class="hs-identifier">ptr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059232"><a href="#local-6989586621680059232"><span class="hs-identifier">len</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-148"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FastString.html#hashStr"><span class="hs-identifier hs-var">hashStr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621680059231"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059232"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-keyword">newtype</span><span> </span><a name="FastZString"><a href="FastString.html#FastZString"><span class="hs-identifier">FastZString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FastZString"><a href="FastString.html#FastZString"><span class="hs-identifier">FastZString</span></a></a><span> </span><span class="hs-identifier hs-type">ByteString</span><span>
</span><a name="line-153"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">NFData</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-identifier">hPutFZS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><a name="hPutFZS"><a href="FastString.html#hPutFZS"><span class="hs-identifier">hPutFZS</span></a></a><span> </span><a name="local-6989586621680059233"><a href="#local-6989586621680059233"><span class="hs-identifier">handle</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><a name="local-6989586621680059234"><a href="#local-6989586621680059234"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS.hPut</span><span> </span><a href="#local-6989586621680059233"><span class="hs-identifier hs-var">handle</span></a><span> </span><a href="#local-6989586621680059234"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-157"></a><span>
</span><a name="line-158"></a><span class="hs-identifier">zString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-159"></a><a name="zString"><a href="FastString.html#zString"><span class="hs-identifier">zString</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><a name="local-6989586621680059235"><a href="#local-6989586621680059235"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-160"></a><span>    </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BS.unsafeUseAsCStringLen</span><span> </span><a href="#local-6989586621680059235"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-identifier hs-var">peekCAStringLen</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-identifier">lengthFZS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-163"></a><a name="lengthFZS"><a href="FastString.html#lengthFZS"><span class="hs-identifier">lengthFZS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><a name="local-6989586621680059236"><a href="#local-6989586621680059236"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS.length</span><span> </span><a href="#local-6989586621680059236"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-identifier">mkFastZStringString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span>
</span><a name="line-166"></a><a name="mkFastZStringString"><a href="FastString.html#mkFastZStringString"><span class="hs-identifier">mkFastZStringString</span></a></a><span> </span><a name="local-6989586621680059237"><a href="#local-6989586621680059237"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-var">FastZString</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BSC.pack</span><span> </span><a href="#local-6989586621680059237"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">{-|
A 'FastString' is an array of bytes, hashed to support fast O(1)
comparison.  It is also associated with a character encoding, so that
we know how to convert a 'FastString' to the local encoding, or to the
Z-encoding used by the compiler internally.

'FastString's support a memoized conversion to the Z-encoding via zEncodeFS.
-}</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-keyword">data</span><span> </span><a name="FastString"><a href="FastString.html#FastString"><span class="hs-identifier">FastString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FastString"><a href="FastString.html#FastString"><span class="hs-identifier">FastString</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-180"></a><span>      </span><a name="uniq"><a href="FastString.html#uniq"><span class="hs-identifier">uniq</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- unique id</span><span>
</span><a name="line-181"></a><span>      </span><a name="n_chars"><a href="FastString.html#n_chars"><span class="hs-identifier">n_chars</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- number of chars</span><span>
</span><a name="line-182"></a><span>      </span><a name="fs_bs"><a href="FastString.html#fs_bs"><span class="hs-identifier">fs_bs</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">,</span><span>
</span><a name="line-183"></a><span>      </span><a name="fs_ref"><a href="FastString.html#fs_ref"><span class="hs-identifier">fs_ref</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-187"></a><span>  </span><a name="local-6989586621680059226"><a href="#local-6989586621680059226"><span class="hs-identifier">f1</span></a></a><span> </span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span> </span><a name="local-6989586621680059227"><a href="#local-6989586621680059227"><span class="hs-identifier">f2</span></a></a><span>  </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier">uniq</span><span> </span><a href="#local-6989586621680059226"><span class="hs-identifier hs-var">f1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">uniq</span><span> </span><a href="#local-6989586621680059227"><span class="hs-identifier hs-var">f2</span></a><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-190"></a><span>    </span><span class="hs-comment">-- Compares lexicographically, not by unique</span><span>
</span><a name="line-191"></a><span>    </span><a name="local-6989586621680059212"><a href="#local-6989586621680059212"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-8214565720323790495"><span class="hs-operator">&lt;=</span></a><span> </span><a name="local-6989586621680059213"><a href="#local-6989586621680059213"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621680059212"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680059213"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621680059214"><a href="#local-6989586621680059214"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-8214565720323790500"><span class="hs-operator">&lt;</span></a><span>  </span><a name="local-6989586621680059215"><a href="#local-6989586621680059215"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621680059214"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680059215"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621680059216"><a href="#local-6989586621680059216"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-3458764513820541096"><span class="hs-operator">&gt;=</span></a><span> </span><a name="local-6989586621680059217"><a href="#local-6989586621680059217"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621680059216"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680059217"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">;</span><span>  </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621680059218"><a href="#local-6989586621680059218"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-8214565720323790501"><span class="hs-operator">&gt;</span></a><span>  </span><a name="local-6989586621680059219"><a href="#local-6989586621680059219"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621680059218"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680059219"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-195"></a><span>    </span><a name="local-8214565720323790502"><span class="hs-identifier">max</span></a><span> </span><a name="local-6989586621680059220"><a href="#local-6989586621680059220"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621680059221"><a href="#local-6989586621680059221"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680059220"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="#local-6989586621680059221"><span class="hs-identifier hs-var">y</span></a><span>    </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621680059220"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-196"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621680059221"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-197"></a><span>    </span><a name="local-8214565720323790503"><span class="hs-identifier">min</span></a><span> </span><a name="local-6989586621680059222"><a href="#local-6989586621680059222"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621680059223"><a href="#local-6989586621680059223"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680059222"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-6989586621680059223"><span class="hs-identifier hs-var">y</span></a><span>    </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621680059222"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-198"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621680059223"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-199"></a><span>    </span><a name="local-8214565720323790496"><span class="hs-identifier">compare</span></a><span> </span><a name="local-6989586621680059224"><a href="#local-6989586621680059224"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680059225"><a href="#local-6989586621680059225"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#cmpFS"><span class="hs-identifier hs-var">cmpFS</span></a><span> </span><a href="#local-6989586621680059224"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621680059225"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-200"></a><span>
</span><a name="line-201"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">IsString</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-202"></a><span>    </span><a name="local-3458764513820541114"><span class="hs-identifier">fromString</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Semi.Semigroup</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-205"></a><span>    </span><span class="hs-special">(</span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#appendFS"><span class="hs-identifier hs-var">appendFS</span></a><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-208"></a><span>    </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#nilFS"><span class="hs-identifier hs-var">nilFS</span></a><span>
</span><a name="line-209"></a><span>    </span><a name="local-3458764513820541484"><span class="hs-identifier">mappend</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">Semi.&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>    </span><a name="local-3458764513820541485"><span class="hs-identifier">mconcat</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#concatFS"><span class="hs-identifier hs-var">concatFS</span></a><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-213"></a><span>   </span><a name="local-8214565720323790323"><span class="hs-identifier">show</span></a><span> </span><a name="local-6989586621680059211"><a href="#local-6989586621680059211"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span> </span><a href="#local-6989586621680059211"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Data</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-216"></a><span>  </span><span class="hs-comment">-- don't traverse?</span><span>
</span><a name="line-217"></a><span>  </span><a name="local-8214565720323786785"><span class="hs-identifier">toConstr</span></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#abstractConstr"><span class="hs-identifier hs-var">abstractConstr</span></a><span> </span><span class="hs-string">&quot;FastString&quot;</span><span>
</span><a name="line-218"></a><span>  </span><a name="local-8214565720323786786"><span class="hs-identifier">gunfold</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;gunfold&quot;</span><span>
</span><a name="line-219"></a><span>  </span><a name="local-8214565720323786784"><span class="hs-identifier">dataTypeOf</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkNoRepType</span><span> </span><span class="hs-string">&quot;FastString&quot;</span><span>
</span><a name="line-220"></a><span>
</span><a name="line-221"></a><span class="hs-identifier">cmpFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-222"></a><a name="cmpFS"><a href="FastString.html#cmpFS"><span class="hs-identifier">cmpFS</span></a></a><span> </span><a name="local-6989586621680059238"><a href="#local-6989586621680059238"><span class="hs-identifier">f1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a name="local-6989586621680059239"><a href="#local-6989586621680059239"><span class="hs-identifier">u1</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680059240"><a href="#local-6989586621680059240"><span class="hs-identifier">f2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a name="local-6989586621680059241"><a href="#local-6989586621680059241"><span class="hs-identifier">u2</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-223"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680059239"><span class="hs-identifier hs-var">u1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680059241"><span class="hs-identifier hs-var">u2</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-keyword">else</span><span>
</span><a name="line-224"></a><span>  </span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">(</span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621680059238"><span class="hs-identifier hs-var">f1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621680059240"><span class="hs-identifier hs-var">f2</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;memcmp&quot;</span><span>
</span><a name="line-227"></a><span>  </span><span class="hs-identifier">memcmp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="#local-6989586621680059473"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><a href="#local-6989586621680059474"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-228"></a><span>
</span><a name="line-229"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- Construction</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-comment">{-
Internally, the compiler will maintain a fast string symbol table, providing
sharing and fast comparison. Creation of new @FastString@s then covertly does a
lookup, re-using the @FastString@ if there was a hit.

The design of the FastString hash table allows for lockless concurrent reads
and updates to multiple buckets with low synchronization overhead.

See Note [Updating the FastString table] on how it's updated.
-}</span><span>
</span><a name="line-242"></a><span class="hs-keyword">data</span><span> </span><a name="FastStringTable"><a href="FastString.html#FastStringTable"><span class="hs-identifier">FastStringTable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FastStringTable"><a href="FastString.html#FastStringTable"><span class="hs-identifier">FastStringTable</span></a></a><span>
</span><a name="line-243"></a><span>  </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- the unique ID counter shared with all buckets</span><span>
</span><a name="line-244"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Array#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-type">FastStringTableSegment</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- concurrent segments</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-keyword">data</span><span> </span><a name="FastStringTableSegment"><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier">FastStringTableSegment</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FastStringTableSegment"><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier">FastStringTableSegment</span></a></a><span>
</span><a name="line-247"></a><span>  </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- the lock for write in each segment</span><span>
</span><a name="line-248"></a><span>  </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- the number of elements</span><span>
</span><a name="line-249"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MutableArray#</span><span> </span><span class="hs-identifier hs-type">RealWorld</span><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- buckets in this segment</span><span>
</span><a name="line-250"></a><span>
</span><a name="line-251"></a><span class="hs-comment">{-
Following parameters are determined based on:

* Benchmark based on testsuite/tests/utils/should_run/T14854.hs
* Stats of @echo :browse | ghc --interactive -dfaststring-stats &gt;/dev/null@:
  on 2018-10-24, we have 13920 entries.
-}</span><span>
</span><a name="line-258"></a><span class="hs-identifier">segmentBits</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">numSegments</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">segmentMask</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">initialNumBuckets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-259"></a><a name="segmentBits"><a href="FastString.html#segmentBits"><span class="hs-identifier">segmentBits</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">8</span><span>
</span><a name="line-260"></a><a name="numSegments"><a href="FastString.html#numSegments"><span class="hs-identifier">numSegments</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">256</span><span>   </span><span class="hs-comment">-- bit segmentBits</span><span>
</span><a name="line-261"></a><a name="segmentMask"><a href="FastString.html#segmentMask"><span class="hs-identifier">segmentMask</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0xff</span><span>  </span><span class="hs-comment">-- bit segmentBits - 1</span><span>
</span><a name="line-262"></a><a name="initialNumBuckets"><a href="FastString.html#initialNumBuckets"><span class="hs-identifier">initialNumBuckets</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">64</span><span>
</span><a name="line-263"></a><span>
</span><a name="line-264"></a><span class="hs-identifier">hashToSegment#</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int#</span><span>
</span><a name="line-265"></a><a name="hashToSegment%23"><a href="FastString.html#hashToSegment%23"><span class="hs-identifier">hashToSegment#</span></a></a><span> </span><a name="local-6989586621680059242"><a href="#local-6989586621680059242"><span class="hs-identifier">hash#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059242"><span class="hs-identifier hs-var">hash#</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">andI#</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680059243"><span class="hs-identifier hs-var">segmentMask#</span></a><span>
</span><a name="line-266"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059243"><a href="#local-6989586621680059243"><span class="hs-identifier">segmentMask#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#segmentMask"><span class="hs-identifier hs-var">segmentMask</span></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">hashToIndex#</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MutableArray#</span><span> </span><span class="hs-identifier hs-type">RealWorld</span><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int#</span><span>
</span><a name="line-270"></a><a name="hashToIndex%23"><a href="FastString.html#hashToIndex%23"><span class="hs-identifier">hashToIndex#</span></a></a><span> </span><a name="local-6989586621680059244"><a href="#local-6989586621680059244"><span class="hs-identifier">buckets#</span></a></a><span> </span><a name="local-6989586621680059245"><a href="#local-6989586621680059245"><span class="hs-identifier">hash#</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-special">(</span><a href="#local-6989586621680059245"><span class="hs-identifier hs-var">hash#</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">uncheckedIShiftRL#</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680059246"><span class="hs-identifier hs-var">segmentBits#</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">remInt#</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680059247"><span class="hs-identifier hs-var">size#</span></a><span>
</span><a name="line-272"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-273"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059246"><a href="#local-6989586621680059246"><span class="hs-identifier">segmentBits#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#segmentBits"><span class="hs-identifier hs-var">segmentBits</span></a><span>
</span><a name="line-274"></a><span>    </span><a name="local-6989586621680059247"><a href="#local-6989586621680059247"><span class="hs-identifier">size#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sizeofMutableArray#</span><span> </span><a href="#local-6989586621680059244"><span class="hs-identifier hs-var">buckets#</span></a><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-identifier">maybeResizeSegment</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-type">FastStringTableSegment</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-type">FastStringTableSegment</span></a><span>
</span><a name="line-277"></a><a name="maybeResizeSegment"><a href="FastString.html#maybeResizeSegment"><span class="hs-identifier">maybeResizeSegment</span></a></a><span> </span><a name="local-6989586621680059248"><a href="#local-6989586621680059248"><span class="hs-identifier">segmentRef</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-278"></a><span>  </span><a name="local-6989586621680059249"><a href="#local-6989586621680059249"><span class="hs-identifier">segment</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-var">FastStringTableSegment</span></a><span> </span><a name="local-6989586621680059250"><a href="#local-6989586621680059250"><span class="hs-identifier">lock</span></a></a><span> </span><a name="local-6989586621680059251"><a href="#local-6989586621680059251"><span class="hs-identifier">counter</span></a></a><span> </span><a name="local-6989586621680059252"><a href="#local-6989586621680059252"><span class="hs-identifier">old#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621680059248"><span class="hs-identifier hs-var">segmentRef</span></a><span>
</span><a name="line-279"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059253"><a href="#local-6989586621680059253"><span class="hs-identifier">oldSize#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sizeofMutableArray#</span><span> </span><a href="#local-6989586621680059252"><span class="hs-identifier hs-var">old#</span></a><span>
</span><a name="line-280"></a><span>      </span><a name="local-6989586621680059254"><a href="#local-6989586621680059254"><span class="hs-identifier">newSize#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059253"><span class="hs-identifier hs-var">oldSize#</span></a><span> </span><span class="hs-operator hs-var">*#</span><span> </span><span class="hs-number">2#</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059255"><a href="#local-6989586621680059255"><span class="hs-identifier">n#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621680059251"><span class="hs-identifier hs-var">counter</span></a><span>
</span><a name="line-282"></a><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isTrue#</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059255"><span class="hs-identifier hs-var">n#</span></a><span> </span><span class="hs-operator hs-var">&lt;#</span><span> </span><a href="#local-6989586621680059254"><span class="hs-identifier hs-var">newSize#</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- maximum load of 1</span><span>
</span><a name="line-283"></a><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680059249"><span class="hs-identifier hs-var">segment</span></a><span>
</span><a name="line-284"></a><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-285"></a><span>    </span><a name="local-6989586621680059259"><a href="#local-6989586621680059259"><span class="hs-identifier">resizedSegment</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-var">FastStringTableSegment</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059260"><a href="#local-6989586621680059260"><span class="hs-identifier">new#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059256"><a href="#local-6989586621680059256"><span class="hs-identifier">s1#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-286"></a><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">newArray#</span><span> </span><a href="#local-6989586621680059254"><span class="hs-identifier hs-var">newSize#</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680059256"><span class="hs-identifier hs-var">s1#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-287"></a><span>        </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059257"><a href="#local-6989586621680059257"><span class="hs-identifier">s2#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059258"><a href="#local-6989586621680059258"><span class="hs-identifier">arr#</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621680059257"><span class="hs-identifier hs-var">s2#</span></a><span class="hs-special">,</span><span> </span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-var">FastStringTableSegment</span></a><span> </span><a href="#local-6989586621680059250"><span class="hs-identifier hs-var">lock</span></a><span> </span><a href="#local-6989586621680059251"><span class="hs-identifier hs-var">counter</span></a><span> </span><a href="#local-6989586621680059258"><span class="hs-identifier hs-var">arr#</span></a><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-288"></a><span>    </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a href="#local-6989586621680059253"><span class="hs-identifier hs-var">oldSize#</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059261"><a href="#local-6989586621680059261"><span class="hs-identifier">i#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-289"></a><span>      </span><a name="local-6989586621680059262"><a href="#local-6989586621680059262"><span class="hs-identifier">fsList</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readArray#</span><span> </span><a href="#local-6989586621680059252"><span class="hs-identifier hs-var">old#</span></a><span> </span><a href="#local-6989586621680059261"><span class="hs-identifier hs-var">i#</span></a><span>
</span><a name="line-290"></a><span>      </span><span class="hs-identifier hs-var">forM_</span><span> </span><a href="#local-6989586621680059262"><span class="hs-identifier hs-var">fsList</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059263"><a href="#local-6989586621680059263"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-291"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Shall we store in hash value in FastString instead?</span><span>
</span><a name="line-292"></a><span>            </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059264"><a href="#local-6989586621680059264"><span class="hs-identifier">hash#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#hashFastString"><span class="hs-identifier hs-var">hashFastString</span></a><span> </span><a href="#local-6989586621680059263"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-293"></a><span>            </span><a name="local-6989586621680059265"><a href="#local-6989586621680059265"><span class="hs-identifier">idx#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#hashToIndex%23"><span class="hs-identifier hs-var">hashToIndex#</span></a><span> </span><a href="#local-6989586621680059260"><span class="hs-identifier hs-var">new#</span></a><span> </span><a href="#local-6989586621680059264"><span class="hs-identifier hs-var">hash#</span></a><span>
</span><a name="line-294"></a><span>        </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059266"><a href="#local-6989586621680059266"><span class="hs-identifier">s1#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-295"></a><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">readArray#</span><span> </span><a href="#local-6989586621680059260"><span class="hs-identifier hs-var">new#</span></a><span> </span><a href="#local-6989586621680059265"><span class="hs-identifier hs-var">idx#</span></a><span> </span><a href="#local-6989586621680059266"><span class="hs-identifier hs-var">s1#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-296"></a><span>            </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059267"><a href="#local-6989586621680059267"><span class="hs-identifier">s2#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059268"><a href="#local-6989586621680059268"><span class="hs-identifier">bucket</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">writeArray#</span><span> </span><a href="#local-6989586621680059260"><span class="hs-identifier hs-var">new#</span></a><span> </span><a href="#local-6989586621680059265"><span class="hs-identifier hs-var">idx#</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059263"><span class="hs-identifier hs-var">fs</span></a><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680059268"><span class="hs-identifier hs-var">bucket</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059267"><span class="hs-identifier hs-var">s2#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-297"></a><span>              </span><a name="local-6989586621680059269"><a href="#local-6989586621680059269"><span class="hs-identifier">s3#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621680059269"><span class="hs-identifier hs-var">s3#</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-298"></a><span>    </span><span class="hs-identifier hs-var">writeIORef</span><span> </span><a href="#local-6989586621680059248"><span class="hs-identifier hs-var">segmentRef</span></a><span> </span><a href="#local-6989586621680059259"><span class="hs-identifier hs-var">resizedSegment</span></a><span>
</span><a name="line-299"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680059259"><span class="hs-identifier hs-var">resizedSegment</span></a><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">stringTable</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-302"></a><span class="hs-identifier">stringTable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-type">FastStringTable</span></a><span>
</span><a name="line-303"></a><a name="stringTable"><a href="FastString.html#stringTable"><span class="hs-identifier">stringTable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-304"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059270"><a href="#local-6989586621680059270"><span class="hs-identifier">numSegments#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#numSegments"><span class="hs-identifier hs-var">numSegments</span></a><span>
</span><a name="line-305"></a><span>      </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059271"><a href="#local-6989586621680059271"><span class="hs-identifier">initialNumBuckets#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#initialNumBuckets"><span class="hs-identifier hs-var">initialNumBuckets</span></a><span>
</span><a name="line-306"></a><span>      </span><a name="local-6989586621680059272"><a href="#local-6989586621680059272"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621680059273"><a href="#local-6989586621680059273"><span class="hs-identifier">a#</span></a></a><span> </span><a name="local-6989586621680059274"><a href="#local-6989586621680059274"><span class="hs-identifier">i#</span></a></a><span> </span><a name="local-6989586621680059275"><a href="#local-6989586621680059275"><span class="hs-identifier">s1#</span></a></a><span>
</span><a name="line-307"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTrue#</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059274"><span class="hs-identifier hs-var">i#</span></a><span> </span><span class="hs-operator hs-var">==#</span><span> </span><a href="#local-6989586621680059270"><span class="hs-identifier hs-var">numSegments#</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059275"><span class="hs-identifier hs-var">s1#</span></a><span>
</span><a name="line-308"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unIO</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680059275"><span class="hs-identifier hs-var">s1#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-309"></a><span>            </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059276"><a href="#local-6989586621680059276"><span class="hs-identifier">s2#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059277"><a href="#local-6989586621680059277"><span class="hs-identifier">lock</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unIO</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680059276"><span class="hs-identifier hs-var">s2#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-310"></a><span>              </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059278"><a href="#local-6989586621680059278"><span class="hs-identifier">s3#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059279"><a href="#local-6989586621680059279"><span class="hs-identifier">counter</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">newArray#</span><span> </span><a href="#local-6989586621680059271"><span class="hs-identifier hs-var">initialNumBuckets#</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680059278"><span class="hs-identifier hs-var">s3#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-311"></a><span>                </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059280"><a href="#local-6989586621680059280"><span class="hs-identifier">s4#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059281"><a href="#local-6989586621680059281"><span class="hs-identifier">buckets#</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span>
</span><a name="line-312"></a><span>                    </span><span class="hs-special">(</span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-var">FastStringTableSegment</span></a><span> </span><a href="#local-6989586621680059277"><span class="hs-identifier hs-var">lock</span></a><span> </span><a href="#local-6989586621680059279"><span class="hs-identifier hs-var">counter</span></a><span> </span><a href="#local-6989586621680059281"><span class="hs-identifier hs-var">buckets#</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">unIO</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680059280"><span class="hs-identifier hs-var">s4#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-313"></a><span>                  </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059282"><a href="#local-6989586621680059282"><span class="hs-identifier">s5#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059283"><a href="#local-6989586621680059283"><span class="hs-identifier">segment</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">writeArray#</span><span> </span><a href="#local-6989586621680059273"><span class="hs-identifier hs-var">a#</span></a><span> </span><a href="#local-6989586621680059274"><span class="hs-identifier hs-var">i#</span></a><span> </span><a href="#local-6989586621680059283"><span class="hs-identifier hs-var">segment</span></a><span> </span><a href="#local-6989586621680059282"><span class="hs-identifier hs-var">s5#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-314"></a><span>                    </span><a name="local-6989586621680059284"><a href="#local-6989586621680059284"><span class="hs-identifier">s6#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680059272"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621680059273"><span class="hs-identifier hs-var">a#</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059274"><span class="hs-identifier hs-var">i#</span></a><span> </span><span class="hs-operator hs-var">+#</span><span> </span><span class="hs-number">1#</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059284"><span class="hs-identifier hs-var">s6#</span></a><span>
</span><a name="line-315"></a><span>  </span><a name="local-6989586621680059285"><a href="#local-6989586621680059285"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-number">603979776</span><span> </span><span class="hs-comment">-- ord '$' * 0x01000000</span><span>
</span><a name="line-316"></a><span>  </span><a name="local-6989586621680059292"><a href="#local-6989586621680059292"><span class="hs-identifier">tab</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059286"><a href="#local-6989586621680059286"><span class="hs-identifier">s1#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-317"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">newArray#</span><span> </span><a href="#local-6989586621680059270"><span class="hs-identifier hs-var">numSegments#</span></a><span> </span><span class="hs-special">(</span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;string_table&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059286"><span class="hs-identifier hs-var">s1#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-318"></a><span>      </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059287"><a href="#local-6989586621680059287"><span class="hs-identifier">s2#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059288"><a href="#local-6989586621680059288"><span class="hs-identifier">arr#</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680059272"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621680059288"><span class="hs-identifier hs-var">arr#</span></a><span> </span><span class="hs-number">0#</span><span> </span><a href="#local-6989586621680059287"><span class="hs-identifier hs-var">s2#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-319"></a><span>        </span><a name="local-6989586621680059289"><a href="#local-6989586621680059289"><span class="hs-identifier">s3#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">unsafeFreezeArray#</span><span> </span><a href="#local-6989586621680059288"><span class="hs-identifier hs-var">arr#</span></a><span> </span><a href="#local-6989586621680059289"><span class="hs-identifier hs-var">s3#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-320"></a><span>          </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059290"><a href="#local-6989586621680059290"><span class="hs-identifier">s4#</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059291"><a href="#local-6989586621680059291"><span class="hs-identifier">segments#</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621680059290"><span class="hs-identifier hs-var">s4#</span></a><span class="hs-special">,</span><span> </span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-var">FastStringTable</span></a><span> </span><a href="#local-6989586621680059285"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621680059291"><span class="hs-identifier hs-var">segments#</span></a><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span>  </span><span class="hs-comment">-- use the support wired into the RTS to share this CAF among all images of</span><span>
</span><a name="line-323"></a><span>  </span><span class="hs-comment">-- libHSghc</span><span>
</span><a name="line-324"></a><span class="hs-cpp">#if 1
</span><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680059292"><span class="hs-identifier hs-var">tab</span></a><span>
</span><a name="line-326"></a><span class="hs-cpp">#else
</span><span>  </span><span class="hs-identifier">sharedCAF</span><span> </span><span class="hs-identifier">tab</span><span> </span><span class="hs-identifier">getOrSetLibHSghcFastStringTable</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-comment">-- from the RTS; thus we cannot use this mechanism when STAGE&lt;2; the previous</span><span>
</span><a name="line-330"></a><span class="hs-comment">-- RTS might not have this symbol</span><span>
</span><a name="line-331"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;getOrSetLibHSghcFastStringTable&quot;</span><span>
</span><a name="line-332"></a><span>  </span><span class="hs-identifier">getOrSetLibHSghcFastStringTable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Ptr</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-335"></a><span class="hs-comment">{-

We include the FastString table in the `sharedCAF` mechanism because we'd like
FastStrings created by a Core plugin to have the same uniques as corresponding
strings created by the host compiler itself.  For example, this allows plugins
to lookup known names (eg `mkTcOcc &quot;MySpecialType&quot;`) in the GlobalRdrEnv or
even re-invoke the parser.

In particular, the following little sanity test was failing in a plugin
prototyping safe newtype-coercions: GHC.NT.Type.NT was imported, but could not
be looked up /by the plugin/.

   let rdrName = mkModuleName &quot;GHC.NT.Type&quot; `mkRdrQual` mkTcOcc &quot;NT&quot;
   putMsgS $ showSDoc dflags $ ppr $ lookupGRE_RdrName rdrName $ mg_rdr_env guts

`mkTcOcc` involves the lookup (or creation) of a FastString.  Since the
plugin's FastString.string_table is empty, constructing the RdrName also
allocates new uniques for the FastStrings &quot;GHC.NT.Type&quot; and &quot;NT&quot;.  These
uniques are almost certainly unequal to the ones that the host compiler
originally assigned to those FastStrings.  Thus the lookup fails since the
domain of the GlobalRdrEnv is affected by the RdrName's OccName's FastString's
unique.

Maintaining synchronization of the two instances of this global is rather
difficult because of the uses of `unsafePerformIO` in this module.  Not
synchronizing them risks breaking the rather major invariant that two
FastStrings with the same unique have the same string. Thus we use the
lower-level `sharedCAF` mechanism that relies on Globals.c.

-}</span><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span class="hs-identifier">mkFastString#</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Addr#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-367"></a><a name="mkFastString%23"><a href="FastString.html#mkFastString%23"><span class="hs-identifier">mkFastString#</span></a></a><span> </span><a name="local-6989586621680059293"><a href="#local-6989586621680059293"><span class="hs-identifier">a#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringBytes"><span class="hs-identifier hs-var">mkFastStringBytes</span></a><span> </span><a href="#local-6989586621680059294"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#ptrStrLength"><span class="hs-identifier hs-var">ptrStrLength</span></a><span> </span><a href="#local-6989586621680059294"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680059294"><a href="#local-6989586621680059294"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Ptr</span><span> </span><a href="#local-6989586621680059293"><span class="hs-identifier hs-var">a#</span></a><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-comment">{- Note [Updating the FastString table]

We use a concurrent hashtable which contains multiple segments, each hash value
always maps to the same segment. Read is lock-free, write to the a segment
should acquire a lock for that segment to avoid race condition, writes to
different segments are independent.

The procedure goes like this:

1. Find out which segment to operate on based on the hash value
2. Read the relevant bucket and perform a look up of the string.
3. If it exists, return it.
4. Otherwise grab a unique ID, create a new FastString and atomically attempt
   to update the relevant segment with this FastString:

   * Resize the segment by doubling the number of buckets when the number of
     FastStrings in this segment grows beyond the threshold.
   * Double check that the string is not in the bucket. Another thread may have
     inserted it while we were creating our string.
   * Return the existing FastString if it exists. The one we preemptively
     created will get GCed.
   * Otherwise, insert and return the string we created.
-}</span><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span class="hs-identifier">mkFastStringWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-395"></a><a name="mkFastStringWith"><a href="FastString.html#mkFastStringWith"><span class="hs-identifier">mkFastStringWith</span></a></a><span> </span><a name="local-6989586621680059295"><a href="#local-6989586621680059295"><span class="hs-identifier">mk_fs</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680059296"><a href="#local-6989586621680059296"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680059297"><a href="#local-6989586621680059297"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-396"></a><span>  </span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-var">FastStringTableSegment</span></a><span> </span><a name="local-6989586621680059314"><a href="#local-6989586621680059314"><span class="hs-identifier">lock</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059315"><a href="#local-6989586621680059315"><span class="hs-identifier">buckets#</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621680059302"><span class="hs-identifier hs-var">segmentRef</span></a><span>
</span><a name="line-397"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059316"><a href="#local-6989586621680059316"><span class="hs-identifier">idx#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#hashToIndex%23"><span class="hs-identifier hs-var">hashToIndex#</span></a><span> </span><a href="#local-6989586621680059315"><span class="hs-identifier hs-var">buckets#</span></a><span> </span><a href="#local-6989586621680059301"><span class="hs-identifier hs-var">hash#</span></a><span>
</span><a name="line-398"></a><span>  </span><a name="local-6989586621680059317"><a href="#local-6989586621680059317"><span class="hs-identifier">bucket</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readArray#</span><span> </span><a href="#local-6989586621680059315"><span class="hs-identifier hs-var">buckets#</span></a><span> </span><a href="#local-6989586621680059316"><span class="hs-identifier hs-var">idx#</span></a><span>
</span><a name="line-399"></a><span>  </span><a name="local-6989586621680059318"><a href="#local-6989586621680059318"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#bucket_match"><span class="hs-identifier hs-var">bucket_match</span></a><span> </span><a href="#local-6989586621680059317"><span class="hs-identifier hs-var">bucket</span></a><span> </span><a href="#local-6989586621680059297"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621680059296"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-400"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680059318"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-401"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680059319"><a href="#local-6989586621680059319"><span class="hs-identifier">found</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680059319"><span class="hs-identifier hs-var">found</span></a><span>
</span><a name="line-402"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-403"></a><span>      </span><span class="hs-comment">-- The withMVar below is not dupable. It can lead to deadlock if it is</span><span>
</span><a name="line-404"></a><span>      </span><span class="hs-comment">-- only run partially and putMVar is not called after takeMVar.</span><span>
</span><a name="line-405"></a><span>      </span><span class="hs-identifier hs-var">noDuplicate</span><span>
</span><a name="line-406"></a><span>      </span><a name="local-6989586621680059320"><a href="#local-6989586621680059320"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680059300"><span class="hs-identifier hs-var">get_uid</span></a><span>
</span><a name="line-407"></a><span>      </span><a name="local-6989586621680059321"><a href="#local-6989586621680059321"><span class="hs-identifier">new_fs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680059295"><span class="hs-identifier hs-var">mk_fs</span></a><span> </span><a href="#local-6989586621680059320"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-408"></a><span>      </span><span class="hs-identifier hs-var">withMVar</span><span> </span><a href="#local-6989586621680059314"><span class="hs-identifier hs-var">lock</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680059303"><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621680059321"><span class="hs-identifier hs-var">new_fs</span></a><span>
</span><a name="line-409"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-410"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-var">FastStringTable</span></a><span> </span><a name="local-6989586621680059298"><a href="#local-6989586621680059298"><span class="hs-identifier">uid</span></a></a><span> </span><a name="local-6989586621680059299"><a href="#local-6989586621680059299"><span class="hs-identifier">segments#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#stringTable"><span class="hs-identifier hs-var">stringTable</span></a><span>
</span><a name="line-411"></a><span>    </span><a name="local-6989586621680059300"><a href="#local-6989586621680059300"><span class="hs-identifier">get_uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621680059298"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059304"><a href="#local-6989586621680059304"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059304"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><a href="#local-6989586621680059304"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059301"><a href="#local-6989586621680059301"><span class="hs-identifier">hash#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#hashStr"><span class="hs-identifier hs-var">hashStr</span></a><span> </span><a href="#local-6989586621680059296"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059297"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-414"></a><span>    </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059302"><a href="#local-6989586621680059302"><span class="hs-identifier">segmentRef</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">indexArray#</span><span> </span><a href="#local-6989586621680059299"><span class="hs-identifier hs-var">segments#</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#hashToSegment%23"><span class="hs-identifier hs-var">hashToSegment#</span></a><span> </span><a href="#local-6989586621680059301"><span class="hs-identifier hs-var">hash#</span></a><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>    </span><a name="local-6989586621680059303"><a href="#local-6989586621680059303"><span class="hs-identifier">insert</span></a></a><span> </span><a name="local-6989586621680059305"><a href="#local-6989586621680059305"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-416"></a><span>      </span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-var">FastStringTableSegment</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059306"><a href="#local-6989586621680059306"><span class="hs-identifier">counter</span></a></a><span> </span><a name="local-6989586621680059307"><a href="#local-6989586621680059307"><span class="hs-identifier">buckets#</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#maybeResizeSegment"><span class="hs-identifier hs-var">maybeResizeSegment</span></a><span> </span><a href="#local-6989586621680059302"><span class="hs-identifier hs-var">segmentRef</span></a><span>
</span><a name="line-417"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059308"><a href="#local-6989586621680059308"><span class="hs-identifier">idx#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#hashToIndex%23"><span class="hs-identifier hs-var">hashToIndex#</span></a><span> </span><a href="#local-6989586621680059307"><span class="hs-identifier hs-var">buckets#</span></a><span> </span><a href="#local-6989586621680059301"><span class="hs-identifier hs-var">hash#</span></a><span>
</span><a name="line-418"></a><span>      </span><a name="local-6989586621680059309"><a href="#local-6989586621680059309"><span class="hs-identifier">bucket</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readArray#</span><span> </span><a href="#local-6989586621680059307"><span class="hs-identifier hs-var">buckets#</span></a><span> </span><a href="#local-6989586621680059308"><span class="hs-identifier hs-var">idx#</span></a><span>
</span><a name="line-419"></a><span>      </span><a name="local-6989586621680059310"><a href="#local-6989586621680059310"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#bucket_match"><span class="hs-identifier hs-var">bucket_match</span></a><span> </span><a href="#local-6989586621680059309"><span class="hs-identifier hs-var">bucket</span></a><span> </span><a href="#local-6989586621680059297"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621680059296"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-420"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680059310"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-421"></a><span>        </span><span class="hs-comment">-- The FastString was added by another thread after previous read and</span><span>
</span><a name="line-422"></a><span>        </span><span class="hs-comment">-- before we acquired the write lock.</span><span>
</span><a name="line-423"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680059311"><a href="#local-6989586621680059311"><span class="hs-identifier">found</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680059311"><span class="hs-identifier hs-var">found</span></a><span>
</span><a name="line-424"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-425"></a><span>          </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059312"><a href="#local-6989586621680059312"><span class="hs-identifier">s1#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-426"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">writeArray#</span><span> </span><a href="#local-6989586621680059307"><span class="hs-identifier hs-var">buckets#</span></a><span> </span><a href="#local-6989586621680059308"><span class="hs-identifier hs-var">idx#</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059305"><span class="hs-identifier hs-var">fs</span></a><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680059309"><span class="hs-identifier hs-var">bucket</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059312"><span class="hs-identifier hs-var">s1#</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-427"></a><span>              </span><a name="local-6989586621680059313"><a href="#local-6989586621680059313"><span class="hs-identifier">s2#</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><a href="#local-6989586621680059313"><span class="hs-identifier hs-var">s2#</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><a name="line-428"></a><span>          </span><span class="hs-identifier hs-var">modifyIORef'</span><span> </span><a href="#local-6989586621680059306"><span class="hs-identifier hs-var">counter</span></a><span> </span><span class="hs-identifier hs-var">succ</span><span>
</span><a name="line-429"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680059305"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-identifier">bucket_match</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">)</span><span>
</span><a name="line-432"></a><a name="bucket_match"><a href="FastString.html#bucket_match"><span class="hs-identifier">bucket_match</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-433"></a><span class="hs-identifier">bucket_match</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680059322"><a href="#local-6989586621680059322"><span class="hs-identifier">v</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059323"><a href="#local-6989586621680059323"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621680059324"><a href="#local-6989586621680059324"><span class="hs-identifier">ls</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680059325"><a href="#local-6989586621680059325"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621680059326"><a href="#local-6989586621680059326"><span class="hs-identifier">ptr</span></a></a><span>
</span><a name="line-434"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680059325"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">BS.length</span><span> </span><a href="#local-6989586621680059323"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-435"></a><span>         </span><a name="local-6989586621680059328"><a href="#local-6989586621680059328"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">BS.unsafeUseAsCString</span><span> </span><a href="#local-6989586621680059323"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059327"><a href="#local-6989586621680059327"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-436"></a><span>             </span><a href="FastString.html#cmpStringPrefix"><span class="hs-identifier hs-var">cmpStringPrefix</span></a><span> </span><a href="#local-6989586621680059326"><span class="hs-identifier hs-var">ptr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621680059327"><span class="hs-identifier hs-var">buf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059325"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-437"></a><span>         </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680059328"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680059322"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>              </span><span class="hs-keyword">else</span><span> </span><a href="FastString.html#bucket_match"><span class="hs-identifier hs-var">bucket_match</span></a><span> </span><a href="#local-6989586621680059324"><span class="hs-identifier hs-var">ls</span></a><span> </span><a href="#local-6989586621680059325"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621680059326"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-439"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-440"></a><span>         </span><a href="FastString.html#bucket_match"><span class="hs-identifier hs-var">bucket_match</span></a><span> </span><a href="#local-6989586621680059324"><span class="hs-identifier hs-var">ls</span></a><span> </span><a href="#local-6989586621680059325"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621680059326"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span class="hs-identifier">mkFastStringBytes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-443"></a><a name="mkFastStringBytes"><a href="FastString.html#mkFastStringBytes"><span class="hs-identifier">mkFastStringBytes</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680059329"><a href="#local-6989586621680059329"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680059330"><a href="#local-6989586621680059330"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-444"></a><span>    </span><span class="hs-comment">-- NB: Might as well use unsafeDupablePerformIO, since mkFastStringWith is</span><span>
</span><a name="line-445"></a><span>    </span><span class="hs-comment">-- idempotent.</span><span>
</span><a name="line-446"></a><span>    </span><span class="hs-identifier hs-var">unsafeDupablePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-447"></a><span>        </span><a href="FastString.html#mkFastStringWith"><span class="hs-identifier hs-var">mkFastStringWith</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#copyNewFastString"><span class="hs-identifier hs-var">copyNewFastString</span></a><span> </span><a href="#local-6989586621680059329"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059330"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059329"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059330"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-448"></a><span>
</span><a name="line-449"></a><span class="hs-comment">-- | Create a 'FastString' from an existing 'ForeignPtr'; the difference</span><span>
</span><a name="line-450"></a><span class="hs-comment">-- between this and 'mkFastStringBytes' is that we don't have to copy</span><span>
</span><a name="line-451"></a><span class="hs-comment">-- the bytes if the string is new to the table.</span><span>
</span><a name="line-452"></a><span class="hs-identifier">mkFastStringForeignPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ForeignPtr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-453"></a><a name="mkFastStringForeignPtr"><a href="FastString.html#mkFastStringForeignPtr"><span class="hs-identifier">mkFastStringForeignPtr</span></a></a><span> </span><a name="local-6989586621680059331"><a href="#local-6989586621680059331"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680059332"><a href="#local-6989586621680059332"><span class="hs-identifier">fp</span></a></a><span> </span><a name="local-6989586621680059333"><a href="#local-6989586621680059333"><span class="hs-identifier">len</span></a></a><span>
</span><a name="line-454"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringWith"><span class="hs-identifier hs-var">mkFastStringWith</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#mkNewFastString"><span class="hs-identifier hs-var">mkNewFastString</span></a><span> </span><a href="#local-6989586621680059332"><span class="hs-identifier hs-var">fp</span></a><span> </span><a href="#local-6989586621680059331"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059333"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059331"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059333"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span class="hs-comment">-- | Create a 'FastString' from an existing 'ForeignPtr'; the difference</span><span>
</span><a name="line-457"></a><span class="hs-comment">-- between this and 'mkFastStringBytes' is that we don't have to copy</span><span>
</span><a name="line-458"></a><span class="hs-comment">-- the bytes if the string is new to the table.</span><span>
</span><a name="line-459"></a><span class="hs-identifier">mkFastStringByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-460"></a><a name="mkFastStringByteString"><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier">mkFastStringByteString</span></a></a><span> </span><a name="local-6989586621680059334"><a href="#local-6989586621680059334"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-461"></a><span>    </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-462"></a><span>      </span><span class="hs-identifier hs-var">BS.unsafeUseAsCStringLen</span><span> </span><a href="#local-6989586621680059334"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680059335"><a href="#local-6989586621680059335"><span class="hs-identifier">ptr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680059336"><a href="#local-6989586621680059336"><span class="hs-identifier">len</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-463"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059337"><a href="#local-6989586621680059337"><span class="hs-identifier">ptr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621680059335"><span class="hs-identifier hs-var">ptr</span></a><span>
</span><a name="line-464"></a><span>        </span><a href="FastString.html#mkFastStringWith"><span class="hs-identifier hs-var">mkFastStringWith</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#mkNewFastStringByteString"><span class="hs-identifier hs-var">mkNewFastStringByteString</span></a><span> </span><a href="#local-6989586621680059334"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621680059337"><span class="hs-identifier hs-var">ptr'</span></a><span> </span><a href="#local-6989586621680059336"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059337"><span class="hs-identifier hs-var">ptr'</span></a><span> </span><a href="#local-6989586621680059336"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span class="hs-comment">-- | Creates a UTF-8 encoded 'FastString' from a 'String'</span><span>
</span><a name="line-467"></a><span class="hs-identifier">mkFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-468"></a><a name="mkFastString"><a href="FastString.html#mkFastString"><span class="hs-identifier">mkFastString</span></a></a><span> </span><a name="local-6989586621680059338"><a href="#local-6989586621680059338"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-469"></a><span>  </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-470"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059339"><a href="#local-6989586621680059339"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Encoding.html#utf8EncodedLength"><span class="hs-identifier hs-var">utf8EncodedLength</span></a><span> </span><a href="#local-6989586621680059338"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-471"></a><span>    </span><a name="local-6989586621680059340"><a href="#local-6989586621680059340"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mallocForeignPtrBytes</span><span> </span><a href="#local-6989586621680059339"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-472"></a><span>    </span><span class="hs-identifier hs-var">withForeignPtr</span><span> </span><a href="#local-6989586621680059340"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059341"><a href="#local-6989586621680059341"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-473"></a><span>      </span><a href="Encoding.html#utf8EncodeString"><span class="hs-identifier hs-var">utf8EncodeString</span></a><span> </span><a href="#local-6989586621680059341"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059338"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-474"></a><span>      </span><a href="FastString.html#mkFastStringForeignPtr"><span class="hs-identifier hs-var">mkFastStringForeignPtr</span></a><span> </span><a href="#local-6989586621680059341"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059340"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621680059339"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-475"></a><span>
</span><a name="line-476"></a><span class="hs-comment">-- | Creates a 'FastString' from a UTF-8 encoded @[Word8]@</span><span>
</span><a name="line-477"></a><span class="hs-identifier">mkFastStringByteList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-478"></a><a name="mkFastStringByteList"><a href="FastString.html#mkFastStringByteList"><span class="hs-identifier">mkFastStringByteList</span></a></a><span> </span><a name="local-6989586621680059342"><a href="#local-6989586621680059342"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-479"></a><span>  </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-480"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059343"><a href="#local-6989586621680059343"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Prelude.length</span><span> </span><a href="#local-6989586621680059342"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-481"></a><span>    </span><a name="local-6989586621680059344"><a href="#local-6989586621680059344"><span class="hs-identifier">buf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mallocForeignPtrBytes</span><span> </span><a href="#local-6989586621680059343"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-482"></a><span>    </span><span class="hs-identifier hs-var">withForeignPtr</span><span> </span><a href="#local-6989586621680059344"><span class="hs-identifier hs-var">buf</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059345"><a href="#local-6989586621680059345"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-483"></a><span>      </span><span class="hs-identifier hs-var">pokeArray</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621680059345"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059342"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-484"></a><span>      </span><a href="FastString.html#mkFastStringForeignPtr"><span class="hs-identifier hs-var">mkFastStringForeignPtr</span></a><span> </span><a href="#local-6989586621680059345"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059344"><span class="hs-identifier hs-var">buf</span></a><span> </span><a href="#local-6989586621680059343"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-comment">-- | Creates a Z-encoded 'FastString' from a 'String'</span><span>
</span><a name="line-487"></a><span class="hs-identifier">mkZFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span>
</span><a name="line-488"></a><a name="mkZFastString"><a href="FastString.html#mkZFastString"><span class="hs-identifier">mkZFastString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastZStringString"><span class="hs-identifier hs-var">mkFastZStringString</span></a><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span class="hs-identifier">mkNewFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ForeignPtr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-491"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-492"></a><a name="mkNewFastString"><a href="FastString.html#mkNewFastString"><span class="hs-identifier">mkNewFastString</span></a></a><span> </span><a name="local-6989586621680059346"><a href="#local-6989586621680059346"><span class="hs-identifier">fp</span></a></a><span> </span><a name="local-6989586621680059347"><a href="#local-6989586621680059347"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621680059348"><a href="#local-6989586621680059348"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621680059349"><a href="#local-6989586621680059349"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-493"></a><span>  </span><a name="local-6989586621680059350"><a href="#local-6989586621680059350"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-494"></a><span>  </span><a name="local-6989586621680059351"><a href="#local-6989586621680059351"><span class="hs-identifier">n_chars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Encoding.html#countUTF8Chars"><span class="hs-identifier hs-var">countUTF8Chars</span></a><span> </span><a href="#local-6989586621680059347"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059348"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-495"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a href="#local-6989586621680059349"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621680059351"><span class="hs-identifier hs-var">n_chars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.fromForeignPtr</span><span> </span><a href="#local-6989586621680059346"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621680059348"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059350"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">)</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span class="hs-identifier">mkNewFastStringByteString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-498"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-499"></a><a name="mkNewFastStringByteString"><a href="FastString.html#mkNewFastStringByteString"><span class="hs-identifier">mkNewFastStringByteString</span></a></a><span> </span><a name="local-6989586621680059352"><a href="#local-6989586621680059352"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621680059353"><a href="#local-6989586621680059353"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621680059354"><a href="#local-6989586621680059354"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621680059355"><a href="#local-6989586621680059355"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-500"></a><span>  </span><a name="local-6989586621680059356"><a href="#local-6989586621680059356"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-501"></a><span>  </span><a name="local-6989586621680059357"><a href="#local-6989586621680059357"><span class="hs-identifier">n_chars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Encoding.html#countUTF8Chars"><span class="hs-identifier hs-var">countUTF8Chars</span></a><span> </span><a href="#local-6989586621680059353"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059354"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-502"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a href="#local-6989586621680059355"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621680059357"><span class="hs-identifier hs-var">n_chars</span></a><span> </span><a href="#local-6989586621680059352"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621680059356"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-identifier">copyNewFastString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-505"></a><a name="copyNewFastString"><a href="FastString.html#copyNewFastString"><span class="hs-identifier">copyNewFastString</span></a></a><span> </span><a name="local-6989586621680059358"><a href="#local-6989586621680059358"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621680059359"><a href="#local-6989586621680059359"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621680059360"><a href="#local-6989586621680059360"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-506"></a><span>  </span><a name="local-6989586621680059361"><a href="#local-6989586621680059361"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#copyBytesToForeignPtr"><span class="hs-identifier hs-var">copyBytesToForeignPtr</span></a><span> </span><a href="#local-6989586621680059358"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059359"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-507"></a><span>  </span><a name="local-6989586621680059362"><a href="#local-6989586621680059362"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-508"></a><span>  </span><a name="local-6989586621680059363"><a href="#local-6989586621680059363"><span class="hs-identifier">n_chars</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Encoding.html#countUTF8Chars"><span class="hs-identifier hs-var">countUTF8Chars</span></a><span> </span><a href="#local-6989586621680059358"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059359"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-509"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a href="#local-6989586621680059360"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621680059363"><span class="hs-identifier hs-var">n_chars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.fromForeignPtr</span><span> </span><a href="#local-6989586621680059361"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621680059359"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059362"><span class="hs-identifier hs-var">ref</span></a><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-identifier">copyBytesToForeignPtr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ForeignPtr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-512"></a><a name="copyBytesToForeignPtr"><a href="FastString.html#copyBytesToForeignPtr"><span class="hs-identifier">copyBytesToForeignPtr</span></a></a><span> </span><a name="local-6989586621680059364"><a href="#local-6989586621680059364"><span class="hs-identifier">ptr</span></a></a><span> </span><a name="local-6989586621680059365"><a href="#local-6989586621680059365"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-513"></a><span>  </span><a name="local-6989586621680059366"><a href="#local-6989586621680059366"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mallocForeignPtrBytes</span><span> </span><a href="#local-6989586621680059365"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-514"></a><span>  </span><span class="hs-identifier hs-var">withForeignPtr</span><span> </span><a href="#local-6989586621680059366"><span class="hs-identifier hs-var">fp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059367"><a href="#local-6989586621680059367"><span class="hs-identifier">ptr'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">copyBytes</span><span> </span><a href="#local-6989586621680059367"><span class="hs-identifier hs-var">ptr'</span></a><span> </span><a href="#local-6989586621680059364"><span class="hs-identifier hs-var">ptr</span></a><span> </span><a href="#local-6989586621680059365"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-515"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680059366"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-identifier">cmpStringPrefix</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-518"></a><a name="cmpStringPrefix"><a href="FastString.html#cmpStringPrefix"><span class="hs-identifier">cmpStringPrefix</span></a></a><span> </span><a name="local-6989586621680059415"><a href="#local-6989586621680059415"><span class="hs-identifier">ptr1</span></a></a><span> </span><a name="local-6989586621680059416"><a href="#local-6989586621680059416"><span class="hs-identifier">ptr2</span></a></a><span> </span><a name="local-6989586621680059417"><a href="#local-6989586621680059417"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-519"></a><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680059418"><a href="#local-6989586621680059418"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FastString.html#memcmp"><span class="hs-identifier hs-var">memcmp</span></a><span> </span><a href="#local-6989586621680059415"><span class="hs-identifier hs-var">ptr1</span></a><span> </span><a href="#local-6989586621680059416"><span class="hs-identifier hs-var">ptr2</span></a><span> </span><a href="#local-6989586621680059417"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-520"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059418"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-identifier">hashStr</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-524"></a><span> </span><span class="hs-comment">-- use the Addr to produce a hash value between 0 &amp; m (inclusive)</span><span>
</span><a name="line-525"></a><a name="hashStr"><a href="FastString.html#hashStr"><span class="hs-identifier">hashStr</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ptr</span><span> </span><a name="local-6989586621680059419"><a href="#local-6989586621680059419"><span class="hs-identifier">a#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059420"><a href="#local-6989586621680059420"><span class="hs-identifier">len#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059421"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-number">0#</span><span> </span><span class="hs-number">0#</span><span>
</span><a name="line-526"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-527"></a><span>    </span><a name="local-6989586621680059421"><a href="#local-6989586621680059421"><span class="hs-identifier">loop</span></a></a><span> </span><a name="local-6989586621680059422"><a href="#local-6989586621680059422"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621680059423"><a href="#local-6989586621680059423"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isTrue#</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059423"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==#</span><span> </span><a href="#local-6989586621680059420"><span class="hs-identifier hs-var">len#</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">I#</span><span> </span><a href="#local-6989586621680059422"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-528"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059421"><span class="hs-identifier hs-var">loop</span></a><span> </span><a href="#local-6989586621680059425"><span class="hs-identifier hs-var">h2</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059423"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">+#</span><span> </span><span class="hs-number">1#</span><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-530"></a><span>            </span><span class="hs-glyph">!</span><a name="local-6989586621680059424"><a href="#local-6989586621680059424"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ord#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">indexCharOffAddr#</span><span> </span><a href="#local-6989586621680059419"><span class="hs-identifier hs-var">a#</span></a><span> </span><a href="#local-6989586621680059423"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a><span>            </span><span class="hs-glyph">!</span><a name="local-6989586621680059425"><a href="#local-6989586621680059425"><span class="hs-identifier">h2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059422"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-operator hs-var">*#</span><span> </span><span class="hs-number">16777619#</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">xorI#</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621680059424"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- Operations</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span class="hs-comment">-- | Returns the length of the 'FastString' in characters</span><span>
</span><a name="line-537"></a><span class="hs-identifier">lengthFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-538"></a><a name="lengthFS"><a href="FastString.html#lengthFS"><span class="hs-identifier">lengthFS</span></a></a><span> </span><a name="local-6989586621680059426"><a href="#local-6989586621680059426"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">n_chars</span><span> </span><a href="#local-6989586621680059426"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-539"></a><span>
</span><a name="line-540"></a><span class="hs-comment">-- | Returns @True@ if this 'FastString' is not Z-encoded but already has</span><span>
</span><a name="line-541"></a><span class="hs-comment">-- a Z-encoding cached (used in producing stats).</span><span>
</span><a name="line-542"></a><span class="hs-identifier">hasZEncoding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-543"></a><a name="hasZEncoding"><a href="FastString.html#hasZEncoding"><span class="hs-identifier">hasZEncoding</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059427"><a href="#local-6989586621680059427"><span class="hs-identifier">ref</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-544"></a><span>      </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-545"></a><span>        </span><a name="local-6989586621680059428"><a href="#local-6989586621680059428"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621680059427"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-546"></a><span>        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><a href="#local-6989586621680059428"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span class="hs-comment">-- | Returns @True@ if the 'FastString' is empty</span><span>
</span><a name="line-549"></a><span class="hs-identifier">nullFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-550"></a><a name="nullFS"><a href="FastString.html#nullFS"><span class="hs-identifier">nullFS</span></a></a><span> </span><a name="local-6989586621680059429"><a href="#local-6989586621680059429"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS.null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fs_bs</span><span> </span><a href="#local-6989586621680059429"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span>
</span><a name="line-552"></a><span class="hs-comment">-- | Unpacks and decodes the FastString</span><span>
</span><a name="line-553"></a><span class="hs-identifier">unpackFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-554"></a><a name="unpackFS"><a href="FastString.html#unpackFS"><span class="hs-identifier">unpackFS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059430"><a href="#local-6989586621680059430"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Encoding.html#utf8DecodeByteString"><span class="hs-identifier hs-var">utf8DecodeByteString</span></a><span> </span><a href="#local-6989586621680059430"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span class="hs-comment">-- | Gives the UTF-8 encoded bytes corresponding to a 'FastString'</span><span>
</span><a name="line-557"></a><span class="hs-identifier">bytesFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">]</span><span>
</span><a name="line-558"></a><a name="bytesFS"><a href="FastString.html#bytesFS"><span class="hs-identifier">bytesFS</span></a></a><span> </span><a name="local-6989586621680059431"><a href="#local-6989586621680059431"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS.unpack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621680059431"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-559"></a><span>
</span><a name="line-560"></a><span class="hs-comment">-- | Returns a Z-encoded version of a 'FastString'.  This might be the</span><span>
</span><a name="line-561"></a><span class="hs-comment">-- original, if it was already Z-encoded.  The first time this</span><span>
</span><a name="line-562"></a><span class="hs-comment">-- function is applied to a particular 'FastString', the results are</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- memoized.</span><span>
</span><a name="line-564"></a><span class="hs-comment">--</span><span>
</span><a name="line-565"></a><span class="hs-identifier">zEncodeFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastZString"><span class="hs-identifier hs-type">FastZString</span></a><span>
</span><a name="line-566"></a><a name="zEncodeFS"><a href="FastString.html#zEncodeFS"><span class="hs-identifier">zEncodeFS</span></a></a><span> </span><a name="local-6989586621680059432"><a href="#local-6989586621680059432"><span class="hs-identifier">fs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059433"><a href="#local-6989586621680059433"><span class="hs-identifier">ref</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-567"></a><span>      </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-568"></a><span>        </span><a name="local-6989586621680059434"><a href="#local-6989586621680059434"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621680059433"><span class="hs-identifier hs-var">ref</span></a><span>
</span><a name="line-569"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680059434"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-570"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680059435"><a href="#local-6989586621680059435"><span class="hs-identifier">zfs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680059435"><span class="hs-identifier hs-var">zfs</span></a><span>
</span><a name="line-571"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-572"></a><span>            </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621680059433"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059436"><a href="#local-6989586621680059436"><span class="hs-identifier">m'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680059436"><span class="hs-identifier hs-var">m'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-573"></a><span>              </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059437"><a href="#local-6989586621680059437"><span class="hs-identifier">zfs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkZFastString"><span class="hs-identifier hs-var">mkZFastString</span></a><span> </span><span class="hs-special">(</span><a href="Encoding.html#zEncodeString"><span class="hs-identifier hs-var">zEncodeString</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span> </span><a href="#local-6989586621680059432"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>                          </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680059437"><span class="hs-identifier hs-var">zfs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680059437"><span class="hs-identifier hs-var">zfs</span></a><span class="hs-special">)</span><span>
</span><a name="line-575"></a><span>              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680059438"><a href="#local-6989586621680059438"><span class="hs-identifier">zfs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059436"><span class="hs-identifier hs-var">m'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680059438"><span class="hs-identifier hs-var">zfs</span></a><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span>
</span><a name="line-577"></a><span class="hs-identifier">appendFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-578"></a><a name="appendFS"><a href="FastString.html#appendFS"><span class="hs-identifier">appendFS</span></a></a><span> </span><a name="local-6989586621680059439"><a href="#local-6989586621680059439"><span class="hs-identifier">fs1</span></a></a><span> </span><a name="local-6989586621680059440"><a href="#local-6989586621680059440"><span class="hs-identifier">fs2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span>
</span><a name="line-579"></a><span>                 </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BS.append</span><span> </span><span class="hs-special">(</span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621680059439"><span class="hs-identifier hs-var">fs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>                             </span><span class="hs-special">(</span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621680059440"><span class="hs-identifier hs-var">fs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-581"></a><span>
</span><a name="line-582"></a><span class="hs-identifier">concatFS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-583"></a><a name="concatFS"><a href="FastString.html#concatFS"><span class="hs-identifier">concatFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">BS.concat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">fs_bs</span><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span class="hs-identifier">headFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Char</span><span>
</span><a name="line-586"></a><a name="headFS"><a href="FastString.html#headFS"><span class="hs-identifier">headFS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;headFS: Empty FastString&quot;</span><span>
</span><a name="line-587"></a><span class="hs-identifier">headFS</span><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059441"><a href="#local-6989586621680059441"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-588"></a><span>  </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BS.unsafeUseAsCString</span><span> </span><a href="#local-6989586621680059441"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059442"><a href="#local-6989586621680059442"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-589"></a><span>         </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><a href="Encoding.html#utf8DecodeChar"><span class="hs-identifier hs-var">utf8DecodeChar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621680059442"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span class="hs-identifier">tailFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-592"></a><a name="tailFS"><a href="FastString.html#tailFS"><span class="hs-identifier">tailFS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;tailFS: Empty FastString&quot;</span><span>
</span><a name="line-593"></a><span class="hs-identifier">tailFS</span><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059443"><a href="#local-6989586621680059443"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-594"></a><span>    </span><a href="FastFunctions.html#inlinePerformIO"><span class="hs-identifier hs-var">inlinePerformIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">BS.unsafeUseAsCString</span><span> </span><a href="#local-6989586621680059443"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680059444"><a href="#local-6989586621680059444"><span class="hs-identifier">ptr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-595"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680059445"><a href="#local-6989586621680059445"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Encoding.html#utf8DecodeChar"><span class="hs-identifier hs-var">utf8DecodeChar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">castPtr</span><span> </span><a href="#local-6989586621680059444"><span class="hs-identifier hs-var">ptr</span></a><span class="hs-special">)</span><span>
</span><a name="line-596"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">BS.drop</span><span> </span><a href="#local-6989586621680059445"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621680059443"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-identifier">consFS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Char</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-599"></a><a name="consFS"><a href="FastString.html#consFS"><span class="hs-identifier">consFS</span></a></a><span> </span><a name="local-6989586621680059446"><a href="#local-6989586621680059446"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621680059447"><a href="#local-6989586621680059447"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680059446"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span> </span><a href="#local-6989586621680059447"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-600"></a><span>
</span><a name="line-601"></a><span class="hs-identifier">uniqueOfFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-602"></a><a name="uniqueOfFS"><a href="FastString.html#uniqueOfFS"><span class="hs-identifier">uniqueOfFS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#FastString"><span class="hs-identifier hs-var">FastString</span></a><span> </span><a name="local-6989586621680059448"><a href="#local-6989586621680059448"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059448"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span class="hs-identifier">nilFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-605"></a><a name="nilFS"><a href="FastString.html#nilFS"><span class="hs-identifier">nilFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span class="hs-identifier">isUnderscoreFS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-608"></a><a name="isUnderscoreFS"><a href="FastString.html#isUnderscoreFS"><span class="hs-identifier">isUnderscoreFS</span></a></a><span> </span><a name="local-6989586621680059449"><a href="#local-6989586621680059449"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059449"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;_&quot;</span><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-611"></a><span class="hs-comment">-- Stats</span><span>
</span><a name="line-612"></a><span>
</span><a name="line-613"></a><span class="hs-identifier">getFastStringTable</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">[</span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-614"></a><a name="getFastStringTable"><a href="FastString.html#getFastStringTable"><span class="hs-identifier">getFastStringTable</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-615"></a><span>  </span><span class="hs-identifier hs-var">forM</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">..</span><span> </span><a href="FastString.html#numSegments"><span class="hs-identifier hs-var">numSegments</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059451"><a href="#local-6989586621680059451"><span class="hs-identifier">i#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-616"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(#</span><span> </span><a name="local-6989586621680059452"><a href="#local-6989586621680059452"><span class="hs-identifier">segmentRef</span></a></a><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">indexArray#</span><span> </span><a href="#local-6989586621680059450"><span class="hs-identifier hs-var">segments#</span></a><span> </span><a href="#local-6989586621680059451"><span class="hs-identifier hs-var">i#</span></a><span>
</span><a name="line-617"></a><span>    </span><a href="FastString.html#FastStringTableSegment"><span class="hs-identifier hs-var">FastStringTableSegment</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059453"><a href="#local-6989586621680059453"><span class="hs-identifier">buckets#</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621680059452"><span class="hs-identifier hs-var">segmentRef</span></a><span>
</span><a name="line-618"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059454"><a href="#local-6989586621680059454"><span class="hs-identifier">bucketSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">I#</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sizeofMutableArray#</span><span> </span><a href="#local-6989586621680059453"><span class="hs-identifier hs-var">buckets#</span></a><span class="hs-special">)</span><span>
</span><a name="line-619"></a><span>    </span><span class="hs-identifier hs-var">forM</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">..</span><span> </span><a href="#local-6989586621680059454"><span class="hs-identifier hs-var">bucketSize</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059455"><a href="#local-6989586621680059455"><span class="hs-identifier">j#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-620"></a><span>      </span><span class="hs-identifier hs-var">IO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readArray#</span><span> </span><a href="#local-6989586621680059453"><span class="hs-identifier hs-var">buckets#</span></a><span> </span><a href="#local-6989586621680059455"><span class="hs-identifier hs-var">j#</span></a><span>
</span><a name="line-621"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-622"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="FastString.html#FastStringTable"><span class="hs-identifier hs-var">FastStringTable</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059450"><a href="#local-6989586621680059450"><span class="hs-identifier">segments#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#stringTable"><span class="hs-identifier hs-var">stringTable</span></a><span>
</span><a name="line-623"></a><span>
</span><a name="line-624"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-625"></a><span class="hs-comment">-- Outputting 'FastString's</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-comment">-- |Outputs a 'FastString' with /no decoding at all/, that is, you</span><span>
</span><a name="line-628"></a><span class="hs-comment">-- get the actual bytes in the 'FastString' written to the 'Handle'.</span><span>
</span><a name="line-629"></a><span class="hs-identifier">hPutFS</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Handle</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-630"></a><a name="hPutFS"><a href="FastString.html#hPutFS"><span class="hs-identifier">hPutFS</span></a></a><span> </span><a name="local-6989586621680059456"><a href="#local-6989586621680059456"><span class="hs-identifier">handle</span></a></a><span> </span><a name="local-6989586621680059457"><a href="#local-6989586621680059457"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">BS.hPut</span><span> </span><a href="#local-6989586621680059456"><span class="hs-identifier hs-var">handle</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><a href="#local-6989586621680059457"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><span class="hs-comment">-- ToDo: we'll probably want an hPutFSLocal, or something, to output</span><span>
</span><a name="line-633"></a><span class="hs-comment">-- in the current locale's encoding (for error messages and suchlike).</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-636"></a><span class="hs-comment">-- PtrStrings, here for convenience only.</span><span>
</span><a name="line-637"></a><span>
</span><a name="line-638"></a><span class="hs-comment">-- | A 'PtrString' is a pointer to some array of Latin-1 encoded chars.</span><span>
</span><a name="line-639"></a><span class="hs-keyword">data</span><span> </span><a name="PtrString"><a href="FastString.html#PtrString"><span class="hs-identifier">PtrString</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PtrString"><a href="FastString.html#PtrString"><span class="hs-identifier">PtrString</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-640"></a><span>
</span><a name="line-641"></a><span class="hs-comment">-- | Wrap an unboxed address into a 'PtrString'.</span><span>
</span><a name="line-642"></a><span class="hs-identifier">mkPtrString#</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Addr#</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#PtrString"><span class="hs-identifier hs-type">PtrString</span></a><span>
</span><a name="line-643"></a><a name="mkPtrString%23"><a href="FastString.html#mkPtrString%23"><span class="hs-identifier">mkPtrString#</span></a></a><span> </span><a name="local-6989586621680059458"><a href="#local-6989586621680059458"><span class="hs-identifier">a#</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#PtrString"><span class="hs-identifier hs-var">PtrString</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ptr</span><span> </span><a href="#local-6989586621680059458"><span class="hs-identifier hs-var">a#</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="FastString.html#ptrStrLength"><span class="hs-identifier hs-var">ptrStrLength</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ptr</span><span> </span><a href="#local-6989586621680059458"><span class="hs-identifier hs-var">a#</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-comment">-- | Encode a 'String' into a newly allocated 'PtrString' using Latin-1</span><span>
</span><a name="line-646"></a><span class="hs-comment">-- encoding.  The original string must not contain non-Latin-1 characters</span><span>
</span><a name="line-647"></a><span class="hs-comment">-- (above codepoint @0xff@).</span><span>
</span><a name="line-648"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mkPtrString</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-649"></a><span class="hs-identifier">mkPtrString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#PtrString"><span class="hs-identifier hs-type">PtrString</span></a><span>
</span><a name="line-650"></a><a name="mkPtrString"><a href="FastString.html#mkPtrString"><span class="hs-identifier">mkPtrString</span></a></a><span> </span><a name="local-6989586621680059459"><a href="#local-6989586621680059459"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-651"></a><span> </span><span class="hs-comment">-- we don't use `unsafeDupablePerformIO` here to avoid potential memory leaks</span><span>
</span><a name="line-652"></a><span> </span><span class="hs-comment">-- and because someone might be using `eqAddr#` to check for string equality.</span><span>
</span><a name="line-653"></a><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><a name="line-654"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680059460"><a href="#local-6989586621680059460"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621680059459"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-655"></a><span>   </span><a name="local-6989586621680059461"><a href="#local-6989586621680059461"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mallocBytes</span><span> </span><a href="#local-6989586621680059460"><span class="hs-identifier hs-var">len</span></a><span>
</span><a name="line-656"></a><span>   </span><span class="hs-keyword">let</span><span>
</span><a name="line-657"></a><span>     </span><span class="hs-identifier">loop</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-658"></a><span>     </span><a name="local-6989586621680059462"><a href="#local-6989586621680059462"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>     </span><span class="hs-identifier">loop</span><span> </span><a name="local-6989586621680059463"><a href="#local-6989586621680059463"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680059464"><a href="#local-6989586621680059464"><span class="hs-identifier">c</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680059465"><a href="#local-6989586621680059465"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-660"></a><span>        </span><span class="hs-identifier hs-var">pokeByteOff</span><span> </span><a href="#local-6989586621680059461"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621680059463"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ord</span><span> </span><a href="#local-6989586621680059464"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word8</span><span class="hs-special">)</span><span>
</span><a name="line-661"></a><span>        </span><a href="#local-6989586621680059462"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-special">(</span><span class="hs-number">1</span><span class="hs-operator hs-var">+</span><a href="#local-6989586621680059463"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680059465"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-662"></a><span>   </span><a href="#local-6989586621680059462"><span class="hs-identifier hs-var">loop</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621680059459"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-663"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="FastString.html#PtrString"><span class="hs-identifier hs-var">PtrString</span></a><span> </span><a href="#local-6989586621680059461"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="#local-6989586621680059460"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-664"></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>
</span><a name="line-666"></a><span class="hs-comment">-- | Decode a 'PtrString' back into a 'String' using Latin-1 encoding.</span><span>
</span><a name="line-667"></a><span class="hs-comment">-- This does not free the memory associated with 'PtrString'.</span><span>
</span><a name="line-668"></a><span class="hs-identifier">unpackPtrString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#PtrString"><span class="hs-identifier hs-type">PtrString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-669"></a><a name="unpackPtrString"><a href="FastString.html#unpackPtrString"><span class="hs-identifier">unpackPtrString</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#PtrString"><span class="hs-identifier hs-var">PtrString</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Ptr</span><span> </span><a name="local-6989586621680059466"><a href="#local-6989586621680059466"><span class="hs-identifier">p#</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">I#</span><span> </span><a name="local-6989586621680059467"><a href="#local-6989586621680059467"><span class="hs-identifier">n#</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unpackNBytes#</span><span> </span><a href="#local-6989586621680059466"><span class="hs-identifier hs-var">p#</span></a><span> </span><a href="#local-6989586621680059467"><span class="hs-identifier hs-var">n#</span></a><span>
</span><a name="line-670"></a><span>
</span><a name="line-671"></a><span class="hs-comment">-- | Return the length of a 'PtrString'</span><span>
</span><a name="line-672"></a><span class="hs-identifier">lengthPS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FastString.html#PtrString"><span class="hs-identifier hs-type">PtrString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-673"></a><a name="lengthPS"><a href="FastString.html#lengthPS"><span class="hs-identifier">lengthPS</span></a></a><span> </span><span class="hs-special">(</span><a href="FastString.html#PtrString"><span class="hs-identifier hs-var">PtrString</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680059468"><a href="#local-6989586621680059468"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680059468"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-674"></a><span>
</span><a name="line-675"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-676"></a><span class="hs-comment">-- under the carpet</span><span>
</span><a name="line-677"></a><span>
</span><a name="line-678"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;strlen&quot;</span><span>
</span><a name="line-679"></a><span>  </span><span class="hs-identifier">ptrStrLength</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ptr</span><span> </span><span class="hs-identifier hs-type">Word8</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-680"></a><span>
</span><a name="line-681"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">sLit</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-682"></a><span class="hs-identifier">sLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#PtrString"><span class="hs-identifier hs-type">PtrString</span></a><span>
</span><a name="line-683"></a><a name="sLit"><a href="FastString.html#sLit"><span class="hs-identifier">sLit</span></a></a><span> </span><a name="local-6989586621680059469"><a href="#local-6989586621680059469"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkPtrString"><span class="hs-identifier hs-var">mkPtrString</span></a><span> </span><a href="#local-6989586621680059469"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-684"></a><span>
</span><a name="line-685"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">fsLit</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-686"></a><span class="hs-identifier">fsLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-687"></a><a name="fsLit"><a href="FastString.html#fsLit"><span class="hs-identifier">fsLit</span></a></a><span> </span><a name="local-6989586621680059470"><a href="#local-6989586621680059470"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span> </span><a href="#local-6989586621680059470"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span class="hs-pragma">{-# RULES</span><span> </span><span class="hs-pragma">&quot;slit&quot;</span><span>
</span><a name="line-690"></a><span>    </span><span class="hs-pragma">forall</span><span> </span><span class="hs-pragma">x</span><span> </span><span class="hs-pragma">.</span><span> </span><span class="hs-pragma">sLit</span><span>  </span><span class="hs-pragma">(</span><span class="hs-pragma">unpackCString#</span><span> </span><span class="hs-pragma">x</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="hs-pragma">mkPtrString#</span><span>  </span><span class="hs-pragma">x</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-691"></a><span class="hs-pragma">{-# RULES</span><span> </span><span class="hs-pragma">&quot;fslit&quot;</span><span>
</span><a name="line-692"></a><span>    </span><span class="hs-pragma">forall</span><span> </span><span class="hs-pragma">x</span><span> </span><span class="hs-pragma">.</span><span> </span><span class="hs-pragma">fsLit</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">unpackCString#</span><span> </span><span class="hs-pragma">x</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">=</span><span> </span><span class="hs-pragma">mkFastString#</span><span> </span><span class="hs-pragma">x</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-693"></a></pre></body></html>