<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[CoreRules]{Transformation rules}
-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-comment">-- | Functions for collecting together and applying rewrite rules to a module.</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- The 'CoreRule' datatype itself is declared elsewhere.</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Rules</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>        </span><span class="hs-comment">-- ** Constructing</span><span>
</span><a name="line-13"></a><span>        </span><a href="Rules.html#emptyRuleBase"><span class="hs-identifier hs-var">emptyRuleBase</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#mkRuleBase"><span class="hs-identifier hs-var">mkRuleBase</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#extendRuleBaseList"><span class="hs-identifier hs-var">extendRuleBaseList</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="Rules.html#unionRuleBase"><span class="hs-identifier hs-var">unionRuleBase</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#pprRuleBase"><span class="hs-identifier hs-var">pprRuleBase</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span>        </span><span class="hs-comment">-- ** Checking rule applications</span><span>
</span><a name="line-17"></a><span>        </span><a href="Rules.html#ruleCheckProgram"><span class="hs-identifier hs-var">ruleCheckProgram</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>        </span><span class="hs-comment">-- ** Manipulating 'RuleInfo' rules</span><span>
</span><a name="line-20"></a><span>        </span><a href="Rules.html#mkRuleInfo"><span class="hs-identifier hs-var">mkRuleInfo</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#extendRuleInfo"><span class="hs-identifier hs-var">extendRuleInfo</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#addRuleInfo"><span class="hs-identifier hs-var">addRuleInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="Rules.html#addIdSpecialisations"><span class="hs-identifier hs-var">addIdSpecialisations</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span>        </span><span class="hs-comment">-- * Misc. CoreRule helpers</span><span>
</span><a name="line-24"></a><span>        </span><a href="Rules.html#rulesOfBinds"><span class="hs-identifier hs-var">rulesOfBinds</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#getRules"><span class="hs-identifier hs-var">getRules</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#pprRulesForUser"><span class="hs-identifier hs-var">pprRulesForUser</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>        </span><a href="Rules.html#lookupRule"><span class="hs-identifier hs-var">lookupRule</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#mkRule"><span class="hs-identifier hs-var">mkRule</span></a><span class="hs-special">,</span><span> </span><a href="Rules.html#roughTopNames"><span class="hs-identifier hs-var">roughTopNames</span></a><span>
</span><a name="line-27"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>          </span><span class="hs-comment">-- All of it</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#ModuleSet"><span class="hs-identifier hs-type">ModuleSet</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#elemModuleSet"><span class="hs-identifier hs-var">elemModuleSet</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSubst.html"><span class="hs-identifier">CoreSubst</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="CoreOpt.html"><span class="hs-identifier">CoreOpt</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="CoreOpt.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="CoreFVs.html"><span class="hs-identifier">CoreFVs</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="CoreFVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a><span class="hs-special">,</span><span> </span><a href="CoreFVs.html#exprsFreeVars"><span class="hs-identifier hs-var">exprsFreeVars</span></a><span class="hs-special">,</span><span> </span><a href="CoreFVs.html#bindFreeVars"><span class="hs-identifier hs-var">bindFreeVars</span></a><span>
</span><a name="line-38"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="CoreFVs.html#rulesFreeVarsDSet"><span class="hs-identifier hs-var">rulesFreeVarsDSet</span></a><span class="hs-special">,</span><span> </span><a href="CoreFVs.html#exprsOrphNames"><span class="hs-identifier hs-var">exprsOrphNames</span></a><span class="hs-special">,</span><span> </span><a href="CoreFVs.html#exprFreeVarsList"><span class="hs-identifier hs-var">exprFreeVarsList</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#eqExpr"><span class="hs-identifier hs-var">eqExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>                          </span><a href="CoreUtils.html#stripTicksTopT"><span class="hs-identifier hs-var">stripTicksTopT</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>                          </span><a href="CoreUtils.html#isJoinBind"><span class="hs-identifier hs-var">isJoinBind</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="PprCore.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>             </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#mkTCvSubst"><span class="hs-identifier hs-var">mkTCvSubst</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="TysWiredIn.html"><span class="hs-identifier">TysWiredIn</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="TysWiredIn.html#anyTypeOfKind"><span class="hs-identifier hs-var">anyTypeOfKind</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="CoreTidy.html"><span class="hs-identifier">CoreTidy</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="CoreTidy.html#tidyRules"><span class="hs-identifier hs-var">tidyRules</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="IdInfo.html"><span class="hs-identifier">IdInfo</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span class="hs-special">(</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>             </span><span class="hs-special">(</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span> </span><a href="Name.html#NamedThing"><span class="hs-identifier hs-type">NamedThing</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="NameSet.html"><span class="hs-identifier">NameSet</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="NameEnv.html"><span class="hs-identifier">NameEnv</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Unify.html"><span class="hs-identifier">Unify</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="Unify.html#ruleMatchTyKiX"><span class="hs-identifier hs-var">ruleMatchTyKiX</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Bag.html"><span class="hs-identifier">Bag</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Ord</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">{-
Note [Overall plumbing for rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* After the desugarer:
   - The ModGuts initially contains mg_rules :: [CoreRule] of
     locally-declared rules for imported Ids.
   - Locally-declared rules for locally-declared Ids are attached to
     the IdInfo for that Id.  See Note [Attach rules to local ids] in
     DsBinds

* TidyPgm strips off all the rules from local Ids and adds them to
  mg_rules, so that the ModGuts has *all* the locally-declared rules.

* The HomePackageTable contains a ModDetails for each home package
  module.  Each contains md_rules :: [CoreRule] of rules declared in
  that module.  The HomePackageTable grows as ghc --make does its
  up-sweep.  In batch mode (ghc -c), the HPT is empty; all imported modules
  are treated by the &quot;external&quot; route, discussed next, regardless of
  which package they come from.

* The ExternalPackageState has a single eps_rule_base :: RuleBase for
  Ids in other packages.  This RuleBase simply grow monotonically, as
  ghc --make compiles one module after another.

  During simplification, interface files may get demand-loaded,
  as the simplifier explores the unfoldings for Ids it has in
  its hand.  (Via an unsafePerformIO; the EPS is really a cache.)
  That in turn may make the EPS rule-base grow.  In contrast, the
  HPT never grows in this way.

* The result of all this is that during Core-to-Core optimisation
  there are four sources of rules:

    (a) Rules in the IdInfo of the Id they are a rule for.  These are
        easy: fast to look up, and if you apply a substitution then
        it'll be applied to the IdInfo as a matter of course.

    (b) Rules declared in this module for imported Ids, kept in the
        ModGuts. If you do a substitution, you'd better apply the
        substitution to these.  There are seldom many of these.

    (c) Rules declared in the HomePackageTable.  These never change.

    (d) Rules in the ExternalPackageTable. These can grow in response
        to lazy demand-loading of interfaces.

* At the moment (c) is carried in a reader-monad way by the CoreMonad.
  The HomePackageTable doesn't have a single RuleBase because technically
  we should only be able to &quot;see&quot; rules &quot;below&quot; this module; so we
  generate a RuleBase for (c) by combing rules from all the modules
  &quot;below&quot; us.  That's why we can't just select the home-package RuleBase
  from HscEnv.

  [NB: we are inconsistent here.  We should do the same for external
  packages, but we don't.  Same for type-class instances.]

* So in the outer simplifier loop, we combine (b-d) into a single
  RuleBase, reading
     (b) from the ModGuts,
     (c) from the CoreMonad, and
     (d) from its mutable variable
  [Of coures this means that we won't see new EPS rules that come in
  during a single simplifier iteration, but that probably does not
  matter.]


************************************************************************
*                                                                      *
\subsection[specialisation-IdInfo]{Specialisation info about an @Id@}
*                                                                      *
************************************************************************

A @CoreRule@ holds details of one rule for an @Id@, which
includes its specialisations.

For example, if a rule for @f@ contains the mapping:
\begin{verbatim}
        forall a b d. [Type (List a), Type b, Var d]  ===&gt;  f' a b
\end{verbatim}
then when we find an application of f to matching types, we simply replace
it by the matching RHS:
\begin{verbatim}
        f (List Int) Bool dict ===&gt;  f' Int Bool
\end{verbatim}
All the stuff about how many dictionaries to discard, and what types
to apply the specialised function to, are handled by the fact that the
Rule contains a template for the result of the specialisation.

There is one more exciting case, which is dealt with in exactly the same
way.  If the specialised value is unboxed then it is lifted at its
definition site and unlifted at its uses.  For example:

        pi :: forall a. Num a =&gt; a

might have a specialisation

        [Int#] ===&gt;  (case pi' of Lift pi# -&gt; pi#)

where pi' :: Lift Int# is the specialised version of pi.
-}</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-identifier">mkRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span>
</span><a name="line-171"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span>
</span><a name="line-172"></a><span class="hs-comment">-- ^ Used to make 'CoreRule' for an 'Id' defined in the module being</span><span>
</span><a name="line-173"></a><span class="hs-comment">-- compiled. See also 'CoreSyn.CoreRule'</span><span>
</span><a name="line-174"></a><a name="mkRule"><a href="Rules.html#mkRule"><span class="hs-identifier">mkRule</span></a></a><span> </span><a name="local-6989586621684773941"><a href="#local-6989586621684773941"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684773942"><a href="#local-6989586621684773942"><span class="hs-identifier">is_auto</span></a></a><span> </span><a name="local-6989586621684773943"><a href="#local-6989586621684773943"><span class="hs-identifier">is_local</span></a></a><span> </span><a name="local-6989586621684773944"><a href="#local-6989586621684773944"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621684773945"><a href="#local-6989586621684773945"><span class="hs-identifier">act</span></a></a><span> </span><a name="local-6989586621684773946"><a href="#local-6989586621684773946"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621684773947"><a href="#local-6989586621684773947"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684773948"><a href="#local-6989586621684773948"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684773949"><a href="#local-6989586621684773949"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-175"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773944"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773946"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_act</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773945"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">,</span><span>
</span><a name="line-176"></a><span>           </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773947"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773948"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span>
</span><a name="line-177"></a><span>           </span><span class="hs-identifier">ru_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773949"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span>
</span><a name="line-178"></a><span>           </span><span class="hs-identifier">ru_rough</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#roughTopNames"><span class="hs-identifier hs-var">roughTopNames</span></a><span> </span><a href="#local-6989586621684773948"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span>
</span><a name="line-179"></a><span>           </span><span class="hs-identifier">ru_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773941"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">,</span><span>
</span><a name="line-180"></a><span>           </span><span class="hs-identifier">ru_orphan</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773952"><span class="hs-identifier hs-var">orph</span></a><span class="hs-special">,</span><span>
</span><a name="line-181"></a><span>           </span><span class="hs-identifier">ru_auto</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773942"><span class="hs-identifier hs-var">is_auto</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_local</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773943"><span class="hs-identifier hs-var">is_local</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-182"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-comment">-- Compute orphanhood.  See Note [Orphans] in InstEnv</span><span>
</span><a name="line-184"></a><span>        </span><span class="hs-comment">-- A rule is an orphan only if none of the variables</span><span>
</span><a name="line-185"></a><span>        </span><span class="hs-comment">-- mentioned on its left-hand side are locally defined</span><span>
</span><a name="line-186"></a><span>    </span><a name="local-6989586621684773950"><a href="#local-6989586621684773950"><span class="hs-identifier">lhs_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameSet.html#extendNameSet"><span class="hs-identifier hs-var">extendNameSet</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#exprsOrphNames"><span class="hs-identifier hs-var">exprsOrphNames</span></a><span> </span><a href="#local-6989586621684773948"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684773946"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>        </span><span class="hs-comment">-- Since rules get eventually attached to one of the free names</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-comment">-- from the definition when compiling the ABI hash, we should make</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-comment">-- it deterministic. This chooses the one with minimal OccName</span><span>
</span><a name="line-191"></a><span>        </span><span class="hs-comment">-- as opposed to uniq value.</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621684773951"><a href="#local-6989586621684773951"><span class="hs-identifier">local_lhs_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameSet.html#filterNameSet"><span class="hs-identifier hs-var">filterNameSet</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#nameIsLocalOrFrom"><span class="hs-identifier hs-var">nameIsLocalOrFrom</span></a><span> </span><a href="#local-6989586621684773941"><span class="hs-identifier hs-var">this_mod</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684773950"><span class="hs-identifier hs-var">lhs_names</span></a><span>
</span><a name="line-193"></a><span>    </span><a name="local-6989586621684773952"><a href="#local-6989586621684773952"><span class="hs-identifier">orph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#chooseOrphanAnchor"><span class="hs-identifier hs-var">chooseOrphanAnchor</span></a><span> </span><a href="#local-6989586621684773951"><span class="hs-identifier hs-var">local_lhs_names</span></a><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-196"></a><span class="hs-identifier">roughTopNames</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- ^ Find the \&quot;top\&quot; free names of several expressions.</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- Such names are either:</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- 1. The function finally being applied to in an application chain</span><span>
</span><a name="line-201"></a><span class="hs-comment">--    (if that name is a GlobalId: see &quot;Var#globalvslocal&quot;), or</span><span>
</span><a name="line-202"></a><span class="hs-comment">--</span><span>
</span><a name="line-203"></a><span class="hs-comment">-- 2. The 'TyCon' if the expression is a 'Type'</span><span>
</span><a name="line-204"></a><span class="hs-comment">--</span><span>
</span><a name="line-205"></a><span class="hs-comment">-- This is used for the fast-match-check for rules;</span><span>
</span><a name="line-206"></a><span class="hs-comment">--      if the top names don't match, the rest can't</span><span>
</span><a name="line-207"></a><a name="roughTopNames"><a href="Rules.html#roughTopNames"><span class="hs-identifier">roughTopNames</span></a></a><span> </span><a name="local-6989586621684773953"><a href="#local-6989586621684773953"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a><span> </span><a href="#local-6989586621684773953"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-208"></a><span>
</span><a name="line-209"></a><span class="hs-identifier">roughTopName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-210"></a><a name="roughTopName"><a href="Rules.html#roughTopName"><span class="hs-identifier">roughTopName</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684773954"><a href="#local-6989586621684773954"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621684773954"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-211"></a><span>                               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684773955"><a href="#local-6989586621684773955"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621684773955"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><span>                               </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-213"></a><span class="hs-identifier">roughTopName</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-214"></a><span class="hs-identifier">roughTopName</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684773956"><a href="#local-6989586621684773956"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a><span> </span><a href="#local-6989586621684773956"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-215"></a><span class="hs-identifier">roughTopName</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684773957"><a href="#local-6989586621684773957"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isGlobalId"><span class="hs-identifier hs-var">isGlobalId</span></a><span> </span><a href="#local-6989586621684773957"><span class="hs-identifier hs-var">f</span></a><span>   </span><span class="hs-comment">-- Note [Care with roughTopName]</span><span>
</span><a name="line-216"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="Id.html#isDataConWorkId"><span class="hs-identifier hs-var">isDataConWorkId</span></a><span> </span><a href="#local-6989586621684773957"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-6989586621684773957"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-217"></a><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-6989586621684773957"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span class="hs-identifier">roughTopName</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684773958"><a href="#local-6989586621684773958"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684773959"><a href="#local-6989586621684773959"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-6989586621684773958"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-219"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a><span> </span><a href="#local-6989586621684773959"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-220"></a><span class="hs-identifier">roughTopName</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">ruleCantMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-223"></a><span class="hs-comment">-- ^ @ruleCantMatch tpl actual@ returns True only if @actual@</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- definitely can't match @tpl@ by instantiating @tpl@.</span><span>
</span><a name="line-225"></a><span class="hs-comment">-- It's only a one-way match; unlike instance matching we</span><span>
</span><a name="line-226"></a><span class="hs-comment">-- don't consider unification.</span><span>
</span><a name="line-227"></a><span class="hs-comment">--</span><span>
</span><a name="line-228"></a><span class="hs-comment">-- Notice that [_$_]</span><span>
</span><a name="line-229"></a><span class="hs-comment">--      @ruleCantMatch [Nothing] [Just n2] = False@</span><span>
</span><a name="line-230"></a><span class="hs-comment">--      Reason: a template variable can be instantiated by a constant</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- Also:</span><span>
</span><a name="line-232"></a><span class="hs-comment">--      @ruleCantMatch [Just n1] [Nothing] = False@</span><span>
</span><a name="line-233"></a><span class="hs-comment">--      Reason: a local variable @v@ in the actuals might [_$_]</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><a name="ruleCantMatch"><a href="Rules.html#ruleCantMatch"><span class="hs-identifier">ruleCantMatch</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684773960"><a href="#local-6989586621684773960"><span class="hs-identifier">n1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684773961"><a href="#local-6989586621684773961"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684773962"><a href="#local-6989586621684773962"><span class="hs-identifier">n2</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773960"><span class="hs-identifier hs-var">n1</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621684773962"><span class="hs-identifier hs-var">n2</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Rules.html#ruleCantMatch"><span class="hs-identifier hs-var">ruleCantMatch</span></a><span> </span><a href="#local-6989586621684773961"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-236"></a><span class="hs-identifier">ruleCantMatch</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684773964"><a href="#local-6989586621684773964"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCantMatch"><span class="hs-identifier hs-var">ruleCantMatch</span></a><span> </span><a href="#local-6989586621684773964"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-237"></a><span class="hs-identifier">ruleCantMatch</span><span> </span><span class="hs-identifier">_</span><span>              </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-238"></a><span>
</span><a name="line-239"></a><span class="hs-comment">{-
Note [Care with roughTopName]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
    module M where { x = a:b }
    module N where { ...f x...
                     RULE f (p:q) = ... }
You'd expect the rule to match, because the matcher can
look through the unfolding of 'x'.  So we must avoid roughTopName
returning 'M.x' for the call (f x), or else it'll say &quot;can't match&quot;
and we won't even try!!

However, suppose we have
         RULE g (M.h x) = ...
         foo = ...(g (M.k v))....
where k is a *function* exported by M.  We never really match
functions (lambdas) except by name, so in this case it seems like
a good idea to treat 'M.k' as a roughTopName of the call.
-}</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-identifier">pprRulesForUser</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-260"></a><span class="hs-comment">-- (a) tidy the rules</span><span>
</span><a name="line-261"></a><span class="hs-comment">-- (b) sort them into order based on the rule name</span><span>
</span><a name="line-262"></a><span class="hs-comment">-- (c) suppress uniques (unless -dppr-debug is on)</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- This combination makes the output stable so we can use in testing</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- It's here rather than in PprCore because it calls tidyRules</span><span>
</span><a name="line-265"></a><a name="pprRulesForUser"><a href="Rules.html#pprRulesForUser"><span class="hs-identifier">pprRulesForUser</span></a></a><span> </span><a name="local-6989586621684773966"><a href="#local-6989586621684773966"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684773967"><a href="#local-6989586621684773967"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#withPprStyle"><span class="hs-identifier hs-var">withPprStyle</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#defaultUserStyle"><span class="hs-identifier hs-var">defaultUserStyle</span></a><span> </span><a href="#local-6989586621684773966"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-267"></a><span>    </span><a href="PprCore.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-268"></a><span>    </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">comparing</span><span> </span><a href="CoreSyn.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-269"></a><span>    </span><a href="CoreTidy.html#tidyRules"><span class="hs-identifier hs-var">tidyRules</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="#local-6989586621684773967"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                RuleInfo: the rules in an IdInfo
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-comment">-- | Make a 'RuleInfo' containing a number of 'CoreRule's, suitable</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- for putting into an 'IdInfo'</span><span>
</span><a name="line-281"></a><span class="hs-identifier">mkRuleInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span>
</span><a name="line-282"></a><a name="mkRuleInfo"><a href="Rules.html#mkRuleInfo"><span class="hs-identifier">mkRuleInfo</span></a></a><span> </span><a name="local-6989586621684773968"><a href="#local-6989586621684773968"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><a href="#local-6989586621684773968"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#rulesFreeVarsDSet"><span class="hs-identifier hs-var">rulesFreeVarsDSet</span></a><span> </span><a href="#local-6989586621684773968"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-identifier">extendRuleInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span>
</span><a name="line-285"></a><a name="extendRuleInfo"><a href="Rules.html#extendRuleInfo"><span class="hs-identifier">extendRuleInfo</span></a></a><span> </span><span class="hs-special">(</span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><a name="local-6989586621684773969"><a href="#local-6989586621684773969"><span class="hs-identifier">rs1</span></a></a><span> </span><a name="local-6989586621684773970"><a href="#local-6989586621684773970"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684773971"><a href="#local-6989586621684773971"><span class="hs-identifier">rs2</span></a></a><span>
</span><a name="line-286"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684773971"><span class="hs-identifier hs-var">rs2</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684773969"><span class="hs-identifier hs-var">rs1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#rulesFreeVarsDSet"><span class="hs-identifier hs-var">rulesFreeVarsDSet</span></a><span> </span><a href="#local-6989586621684773971"><span class="hs-identifier hs-var">rs2</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684773970"><span class="hs-identifier hs-var">fvs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-identifier">addRuleInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span>
</span><a name="line-289"></a><a name="addRuleInfo"><a href="Rules.html#addRuleInfo"><span class="hs-identifier">addRuleInfo</span></a></a><span> </span><span class="hs-special">(</span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><a name="local-6989586621684773972"><a href="#local-6989586621684773972"><span class="hs-identifier">rs1</span></a></a><span> </span><a name="local-6989586621684773973"><a href="#local-6989586621684773973"><span class="hs-identifier">fvs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><a name="local-6989586621684773974"><a href="#local-6989586621684773974"><span class="hs-identifier">rs2</span></a></a><span> </span><a name="local-6989586621684773975"><a href="#local-6989586621684773975"><span class="hs-identifier">fvs2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684773972"><span class="hs-identifier hs-var">rs1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684773974"><span class="hs-identifier hs-var">rs2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684773973"><span class="hs-identifier hs-var">fvs1</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionDVarSet"><span class="hs-identifier hs-var">unionDVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684773975"><span class="hs-identifier hs-var">fvs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span class="hs-identifier">addIdSpecialisations</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-293"></a><a name="addIdSpecialisations"><a href="Rules.html#addIdSpecialisations"><span class="hs-identifier">addIdSpecialisations</span></a></a><span> </span><a name="local-6989586621684773976"><a href="#local-6989586621684773976"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684773977"><a href="#local-6989586621684773977"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684773977"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-295"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684773976"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-296"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-297"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdSpecialisation"><span class="hs-identifier hs-var">setIdSpecialisation</span></a><span> </span><a href="#local-6989586621684773976"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-298"></a><span>    </span><a href="Rules.html#extendRuleInfo"><span class="hs-identifier hs-var">extendRuleInfo</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idSpecialisation"><span class="hs-identifier hs-var">idSpecialisation</span></a><span> </span><a href="#local-6989586621684773976"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684773977"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-299"></a><span>
</span><a name="line-300"></a><span class="hs-comment">-- | Gather all the rules for locally bound identifiers from the supplied bindings</span><span>
</span><a name="line-301"></a><span class="hs-identifier">rulesOfBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-302"></a><a name="rulesOfBinds"><a href="Rules.html#rulesOfBinds"><span class="hs-identifier">rulesOfBinds</span></a></a><span> </span><a name="local-6989586621684773978"><a href="#local-6989586621684773978"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CoreSyn.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684773978"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-identifier">getRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-305"></a><span class="hs-comment">-- See Note [Where rules are found]</span><span>
</span><a name="line-306"></a><a name="getRules"><a href="Rules.html#getRules"><span class="hs-identifier">getRules</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier hs-var">RuleEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">re_base</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684773979"><a href="#local-6989586621684773979"><span class="hs-identifier">rule_base</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">re_visible_orphs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684773980"><a href="#local-6989586621684773980"><span class="hs-identifier">orphs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684773981"><a href="#local-6989586621684773981"><span class="hs-identifier">fn</span></a></a><span>
</span><a name="line-307"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a><span> </span><a href="#local-6989586621684773981"><span class="hs-identifier hs-var">fn</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="Rules.html#ruleIsVisible"><span class="hs-identifier hs-var">ruleIsVisible</span></a><span> </span><a href="#local-6989586621684773980"><span class="hs-identifier hs-var">orphs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684773982"><span class="hs-identifier hs-var">imp_rules</span></a><span>
</span><a name="line-308"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-309"></a><span>    </span><a name="local-6989586621684773982"><a href="#local-6989586621684773982"><span class="hs-identifier">imp_rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a><span> </span><a href="#local-6989586621684773979"><span class="hs-identifier hs-var">rule_base</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-6989586621684773981"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-310"></a><span>
</span><a name="line-311"></a><span class="hs-identifier">ruleIsVisible</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#ModuleSet"><span class="hs-identifier hs-type">ModuleSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-312"></a><a name="ruleIsVisible"><a href="Rules.html#ruleIsVisible"><span class="hs-identifier">ruleIsVisible</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-313"></a><span class="hs-identifier">ruleIsVisible</span><span> </span><a name="local-6989586621684773983"><a href="#local-6989586621684773983"><span class="hs-identifier">vis_orphs</span></a></a><span> </span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_orphan</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684773984"><a href="#local-6989586621684773984"><span class="hs-identifier">orph</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_origin</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684773985"><a href="#local-6989586621684773985"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#notOrphan"><span class="hs-identifier hs-var">notOrphan</span></a><span> </span><a href="#local-6989586621684773984"><span class="hs-identifier hs-var">orph</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684773985"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-special">`</span><a href="Module.html#elemModuleSet"><span class="hs-identifier hs-var">elemModuleSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684773983"><span class="hs-identifier hs-var">vis_orphs</span></a><span>
</span><a name="line-315"></a><span>
</span><a name="line-316"></a><span class="hs-comment">{- Note [Where rules are found]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The rules for an Id come from two places:
  (a) the ones it is born with, stored inside the Id iself (idCoreRules fn),
  (b) rules added in other modules, stored in the global RuleBase (imp_rules)

It's tempting to think that
     - LocalIds have only (a)
     - non-LocalIds have only (b)

but that isn't quite right:

     - PrimOps and ClassOps are born with a bunch of rules inside the Id,
       even when they are imported

     - The rules in PrelRules.builtinRules should be active even
       in the module defining the Id (when it's a LocalId), but
       the rules are kept in the global RuleBase


************************************************************************
*                                                                      *
                RuleBase
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-comment">-- RuleBase itself is defined in CoreSyn, along with CoreRule</span><span>
</span><a name="line-344"></a><span>
</span><a name="line-345"></a><span class="hs-identifier">emptyRuleBase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span>
</span><a name="line-346"></a><a name="emptyRuleBase"><a href="Rules.html#emptyRuleBase"><span class="hs-identifier">emptyRuleBase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-identifier">mkRuleBase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span>
</span><a name="line-349"></a><a name="mkRuleBase"><a href="Rules.html#mkRuleBase"><span class="hs-identifier">mkRuleBase</span></a></a><span> </span><a name="local-6989586621684773986"><a href="#local-6989586621684773986"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#extendRuleBaseList"><span class="hs-identifier hs-var">extendRuleBaseList</span></a><span> </span><a href="Rules.html#emptyRuleBase"><span class="hs-identifier hs-var">emptyRuleBase</span></a><span> </span><a href="#local-6989586621684773986"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span class="hs-identifier">extendRuleBaseList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span>
</span><a name="line-352"></a><a name="extendRuleBaseList"><a href="Rules.html#extendRuleBaseList"><span class="hs-identifier">extendRuleBaseList</span></a></a><span> </span><a name="local-6989586621684773987"><a href="#local-6989586621684773987"><span class="hs-identifier">rule_base</span></a></a><span> </span><a name="local-6989586621684773988"><a href="#local-6989586621684773988"><span class="hs-identifier">new_guys</span></a></a><span>
</span><a name="line-353"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="Rules.html#extendRuleBase"><span class="hs-identifier hs-var">extendRuleBase</span></a><span> </span><a href="#local-6989586621684773987"><span class="hs-identifier hs-var">rule_base</span></a><span> </span><a href="#local-6989586621684773988"><span class="hs-identifier hs-var">new_guys</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-identifier">unionRuleBase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span>
</span><a name="line-356"></a><a name="unionRuleBase"><a href="Rules.html#unionRuleBase"><span class="hs-identifier">unionRuleBase</span></a></a><span> </span><a name="local-6989586621684773989"><a href="#local-6989586621684773989"><span class="hs-identifier">rb1</span></a></a><span> </span><a name="local-6989586621684773990"><a href="#local-6989586621684773990"><span class="hs-identifier">rb2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#plusNameEnv_C"><span class="hs-identifier hs-var">plusNameEnv_C</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684773989"><span class="hs-identifier hs-var">rb1</span></a><span> </span><a href="#local-6989586621684773990"><span class="hs-identifier hs-var">rb2</span></a><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span class="hs-identifier">extendRuleBase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span>
</span><a name="line-359"></a><a name="extendRuleBase"><a href="Rules.html#extendRuleBase"><span class="hs-identifier">extendRuleBase</span></a></a><span> </span><a name="local-6989586621684773991"><a href="#local-6989586621684773991"><span class="hs-identifier">rule_base</span></a></a><span> </span><a name="local-6989586621684773992"><a href="#local-6989586621684773992"><span class="hs-identifier">rule</span></a></a><span>
</span><a name="line-360"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#extendNameEnv_Acc"><span class="hs-identifier hs-var">extendNameEnv_Acc</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><a href="Util.html#singleton"><span class="hs-identifier hs-var">singleton</span></a><span> </span><a href="#local-6989586621684773991"><span class="hs-identifier hs-var">rule_base</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleIdName"><span class="hs-identifier hs-var">ruleIdName</span></a><span> </span><a href="#local-6989586621684773992"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684773992"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-identifier">pprRuleBase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-363"></a><a name="pprRuleBase"><a href="Rules.html#pprRuleBase"><span class="hs-identifier">pprRuleBase</span></a></a><span> </span><a name="local-6989586621684773993"><a href="#local-6989586621684773993"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#pprUFM"><span class="hs-identifier hs-var">pprUFM</span></a><span> </span><a href="#local-6989586621684773993"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684773994"><a href="#local-6989586621684773994"><span class="hs-identifier">rss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-364"></a><span>  </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="PprCore.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyRules"><span class="hs-identifier hs-var">tidyRules</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="#local-6989586621684773995"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684773995"><a href="#local-6989586621684773995"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684773994"><span class="hs-identifier hs-var">rss</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                        Matching
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-comment">-- | The main rule matching function. Attempts to apply all (active)</span><span>
</span><a name="line-376"></a><span class="hs-comment">-- supplied rules to this instance of an application in a given</span><span>
</span><a name="line-377"></a><span class="hs-comment">-- context, returning the rule applied and the resulting expression if</span><span>
</span><a name="line-378"></a><span class="hs-comment">-- successful.</span><span>
</span><a name="line-379"></a><span class="hs-identifier">lookupRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span>
</span><a name="line-380"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- When rule is active</span><span>
</span><a name="line-381"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span>
</span><a name="line-382"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span class="hs-comment">-- See Note [Extra args in rule matching]</span><span>
</span><a name="line-385"></a><span class="hs-comment">-- See comments on matchRule</span><span>
</span><a name="line-386"></a><a name="lookupRule"><a href="Rules.html#lookupRule"><span class="hs-identifier">lookupRule</span></a></a><span> </span><a name="local-6989586621684773996"><a href="#local-6989586621684773996"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684773997"><a href="#local-6989586621684773997"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684773998"><a href="#local-6989586621684773998"><span class="hs-identifier">is_active</span></a></a><span> </span><a name="local-6989586621684773999"><a href="#local-6989586621684773999"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621684774000"><a href="#local-6989586621684774000"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684774001"><a href="#local-6989586621684774001"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-387"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;matchRules&quot; (ppr fn &lt;+&gt; ppr args $$ ppr rules ) $</span><span>
</span><a name="line-388"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684774005"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684774001"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-389"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-390"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684774011"><a href="#local-6989586621684774011"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684774012"><a href="#local-6989586621684774012"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684773999"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">,</span><a href="#local-6989586621684774003"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774011"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621684774012"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-392"></a><span>    </span><a name="local-6989586621684774002"><a href="#local-6989586621684774002"><span class="hs-identifier">rough_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a><span> </span><a href="#local-6989586621684774000"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-393"></a><span>
</span><a name="line-394"></a><span>    </span><span class="hs-comment">-- Strip ticks from arguments, see note [Tick annotations in RULE</span><span>
</span><a name="line-395"></a><span>    </span><span class="hs-comment">-- matching]. We only collect ticks if a rule actually matches -</span><span>
</span><a name="line-396"></a><span>    </span><span class="hs-comment">-- this matters for performance tests.</span><span>
</span><a name="line-397"></a><span>    </span><a name="local-6989586621684774003"><a href="#local-6989586621684774003"><span class="hs-identifier">args'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774000"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-398"></a><span>    </span><a name="local-6989586621684774004"><a href="#local-6989586621684774004"><span class="hs-identifier">ticks</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#stripTicksTopT"><span class="hs-identifier hs-var">stripTicksTopT</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774000"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-399"></a><span>
</span><a name="line-400"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-401"></a><span>    </span><a name="local-6989586621684774005"><a href="#local-6989586621684774005"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684774006"><a href="#local-6989586621684774006"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774006"><span class="hs-identifier hs-var">ms</span></a><span>
</span><a name="line-402"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684774007"><a href="#local-6989586621684774007"><span class="hs-identifier">ms</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684774008"><a href="#local-6989586621684774008"><span class="hs-identifier">r</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684774009"><a href="#local-6989586621684774009"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-403"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774010"><a href="#local-6989586621684774010"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#matchRule"><span class="hs-identifier hs-var">matchRule</span></a><span> </span><a href="#local-6989586621684773996"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684773997"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684773998"><span class="hs-identifier hs-var">is_active</span></a><span> </span><a href="#local-6989586621684773999"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621684774003"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621684774002"><span class="hs-identifier hs-var">rough_args</span></a><span> </span><a href="#local-6989586621684774008"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-404"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774005"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684774008"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">,</span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><a href="#local-6989586621684774004"><span class="hs-identifier hs-var">ticks</span></a><span> </span><a href="#local-6989586621684774010"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a href="#local-6989586621684774007"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774009"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-405"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-406"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;match failed&quot; (ppr r $$ ppr args $$</span><span>
</span><a name="line-407"></a><span>        </span><span class="hs-comment">--   ppr [ (arg_id, unfoldingTemplate unf)</span><span>
</span><a name="line-408"></a><span>        </span><span class="hs-comment">--       | Var arg_id &lt;- args</span><span>
</span><a name="line-409"></a><span>        </span><span class="hs-comment">--       , let unf = idUnfolding arg_id</span><span>
</span><a name="line-410"></a><span>        </span><span class="hs-comment">--       , isCheapUnfolding unf] )</span><span>
</span><a name="line-411"></a><span>        </span><a href="#local-6989586621684774005"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684774007"><span class="hs-identifier hs-var">ms</span></a><span> </span><a href="#local-6989586621684774009"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span class="hs-identifier">findBest</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-414"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- All these pairs matched the expression</span><span>
</span><a name="line-416"></a><span class="hs-comment">-- Return the pair the most specific rule</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- The (fn,args) is just for overlap reporting</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><a name="findBest"><a href="Rules.html#findBest"><span class="hs-identifier">findBest</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a name="local-6989586621684774013"><a href="#local-6989586621684774013"><span class="hs-identifier">rule</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774014"><a href="#local-6989586621684774014"><span class="hs-identifier">ans</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774013"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">,</span><a href="#local-6989586621684774014"><span class="hs-identifier hs-var">ans</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span class="hs-identifier">findBest</span><span> </span><a name="local-6989586621684774015"><a href="#local-6989586621684774015"><span class="hs-identifier">target</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684774016"><a href="#local-6989586621684774016"><span class="hs-identifier">rule1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774017"><a href="#local-6989586621684774017"><span class="hs-identifier">ans1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684774018"><a href="#local-6989586621684774018"><span class="hs-identifier">rule2</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774019"><a href="#local-6989586621684774019"><span class="hs-identifier">ans2</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684774020"><a href="#local-6989586621684774020"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774016"><span class="hs-identifier hs-var">rule1</span></a><span> </span><span class="hs-special">`</span><a href="Rules.html#isMoreSpecific"><span class="hs-identifier hs-var">isMoreSpecific</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684774018"><span class="hs-identifier hs-var">rule2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a><span> </span><a href="#local-6989586621684774015"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774016"><span class="hs-identifier hs-var">rule1</span></a><span class="hs-special">,</span><a href="#local-6989586621684774017"><span class="hs-identifier hs-var">ans1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774020"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-422"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774018"><span class="hs-identifier hs-var">rule2</span></a><span> </span><span class="hs-special">`</span><a href="Rules.html#isMoreSpecific"><span class="hs-identifier hs-var">isMoreSpecific</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684774016"><span class="hs-identifier hs-var">rule1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a><span> </span><a href="#local-6989586621684774015"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774018"><span class="hs-identifier hs-var">rule2</span></a><span class="hs-special">,</span><a href="#local-6989586621684774019"><span class="hs-identifier hs-var">ans2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774020"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-423"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684774023"><a href="#local-6989586621684774023"><span class="hs-identifier">pp_rule</span></a></a><span> </span><a name="local-6989586621684774024"><a href="#local-6989586621684774024"><span class="hs-identifier">rule</span></a></a><span>
</span><a name="line-424"></a><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ifPprDebug"><span class="hs-identifier hs-var">ifPprDebug</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774024"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-425"></a><span>                                   </span><span class="hs-special">(</span><a href="Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a><span> </span><a href="#local-6989586621684774024"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span>                </span><span class="hs-keyword">in</span><span> </span><a href="Outputable.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a><span> </span><span class="hs-string">&quot;Rules.findBest: rule overlap (Rule 1 wins)&quot;</span><span>
</span><a name="line-427"></a><span>                         </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#whenPprDebug"><span class="hs-identifier hs-var">whenPprDebug</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-428"></a><span>                                 </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Expression to match:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774021"><span class="hs-identifier hs-var">fn</span></a><span>
</span><a name="line-429"></a><span>                                 </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774022"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-430"></a><span>                               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule 1:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621684774023"><span class="hs-identifier hs-var">pp_rule</span></a><span> </span><a href="#local-6989586621684774016"><span class="hs-identifier hs-var">rule1</span></a><span>
</span><a name="line-431"></a><span>                               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule 2:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621684774023"><span class="hs-identifier hs-var">pp_rule</span></a><span> </span><a href="#local-6989586621684774018"><span class="hs-identifier hs-var">rule2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-432"></a><span>                </span><a href="Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a><span> </span><a href="#local-6989586621684774015"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774016"><span class="hs-identifier hs-var">rule1</span></a><span class="hs-special">,</span><a href="#local-6989586621684774017"><span class="hs-identifier hs-var">ans1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774020"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#findBest"><span class="hs-identifier hs-var">findBest</span></a><span> </span><a href="#local-6989586621684774015"><span class="hs-identifier hs-var">target</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774016"><span class="hs-identifier hs-var">rule1</span></a><span class="hs-special">,</span><a href="#local-6989586621684774017"><span class="hs-identifier hs-var">ans1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774020"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-434"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-435"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684774021"><a href="#local-6989586621684774021"><span class="hs-identifier">fn</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774022"><a href="#local-6989586621684774022"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774015"><span class="hs-identifier hs-var">target</span></a><span>
</span><a name="line-436"></a><span>
</span><a name="line-437"></a><span class="hs-identifier">isMoreSpecific</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-438"></a><span class="hs-comment">-- This tests if one rule is more specific than another</span><span>
</span><a name="line-439"></a><span class="hs-comment">-- We take the view that a BuiltinRule is less specific than</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- anything else, because we want user-define rules to &quot;win&quot;</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- In particular, class ops have a built-in rule, but we</span><span>
</span><a name="line-442"></a><span class="hs-comment">-- any user-specific rules to win</span><span>
</span><a name="line-443"></a><span class="hs-comment">--   eg (Trac #4397)</span><span>
</span><a name="line-444"></a><span class="hs-comment">--      truncate :: (RealFrac a, Integral b) =&gt; a -&gt; b</span><span>
</span><a name="line-445"></a><span class="hs-comment">--      {-# RULES &quot;truncate/Double-&gt;Int&quot; truncate = double2Int #-}</span><span>
</span><a name="line-446"></a><span class="hs-comment">--      double2Int :: Double -&gt; Int</span><span>
</span><a name="line-447"></a><span class="hs-comment">--   We want the specific RULE to beat the built-in class-op rule</span><span>
</span><a name="line-448"></a><a name="isMoreSpecific"><a href="Rules.html#isMoreSpecific"><span class="hs-identifier">isMoreSpecific</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-449"></a><span class="hs-identifier">isMoreSpecific</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-450"></a><span class="hs-identifier">isMoreSpecific</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774025"><a href="#local-6989586621684774025"><span class="hs-identifier">bndrs1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774026"><a href="#local-6989586621684774026"><span class="hs-identifier">args1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>               </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774027"><a href="#local-6989586621684774027"><span class="hs-identifier">bndrs2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774028"><a href="#local-6989586621684774028"><span class="hs-identifier">args2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774029"><a href="#local-6989586621684774029"><span class="hs-identifier">rule_name2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-452"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><a href="Rules.html#matchN"><span class="hs-identifier hs-var">matchN</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774031"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684774030"><span class="hs-identifier hs-var">id_unfolding_fun</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774029"><span class="hs-identifier hs-var">rule_name2</span></a><span> </span><a href="#local-6989586621684774027"><span class="hs-identifier hs-var">bndrs2</span></a><span> </span><a href="#local-6989586621684774028"><span class="hs-identifier hs-var">args2</span></a><span> </span><a href="#local-6989586621684774026"><span class="hs-identifier hs-var">args1</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-454"></a><span>   </span><a name="local-6989586621684774030"><a href="#local-6989586621684774030"><span class="hs-identifier">id_unfolding_fun</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span>     </span><span class="hs-comment">-- Don't expand in templates</span><span>
</span><a name="line-455"></a><span>   </span><a name="local-6989586621684774031"><a href="#local-6989586621684774031"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621684774025"><span class="hs-identifier hs-var">bndrs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-456"></a><span>        </span><span class="hs-comment">-- Actually we should probably include the free vars</span><span>
</span><a name="line-457"></a><span>        </span><span class="hs-comment">-- of rule1's args, but I can't be bothered</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-identifier">noBlackList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-460"></a><a name="noBlackList"><a href="Rules.html#noBlackList"><span class="hs-identifier">noBlackList</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>           </span><span class="hs-comment">-- Nothing is black listed</span><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span class="hs-comment">{-
Note [Extra args in rule matching]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we find a matching rule, we return (Just (rule, rhs)),
but the rule firing has only consumed as many of the input args
as the ruleArity says.  It's up to the caller to keep track
of any left-over args.  E.g. if you call
        lookupRule ... f [e1, e2, e3]
and it returns Just (r, rhs), where r has ruleArity 2
then the real rewrite is
        f e1 e2 e3 ==&gt; rhs e3

You might think it'd be cleaner for lookupRule to deal with the
leftover arguments, by applying 'rhs' to them, but the main call
in the Simplifier works better as it is.  Reason: the 'args' passed
to lookupRule are the result of a lazy substitution
-}</span><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-comment">------------------------------------</span><span>
</span><a name="line-481"></a><span class="hs-identifier">matchRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span>
</span><a name="line-483"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-comment">-- If (matchRule rule args) returns Just (name,rhs)</span><span>
</span><a name="line-486"></a><span class="hs-comment">-- then (f args) matches the rule, and the corresponding</span><span>
</span><a name="line-487"></a><span class="hs-comment">-- rewritten RHS is rhs</span><span>
</span><a name="line-488"></a><span class="hs-comment">--</span><span>
</span><a name="line-489"></a><span class="hs-comment">-- The returned expression is occurrence-analysed</span><span>
</span><a name="line-490"></a><span class="hs-comment">--</span><span>
</span><a name="line-491"></a><span class="hs-comment">--      Example</span><span>
</span><a name="line-492"></a><span class="hs-comment">--</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- The rule</span><span>
</span><a name="line-494"></a><span class="hs-comment">--      forall f g x. map f (map g x) ==&gt; map (f . g) x</span><span>
</span><a name="line-495"></a><span class="hs-comment">-- is stored</span><span>
</span><a name="line-496"></a><span class="hs-comment">--      CoreRule &quot;map/map&quot;</span><span>
</span><a name="line-497"></a><span class="hs-comment">--               [f,g,x]                -- tpl_vars</span><span>
</span><a name="line-498"></a><span class="hs-comment">--               [f,map g x]            -- tpl_args</span><span>
</span><a name="line-499"></a><span class="hs-comment">--               map (f.g) x)           -- rhs</span><span>
</span><a name="line-500"></a><span class="hs-comment">--</span><span>
</span><a name="line-501"></a><span class="hs-comment">-- Then the call: matchRule the_rule [e1,map e2 e3]</span><span>
</span><a name="line-502"></a><span class="hs-comment">--        = Just (&quot;map/map&quot;, (\f,g,x -&gt; rhs) e1 e2 e3)</span><span>
</span><a name="line-503"></a><span class="hs-comment">--</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- Any 'surplus' arguments in the input are simply put on the end</span><span>
</span><a name="line-505"></a><span class="hs-comment">-- of the output.</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><a name="matchRule"><a href="Rules.html#matchRule"><span class="hs-identifier">matchRule</span></a></a><span> </span><a name="local-6989586621684774032"><a href="#local-6989586621684774032"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684774033"><a href="#local-6989586621684774033"><span class="hs-identifier">rule_env</span></a></a><span> </span><a name="local-6989586621684774034"><a href="#local-6989586621684774034"><span class="hs-identifier">_is_active</span></a></a><span> </span><a name="local-6989586621684774035"><a href="#local-6989586621684774035"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621684774036"><a href="#local-6989586621684774036"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684774037"><a href="#local-6989586621684774037"><span class="hs-identifier">_rough_args</span></a></a><span>
</span><a name="line-508"></a><span>          </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_try</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774038"><a href="#local-6989586621684774038"><span class="hs-identifier">match_fn</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- Built-in rules can't be switched off, it seems</span><span>
</span><a name="line-510"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684774038"><span class="hs-identifier hs-var">match_fn</span></a><span> </span><a href="#local-6989586621684774032"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684774033"><span class="hs-identifier hs-var">rule_env</span></a><span> </span><a href="#local-6989586621684774035"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621684774036"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-511"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-512"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774039"><a href="#local-6989586621684774039"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684774039"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-identifier">matchRule</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774040"><a href="#local-6989586621684774040"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684774041"><a href="#local-6989586621684774041"><span class="hs-identifier">is_active</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774042"><a href="#local-6989586621684774042"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684774043"><a href="#local-6989586621684774043"><span class="hs-identifier">rough_args</span></a></a><span>
</span><a name="line-515"></a><span>          </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774044"><a href="#local-6989586621684774044"><span class="hs-identifier">rule_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_act</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774045"><a href="#local-6989586621684774045"><span class="hs-identifier">act</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rough</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774046"><a href="#local-6989586621684774046"><span class="hs-identifier">tpl_tops</span></a></a><span>
</span><a name="line-516"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774047"><a href="#local-6989586621684774047"><span class="hs-identifier">tpl_vars</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774048"><a href="#local-6989586621684774048"><span class="hs-identifier">tpl_args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774049"><a href="#local-6989586621684774049"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-517"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774041"><span class="hs-identifier hs-var">is_active</span></a><span> </span><a href="#local-6989586621684774045"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-518"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Rules.html#ruleCantMatch"><span class="hs-identifier hs-var">ruleCantMatch</span></a><span> </span><a href="#local-6989586621684774046"><span class="hs-identifier hs-var">tpl_tops</span></a><span> </span><a href="#local-6989586621684774043"><span class="hs-identifier hs-var">rough_args</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-519"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-520"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Rules.html#matchN"><span class="hs-identifier hs-var">matchN</span></a><span> </span><a href="#local-6989586621684774040"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684774044"><span class="hs-identifier hs-var">rule_name</span></a><span> </span><a href="#local-6989586621684774047"><span class="hs-identifier hs-var">tpl_vars</span></a><span> </span><a href="#local-6989586621684774048"><span class="hs-identifier hs-var">tpl_args</span></a><span> </span><a href="#local-6989586621684774042"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-521"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-522"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774051"><a href="#local-6989586621684774051"><span class="hs-identifier">bind_wrapper</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774052"><a href="#local-6989586621684774052"><span class="hs-identifier">tpl_vals</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774051"><span class="hs-identifier hs-var">bind_wrapper</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-523"></a><span>                                               </span><a href="#local-6989586621684774050"><span class="hs-identifier hs-var">rule_fn</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684774052"><span class="hs-identifier hs-var">tpl_vals</span></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-525"></a><span>    </span><a name="local-6989586621684774050"><a href="#local-6989586621684774050"><span class="hs-identifier">rule_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621684774047"><span class="hs-identifier hs-var">tpl_vars</span></a><span> </span><a href="#local-6989586621684774049"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-comment">---------------------------------------</span><span>
</span><a name="line-528"></a><span class="hs-identifier">matchN</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span>
</span><a name="line-529"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span>
</span><a name="line-530"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- ^ Target; can have more elements than the template</span><span>
</span><a name="line-531"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Rules.html#BindWrapper"><span class="hs-identifier hs-type">BindWrapper</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Floated bindings; see Note [Matching lets]</span><span>
</span><a name="line-532"></a><span>                  </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span class="hs-comment">-- For a given match template and context, find bindings to wrap around</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- the entire result and what should be substituted for each template variable.</span><span>
</span><a name="line-535"></a><span class="hs-comment">-- Fail if there are two few actual arguments from the target to match the template</span><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><a name="matchN"><a href="Rules.html#matchN"><span class="hs-identifier">matchN</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684774053"><a href="#local-6989586621684774053"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774054"><a href="#local-6989586621684774054"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684774055"><a href="#local-6989586621684774055"><span class="hs-identifier">rule_name</span></a></a><span> </span><a name="local-6989586621684774056"><a href="#local-6989586621684774056"><span class="hs-identifier">tmpl_vars</span></a></a><span> </span><a name="local-6989586621684774057"><a href="#local-6989586621684774057"><span class="hs-identifier">tmpl_es</span></a></a><span> </span><a name="local-6989586621684774058"><a href="#local-6989586621684774058"><span class="hs-identifier">target_es</span></a></a><span>
</span><a name="line-538"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774087"><a href="#local-6989586621684774087"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684774062"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684774061"><span class="hs-identifier hs-var">init_menv</span></a><span> </span><a href="Rules.html#emptyRuleSubst"><span class="hs-identifier hs-var">emptyRuleSubst</span></a><span> </span><a href="#local-6989586621684774057"><span class="hs-identifier hs-var">tmpl_es</span></a><span> </span><a href="#local-6989586621684774058"><span class="hs-identifier hs-var">target_es</span></a><span>
</span><a name="line-539"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684774088"><a href="#local-6989586621684774088"><span class="hs-identifier">matched_es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621684774063"><span class="hs-identifier hs-var">lookup_tmpl</span></a><span> </span><a href="#local-6989586621684774087"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-540"></a><span>                                </span><a href="#local-6989586621684774056"><span class="hs-identifier hs-var">tmpl_vars</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684774060"><span class="hs-identifier hs-var">tmpl_vars1</span></a><span>
</span><a name="line-541"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rs_binds</span><span> </span><a href="#local-6989586621684774087"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684774088"><span class="hs-identifier hs-var">matched_es</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-542"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-543"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684774059"><a href="#local-6989586621684774059"><span class="hs-identifier">init_rn_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774060"><a href="#local-6989586621684774060"><span class="hs-identifier">tmpl_vars1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="VarEnv.html#rnBndrL"><span class="hs-identifier hs-var">rnBndrL</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a><span> </span><a href="#local-6989586621684774053"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774056"><span class="hs-identifier hs-var">tmpl_vars</span></a><span>
</span><a name="line-544"></a><span>                  </span><span class="hs-comment">-- See Note [Cloning the template binders]</span><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span>    </span><a name="local-6989586621684774061"><a href="#local-6989586621684774061"><span class="hs-identifier">init_menv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#RV"><span class="hs-identifier hs-var">RV</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rv_tmpls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621684774060"><span class="hs-identifier hs-var">tmpl_vars1</span></a><span>
</span><a name="line-547"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_lcl</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774059"><span class="hs-identifier hs-var">init_rn_env</span></a><span>
</span><a name="line-548"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_fltR</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a><span> </span><a href="#local-6989586621684774059"><span class="hs-identifier hs-var">init_rn_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_unf</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774054"><span class="hs-identifier hs-var">id_unf</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span>    </span><a name="local-6989586621684774062"><a href="#local-6989586621684774062"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><a name="local-6989586621684774065"><a href="#local-6989586621684774065"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684774065"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-552"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-identifier">_</span><span>     </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-comment">-- Fail if too few actual args</span><span>
</span><a name="line-553"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684774066"><a href="#local-6989586621684774066"><span class="hs-identifier">menv</span></a></a><span> </span><a name="local-6989586621684774067"><a href="#local-6989586621684774067"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684774068"><a href="#local-6989586621684774068"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684774069"><a href="#local-6989586621684774069"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774070"><a href="#local-6989586621684774070"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684774071"><a href="#local-6989586621684774071"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774072"><a href="#local-6989586621684774072"><span class="hs-identifier">subst1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774066"><span class="hs-identifier hs-var">menv</span></a><span> </span><a href="#local-6989586621684774067"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774068"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="#local-6989586621684774070"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-554"></a><span>                                     </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621684774062"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684774066"><span class="hs-identifier hs-var">menv</span></a><span> </span><a href="#local-6989586621684774072"><span class="hs-identifier hs-var">subst1</span></a><span> </span><a href="#local-6989586621684774069"><span class="hs-identifier hs-var">ts</span></a><span> </span><a href="#local-6989586621684774071"><span class="hs-identifier hs-var">es</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-555"></a><span>
</span><a name="line-556"></a><span>    </span><span class="hs-identifier">lookup_tmpl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span class="hs-special">,</span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>                   </span><span class="hs-comment">-- Need to return a RuleSubst solely for the benefit of mk_fake_ty</span><span>
</span><a name="line-558"></a><span>    </span><a name="local-6989586621684774063"><a href="#local-6989586621684774063"><span class="hs-identifier">lookup_tmpl</span></a></a><span> </span><a name="local-6989586621684774073"><a href="#local-6989586621684774073"><span class="hs-identifier">rs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Rules.html#RS"><span class="hs-identifier hs-var">RS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_tv_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774074"><a href="#local-6989586621684774074"><span class="hs-identifier">tv_subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rs_id_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774075"><a href="#local-6989586621684774075"><span class="hs-identifier">id_subst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-559"></a><span>                </span><span class="hs-special">(</span><a name="local-6989586621684774076"><a href="#local-6989586621684774076"><span class="hs-identifier">tmpl_var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774077"><a href="#local-6989586621684774077"><span class="hs-identifier">tmpl_var1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-560"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684774077"><span class="hs-identifier hs-var">tmpl_var1</span></a><span>
</span><a name="line-561"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684774075"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-6989586621684774077"><span class="hs-identifier hs-var">tmpl_var1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-562"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774080"><a href="#local-6989586621684774080"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774073"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684774080"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774081"><a href="#local-6989586621684774081"><span class="hs-identifier">refl_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCoVar_maybe"><span class="hs-identifier hs-var">isReflCoVar_maybe</span></a><span> </span><a href="#local-6989586621684774077"><span class="hs-identifier hs-var">tmpl_var1</span></a><span>
</span><a name="line-564"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684774082"><a href="#local-6989586621684774082"><span class="hs-identifier">co_expr</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621684774081"><span class="hs-identifier hs-var">refl_co</span></a><span>
</span><a name="line-565"></a><span>                           </span><a name="local-6989586621684774083"><a href="#local-6989586621684774083"><span class="hs-identifier">id_subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684774075"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-6989586621684774077"><span class="hs-identifier hs-var">tmpl_var1</span></a><span> </span><a href="#local-6989586621684774082"><span class="hs-identifier hs-var">co_expr</span></a><span>
</span><a name="line-566"></a><span>                           </span><a name="local-6989586621684774084"><a href="#local-6989586621684774084"><span class="hs-identifier">rs'</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774073"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_id_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774083"><span class="hs-identifier hs-var">id_subst'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-567"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774084"><span class="hs-identifier hs-var">rs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684774082"><span class="hs-identifier hs-var">co_expr</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Unbound RULE binders]</span><span>
</span><a name="line-568"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-569"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684774064"><span class="hs-identifier hs-var">unbound</span></a><span> </span><a href="#local-6989586621684774076"><span class="hs-identifier hs-var">tmpl_var</span></a><span>
</span><a name="line-570"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-571"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684774074"><span class="hs-identifier hs-var">tv_subst</span></a><span> </span><a href="#local-6989586621684774077"><span class="hs-identifier hs-var">tmpl_var1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-572"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774085"><a href="#local-6989586621684774085"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774073"><span class="hs-identifier hs-var">rs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621684774085"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774078"><span class="hs-identifier hs-var">rs'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621684774079"><span class="hs-identifier hs-var">fake_ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Unbound RULE binders]</span><span>
</span><a name="line-574"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-575"></a><span>          </span><a name="local-6989586621684774078"><a href="#local-6989586621684774078"><span class="hs-identifier">rs'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774073"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_tv_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684774074"><span class="hs-identifier hs-var">tv_subst</span></a><span> </span><a href="#local-6989586621684774077"><span class="hs-identifier hs-var">tmpl_var1</span></a><span> </span><a href="#local-6989586621684774079"><span class="hs-identifier hs-var">fake_ty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-576"></a><span>          </span><a name="local-6989586621684774079"><a href="#local-6989586621684774079"><span class="hs-identifier">fake_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#mk_fake_ty"><span class="hs-identifier hs-var">mk_fake_ty</span></a><span> </span><a href="#local-6989586621684774053"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684774073"><span class="hs-identifier hs-var">rs</span></a><span> </span><a href="#local-6989586621684774077"><span class="hs-identifier hs-var">tmpl_var1</span></a><span>
</span><a name="line-577"></a><span>                    </span><span class="hs-comment">-- This call is the sole reason we accumulate</span><span>
</span><a name="line-578"></a><span>                    </span><span class="hs-comment">-- RuleSubst in lookup_tmpl</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span>    </span><a name="local-6989586621684774064"><a href="#local-6989586621684774064"><span class="hs-identifier">unbound</span></a></a><span> </span><a name="local-6989586621684774086"><a href="#local-6989586621684774086"><span class="hs-identifier">tmpl_var</span></a></a><span>
</span><a name="line-581"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;Template variable unbound in rewrite rule&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-582"></a><span>         </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Variable:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774086"><span class="hs-identifier hs-var">tmpl_var</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621684774086"><span class="hs-identifier hs-var">tmpl_var</span></a><span class="hs-special">)</span><span>
</span><a name="line-583"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="BasicTypes.html#pprRuleName"><span class="hs-identifier hs-var">pprRuleName</span></a><span> </span><a href="#local-6989586621684774055"><span class="hs-identifier hs-var">rule_name</span></a><span>
</span><a name="line-584"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule bndrs:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774056"><span class="hs-identifier hs-var">tmpl_vars</span></a><span>
</span><a name="line-585"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;LHS args:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774057"><span class="hs-identifier hs-var">tmpl_es</span></a><span>
</span><a name="line-586"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Actual args:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774058"><span class="hs-identifier hs-var">target_es</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span class="hs-identifier">mk_fake_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>
</span><a name="line-590"></a><span class="hs-comment">-- Roughly:</span><span>
</span><a name="line-591"></a><span class="hs-comment">--    mk_fake_ty subst tv = Any @(subst (tyVarKind tv))</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- That is: apply the substitution to the kind of the given tyvar,</span><span>
</span><a name="line-593"></a><span class="hs-comment">-- and make an 'any' type of that kind.</span><span>
</span><a name="line-594"></a><span class="hs-comment">-- Tiresomely, the RuleSubst is not well adapted to substTy, leading to</span><span>
</span><a name="line-595"></a><span class="hs-comment">-- horrible impedence matching.</span><span>
</span><a name="line-596"></a><span class="hs-comment">--</span><span>
</span><a name="line-597"></a><span class="hs-comment">-- Happily, this function is seldom called</span><span>
</span><a name="line-598"></a><a name="mk_fake_ty"><a href="Rules.html#mk_fake_ty"><span class="hs-identifier">mk_fake_ty</span></a></a><span> </span><a name="local-6989586621684774089"><a href="#local-6989586621684774089"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-special">(</span><a href="Rules.html#RS"><span class="hs-identifier hs-var">RS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_tv_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774090"><a href="#local-6989586621684774090"><span class="hs-identifier">tv_subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rs_id_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774091"><a href="#local-6989586621684774091"><span class="hs-identifier">id_subst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684774092"><a href="#local-6989586621684774092"><span class="hs-identifier">tmpl_var1</span></a></a><span>
</span><a name="line-599"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TysWiredIn.html#anyTypeOfKind"><span class="hs-identifier hs-var">anyTypeOfKind</span></a><span> </span><a href="#local-6989586621684774093"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-600"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-601"></a><span>    </span><a name="local-6989586621684774093"><a href="#local-6989586621684774093"><span class="hs-identifier">kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">Type.substTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTCvSubst"><span class="hs-identifier hs-var">mkTCvSubst</span></a><span> </span><a href="#local-6989586621684774089"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774090"><span class="hs-identifier hs-var">tv_subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684774094"><span class="hs-identifier hs-var">cv_subst</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-602"></a><span>                        </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621684774092"><span class="hs-identifier hs-var">tmpl_var1</span></a><span class="hs-special">)</span><span>
</span><a name="line-603"></a><span>
</span><a name="line-604"></a><span>    </span><a name="local-6989586621684774094"><a href="#local-6989586621684774094"><span class="hs-identifier">cv_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774095"><span class="hs-identifier hs-var">to_co_env</span></a><span> </span><a href="#local-6989586621684774091"><span class="hs-identifier hs-var">id_subst</span></a><span>
</span><a name="line-605"></a><span>
</span><a name="line-606"></a><span>    </span><span class="hs-identifier">to_co_env</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a><span>
</span><a name="line-607"></a><span>    </span><a name="local-6989586621684774095"><a href="#local-6989586621684774095"><span class="hs-identifier">to_co_env</span></a></a><span> </span><a name="local-6989586621684774097"><a href="#local-6989586621684774097"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#nonDetFoldUFM_Directly"><span class="hs-identifier hs-var">nonDetFoldUFM_Directly</span></a><span> </span><a href="#local-6989586621684774096"><span class="hs-identifier hs-var">to_co</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="#local-6989586621684774097"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-608"></a><span>      </span><span class="hs-comment">-- It's OK to use nonDetFoldUFM_Directly because we forget the</span><span>
</span><a name="line-609"></a><span>      </span><span class="hs-comment">-- order immediately by creating a new env</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span>    </span><a name="local-6989586621684774096"><a href="#local-6989586621684774096"><span class="hs-identifier">to_co</span></a></a><span> </span><a name="local-6989586621684774098"><a href="#local-6989586621684774098"><span class="hs-identifier">uniq</span></a></a><span> </span><a name="local-6989586621684774099"><a href="#local-6989586621684774099"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684774100"><a href="#local-6989586621684774100"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-612"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSyn.html#exprToCoercion_maybe"><span class="hs-identifier hs-var">exprToCoercion_maybe</span></a><span> </span><a href="#local-6989586621684774099"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-613"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774101"><a href="#local-6989586621684774101"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#extendVarEnv_Directly"><span class="hs-identifier hs-var">extendVarEnv_Directly</span></a><span> </span><a href="#local-6989586621684774100"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774098"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621684774101"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-614"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684774100"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span class="hs-comment">{- Note [Unbound RULE binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It can be the case that the binder in a rule is not actually
bound on the LHS:

* Type variables.  Type synonyms with phantom args can give rise to
  unbound template type variables.  Consider this (Trac #10689,
  simplCore/should_compile/T10689):

    type Foo a b = b

    f :: Eq a =&gt; a -&gt; Bool
    f x = x==x

    {-# RULES &quot;foo&quot; forall (x :: Foo a Char). f x = True #-}
    finkle = f 'c'

  The rule looks like
    forall (a::*) (d::Eq Char) (x :: Foo a Char).
         f (Foo a Char) d x = True

  Matching the rule won't bind 'a', and legitimately so.  We fudge by
  pretending that 'a' is bound to (Any :: *).

* Coercion variables.  On the LHS of a RULE for a local binder
  we might have
    RULE forall (c :: a~b). f (x |&gt; c) = e
  Now, if that binding is inlined, so that a=b=Int, we'd get
    RULE forall (c :: Int~Int). f (x |&gt; c) = e
  and now when we simplify the LHS (Simplify.simplRule) we
  optCoercion will turn that 'c' into Refl:
    RULE forall (c :: Int~Int). f (x |&gt; &lt;Int&gt;) = e
  and then perhaps drop it altogether.  Now 'c' is unbound.

  It's tricky to be sure this never happens, so instead I
  say it's OK to have an unbound coercion binder in a RULE
  provided its type is (c :: t~t).  Then, when the RULE
  fires we can substitute &lt;t&gt; for c.

  This actually happened (in a RULE for a local function)
  in Trac #13410, and also in test T10602.


Note [Cloning the template binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following match (example 1):
        Template:  forall x.  f x
        Target:               f (x+1)
This should succeed, because the template variable 'x' has nothing to
do with the 'x' in the target.

Likewise this one (example 2):
        Template:  forall x. f (\x.x)
        Target:              f (\y.y)

We achieve this simply by using rnBndrL to clone the template
binders if they are already in scope.

------ Historical note -------
At one point I tried simply adding the template binders to the
in-scope set /without/ cloning them, but that failed in a horribly
obscure way in Trac #14777.  Problem was that during matching we look
up target-term variables in the in-scope set (see Note [Lookup
in-scope]).  If a target-term variable happens to name-clash with a
template variable, that lookup will find the template variable, which
is /utterly/ bogus.  In Trac #14777, this transformed a term variable
into a type variable, and then crashed when we wanted its idInfo.
------ End of historical note -------


************************************************************************
*                                                                      *
                   The main matcher
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span class="hs-comment">-- * The domain of the TvSubstEnv and IdSubstEnv are the template</span><span>
</span><a name="line-693"></a><span class="hs-comment">--   variables passed into the match.</span><span>
</span><a name="line-694"></a><span class="hs-comment">--</span><span>
</span><a name="line-695"></a><span class="hs-comment">-- * The BindWrapper in a RuleSubst are the bindings floated out</span><span>
</span><a name="line-696"></a><span class="hs-comment">--   from nested matches; see the Let case of match, below</span><span>
</span><a name="line-697"></a><span class="hs-comment">--</span><span>
</span><a name="line-698"></a><span class="hs-keyword">data</span><span> </span><a name="RuleMatchEnv"><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier">RuleMatchEnv</span></a></a><span>
</span><a name="line-699"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="RV"><a href="Rules.html#RV"><span class="hs-identifier">RV</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="rv_lcl"><a href="Rules.html#rv_lcl"><span class="hs-identifier">rv_lcl</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span>          </span><span class="hs-comment">-- Renamings for *local bindings*</span><span>
</span><a name="line-700"></a><span>                                     </span><span class="hs-comment">--   (lambda/case)</span><span>
</span><a name="line-701"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="rv_tmpls"><a href="Rules.html#rv_tmpls"><span class="hs-identifier">rv_tmpls</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>          </span><span class="hs-comment">-- Template variables</span><span>
</span><a name="line-702"></a><span>                                     </span><span class="hs-comment">--   (after applying envL of rv_lcl)</span><span>
</span><a name="line-703"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="rv_fltR"><a href="Rules.html#rv_fltR"><span class="hs-identifier">rv_fltR</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>           </span><span class="hs-comment">-- Renamings for floated let-bindings</span><span>
</span><a name="line-704"></a><span>                                     </span><span class="hs-comment">--   (domain disjoint from envR of rv_lcl)</span><span>
</span><a name="line-705"></a><span>                                     </span><span class="hs-comment">-- See Note [Matching lets]</span><span>
</span><a name="line-706"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="rv_unf"><a href="Rules.html#rv_unf"><span class="hs-identifier">rv_unf</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#IdUnfoldingFun"><span class="hs-identifier hs-type">IdUnfoldingFun</span></a><span>
</span><a name="line-707"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-708"></a><span>
</span><a name="line-709"></a><span class="hs-identifier">rvInScopeEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span>
</span><a name="line-710"></a><a name="rvInScopeEnv"><a href="Rules.html#rvInScopeEnv"><span class="hs-identifier">rvInScopeEnv</span></a></a><span> </span><a name="local-6989586621684774102"><a href="#local-6989586621684774102"><span class="hs-identifier">renv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_lcl</span><span> </span><a href="#local-6989586621684774102"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_unf</span><span> </span><a href="#local-6989586621684774102"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>
</span><a name="line-712"></a><span class="hs-keyword">data</span><span> </span><a name="RuleSubst"><a href="Rules.html#RuleSubst"><span class="hs-identifier">RuleSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="RS"><a href="Rules.html#RS"><span class="hs-identifier">RS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="rs_tv_subst"><a href="Rules.html#rs_tv_subst"><span class="hs-identifier">rs_tv_subst</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a><span>   </span><span class="hs-comment">-- Range is the</span><span>
</span><a name="line-713"></a><span>                    </span><span class="hs-special">,</span><span> </span><a name="rs_id_subst"><a href="Rules.html#rs_id_subst"><span class="hs-identifier">rs_id_subst</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a><span>   </span><span class="hs-comment">--   template variables</span><span>
</span><a name="line-714"></a><span>                    </span><span class="hs-special">,</span><span> </span><a name="rs_binds"><a href="Rules.html#rs_binds"><span class="hs-identifier">rs_binds</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#BindWrapper"><span class="hs-identifier hs-type">BindWrapper</span></a><span>  </span><span class="hs-comment">-- Floated bindings</span><span>
</span><a name="line-715"></a><span>                    </span><span class="hs-special">,</span><span> </span><a name="rs_bndrs"><a href="Rules.html#rs_bndrs"><span class="hs-identifier">rs_bndrs</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>       </span><span class="hs-comment">-- Variables bound by floated lets</span><span>
</span><a name="line-716"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-717"></a><span>
</span><a name="line-718"></a><span class="hs-keyword">type</span><span> </span><a name="BindWrapper"><a href="Rules.html#BindWrapper"><span class="hs-identifier">BindWrapper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-719"></a><span>  </span><span class="hs-comment">-- See Notes [Matching lets] and [Matching cases]</span><span>
</span><a name="line-720"></a><span>  </span><span class="hs-comment">-- we represent the floated bindings as a core-to-core function</span><span>
</span><a name="line-721"></a><span>
</span><a name="line-722"></a><span class="hs-identifier">emptyRuleSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-723"></a><a name="emptyRuleSubst"><a href="Rules.html#emptyRuleSubst"><span class="hs-identifier">emptyRuleSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#RS"><span class="hs-identifier hs-var">RS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_tv_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rs_id_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-724"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684774103"><a href="#local-6989586621684774103"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684774103"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rs_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span class="hs-comment">--      At one stage I tried to match even if there are more</span><span>
</span><a name="line-727"></a><span class="hs-comment">--      template args than real args.</span><span>
</span><a name="line-728"></a><span>
</span><a name="line-729"></a><span class="hs-comment">--      I now think this is probably a bad idea.</span><span>
</span><a name="line-730"></a><span class="hs-comment">--      Should the template (map f xs) match (map g)?  I think not.</span><span>
</span><a name="line-731"></a><span class="hs-comment">--      For a start, in general eta expansion wastes work.</span><span>
</span><a name="line-732"></a><span class="hs-comment">--      SLPJ July 99</span><span>
</span><a name="line-733"></a><span>
</span><a name="line-734"></a><span class="hs-identifier">match</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span>
</span><a name="line-735"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-736"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>               </span><span class="hs-comment">-- Template</span><span>
</span><a name="line-737"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>               </span><span class="hs-comment">-- Target</span><span>
</span><a name="line-738"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span class="hs-comment">-- We look through certain ticks. See note [Tick annotations in RULE matching]</span><span>
</span><a name="line-741"></a><a name="match"><a href="Rules.html#match"><span class="hs-identifier">match</span></a></a><span> </span><a name="local-6989586621684774104"><a href="#local-6989586621684774104"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774105"><a href="#local-6989586621684774105"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774106"><a href="#local-6989586621684774106"><span class="hs-identifier">e1</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684774107"><a href="#local-6989586621684774107"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684774108"><a href="#local-6989586621684774108"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-742"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-6989586621684774107"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-743"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774104"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774109"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621684774106"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684774108"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-744"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684774109"><a href="#local-6989586621684774109"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774105"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rs_binds</span><span> </span><a href="#local-6989586621684774105"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-6989586621684774107"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-745"></a><span class="hs-identifier">match</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774110"><a href="#local-6989586621684774110"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">@</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-746"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;Tick in rule&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774110"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-747"></a><span>
</span><a name="line-748"></a><span class="hs-comment">-- See the notes with Unify.match, which matches types</span><span>
</span><a name="line-749"></a><span class="hs-comment">-- Everything is very similar for terms</span><span>
</span><a name="line-750"></a><span>
</span><a name="line-751"></a><span class="hs-comment">-- Interesting examples:</span><span>
</span><a name="line-752"></a><span class="hs-comment">-- Consider matching</span><span>
</span><a name="line-753"></a><span class="hs-comment">--      \x-&gt;f      against    \f-&gt;f</span><span>
</span><a name="line-754"></a><span class="hs-comment">-- When we meet the lambdas we must remember to rename f to f' in the</span><span>
</span><a name="line-755"></a><span class="hs-comment">-- second expression.  The RnEnv2 does that.</span><span>
</span><a name="line-756"></a><span class="hs-comment">--</span><span>
</span><a name="line-757"></a><span class="hs-comment">-- Consider matching</span><span>
</span><a name="line-758"></a><span class="hs-comment">--      forall a. \b-&gt;b    against   \a-&gt;3</span><span>
</span><a name="line-759"></a><span class="hs-comment">-- We must rename the \a.  Otherwise when we meet the lambdas we</span><span>
</span><a name="line-760"></a><span class="hs-comment">-- might substitute [a/b] in the template, and then erroneously</span><span>
</span><a name="line-761"></a><span class="hs-comment">-- succeed in matching what looks like the template variable 'a' against 3.</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span class="hs-comment">-- The Var case follows closely what happens in Unify.match</span><span>
</span><a name="line-764"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774111"><a href="#local-6989586621684774111"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774112"><a href="#local-6989586621684774112"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684774113"><a href="#local-6989586621684774113"><span class="hs-identifier">v1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684774114"><a href="#local-6989586621684774114"><span class="hs-identifier">e2</span></a></a><span>
</span><a name="line-765"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match_var"><span class="hs-identifier hs-var">match_var</span></a><span> </span><a href="#local-6989586621684774111"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774112"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774113"><span class="hs-identifier hs-var">v1</span></a><span> </span><a href="#local-6989586621684774114"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-766"></a><span>
</span><a name="line-767"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774115"><a href="#local-6989586621684774115"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774116"><a href="#local-6989586621684774116"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774117"><a href="#local-6989586621684774117"><span class="hs-identifier">e1</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684774118"><a href="#local-6989586621684774118"><span class="hs-identifier">v2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Note [Expanding variables]</span><span>
</span><a name="line-768"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#inRnEnvR"><span class="hs-identifier hs-var">inRnEnvR</span></a><span> </span><a href="#local-6989586621684774120"><span class="hs-identifier hs-var">rn_env</span></a><span> </span><a href="#local-6989586621684774118"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Note [Do not expand locally-bound variables]</span><span>
</span><a name="line-769"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774121"><a href="#local-6989586621684774121"><span class="hs-identifier">e2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_unf</span><span> </span><a href="#local-6989586621684774115"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774119"><span class="hs-identifier hs-var">v2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-770"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774115"><span class="hs-identifier hs-var">renv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rv_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#nukeRnEnvR"><span class="hs-identifier hs-var">nukeRnEnvR</span></a><span> </span><a href="#local-6989586621684774120"><span class="hs-identifier hs-var">rn_env</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774116"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774117"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684774121"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-771"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-772"></a><span>    </span><a name="local-6989586621684774119"><a href="#local-6989586621684774119"><span class="hs-identifier">v2'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#lookupRnInScope"><span class="hs-identifier hs-var">lookupRnInScope</span></a><span> </span><a href="#local-6989586621684774120"><span class="hs-identifier hs-var">rn_env</span></a><span> </span><a href="#local-6989586621684774118"><span class="hs-identifier hs-var">v2</span></a><span>
</span><a name="line-773"></a><span>    </span><a name="local-6989586621684774120"><a href="#local-6989586621684774120"><span class="hs-identifier">rn_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rv_lcl</span><span> </span><a href="#local-6989586621684774115"><span class="hs-identifier hs-var">renv</span></a><span>
</span><a name="line-774"></a><span>        </span><span class="hs-comment">-- Notice that we look up v2 in the in-scope set</span><span>
</span><a name="line-775"></a><span>        </span><span class="hs-comment">-- See Note [Lookup in-scope]</span><span>
</span><a name="line-776"></a><span>        </span><span class="hs-comment">-- No need to apply any renaming first (hence no rnOccR)</span><span>
</span><a name="line-777"></a><span>        </span><span class="hs-comment">-- because of the not-inRnEnvR</span><span>
</span><a name="line-778"></a><span>
</span><a name="line-779"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774122"><a href="#local-6989586621684774122"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774123"><a href="#local-6989586621684774123"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774124"><a href="#local-6989586621684774124"><span class="hs-identifier">e1</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621684774125"><a href="#local-6989586621684774125"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621684774126"><a href="#local-6989586621684774126"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-780"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- pprTrace &quot;match:Let&quot; (vcat [ppr bind, ppr $ okToFloat (rv_lcl renv) (bindFreeVars bind)]) $</span><span>
</span><a name="line-781"></a><span>    </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#isJoinBind"><span class="hs-identifier hs-var">isJoinBind</span></a><span> </span><a href="#local-6989586621684774125"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- can't float join point out of argument position</span><span>
</span><a name="line-782"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Rules.html#okToFloat"><span class="hs-identifier hs-var">okToFloat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_lcl</span><span> </span><a href="#local-6989586621684774122"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#bindFreeVars"><span class="hs-identifier hs-var">bindFreeVars</span></a><span> </span><a href="#local-6989586621684774125"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Matching lets]</span><span>
</span><a name="line-783"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774122"><span class="hs-identifier hs-var">renv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rv_fltR</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774128"><span class="hs-identifier hs-var">flt_subst'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>          </span><span class="hs-special">(</span><a href="#local-6989586621684774123"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rs_binds</span><span> </span><a href="#local-6989586621684774123"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-6989586621684774129"><span class="hs-identifier hs-var">bind'</span></a><span>
</span><a name="line-785"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rs_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#extendVarSetList"><span class="hs-identifier hs-var">extendVarSetList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rs_bndrs</span><span> </span><a href="#local-6989586621684774123"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774130"><span class="hs-identifier hs-var">new_bndrs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-786"></a><span>          </span><a href="#local-6989586621684774124"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684774126"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-787"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-788"></a><span>    </span><a name="local-6989586621684774127"><a href="#local-6989586621684774127"><span class="hs-identifier">flt_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#addInScopeSet"><span class="hs-identifier hs-var">addInScopeSet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_fltR</span><span> </span><a href="#local-6989586621684774122"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rs_bndrs</span><span> </span><a href="#local-6989586621684774123"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-789"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684774128"><a href="#local-6989586621684774128"><span class="hs-identifier">flt_subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774129"><a href="#local-6989586621684774129"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span> </span><a href="#local-6989586621684774127"><span class="hs-identifier hs-var">flt_subst</span></a><span> </span><a href="#local-6989586621684774125"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-790"></a><span>    </span><a name="local-6989586621684774130"><a href="#local-6989586621684774130"><span class="hs-identifier">new_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a><span> </span><a href="#local-6989586621684774129"><span class="hs-identifier hs-var">bind'</span></a><span>
</span><a name="line-791"></a><span>
</span><a name="line-792"></a><span class="hs-comment">{- Disabled: see Note [Matching cases] below
match renv (tv_subst, id_subst, binds) e1
      (Case scrut case_bndr ty [(con, alt_bndrs, rhs)])
  | exprOkForSpeculation scrut  -- See Note [Matching cases]
  , okToFloat rn_env bndrs (exprFreeVars scrut)
  = match (renv { me_env = rn_env' })
          (tv_subst, id_subst, binds . case_wrap)
          e1 rhs
  where
    rn_env   = me_env renv
    rn_env'  = extendRnInScopeList rn_env bndrs
    bndrs    = case_bndr : alt_bndrs
    case_wrap rhs' = Case scrut case_bndr ty [(con, alt_bndrs, rhs')]
-}</span><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span class="hs-identifier">match</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774131"><a href="#local-6989586621684774131"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621684774132"><a href="#local-6989586621684774132"><span class="hs-identifier">lit1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621684774133"><a href="#local-6989586621684774133"><span class="hs-identifier">lit2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-808"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774132"><span class="hs-identifier hs-var">lit1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684774133"><span class="hs-identifier hs-var">lit2</span></a><span>
</span><a name="line-809"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684774131"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774134"><a href="#local-6989586621684774134"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774135"><a href="#local-6989586621684774135"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684774136"><a href="#local-6989586621684774136"><span class="hs-identifier">f1</span></a></a><span> </span><a name="local-6989586621684774137"><a href="#local-6989586621684774137"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684774138"><a href="#local-6989586621684774138"><span class="hs-identifier">f2</span></a></a><span> </span><a name="local-6989586621684774139"><a href="#local-6989586621684774139"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774140"><a href="#local-6989586621684774140"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774134"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774135"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774136"><span class="hs-identifier hs-var">f1</span></a><span> </span><a href="#local-6989586621684774138"><span class="hs-identifier hs-var">f2</span></a><span>
</span><a name="line-813"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774134"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774140"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621684774137"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-6989586621684774139"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-814"></a><span>
</span><a name="line-815"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774141"><a href="#local-6989586621684774141"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774142"><a href="#local-6989586621684774142"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684774143"><a href="#local-6989586621684774143"><span class="hs-identifier">x1</span></a></a><span> </span><a name="local-6989586621684774144"><a href="#local-6989586621684774144"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684774145"><a href="#local-6989586621684774145"><span class="hs-identifier">e2</span></a></a><span>
</span><a name="line-816"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774146"><a href="#local-6989586621684774146"><span class="hs-identifier">x2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774147"><a href="#local-6989586621684774147"><span class="hs-identifier">e2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774148"><a href="#local-6989586621684774148"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span> </span><span class="hs-special">(</span><a href="Rules.html#rvInScopeEnv"><span class="hs-identifier hs-var">rvInScopeEnv</span></a><span> </span><a href="#local-6989586621684774141"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774145"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-817"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684774149"><a href="#local-6989586621684774149"><span class="hs-identifier">renv'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774141"><span class="hs-identifier hs-var">renv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rv_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_lcl</span><span> </span><a href="#local-6989586621684774141"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774143"><span class="hs-identifier hs-var">x1</span></a><span> </span><a href="#local-6989586621684774146"><span class="hs-identifier hs-var">x2</span></a><span>
</span><a name="line-818"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_fltR</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#delBndr"><span class="hs-identifier hs-var">delBndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_fltR</span><span> </span><a href="#local-6989586621684774141"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774146"><span class="hs-identifier hs-var">x2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-819"></a><span>        </span><a name="local-6989586621684774150"><a href="#local-6989586621684774150"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774142"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_binds</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rs_binds</span><span> </span><a href="#local-6989586621684774142"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774148"><span class="hs-identifier hs-var">ts</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-820"></a><span>    </span><span class="hs-keyword">in</span><span>  </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774149"><span class="hs-identifier hs-var">renv'</span></a><span> </span><a href="#local-6989586621684774150"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621684774144"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684774147"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-821"></a><span>
</span><a name="line-822"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774151"><a href="#local-6989586621684774151"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774152"><a href="#local-6989586621684774152"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621684774153"><a href="#local-6989586621684774153"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684774154"><a href="#local-6989586621684774154"><span class="hs-identifier">x1</span></a></a><span> </span><a name="local-6989586621684774155"><a href="#local-6989586621684774155"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621684774156"><a href="#local-6989586621684774156"><span class="hs-identifier">alts1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621684774157"><a href="#local-6989586621684774157"><span class="hs-identifier">e2</span></a></a><span> </span><a name="local-6989586621684774158"><a href="#local-6989586621684774158"><span class="hs-identifier">x2</span></a></a><span> </span><a name="local-6989586621684774159"><a href="#local-6989586621684774159"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621684774160"><a href="#local-6989586621684774160"><span class="hs-identifier">alts2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774161"><a href="#local-6989586621684774161"><span class="hs-identifier">subst1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#match_ty"><span class="hs-identifier hs-var">match_ty</span></a><span> </span><a href="#local-6989586621684774151"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774152"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774155"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621684774159"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-824"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621684774162"><a href="#local-6989586621684774162"><span class="hs-identifier">subst2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774151"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774161"><span class="hs-identifier hs-var">subst1</span></a><span> </span><a href="#local-6989586621684774153"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684774157"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-825"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684774163"><a href="#local-6989586621684774163"><span class="hs-identifier">renv'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#rnMatchBndr2"><span class="hs-identifier hs-var">rnMatchBndr2</span></a><span> </span><a href="#local-6989586621684774151"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774152"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774154"><span class="hs-identifier hs-var">x1</span></a><span> </span><a href="#local-6989586621684774158"><span class="hs-identifier hs-var">x2</span></a><span>
</span><a name="line-826"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Rules.html#match_alts"><span class="hs-identifier hs-var">match_alts</span></a><span> </span><a href="#local-6989586621684774163"><span class="hs-identifier hs-var">renv'</span></a><span> </span><a href="#local-6989586621684774162"><span class="hs-identifier hs-var">subst2</span></a><span> </span><a href="#local-6989586621684774156"><span class="hs-identifier hs-var">alts1</span></a><span> </span><a href="#local-6989586621684774160"><span class="hs-identifier hs-var">alts2</span></a><span>   </span><span class="hs-comment">-- Alts are both sorted</span><span>
</span><a name="line-827"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-828"></a><span>
</span><a name="line-829"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774164"><a href="#local-6989586621684774164"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774165"><a href="#local-6989586621684774165"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684774166"><a href="#local-6989586621684774166"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684774167"><a href="#local-6989586621684774167"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match_ty"><span class="hs-identifier hs-var">match_ty</span></a><span> </span><a href="#local-6989586621684774164"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774165"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774166"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621684774167"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-831"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774168"><a href="#local-6989586621684774168"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774169"><a href="#local-6989586621684774169"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684774170"><a href="#local-6989586621684774170"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684774171"><a href="#local-6989586621684774171"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-832"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match_co"><span class="hs-identifier hs-var">match_co</span></a><span> </span><a href="#local-6989586621684774168"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774169"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774170"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621684774171"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span class="hs-identifier">match</span><span> </span><a name="local-6989586621684774172"><a href="#local-6989586621684774172"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774173"><a href="#local-6989586621684774173"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684774174"><a href="#local-6989586621684774174"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684774175"><a href="#local-6989586621684774175"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684774176"><a href="#local-6989586621684774176"><span class="hs-identifier">e2</span></a></a><span> </span><a name="local-6989586621684774177"><a href="#local-6989586621684774177"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-835"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774178"><a href="#local-6989586621684774178"><span class="hs-identifier">subst1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#match_co"><span class="hs-identifier hs-var">match_co</span></a><span> </span><a href="#local-6989586621684774172"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774173"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774175"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621684774177"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-836"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774172"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774178"><span class="hs-identifier hs-var">subst1</span></a><span> </span><a href="#local-6989586621684774174"><span class="hs-identifier hs-var">e1</span></a><span> </span><a href="#local-6989586621684774176"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-837"></a><span>
</span><a name="line-838"></a><span class="hs-comment">-- Everything else fails</span><span>
</span><a name="line-839"></a><span class="hs-identifier">match</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774179"><a href="#local-6989586621684774179"><span class="hs-identifier">_e1</span></a></a><span> </span><a name="local-6989586621684774180"><a href="#local-6989586621684774180"><span class="hs-identifier">_e2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;Failing at&quot; ((text &quot;e1:&quot; &lt;+&gt; ppr _e1) $$ (text &quot;e2:&quot; &lt;+&gt; ppr _e2)) $</span><span>
</span><a name="line-840"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-843"></a><span class="hs-identifier">match_co</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span>
</span><a name="line-844"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-845"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-846"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-847"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-848"></a><a name="match_co"><a href="Rules.html#match_co"><span class="hs-identifier">match_co</span></a></a><span> </span><a name="local-6989586621684774181"><a href="#local-6989586621684774181"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774182"><a href="#local-6989586621684774182"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774183"><a href="#local-6989586621684774183"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621684774184"><a href="#local-6989586621684774184"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-849"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774185"><a href="#local-6989586621684774185"><span class="hs-identifier">cv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#getCoVar_maybe"><span class="hs-identifier hs-var">getCoVar_maybe</span></a><span> </span><a href="#local-6989586621684774183"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-850"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match_var"><span class="hs-identifier hs-var">match_var</span></a><span> </span><a href="#local-6989586621684774181"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774182"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774185"><span class="hs-identifier hs-var">cv</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621684774184"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-851"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774186"><a href="#local-6989586621684774186"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774187"><a href="#local-6989586621684774187"><span class="hs-identifier">r1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621684774183"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-852"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774188"><a href="#local-6989586621684774188"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774189"><a href="#local-6989586621684774189"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621684774184"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-853"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">guard</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774187"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684774189"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span>
</span><a name="line-854"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="Rules.html#match_ty"><span class="hs-identifier hs-var">match_ty</span></a><span> </span><a href="#local-6989586621684774181"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774182"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774186"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621684774188"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-855"></a><span class="hs-identifier">match_co</span><span> </span><a name="local-6989586621684774190"><a href="#local-6989586621684774190"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774191"><a href="#local-6989586621684774191"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774192"><a href="#local-6989586621684774192"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621684774193"><a href="#local-6989586621684774193"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-856"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774194"><a href="#local-6989586621684774194"><span class="hs-identifier">tc1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774195"><a href="#local-6989586621684774195"><span class="hs-identifier">cos1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitTyConAppCo_maybe"><span class="hs-identifier hs-var">splitTyConAppCo_maybe</span></a><span> </span><a href="#local-6989586621684774192"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-857"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Coercion.html#splitTyConAppCo_maybe"><span class="hs-identifier hs-var">splitTyConAppCo_maybe</span></a><span> </span><a href="#local-6989586621684774193"><span class="hs-identifier hs-var">co2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-858"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774196"><a href="#local-6989586621684774196"><span class="hs-identifier">tc2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774197"><a href="#local-6989586621684774197"><span class="hs-identifier">cos2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-859"></a><span>        </span><span class="hs-glyph">|</span><span>  </span><a href="#local-6989586621684774194"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684774196"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-860"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#match_cos"><span class="hs-identifier hs-var">match_cos</span></a><span> </span><a href="#local-6989586621684774190"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774191"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774195"><span class="hs-identifier hs-var">cos1</span></a><span> </span><a href="#local-6989586621684774197"><span class="hs-identifier hs-var">cos2</span></a><span>
</span><a name="line-861"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-862"></a><span class="hs-identifier">match_co</span><span> </span><a name="local-6989586621684774198"><a href="#local-6989586621684774198"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774199"><a href="#local-6989586621684774199"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774200"><a href="#local-6989586621684774200"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621684774201"><a href="#local-6989586621684774201"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-863"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774202"><a href="#local-6989586621684774202"><span class="hs-identifier">arg1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774203"><a href="#local-6989586621684774203"><span class="hs-identifier">res1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitFunCo_maybe"><span class="hs-identifier hs-var">splitFunCo_maybe</span></a><span> </span><a href="#local-6989586621684774200"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-864"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Coercion.html#splitFunCo_maybe"><span class="hs-identifier hs-var">splitFunCo_maybe</span></a><span> </span><a href="#local-6989586621684774201"><span class="hs-identifier hs-var">co2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-865"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774204"><a href="#local-6989586621684774204"><span class="hs-identifier">arg2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684774205"><a href="#local-6989586621684774205"><span class="hs-identifier">res2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-866"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#match_cos"><span class="hs-identifier hs-var">match_cos</span></a><span> </span><a href="#local-6989586621684774198"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774199"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684774202"><span class="hs-identifier hs-var">arg1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684774203"><span class="hs-identifier hs-var">res1</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684774204"><span class="hs-identifier hs-var">arg2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684774205"><span class="hs-identifier hs-var">res2</span></a><span class="hs-special">]</span><span>
</span><a name="line-867"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-868"></a><span class="hs-identifier">match_co</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774206"><a href="#local-6989586621684774206"><span class="hs-identifier">_co1</span></a></a><span> </span><a name="local-6989586621684774207"><a href="#local-6989586621684774207"><span class="hs-identifier">_co2</span></a></a><span>
</span><a name="line-869"></a><span>    </span><span class="hs-comment">-- Currently just deals with CoVarCo, TyConAppCo and Refl</span><span>
</span><a name="line-870"></a><span class="hs-cpp">#if defined(DEBUG)
</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pprTrace</span><span> </span><span class="hs-string">&quot;match_co: needs more cases&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">_co1</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">_co2</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><a name="line-872"></a><span class="hs-cpp">#else
</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-874"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-876"></a><span class="hs-identifier">match_cos</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span>
</span><a name="line-877"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-878"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-879"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-880"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-881"></a><a name="match_cos"><a href="Rules.html#match_cos"><span class="hs-identifier">match_cos</span></a></a><span> </span><a name="local-6989586621684774208"><a href="#local-6989586621684774208"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774209"><a href="#local-6989586621684774209"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684774210"><a href="#local-6989586621684774210"><span class="hs-identifier">co1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684774211"><a href="#local-6989586621684774211"><span class="hs-identifier">cos1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774212"><a href="#local-6989586621684774212"><span class="hs-identifier">co2</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684774213"><a href="#local-6989586621684774213"><span class="hs-identifier">cos2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-882"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774214"><a href="#local-6989586621684774214"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#match_co"><span class="hs-identifier hs-var">match_co</span></a><span> </span><a href="#local-6989586621684774208"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774209"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774210"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621684774212"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-883"></a><span>     </span><span class="hs-special">;</span><span> </span><a href="Rules.html#match_cos"><span class="hs-identifier hs-var">match_cos</span></a><span> </span><a href="#local-6989586621684774208"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774214"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621684774211"><span class="hs-identifier hs-var">cos1</span></a><span> </span><a href="#local-6989586621684774213"><span class="hs-identifier hs-var">cos2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-884"></a><span class="hs-identifier">match_cos</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774215"><a href="#local-6989586621684774215"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684774215"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-885"></a><span class="hs-identifier">match_cos</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774216"><a href="#local-6989586621684774216"><span class="hs-identifier">cos1</span></a></a><span> </span><a name="local-6989586621684774217"><a href="#local-6989586621684774217"><span class="hs-identifier">cos2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a><span> </span><span class="hs-string">&quot;match_cos: not same length&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774216"><span class="hs-identifier hs-var">cos1</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774217"><span class="hs-identifier hs-var">cos2</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-886"></a><span>
</span><a name="line-887"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-888"></a><span class="hs-identifier">rnMatchBndr2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span>
</span><a name="line-889"></a><a name="rnMatchBndr2"><a href="Rules.html#rnMatchBndr2"><span class="hs-identifier">rnMatchBndr2</span></a></a><span> </span><a name="local-6989586621684774218"><a href="#local-6989586621684774218"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774219"><a href="#local-6989586621684774219"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774220"><a href="#local-6989586621684774220"><span class="hs-identifier">x1</span></a></a><span> </span><a name="local-6989586621684774221"><a href="#local-6989586621684774221"><span class="hs-identifier">x2</span></a></a><span>
</span><a name="line-890"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774218"><span class="hs-identifier hs-var">renv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rv_lcl</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#rnBndr2"><span class="hs-identifier hs-var">rnBndr2</span></a><span> </span><a href="#local-6989586621684774222"><span class="hs-identifier hs-var">rn_env</span></a><span> </span><a href="#local-6989586621684774220"><span class="hs-identifier hs-var">x1</span></a><span> </span><a href="#local-6989586621684774221"><span class="hs-identifier hs-var">x2</span></a><span>
</span><a name="line-891"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_fltR</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#delBndr"><span class="hs-identifier hs-var">delBndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_fltR</span><span> </span><a href="#local-6989586621684774218"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774221"><span class="hs-identifier hs-var">x2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-892"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-893"></a><span>    </span><a name="local-6989586621684774222"><a href="#local-6989586621684774222"><span class="hs-identifier">rn_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#addRnInScopeSet"><span class="hs-identifier hs-var">addRnInScopeSet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_lcl</span><span> </span><a href="#local-6989586621684774218"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rs_bndrs</span><span> </span><a href="#local-6989586621684774219"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-894"></a><span>    </span><span class="hs-comment">-- Typically this is a no-op, but it may matter if</span><span>
</span><a name="line-895"></a><span>    </span><span class="hs-comment">-- there are some floated let-bindings</span><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-898"></a><span class="hs-identifier">match_alts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span>
</span><a name="line-899"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-900"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Template</span><span>
</span><a name="line-901"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Target</span><span>
</span><a name="line-902"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-903"></a><a name="match_alts"><a href="Rules.html#match_alts"><span class="hs-identifier">match_alts</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774223"><a href="#local-6989586621684774223"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-904"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621684774223"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-905"></a><span class="hs-identifier">match_alts</span><span> </span><a name="local-6989586621684774224"><a href="#local-6989586621684774224"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774225"><a href="#local-6989586621684774225"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684774226"><a href="#local-6989586621684774226"><span class="hs-identifier">c1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774227"><a href="#local-6989586621684774227"><span class="hs-identifier">vs1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774228"><a href="#local-6989586621684774228"><span class="hs-identifier">r1</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684774229"><a href="#local-6989586621684774229"><span class="hs-identifier">alts1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684774230"><a href="#local-6989586621684774230"><span class="hs-identifier">c2</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774231"><a href="#local-6989586621684774231"><span class="hs-identifier">vs2</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774232"><a href="#local-6989586621684774232"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684774233"><a href="#local-6989586621684774233"><span class="hs-identifier">alts2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774226"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684774230"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-907"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774239"><a href="#local-6989586621684774239"><span class="hs-identifier">subst1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774234"><span class="hs-identifier hs-var">renv'</span></a><span> </span><a href="#local-6989586621684774225"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774228"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-6989586621684774232"><span class="hs-identifier hs-var">r2</span></a><span>
</span><a name="line-908"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="Rules.html#match_alts"><span class="hs-identifier hs-var">match_alts</span></a><span> </span><a href="#local-6989586621684774224"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774239"><span class="hs-identifier hs-var">subst1</span></a><span> </span><a href="#local-6989586621684774229"><span class="hs-identifier hs-var">alts1</span></a><span> </span><a href="#local-6989586621684774233"><span class="hs-identifier hs-var">alts2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-909"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-910"></a><span>    </span><a name="local-6989586621684774234"><a href="#local-6989586621684774234"><span class="hs-identifier">renv'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684774235"><span class="hs-identifier hs-var">mb</span></a><span> </span><a href="#local-6989586621684774224"><span class="hs-identifier hs-var">renv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774227"><span class="hs-identifier hs-var">vs1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684774231"><span class="hs-identifier hs-var">vs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-911"></a><span>    </span><a name="local-6989586621684774235"><a href="#local-6989586621684774235"><span class="hs-identifier">mb</span></a></a><span> </span><a name="local-6989586621684774236"><a href="#local-6989586621684774236"><span class="hs-identifier">renv</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684774237"><a href="#local-6989586621684774237"><span class="hs-identifier">v1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774238"><a href="#local-6989586621684774238"><span class="hs-identifier">v2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#rnMatchBndr2"><span class="hs-identifier hs-var">rnMatchBndr2</span></a><span> </span><a href="#local-6989586621684774236"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774225"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774237"><span class="hs-identifier hs-var">v1</span></a><span> </span><a href="#local-6989586621684774238"><span class="hs-identifier hs-var">v2</span></a><span>
</span><a name="line-912"></a><span>
</span><a name="line-913"></a><span class="hs-identifier">match_alts</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-914"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-917"></a><span class="hs-identifier">okToFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-918"></a><a name="okToFloat"><a href="Rules.html#okToFloat"><span class="hs-identifier">okToFloat</span></a></a><span> </span><a name="local-6989586621684774240"><a href="#local-6989586621684774240"><span class="hs-identifier">rn_env</span></a></a><span> </span><a name="local-6989586621684774241"><a href="#local-6989586621684774241"><span class="hs-identifier">bind_fvs</span></a></a><span>
</span><a name="line-919"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#allVarSet"><span class="hs-identifier hs-var">allVarSet</span></a><span> </span><a href="#local-6989586621684774242"><span class="hs-identifier hs-var">not_captured</span></a><span> </span><a href="#local-6989586621684774241"><span class="hs-identifier hs-var">bind_fvs</span></a><span>
</span><a name="line-920"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-921"></a><span>    </span><a name="local-6989586621684774242"><a href="#local-6989586621684774242"><span class="hs-identifier">not_captured</span></a></a><span> </span><a name="local-6989586621684774243"><a href="#local-6989586621684774243"><span class="hs-identifier">fv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#inRnEnvR"><span class="hs-identifier hs-var">inRnEnvR</span></a><span> </span><a href="#local-6989586621684774240"><span class="hs-identifier hs-var">rn_env</span></a><span> </span><a href="#local-6989586621684774243"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">)</span><span>
</span><a name="line-922"></a><span>
</span><a name="line-923"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-924"></a><span class="hs-identifier">match_var</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span>
</span><a name="line-925"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-926"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>                </span><span class="hs-comment">-- Template</span><span>
</span><a name="line-927"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>        </span><span class="hs-comment">-- Target</span><span>
</span><a name="line-928"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-929"></a><a name="match_var"><a href="Rules.html#match_var"><span class="hs-identifier">match_var</span></a></a><span> </span><a name="local-6989586621684774244"><a href="#local-6989586621684774244"><span class="hs-identifier">renv</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Rules.html#RV"><span class="hs-identifier hs-var">RV</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rv_tmpls</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774245"><a href="#local-6989586621684774245"><span class="hs-identifier">tmpls</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774246"><a href="#local-6989586621684774246"><span class="hs-identifier">rn_env</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_fltR</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774247"><a href="#local-6989586621684774247"><span class="hs-identifier">flt_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-930"></a><span>          </span><a name="local-6989586621684774248"><a href="#local-6989586621684774248"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774249"><a href="#local-6989586621684774249"><span class="hs-identifier">v1</span></a></a><span> </span><a name="local-6989586621684774250"><a href="#local-6989586621684774250"><span class="hs-identifier">e2</span></a></a><span>
</span><a name="line-931"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774251"><span class="hs-identifier hs-var">v1'</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684774245"><span class="hs-identifier hs-var">tmpls</span></a><span>
</span><a name="line-932"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match_tmpl_var"><span class="hs-identifier hs-var">match_tmpl_var</span></a><span> </span><a href="#local-6989586621684774244"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774248"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684774251"><span class="hs-identifier hs-var">v1'</span></a><span> </span><a href="#local-6989586621684774250"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-933"></a><span>
</span><a name="line-934"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- v1' is not a template variable; check for an exact match with e2</span><span>
</span><a name="line-935"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684774250"><span class="hs-identifier hs-var">e2</span></a><span> </span><span class="hs-keyword">of</span><span>  </span><span class="hs-comment">-- Remember, envR of rn_env is disjoint from rv_fltR</span><span>
</span><a name="line-936"></a><span>       </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684774252"><a href="#local-6989586621684774252"><span class="hs-identifier">v2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774251"><span class="hs-identifier hs-var">v1'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="VarEnv.html#rnOccR"><span class="hs-identifier hs-var">rnOccR</span></a><span> </span><a href="#local-6989586621684774246"><span class="hs-identifier hs-var">rn_env</span></a><span> </span><a href="#local-6989586621684774252"><span class="hs-identifier hs-var">v2</span></a><span>
</span><a name="line-937"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684774248"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-938"></a><span>
</span><a name="line-939"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684774253"><a href="#local-6989586621684774253"><span class="hs-identifier">v2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;match_var&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774247"><span class="hs-identifier hs-var">flt_env</span></a><span> </span><a href="#local-6989586621684774252"><span class="hs-identifier hs-var">v2</span></a><span>
</span><a name="line-940"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684774251"><span class="hs-identifier hs-var">v1'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684774253"><span class="hs-identifier hs-var">v2'</span></a><span>
</span><a name="line-941"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684774248"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span>       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-944"></a><span>
</span><a name="line-945"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-946"></a><span>    </span><a name="local-6989586621684774251"><a href="#local-6989586621684774251"><span class="hs-identifier">v1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#rnOccL"><span class="hs-identifier hs-var">rnOccL</span></a><span> </span><a href="#local-6989586621684774246"><span class="hs-identifier hs-var">rn_env</span></a><span> </span><a href="#local-6989586621684774249"><span class="hs-identifier hs-var">v1</span></a><span>
</span><a name="line-947"></a><span>        </span><span class="hs-comment">-- If the template is</span><span>
</span><a name="line-948"></a><span>        </span><span class="hs-comment">--      forall x. f x (\x -&gt; x) = ...</span><span>
</span><a name="line-949"></a><span>        </span><span class="hs-comment">-- Then the x inside the lambda isn't the</span><span>
</span><a name="line-950"></a><span>        </span><span class="hs-comment">-- template x, so we must rename first!</span><span>
</span><a name="line-951"></a><span>
</span><a name="line-952"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-953"></a><span class="hs-identifier">match_tmpl_var</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span>
</span><a name="line-954"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-955"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>                </span><span class="hs-comment">-- Template</span><span>
</span><a name="line-956"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>              </span><span class="hs-comment">-- Target</span><span>
</span><a name="line-957"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-958"></a><span>
</span><a name="line-959"></a><a name="match_tmpl_var"><a href="Rules.html#match_tmpl_var"><span class="hs-identifier">match_tmpl_var</span></a></a><span> </span><a name="local-6989586621684774254"><a href="#local-6989586621684774254"><span class="hs-identifier">renv</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Rules.html#RV"><span class="hs-identifier hs-var">RV</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rv_lcl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774255"><a href="#local-6989586621684774255"><span class="hs-identifier">rn_env</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_fltR</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774256"><a href="#local-6989586621684774256"><span class="hs-identifier">flt_env</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-960"></a><span>               </span><a name="local-6989586621684774257"><a href="#local-6989586621684774257"><span class="hs-identifier">subst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Rules.html#RS"><span class="hs-identifier hs-var">RS</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_id_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774258"><a href="#local-6989586621684774258"><span class="hs-identifier">id_subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rs_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774259"><a href="#local-6989586621684774259"><span class="hs-identifier">let_bndrs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-961"></a><span>               </span><a name="local-6989586621684774260"><a href="#local-6989586621684774260"><span class="hs-identifier">v1'</span></a></a><span> </span><a name="local-6989586621684774261"><a href="#local-6989586621684774261"><span class="hs-identifier">e2</span></a></a><span>
</span><a name="line-962"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#inRnEnvR"><span class="hs-identifier hs-var">inRnEnvR</span></a><span> </span><a href="#local-6989586621684774255"><span class="hs-identifier hs-var">rn_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#exprFreeVarsList"><span class="hs-identifier hs-var">exprFreeVarsList</span></a><span> </span><a href="#local-6989586621684774261"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">)</span><span>
</span><a name="line-963"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>     </span><span class="hs-comment">-- Occurs check failure</span><span>
</span><a name="line-964"></a><span>                </span><span class="hs-comment">-- e.g. match forall a. (\x-&gt; a x) against (\y. y y)</span><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684774264"><a href="#local-6989586621684774264"><span class="hs-identifier">e1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684774258"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-6989586621684774260"><span class="hs-identifier hs-var">v1'</span></a><span>
</span><a name="line-967"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="CoreUtils.html#eqExpr"><span class="hs-identifier hs-var">eqExpr</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#rnInScopeSet"><span class="hs-identifier hs-var">rnInScopeSet</span></a><span> </span><a href="#local-6989586621684774255"><span class="hs-identifier hs-var">rn_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774264"><span class="hs-identifier hs-var">e1'</span></a><span> </span><a href="#local-6989586621684774262"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-968"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684774257"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-969"></a><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-970"></a><span>
</span><a name="line-971"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-972"></a><span>  </span><span class="hs-glyph">=</span><span>             </span><span class="hs-comment">-- Note [Matching variable types]</span><span>
</span><a name="line-973"></a><span>                </span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-974"></a><span>                </span><span class="hs-comment">-- However, we must match the *types*; e.g.</span><span>
</span><a name="line-975"></a><span>                </span><span class="hs-comment">--   forall (c::Char-&gt;Int) (x::Char).</span><span>
</span><a name="line-976"></a><span>                </span><span class="hs-comment">--      f (c x) = &quot;RULE FIRED&quot;</span><span>
</span><a name="line-977"></a><span>                </span><span class="hs-comment">-- We must only match on args that have the right type</span><span>
</span><a name="line-978"></a><span>                </span><span class="hs-comment">-- It's actually quite difficult to come up with an example that shows</span><span>
</span><a name="line-979"></a><span>                </span><span class="hs-comment">-- you need type matching, esp since matching is left-to-right, so type</span><span>
</span><a name="line-980"></a><span>                </span><span class="hs-comment">-- args get matched first.  But it's possible (e.g. simplrun008) and</span><span>
</span><a name="line-981"></a><span>                </span><span class="hs-comment">-- this is the Right Thing to do</span><span>
</span><a name="line-982"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774265"><a href="#local-6989586621684774265"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#match_ty"><span class="hs-identifier hs-var">match_ty</span></a><span> </span><a href="#local-6989586621684774254"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="#local-6989586621684774257"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621684774260"><span class="hs-identifier hs-var">v1'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621684774261"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774265"><span class="hs-identifier hs-var">subst'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_id_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774263"><span class="hs-identifier hs-var">id_subst'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-984"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-985"></a><span>    </span><span class="hs-comment">-- e2' is the result of applying flt_env to e2</span><span>
</span><a name="line-986"></a><span>    </span><a name="local-6989586621684774262"><a href="#local-6989586621684774262"><span class="hs-identifier">e2'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><a href="#local-6989586621684774259"><span class="hs-identifier hs-var">let_bndrs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774261"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-987"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;match_tmpl_var&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774256"><span class="hs-identifier hs-var">flt_env</span></a><span> </span><a href="#local-6989586621684774261"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-988"></a><span>
</span><a name="line-989"></a><span>    </span><a name="local-6989586621684774263"><a href="#local-6989586621684774263"><span class="hs-identifier">id_subst'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rs_id_subst</span><span> </span><a href="#local-6989586621684774257"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774260"><span class="hs-identifier hs-var">v1'</span></a><span> </span><a href="#local-6989586621684774262"><span class="hs-identifier hs-var">e2'</span></a><span>
</span><a name="line-990"></a><span>         </span><span class="hs-comment">-- No further renaming to do on e2',</span><span>
</span><a name="line-991"></a><span>         </span><span class="hs-comment">-- because no free var of e2' is in the rnEnvR of the envt</span><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-994"></a><span class="hs-identifier">match_ty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleMatchEnv"><span class="hs-identifier hs-type">RuleMatchEnv</span></a><span>
</span><a name="line-995"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-996"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>                </span><span class="hs-comment">-- Template</span><span>
</span><a name="line-997"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>                </span><span class="hs-comment">-- Target</span><span>
</span><a name="line-998"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Rules.html#RuleSubst"><span class="hs-identifier hs-type">RuleSubst</span></a><span>
</span><a name="line-999"></a><span class="hs-comment">-- Matching Core types: use the matcher in TcType.</span><span>
</span><a name="line-1000"></a><span class="hs-comment">-- Notice that we treat newtypes as opaque.  For example, suppose</span><span>
</span><a name="line-1001"></a><span class="hs-comment">-- we have a specialised version of a function at a newtype, say</span><span>
</span><a name="line-1002"></a><span class="hs-comment">--      newtype T = MkT Int</span><span>
</span><a name="line-1003"></a><span class="hs-comment">-- We only want to replace (f T) with f', not (f Int).</span><span>
</span><a name="line-1004"></a><span>
</span><a name="line-1005"></a><a name="match_ty"><a href="Rules.html#match_ty"><span class="hs-identifier">match_ty</span></a></a><span> </span><a name="local-6989586621684774266"><a href="#local-6989586621684774266"><span class="hs-identifier">renv</span></a></a><span> </span><a name="local-6989586621684774267"><a href="#local-6989586621684774267"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684774268"><a href="#local-6989586621684774268"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621684774269"><a href="#local-6989586621684774269"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-1006"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621684774271"><a href="#local-6989586621684774271"><span class="hs-identifier">tv_subst'</span></a></a><span>
</span><a name="line-1007"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Unify.html#ruleMatchTyKiX"><span class="hs-identifier hs-var">Unify.ruleMatchTyKiX</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_tmpls</span><span> </span><a href="#local-6989586621684774266"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rv_lcl</span><span> </span><a href="#local-6989586621684774266"><span class="hs-identifier hs-var">renv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774270"><span class="hs-identifier hs-var">tv_subst</span></a><span> </span><a href="#local-6989586621684774268"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621684774269"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1008"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774267"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rs_tv_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774271"><span class="hs-identifier hs-var">tv_subst'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1009"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1010"></a><span>    </span><a name="local-6989586621684774270"><a href="#local-6989586621684774270"><span class="hs-identifier">tv_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rs_tv_subst</span><span> </span><a href="#local-6989586621684774267"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-1011"></a><span>
</span><a name="line-1012"></a><span class="hs-comment">{-
Note [Expanding variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is another Very Important rule: if the term being matched is a
variable, we expand it so long as its unfolding is &quot;expandable&quot;. (Its
occurrence information is not necessarily up to date, so we don't use
it.)  By &quot;expandable&quot; we mean a WHNF or a &quot;constructor-like&quot; application.
This is the key reason for &quot;constructor-like&quot; Ids.  If we have
     {-# NOINLINE [1] CONLIKE g #-}
     {-# RULE f (g x) = h x #-}
then in the term
   let v = g 3 in ....(f v)....
we want to make the rule fire, to replace (f v) with (h 3).

Note [Do not expand locally-bound variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Do *not* expand locally-bound variables, else there's a worry that the
unfolding might mention variables that are themselves renamed.
Example
          case x of y { (p,q) -&gt; ...y... }
Don't expand 'y' to (p,q) because p,q might themselves have been
renamed.  Essentially we only expand unfoldings that are &quot;outside&quot;
the entire match.

Hence, (a) the guard (not (isLocallyBoundR v2))
       (b) when we expand we nuke the renaming envt (nukeRnEnvR).

Note [Tick annotations in RULE matching]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We used to unconditionally look through Notes in both template and
expression being matched. This is actually illegal for counting or
cost-centre-scoped ticks, because we have no place to put them without
changing entry counts and/or costs. So now we just fail the match in
these cases.

On the other hand, where we are allowed to insert new cost into the
tick scope, we can float them upwards to the rule application site.

cf Note [Notes in call patterns] in SpecConstr

Note [Matching lets]
~~~~~~~~~~~~~~~~~~~~
Matching a let-expression.  Consider
        RULE forall x.  f (g x) = &lt;rhs&gt;
and target expression
        f (let { w=R } in g E))
Then we'd like the rule to match, to generate
        let { w=R } in (\x. &lt;rhs&gt;) E
In effect, we want to float the let-binding outward, to enable
the match to happen.  This is the WHOLE REASON for accumulating
bindings in the RuleSubst

We can only do this if the free variables of R are not bound by the
part of the target expression outside the let binding; e.g.
        f (\v. let w = v+1 in g E)
Here we obviously cannot float the let-binding for w.  Hence the
use of okToFloat.

There are a couple of tricky points.
  (a) What if floating the binding captures a variable?
        f (let v = x+1 in v) v
      --&gt; NOT!
        let v = x+1 in f (x+1) v

  (b) What if two non-nested let bindings bind the same variable?
        f (let v = e1 in b1) (let v = e2 in b2)
      --&gt; NOT!
        let v = e1 in let v = e2 in (f b2 b2)
      See testsuite test &quot;RuleFloatLet&quot;.

Our cunning plan is this:
  * Along with the growing substitution for template variables
    we maintain a growing set of floated let-bindings (rs_binds)
    plus the set of variables thus bound.

  * The RnEnv2 in the MatchEnv binds only the local binders
    in the term (lambdas, case)

  * When we encounter a let in the term to be matched, we
    check that does not mention any locally bound (lambda, case)
    variables.  If so we fail

  * We use CoreSubst.substBind to freshen the binding, using an
    in-scope set that is the original in-scope variables plus the
    rs_bndrs (currently floated let-bindings).  So in (a) above
    we'll freshen the 'v' binding; in (b) above we'll freshen
    the *second* 'v' binding.

  * We apply that freshening substitution, in a lexically-scoped
    way to the term, although lazily; this is the rv_fltR field.


Note [Matching cases]
~~~~~~~~~~~~~~~~~~~~~
{- NOTE: This idea is currently disabled.  It really only works if
         the primops involved are OkForSpeculation, and, since
         they have side effects readIntOfAddr and touch are not.
         Maybe we'll get back to this later .  -}

Consider
   f (case readIntOffAddr# p# i# realWorld# of { (# s#, n# #) -&gt;
      case touch# fp s# of { _ -&gt;
      I# n# } } )
This happened in a tight loop generated by stream fusion that
Roman encountered.  We'd like to treat this just like the let
case, because the primops concerned are ok-for-speculation.
That is, we'd like to behave as if it had been
   case readIntOffAddr# p# i# realWorld# of { (# s#, n# #) -&gt;
   case touch# fp s# of { _ -&gt;
   f (I# n# } } )

Note [Lookup in-scope]
~~~~~~~~~~~~~~~~~~~~~~
Consider this example
        foo :: Int -&gt; Maybe Int -&gt; Int
        foo 0 (Just n) = n
        foo m (Just n) = foo (m-n) (Just n)

SpecConstr sees this fragment:

        case w_smT of wild_Xf [Just A] {
          Data.Maybe.Nothing -&gt; lvl_smf;
          Data.Maybe.Just n_acT [Just S(L)] -&gt;
            case n_acT of wild1_ams [Just A] { GHC.Base.I# y_amr [Just L] -&gt;
              $wfoo_smW (GHC.Prim.-# ds_Xmb y_amr) wild_Xf
            }};

and correctly generates the rule

        RULES: &quot;SC:$wfoo1&quot; [0] __forall {y_amr [Just L] :: GHC.Prim.Int#
                                          sc_snn :: GHC.Prim.Int#}
          $wfoo_smW sc_snn (Data.Maybe.Just @ GHC.Base.Int (GHC.Base.I# y_amr))
          = $s$wfoo_sno y_amr sc_snn ;]

BUT we must ensure that this rule matches in the original function!
Note that the call to $wfoo is
            $wfoo_smW (GHC.Prim.-# ds_Xmb y_amr) wild_Xf

During matching we expand wild_Xf to (Just n_acT).  But then we must also
expand n_acT to (I# y_amr).  And we can only do that if we look up n_acT
in the in-scope set, because in wild_Xf's unfolding it won't have an unfolding
at all.

That is why the 'lookupRnInScope' call in the (Var v2) case of 'match'
is so important.


************************************************************************
*                                                                      *
                   Rule-check the program
*                                                                      *
************************************************************************

   We want to know what sites have rules that could have fired but didn't.
   This pass runs over the tree (without changing it) and reports such.
-}</span><span>
</span><a name="line-1169"></a><span>
</span><a name="line-1170"></a><span class="hs-comment">-- | Report partial matches for rules beginning with the specified</span><span>
</span><a name="line-1171"></a><span class="hs-comment">-- string for the purposes of error reporting</span><span>
</span><a name="line-1172"></a><span class="hs-identifier">ruleCheckProgram</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#CompilerPhase"><span class="hs-identifier hs-type">CompilerPhase</span></a><span>               </span><span class="hs-comment">-- ^ Rule activation test</span><span>
</span><a name="line-1173"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>                      </span><span class="hs-comment">-- ^ Rule pattern</span><span>
</span><a name="line-1174"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>          </span><span class="hs-comment">-- ^ Rules for an Id</span><span>
</span><a name="line-1175"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span>                 </span><span class="hs-comment">-- ^ Bindings to check in</span><span>
</span><a name="line-1176"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>                        </span><span class="hs-comment">-- ^ Resulting check message</span><span>
</span><a name="line-1177"></a><a name="ruleCheckProgram"><a href="Rules.html#ruleCheckProgram"><span class="hs-identifier">ruleCheckProgram</span></a></a><span> </span><a name="local-6989586621684774272"><a href="#local-6989586621684774272"><span class="hs-identifier">phase</span></a></a><span> </span><a name="local-6989586621684774273"><a href="#local-6989586621684774273"><span class="hs-identifier">rule_pat</span></a></a><span> </span><a name="local-6989586621684774274"><a href="#local-6989586621684774274"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-6989586621684774275"><a href="#local-6989586621684774275"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-1178"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Bag.html#isEmptyBag"><span class="hs-identifier hs-var">isEmptyBag</span></a><span> </span><a href="#local-6989586621684774277"><span class="hs-identifier hs-var">results</span></a><span>
</span><a name="line-1179"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule check results: no rule application sites&quot;</span><span>
</span><a name="line-1180"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1181"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule check results:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1182"></a><span>          </span><a href="#local-6989586621684774278"><span class="hs-identifier hs-var">line</span></a><span class="hs-special">,</span><span>
</span><a name="line-1183"></a><span>          </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621684774279"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="#local-6989586621684774278"><span class="hs-identifier hs-var">line</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684774279"><a href="#local-6989586621684774279"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Bag.html#bagToList"><span class="hs-identifier hs-var">bagToList</span></a><span> </span><a href="#local-6989586621684774277"><span class="hs-identifier hs-var">results</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1184"></a><span>         </span><span class="hs-special">]</span><span>
</span><a name="line-1185"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1186"></a><span>    </span><a name="local-6989586621684774276"><a href="#local-6989586621684774276"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#RuleCheckEnv"><span class="hs-identifier hs-var">RuleCheckEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rc_is_active</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isActive"><span class="hs-identifier hs-var">isActive</span></a><span> </span><a href="#local-6989586621684774272"><span class="hs-identifier hs-var">phase</span></a><span>
</span><a name="line-1187"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rc_id_unf</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span>     </span><span class="hs-comment">-- Not quite right</span><span>
</span><a name="line-1188"></a><span>                                                        </span><span class="hs-comment">-- Should use activeUnfolding</span><span>
</span><a name="line-1189"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rc_pattern</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774273"><span class="hs-identifier hs-var">rule_pat</span></a><span>
</span><a name="line-1190"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rc_rules</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774274"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1191"></a><span>    </span><a name="local-6989586621684774277"><a href="#local-6989586621684774277"><span class="hs-identifier">results</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#unionManyBags"><span class="hs-identifier hs-var">unionManyBags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Rules.html#ruleCheckBind"><span class="hs-identifier hs-var">ruleCheckBind</span></a><span> </span><a href="#local-6989586621684774276"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774275"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1192"></a><span>    </span><a name="local-6989586621684774278"><a href="#local-6989586621684774278"><span class="hs-identifier">line</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-number">20</span><span> </span><span class="hs-char">'-'</span><span class="hs-special">)</span><span>
</span><a name="line-1193"></a><span>
</span><a name="line-1194"></a><span class="hs-keyword">data</span><span> </span><a name="RuleCheckEnv"><a href="Rules.html#RuleCheckEnv"><span class="hs-identifier">RuleCheckEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="RuleCheckEnv"><a href="Rules.html#RuleCheckEnv"><span class="hs-identifier">RuleCheckEnv</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1195"></a><span>    </span><a name="rc_is_active"><a href="Rules.html#rc_is_active"><span class="hs-identifier">rc_is_active</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>
</span><a name="line-1196"></a><span>    </span><a name="rc_id_unf"><a href="Rules.html#rc_id_unf"><span class="hs-identifier">rc_id_unf</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#IdUnfoldingFun"><span class="hs-identifier hs-type">IdUnfoldingFun</span></a><span class="hs-special">,</span><span>
</span><a name="line-1197"></a><span>    </span><a name="rc_pattern"><a href="Rules.html#rc_pattern"><span class="hs-identifier">rc_pattern</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span>
</span><a name="line-1198"></a><span>    </span><a name="rc_rules"><a href="Rules.html#rc_rules"><span class="hs-identifier">rc_rules</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-1199"></a><span class="hs-special">}</span><span>
</span><a name="line-1200"></a><span>
</span><a name="line-1201"></a><span class="hs-identifier">ruleCheckBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1202"></a><span>   </span><span class="hs-comment">-- The Bag returned has one SDoc for each call site found</span><span>
</span><a name="line-1203"></a><a name="ruleCheckBind"><a href="Rules.html#ruleCheckBind"><span class="hs-identifier">ruleCheckBind</span></a></a><span> </span><a name="local-6989586621684774280"><a href="#local-6989586621684774280"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774281"><a href="#local-6989586621684774281"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774280"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774281"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1204"></a><span class="hs-identifier">ruleCheckBind</span><span> </span><a name="local-6989586621684774282"><a href="#local-6989586621684774282"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621684774283"><a href="#local-6989586621684774283"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#unionManyBags"><span class="hs-identifier hs-var">unionManyBags</span></a><span> </span><span class="hs-special">[</span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774282"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774284"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684774284"><a href="#local-6989586621684774284"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684774283"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">]</span><span>
</span><a name="line-1205"></a><span>
</span><a name="line-1206"></a><span class="hs-identifier">ruleCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1207"></a><a name="ruleCheck"><a href="Rules.html#ruleCheck"><span class="hs-identifier">ruleCheck</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span>
</span><a name="line-1208"></a><span class="hs-identifier">ruleCheck</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span>
</span><a name="line-1209"></a><span class="hs-identifier">ruleCheck</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span>
</span><a name="line-1210"></a><span class="hs-identifier">ruleCheck</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span>
</span><a name="line-1211"></a><span class="hs-identifier">ruleCheck</span><span> </span><a name="local-6989586621684774285"><a href="#local-6989586621684774285"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684774286"><a href="#local-6989586621684774286"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621684774287"><a href="#local-6989586621684774287"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheckApp"><span class="hs-identifier hs-var">ruleCheckApp</span></a><span> </span><a href="#local-6989586621684774285"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621684774286"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621684774287"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1212"></a><span class="hs-identifier">ruleCheck</span><span> </span><a name="local-6989586621684774288"><a href="#local-6989586621684774288"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774289"><a href="#local-6989586621684774289"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774288"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774289"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1213"></a><span class="hs-identifier">ruleCheck</span><span> </span><a name="local-6989586621684774290"><a href="#local-6989586621684774290"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684774291"><a href="#local-6989586621684774291"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774290"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774291"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1214"></a><span class="hs-identifier">ruleCheck</span><span> </span><a name="local-6989586621684774292"><a href="#local-6989586621684774292"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621684774293"><a href="#local-6989586621684774293"><span class="hs-identifier">bd</span></a></a><span> </span><a name="local-6989586621684774294"><a href="#local-6989586621684774294"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheckBind"><span class="hs-identifier hs-var">ruleCheckBind</span></a><span> </span><a href="#local-6989586621684774292"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774293"><span class="hs-identifier hs-var">bd</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774292"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774294"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1215"></a><span class="hs-identifier">ruleCheck</span><span> </span><a name="local-6989586621684774295"><a href="#local-6989586621684774295"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684774296"><a href="#local-6989586621684774296"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774295"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774296"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1216"></a><span class="hs-identifier">ruleCheck</span><span> </span><a name="local-6989586621684774297"><a href="#local-6989586621684774297"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621684774298"><a href="#local-6989586621684774298"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774297"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774298"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span>
</span><a name="line-1217"></a><span>                                </span><a href="Bag.html#unionManyBags"><span class="hs-identifier hs-var">unionManyBags</span></a><span> </span><span class="hs-special">[</span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774297"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774300"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621684774300"><a href="#local-6989586621684774300"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">]</span><span>
</span><a name="line-1218"></a><span>
</span><a name="line-1219"></a><span class="hs-identifier">ruleCheckApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1220"></a><a name="ruleCheckApp"><a href="Rules.html#ruleCheckApp"><span class="hs-identifier">ruleCheckApp</span></a></a><span> </span><a name="local-6989586621684774301"><a href="#local-6989586621684774301"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684774302"><a href="#local-6989586621684774302"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621684774303"><a href="#local-6989586621684774303"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774301"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774303"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="Bag.html#unionBags"><span class="hs-identifier hs-var">unionBags</span></a><span class="hs-special">`</span><span> </span><a href="Rules.html#ruleCheckApp"><span class="hs-identifier hs-var">ruleCheckApp</span></a><span> </span><a href="#local-6989586621684774301"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774302"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774303"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-1221"></a><span class="hs-identifier">ruleCheckApp</span><span> </span><a name="local-6989586621684774305"><a href="#local-6989586621684774305"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684774306"><a href="#local-6989586621684774306"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheckFun"><span class="hs-identifier hs-var">ruleCheckFun</span></a><span> </span><a href="#local-6989586621684774305"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774306"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-1222"></a><span class="hs-identifier">ruleCheckApp</span><span> </span><a name="local-6989586621684774308"><a href="#local-6989586621684774308"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684774309"><a href="#local-6989586621684774309"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#ruleCheck"><span class="hs-identifier hs-var">ruleCheck</span></a><span> </span><a href="#local-6989586621684774308"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774309"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-1223"></a><span>
</span><a name="line-1224"></a><span class="hs-identifier">ruleCheckFun</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bag.html#Bag"><span class="hs-identifier hs-type">Bag</span></a><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1225"></a><span class="hs-comment">-- Produce a report for all rules matching the predicate</span><span>
</span><a name="line-1226"></a><span class="hs-comment">-- saying why it doesn't match the specified application</span><span>
</span><a name="line-1227"></a><span>
</span><a name="line-1228"></a><a name="ruleCheckFun"><a href="Rules.html#ruleCheckFun"><span class="hs-identifier">ruleCheckFun</span></a></a><span> </span><a name="local-6989586621684774310"><a href="#local-6989586621684774310"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684774311"><a href="#local-6989586621684774311"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621684774312"><a href="#local-6989586621684774312"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1229"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684774313"><span class="hs-identifier hs-var">name_match_rules</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a><span>
</span><a name="line-1230"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Bag.html#unitBag"><span class="hs-identifier hs-var">unitBag</span></a><span> </span><span class="hs-special">(</span><a href="Rules.html#ruleAppCheck_help"><span class="hs-identifier hs-var">ruleAppCheck_help</span></a><span> </span><a href="#local-6989586621684774310"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774311"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621684774312"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684774313"><span class="hs-identifier hs-var">name_match_rules</span></a><span class="hs-special">)</span><span>
</span><a name="line-1231"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1232"></a><span>    </span><a name="local-6989586621684774313"><a href="#local-6989586621684774313"><span class="hs-identifier">name_match_rules</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621684774314"><span class="hs-identifier hs-var">match</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rc_rules</span><span> </span><a href="#local-6989586621684774310"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774311"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1233"></a><span>    </span><a name="local-6989586621684774314"><a href="#local-6989586621684774314"><span class="hs-identifier">match</span></a></a><span> </span><a name="local-6989586621684774315"><a href="#local-6989586621684774315"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rc_pattern</span><span> </span><a href="#local-6989586621684774310"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span> </span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a><span> </span><a href="#local-6989586621684774315"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span class="hs-identifier">ruleAppCheck_help</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Rules.html#RuleCheckEnv"><span class="hs-identifier hs-type">RuleCheckEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1236"></a><a name="ruleAppCheck_help"><a href="Rules.html#ruleAppCheck_help"><span class="hs-identifier">ruleAppCheck_help</span></a></a><span> </span><a name="local-6989586621684774316"><a href="#local-6989586621684774316"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684774317"><a href="#local-6989586621684774317"><span class="hs-identifier">fn</span></a></a><span> </span><a name="local-6989586621684774318"><a href="#local-6989586621684774318"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684774319"><a href="#local-6989586621684774319"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-1237"></a><span>  </span><span class="hs-glyph">=</span><span>     </span><span class="hs-comment">-- The rules match the pattern, so we want to print something</span><span>
</span><a name="line-1238"></a><span>    </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Expression:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684774317"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684774318"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1239"></a><span>          </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684774323"><span class="hs-identifier hs-var">check_rule</span></a><span> </span><a href="#local-6989586621684774319"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1240"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1241"></a><span>    </span><a name="local-6989586621684774320"><a href="#local-6989586621684774320"><span class="hs-identifier">n_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684774318"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1242"></a><span>    </span><a name="local-6989586621684774321"><a href="#local-6989586621684774321"><span class="hs-identifier">i_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684774318"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-1243"></a><span>    </span><a name="local-6989586621684774322"><a href="#local-6989586621684774322"><span class="hs-identifier">rough_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Rules.html#roughTopName"><span class="hs-identifier hs-var">roughTopName</span></a><span> </span><a href="#local-6989586621684774318"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1244"></a><span>
</span><a name="line-1245"></a><span>    </span><a name="local-6989586621684774323"><a href="#local-6989586621684774323"><span class="hs-identifier">check_rule</span></a></a><span> </span><a name="local-6989586621684774326"><a href="#local-6989586621684774326"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sdocWithDynFlags"><span class="hs-identifier hs-var">sdocWithDynFlags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621684774327"><a href="#local-6989586621684774327"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1246"></a><span>                      </span><a href="#local-6989586621684774324"><span class="hs-identifier hs-var">rule_herald</span></a><span> </span><a href="#local-6989586621684774326"><span class="hs-identifier hs-var">rule</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621684774325"><span class="hs-identifier hs-var">rule_info</span></a><span> </span><a href="#local-6989586621684774327"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684774326"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-1247"></a><span>
</span><a name="line-1248"></a><span>    </span><a name="local-6989586621684774324"><a href="#local-6989586621684774324"><span class="hs-identifier">rule_herald</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774328"><a href="#local-6989586621684774328"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1249"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Builtin rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><a href="#local-6989586621684774328"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1250"></a><span>    </span><span class="hs-identifier">rule_herald</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774329"><a href="#local-6989586621684774329"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1251"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#doubleQuotes"><span class="hs-identifier hs-var">doubleQuotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><a href="#local-6989586621684774329"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1252"></a><span>
</span><a name="line-1253"></a><span>    </span><a name="local-6989586621684774325"><a href="#local-6989586621684774325"><span class="hs-identifier">rule_info</span></a></a><span> </span><a name="local-6989586621684774330"><a href="#local-6989586621684774330"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684774331"><a href="#local-6989586621684774331"><span class="hs-identifier">rule</span></a></a><span>
</span><a name="line-1254"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Rules.html#matchRule"><span class="hs-identifier hs-var">matchRule</span></a><span> </span><a href="#local-6989586621684774330"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#emptyInScopeSet"><span class="hs-identifier hs-var">emptyInScopeSet</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rc_id_unf</span><span> </span><a href="#local-6989586621684774316"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1255"></a><span>                              </span><a href="Rules.html#noBlackList"><span class="hs-identifier hs-var">noBlackList</span></a><span> </span><a href="#local-6989586621684774317"><span class="hs-identifier hs-var">fn</span></a><span> </span><a href="#local-6989586621684774318"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684774322"><span class="hs-identifier hs-var">rough_args</span></a><span> </span><a href="#local-6989586621684774331"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-1256"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;matches (which is very peculiar!)&quot;</span><span>
</span><a name="line-1257"></a><span>
</span><a name="line-1258"></a><span>    </span><span class="hs-identifier">rule_info</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;does not match&quot;</span><span>
</span><a name="line-1259"></a><span>
</span><a name="line-1260"></a><span>    </span><span class="hs-identifier">rule_info</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_act</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774332"><a href="#local-6989586621684774332"><span class="hs-identifier">act</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1261"></a><span>                        </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774333"><a href="#local-6989586621684774333"><span class="hs-identifier">rule_bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684774334"><a href="#local-6989586621684774334"><span class="hs-identifier">rule_args</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1262"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rc_is_active</span><span> </span><a href="#local-6989586621684774316"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684774332"><span class="hs-identifier hs-var">act</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;active only in later phase&quot;</span><span>
</span><a name="line-1263"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774320"><span class="hs-identifier hs-var">n_args</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621684774335"><span class="hs-identifier hs-var">n_rule_args</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;too few arguments&quot;</span><span>
</span><a name="line-1264"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774336"><span class="hs-identifier hs-var">n_mismatches</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684774335"><span class="hs-identifier hs-var">n_rule_args</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;no arguments match&quot;</span><span>
</span><a name="line-1265"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684774336"><span class="hs-identifier hs-var">n_mismatches</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;all arguments match (considered individually), but rule as a whole does not&quot;</span><span>
</span><a name="line-1266"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;arguments&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684774337"><span class="hs-identifier hs-var">mismatches</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;do not match (1-indexing)&quot;</span><span>
</span><a name="line-1267"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1268"></a><span>          </span><a name="local-6989586621684774335"><a href="#local-6989586621684774335"><span class="hs-identifier">n_rule_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684774334"><span class="hs-identifier hs-var">rule_args</span></a><span>
</span><a name="line-1269"></a><span>          </span><a name="local-6989586621684774336"><a href="#local-6989586621684774336"><span class="hs-identifier">n_mismatches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684774337"><span class="hs-identifier hs-var">mismatches</span></a><span>
</span><a name="line-1270"></a><span>          </span><a name="local-6989586621684774337"><a href="#local-6989586621684774337"><span class="hs-identifier">mismatches</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621684774342"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774340"><a href="#local-6989586621684774340"><span class="hs-identifier">rule_arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684774341"><a href="#local-6989586621684774341"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><a name="local-6989586621684774342"><a href="#local-6989586621684774342"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684774334"><span class="hs-identifier hs-var">rule_args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684774321"><span class="hs-identifier hs-var">i_args</span></a><span class="hs-special">,</span><span>
</span><a name="line-1271"></a><span>                              </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774339"><span class="hs-identifier hs-var">match_fn</span></a><span> </span><a href="#local-6989586621684774340"><span class="hs-identifier hs-var">rule_arg</span></a><span> </span><a href="#local-6989586621684774341"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1272"></a><span>
</span><a name="line-1273"></a><span>          </span><a name="local-6989586621684774338"><a href="#local-6989586621684774338"><span class="hs-identifier">lhs_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#exprsFreeVars"><span class="hs-identifier hs-var">exprsFreeVars</span></a><span> </span><a href="#local-6989586621684774334"><span class="hs-identifier hs-var">rule_args</span></a><span>     </span><span class="hs-comment">-- Includes template tyvars</span><span>
</span><a name="line-1274"></a><span>          </span><a name="local-6989586621684774339"><a href="#local-6989586621684774339"><span class="hs-identifier">match_fn</span></a></a><span> </span><a name="local-6989586621684774343"><a href="#local-6989586621684774343"><span class="hs-identifier">rule_arg</span></a></a><span> </span><a name="local-6989586621684774344"><a href="#local-6989586621684774344"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#match"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621684774346"><span class="hs-identifier hs-var">renv</span></a><span> </span><a href="Rules.html#emptyRuleSubst"><span class="hs-identifier hs-var">emptyRuleSubst</span></a><span> </span><a href="#local-6989586621684774343"><span class="hs-identifier hs-var">rule_arg</span></a><span> </span><a href="#local-6989586621684774344"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1275"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-1276"></a><span>                  </span><a name="local-6989586621684774345"><a href="#local-6989586621684774345"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684774338"><span class="hs-identifier hs-var">lhs_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="CoreFVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a><span> </span><a href="#local-6989586621684774344"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1277"></a><span>                  </span><a name="local-6989586621684774346"><a href="#local-6989586621684774346"><span class="hs-identifier">renv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Rules.html#RV"><span class="hs-identifier hs-var">RV</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rv_lcl</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkRnEnv2"><span class="hs-identifier hs-var">mkRnEnv2</span></a><span> </span><a href="#local-6989586621684774345"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-1278"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_tmpls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621684774333"><span class="hs-identifier hs-var">rule_bndrs</span></a><span>
</span><a name="line-1279"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_fltR</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><a href="#local-6989586621684774345"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-1280"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rv_unf</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rc_id_unf</span><span> </span><a href="#local-6989586621684774316"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1281"></a></pre></body></html>