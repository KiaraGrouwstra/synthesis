<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

************************************************************************
*                                                                      *
\section[OccurAnal]{Occurrence analysis pass}
*                                                                      *
************************************************************************

The occurrence analyser re-typechecks a core expression, returning a new
core expression with (hopefully) improved usage information.
-}</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE CPP, BangPatterns, MultiWayIf, ViewPatterns  #-}</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">OccurAnal</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-17"></a><span>        </span><a href="OccurAnal.html#occurAnalysePgm"><span class="hs-identifier hs-var">occurAnalysePgm</span></a><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#occurAnalyseExpr_NoBinderSwap"><span class="hs-identifier hs-var">occurAnalyseExpr_NoBinderSwap</span></a><span>
</span><a name="line-18"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="CoreFVs.html"><span class="hs-identifier">CoreFVs</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#isDefaultAlt"><span class="hs-identifier hs-var">isDefaultAlt</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#isExpandableApp"><span class="hs-identifier hs-var">isExpandableApp</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>                          </span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="CoreArity.html"><span class="hs-identifier">CoreArity</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="CoreArity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="IdInfo.html"><span class="hs-identifier">IdInfo</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span class="hs-special">(</span><span> </span><a href="Name.html#localiseName"><span class="hs-identifier hs-var">localiseName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span class="hs-special">(</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="Demand.html"><span class="hs-identifier">Demand</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="Demand.html#argOneShots"><span class="hs-identifier hs-var">argOneShots</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#argsOneShots"><span class="hs-identifier hs-var">argsOneShots</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Digraph.html"><span class="hs-identifier">Digraph</span></a><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">SCC</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Digraph.html#Node"><span class="hs-identifier hs-type">Node</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Digraph.html#stronglyConnCompFromEdgedVerticesUniq"><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniq</span></a><span>
</span><a name="line-43"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Digraph.html#stronglyConnCompFromEdgedVerticesUniqR"><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniqR</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="UniqSet.html"><span class="hs-identifier">UniqSet</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
    occurAnalysePgm, occurAnalyseExpr, occurAnalyseExpr_NoBinderSwap
*                                                                      *
************************************************************************

Here's the externally-callable interface:
-}</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-identifier">occurAnalysePgm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span>         </span><span class="hs-comment">-- Used only in debug output</span><span>
</span><a name="line-63"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>         </span><span class="hs-comment">-- Active unfoldings</span><span>
</span><a name="line-64"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Active rules</span><span>
</span><a name="line-65"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-66"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span>
</span><a name="line-67"></a><a name="occurAnalysePgm"><a href="OccurAnal.html#occurAnalysePgm"><span class="hs-identifier">occurAnalysePgm</span></a></a><span> </span><a name="local-6989586621684706874"><a href="#local-6989586621684706874"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684706875"><a href="#local-6989586621684706875"><span class="hs-identifier">active_unf</span></a></a><span> </span><a name="local-6989586621684706876"><a href="#local-6989586621684706876"><span class="hs-identifier">active_rule</span></a></a><span> </span><a name="local-6989586621684706877"><a href="#local-6989586621684706877"><span class="hs-identifier">imp_rules</span></a></a><span> </span><a name="local-6989586621684706878"><a href="#local-6989586621684706878"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-68"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="OccurAnal.html#isEmptyDetails"><span class="hs-identifier hs-var">isEmptyDetails</span></a><span> </span><a href="#local-6989586621684706880"><span class="hs-identifier hs-var">final_usage</span></a><span>
</span><a name="line-69"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706881"><span class="hs-identifier hs-var">occ_anald_binds</span></a><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- See Note [Glomming]</span><span>
</span><a name="line-72"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hang</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Glomming in&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">this_mod</span><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><span class="hs-identifier">colon</span><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>                   </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">final_usage</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>    </span><a href="#local-6989586621684706882"><span class="hs-identifier hs-var">occ_anald_glommed_binds</span></a><span>
</span><a name="line-75"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-76"></a><span>    </span><a name="local-6989586621684706879"><a href="#local-6989586621684706879"><span class="hs-identifier">init_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#initOccEnv"><span class="hs-identifier hs-var">initOccEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_rule_act</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706876"><span class="hs-identifier hs-var">active_rule</span></a><span>
</span><a name="line-77"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_unf_act</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706875"><span class="hs-identifier hs-var">active_unf</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684706880"><a href="#local-6989586621684706880"><span class="hs-identifier">final_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706881"><a href="#local-6989586621684706881"><span class="hs-identifier">occ_anald_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706885"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684706879"><span class="hs-identifier hs-var">init_env</span></a><span> </span><a href="#local-6989586621684706878"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-80"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684706882"><a href="#local-6989586621684706882"><span class="hs-identifier">occ_anald_glommed_binds</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalRecBind"><span class="hs-identifier hs-var">occAnalRecBind</span></a><span> </span><a href="#local-6989586621684706879"><span class="hs-identifier hs-var">init_env</span></a><span> </span><a href="BasicTypes.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a><span>
</span><a name="line-81"></a><span>                                                    </span><a href="#local-6989586621684706884"><span class="hs-identifier hs-var">imp_rule_edges</span></a><span>
</span><a name="line-82"></a><span>                                                    </span><span class="hs-special">(</span><a href="CoreSyn.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a><span> </span><a href="#local-6989586621684706881"><span class="hs-identifier hs-var">occ_anald_binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>                                                    </span><a href="#local-6989586621684706883"><span class="hs-identifier hs-var">initial_uds</span></a><span>
</span><a name="line-84"></a><span>          </span><span class="hs-comment">-- It's crucial to re-analyse the glommed-together bindings</span><span>
</span><a name="line-85"></a><span>          </span><span class="hs-comment">-- so that we establish the right loop breakers. Otherwise</span><span>
</span><a name="line-86"></a><span>          </span><span class="hs-comment">-- we can easily create an infinite loop (Trac #9583 is an example)</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>    </span><a name="local-6989586621684706883"><a href="#local-6989586621684706883"><span class="hs-identifier">initial_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#addManyOccsSet"><span class="hs-identifier hs-var">addManyOccsSet</span></a><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span>
</span><a name="line-89"></a><span>                            </span><span class="hs-special">(</span><a href="CoreFVs.html#rulesFreeVars"><span class="hs-identifier hs-var">rulesFreeVars</span></a><span> </span><a href="#local-6989586621684706877"><span class="hs-identifier hs-var">imp_rules</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>    </span><span class="hs-comment">-- The RULES declarations keep things alive!</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>    </span><span class="hs-comment">-- Note [Preventing loops due to imported functions rules]</span><span>
</span><a name="line-93"></a><span>    </span><a name="local-6989586621684706884"><a href="#local-6989586621684706884"><span class="hs-identifier">imp_rule_edges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a><span> </span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">)</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-94"></a><span>                            </span><span class="hs-special">[</span><span> </span><a href="VarEnv.html#mapVarEnv"><span class="hs-identifier hs-var">mapVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621684706887"><span class="hs-identifier hs-var">maps_to</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-95"></a><span>                                </span><a href="UniqSet.html#getUniqSet"><span class="hs-identifier hs-var">getUniqSet</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#exprFreeIds"><span class="hs-identifier hs-var">exprFreeIds</span></a><span> </span><a href="#local-6989586621684706888"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delVarSetList"><span class="hs-identifier hs-var">delVarSetList</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><a href="#local-6989586621684706886"><span class="hs-identifier hs-var">imp_rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-96"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684706886"><a href="#local-6989586621684706886"><span class="hs-identifier">imp_rule</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684706877"><span class="hs-identifier hs-var">imp_rules</span></a><span>
</span><a name="line-97"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isBuiltinRule"><span class="hs-identifier hs-var">isBuiltinRule</span></a><span> </span><a href="#local-6989586621684706886"><span class="hs-identifier hs-var">imp_rule</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [Plugin rules]</span><span>
</span><a name="line-98"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684706887"><a href="#local-6989586621684706887"><span class="hs-identifier">maps_to</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#exprFreeIds"><span class="hs-identifier hs-var">exprFreeIds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ru_rhs</span><span> </span><a href="#local-6989586621684706886"><span class="hs-identifier hs-var">imp_rule</span></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>                                             </span><span class="hs-special">`</span><a href="VarSet.html#delVarSetList"><span class="hs-identifier hs-var">delVarSetList</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><a href="#local-6989586621684706886"><span class="hs-identifier hs-var">imp_rule</span></a><span>
</span><a name="line-100"></a><span>                            </span><span class="hs-special">,</span><span> </span><a name="local-6989586621684706888"><a href="#local-6989586621684706888"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><a href="#local-6989586621684706886"><span class="hs-identifier hs-var">imp_rule</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>    </span><a name="local-6989586621684706885"><a href="#local-6989586621684706885"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-104"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706883"><span class="hs-identifier hs-var">initial_uds</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684706889"><a href="#local-6989586621684706889"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684706890"><a href="#local-6989586621684706890"><span class="hs-identifier">bind</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684706891"><a href="#local-6989586621684706891"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-106"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706894"><span class="hs-identifier hs-var">final_usage</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684706895"><span class="hs-identifier hs-var">bind'</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684706893"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-108"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621684706892"><a href="#local-6989586621684706892"><span class="hs-identifier">bs_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706893"><a href="#local-6989586621684706893"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706885"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684706889"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706891"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-109"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621684706894"><a href="#local-6989586621684706894"><span class="hs-identifier">final_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706895"><a href="#local-6989586621684706895"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalBind"><span class="hs-identifier hs-var">occAnalBind</span></a><span> </span><a href="#local-6989586621684706889"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="BasicTypes.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a><span> </span><a href="#local-6989586621684706884"><span class="hs-identifier hs-var">imp_rule_edges</span></a><span> </span><a href="#local-6989586621684706890"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-110"></a><span>                                              </span><a href="#local-6989586621684706892"><span class="hs-identifier hs-var">bs_usage</span></a><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-identifier">occurAnalyseExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-113"></a><span>        </span><span class="hs-comment">-- Do occurrence analysis, and discard occurrence info returned</span><span>
</span><a name="line-114"></a><a name="occurAnalyseExpr"><a href="OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier">occurAnalyseExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occurAnalyseExpr%27"><span class="hs-identifier hs-var">occurAnalyseExpr'</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- do binder swap</span><span>
</span><a name="line-115"></a><span>
</span><a name="line-116"></a><span class="hs-identifier">occurAnalyseExpr_NoBinderSwap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-117"></a><a name="occurAnalyseExpr_NoBinderSwap"><a href="OccurAnal.html#occurAnalyseExpr_NoBinderSwap"><span class="hs-identifier">occurAnalyseExpr_NoBinderSwap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occurAnalyseExpr%27"><span class="hs-identifier hs-var">occurAnalyseExpr'</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- do not do binder swap</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-identifier">occurAnalyseExpr'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-120"></a><a name="occurAnalyseExpr%27"><a href="OccurAnal.html#occurAnalyseExpr%27"><span class="hs-identifier">occurAnalyseExpr'</span></a></a><span> </span><a name="local-6989586621684706896"><a href="#local-6989586621684706896"><span class="hs-identifier">enable_binder_swap</span></a></a><span> </span><a name="local-6989586621684706897"><a href="#local-6989586621684706897"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-121"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684706898"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706897"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-123"></a><span>    </span><a name="local-6989586621684706898"><a href="#local-6989586621684706898"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#initOccEnv"><span class="hs-identifier hs-var">initOccEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_binder_swap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706896"><span class="hs-identifier hs-var">enable_binder_swap</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">{- Note [Plugin rules]
~~~~~~~~~~~~~~~~~~~~~~
Conal Elliott (Trac #11651) built a GHC plugin that added some
BuiltinRules (for imported Ids) to the mg_rules field of ModGuts, to
do some domain-specific transformations that could not be expressed
with an ordinary pattern-matching CoreRule.  But then we can't extract
the dependencies (in imp_rule_edges) from ru_rhs etc, because a
BuiltinRule doesn't have any of that stuff.

So we simply assume that BuiltinRules have no dependencies, and filter
them out from the imp_rule_edges comprehension.
-}</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Bindings
*                                                                      *
************************************************************************

Note [Recursive bindings: the grand plan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When we come across a binding group
  Rec { x1 = r1; ...; xn = rn }
we treat it like this (occAnalRecBind):

1. Occurrence-analyse each right hand side, and build a
   &quot;Details&quot; for each binding to capture the results.

   Wrap the details in a Node (details, node-id, dep-node-ids),
   where node-id is just the unique of the binder, and
   dep-node-ids lists all binders on which this binding depends.
   We'll call these the &quot;scope edges&quot;.
   See Note [Forming the Rec groups].

   All this is done by makeNode.

2. Do SCC-analysis on these Nodes.  Each SCC will become a new Rec or
   NonRec.  The key property is that every free variable of a binding
   is accounted for by the scope edges, so that when we are done
   everything is still in scope.

3. For each Cyclic SCC of the scope-edge SCC-analysis in (2), we
   identify suitable loop-breakers to ensure that inlining terminates.
   This is done by occAnalRec.

4. To do so we form a new set of Nodes, with the same details, but
   different edges, the &quot;loop-breaker nodes&quot;. The loop-breaker nodes
   have both more and fewer dependencies than the scope edges
   (see Note [Choosing loop breakers])

   More edges: if f calls g, and g has an active rule that mentions h
               then we add an edge from f -&gt; h

   Fewer edges: we only include dependencies on active rules, on rule
                RHSs (not LHSs) and if there is an INLINE pragma only
                on the stable unfolding (and vice versa).  The scope
                edges must be much more inclusive.

5.  The &quot;weak fvs&quot; of a node are, by definition:
       the scope fvs - the loop-breaker fvs
    See Note [Weak loop breakers], and the nd_weak field of Details

6.  Having formed the loop-breaker nodes

Note [Dead code]
~~~~~~~~~~~~~~~~
Dropping dead code for a cyclic Strongly Connected Component is done
in a very simple way:

        the entire SCC is dropped if none of its binders are mentioned
        in the body; otherwise the whole thing is kept.

The key observation is that dead code elimination happens after
dependency analysis: so 'occAnalBind' processes SCCs instead of the
original term's binding groups.

Thus 'occAnalBind' does indeed drop 'f' in an example like

        letrec f = ...g...
               g = ...(...g...)...
        in
           ...g...

when 'g' no longer uses 'f' at all (eg 'f' does not occur in a RULE in
'g'). 'occAnalBind' first consumes 'CyclicSCC g' and then it consumes
'AcyclicSCC f', where 'body_usage' won't contain 'f'.

------------------------------------------------------------
Note [Forming Rec groups]
~~~~~~~~~~~~~~~~~~~~~~~~~
We put bindings {f = ef; g = eg } in a Rec group if &quot;f uses g&quot;
and &quot;g uses f&quot;, no matter how indirectly.  We do a SCC analysis
with an edge f -&gt; g if &quot;f uses g&quot;.

More precisely, &quot;f uses g&quot; iff g should be in scope wherever f is.
That is, g is free in:
  a) the rhs 'ef'
  b) or the RHS of a rule for f (Note [Rules are extra RHSs])
  c) or the LHS or a rule for f (Note [Rule dependency info])

These conditions apply regardless of the activation of the RULE (eg it might be
inactive in this phase but become active later).  Once a Rec is broken up
it can never be put back together, so we must be conservative.

The principle is that, regardless of rule firings, every variable is
always in scope.

  * Note [Rules are extra RHSs]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~
    A RULE for 'f' is like an extra RHS for 'f'. That way the &quot;parent&quot;
    keeps the specialised &quot;children&quot; alive.  If the parent dies
    (because it isn't referenced any more), then the children will die
    too (unless they are already referenced directly).

    To that end, we build a Rec group for each cyclic strongly
    connected component,
        *treating f's rules as extra RHSs for 'f'*.
    More concretely, the SCC analysis runs on a graph with an edge
    from f -&gt; g iff g is mentioned in
        (a) f's rhs
        (b) f's RULES
    These are rec_edges.

    Under (b) we include variables free in *either* LHS *or* RHS of
    the rule.  The former might seems silly, but see Note [Rule
    dependency info].  So in Example [eftInt], eftInt and eftIntFB
    will be put in the same Rec, even though their 'main' RHSs are
    both non-recursive.

  * Note [Rule dependency info]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~
    The VarSet in a RuleInfo is used for dependency analysis in the
    occurrence analyser.  We must track free vars in *both* lhs and rhs.
    Hence use of idRuleVars, rather than idRuleRhsVars in occAnalBind.
    Why both? Consider
        x = y
        RULE f x = v+4
    Then if we substitute y for x, we'd better do so in the
    rule's LHS too, so we'd better ensure the RULE appears to mention 'x'
    as well as 'v'

  * Note [Rules are visible in their own rec group]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    We want the rules for 'f' to be visible in f's right-hand side.
    And we'd like them to be visible in other functions in f's Rec
    group.  E.g. in Note [Specialisation rules] we want f' rule
    to be visible in both f's RHS, and fs's RHS.

    This means that we must simplify the RULEs first, before looking
    at any of the definitions.  This is done by Simplify.simplRecBind,
    when it calls addLetIdInfo.

------------------------------------------------------------
Note [Choosing loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Loop breaking is surprisingly subtle.  First read the section 4 of
&quot;Secrets of the GHC inliner&quot;.  This describes our basic plan.
We avoid infinite inlinings by choosing loop breakers, and
ensuring that a loop breaker cuts each loop.

See also Note [Inlining and hs-boot files] in ToIface, which deals
with a closely related source of infinite loops.

Fundamentally, we do SCC analysis on a graph.  For each recursive
group we choose a loop breaker, delete all edges to that node,
re-analyse the SCC, and iterate.

But what is the graph?  NOT the same graph as was used for Note
[Forming Rec groups]!  In particular, a RULE is like an equation for
'f' that is *always* inlined if it is applicable.  We do *not* disable
rules for loop-breakers.  It's up to whoever makes the rules to make
sure that the rules themselves always terminate.  See Note [Rules for
recursive functions] in Simplify.hs

Hence, if
    f's RHS (or its INLINE template if it has one) mentions g, and
    g has a RULE that mentions h, and
    h has a RULE that mentions f

then we *must* choose f to be a loop breaker.  Example: see Note
[Specialisation rules].

In general, take the free variables of f's RHS, and augment it with
all the variables reachable by RULES from those starting points.  That
is the whole reason for computing rule_fv_env in occAnalBind.  (Of
course we only consider free vars that are also binders in this Rec
group.)  See also Note [Finding rule RHS free vars]

Note that when we compute this rule_fv_env, we only consider variables
free in the *RHS* of the rule, in contrast to the way we build the
Rec group in the first place (Note [Rule dependency info])

Note that if 'g' has RHS that mentions 'w', we should add w to
g's loop-breaker edges.  More concretely there is an edge from f -&gt; g
iff
        (a) g is mentioned in f's RHS `xor` f's INLINE rhs
            (see Note [Inline rules])
        (b) or h is mentioned in f's RHS, and
            g appears in the RHS of an active RULE of h
            or a transitive sequence of active rules starting with h

Why &quot;active rules&quot;?  See Note [Finding rule RHS free vars]

Note that in Example [eftInt], *neither* eftInt *nor* eftIntFB is
chosen as a loop breaker, because their RHSs don't mention each other.
And indeed both can be inlined safely.

Note again that the edges of the graph we use for computing loop breakers
are not the same as the edges we use for computing the Rec blocks.
That's why we compute

- rec_edges          for the Rec block analysis
- loop_breaker_nodes for the loop breaker analysis

  * Note [Finding rule RHS free vars]
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Consider this real example from Data Parallel Haskell
         tagZero :: Array Int -&gt; Array Tag
         {-# INLINE [1] tagZeroes #-}
         tagZero xs = pmap (\x -&gt; fromBool (x==0)) xs

         {-# RULES &quot;tagZero&quot; [~1] forall xs n.
             pmap fromBool &lt;blah blah&gt; = tagZero xs #-}
    So tagZero's RHS mentions pmap, and pmap's RULE mentions tagZero.
    However, tagZero can only be inlined in phase 1 and later, while
    the RULE is only active *before* phase 1.  So there's no problem.

    To make this work, we look for the RHS free vars only for
    *active* rules. That's the reason for the occ_rule_act field
    of the OccEnv.

  * Note [Weak loop breakers]
    ~~~~~~~~~~~~~~~~~~~~~~~~~
    There is a last nasty wrinkle.  Suppose we have

        Rec { f = f_rhs
              RULE f [] = g

              h = h_rhs
              g = h
              ...more...
        }

    Remember that we simplify the RULES before any RHS (see Note
    [Rules are visible in their own rec group] above).

    So we must *not* postInlineUnconditionally 'g', even though
    its RHS turns out to be trivial.  (I'm assuming that 'g' is
    not choosen as a loop breaker.)  Why not?  Because then we
    drop the binding for 'g', which leaves it out of scope in the
    RULE!

    Here's a somewhat different example of the same thing
        Rec { g = h
            ; h = ...f...
            ; f = f_rhs
              RULE f [] = g }
    Here the RULE is &quot;below&quot; g, but we *still* can't postInlineUnconditionally
    g, because the RULE for f is active throughout.  So the RHS of h
    might rewrite to     h = ...g...
    So g must remain in scope in the output program!

    We &quot;solve&quot; this by:

        Make g a &quot;weak&quot; loop breaker (OccInfo = IAmLoopBreaker True)
        iff g is a &quot;missing free variable&quot; of the Rec group

    A &quot;missing free variable&quot; x is one that is mentioned in an RHS or
    INLINE or RULE of a binding in the Rec group, but where the
    dependency on x may not show up in the loop_breaker_nodes (see
    note [Choosing loop breakers} above).

    A normal &quot;strong&quot; loop breaker has IAmLoopBreaker False.  So

                                    Inline  postInlineUnconditionally
   strong   IAmLoopBreaker False    no      no
   weak     IAmLoopBreaker True     yes     no
            other                   yes     yes

    The **sole** reason for this kind of loop breaker is so that
    postInlineUnconditionally does not fire.  Ugh.  (Typically it'll
    inline via the usual callSiteInline stuff, so it'll be dead in the
    next pass, so the main Ugh is the tiresome complication.)

Note [Rules for imported functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this
   f = /\a. B.g a
   RULE B.g Int = 1 + f Int
Note that
  * The RULE is for an imported function.
  * f is non-recursive
Now we
can get
   f Int --&gt; B.g Int      Inlining f
         --&gt; 1 + f Int    Firing RULE
and so the simplifier goes into an infinite loop. This
would not happen if the RULE was for a local function,
because we keep track of dependencies through rules.  But
that is pretty much impossible to do for imported Ids.  Suppose
f's definition had been
   f = /\a. C.h a
where (by some long and devious process), C.h eventually inlines to
B.g.  We could only spot such loops by exhaustively following
unfoldings of C.h etc, in case we reach B.g, and hence (via the RULE)
f.

Note that RULES for imported functions are important in practice; they
occur a lot in the libraries.

We regard this potential infinite loop as a *programmer* error.
It's up the programmer not to write silly rules like
     RULE f x = f x
and the example above is just a more complicated version.

Note [Preventing loops due to imported functions rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider:
  import GHC.Base (foldr)

  {-# RULES &quot;filterList&quot; forall p. foldr (filterFB (:) p) [] = filter p #-}
  filter p xs = build (\c n -&gt; foldr (filterFB c p) n xs)
  filterFB c p = ...

  f = filter p xs

Note that filter is not a loop-breaker, so what happens is:
  f =          filter p xs
    = {inline} build (\c n -&gt; foldr (filterFB c p) n xs)
    = {inline} foldr (filterFB (:) p) [] xs
    = {RULE}   filter p xs

We are in an infinite loop.

A more elaborate example (that I actually saw in practice when I went to
mark GHC.List.filter as INLINABLE) is as follows. Say I have this module:
  {-# LANGUAGE RankNTypes #-}
  module GHCList where

  import Prelude hiding (filter)
  import GHC.Base (build)

  {-# INLINABLE filter #-}
  filter :: (a -&gt; Bool) -&gt; [a] -&gt; [a]
  filter p [] = []
  filter p (x:xs) = if p x then x : filter p xs else filter p xs

  {-# NOINLINE [0] filterFB #-}
  filterFB :: (a -&gt; b -&gt; b) -&gt; (a -&gt; Bool) -&gt; a -&gt; b -&gt; b
  filterFB c p x r | p x       = x `c` r
                   | otherwise = r

  {-# RULES
  &quot;filter&quot;     [~1] forall p xs.  filter p xs = build (\c n -&gt; foldr
  (filterFB c p) n xs)
  &quot;filterList&quot; [1]  forall p.     foldr (filterFB (:) p) [] = filter p
   #-}

Then (because RULES are applied inside INLINABLE unfoldings, but inlinings
are not), the unfolding given to &quot;filter&quot; in the interface file will be:
  filter p []     = []
  filter p (x:xs) = if p x then x : build (\c n -&gt; foldr (filterFB c p) n xs)
                           else     build (\c n -&gt; foldr (filterFB c p) n xs

Note that because this unfolding does not mention &quot;filter&quot;, filter is not
marked as a strong loop breaker. Therefore at a use site in another module:
  filter p xs
    = {inline}
      case xs of []     -&gt; []
                 (x:xs) -&gt; if p x then x : build (\c n -&gt; foldr (filterFB c p) n xs)
                                  else     build (\c n -&gt; foldr (filterFB c p) n xs)

  build (\c n -&gt; foldr (filterFB c p) n xs)
    = {inline} foldr (filterFB (:) p) [] xs
    = {RULE}   filter p xs

And we are in an infinite loop again, except that this time the loop is producing an
infinitely large *term* (an unrolling of filter) and so the simplifier finally
dies with &quot;ticks exhausted&quot;

Because of this problem, we make a small change in the occurrence analyser
designed to mark functions like &quot;filter&quot; as strong loop breakers on the basis that:
  1. The RHS of filter mentions the local function &quot;filterFB&quot;
  2. We have a rule which mentions &quot;filterFB&quot; on the LHS and &quot;filter&quot; on the RHS

So for each RULE for an *imported* function we are going to add
dependency edges between the *local* FVS of the rule LHS and the
*local* FVS of the rule RHS. We don't do anything special for RULES on
local functions because the standard occurrence analysis stuff is
pretty good at getting loop-breakerness correct there.

It is important to note that even with this extra hack we aren't always going to get
things right. For example, it might be that the rule LHS mentions an imported Id,
and another module has a RULE that can rewrite that imported Id to one of our local
Ids.

Note [Specialising imported functions] (referred to from Specialise)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
BUT for *automatically-generated* rules, the programmer can't be
responsible for the &quot;programmer error&quot; in Note [Rules for imported
functions].  In paricular, consider specialising a recursive function
defined in another module.  If we specialise a recursive function B.g,
we get
         g_spec = .....(B.g Int).....
         RULE B.g Int = g_spec
Here, g_spec doesn't look recursive, but when the rule fires, it
becomes so.  And if B.g was mutually recursive, the loop might
not be as obvious as it is here.

To avoid this,
 * When specialising a function that is a loop breaker,
   give a NOINLINE pragma to the specialised function

Note [Glomming]
~~~~~~~~~~~~~~~
RULES for imported Ids can make something at the top refer to something at the bottom:
        f = \x -&gt; B.g (q x)
        h = \y -&gt; 3

        RULE:  B.g (q x) = h x

Applying this rule makes f refer to h, although f doesn't appear to
depend on h.  (And, as in Note [Rules for imported functions], the
dependency might be more indirect. For example, f might mention C.t
rather than B.g, where C.t eventually inlines to B.g.)

NOTICE that this cannot happen for rules whose head is a
locally-defined function, because we accurately track dependencies
through RULES.  It only happens for rules whose head is an imported
function (B.g in the example above).

Solution:
  - When simplifying, bring all top level identifiers into
    scope at the start, ignoring the Rec/NonRec structure, so
    that when 'h' pops up in f's rhs, we find it in the in-scope set
    (as the simplifier generally expects). This happens in simplTopBinds.

  - In the occurrence analyser, if there are any out-of-scope
    occurrences that pop out of the top, which will happen after
    firing the rule:      f = \x -&gt; h x
                          h = \y -&gt; 3
    then just glom all the bindings into a single Rec, so that
    the *next* iteration of the occurrence analyser will sort
    them all out.   This part happens in occurAnalysePgm.

------------------------------------------------------------
Note [Inline rules]
~~~~~~~~~~~~~~~~~~~
None of the above stuff about RULES applies to Inline Rules,
stored in a CoreUnfolding.  The unfolding, if any, is simplified
at the same time as the regular RHS of the function (ie *not* like
Note [Rules are visible in their own rec group]), so it should be
treated *exactly* like an extra RHS.

Or, rather, when computing loop-breaker edges,
  * If f has an INLINE pragma, and it is active, we treat the
    INLINE rhs as f's rhs
  * If it's inactive, we treat f as having no rhs
  * If it has no INLINE pragma, we look at f's actual rhs


There is a danger that we'll be sub-optimal if we see this
     f = ...f...
     [INLINE f = ..no f...]
where f is recursive, but the INLINE is not. This can just about
happen with a sufficiently odd set of rules; eg

        foo :: Int -&gt; Int
        {-# INLINE [1] foo #-}
        foo x = x+1

        bar :: Int -&gt; Int
        {-# INLINE [1] bar #-}
        bar x = foo x + 1

        {-# RULES &quot;foo&quot; [~1] forall x. foo x = bar x #-}

Here the RULE makes bar recursive; but it's INLINE pragma remains
non-recursive. It's tempting to then say that 'bar' should not be
a loop breaker, but an attempt to do so goes wrong in two ways:
   a) We may get
         $df = ...$cfoo...
         $cfoo = ...$df....
         [INLINE $cfoo = ...no-$df...]
      But we want $cfoo to depend on $df explicitly so that we
      put the bindings in the right order to inline $df in $cfoo
      and perhaps break the loop altogether.  (Maybe this
   b)


Example [eftInt]
~~~~~~~~~~~~~~~
Example (from GHC.Enum):

  eftInt :: Int# -&gt; Int# -&gt; [Int]
  eftInt x y = ...(non-recursive)...

  {-# INLINE [0] eftIntFB #-}
  eftIntFB :: (Int -&gt; r -&gt; r) -&gt; r -&gt; Int# -&gt; Int# -&gt; r
  eftIntFB c n x y = ...(non-recursive)...

  {-# RULES
  &quot;eftInt&quot;  [~1] forall x y. eftInt x y = build (\ c n -&gt; eftIntFB c n x y)
  &quot;eftIntList&quot;  [1] eftIntFB  (:) [] = eftInt
   #-}

Note [Specialisation rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this group, which is typical of what SpecConstr builds:

   fs a = ....f (C a)....
   f  x = ....f (C a)....
   {-# RULE f (C a) = fs a #-}

So 'f' and 'fs' are in the same Rec group (since f refers to fs via its RULE).

But watch out!  If 'fs' is not chosen as a loop breaker, we may get an infinite loop:
  - the RULE is applied in f's RHS (see Note [Self-recursive rules] in Simplify
  - fs is inlined (say it's small)
  - now there's another opportunity to apply the RULE

This showed up when compiling Control.Concurrent.Chan.getChanContents.

------------------------------------------------------------
Note [Finding join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~
It's the occurrence analyser's job to find bindings that we can turn into join
points, but it doesn't perform that transformation right away. Rather, it marks
the eligible bindings as part of their occurrence data, leaving it to the
simplifier (or to simpleOptPgm) to actually change the binder's 'IdDetails'.
The simplifier then eta-expands the RHS if needed and then updates the
occurrence sites. Dividing the work this way means that the occurrence analyser
still only takes one pass, yet one can always tell the difference between a
function call and a jump by looking at the occurrence (because the same pass
changes the 'IdDetails' and propagates the binders to their occurrence sites).

To track potential join points, we use the 'occ_tail' field of OccInfo. A value
of `AlwaysTailCalled n` indicates that every occurrence of the variable is a
tail call with `n` arguments (counting both value and type arguments). Otherwise
'occ_tail' will be 'NoTailCallInfo'. The tail call info flows bottom-up with the
rest of 'OccInfo' until it goes on the binder.

Note [Rules and join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Things get fiddly with rules. Suppose we have:

  let j :: Int -&gt; Int
      j y = 2 * y
      k :: Int -&gt; Int -&gt; Int
      {-# RULES &quot;SPEC k 0&quot; k 0 = j #-}
      k x y = x + 2 * y
  in ...

Now suppose that both j and k appear only as saturated tail calls in the body.
Thus we would like to make them both join points. The rule complicates matters,
though, as its RHS has an unapplied occurrence of j. *However*, if we were to
eta-expand the rule, all would be well:

  {-# RULES &quot;SPEC k 0&quot; forall a. k 0 a = j a #-}

So conceivably we could notice that a potential join point would have an
&quot;undersaturated&quot; rule and account for it. This would mean we could make
something that's been specialised a join point, for instance. But local bindings
are rarely specialised, and being overly cautious about rules only
costs us anything when, for some `j`:

  * Before specialisation, `j` has non-tail calls, so it can't be a join point.
  * During specialisation, `j` gets specialised and thus acquires rules.
  * Sometime afterward, the non-tail calls to `j` disappear (as dead code, say),
    and so now `j` *could* become a join point.

This appears to be very rare in practice. TODO Perhaps we should gather
statistics to be sure.

------------------------------------------------------------
Note [Adjusting right-hand sides]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There's a bit of a dance we need to do after analysing a lambda expression or
a right-hand side. In particular, we need to

  a) call 'markAllInsideLam' *unless* the binding is for a thunk, a one-shot
     lambda, or a non-recursive join point; and
  b) call 'markAllNonTailCalled' *unless* the binding is for a join point.

Some examples, with how the free occurrences in e (assumed not to be a value
lambda) get marked:

                             inside lam    non-tail-called
  ------------------------------------------------------------
  let x = e                  No            Yes
  let f = \x -&gt; e            Yes           Yes
  let f = \x{OneShot} -&gt; e   No            Yes
  \x -&gt; e                    Yes           Yes
  join j x = e               No            No
  joinrec j x = e            Yes           No

There are a few other caveats; most importantly, if we're marking a binding as
'AlwaysTailCalled', it's *going* to be a join point, so we treat it as one so
that the effect cascades properly. Consequently, at the time the RHS is
analysed, we won't know what adjustments to make; thus 'occAnalLamOrRhs' must
return the unadjusted 'UsageDetails', to be adjusted by 'adjustRhsUsage' once
join-point-hood has been decided.

Thus the overall sequence taking place in 'occAnalNonRecBind' and
'occAnalRecBind' is as follows:

  1. Call 'occAnalLamOrRhs' to find usage information for the RHS.
  2. Call 'tagNonRecBinder' or 'tagRecBinders', which decides whether to make
     the binding a join point.
  3. Call 'adjustRhsUsage' accordingly. (Done as part of 'tagRecBinders' when
     recursive.)

(In the recursive case, this logic is spread between 'makeNode' and
'occAnalRec'.)
-}</span><span>
</span><a name="line-742"></a><span>
</span><a name="line-743"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-744"></a><span class="hs-comment">--                 occAnalBind</span><span>
</span><a name="line-745"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-746"></a><span>
</span><a name="line-747"></a><span class="hs-identifier">occAnalBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>           </span><span class="hs-comment">-- The incoming OccEnv</span><span>
</span><a name="line-748"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span>
</span><a name="line-749"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a><span>
</span><a name="line-750"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-751"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>             </span><span class="hs-comment">-- Usage details of scope</span><span>
</span><a name="line-752"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span>           </span><span class="hs-comment">-- Of the whole let(rec)</span><span>
</span><a name="line-753"></a><span>                </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-754"></a><span>
</span><a name="line-755"></a><a name="occAnalBind"><a href="OccurAnal.html#occAnalBind"><span class="hs-identifier">occAnalBind</span></a></a><span> </span><a name="local-6989586621684706899"><a href="#local-6989586621684706899"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684706900"><a href="#local-6989586621684706900"><span class="hs-identifier">lvl</span></a></a><span> </span><a name="local-6989586621684706901"><a href="#local-6989586621684706901"><span class="hs-identifier">top_env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621684706902"><a href="#local-6989586621684706902"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-6989586621684706903"><a href="#local-6989586621684706903"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684706904"><a href="#local-6989586621684706904"><span class="hs-identifier">body_usage</span></a></a><span>
</span><a name="line-756"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalNonRecBind"><span class="hs-identifier hs-var">occAnalNonRecBind</span></a><span> </span><a href="#local-6989586621684706899"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706900"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621684706901"><span class="hs-identifier hs-var">top_env</span></a><span> </span><a href="#local-6989586621684706902"><span class="hs-identifier hs-var">binder</span></a><span> </span><a href="#local-6989586621684706903"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684706904"><span class="hs-identifier hs-var">body_usage</span></a><span>
</span><a name="line-757"></a><span class="hs-identifier">occAnalBind</span><span> </span><a name="local-6989586621684706905"><a href="#local-6989586621684706905"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684706906"><a href="#local-6989586621684706906"><span class="hs-identifier">lvl</span></a></a><span> </span><a name="local-6989586621684706907"><a href="#local-6989586621684706907"><span class="hs-identifier">top_env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621684706908"><a href="#local-6989586621684706908"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684706909"><a href="#local-6989586621684706909"><span class="hs-identifier">body_usage</span></a></a><span>
</span><a name="line-758"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalRecBind"><span class="hs-identifier hs-var">occAnalRecBind</span></a><span> </span><a href="#local-6989586621684706905"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706906"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621684706907"><span class="hs-identifier hs-var">top_env</span></a><span> </span><a href="#local-6989586621684706908"><span class="hs-identifier hs-var">pairs</span></a><span> </span><a href="#local-6989586621684706909"><span class="hs-identifier hs-var">body_usage</span></a><span>
</span><a name="line-759"></a><span>
</span><a name="line-760"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-761"></a><span class="hs-identifier">occAnalNonRecBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-762"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-763"></a><a name="occAnalNonRecBind"><a href="OccurAnal.html#occAnalNonRecBind"><span class="hs-identifier">occAnalNonRecBind</span></a></a><span> </span><a name="local-6989586621684706910"><a href="#local-6989586621684706910"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684706911"><a href="#local-6989586621684706911"><span class="hs-identifier">lvl</span></a></a><span> </span><a name="local-6989586621684706912"><a href="#local-6989586621684706912"><span class="hs-identifier">imp_rule_edges</span></a></a><span> </span><a name="local-6989586621684706913"><a href="#local-6989586621684706913"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-6989586621684706914"><a href="#local-6989586621684706914"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621684706915"><a href="#local-6989586621684706915"><span class="hs-identifier">body_usage</span></a></a><span>
</span><a name="line-764"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684706913"><span class="hs-identifier hs-var">binder</span></a><span>      </span><span class="hs-comment">-- A type let; we don't gather usage info</span><span>
</span><a name="line-765"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706915"><span class="hs-identifier hs-var">body_usage</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684706913"><span class="hs-identifier hs-var">binder</span></a><span> </span><a href="#local-6989586621684706914"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-766"></a><span>
</span><a name="line-767"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706913"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#usedIn"><span class="hs-identifier hs-var">usedIn</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684706915"><span class="hs-identifier hs-var">body_usage</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- It's not mentioned</span><span>
</span><a name="line-768"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706915"><span class="hs-identifier hs-var">body_usage</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-comment">-- It's mentioned in the body</span><span>
</span><a name="line-771"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706916"><span class="hs-identifier hs-var">body_usage'</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684706930"><span class="hs-identifier hs-var">rhs_usage'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684706917"><span class="hs-identifier hs-var">tagged_binder</span></a><span> </span><a href="#local-6989586621684706924"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-772"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-773"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684706916"><a href="#local-6989586621684706916"><span class="hs-identifier">body_usage'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706917"><a href="#local-6989586621684706917"><span class="hs-identifier">tagged_binder</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#tagNonRecBinder"><span class="hs-identifier hs-var">tagNonRecBinder</span></a><span> </span><a href="#local-6989586621684706911"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621684706915"><span class="hs-identifier hs-var">body_usage</span></a><span> </span><a href="#local-6989586621684706913"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-774"></a><span>    </span><a name="local-6989586621684706918"><a href="#local-6989586621684706918"><span class="hs-identifier">mb_join_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#willBeJoinId_maybe"><span class="hs-identifier hs-var">willBeJoinId_maybe</span></a><span> </span><a href="#local-6989586621684706917"><span class="hs-identifier hs-var">tagged_binder</span></a><span>
</span><a name="line-775"></a><span>
</span><a name="line-776"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684706919"><a href="#local-6989586621684706919"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706920"><a href="#local-6989586621684706920"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a><span> </span><a href="#local-6989586621684706914"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-777"></a><span>
</span><a name="line-778"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684706921"><a href="#local-6989586621684706921"><span class="hs-identifier">rhs_usage1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706922"><a href="#local-6989586621684706922"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706923"><a href="#local-6989586621684706923"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalNonRecRhs"><span class="hs-identifier hs-var">occAnalNonRecRhs</span></a><span> </span><a href="#local-6989586621684706910"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706917"><span class="hs-identifier hs-var">tagged_binder</span></a><span> </span><a href="#local-6989586621684706919"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684706920"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-779"></a><span>    </span><a name="local-6989586621684706924"><a href="#local-6989586621684706924"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#markJoinOneShots"><span class="hs-identifier hs-var">markJoinOneShots</span></a><span> </span><a href="#local-6989586621684706918"><span class="hs-identifier hs-var">mb_join_arity</span></a><span> </span><a href="#local-6989586621684706922"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684706923"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-780"></a><span>           </span><span class="hs-comment">-- For a /non-recursive/ join point we can mark all</span><span>
</span><a name="line-781"></a><span>           </span><span class="hs-comment">-- its join-lambda as one-shot; and it's a good idea to do so</span><span>
</span><a name="line-782"></a><span>
</span><a name="line-783"></a><span>    </span><span class="hs-comment">-- Unfoldings</span><span>
</span><a name="line-784"></a><span>    </span><span class="hs-comment">-- See Note [Unfoldings and join points]</span><span>
</span><a name="line-785"></a><span>    </span><a name="local-6989586621684706925"><a href="#local-6989586621684706925"><span class="hs-identifier">rhs_usage2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnalUnfolding"><span class="hs-identifier hs-var">occAnalUnfolding</span></a><span> </span><a href="#local-6989586621684706910"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a href="#local-6989586621684706913"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-786"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684706931"><a href="#local-6989586621684706931"><span class="hs-identifier">unf_usage</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684706921"><span class="hs-identifier hs-var">rhs_usage1</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684706931"><span class="hs-identifier hs-var">unf_usage</span></a><span>
</span><a name="line-787"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684706921"><span class="hs-identifier hs-var">rhs_usage1</span></a><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span>    </span><span class="hs-comment">-- Rules</span><span>
</span><a name="line-790"></a><span>    </span><span class="hs-comment">-- See Note [Rules are extra RHSs] and Note [Rule dependency info]</span><span>
</span><a name="line-791"></a><span>    </span><a name="local-6989586621684706926"><a href="#local-6989586621684706926"><span class="hs-identifier">rules_w_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalRules"><span class="hs-identifier hs-var">occAnalRules</span></a><span> </span><a href="#local-6989586621684706910"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706918"><span class="hs-identifier hs-var">mb_join_arity</span></a><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a href="#local-6989586621684706917"><span class="hs-identifier hs-var">tagged_binder</span></a><span>
</span><a name="line-792"></a><span>    </span><a name="local-6989586621684706927"><a href="#local-6989586621684706927"><span class="hs-identifier">rule_uds</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684706932"><a href="#local-6989586621684706932"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706933"><a href="#local-6989586621684706933"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684706932"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684706933"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684706926"><span class="hs-identifier hs-var">rules_w_uds</span></a><span>
</span><a name="line-793"></a><span>    </span><a name="local-6989586621684706928"><a href="#local-6989586621684706928"><span class="hs-identifier">rhs_usage3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span> </span><a href="#local-6989586621684706925"><span class="hs-identifier hs-var">rhs_usage2</span></a><span> </span><a href="#local-6989586621684706927"><span class="hs-identifier hs-var">rule_uds</span></a><span>
</span><a name="line-794"></a><span>    </span><a name="local-6989586621684706929"><a href="#local-6989586621684706929"><span class="hs-identifier">rhs_usage4</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684706912"><span class="hs-identifier hs-var">imp_rule_edges</span></a><span> </span><a href="#local-6989586621684706913"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-795"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684706928"><span class="hs-identifier hs-var">rhs_usage3</span></a><span>
</span><a name="line-796"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684706934"><a href="#local-6989586621684706934"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#addManyOccsSet"><span class="hs-identifier hs-var">addManyOccsSet</span></a><span> </span><a href="#local-6989586621684706928"><span class="hs-identifier hs-var">rhs_usage3</span></a><span> </span><a href="#local-6989586621684706934"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-797"></a><span>       </span><span class="hs-comment">-- See Note [Preventing loops due to imported functions rules]</span><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span>    </span><span class="hs-comment">-- Final adjustment</span><span>
</span><a name="line-800"></a><span>    </span><a name="local-6989586621684706930"><a href="#local-6989586621684706930"><span class="hs-identifier">rhs_usage'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#adjustRhsUsage"><span class="hs-identifier hs-var">adjustRhsUsage</span></a><span> </span><a href="#local-6989586621684706918"><span class="hs-identifier hs-var">mb_join_arity</span></a><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a href="#local-6989586621684706922"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621684706929"><span class="hs-identifier hs-var">rhs_usage4</span></a><span>
</span><a name="line-801"></a><span>
</span><a name="line-802"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-803"></a><span class="hs-identifier">occAnalRecBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-804"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-805"></a><a name="occAnalRecBind"><a href="OccurAnal.html#occAnalRecBind"><span class="hs-identifier">occAnalRecBind</span></a></a><span> </span><a name="local-6989586621684706935"><a href="#local-6989586621684706935"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684706936"><a href="#local-6989586621684706936"><span class="hs-identifier">lvl</span></a></a><span> </span><a name="local-6989586621684706937"><a href="#local-6989586621684706937"><span class="hs-identifier">imp_rule_edges</span></a></a><span> </span><a name="local-6989586621684706938"><a href="#local-6989586621684706938"><span class="hs-identifier">pairs</span></a></a><span> </span><a name="local-6989586621684706939"><a href="#local-6989586621684706939"><span class="hs-identifier">body_usage</span></a></a><span>
</span><a name="line-806"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#occAnalRec"><span class="hs-identifier hs-var">occAnalRec</span></a><span> </span><a href="#local-6989586621684706935"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706936"><span class="hs-identifier hs-var">lvl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706939"><span class="hs-identifier hs-var">body_usage</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684706940"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-807"></a><span>        </span><span class="hs-comment">-- For a recursive group, we</span><span>
</span><a name="line-808"></a><span>        </span><span class="hs-comment">--      * occ-analyse all the RHSs</span><span>
</span><a name="line-809"></a><span>        </span><span class="hs-comment">--      * compute strongly-connected components</span><span>
</span><a name="line-810"></a><span>        </span><span class="hs-comment">--      * feed those components to occAnalRec</span><span>
</span><a name="line-811"></a><span>        </span><span class="hs-comment">-- See Note [Recursive bindings: the grand plan]</span><span>
</span><a name="line-812"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-813"></a><span>    </span><span class="hs-identifier">sccs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><a href="OccurAnal.html#Details"><span class="hs-identifier hs-type">Details</span></a><span class="hs-special">]</span><span>
</span><a name="line-814"></a><span>    </span><a name="local-6989586621684706940"><a href="#local-6989586621684706940"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;occAnalBind.scc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-815"></a><span>           </span><a href="Digraph.html#stronglyConnCompFromEdgedVerticesUniq"><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniq</span></a><span> </span><a href="#local-6989586621684706941"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-816"></a><span>
</span><a name="line-817"></a><span>    </span><span class="hs-identifier">nodes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span>
</span><a name="line-818"></a><span>    </span><a name="local-6989586621684706941"><a href="#local-6989586621684706941"><span class="hs-identifier">nodes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;occAnalBind.assoc&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-819"></a><span>            </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#makeNode"><span class="hs-identifier hs-var">makeNode</span></a><span> </span><a href="#local-6989586621684706935"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706937"><span class="hs-identifier hs-var">imp_rule_edges</span></a><span> </span><a href="#local-6989586621684706942"><span class="hs-identifier hs-var">bndr_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684706938"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span>    </span><a name="local-6989586621684706942"><a href="#local-6989586621684706942"><span class="hs-identifier">bndr_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684706938"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-822"></a><span>
</span><a name="line-823"></a><span class="hs-comment">{-
Note [Unfoldings and join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We assume that anything in an unfolding occurs multiple times, since unfoldings
are often copied (that's the whole point!). But we still need to track tail
calls for the purpose of finding join points.
-}</span><span>
</span><a name="line-831"></a><span>
</span><a name="line-832"></a><span class="hs-comment">-----------------------------</span><span>
</span><a name="line-833"></a><span class="hs-identifier">occAnalRec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span>
</span><a name="line-834"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SCC</span><span> </span><a href="OccurAnal.html#Details"><span class="hs-identifier hs-type">Details</span></a><span>
</span><a name="line-835"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-836"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>
</span><a name="line-838"></a><span>        </span><span class="hs-comment">-- The NonRec case is just like a Let (NonRec ...) above</span><span>
</span><a name="line-839"></a><a name="occAnalRec"><a href="OccurAnal.html#occAnalRec"><span class="hs-identifier">occAnalRec</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684706943"><a href="#local-6989586621684706943"><span class="hs-identifier">lvl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#ND"><span class="hs-identifier hs-var">ND</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nd_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684706944"><a href="#local-6989586621684706944"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684706945"><a href="#local-6989586621684706945"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-840"></a><span>                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_uds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684706946"><a href="#local-6989586621684706946"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_rhs_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684706947"><a href="#local-6989586621684706947"><span class="hs-identifier">rhs_bndrs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-841"></a><span>           </span><span class="hs-special">(</span><a name="local-6989586621684706948"><a href="#local-6989586621684706948"><span class="hs-identifier">body_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706949"><a href="#local-6989586621684706949"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-842"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706944"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#usedIn"><span class="hs-identifier hs-var">usedIn</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684706948"><span class="hs-identifier hs-var">body_uds</span></a><span class="hs-special">)</span><span>
</span><a name="line-843"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706948"><span class="hs-identifier hs-var">body_uds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684706949"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- See Note [Dead code]</span><span>
</span><a name="line-844"></a><span>
</span><a name="line-845"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-comment">-- It's mentioned in the body</span><span>
</span><a name="line-846"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706950"><span class="hs-identifier hs-var">body_uds'</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684706952"><span class="hs-identifier hs-var">rhs_uds'</span></a><span class="hs-special">,</span><span>
</span><a name="line-847"></a><span>     </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684706951"><span class="hs-identifier hs-var">tagged_bndr</span></a><span> </span><a href="#local-6989586621684706945"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684706949"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-849"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684706950"><a href="#local-6989586621684706950"><span class="hs-identifier">body_uds'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706951"><a href="#local-6989586621684706951"><span class="hs-identifier">tagged_bndr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#tagNonRecBinder"><span class="hs-identifier hs-var">tagNonRecBinder</span></a><span> </span><a href="#local-6989586621684706943"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621684706948"><span class="hs-identifier hs-var">body_uds</span></a><span> </span><a href="#local-6989586621684706944"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-850"></a><span>    </span><a name="local-6989586621684706952"><a href="#local-6989586621684706952"><span class="hs-identifier">rhs_uds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#adjustRhsUsage"><span class="hs-identifier hs-var">adjustRhsUsage</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#willBeJoinId_maybe"><span class="hs-identifier hs-var">willBeJoinId_maybe</span></a><span> </span><a href="#local-6989586621684706951"><span class="hs-identifier hs-var">tagged_bndr</span></a><span class="hs-special">)</span><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span>
</span><a name="line-851"></a><span>                              </span><a href="#local-6989586621684706947"><span class="hs-identifier hs-var">rhs_bndrs</span></a><span> </span><a href="#local-6989586621684706946"><span class="hs-identifier hs-var">rhs_uds</span></a><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span>        </span><span class="hs-comment">-- The Rec case is the interesting one</span><span>
</span><a name="line-854"></a><span>        </span><span class="hs-comment">-- See Note [Recursive bindings: the grand plan]</span><span>
</span><a name="line-855"></a><span>        </span><span class="hs-comment">-- See Note [Loop breaking]</span><span>
</span><a name="line-856"></a><span class="hs-identifier">occAnalRec</span><span> </span><a name="local-6989586621684706953"><a href="#local-6989586621684706953"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684706954"><a href="#local-6989586621684706954"><span class="hs-identifier">lvl</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621684706955"><a href="#local-6989586621684706955"><span class="hs-identifier">details_s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684706956"><a href="#local-6989586621684706956"><span class="hs-identifier">body_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706957"><a href="#local-6989586621684706957"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-857"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="OccurAnal.html#usedIn"><span class="hs-identifier hs-var">usedIn</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684706956"><span class="hs-identifier hs-var">body_uds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684706958"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NB: look at body_uds, not total_uds</span><span>
</span><a name="line-858"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706956"><span class="hs-identifier hs-var">body_uds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684706957"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- See Note [Dead code]</span><span>
</span><a name="line-859"></a><span>
</span><a name="line-860"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- At this point we always build a single Rec</span><span>
</span><a name="line-861"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;occAnalRec&quot; (vcat</span><span>
</span><a name="line-862"></a><span>    </span><span class="hs-comment">--  [ text &quot;weak_fvs&quot; &lt;+&gt; ppr weak_fvs</span><span>
</span><a name="line-863"></a><span>    </span><span class="hs-comment">--  , text &quot;lb nodes&quot; &lt;+&gt; ppr loop_breaker_nodes])</span><span>
</span><a name="line-864"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684706960"><span class="hs-identifier hs-var">final_uds</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-6989586621684706963"><span class="hs-identifier hs-var">pairs</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684706957"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-865"></a><span>
</span><a name="line-866"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-867"></a><span>    </span><a name="local-6989586621684706958"><a href="#local-6989586621684706958"><span class="hs-identifier">bndrs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">nd_bndr</span><span> </span><a href="#local-6989586621684706955"><span class="hs-identifier hs-var">details_s</span></a><span>
</span><a name="line-868"></a><span>    </span><a name="local-6989586621684706959"><a href="#local-6989586621684706959"><span class="hs-identifier">bndr_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621684706958"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-869"></a><span>
</span><a name="line-870"></a><span>    </span><span class="hs-comment">------------------------------</span><span>
</span><a name="line-871"></a><span>        </span><span class="hs-comment">-- See Note [Choosing loop breakers] for loop_breaker_nodes</span><span>
</span><a name="line-872"></a><span>    </span><span class="hs-identifier">final_uds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-873"></a><span>    </span><span class="hs-identifier">loop_breaker_nodes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span>
</span><a name="line-874"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684706960"><a href="#local-6989586621684706960"><span class="hs-identifier">final_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706961"><a href="#local-6989586621684706961"><span class="hs-identifier">loop_breaker_nodes</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-875"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#mkLoopBreakerNodes"><span class="hs-identifier hs-var">mkLoopBreakerNodes</span></a><span> </span><a href="#local-6989586621684706953"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684706954"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621684706959"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684706956"><span class="hs-identifier hs-var">body_uds</span></a><span> </span><a href="#local-6989586621684706955"><span class="hs-identifier hs-var">details_s</span></a><span>
</span><a name="line-876"></a><span>
</span><a name="line-877"></a><span>    </span><span class="hs-comment">------------------------------</span><span>
</span><a name="line-878"></a><span>    </span><span class="hs-identifier">weak_fvs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-879"></a><span>    </span><a name="local-6989586621684706962"><a href="#local-6989586621684706962"><span class="hs-identifier">weak_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mapUnionVarSet"><span class="hs-identifier hs-var">mapUnionVarSet</span></a><span> </span><span class="hs-identifier">nd_weak</span><span> </span><a href="#local-6989586621684706955"><span class="hs-identifier hs-var">details_s</span></a><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span>    </span><span class="hs-comment">---------------------------</span><span>
</span><a name="line-882"></a><span>    </span><span class="hs-comment">-- Now reconstruct the cycle</span><span>
</span><a name="line-883"></a><span>    </span><span class="hs-identifier">pairs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-884"></a><span>    </span><a name="local-6989586621684706963"><a href="#local-6989586621684706963"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><a href="#local-6989586621684706962"><span class="hs-identifier hs-var">weak_fvs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#reOrderNodes"><span class="hs-identifier hs-var">reOrderNodes</span></a><span>   </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684706959"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684706962"><span class="hs-identifier hs-var">weak_fvs</span></a><span> </span><a href="#local-6989586621684706961"><span class="hs-identifier hs-var">loop_breaker_nodes</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-885"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#loopBreakNodes"><span class="hs-identifier hs-var">loopBreakNodes</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684706959"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684706962"><span class="hs-identifier hs-var">weak_fvs</span></a><span> </span><a href="#local-6989586621684706961"><span class="hs-identifier hs-var">loop_breaker_nodes</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-886"></a><span>          </span><span class="hs-comment">-- If weak_fvs is empty, the loop_breaker_nodes will include</span><span>
</span><a name="line-887"></a><span>          </span><span class="hs-comment">-- all the edges in the original scope edges [remember,</span><span>
</span><a name="line-888"></a><span>          </span><span class="hs-comment">-- weak_fvs is the difference between scope edges and</span><span>
</span><a name="line-889"></a><span>          </span><span class="hs-comment">-- lb-edges], so a fresh SCC computation would yield a</span><span>
</span><a name="line-890"></a><span>          </span><span class="hs-comment">-- single CyclicSCC result; and reOrderNodes deals with</span><span>
</span><a name="line-891"></a><span>          </span><span class="hs-comment">-- exactly that case</span><span>
</span><a name="line-892"></a><span>
</span><a name="line-893"></a><span>
</span><a name="line-894"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-895"></a><span class="hs-comment">--                 Loop breaking</span><span>
</span><a name="line-896"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-897"></a><span>
</span><a name="line-898"></a><span class="hs-keyword">type</span><span> </span><a name="Binding"><a href="OccurAnal.html#Binding"><span class="hs-identifier">Binding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-899"></a><span>
</span><a name="line-900"></a><span class="hs-identifier">loopBreakNodes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-901"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>        </span><span class="hs-comment">-- All binders</span><span>
</span><a name="line-902"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>        </span><span class="hs-comment">-- Binders whose dependencies may be &quot;missing&quot;</span><span>
</span><a name="line-903"></a><span>                                </span><span class="hs-comment">-- See Note [Weak loop breakers]</span><span>
</span><a name="line-904"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span>
</span><a name="line-905"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- Append these to the end</span><span>
</span><a name="line-906"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span class="hs-special">]</span><span>
</span><a name="line-907"></a><span class="hs-comment">{-
loopBreakNodes is applied to the list of nodes for a cyclic strongly
connected component (there's guaranteed to be a cycle).  It returns
the same nodes, but
        a) in a better order,
        b) with some of the Ids having a IAmALoopBreaker pragma

The &quot;loop-breaker&quot; Ids are sufficient to break all cycles in the SCC.  This means
that the simplifier can guarantee not to loop provided it never records an inlining
for these no-inline guys.

Furthermore, the order of the binds is such that if we neglect dependencies
on the no-inline Ids then the binds are topologically sorted.  This means
that the simplifier will generally do a good job if it works from top bottom,
recording inlinings for any Ids which aren't marked as &quot;no-inline&quot; as it goes.
-}</span><span>
</span><a name="line-923"></a><span>
</span><a name="line-924"></a><span class="hs-comment">-- Return the bindings sorted into a plausible order, and marked with loop breakers.</span><span>
</span><a name="line-925"></a><a name="loopBreakNodes"><a href="OccurAnal.html#loopBreakNodes"><span class="hs-identifier">loopBreakNodes</span></a></a><span> </span><a name="local-6989586621684706964"><a href="#local-6989586621684706964"><span class="hs-identifier">depth</span></a></a><span> </span><a name="local-6989586621684706965"><a href="#local-6989586621684706965"><span class="hs-identifier">bndr_set</span></a></a><span> </span><a name="local-6989586621684706966"><a href="#local-6989586621684706966"><span class="hs-identifier">weak_fvs</span></a></a><span> </span><a name="local-6989586621684706967"><a href="#local-6989586621684706967"><span class="hs-identifier">nodes</span></a></a><span> </span><a name="local-6989586621684706968"><a href="#local-6989586621684706968"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-926"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;loopBreakNodes&quot; (ppr nodes) $</span><span>
</span><a name="line-927"></a><span>    </span><a href="#local-6989586621684706969"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Digraph.html#stronglyConnCompFromEdgedVerticesUniqR"><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesUniqR</span></a><span> </span><a href="#local-6989586621684706967"><span class="hs-identifier hs-var">nodes</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684706968"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-928"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-929"></a><span>    </span><a name="local-6989586621684706969"><a href="#local-6989586621684706969"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><a name="local-6989586621684706971"><a href="#local-6989586621684706971"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706971"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-930"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684706972"><a href="#local-6989586621684706972"><span class="hs-identifier">scc</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684706973"><a href="#local-6989586621684706973"><span class="hs-identifier">sccs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684706974"><a href="#local-6989586621684706974"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706970"><span class="hs-identifier hs-var">loop_break_scc</span></a><span> </span><a href="#local-6989586621684706972"><span class="hs-identifier hs-var">scc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706969"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684706973"><span class="hs-identifier hs-var">sccs</span></a><span> </span><a href="#local-6989586621684706974"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-931"></a><span>
</span><a name="line-932"></a><span>    </span><a name="local-6989586621684706970"><a href="#local-6989586621684706970"><span class="hs-identifier">loop_break_scc</span></a></a><span> </span><a name="local-6989586621684706975"><a href="#local-6989586621684706975"><span class="hs-identifier">scc</span></a></a><span> </span><a name="local-6989586621684706976"><a href="#local-6989586621684706976"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-933"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684706975"><span class="hs-identifier hs-var">scc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-934"></a><span>          </span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><a name="local-6989586621684706977"><a href="#local-6989586621684706977"><span class="hs-identifier">node</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#mk_non_loop_breaker"><span class="hs-identifier hs-var">mk_non_loop_breaker</span></a><span> </span><a href="#local-6989586621684706966"><span class="hs-identifier hs-var">weak_fvs</span></a><span> </span><a href="#local-6989586621684706977"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684706976"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-935"></a><span>          </span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621684706978"><a href="#local-6989586621684706978"><span class="hs-identifier">nodes</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#reOrderNodes"><span class="hs-identifier hs-var">reOrderNodes</span></a><span> </span><a href="#local-6989586621684706964"><span class="hs-identifier hs-var">depth</span></a><span> </span><a href="#local-6989586621684706965"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684706966"><span class="hs-identifier hs-var">weak_fvs</span></a><span> </span><a href="#local-6989586621684706978"><span class="hs-identifier hs-var">nodes</span></a><span> </span><a href="#local-6989586621684706976"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span class="hs-comment">----------------------------------</span><span>
</span><a name="line-938"></a><span class="hs-identifier">reOrderNodes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span class="hs-special">]</span><span>
</span><a name="line-939"></a><span>    </span><span class="hs-comment">-- Choose a loop breaker, mark it no-inline,</span><span>
</span><a name="line-940"></a><span>    </span><span class="hs-comment">-- and call loopBreakNodes on the rest</span><span>
</span><a name="line-941"></a><a name="reOrderNodes"><a href="OccurAnal.html#reOrderNodes"><span class="hs-identifier">reOrderNodes</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;reOrderNodes&quot;</span><span>
</span><a name="line-942"></a><span class="hs-identifier">reOrderNodes</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><a name="local-6989586621684706979"><a href="#local-6989586621684706979"><span class="hs-identifier">node</span></a></a><span class="hs-special">]</span><span> </span><a name="local-6989586621684706980"><a href="#local-6989586621684706980"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#mk_loop_breaker"><span class="hs-identifier hs-var">mk_loop_breaker</span></a><span> </span><a href="#local-6989586621684706979"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684706980"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-943"></a><span class="hs-identifier">reOrderNodes</span><span> </span><a name="local-6989586621684706981"><a href="#local-6989586621684706981"><span class="hs-identifier">depth</span></a></a><span> </span><a name="local-6989586621684706982"><a href="#local-6989586621684706982"><span class="hs-identifier">bndr_set</span></a></a><span> </span><a name="local-6989586621684706983"><a href="#local-6989586621684706983"><span class="hs-identifier">weak_fvs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684706984"><a href="#local-6989586621684706984"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684706985"><a href="#local-6989586621684706985"><span class="hs-identifier">nodes</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684706986"><a href="#local-6989586621684706986"><span class="hs-identifier">binds</span></a></a><span>
</span><a name="line-944"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;reOrderNodes&quot; (vcat [ text &quot;unchosen&quot; &lt;+&gt; ppr unchosen</span><span>
</span><a name="line-945"></a><span>    </span><span class="hs-comment">--                              , text &quot;chosen&quot; &lt;+&gt; ppr chosen_nodes ]) $</span><span>
</span><a name="line-946"></a><span>    </span><a href="OccurAnal.html#loopBreakNodes"><span class="hs-identifier hs-var">loopBreakNodes</span></a><span> </span><a href="#local-6989586621684706990"><span class="hs-identifier hs-var">new_depth</span></a><span> </span><a href="#local-6989586621684706982"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684706983"><span class="hs-identifier hs-var">weak_fvs</span></a><span> </span><a href="#local-6989586621684706988"><span class="hs-identifier hs-var">unchosen</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-947"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="OccurAnal.html#mk_loop_breaker"><span class="hs-identifier hs-var">mk_loop_breaker</span></a><span> </span><a href="#local-6989586621684706987"><span class="hs-identifier hs-var">chosen_nodes</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684706986"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-948"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-949"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684706987"><a href="#local-6989586621684706987"><span class="hs-identifier">chosen_nodes</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684706988"><a href="#local-6989586621684706988"><span class="hs-identifier">unchosen</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a><span> </span><a href="#local-6989586621684706989"><span class="hs-identifier hs-var">approximate_lb</span></a><span>
</span><a name="line-950"></a><span>                                                 </span><span class="hs-special">(</span><span class="hs-identifier">nd_score</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">node_payload</span><span> </span><a href="#local-6989586621684706984"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-951"></a><span>                                                 </span><span class="hs-special">[</span><a href="#local-6989586621684706984"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684706985"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-952"></a><span>
</span><a name="line-953"></a><span>    </span><a name="local-6989586621684706989"><a href="#local-6989586621684706989"><span class="hs-identifier">approximate_lb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706981"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-954"></a><span>    </span><a name="local-6989586621684706990"><a href="#local-6989586621684706990"><span class="hs-identifier">new_depth</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684706989"><span class="hs-identifier hs-var">approximate_lb</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-955"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706981"><span class="hs-identifier hs-var">depth</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span>
</span><a name="line-956"></a><span>        </span><span class="hs-comment">-- After two iterations (d=0, d=1) give up</span><span>
</span><a name="line-957"></a><span>        </span><span class="hs-comment">-- and approximate, returning to d=0</span><span>
</span><a name="line-958"></a><span>
</span><a name="line-959"></a><span class="hs-identifier">mk_loop_breaker</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span>
</span><a name="line-960"></a><a name="mk_loop_breaker"><a href="OccurAnal.html#mk_loop_breaker"><span class="hs-identifier">mk_loop_breaker</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">node_payload</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#ND"><span class="hs-identifier hs-var">ND</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nd_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684706991"><a href="#local-6989586621684706991"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684706992"><a href="#local-6989586621684706992"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-961"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706991"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdOccInfo"><span class="hs-identifier hs-var">setIdOccInfo</span></a><span class="hs-special">`</span><span> </span><a href="BasicTypes.html#strongLoopBreaker"><span class="hs-identifier hs-var">strongLoopBreaker</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706993"><span class="hs-identifier hs-var">tail_info</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684706992"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-962"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-963"></a><span>    </span><a name="local-6989586621684706993"><a href="#local-6989586621684706993"><span class="hs-identifier">tail_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684706991"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-964"></a><span>
</span><a name="line-965"></a><span class="hs-identifier">mk_non_loop_breaker</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#Binding"><span class="hs-identifier hs-type">Binding</span></a><span>
</span><a name="line-966"></a><span class="hs-comment">-- See Note [Weak loop breakers]</span><span>
</span><a name="line-967"></a><a name="mk_non_loop_breaker"><a href="OccurAnal.html#mk_non_loop_breaker"><span class="hs-identifier">mk_non_loop_breaker</span></a></a><span> </span><a name="local-6989586621684706994"><a href="#local-6989586621684706994"><span class="hs-identifier">weak_fvs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">node_payload</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#ND"><span class="hs-identifier hs-var">ND</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nd_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684706995"><a href="#local-6989586621684706995"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-968"></a><span>                                                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684706996"><a href="#local-6989586621684706996"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-969"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684706995"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684706994"><span class="hs-identifier hs-var">weak_fvs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Id.html#setIdOccInfo"><span class="hs-identifier hs-var">setIdOccInfo</span></a><span> </span><a href="#local-6989586621684706995"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621684706997"><span class="hs-identifier hs-var">occ'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684706996"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-970"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706995"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684706996"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-971"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-972"></a><span>    </span><a name="local-6989586621684706997"><a href="#local-6989586621684706997"><span class="hs-identifier">occ'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#weakLoopBreaker"><span class="hs-identifier hs-var">weakLoopBreaker</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684706998"><span class="hs-identifier hs-var">tail_info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-973"></a><span>    </span><a name="local-6989586621684706998"><a href="#local-6989586621684706998"><span class="hs-identifier">tail_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684706995"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>
</span><a name="line-975"></a><span class="hs-comment">----------------------------------</span><span>
</span><a name="line-976"></a><span class="hs-identifier">chooseLoopBreaker</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>             </span><span class="hs-comment">-- True &lt;=&gt; Too many iterations,</span><span>
</span><a name="line-977"></a><span>                                      </span><span class="hs-comment">--          so approximate</span><span>
</span><a name="line-978"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a><span>            </span><span class="hs-comment">-- Best score so far</span><span>
</span><a name="line-979"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Nodes with this score</span><span>
</span><a name="line-980"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Nodes with higher scores</span><span>
</span><a name="line-981"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Unprocessed nodes</span><span>
</span><a name="line-982"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-983"></a><span>    </span><span class="hs-comment">-- This loop looks for the bind with the lowest score</span><span>
</span><a name="line-984"></a><span>    </span><span class="hs-comment">-- to pick as the loop  breaker.  The rest accumulate in</span><span>
</span><a name="line-985"></a><a name="chooseLoopBreaker"><a href="OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier">chooseLoopBreaker</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684706999"><a href="#local-6989586621684706999"><span class="hs-identifier">loop_nodes</span></a></a><span> </span><a name="local-6989586621684707000"><a href="#local-6989586621684707000"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-986"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684706999"><span class="hs-identifier hs-var">loop_nodes</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707000"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Done</span><span>
</span><a name="line-987"></a><span>
</span><a name="line-988"></a><span>    </span><span class="hs-comment">-- If approximate_loop_breaker is True, we pick *all*</span><span>
</span><a name="line-989"></a><span>    </span><span class="hs-comment">-- nodes with lowest score, else just one</span><span>
</span><a name="line-990"></a><span>    </span><span class="hs-comment">-- See Note [Complexity of loop breaking]</span><span>
</span><a name="line-991"></a><span class="hs-identifier">chooseLoopBreaker</span><span> </span><a name="local-6989586621684707001"><a href="#local-6989586621684707001"><span class="hs-identifier">approx_lb</span></a></a><span> </span><a name="local-6989586621684707002"><a href="#local-6989586621684707002"><span class="hs-identifier">loop_sc</span></a></a><span> </span><a name="local-6989586621684707003"><a href="#local-6989586621684707003"><span class="hs-identifier">loop_nodes</span></a></a><span> </span><a name="local-6989586621684707004"><a href="#local-6989586621684707004"><span class="hs-identifier">acc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707005"><a href="#local-6989586621684707005"><span class="hs-identifier">node</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684707006"><a href="#local-6989586621684707006"><span class="hs-identifier">nodes</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707001"><span class="hs-identifier hs-var">approx_lb</span></a><span>
</span><a name="line-993"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#rank"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621684707007"><span class="hs-identifier hs-var">sc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="OccurAnal.html#rank"><span class="hs-identifier hs-var">rank</span></a><span> </span><a href="#local-6989586621684707002"><span class="hs-identifier hs-var">loop_sc</span></a><span>
</span><a name="line-994"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a><span> </span><a href="#local-6989586621684707001"><span class="hs-identifier hs-var">approx_lb</span></a><span> </span><a href="#local-6989586621684707002"><span class="hs-identifier hs-var">loop_sc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707005"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684707003"><span class="hs-identifier hs-var">loop_nodes</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707004"><span class="hs-identifier hs-var">acc</span></a><span> </span><a href="#local-6989586621684707006"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-995"></a><span>
</span><a name="line-996"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707007"><span class="hs-identifier hs-var">sc</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#betterLB"><span class="hs-identifier hs-var">betterLB</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707002"><span class="hs-identifier hs-var">loop_sc</span></a><span>  </span><span class="hs-comment">-- Better score so pick this new one</span><span>
</span><a name="line-997"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a><span> </span><a href="#local-6989586621684707001"><span class="hs-identifier hs-var">approx_lb</span></a><span> </span><a href="#local-6989586621684707007"><span class="hs-identifier hs-var">sc</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684707005"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707003"><span class="hs-identifier hs-var">loop_nodes</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684707004"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707006"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-998"></a><span>
</span><a name="line-999"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-comment">-- Worse score so don't pick it</span><span>
</span><a name="line-1000"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#chooseLoopBreaker"><span class="hs-identifier hs-var">chooseLoopBreaker</span></a><span> </span><a href="#local-6989586621684707001"><span class="hs-identifier hs-var">approx_lb</span></a><span> </span><a href="#local-6989586621684707002"><span class="hs-identifier hs-var">loop_sc</span></a><span> </span><a href="#local-6989586621684707003"><span class="hs-identifier hs-var">loop_nodes</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707005"><span class="hs-identifier hs-var">node</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684707004"><span class="hs-identifier hs-var">acc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707006"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-1001"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1002"></a><span>    </span><a name="local-6989586621684707007"><a href="#local-6989586621684707007"><span class="hs-identifier">sc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">nd_score</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">node_payload</span><span> </span><a href="#local-6989586621684707005"><span class="hs-identifier hs-var">node</span></a><span class="hs-special">)</span><span>
</span><a name="line-1003"></a><span>
</span><a name="line-1004"></a><span class="hs-comment">{-
Note [Complexity of loop breaking]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The loop-breaking algorithm knocks out one binder at a time, and
performs a new SCC analysis on the remaining binders.  That can
behave very badly in tightly-coupled groups of bindings; in the
worst case it can be (N**2)*log N, because it does a full SCC
on N, then N-1, then N-2 and so on.

To avoid this, we switch plans after 2 (or whatever) attempts:
  Plan A: pick one binder with the lowest score, make it
          a loop breaker, and try again
  Plan B: pick *all* binders with the lowest score, make them
          all loop breakers, and try again
Since there are only a small finite number of scores, this will
terminate in a constant number of iterations, rather than O(N)
iterations.

You might thing that it's very unlikely, but RULES make it much
more likely.  Here's a real example from Trac #1969:
  Rec { $dm = \d.\x. op d
        {-# RULES forall d. $dm Int d  = $s$dm1
                  forall d. $dm Bool d = $s$dm2 #-}

        dInt = MkD .... opInt ...
        dInt = MkD .... opBool ...
        opInt  = $dm dInt
        opBool = $dm dBool

        $s$dm1 = \x. op dInt
        $s$dm2 = \x. op dBool }
The RULES stuff means that we can't choose $dm as a loop breaker
(Note [Choosing loop breakers]), so we must choose at least (say)
opInt *and* opBool, and so on.  The number of loop breakders is
linear in the number of instance declarations.

Note [Loop breakers and INLINE/INLINABLE pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Avoid choosing a function with an INLINE pramga as the loop breaker!
If such a function is mutually-recursive with a non-INLINE thing,
then the latter should be the loop-breaker.

It's vital to distinguish between INLINE and INLINABLE (the
Bool returned by hasStableCoreUnfolding_maybe).  If we start with
   Rec { {-# INLINABLE f #-}
         f x = ...f... }
and then worker/wrapper it through strictness analysis, we'll get
   Rec { {-# INLINABLE $wf #-}
         $wf p q = let x = (p,q) in ...f...

         {-# INLINE f #-}
         f x = case x of (p,q) -&gt; $wf p q }

Now it is vital that we choose $wf as the loop breaker, so we can
inline 'f' in '$wf'.

Note [DFuns should not be loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's particularly bad to make a DFun into a loop breaker.  See
Note [How instance declarations are translated] in TcInstDcls

We give DFuns a higher score than ordinary CONLIKE things because
if there's a choice we want the DFun to be the non-loop breaker. Eg

rec { sc = /\ a \$dC. $fBWrap (T a) ($fCT @ a $dC)

      $fCT :: forall a_afE. (Roman.C a_afE) =&gt; Roman.C (Roman.T a_afE)
      {-# DFUN #-}
      $fCT = /\a \$dC. MkD (T a) ((sc @ a $dC) |&gt; blah) ($ctoF @ a $dC)
    }

Here 'sc' (the superclass) looks CONLIKE, but we'll never get to it
if we can't unravel the DFun first.

Note [Constructor applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's really really important to inline dictionaries.  Real
example (the Enum Ordering instance from GHC.Base):

     rec     f = \ x -&gt; case d of (p,q,r) -&gt; p x
             g = \ x -&gt; case d of (p,q,r) -&gt; q x
             d = (v, f, g)

Here, f and g occur just once; but we can't inline them into d.
On the other hand we *could* simplify those case expressions if
we didn't stupidly choose d as the loop breaker.
But we won't because constructor args are marked &quot;Many&quot;.
Inlining dictionaries is really essential to unravelling
the loops in static numeric dictionaries, see GHC.Float.

Note [Closure conversion]
~~~~~~~~~~~~~~~~~~~~~~~~~
We treat (\x. C p q) as a high-score candidate in the letrec scoring algorithm.
The immediate motivation came from the result of a closure-conversion transformation
which generated code like this:

    data Clo a b = forall c. Clo (c -&gt; a -&gt; b) c

    ($:) :: Clo a b -&gt; a -&gt; b
    Clo f env $: x = f env x

    rec { plus = Clo plus1 ()

        ; plus1 _ n = Clo plus2 n

        ; plus2 Zero     n = n
        ; plus2 (Succ m) n = Succ (plus $: m $: n) }

If we inline 'plus' and 'plus1', everything unravels nicely.  But if
we choose 'plus1' as the loop breaker (which is entirely possible
otherwise), the loop does not unravel nicely.


@occAnalUnfolding@ deals with the question of bindings where the Id is marked
by an INLINE pragma.  For these we record that anything which occurs
in its RHS occurs many times.  This pessimistically assumes that this
inlined binder also occurs many times in its scope, but if it doesn't
we'll catch it next time round.  At worst this costs an extra simplifier pass.
ToDo: try using the occurrence info for the inline'd binder.

[March 97] We do the same for atomic RHSs.  Reason: see notes with loopBreakSCC.
[June 98, SLPJ]  I've undone this change; I don't understand it.  See notes with loopBreakSCC.


************************************************************************
*                                                                      *
                   Making nodes
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1134"></a><span>
</span><a name="line-1135"></a><span class="hs-keyword">type</span><span> </span><a name="ImpRuleEdges"><a href="OccurAnal.html#ImpRuleEdges"><span class="hs-identifier">ImpRuleEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a><span> </span><a href="VarSet.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a><span>     </span><span class="hs-comment">-- Mapping from FVs of imported RULE LHSs to RHS FVs</span><span>
</span><a name="line-1136"></a><span>
</span><a name="line-1137"></a><span class="hs-identifier">noImpRuleEdges</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a><span>
</span><a name="line-1138"></a><a name="noImpRuleEdges"><a href="OccurAnal.html#noImpRuleEdges"><span class="hs-identifier">noImpRuleEdges</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-1139"></a><span>
</span><a name="line-1140"></a><span class="hs-keyword">type</span><span> </span><a name="LetrecNode"><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier">LetrecNode</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Digraph.html#Node"><span class="hs-identifier hs-type">Node</span></a><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><a href="OccurAnal.html#Details"><span class="hs-identifier hs-type">Details</span></a><span>  </span><span class="hs-comment">-- Node comes from Digraph</span><span>
</span><a name="line-1141"></a><span>                                       </span><span class="hs-comment">-- The Unique key is gotten from the Id</span><span>
</span><a name="line-1142"></a><span class="hs-keyword">data</span><span> </span><a name="Details"><a href="OccurAnal.html#Details"><span class="hs-identifier">Details</span></a></a><span>
</span><a name="line-1143"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="ND"><a href="OccurAnal.html#ND"><span class="hs-identifier">ND</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="nd_bndr"><a href="OccurAnal.html#nd_bndr"><span class="hs-identifier">nd_bndr</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>          </span><span class="hs-comment">-- Binder</span><span>
</span><a name="line-1144"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="nd_rhs"><a href="OccurAnal.html#nd_rhs"><span class="hs-identifier">nd_rhs</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>    </span><span class="hs-comment">-- RHS, already occ-analysed</span><span>
</span><a name="line-1145"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="nd_rhs_bndrs"><a href="OccurAnal.html#nd_rhs_bndrs"><span class="hs-identifier">nd_rhs_bndrs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Outer lambdas of RHS</span><span>
</span><a name="line-1146"></a><span>                                    </span><span class="hs-comment">-- INVARIANT: (nd_rhs_bndrs nd, _) ==</span><span>
</span><a name="line-1147"></a><span>                                    </span><span class="hs-comment">--              collectBinders (nd_rhs nd)</span><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="nd_uds"><a href="OccurAnal.html#nd_uds"><span class="hs-identifier">nd_uds</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>  </span><span class="hs-comment">-- Usage from RHS, and RULES, and stable unfoldings</span><span>
</span><a name="line-1150"></a><span>                                  </span><span class="hs-comment">-- ignoring phase (ie assuming all are active)</span><span>
</span><a name="line-1151"></a><span>                                  </span><span class="hs-comment">-- See Note [Forming Rec groups]</span><span>
</span><a name="line-1152"></a><span>
</span><a name="line-1153"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="nd_inl"><a href="OccurAnal.html#nd_inl"><span class="hs-identifier">nd_inl</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a><span>       </span><span class="hs-comment">-- Free variables of</span><span>
</span><a name="line-1154"></a><span>                                </span><span class="hs-comment">--   the stable unfolding (if present and active)</span><span>
</span><a name="line-1155"></a><span>                                </span><span class="hs-comment">--   or the RHS (if not)</span><span>
</span><a name="line-1156"></a><span>                                </span><span class="hs-comment">-- but excluding any RULES</span><span>
</span><a name="line-1157"></a><span>                                </span><span class="hs-comment">-- This is the IdSet that may be used if the Id is inlined</span><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="nd_weak"><a href="OccurAnal.html#nd_weak"><span class="hs-identifier">nd_weak</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a><span>       </span><span class="hs-comment">-- Binders of this Rec that are mentioned in nd_uds</span><span>
</span><a name="line-1160"></a><span>                                </span><span class="hs-comment">-- but are *not* in nd_inl.  These are the ones whose</span><span>
</span><a name="line-1161"></a><span>                                </span><span class="hs-comment">-- dependencies might not be respected by loop_breaker_nodes</span><span>
</span><a name="line-1162"></a><span>                                </span><span class="hs-comment">-- See Note [Weak loop breakers]</span><span>
</span><a name="line-1163"></a><span>
</span><a name="line-1164"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="nd_active_rule_fvs"><a href="OccurAnal.html#nd_active_rule_fvs"><span class="hs-identifier">nd_active_rule_fvs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a><span>   </span><span class="hs-comment">-- Free variables of the RHS of active RULES</span><span>
</span><a name="line-1165"></a><span>
</span><a name="line-1166"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="nd_score"><a href="OccurAnal.html#nd_score"><span class="hs-identifier">nd_score</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a><span>
</span><a name="line-1167"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-1168"></a><span>
</span><a name="line-1169"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="OccurAnal.html#Details"><span class="hs-identifier hs-type">Details</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1170"></a><span>   </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a name="local-6989586621684706873"><a href="#local-6989586621684706873"><span class="hs-identifier">nd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ND&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a><span>
</span><a name="line-1171"></a><span>             </span><span class="hs-special">(</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;bndr =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nd_bndr</span><span> </span><a href="#local-6989586621684706873"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1172"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;uds =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nd_uds</span><span> </span><a href="#local-6989586621684706873"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1173"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;inl =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nd_inl</span><span> </span><a href="#local-6989586621684706873"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1174"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;weak =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nd_weak</span><span> </span><a href="#local-6989586621684706873"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1175"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;rule =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nd_active_rule_fvs</span><span> </span><a href="#local-6989586621684706873"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1176"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;score =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">nd_score</span><span> </span><a href="#local-6989586621684706873"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1177"></a><span>             </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1178"></a><span>
</span><a name="line-1179"></a><span class="hs-comment">-- The NodeScore is compared lexicographically;</span><span>
</span><a name="line-1180"></a><span class="hs-comment">--      e.g. lower rank wins regardless of size</span><span>
</span><a name="line-1181"></a><span class="hs-keyword">type</span><span> </span><a name="NodeScore"><a href="OccurAnal.html#NodeScore"><span class="hs-identifier">NodeScore</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Int</span><span>     </span><span class="hs-comment">-- Rank: lower =&gt; more likely to be picked as loop breaker</span><span>
</span><a name="line-1182"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Int</span><span>     </span><span class="hs-comment">-- Size of rhs: higher =&gt; more likely to be picked as LB</span><span>
</span><a name="line-1183"></a><span>                           </span><span class="hs-comment">-- Maxes out at maxExprSize; we just use it to prioritise</span><span>
</span><a name="line-1184"></a><span>                           </span><span class="hs-comment">-- small functions</span><span>
</span><a name="line-1185"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Was it a loop breaker before?</span><span>
</span><a name="line-1186"></a><span>                           </span><span class="hs-comment">-- True =&gt; more likely to be picked</span><span>
</span><a name="line-1187"></a><span>                           </span><span class="hs-comment">-- Note [Loop breakers, node scoring, and stability]</span><span>
</span><a name="line-1188"></a><span>
</span><a name="line-1189"></a><span class="hs-identifier">rank</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1190"></a><a name="rank"><a href="OccurAnal.html#rank"><span class="hs-identifier">rank</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707008"><a href="#local-6989586621684707008"><span class="hs-identifier">r</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707008"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1191"></a><span>
</span><a name="line-1192"></a><span class="hs-identifier">makeNode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#ImpRuleEdges"><span class="hs-identifier hs-type">ImpRuleEdges</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1193"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span>
</span><a name="line-1194"></a><span class="hs-comment">-- See Note [Recursive bindings: the grand plan]</span><span>
</span><a name="line-1195"></a><a name="makeNode"><a href="OccurAnal.html#makeNode"><span class="hs-identifier">makeNode</span></a></a><span> </span><a name="local-6989586621684707009"><a href="#local-6989586621684707009"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707010"><a href="#local-6989586621684707010"><span class="hs-identifier">imp_rule_edges</span></a></a><span> </span><a name="local-6989586621684707011"><a href="#local-6989586621684707011"><span class="hs-identifier">bndr_set</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707012"><a href="#local-6989586621684707012"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707013"><a href="#local-6989586621684707013"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1196"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Digraph.html#DigraphNode"><span class="hs-identifier hs-var">DigraphNode</span></a><span> </span><a href="#local-6989586621684707014"><span class="hs-identifier hs-var">details</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#varUnique"><span class="hs-identifier hs-var">varUnique</span></a><span> </span><a href="#local-6989586621684707012"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="UniqSet.html#nonDetKeysUniqSet"><span class="hs-identifier hs-var">nonDetKeysUniqSet</span></a><span> </span><a href="#local-6989586621684707023"><span class="hs-identifier hs-var">node_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1197"></a><span>    </span><span class="hs-comment">-- It's OK to use nonDetKeysUniqSet here as stronglyConnCompFromEdgedVerticesR</span><span>
</span><a name="line-1198"></a><span>    </span><span class="hs-comment">-- is still deterministic with edges in nondeterministic order as</span><span>
</span><a name="line-1199"></a><span>    </span><span class="hs-comment">-- explained in Note [Deterministic SCC] in Digraph.</span><span>
</span><a name="line-1200"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1201"></a><span>    </span><a name="local-6989586621684707014"><a href="#local-6989586621684707014"><span class="hs-identifier">details</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#ND"><span class="hs-identifier hs-var">ND</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nd_bndr</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707012"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1202"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_rhs</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707020"><span class="hs-identifier hs-var">rhs'</span></a><span>
</span><a name="line-1203"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_rhs_bndrs</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707018"><span class="hs-identifier hs-var">bndrs'</span></a><span>
</span><a name="line-1204"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_uds</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707022"><span class="hs-identifier hs-var">rhs_usage3</span></a><span>
</span><a name="line-1205"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_inl</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707030"><span class="hs-identifier hs-var">inl_fvs</span></a><span>
</span><a name="line-1206"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_weak</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707023"><span class="hs-identifier hs-var">node_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#minusVarSet"><span class="hs-identifier hs-var">minusVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707030"><span class="hs-identifier hs-var">inl_fvs</span></a><span>
</span><a name="line-1207"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_active_rule_fvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707028"><span class="hs-identifier hs-var">active_rule_fvs</span></a><span>
</span><a name="line-1208"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_score</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;makeNodeDetails&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684707012"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1209"></a><span>
</span><a name="line-1210"></a><span>    </span><span class="hs-comment">-- Constructing the edges for the main Rec computation</span><span>
</span><a name="line-1211"></a><span>    </span><span class="hs-comment">-- See Note [Forming Rec groups]</span><span>
</span><a name="line-1212"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707015"><a href="#local-6989586621684707015"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707016"><a href="#local-6989586621684707016"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a><span> </span><a href="#local-6989586621684707013"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1213"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707017"><a href="#local-6989586621684707017"><span class="hs-identifier">rhs_usage1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707018"><a href="#local-6989586621684707018"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707019"><a href="#local-6989586621684707019"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalRecRhs"><span class="hs-identifier hs-var">occAnalRecRhs</span></a><span> </span><a href="#local-6989586621684707009"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707015"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684707016"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1214"></a><span>    </span><a name="local-6989586621684707020"><a href="#local-6989586621684707020"><span class="hs-identifier">rhs'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621684707018"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621684707019"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-1215"></a><span>    </span><a name="local-6989586621684707021"><a href="#local-6989586621684707021"><span class="hs-identifier">rhs_usage2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span> </span><a href="#local-6989586621684707017"><span class="hs-identifier hs-var">rhs_usage1</span></a><span> </span><a href="#local-6989586621684707027"><span class="hs-identifier hs-var">rule_uds</span></a><span>
</span><a name="line-1216"></a><span>                   </span><span class="hs-comment">-- Note [Rules are extra RHSs]</span><span>
</span><a name="line-1217"></a><span>                   </span><span class="hs-comment">-- Note [Rule dependency info]</span><span>
</span><a name="line-1218"></a><span>    </span><a name="local-6989586621684707022"><a href="#local-6989586621684707022"><span class="hs-identifier">rhs_usage3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707029"><span class="hs-identifier hs-var">mb_unf_uds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1219"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684707031"><a href="#local-6989586621684707031"><span class="hs-identifier">unf_uds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707021"><span class="hs-identifier hs-var">rhs_usage2</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707031"><span class="hs-identifier hs-var">unf_uds</span></a><span>
</span><a name="line-1220"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707021"><span class="hs-identifier hs-var">rhs_usage2</span></a><span>
</span><a name="line-1221"></a><span>    </span><a name="local-6989586621684707023"><a href="#local-6989586621684707023"><span class="hs-identifier">node_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var">udFreeVars</span></a><span> </span><a href="#local-6989586621684707011"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684707022"><span class="hs-identifier hs-var">rhs_usage3</span></a><span>
</span><a name="line-1222"></a><span>
</span><a name="line-1223"></a><span>    </span><span class="hs-comment">-- Finding the free variables of the rules</span><span>
</span><a name="line-1224"></a><span>    </span><a name="local-6989586621684707024"><a href="#local-6989586621684707024"><span class="hs-identifier">is_active</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">occ_rule_act</span><span> </span><a href="#local-6989586621684707009"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1225"></a><span>
</span><a name="line-1226"></a><span>    </span><span class="hs-identifier">rules_w_uds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1227"></a><span>    </span><a name="local-6989586621684707025"><a href="#local-6989586621684707025"><span class="hs-identifier">rules_w_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalRules"><span class="hs-identifier hs-var">occAnalRules</span></a><span> </span><a href="#local-6989586621684707009"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684707015"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="BasicTypes.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a><span> </span><a href="#local-6989586621684707012"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1228"></a><span>
</span><a name="line-1229"></a><span>    </span><span class="hs-identifier">rules_w_rhs_fvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span class="hs-special">,</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Find the RHS fvs</span><span>
</span><a name="line-1230"></a><span>    </span><a name="local-6989586621684707026"><a href="#local-6989586621684707026"><span class="hs-identifier">rules_w_rhs_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684707032"><a href="#local-6989586621684707032"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="BasicTypes.html#AlwaysActive"><span class="hs-identifier hs-var">AlwaysActive</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707032"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1231"></a><span>                               </span><span class="hs-special">(</span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684707010"><span class="hs-identifier hs-var">imp_rule_edges</span></a><span> </span><a href="#local-6989586621684707012"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1232"></a><span>      </span><span class="hs-comment">-- See Note [Preventing loops due to imported functions rules]</span><span>
</span><a name="line-1233"></a><span>                      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ru_act</span><span> </span><a href="#local-6989586621684707033"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var">udFreeVars</span></a><span> </span><a href="#local-6989586621684707011"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684707034"><span class="hs-identifier hs-var">rhs_uds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1234"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707033"><a href="#local-6989586621684707033"><span class="hs-identifier">rule</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684707034"><a href="#local-6989586621684707034"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707025"><span class="hs-identifier hs-var">rules_w_uds</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1235"></a><span>    </span><a name="local-6989586621684707027"><a href="#local-6989586621684707027"><span class="hs-identifier">rule_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684707035"><a href="#local-6989586621684707035"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707036"><a href="#local-6989586621684707036"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707035"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707036"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707025"><span class="hs-identifier hs-var">rules_w_uds</span></a><span>
</span><a name="line-1236"></a><span>    </span><a name="local-6989586621684707028"><a href="#local-6989586621684707028"><span class="hs-identifier">active_rule_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unionVarSets"><span class="hs-identifier hs-var">unionVarSets</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684707038"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707037"><a href="#local-6989586621684707037"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><a name="local-6989586621684707038"><a href="#local-6989586621684707038"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707026"><span class="hs-identifier hs-var">rules_w_rhs_fvs</span></a><span>
</span><a name="line-1237"></a><span>                                        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707024"><span class="hs-identifier hs-var">is_active</span></a><span> </span><a href="#local-6989586621684707037"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1238"></a><span>
</span><a name="line-1239"></a><span>    </span><span class="hs-comment">-- Finding the usage details of the INLINE pragma (if any)</span><span>
</span><a name="line-1240"></a><span>    </span><a name="local-6989586621684707029"><a href="#local-6989586621684707029"><span class="hs-identifier">mb_unf_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalUnfolding"><span class="hs-identifier hs-var">occAnalUnfolding</span></a><span> </span><a href="#local-6989586621684707009"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="BasicTypes.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a><span> </span><a href="#local-6989586621684707012"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1241"></a><span>
</span><a name="line-1242"></a><span>    </span><span class="hs-comment">-- Find the &quot;nd_inl&quot; free vars; for the loop-breaker phase</span><span>
</span><a name="line-1243"></a><span>    </span><a name="local-6989586621684707030"><a href="#local-6989586621684707030"><span class="hs-identifier">inl_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707029"><span class="hs-identifier hs-var">mb_unf_uds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1244"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var">udFreeVars</span></a><span> </span><a href="#local-6989586621684707011"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684707017"><span class="hs-identifier hs-var">rhs_usage1</span></a><span> </span><span class="hs-comment">-- No INLINE, use RHS</span><span>
</span><a name="line-1245"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684707039"><a href="#local-6989586621684707039"><span class="hs-identifier">unf_uds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#udFreeVars"><span class="hs-identifier hs-var">udFreeVars</span></a><span> </span><a href="#local-6989586621684707011"><span class="hs-identifier hs-var">bndr_set</span></a><span> </span><a href="#local-6989586621684707039"><span class="hs-identifier hs-var">unf_uds</span></a><span>
</span><a name="line-1246"></a><span>                      </span><span class="hs-comment">-- We could check for an *active* INLINE (returning</span><span>
</span><a name="line-1247"></a><span>                      </span><span class="hs-comment">-- emptyVarSet for an inactive one), but is_active</span><span>
</span><a name="line-1248"></a><span>                      </span><span class="hs-comment">-- isn't the right thing (it tells about</span><span>
</span><a name="line-1249"></a><span>                      </span><span class="hs-comment">-- RULE activation), so we'd need more plumbing</span><span>
</span><a name="line-1250"></a><span>
</span><a name="line-1251"></a><span class="hs-identifier">mkLoopBreakerNodes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span>
</span><a name="line-1252"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1253"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>   </span><span class="hs-comment">-- for BODY of let</span><span>
</span><a name="line-1254"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#Details"><span class="hs-identifier hs-type">Details</span></a><span class="hs-special">]</span><span>
</span><a name="line-1255"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- adjusted</span><span>
</span><a name="line-1256"></a><span>                       </span><span class="hs-special">[</span><a href="OccurAnal.html#LetrecNode"><span class="hs-identifier hs-type">LetrecNode</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1257"></a><span class="hs-comment">-- Does four things</span><span>
</span><a name="line-1258"></a><span class="hs-comment">--   a) tag each binder with its occurrence info</span><span>
</span><a name="line-1259"></a><span class="hs-comment">--   b) add a NodeScore to each node</span><span>
</span><a name="line-1260"></a><span class="hs-comment">--   c) make a Node with the right dependency edges for</span><span>
</span><a name="line-1261"></a><span class="hs-comment">--      the loop-breaker SCC analysis</span><span>
</span><a name="line-1262"></a><span class="hs-comment">--   d) adjust each RHS's usage details according to</span><span>
</span><a name="line-1263"></a><span class="hs-comment">--      the binder's (new) shotness and join-point-hood</span><span>
</span><a name="line-1264"></a><a name="mkLoopBreakerNodes"><a href="OccurAnal.html#mkLoopBreakerNodes"><span class="hs-identifier">mkLoopBreakerNodes</span></a></a><span> </span><a name="local-6989586621684707040"><a href="#local-6989586621684707040"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707041"><a href="#local-6989586621684707041"><span class="hs-identifier">lvl</span></a></a><span> </span><a name="local-6989586621684707042"><a href="#local-6989586621684707042"><span class="hs-identifier">bndr_set</span></a></a><span> </span><a name="local-6989586621684707043"><a href="#local-6989586621684707043"><span class="hs-identifier">body_uds</span></a></a><span> </span><a name="local-6989586621684707044"><a href="#local-6989586621684707044"><span class="hs-identifier">details_s</span></a></a><span>
</span><a name="line-1265"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707045"><span class="hs-identifier hs-var">final_uds</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621684707047"><span class="hs-identifier hs-var">mk_lb_node</span></a><span> </span><a href="#local-6989586621684707044"><span class="hs-identifier hs-var">details_s</span></a><span> </span><a href="#local-6989586621684707046"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1266"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1267"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707045"><a href="#local-6989586621684707045"><span class="hs-identifier">final_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707046"><a href="#local-6989586621684707046"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#tagRecBinders"><span class="hs-identifier hs-var">tagRecBinders</span></a><span> </span><a href="#local-6989586621684707041"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621684707043"><span class="hs-identifier hs-var">body_uds</span></a><span>
</span><a name="line-1268"></a><span>                            </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">nd_bndr</span><span> </span><a href="#local-6989586621684707050"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1269"></a><span>                               </span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-identifier">nd_uds</span><span> </span><a href="#local-6989586621684707050"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1270"></a><span>                               </span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-identifier">nd_rhs_bndrs</span><span> </span><a href="#local-6989586621684707050"><span class="hs-identifier hs-var">nd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1271"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684707050"><a href="#local-6989586621684707050"><span class="hs-identifier">nd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707044"><span class="hs-identifier hs-var">details_s</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1272"></a><span>    </span><a name="local-6989586621684707047"><a href="#local-6989586621684707047"><span class="hs-identifier">mk_lb_node</span></a></a><span> </span><a name="local-6989586621684707051"><a href="#local-6989586621684707051"><span class="hs-identifier">nd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="OccurAnal.html#ND"><span class="hs-identifier hs-var">ND</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nd_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707052"><a href="#local-6989586621684707052"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707053"><a href="#local-6989586621684707053"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707054"><a href="#local-6989586621684707054"><span class="hs-identifier">inl_fvs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684707055"><a href="#local-6989586621684707055"><span class="hs-identifier">bndr'</span></a></a><span>
</span><a name="line-1273"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Digraph.html#DigraphNode"><span class="hs-identifier hs-var">DigraphNode</span></a><span> </span><a href="#local-6989586621684707056"><span class="hs-identifier hs-var">nd'</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#varUnique"><span class="hs-identifier hs-var">varUnique</span></a><span> </span><a href="#local-6989586621684707052"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="UniqSet.html#nonDetKeysUniqSet"><span class="hs-identifier hs-var">nonDetKeysUniqSet</span></a><span> </span><a href="#local-6989586621684707058"><span class="hs-identifier hs-var">lb_deps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1274"></a><span>              </span><span class="hs-comment">-- It's OK to use nonDetKeysUniqSet here as</span><span>
</span><a name="line-1275"></a><span>              </span><span class="hs-comment">-- stronglyConnCompFromEdgedVerticesR is still deterministic with edges</span><span>
</span><a name="line-1276"></a><span>              </span><span class="hs-comment">-- in nondeterministic order as explained in</span><span>
</span><a name="line-1277"></a><span>              </span><span class="hs-comment">-- Note [Deterministic SCC] in Digraph.</span><span>
</span><a name="line-1278"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1279"></a><span>        </span><a name="local-6989586621684707056"><a href="#local-6989586621684707056"><span class="hs-identifier">nd'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707051"><span class="hs-identifier hs-var">nd</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nd_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707055"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_score</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707057"><span class="hs-identifier hs-var">score</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1280"></a><span>        </span><a name="local-6989586621684707057"><a href="#local-6989586621684707057"><span class="hs-identifier">score</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#nodeScore"><span class="hs-identifier hs-var">nodeScore</span></a><span> </span><a href="#local-6989586621684707040"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707052"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621684707055"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621684707053"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684707058"><span class="hs-identifier hs-var">lb_deps</span></a><span>
</span><a name="line-1281"></a><span>        </span><a name="local-6989586621684707058"><a href="#local-6989586621684707058"><span class="hs-identifier">lb_deps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#extendFvs_"><span class="hs-identifier hs-var">extendFvs_</span></a><span> </span><a href="#local-6989586621684707048"><span class="hs-identifier hs-var">rule_fv_env</span></a><span> </span><a href="#local-6989586621684707054"><span class="hs-identifier hs-var">inl_fvs</span></a><span>
</span><a name="line-1282"></a><span>
</span><a name="line-1283"></a><span>    </span><span class="hs-identifier">rule_fv_env</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a><span> </span><a href="VarSet.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a><span>
</span><a name="line-1284"></a><span>        </span><span class="hs-comment">-- Maps a variable f to the variables from this group</span><span>
</span><a name="line-1285"></a><span>        </span><span class="hs-comment">--      mentioned in RHS of active rules for f</span><span>
</span><a name="line-1286"></a><span>        </span><span class="hs-comment">-- Domain is *subset* of bound vars (others have no rule fvs)</span><span>
</span><a name="line-1287"></a><span>    </span><a name="local-6989586621684707048"><a href="#local-6989586621684707048"><span class="hs-identifier">rule_fv_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#transClosureFV"><span class="hs-identifier hs-var">transClosureFV</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><a href="#local-6989586621684707049"><span class="hs-identifier hs-var">init_rule_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1288"></a><span>    </span><a name="local-6989586621684707049"><a href="#local-6989586621684707049"><span class="hs-identifier">init_rule_fvs</span></a></a><span>   </span><span class="hs-comment">-- See Note [Finding rule RHS free vars]</span><span>
</span><a name="line-1289"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707059"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707061"><span class="hs-identifier hs-var">trimmed_rule_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="OccurAnal.html#ND"><span class="hs-identifier hs-var">ND</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">nd_bndr</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707059"><a href="#local-6989586621684707059"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">nd_active_rule_fvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707060"><a href="#local-6989586621684707060"><span class="hs-identifier">rule_fvs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707044"><span class="hs-identifier hs-var">details_s</span></a><span>
</span><a name="line-1291"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684707061"><a href="#local-6989586621684707061"><span class="hs-identifier">trimmed_rule_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707060"><span class="hs-identifier hs-var">rule_fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#intersectVarSet"><span class="hs-identifier hs-var">intersectVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707042"><span class="hs-identifier hs-var">bndr_set</span></a><span>
</span><a name="line-1292"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><a href="#local-6989586621684707061"><span class="hs-identifier hs-var">trimmed_rule_fvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span class="hs-comment">------------------------------------------</span><span>
</span><a name="line-1296"></a><span class="hs-identifier">nodeScore</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-1297"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>        </span><span class="hs-comment">-- Binder has old occ-info (just for loop-breaker-ness)</span><span>
</span><a name="line-1298"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>        </span><span class="hs-comment">-- Binder with new occ-info</span><span>
</span><a name="line-1299"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>  </span><span class="hs-comment">-- RHS</span><span>
</span><a name="line-1300"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>    </span><span class="hs-comment">-- Loop-breaker dependencies</span><span>
</span><a name="line-1301"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a><span>
</span><a name="line-1302"></a><a name="nodeScore"><a href="OccurAnal.html#nodeScore"><span class="hs-identifier">nodeScore</span></a></a><span> </span><a name="local-6989586621684707062"><a href="#local-6989586621684707062"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707063"><a href="#local-6989586621684707063"><span class="hs-identifier">old_bndr</span></a></a><span> </span><a name="local-6989586621684707064"><a href="#local-6989586621684707064"><span class="hs-identifier">new_bndr</span></a></a><span> </span><a name="local-6989586621684707065"><a href="#local-6989586621684707065"><span class="hs-identifier">bind_rhs</span></a></a><span> </span><a name="local-6989586621684707066"><a href="#local-6989586621684707066"><span class="hs-identifier">lb_deps</span></a></a><span>
</span><a name="line-1303"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684707063"><span class="hs-identifier hs-var">old_bndr</span></a><span class="hs-special">)</span><span>     </span><span class="hs-comment">-- A type or cercion variable is never a loop breaker</span><span>
</span><a name="line-1304"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">100</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707063"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707066"><span class="hs-identifier hs-var">lb_deps</span></a><span>  </span><span class="hs-comment">-- Self-recursive things are great loop breakers</span><span>
</span><a name="line-1307"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- See Note [Self-recursion and loop breakers]</span><span>
</span><a name="line-1308"></a><span>
</span><a name="line-1309"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occ_unf_act</span><span> </span><a href="#local-6989586621684707062"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707063"><span class="hs-identifier hs-var">old_bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- A binder whose inlining is inactive (e.g. has</span><span>
</span><a name="line-1310"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- a NOINLINE pragma) makes a great loop breaker</span><span>
</span><a name="line-1311"></a><span>
</span><a name="line-1312"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-6989586621684707069"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1313"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707067"><span class="hs-identifier hs-var">mk_score</span></a><span> </span><span class="hs-number">10</span><span>  </span><span class="hs-comment">-- Practically certain to be inlined</span><span>
</span><a name="line-1314"></a><span>    </span><span class="hs-comment">-- Used to have also: &amp;&amp; not (isExportedId bndr)</span><span>
</span><a name="line-1315"></a><span>    </span><span class="hs-comment">-- But I found this sometimes cost an extra iteration when we have</span><span>
</span><a name="line-1316"></a><span>    </span><span class="hs-comment">--      rec { d = (a,b); a = ...df...; b = ...df...; df = d }</span><span>
</span><a name="line-1317"></a><span>    </span><span class="hs-comment">-- where df is the exported dictionary. Then df makes a really</span><span>
</span><a name="line-1318"></a><span>    </span><span class="hs-comment">-- bad choice for loop breaker</span><span>
</span><a name="line-1319"></a><span>
</span><a name="line-1320"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707083"><a href="#local-6989586621684707083"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707072"><span class="hs-identifier hs-var">id_unfolding</span></a><span>
</span><a name="line-1321"></a><span>    </span><span class="hs-comment">-- Never choose a DFun as a loop breaker</span><span>
</span><a name="line-1322"></a><span>    </span><span class="hs-comment">-- Note [DFuns should not be loop breakers]</span><span>
</span><a name="line-1323"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">9</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684707083"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707068"><span class="hs-identifier hs-var">is_lb</span></a><span class="hs-special">)</span><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span>    </span><span class="hs-comment">-- Data structures are more important than INLINE pragmas</span><span>
</span><a name="line-1326"></a><span>    </span><span class="hs-comment">-- so that dictionary/method recursion unravels</span><span>
</span><a name="line-1327"></a><span>
</span><a name="line-1328"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_guidance</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#UnfWhen"><span class="hs-identifier hs-var">UnfWhen</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707072"><span class="hs-identifier hs-var">id_unfolding</span></a><span>
</span><a name="line-1329"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707067"><span class="hs-identifier hs-var">mk_score</span></a><span> </span><span class="hs-number">6</span><span>
</span><a name="line-1330"></a><span>
</span><a name="line-1331"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707073"><span class="hs-identifier hs-var">is_con_app</span></a><span> </span><a href="#local-6989586621684707069"><span class="hs-identifier hs-var">rhs</span></a><span>   </span><span class="hs-comment">-- Data types help with cases:</span><span>
</span><a name="line-1332"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707067"><span class="hs-identifier hs-var">mk_score</span></a><span> </span><span class="hs-number">5</span><span>       </span><span class="hs-comment">-- Note [Constructor applications]</span><span>
</span><a name="line-1333"></a><span>
</span><a name="line-1334"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a><span> </span><a href="#local-6989586621684707072"><span class="hs-identifier hs-var">id_unfolding</span></a><span>
</span><a name="line-1335"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707071"><span class="hs-identifier hs-var">can_unfold</span></a><span>
</span><a name="line-1336"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707067"><span class="hs-identifier hs-var">mk_score</span></a><span> </span><span class="hs-number">3</span><span>
</span><a name="line-1337"></a><span>
</span><a name="line-1338"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="BasicTypes.html#isOneOcc"><span class="hs-identifier hs-var">isOneOcc</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684707064"><span class="hs-identifier hs-var">new_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1339"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707067"><span class="hs-identifier hs-var">mk_score</span></a><span> </span><span class="hs-number">2</span><span>  </span><span class="hs-comment">-- Likely to be inlined</span><span>
</span><a name="line-1340"></a><span>
</span><a name="line-1341"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707071"><span class="hs-identifier hs-var">can_unfold</span></a><span>  </span><span class="hs-comment">-- The Id has some kind of unfolding</span><span>
</span><a name="line-1342"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707067"><span class="hs-identifier hs-var">mk_score</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1343"></a><span>
</span><a name="line-1344"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1345"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707068"><span class="hs-identifier hs-var">is_lb</span></a><span class="hs-special">)</span><span>
</span><a name="line-1346"></a><span>
</span><a name="line-1347"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1348"></a><span>    </span><span class="hs-identifier">mk_score</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a><span>
</span><a name="line-1349"></a><span>    </span><a name="local-6989586621684707067"><a href="#local-6989586621684707067"><span class="hs-identifier">mk_score</span></a></a><span> </span><a name="local-6989586621684707074"><a href="#local-6989586621684707074"><span class="hs-identifier">rank</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707074"><span class="hs-identifier hs-var">rank</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707070"><span class="hs-identifier hs-var">rhs_size</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707068"><span class="hs-identifier hs-var">is_lb</span></a><span class="hs-special">)</span><span>
</span><a name="line-1350"></a><span>
</span><a name="line-1351"></a><span>    </span><a name="local-6989586621684707068"><a href="#local-6989586621684707068"><span class="hs-identifier">is_lb</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isStrongLoopBreaker"><span class="hs-identifier hs-var">isStrongLoopBreaker</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684707063"><span class="hs-identifier hs-var">old_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1352"></a><span>    </span><a name="local-6989586621684707069"><a href="#local-6989586621684707069"><span class="hs-identifier">rhs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707072"><span class="hs-identifier hs-var">id_unfolding</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1353"></a><span>                 </span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707075"><a href="#local-6989586621684707075"><span class="hs-identifier">src</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707076"><a href="#local-6989586621684707076"><span class="hs-identifier">unf_rhs</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1354"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span> </span><a href="#local-6989586621684707075"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-1355"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707076"><span class="hs-identifier hs-var">unf_rhs</span></a><span>
</span><a name="line-1356"></a><span>                 </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707065"><span class="hs-identifier hs-var">bind_rhs</span></a><span>
</span><a name="line-1357"></a><span>       </span><span class="hs-comment">-- 'bind_rhs' is irrelevant for inlining things with a stable unfolding</span><span>
</span><a name="line-1358"></a><span>    </span><a name="local-6989586621684707070"><a href="#local-6989586621684707070"><span class="hs-identifier">rhs_size</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707072"><span class="hs-identifier hs-var">id_unfolding</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1359"></a><span>                 </span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_guidance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707077"><a href="#local-6989586621684707077"><span class="hs-identifier">guidance</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1360"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#UnfIfGoodArgs"><span class="hs-identifier hs-var">UnfIfGoodArgs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ug_size</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707078"><a href="#local-6989586621684707078"><span class="hs-identifier">size</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707077"><span class="hs-identifier hs-var">guidance</span></a><span>
</span><a name="line-1361"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707078"><span class="hs-identifier hs-var">size</span></a><span>
</span><a name="line-1362"></a><span>                 </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#cheapExprSize"><span class="hs-identifier hs-var">cheapExprSize</span></a><span> </span><a href="#local-6989586621684707069"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1363"></a><span>
</span><a name="line-1364"></a><span>    </span><a name="local-6989586621684707071"><a href="#local-6989586621684707071"><span class="hs-identifier">can_unfold</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#canUnfold"><span class="hs-identifier hs-var">canUnfold</span></a><span> </span><a href="#local-6989586621684707072"><span class="hs-identifier hs-var">id_unfolding</span></a><span>
</span><a name="line-1365"></a><span>    </span><a name="local-6989586621684707072"><a href="#local-6989586621684707072"><span class="hs-identifier">id_unfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a><span> </span><a href="#local-6989586621684707063"><span class="hs-identifier hs-var">old_bndr</span></a><span>
</span><a name="line-1366"></a><span>       </span><span class="hs-comment">-- realIdUnfolding: Ignore loop-breaker-ness here because</span><span>
</span><a name="line-1367"></a><span>       </span><span class="hs-comment">-- that is what we are setting!</span><span>
</span><a name="line-1368"></a><span>
</span><a name="line-1369"></a><span>        </span><span class="hs-comment">-- Checking for a constructor application</span><span>
</span><a name="line-1370"></a><span>        </span><span class="hs-comment">-- Cheap and cheerful; the simplifier moves casts out of the way</span><span>
</span><a name="line-1371"></a><span>        </span><span class="hs-comment">-- The lambda case is important to spot x = /\a. C (f a)</span><span>
</span><a name="line-1372"></a><span>        </span><span class="hs-comment">-- which comes up when C is a dictionary constructor and</span><span>
</span><a name="line-1373"></a><span>        </span><span class="hs-comment">-- f is a default method.</span><span>
</span><a name="line-1374"></a><span>        </span><span class="hs-comment">-- Example: the instance for Show (ST s a) in GHC.ST</span><span>
</span><a name="line-1375"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1376"></a><span>        </span><span class="hs-comment">-- However we *also* treat (\x. C p q) as a con-app-like thing,</span><span>
</span><a name="line-1377"></a><span>        </span><span class="hs-comment">--      Note [Closure conversion]</span><span>
</span><a name="line-1378"></a><span>    </span><a name="local-6989586621684707073"><a href="#local-6989586621684707073"><span class="hs-identifier">is_con_app</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684707079"><a href="#local-6989586621684707079"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#isConLikeId"><span class="hs-identifier hs-var">isConLikeId</span></a><span> </span><a href="#local-6989586621684707079"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1379"></a><span>    </span><span class="hs-identifier">is_con_app</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684707080"><a href="#local-6989586621684707080"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707073"><span class="hs-identifier hs-var">is_con_app</span></a><span> </span><a href="#local-6989586621684707080"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-1380"></a><span>    </span><span class="hs-identifier">is_con_app</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684707081"><a href="#local-6989586621684707081"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707073"><span class="hs-identifier hs-var">is_con_app</span></a><span> </span><a href="#local-6989586621684707081"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1381"></a><span>    </span><span class="hs-identifier">is_con_app</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684707082"><a href="#local-6989586621684707082"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707073"><span class="hs-identifier hs-var">is_con_app</span></a><span> </span><a href="#local-6989586621684707082"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1382"></a><span>    </span><span class="hs-identifier">is_con_app</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1383"></a><span>
</span><a name="line-1384"></a><span class="hs-identifier">maxExprSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1385"></a><a name="maxExprSize"><a href="OccurAnal.html#maxExprSize"><span class="hs-identifier">maxExprSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">20</span><span>  </span><span class="hs-comment">-- Rather arbitrary</span><span>
</span><a name="line-1386"></a><span>
</span><a name="line-1387"></a><span class="hs-identifier">cheapExprSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1388"></a><span class="hs-comment">-- Maxes out at maxExprSize</span><span>
</span><a name="line-1389"></a><a name="cheapExprSize"><a href="OccurAnal.html#cheapExprSize"><span class="hs-identifier">cheapExprSize</span></a></a><span> </span><a name="local-6989586621684707084"><a href="#local-6989586621684707084"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-1390"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707085"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684707084"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1391"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1392"></a><span>    </span><a name="local-6989586621684707085"><a href="#local-6989586621684707085"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684707088"><a href="#local-6989586621684707088"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621684707089"><a href="#local-6989586621684707089"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707088"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="OccurAnal.html#maxExprSize"><span class="hs-identifier hs-var">maxExprSize</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707088"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1393"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707086"><span class="hs-identifier hs-var">go1</span></a><span> </span><a href="#local-6989586621684707088"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707089"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1394"></a><span>
</span><a name="line-1395"></a><span>    </span><a name="local-6989586621684707086"><a href="#local-6989586621684707086"><span class="hs-identifier">go1</span></a></a><span> </span><a name="local-6989586621684707090"><a href="#local-6989586621684707090"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707090"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span>
</span><a name="line-1396"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707091"><a href="#local-6989586621684707091"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707091"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span>
</span><a name="line-1397"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707092"><a href="#local-6989586621684707092"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707092"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1398"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707093"><a href="#local-6989586621684707093"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707093"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1399"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707094"><a href="#local-6989586621684707094"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684707095"><a href="#local-6989586621684707095"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707086"><span class="hs-identifier hs-var">go1</span></a><span> </span><a href="#local-6989586621684707094"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707095"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1400"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707096"><a href="#local-6989586621684707096"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684707097"><a href="#local-6989586621684707097"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707086"><span class="hs-identifier hs-var">go1</span></a><span> </span><a href="#local-6989586621684707096"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707097"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1401"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707098"><a href="#local-6989586621684707098"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684707099"><a href="#local-6989586621684707099"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621684707100"><a href="#local-6989586621684707100"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707085"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707086"><span class="hs-identifier hs-var">go1</span></a><span> </span><a href="#local-6989586621684707098"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707099"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707100"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1402"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707101"><a href="#local-6989586621684707101"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684707102"><a href="#local-6989586621684707102"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684707103"><a href="#local-6989586621684707103"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1403"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684707102"><span class="hs-identifier hs-var">b</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707086"><span class="hs-identifier hs-var">go1</span></a><span> </span><a href="#local-6989586621684707101"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707103"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1404"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707085"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707101"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707103"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1405"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707104"><a href="#local-6989586621684707104"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621684707105"><a href="#local-6989586621684707105"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684707106"><a href="#local-6989586621684707106"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707087"><span class="hs-identifier hs-var">gos</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707086"><span class="hs-identifier hs-var">go1</span></a><span> </span><a href="#local-6989586621684707104"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707106"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#rhssOfBind"><span class="hs-identifier hs-var">rhssOfBind</span></a><span> </span><a href="#local-6989586621684707105"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-1406"></a><span>    </span><span class="hs-identifier">go1</span><span> </span><a name="local-6989586621684707107"><a href="#local-6989586621684707107"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621684707108"><a href="#local-6989586621684707108"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707087"><span class="hs-identifier hs-var">gos</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707086"><span class="hs-identifier hs-var">go1</span></a><span> </span><a href="#local-6989586621684707107"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707108"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#rhssOfAlts"><span class="hs-identifier hs-var">rhssOfAlts</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-1407"></a><span>
</span><a name="line-1408"></a><span>    </span><a name="local-6989586621684707087"><a href="#local-6989586621684707087"><span class="hs-identifier">gos</span></a></a><span> </span><a name="local-6989586621684707110"><a href="#local-6989586621684707110"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707110"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1409"></a><span>    </span><span class="hs-identifier">gos</span><span> </span><a name="local-6989586621684707111"><a href="#local-6989586621684707111"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707112"><a href="#local-6989586621684707112"><span class="hs-identifier">e</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684707113"><a href="#local-6989586621684707113"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707111"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&gt;=</span><span> </span><a href="OccurAnal.html#maxExprSize"><span class="hs-identifier hs-var">maxExprSize</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707111"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1410"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707087"><span class="hs-identifier hs-var">gos</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707086"><span class="hs-identifier hs-var">go1</span></a><span> </span><a href="#local-6989586621684707111"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707112"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707113"><span class="hs-identifier hs-var">es</span></a><span>
</span><a name="line-1411"></a><span>
</span><a name="line-1412"></a><span class="hs-identifier">betterLB</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#NodeScore"><span class="hs-identifier hs-type">NodeScore</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1413"></a><span class="hs-comment">-- If  n1 `betterLB` n2  then choose n1 as the loop breaker</span><span>
</span><a name="line-1414"></a><a name="betterLB"><a href="OccurAnal.html#betterLB"><span class="hs-identifier">betterLB</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707114"><a href="#local-6989586621684707114"><span class="hs-identifier">rank1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707115"><a href="#local-6989586621684707115"><span class="hs-identifier">size1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707116"><a href="#local-6989586621684707116"><span class="hs-identifier">lb1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707117"><a href="#local-6989586621684707117"><span class="hs-identifier">rank2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707118"><a href="#local-6989586621684707118"><span class="hs-identifier">size2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1415"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707114"><span class="hs-identifier hs-var">rank1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621684707117"><span class="hs-identifier hs-var">rank2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1416"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707114"><span class="hs-identifier hs-var">rank1</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621684707117"><span class="hs-identifier hs-var">rank2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1417"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707115"><span class="hs-identifier hs-var">size1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621684707118"><span class="hs-identifier hs-var">size2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>   </span><span class="hs-comment">-- Make the bigger n2 into the loop breaker</span><span>
</span><a name="line-1418"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707115"><span class="hs-identifier hs-var">size1</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621684707118"><span class="hs-identifier hs-var">size2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1419"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707116"><span class="hs-identifier hs-var">lb1</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>    </span><span class="hs-comment">-- Tie-break: if n1 was a loop breaker before, choose it</span><span>
</span><a name="line-1420"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>   </span><span class="hs-comment">-- See Note [Loop breakers, node scoring, and stability]</span><span>
</span><a name="line-1421"></a><span>
</span><a name="line-1422"></a><span class="hs-comment">{- Note [Self-recursion and loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we have
   rec { f = ...f...g...
       ; g = .....f...   }
then 'f' has to be a loop breaker anyway, so we may as well choose it
right away, so that g can inline freely.

This is really just a cheap hack. Consider
   rec { f = ...g...
       ; g = ..f..h...
      ;  h = ...f....}
Here f or g are better loop breakers than h; but we might accidentally
choose h.  Finding the minimal set of loop breakers is hard.

Note [Loop breakers, node scoring, and stability]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
To choose a loop breaker, we give a NodeScore to each node in the SCC,
and pick the one with the best score (according to 'betterLB').

We need to be jolly careful (Trac #12425, #12234) about the stability
of this choice. Suppose we have

    let rec { f = ...g...g...
            ; g = ...f...f... }
    in
    case x of
      True  -&gt; ...f..
      False -&gt; ..f...

In each iteration of the simplifier the occurrence analyser OccAnal
chooses a loop breaker. Suppose in iteration 1 it choose g as the loop
breaker. That means it is free to inline f.

Suppose that GHC decides to inline f in the branches of the case, but
(for some reason; eg it is not saturated) in the rhs of g. So we get

    let rec { f = ...g...g...
            ; g = ...f...f... }
    in
    case x of
      True  -&gt; ...g...g.....
      False -&gt; ..g..g....

Now suppose that, for some reason, in the next iteration the occurrence
analyser chooses f as the loop breaker, so it can freely inline g. And
again for some reason the simplifier inlines g at its calls in the case
branches, but not in the RHS of f. Then we get

    let rec { f = ...g...g...
            ; g = ...f...f... }
    in
    case x of
      True  -&gt; ...(...f...f...)...(...f..f..).....
      False -&gt; ..(...f...f...)...(..f..f...)....

You can see where this is going! Each iteration of the simplifier
doubles the number of calls to f or g. No wonder GHC is slow!

(In the particular example in comment:3 of #12425, f and g are the two
mutually recursive fmap instances for CondT and Result. They are both
marked INLINE which, oddly, is why they don't inline in each other's
RHS, because the call there is not saturated.)

The root cause is that we flip-flop on our choice of loop breaker. I
always thought it didn't matter, and indeed for any single iteration
to terminate, it doesn't matter. But when we iterate, it matters a
lot!!

So The Plan is this:
   If there is a tie, choose the node that
   was a loop breaker last time round

Hence the is_lb field of NodeScore

************************************************************************
*                                                                      *
                   Right hand sides
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1503"></a><span>
</span><a name="line-1504"></a><span class="hs-identifier">occAnalRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1505"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1506"></a><span>              </span><span class="hs-comment">-- Returned usage details covers only the RHS,</span><span>
</span><a name="line-1507"></a><span>              </span><span class="hs-comment">-- and *not* the RULE or INLINE template for the Id</span><span>
</span><a name="line-1508"></a><a name="occAnalRhs"><a href="OccurAnal.html#occAnalRhs"><span class="hs-identifier">occAnalRhs</span></a></a><span> </span><a name="local-6989586621684707119"><a href="#local-6989586621684707119"><span class="hs-identifier">env</span></a></a><span> </span><a href="BasicTypes.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684707120"><a href="#local-6989586621684707120"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684707121"><a href="#local-6989586621684707121"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1509"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalRecRhs"><span class="hs-identifier hs-var">occAnalRecRhs</span></a><span> </span><a href="#local-6989586621684707119"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707120"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684707121"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1510"></a><span class="hs-identifier">occAnalRhs</span><span> </span><a name="local-6989586621684707122"><a href="#local-6989586621684707122"><span class="hs-identifier">env</span></a></a><span> </span><a href="BasicTypes.html#NonRecursive"><span class="hs-identifier hs-var">NonRecursive</span></a><span> </span><a name="local-6989586621684707123"><a href="#local-6989586621684707123"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684707124"><a href="#local-6989586621684707124"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684707125"><a href="#local-6989586621684707125"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1511"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalNonRecRhs"><span class="hs-identifier hs-var">occAnalNonRecRhs</span></a><span> </span><a href="#local-6989586621684707122"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707123"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684707124"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684707125"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1512"></a><span>
</span><a name="line-1513"></a><span class="hs-identifier">occAnalRecRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>    </span><span class="hs-comment">-- Rhs lambdas, body</span><span>
</span><a name="line-1514"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>              </span><span class="hs-comment">-- Returned usage details covers only the RHS,</span><span>
</span><a name="line-1516"></a><span>              </span><span class="hs-comment">-- and *not* the RULE or INLINE template for the Id</span><span>
</span><a name="line-1517"></a><a name="occAnalRecRhs"><a href="OccurAnal.html#occAnalRecRhs"><span class="hs-identifier">occAnalRecRhs</span></a></a><span> </span><a name="local-6989586621684707126"><a href="#local-6989586621684707126"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707127"><a href="#local-6989586621684707127"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684707128"><a href="#local-6989586621684707128"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalLamOrRhs"><span class="hs-identifier hs-var">occAnalLamOrRhs</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#rhsCtxt"><span class="hs-identifier hs-var">rhsCtxt</span></a><span> </span><a href="#local-6989586621684707126"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707127"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684707128"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1518"></a><span>
</span><a name="line-1519"></a><span class="hs-identifier">occAnalNonRecRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-1520"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>    </span><span class="hs-comment">-- Binder; rhs lams, body</span><span>
</span><a name="line-1521"></a><span>                     </span><span class="hs-comment">-- Binder is already tagged with occurrence info</span><span>
</span><a name="line-1522"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1523"></a><span>              </span><span class="hs-comment">-- Returned usage details covers only the RHS,</span><span>
</span><a name="line-1524"></a><span>              </span><span class="hs-comment">-- and *not* the RULE or INLINE template for the Id</span><span>
</span><a name="line-1525"></a><a name="occAnalNonRecRhs"><a href="OccurAnal.html#occAnalNonRecRhs"><span class="hs-identifier">occAnalNonRecRhs</span></a></a><span> </span><a name="local-6989586621684707129"><a href="#local-6989586621684707129"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707130"><a href="#local-6989586621684707130"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684707131"><a href="#local-6989586621684707131"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684707132"><a href="#local-6989586621684707132"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1526"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalLamOrRhs"><span class="hs-identifier hs-var">occAnalLamOrRhs</span></a><span> </span><a href="#local-6989586621684707134"><span class="hs-identifier hs-var">rhs_env</span></a><span> </span><a href="#local-6989586621684707131"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684707132"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1527"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1528"></a><span>    </span><a name="local-6989586621684707133"><a href="#local-6989586621684707133"><span class="hs-identifier">env1</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707136"><span class="hs-identifier hs-var">is_join_point</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707129"><span class="hs-identifier hs-var">env</span></a><span>  </span><span class="hs-comment">-- See Note [Join point RHSs]</span><span>
</span><a name="line-1529"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707135"><span class="hs-identifier hs-var">certainly_inline</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707129"><span class="hs-identifier hs-var">env</span></a><span>  </span><span class="hs-comment">-- See Note [Cascading inlines]</span><span>
</span><a name="line-1530"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#rhsCtxt"><span class="hs-identifier hs-var">rhsCtxt</span></a><span> </span><a href="#local-6989586621684707129"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1531"></a><span>
</span><a name="line-1532"></a><span>    </span><span class="hs-comment">-- See Note [Sources of one-shot information]</span><span>
</span><a name="line-1533"></a><span>    </span><a name="local-6989586621684707134"><a href="#local-6989586621684707134"><span class="hs-identifier">rhs_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707133"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#argOneShots"><span class="hs-identifier hs-var">argOneShots</span></a><span> </span><a href="#local-6989586621684707138"><span class="hs-identifier hs-var">dmd</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1534"></a><span>
</span><a name="line-1535"></a><span>    </span><a name="local-6989586621684707135"><a href="#local-6989586621684707135"><span class="hs-identifier">certainly_inline</span></a></a><span> </span><span class="hs-comment">-- See Note [Cascading inlines]</span><span>
</span><a name="line-1536"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707137"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1537"></a><span>          </span><a href="BasicTypes.html#OneOcc"><span class="hs-identifier hs-var">OneOcc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_in_lam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707141"><a href="#local-6989586621684707141"><span class="hs-identifier">in_lam</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_one_br</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707142"><a href="#local-6989586621684707142"><span class="hs-identifier">one_br</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1538"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684707141"><span class="hs-identifier hs-var">in_lam</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684707142"><span class="hs-identifier hs-var">one_br</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684707139"><span class="hs-identifier hs-var">active</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684707140"><span class="hs-identifier hs-var">not_stable</span></a><span>
</span><a name="line-1539"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1540"></a><span>
</span><a name="line-1541"></a><span>    </span><a name="local-6989586621684707136"><a href="#local-6989586621684707136"><span class="hs-identifier">is_join_point</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isAlwaysTailCalled"><span class="hs-identifier hs-var">isAlwaysTailCalled</span></a><span> </span><a href="#local-6989586621684707137"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-1542"></a><span>    </span><span class="hs-comment">-- Like (isJoinId bndr) but happens one step earlier</span><span>
</span><a name="line-1543"></a><span>    </span><span class="hs-comment">--  c.f. willBeJoinId_maybe</span><span>
</span><a name="line-1544"></a><span>
</span><a name="line-1545"></a><span>    </span><a name="local-6989586621684707137"><a href="#local-6989586621684707137"><span class="hs-identifier">occ</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684707130"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1546"></a><span>    </span><a name="local-6989586621684707138"><a href="#local-6989586621684707138"><span class="hs-identifier">dmd</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idDemandInfo"><span class="hs-identifier hs-var">idDemandInfo</span></a><span> </span><a href="#local-6989586621684707130"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1547"></a><span>    </span><a name="local-6989586621684707139"><a href="#local-6989586621684707139"><span class="hs-identifier">active</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-6989586621684707130"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1548"></a><span>    </span><a name="local-6989586621684707140"><a href="#local-6989586621684707140"><span class="hs-identifier">not_stable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-6989586621684707130"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1549"></a><span>
</span><a name="line-1550"></a><span class="hs-identifier">occAnalUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-1551"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span>
</span><a name="line-1552"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-1553"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-1554"></a><span>                      </span><span class="hs-comment">-- Just the analysis, not a new unfolding. The unfolding</span><span>
</span><a name="line-1555"></a><span>                      </span><span class="hs-comment">-- got analysed when it was created and we don't need to</span><span>
</span><a name="line-1556"></a><span>                      </span><span class="hs-comment">-- update it.</span><span>
</span><a name="line-1557"></a><a name="occAnalUnfolding"><a href="OccurAnal.html#occAnalUnfolding"><span class="hs-identifier">occAnalUnfolding</span></a></a><span> </span><a name="local-6989586621684707143"><a href="#local-6989586621684707143"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707144"><a href="#local-6989586621684707144"><span class="hs-identifier">rec_flag</span></a></a><span> </span><a name="local-6989586621684707145"><a href="#local-6989586621684707145"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1558"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a><span> </span><a href="#local-6989586621684707145"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- ignore previous loop-breaker flag</span><span>
</span><a name="line-1559"></a><span>      </span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707146"><a href="#local-6989586621684707146"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707147"><a href="#local-6989586621684707147"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1560"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span> </span><a href="#local-6989586621684707147"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">)</span><span>
</span><a name="line-1561"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1562"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1563"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="OccurAnal.html#markAllMany"><span class="hs-identifier hs-var">markAllMany</span></a><span> </span><a href="#local-6989586621684707150"><span class="hs-identifier hs-var">usage</span></a><span>
</span><a name="line-1564"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1565"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684707148"><a href="#local-6989586621684707148"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707149"><a href="#local-6989586621684707149"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a><span> </span><a href="#local-6989586621684707146"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1566"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684707150"><a href="#local-6989586621684707150"><span class="hs-identifier">usage</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalRhs"><span class="hs-identifier hs-var">occAnalRhs</span></a><span> </span><a href="#local-6989586621684707143"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707144"><span class="hs-identifier hs-var">rec_flag</span></a><span> </span><a href="#local-6989586621684707145"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684707148"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684707149"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1567"></a><span>
</span><a name="line-1568"></a><span>      </span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707151"><a href="#local-6989586621684707151"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707152"><a href="#local-6989586621684707152"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1569"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="OccurAnal.html#zapDetails"><span class="hs-identifier hs-var">zapDetails</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#delDetailsList"><span class="hs-identifier hs-var">delDetailsList</span></a><span> </span><a href="#local-6989586621684707153"><span class="hs-identifier hs-var">usage</span></a><span> </span><a href="#local-6989586621684707151"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1570"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-1571"></a><span>          </span><a name="local-6989586621684707153"><a href="#local-6989586621684707153"><span class="hs-identifier">usage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#andUDsList"><span class="hs-identifier hs-var">andUDsList</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707143"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707152"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1574"></a><span>
</span><a name="line-1575"></a><span class="hs-identifier">occAnalRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-1576"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BasicTypes.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a><span> </span><span class="hs-comment">-- If the binder is (or MAY become) a join</span><span>
</span><a name="line-1577"></a><span>                                </span><span class="hs-comment">-- point, what its join arity is (or WOULD</span><span>
</span><a name="line-1578"></a><span>                                </span><span class="hs-comment">-- become). See Note [Rules and join points].</span><span>
</span><a name="line-1579"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span>
</span><a name="line-1580"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-1581"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- Each (non-built-in) rule</span><span>
</span><a name="line-1582"></a><span>                  </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Usage details for LHS</span><span>
</span><a name="line-1583"></a><span>                  </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Usage details for RHS</span><span>
</span><a name="line-1584"></a><a name="occAnalRules"><a href="OccurAnal.html#occAnalRules"><span class="hs-identifier">occAnalRules</span></a></a><span> </span><a name="local-6989586621684707154"><a href="#local-6989586621684707154"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707155"><a href="#local-6989586621684707155"><span class="hs-identifier">mb_expected_join_arity</span></a></a><span> </span><a name="local-6989586621684707156"><a href="#local-6989586621684707156"><span class="hs-identifier">rec_flag</span></a></a><span> </span><a name="local-6989586621684707157"><a href="#local-6989586621684707157"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1585"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707171"><span class="hs-identifier hs-var">rule</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707172"><span class="hs-identifier hs-var">lhs_uds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707173"><span class="hs-identifier hs-var">rhs_uds</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684707171"><a href="#local-6989586621684707171"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a><span> </span><a href="#local-6989586621684707157"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1586"></a><span>                               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707172"><a href="#local-6989586621684707172"><span class="hs-identifier">lhs_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707173"><a href="#local-6989586621684707173"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707158"><span class="hs-identifier hs-var">occ_anal_rule</span></a><span> </span><a href="#local-6989586621684707171"><span class="hs-identifier hs-var">rule</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1587"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1588"></a><span>    </span><a name="local-6989586621684707158"><a href="#local-6989586621684707158"><span class="hs-identifier">occ_anal_rule</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707160"><a href="#local-6989586621684707160"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707161"><a href="#local-6989586621684707161"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707162"><a href="#local-6989586621684707162"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1589"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707163"><span class="hs-identifier hs-var">lhs_uds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707167"><span class="hs-identifier hs-var">final_rhs_uds</span></a><span class="hs-special">)</span><span>
</span><a name="line-1590"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1591"></a><span>        </span><a name="local-6989586621684707163"><a href="#local-6989586621684707163"><span class="hs-identifier">lhs_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#addManyOccsSet"><span class="hs-identifier hs-var">addManyOccsSet</span></a><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1592"></a><span>                    </span><span class="hs-special">(</span><a href="CoreFVs.html#exprsFreeVars"><span class="hs-identifier hs-var">exprsFreeVars</span></a><span> </span><a href="#local-6989586621684707161"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delVarSetList"><span class="hs-identifier hs-var">delVarSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707160"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1593"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684707164"><a href="#local-6989586621684707164"><span class="hs-identifier">rhs_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707165"><a href="#local-6989586621684707165"><span class="hs-identifier">rhs_body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a><span> </span><a href="#local-6989586621684707162"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1594"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684707166"><a href="#local-6989586621684707166"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalRhs"><span class="hs-identifier hs-var">occAnalRhs</span></a><span> </span><a href="#local-6989586621684707154"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707156"><span class="hs-identifier hs-var">rec_flag</span></a><span> </span><a href="#local-6989586621684707157"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684707164"><span class="hs-identifier hs-var">rhs_bndrs</span></a><span> </span><a href="#local-6989586621684707165"><span class="hs-identifier hs-var">rhs_body</span></a><span>
</span><a name="line-1595"></a><span>                            </span><span class="hs-comment">-- Note [Rules are extra RHSs]</span><span>
</span><a name="line-1596"></a><span>                            </span><span class="hs-comment">-- Note [Rule dependency info]</span><span>
</span><a name="line-1597"></a><span>        </span><a name="local-6989586621684707167"><a href="#local-6989586621684707167"><span class="hs-identifier">final_rhs_uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707159"><span class="hs-identifier hs-var">adjust_tail_info</span></a><span> </span><a href="#local-6989586621684707161"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="OccurAnal.html#markAllMany"><span class="hs-identifier hs-var">markAllMany</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1598"></a><span>                          </span><span class="hs-special">(</span><a href="#local-6989586621684707166"><span class="hs-identifier hs-var">rhs_uds</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#delDetailsList"><span class="hs-identifier hs-var">delDetailsList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707160"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1599"></a><span>    </span><span class="hs-identifier">occ_anal_rule</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1600"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span class="hs-special">)</span><span>
</span><a name="line-1601"></a><span>
</span><a name="line-1602"></a><span>    </span><a name="local-6989586621684707159"><a href="#local-6989586621684707159"><span class="hs-identifier">adjust_tail_info</span></a></a><span> </span><a name="local-6989586621684707168"><a href="#local-6989586621684707168"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684707169"><a href="#local-6989586621684707169"><span class="hs-identifier">uds</span></a></a><span> </span><span class="hs-comment">-- see Note [Rules and join points]</span><span>
</span><a name="line-1603"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707155"><span class="hs-identifier hs-var">mb_expected_join_arity</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1604"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684707170"><a href="#local-6989586621684707170"><span class="hs-identifier">ar</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707168"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707170"><span class="hs-identifier hs-var">ar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707169"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-1605"></a><span>          </span><span class="hs-identifier">_</span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><a href="#local-6989586621684707169"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-1606"></a><span class="hs-comment">{- Note [Join point RHSs]
~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   x = e
   join j = Just x

We want to inline x into j right away, so we don't want to give
the join point a RhsCtxt (Trac #14137).  It's not a huge deal, because
the FloatIn pass knows to float into join point RHSs; and the simplifier
does not float things out of join point RHSs.  But it's a simple, cheap
thing to do.  See Trac #14137.

Note [Cascading inlines]
~~~~~~~~~~~~~~~~~~~~~~~~
By default we use an rhsCtxt for the RHS of a binding.  This tells the
occ anal n that it's looking at an RHS, which has an effect in
occAnalApp.  In particular, for constructor applications, it makes
the arguments appear to have NoOccInfo, so that we don't inline into
them. Thus    x = f y
              k = Just x
we do not want to inline x.

But there's a problem.  Consider
     x1 = a0 : []
     x2 = a1 : x1
     x3 = a2 : x2
     g  = f x3
First time round, it looks as if x1 and x2 occur as an arg of a
let-bound constructor ==&gt; give them a many-occurrence.
But then x3 is inlined (unconditionally as it happens) and
next time round, x2 will be, and the next time round x1 will be
Result: multiple simplifier iterations.  Sigh.

So, when analysing the RHS of x3 we notice that x3 will itself
definitely inline the next time round, and so we analyse x3's rhs in
an ordinary context, not rhsCtxt.  Hence the &quot;certainly_inline&quot; stuff.

Annoyingly, we have to approximate SimplUtils.preInlineUnconditionally.
If (a) the RHS is expandable (see isExpandableApp in occAnalApp), and
   (b) certainly_inline says &quot;yes&quot; when preInlineUnconditionally says &quot;no&quot;
then the simplifier iterates indefinitely:
        x = f y
        k = Just x   -- We decide that k is 'certainly_inline'
        v = ...k...  -- but preInlineUnconditionally doesn't inline it
inline ==&gt;
        k = Just (f y)
        v = ...k...
float ==&gt;
        x1 = f y
        k = Just x1
        v = ...k...

This is worse than the slow cascade, so we only want to say &quot;certainly_inline&quot;
if it really is certain.  Look at the note with preInlineUnconditionally
for the various clauses.


************************************************************************
*                                                                      *
                Expressions
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1669"></a><span>
</span><a name="line-1670"></a><span class="hs-identifier">occAnal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-1671"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1672"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- Gives info only about the &quot;interesting&quot; Ids</span><span>
</span><a name="line-1673"></a><span>            </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1674"></a><span>
</span><a name="line-1675"></a><a name="occAnal"><a href="OccurAnal.html#occAnal"><span class="hs-identifier">occAnal</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621684707174"><a href="#local-6989586621684707174"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span class="hs-special">,</span><span>         </span><a href="#local-6989586621684707174"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1676"></a><span class="hs-identifier">occAnal</span><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621684707175"><a href="#local-6989586621684707175"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span class="hs-special">,</span><span>         </span><a href="#local-6989586621684707175"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1677"></a><span class="hs-identifier">occAnal</span><span> </span><a name="local-6989586621684707176"><a href="#local-6989586621684707176"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707177"><a href="#local-6989586621684707177"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalApp"><span class="hs-identifier hs-var">occAnalApp</span></a><span> </span><a href="#local-6989586621684707176"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707177"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1678"></a><span>    </span><span class="hs-comment">-- At one stage, I gathered the idRuleVars for the variable here too,</span><span>
</span><a name="line-1679"></a><span>    </span><span class="hs-comment">-- which in a way is the right thing to do.</span><span>
</span><a name="line-1680"></a><span>    </span><span class="hs-comment">-- But that went wrong right after specialisation, when</span><span>
</span><a name="line-1681"></a><span>    </span><span class="hs-comment">-- the *occurrences* of the overloaded function didn't have any</span><span>
</span><a name="line-1682"></a><span>    </span><span class="hs-comment">-- rules in them, so the *specialised* versions looked as if they</span><span>
</span><a name="line-1683"></a><span>    </span><span class="hs-comment">-- weren't used at all.</span><span>
</span><a name="line-1684"></a><span>
</span><a name="line-1685"></a><span class="hs-identifier">occAnal</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684707178"><a href="#local-6989586621684707178"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1686"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#addManyOccsSet"><span class="hs-identifier hs-var">addManyOccsSet</span></a><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#coVarsOfCo"><span class="hs-identifier hs-var">coVarsOfCo</span></a><span> </span><a href="#local-6989586621684707178"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621684707178"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1687"></a><span>        </span><span class="hs-comment">-- See Note [Gather occurrences of coercion variables]</span><span>
</span><a name="line-1688"></a><span>
</span><a name="line-1689"></a><span class="hs-comment">{-
Note [Gather occurrences of coercion variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to gather info about what coercion variables appear, so that
we can sort them into the right place when doing dependency analysis.
-}</span><span>
</span><a name="line-1695"></a><span>
</span><a name="line-1696"></a><span class="hs-identifier">occAnal</span><span> </span><a name="local-6989586621684707179"><a href="#local-6989586621684707179"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684707180"><a href="#local-6989586621684707180"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621684707181"><a href="#local-6989586621684707181"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1697"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#SourceNote"><span class="hs-identifier hs-var">SourceNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707180"><span class="hs-identifier hs-var">tickish</span></a><span>
</span><a name="line-1698"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707182"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621684707180"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621684707183"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1699"></a><span>                  </span><span class="hs-comment">-- SourceNotes are best-effort; so we just proceed as usual.</span><span>
</span><a name="line-1700"></a><span>                  </span><span class="hs-comment">-- If we drop a tick due to the issues described below it's</span><span>
</span><a name="line-1701"></a><span>                  </span><span class="hs-comment">-- not the end of the world.</span><span>
</span><a name="line-1702"></a><span>
</span><a name="line-1703"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707180"><span class="hs-identifier hs-var">tickish</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>
</span><a name="line-1704"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><a href="#local-6989586621684707182"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621684707180"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621684707183"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1705"></a><span>
</span><a name="line-1706"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684707185"><a href="#local-6989586621684707185"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707180"><span class="hs-identifier hs-var">tickish</span></a><span>
</span><a name="line-1707"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707184"><span class="hs-identifier hs-var">usage_lam</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span> </span><a href="#local-6989586621684707185"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621684707180"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621684707183"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1708"></a><span>    </span><span class="hs-comment">-- never substitute for any of the Ids in a Breakpoint</span><span>
</span><a name="line-1709"></a><span>
</span><a name="line-1710"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1711"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707184"><span class="hs-identifier hs-var">usage_lam</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621684707180"><span class="hs-identifier hs-var">tickish</span></a><span> </span><a href="#local-6989586621684707183"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1712"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1713"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a name="local-6989586621684707182"><a href="#local-6989586621684707182"><span class="hs-identifier">usage</span></a></a><span class="hs-special">,</span><a name="local-6989586621684707183"><a href="#local-6989586621684707183"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707179"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707181"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1714"></a><span>    </span><span class="hs-comment">-- for a non-soft tick scope, we can inline lambdas only</span><span>
</span><a name="line-1715"></a><span>    </span><a name="local-6989586621684707184"><a href="#local-6989586621684707184"><span class="hs-identifier">usage_lam</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#markAllInsideLam"><span class="hs-identifier hs-var">markAllInsideLam</span></a><span> </span><a href="#local-6989586621684707182"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span>
</span><a name="line-1716"></a><span>                  </span><span class="hs-comment">-- TODO There may be ways to make ticks and join points play</span><span>
</span><a name="line-1717"></a><span>                  </span><span class="hs-comment">-- nicer together, but right now there are problems:</span><span>
</span><a name="line-1718"></a><span>                  </span><span class="hs-comment">--   let j x = ... in tick&lt;t&gt; (j 1)</span><span>
</span><a name="line-1719"></a><span>                  </span><span class="hs-comment">-- Making j a join point may cause the simplifier to drop t</span><span>
</span><a name="line-1720"></a><span>                  </span><span class="hs-comment">-- (if the tick is put into the continuation). So we don't</span><span>
</span><a name="line-1721"></a><span>                  </span><span class="hs-comment">-- count j 1 as a tail call.</span><span>
</span><a name="line-1722"></a><span>                  </span><span class="hs-comment">-- See #14242.</span><span>
</span><a name="line-1723"></a><span>
</span><a name="line-1724"></a><span class="hs-identifier">occAnal</span><span> </span><a name="local-6989586621684707186"><a href="#local-6989586621684707186"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684707187"><a href="#local-6989586621684707187"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684707188"><a href="#local-6989586621684707188"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1725"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707186"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707187"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707189"><a href="#local-6989586621684707189"><span class="hs-identifier">usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707190"><a href="#local-6989586621684707190"><span class="hs-identifier">expr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1726"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684707191"><a href="#local-6989586621684707191"><span class="hs-identifier">usage1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#zapDetailsIf"><span class="hs-identifier hs-var">zapDetailsIf</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#isRhsEnv"><span class="hs-identifier hs-var">isRhsEnv</span></a><span> </span><a href="#local-6989586621684707186"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707189"><span class="hs-identifier hs-var">usage</span></a><span>
</span><a name="line-1727"></a><span>          </span><span class="hs-comment">-- usage1: if we see let x = y `cast` co</span><span>
</span><a name="line-1728"></a><span>          </span><span class="hs-comment">-- then mark y as 'Many' so that we don't</span><span>
</span><a name="line-1729"></a><span>          </span><span class="hs-comment">-- immediately inline y again.</span><span>
</span><a name="line-1730"></a><span>        </span><a name="local-6989586621684707192"><a href="#local-6989586621684707192"><span class="hs-identifier">usage2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#addManyOccsSet"><span class="hs-identifier hs-var">addManyOccsSet</span></a><span> </span><a href="#local-6989586621684707191"><span class="hs-identifier hs-var">usage1</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#coVarsOfCo"><span class="hs-identifier hs-var">coVarsOfCo</span></a><span> </span><a href="#local-6989586621684707188"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1731"></a><span>          </span><span class="hs-comment">-- usage2: see Note [Gather occurrences of coercion variables]</span><span>
</span><a name="line-1732"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><a href="#local-6989586621684707192"><span class="hs-identifier hs-var">usage2</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a href="#local-6989586621684707190"><span class="hs-identifier hs-var">expr'</span></a><span> </span><a href="#local-6989586621684707188"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1733"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1734"></a><span>
</span><a name="line-1735"></a><span class="hs-identifier">occAnal</span><span> </span><a name="local-6989586621684707193"><a href="#local-6989586621684707193"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707194"><a href="#local-6989586621684707194"><span class="hs-identifier">app</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1736"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalApp"><span class="hs-identifier hs-var">occAnalApp</span></a><span> </span><a href="#local-6989586621684707193"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#collectArgsTicks"><span class="hs-identifier hs-var">collectArgsTicks</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-6989586621684707194"><span class="hs-identifier hs-var">app</span></a><span class="hs-special">)</span><span>
</span><a name="line-1737"></a><span>
</span><a name="line-1738"></a><span class="hs-comment">-- Ignore type variables altogether</span><span>
</span><a name="line-1739"></a><span class="hs-comment">--   (a) occurrences inside type lambdas only not marked as InsideLam</span><span>
</span><a name="line-1740"></a><span class="hs-comment">--   (b) type variables not in environment</span><span>
</span><a name="line-1741"></a><span>
</span><a name="line-1742"></a><span class="hs-identifier">occAnal</span><span> </span><a name="local-6989586621684707195"><a href="#local-6989586621684707195"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684707196"><a href="#local-6989586621684707196"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621684707197"><a href="#local-6989586621684707197"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1743"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684707196"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1744"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707195"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707197"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707198"><a href="#local-6989586621684707198"><span class="hs-identifier">body_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707199"><a href="#local-6989586621684707199"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1745"></a><span>    </span><span class="hs-special">(</span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><a href="#local-6989586621684707198"><span class="hs-identifier hs-var">body_usage</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-6989586621684707196"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684707199"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1746"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1747"></a><span>
</span><a name="line-1748"></a><span class="hs-comment">-- For value lambdas we do a special hack.  Consider</span><span>
</span><a name="line-1749"></a><span class="hs-comment">--      (\x. \y. ...x...)</span><span>
</span><a name="line-1750"></a><span class="hs-comment">-- If we did nothing, x is used inside the \y, so would be marked</span><span>
</span><a name="line-1751"></a><span class="hs-comment">-- as dangerous to dup.  But in the common case where the abstraction</span><span>
</span><a name="line-1752"></a><span class="hs-comment">-- is applied to two arguments this is over-pessimistic.</span><span>
</span><a name="line-1753"></a><span class="hs-comment">-- So instead, we just mark each binder with its occurrence</span><span>
</span><a name="line-1754"></a><span class="hs-comment">-- info in the *body* of the multiple lambda.</span><span>
</span><a name="line-1755"></a><span class="hs-comment">-- Then, the simplifier is careful when partially applying lambdas.</span><span>
</span><a name="line-1756"></a><span>
</span><a name="line-1757"></a><span class="hs-identifier">occAnal</span><span> </span><a name="local-6989586621684707200"><a href="#local-6989586621684707200"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707201"><a href="#local-6989586621684707201"><span class="hs-identifier">expr</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1758"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnalLamOrRhs"><span class="hs-identifier hs-var">occAnalLamOrRhs</span></a><span> </span><a href="#local-6989586621684707200"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707202"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621684707203"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707204"><a href="#local-6989586621684707204"><span class="hs-identifier">usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707205"><a href="#local-6989586621684707205"><span class="hs-identifier">tagged_binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707206"><a href="#local-6989586621684707206"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1759"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1760"></a><span>        </span><a name="local-6989586621684707207"><a href="#local-6989586621684707207"><span class="hs-identifier">expr'</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621684707205"><span class="hs-identifier hs-var">tagged_binders</span></a><span> </span><a href="#local-6989586621684707206"><span class="hs-identifier hs-var">body'</span></a><span>
</span><a name="line-1761"></a><span>        </span><a name="local-6989586621684707208"><a href="#local-6989586621684707208"><span class="hs-identifier">usage1</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><a href="#local-6989586621684707204"><span class="hs-identifier hs-var">usage</span></a><span>
</span><a name="line-1762"></a><span>        </span><a name="local-6989586621684707209"><a href="#local-6989586621684707209"><span class="hs-identifier">one_shot_gp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="Id.html#isOneShotBndr"><span class="hs-identifier hs-var">isOneShotBndr</span></a><span> </span><a href="#local-6989586621684707205"><span class="hs-identifier hs-var">tagged_binders</span></a><span>
</span><a name="line-1763"></a><span>        </span><a name="local-6989586621684707210"><a href="#local-6989586621684707210"><span class="hs-identifier">final_usage</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707209"><span class="hs-identifier hs-var">one_shot_gp</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707208"><span class="hs-identifier hs-var">usage1</span></a><span>
</span><a name="line-1764"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllInsideLam"><span class="hs-identifier hs-var">markAllInsideLam</span></a><span> </span><a href="#local-6989586621684707208"><span class="hs-identifier hs-var">usage1</span></a><span>
</span><a name="line-1765"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-1766"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684707210"><span class="hs-identifier hs-var">final_usage</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707207"><span class="hs-identifier hs-var">expr'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1767"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1768"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707202"><a href="#local-6989586621684707202"><span class="hs-identifier">binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707203"><a href="#local-6989586621684707203"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a><span> </span><a href="#local-6989586621684707201"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1769"></a><span>
</span><a name="line-1770"></a><span class="hs-identifier">occAnal</span><span> </span><a name="local-6989586621684707211"><a href="#local-6989586621684707211"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621684707212"><a href="#local-6989586621684707212"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684707213"><a href="#local-6989586621684707213"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684707214"><a href="#local-6989586621684707214"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684707215"><a href="#local-6989586621684707215"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1771"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707218"><span class="hs-identifier hs-var">occ_anal_scrut</span></a><span> </span><a href="#local-6989586621684707212"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621684707215"><span class="hs-identifier hs-var">alts</span></a><span>     </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707227"><a href="#local-6989586621684707227"><span class="hs-identifier">scrut_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707228"><a href="#local-6989586621684707228"><span class="hs-identifier">scrut'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1772"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Util.html#mapAndUnzip"><span class="hs-identifier hs-var">mapAndUnzip</span></a><span> </span><a href="#local-6989586621684707217"><span class="hs-identifier hs-var">occ_anal_alt</span></a><span> </span><a href="#local-6989586621684707215"><span class="hs-identifier hs-var">alts</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707229"><a href="#local-6989586621684707229"><span class="hs-identifier">alts_usage_s</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707230"><a href="#local-6989586621684707230"><span class="hs-identifier">alts'</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1773"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1774"></a><span>        </span><a name="local-6989586621684707231"><a href="#local-6989586621684707231"><span class="hs-identifier">alts_usage</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="OccurAnal.html#orUDs"><span class="hs-identifier hs-var">orUDs</span></a><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span> </span><a href="#local-6989586621684707229"><span class="hs-identifier hs-var">alts_usage_s</span></a><span>
</span><a name="line-1775"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684707232"><a href="#local-6989586621684707232"><span class="hs-identifier">alts_usage1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707233"><a href="#local-6989586621684707233"><span class="hs-identifier">tagged_bndr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#tagLamBinder"><span class="hs-identifier hs-var">tagLamBinder</span></a><span> </span><a href="#local-6989586621684707231"><span class="hs-identifier hs-var">alts_usage</span></a><span> </span><a href="#local-6989586621684707213"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1776"></a><span>        </span><a name="local-6989586621684707234"><a href="#local-6989586621684707234"><span class="hs-identifier">total_usage</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><a href="#local-6989586621684707227"><span class="hs-identifier hs-var">scrut_usage</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707232"><span class="hs-identifier hs-var">alts_usage1</span></a><span>
</span><a name="line-1777"></a><span>                        </span><span class="hs-comment">-- Alts can have tail calls, but the scrutinee can't</span><span>
</span><a name="line-1778"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-1779"></a><span>    </span><a href="#local-6989586621684707234"><span class="hs-identifier hs-var">total_usage</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707234"><span class="hs-identifier hs-var">total_usage</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a href="#local-6989586621684707228"><span class="hs-identifier hs-var">scrut'</span></a><span> </span><a href="#local-6989586621684707233"><span class="hs-identifier hs-var">tagged_bndr</span></a><span> </span><a href="#local-6989586621684707214"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684707230"><span class="hs-identifier hs-var">alts'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1780"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1781"></a><span>    </span><a name="local-6989586621684707216"><a href="#local-6989586621684707216"><span class="hs-identifier">alt_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#mkAltEnv"><span class="hs-identifier hs-var">mkAltEnv</span></a><span> </span><a href="#local-6989586621684707211"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707212"><span class="hs-identifier hs-var">scrut</span></a><span> </span><a href="#local-6989586621684707213"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1782"></a><span>    </span><a name="local-6989586621684707217"><a href="#local-6989586621684707217"><span class="hs-identifier">occ_anal_alt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalAlt"><span class="hs-identifier hs-var">occAnalAlt</span></a><span> </span><a href="#local-6989586621684707216"><span class="hs-identifier hs-var">alt_env</span></a><span>
</span><a name="line-1783"></a><span>
</span><a name="line-1784"></a><span>    </span><a name="local-6989586621684707218"><a href="#local-6989586621684707218"><span class="hs-identifier">occ_anal_scrut</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684707219"><a href="#local-6989586621684707219"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707220"><a href="#local-6989586621684707220"><span class="hs-identifier">alt1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684707221"><a href="#local-6989586621684707221"><span class="hs-identifier">other_alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1785"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684707221"><span class="hs-identifier hs-var">other_alts</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#isDefaultAlt"><span class="hs-identifier hs-var">isDefaultAlt</span></a><span> </span><a href="#local-6989586621684707220"><span class="hs-identifier hs-var">alt1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1786"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#mkOneOcc"><span class="hs-identifier hs-var">mkOneOcc</span></a><span> </span><a href="#local-6989586621684707211"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707219"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684707219"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1787"></a><span>            </span><span class="hs-comment">-- The 'True' says that the variable occurs in an interesting</span><span>
</span><a name="line-1788"></a><span>            </span><span class="hs-comment">-- context; the case has at least one non-default alternative</span><span>
</span><a name="line-1789"></a><span>    </span><span class="hs-identifier">occ_anal_scrut</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684707222"><a href="#local-6989586621684707222"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684707223"><a href="#local-6989586621684707223"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684707224"><a href="#local-6989586621684707224"><span class="hs-identifier">alts</span></a></a><span>
</span><a name="line-1790"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707222"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>
</span><a name="line-1791"></a><span>          </span><span class="hs-comment">-- No reason to not look through all ticks here, but only</span><span>
</span><a name="line-1792"></a><span>          </span><span class="hs-comment">-- for soft-scoped ticks we can do so without having to</span><span>
</span><a name="line-1793"></a><span>          </span><span class="hs-comment">-- update returned occurance info (see occAnal)</span><span>
</span><a name="line-1794"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621684707222"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684707218"><span class="hs-identifier hs-var">occ_anal_scrut</span></a><span> </span><a href="#local-6989586621684707223"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684707224"><span class="hs-identifier hs-var">alts</span></a><span>
</span><a name="line-1795"></a><span>
</span><a name="line-1796"></a><span>    </span><span class="hs-identifier">occ_anal_scrut</span><span> </span><a name="local-6989586621684707225"><a href="#local-6989586621684707225"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684707226"><a href="#local-6989586621684707226"><span class="hs-identifier">_alts</span></a></a><span>
</span><a name="line-1797"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#vanillaCtxt"><span class="hs-identifier hs-var">vanillaCtxt</span></a><span> </span><a href="#local-6989586621684707211"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707225"><span class="hs-identifier hs-var">scrut</span></a><span>    </span><span class="hs-comment">-- No need for rhsCtxt</span><span>
</span><a name="line-1798"></a><span>
</span><a name="line-1799"></a><span class="hs-identifier">occAnal</span><span> </span><a name="local-6989586621684707235"><a href="#local-6989586621684707235"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621684707236"><a href="#local-6989586621684707236"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621684707237"><a href="#local-6989586621684707237"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1800"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707235"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707237"><span class="hs-identifier hs-var">body</span></a><span>                </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707238"><a href="#local-6989586621684707238"><span class="hs-identifier">body_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707239"><a href="#local-6989586621684707239"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1801"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnalBind"><span class="hs-identifier hs-var">occAnalBind</span></a><span> </span><a href="#local-6989586621684707235"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span>
</span><a name="line-1802"></a><span>                     </span><a href="OccurAnal.html#noImpRuleEdges"><span class="hs-identifier hs-var">noImpRuleEdges</span></a><span> </span><a href="#local-6989586621684707236"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-1803"></a><span>                     </span><a href="#local-6989586621684707238"><span class="hs-identifier hs-var">body_usage</span></a><span>          </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707240"><a href="#local-6989586621684707240"><span class="hs-identifier">final_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707241"><a href="#local-6989586621684707241"><span class="hs-identifier">new_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1804"></a><span>       </span><span class="hs-special">(</span><a href="#local-6989586621684707240"><span class="hs-identifier hs-var">final_usage</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkLets"><span class="hs-identifier hs-var">mkLets</span></a><span> </span><a href="#local-6989586621684707241"><span class="hs-identifier hs-var">new_binds</span></a><span> </span><a href="#local-6989586621684707239"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1805"></a><span>
</span><a name="line-1806"></a><span class="hs-identifier">occAnalArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#OneShots"><span class="hs-identifier hs-type">OneShots</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1807"></a><a name="occAnalArgs"><a href="OccurAnal.html#occAnalArgs"><span class="hs-identifier">occAnalArgs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1808"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1809"></a><span>
</span><a name="line-1810"></a><span class="hs-identifier">occAnalArgs</span><span> </span><a name="local-6989586621684707242"><a href="#local-6989586621684707242"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707243"><a href="#local-6989586621684707243"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684707244"><a href="#local-6989586621684707244"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684707245"><a href="#local-6989586621684707245"><span class="hs-identifier">one_shots</span></a></a><span>
</span><a name="line-1811"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a><span> </span><a href="#local-6989586621684707243"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1812"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnalArgs"><span class="hs-identifier hs-var">occAnalArgs</span></a><span> </span><a href="#local-6989586621684707242"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707244"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684707245"><span class="hs-identifier hs-var">one_shots</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707246"><a href="#local-6989586621684707246"><span class="hs-identifier">uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707247"><a href="#local-6989586621684707247"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1813"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684707246"><span class="hs-identifier hs-var">uds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707243"><span class="hs-identifier hs-var">arg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684707247"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1814"></a><span>
</span><a name="line-1815"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1816"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#argCtxt"><span class="hs-identifier hs-var">argCtxt</span></a><span> </span><a href="#local-6989586621684707242"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707245"><span class="hs-identifier hs-var">one_shots</span></a><span>           </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707248"><a href="#local-6989586621684707248"><span class="hs-identifier">arg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707249"><a href="#local-6989586621684707249"><span class="hs-identifier">one_shots'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1817"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707248"><span class="hs-identifier hs-var">arg_env</span></a><span> </span><a href="#local-6989586621684707243"><span class="hs-identifier hs-var">arg</span></a><span>             </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707250"><a href="#local-6989586621684707250"><span class="hs-identifier">uds1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707251"><a href="#local-6989586621684707251"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1818"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnalArgs"><span class="hs-identifier hs-var">occAnalArgs</span></a><span> </span><a href="#local-6989586621684707242"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707244"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684707249"><span class="hs-identifier hs-var">one_shots'</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707252"><a href="#local-6989586621684707252"><span class="hs-identifier">uds2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707253"><a href="#local-6989586621684707253"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1819"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684707250"><span class="hs-identifier hs-var">uds1</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707252"><span class="hs-identifier hs-var">uds2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707251"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684707253"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-1820"></a><span>
</span><a name="line-1821"></a><span class="hs-comment">{-
Applications are dealt with specially because we want
the &quot;build hack&quot; to work.

Note [Arguments of let-bound constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    f x = let y = expensive x in
          let z = (True,y) in
          (case z of {(p,q)-&gt;q}, case z of {(p,q)-&gt;q})
We feel free to duplicate the WHNF (True,y), but that means
that y may be duplicated thereby.

If we aren't careful we duplicate the (expensive x) call!
Constructors are rather like lambdas in this way.
-}</span><span>
</span><a name="line-1837"></a><span>
</span><a name="line-1838"></a><span class="hs-identifier">occAnalApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-1839"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1840"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1841"></a><a name="occAnalApp"><a href="OccurAnal.html#occAnalApp"><span class="hs-identifier">occAnalApp</span></a></a><span> </span><a name="local-6989586621684707254"><a href="#local-6989586621684707254"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684707255"><a href="#local-6989586621684707255"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707256"><a href="#local-6989586621684707256"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707257"><a href="#local-6989586621684707257"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1842"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621684707257"><span class="hs-identifier hs-var">ticks</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707258"><span class="hs-identifier hs-var">uds</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684707255"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707260"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1843"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707258"><span class="hs-identifier hs-var">uds</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><a href="#local-6989586621684707257"><span class="hs-identifier hs-var">ticks</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684707255"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707260"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1844"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1845"></a><span>    </span><a name="local-6989586621684707258"><a href="#local-6989586621684707258"><span class="hs-identifier">uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707264"><span class="hs-identifier hs-var">fun_uds</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707261"><span class="hs-identifier hs-var">final_args_uds</span></a><span>
</span><a name="line-1846"></a><span>
</span><a name="line-1847"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a name="local-6989586621684707259"><a href="#local-6989586621684707259"><span class="hs-identifier">args_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707260"><a href="#local-6989586621684707260"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalArgs"><span class="hs-identifier hs-var">occAnalArgs</span></a><span> </span><a href="#local-6989586621684707254"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707256"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684707266"><span class="hs-identifier hs-var">one_shots</span></a><span>
</span><a name="line-1848"></a><span>    </span><span class="hs-glyph">!</span><a name="local-6989586621684707261"><a href="#local-6989586621684707261"><span class="hs-identifier">final_args_uds</span></a></a><span>
</span><a name="line-1849"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="OccurAnal.html#isRhsEnv"><span class="hs-identifier hs-var">isRhsEnv</span></a><span> </span><a href="#local-6989586621684707254"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684707265"><span class="hs-identifier hs-var">is_exp</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1850"></a><span>                                  </span><a href="OccurAnal.html#markAllInsideLam"><span class="hs-identifier hs-var">markAllInsideLam</span></a><span> </span><a href="#local-6989586621684707259"><span class="hs-identifier hs-var">args_uds</span></a><span>
</span><a name="line-1851"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><a href="#local-6989586621684707259"><span class="hs-identifier hs-var">args_uds</span></a><span>
</span><a name="line-1852"></a><span>       </span><span class="hs-comment">-- We mark the free vars of the argument of a constructor or PAP</span><span>
</span><a name="line-1853"></a><span>       </span><span class="hs-comment">-- as &quot;inside-lambda&quot;, if it is the RHS of a let(rec).</span><span>
</span><a name="line-1854"></a><span>       </span><span class="hs-comment">-- This means that nothing gets inlined into a constructor or PAP</span><span>
</span><a name="line-1855"></a><span>       </span><span class="hs-comment">-- argument position, which is what we want.  Typically those</span><span>
</span><a name="line-1856"></a><span>       </span><span class="hs-comment">-- constructor arguments are just variables, or trivial expressions.</span><span>
</span><a name="line-1857"></a><span>       </span><span class="hs-comment">-- We use inside-lam because it's like eta-expanding the PAP.</span><span>
</span><a name="line-1858"></a><span>       </span><span class="hs-comment">--</span><span>
</span><a name="line-1859"></a><span>       </span><span class="hs-comment">-- This is the *whole point* of the isRhsEnv predicate</span><span>
</span><a name="line-1860"></a><span>       </span><span class="hs-comment">-- See Note [Arguments of let-bound constructors]</span><span>
</span><a name="line-1861"></a><span>
</span><a name="line-1862"></a><span>    </span><a name="local-6989586621684707262"><a href="#local-6989586621684707262"><span class="hs-identifier">n_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a><span> </span><a href="#local-6989586621684707256"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1863"></a><span>    </span><a name="local-6989586621684707263"><a href="#local-6989586621684707263"><span class="hs-identifier">n_args</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621684707256"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1864"></a><span>    </span><a name="local-6989586621684707264"><a href="#local-6989586621684707264"><span class="hs-identifier">fun_uds</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#mkOneOcc"><span class="hs-identifier hs-var">mkOneOcc</span></a><span> </span><a href="#local-6989586621684707254"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707255"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707262"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707263"><span class="hs-identifier hs-var">n_args</span></a><span>
</span><a name="line-1865"></a><span>    </span><a name="local-6989586621684707265"><a href="#local-6989586621684707265"><span class="hs-identifier">is_exp</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#isExpandableApp"><span class="hs-identifier hs-var">isExpandableApp</span></a><span> </span><a href="#local-6989586621684707255"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621684707262"><span class="hs-identifier hs-var">n_val_args</span></a><span>
</span><a name="line-1866"></a><span>        </span><span class="hs-comment">-- See Note [CONLIKE pragma] in BasicTypes</span><span>
</span><a name="line-1867"></a><span>        </span><span class="hs-comment">-- The definition of is_exp should match that in Simplify.prepareRhs</span><span>
</span><a name="line-1868"></a><span>
</span><a name="line-1869"></a><span>    </span><a name="local-6989586621684707266"><a href="#local-6989586621684707266"><span class="hs-identifier">one_shots</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#argsOneShots"><span class="hs-identifier hs-var">argsOneShots</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idStrictness"><span class="hs-identifier hs-var">idStrictness</span></a><span> </span><a href="#local-6989586621684707255"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707267"><span class="hs-identifier hs-var">guaranteed_val_args</span></a><span>
</span><a name="line-1870"></a><span>    </span><a name="local-6989586621684707267"><a href="#local-6989586621684707267"><span class="hs-identifier">guaranteed_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707262"><span class="hs-identifier hs-var">n_val_args</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><a href="BasicTypes.html#isOneShotInfo"><span class="hs-identifier hs-var">isOneShotInfo</span></a><span>
</span><a name="line-1871"></a><span>                                                         </span><span class="hs-special">(</span><span class="hs-identifier">occ_one_shots</span><span> </span><a href="#local-6989586621684707254"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1872"></a><span>        </span><span class="hs-comment">-- See Note [Sources of one-shot information], bullet point A']</span><span>
</span><a name="line-1873"></a><span>
</span><a name="line-1874"></a><span class="hs-identifier">occAnalApp</span><span> </span><a name="local-6989586621684707268"><a href="#local-6989586621684707268"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707269"><a href="#local-6989586621684707269"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707270"><a href="#local-6989586621684707270"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707271"><a href="#local-6989586621684707271"><span class="hs-identifier">ticks</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1875"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707272"><span class="hs-identifier hs-var">fun_uds</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707274"><span class="hs-identifier hs-var">args_uds</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1876"></a><span>     </span><a href="CoreUtils.html#mkTicks"><span class="hs-identifier hs-var">mkTicks</span></a><span> </span><a href="#local-6989586621684707271"><span class="hs-identifier hs-var">ticks</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span> </span><a href="#local-6989586621684707273"><span class="hs-identifier hs-var">fun'</span></a><span> </span><a href="#local-6989586621684707275"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1877"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1878"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a name="local-6989586621684707272"><a href="#local-6989586621684707272"><span class="hs-identifier">fun_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707273"><a href="#local-6989586621684707273"><span class="hs-identifier">fun'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#addAppCtxt"><span class="hs-identifier hs-var">addAppCtxt</span></a><span> </span><a href="#local-6989586621684707268"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707270"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707269"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-1879"></a><span>        </span><span class="hs-comment">-- The addAppCtxt is a bit cunning.  One iteration of the simplifier</span><span>
</span><a name="line-1880"></a><span>        </span><span class="hs-comment">-- often leaves behind beta redexs like</span><span>
</span><a name="line-1881"></a><span>        </span><span class="hs-comment">--      (\x y -&gt; e) a1 a2</span><span>
</span><a name="line-1882"></a><span>        </span><span class="hs-comment">-- Here we would like to mark x,y as one-shot, and treat the whole</span><span>
</span><a name="line-1883"></a><span>        </span><span class="hs-comment">-- thing much like a let.  We do this by pushing some True items</span><span>
</span><a name="line-1884"></a><span>        </span><span class="hs-comment">-- onto the context stack.</span><span>
</span><a name="line-1885"></a><span>    </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a name="local-6989586621684707274"><a href="#local-6989586621684707274"><span class="hs-identifier">args_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707275"><a href="#local-6989586621684707275"><span class="hs-identifier">args'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnalArgs"><span class="hs-identifier hs-var">occAnalArgs</span></a><span> </span><a href="#local-6989586621684707268"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707270"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1886"></a><span>
</span><a name="line-1887"></a><span class="hs-identifier">zapDetailsIf</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>              </span><span class="hs-comment">-- If this is true</span><span>
</span><a name="line-1888"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>      </span><span class="hs-comment">-- Then do zapDetails on this</span><span>
</span><a name="line-1889"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-1890"></a><a name="zapDetailsIf"><a href="OccurAnal.html#zapDetailsIf"><span class="hs-identifier">zapDetailsIf</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><a name="local-6989586621684707276"><a href="#local-6989586621684707276"><span class="hs-identifier">uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#zapDetails"><span class="hs-identifier hs-var">zapDetails</span></a><span> </span><a href="#local-6989586621684707276"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-1891"></a><span class="hs-identifier">zapDetailsIf</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621684707277"><a href="#local-6989586621684707277"><span class="hs-identifier">uds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707277"><span class="hs-identifier hs-var">uds</span></a><span>
</span><a name="line-1892"></a><span>
</span><a name="line-1893"></a><span class="hs-comment">{-
Note [Sources of one-shot information]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The occurrence analyser obtains one-shot-lambda information from two sources:

A:  Saturated applications:  eg   f e1 .. en

    In general, given a call (f e1 .. en) we can propagate one-shot info from
    f's strictness signature into e1 .. en, but /only/ if n is enough to
    saturate the strictness signature. A strictness signature like

          f :: C1(C1(L))LS

    means that *if f is applied to three arguments* then it will guarantee to
    call its first argument at most once, and to call the result of that at
    most once. But if f has fewer than three arguments, all bets are off; e.g.

          map (f (\x y. expensive) e2) xs

    Here the \x y abstraction may be called many times (once for each element of
    xs) so we should not mark x and y as one-shot. But if it was

          map (f (\x y. expensive) 3 2) xs

    then the first argument of f will be called at most once.

    The one-shot info, derived from f's strictness signature, is
    computed by 'argsOneShots', called in occAnalApp.

A': Non-obviously saturated applications: eg    build (f (\x y -&gt; expensive))
    where f is as above.

    In this case, f is only manifestly applied to one argument, so it does not
    look saturated. So by the previous point, we should not use its strictness
    signature to learn about the one-shotness of \x y. But in this case we can:
    build is fully applied, so we may use its strictness signature; and from
    that we learn that build calls its argument with two arguments *at most once*.

    So there is really only one call to f, and it will have three arguments. In
    that sense, f is saturated, and we may proceed as described above.

    Hence the computation of 'guaranteed_val_args' in occAnalApp, using
    '(occ_one_shots env)'.  See also Trac #13227, comment:9

B:  Let-bindings:  eg   let f = \c. let ... in \n -&gt; blah
                        in (build f, build f)

    Propagate one-shot info from the demanand-info on 'f' to the
    lambdas in its RHS (which may not be syntactically at the top)

    This information must have come from a previous run of the demanand
    analyser.

Previously, the demand analyser would *also* set the one-shot information, but
that code was buggy (see #11770), so doing it only in on place, namely here, is
saner.

Note [OneShots]
~~~~~~~~~~~~~~~
When analysing an expression, the occ_one_shots argument contains information
about how the function is being used. The length of the list indicates
how many arguments will eventually be passed to the analysed expression,
and the OneShotInfo indicates whether this application is once or multiple times.

Example:

 Context of f                occ_one_shots when analysing f

 f 1 2                       [OneShot, OneShot]
 map (f 1)                   [OneShot, NoOneShotInfo]
 build f                     [OneShot, OneShot]
 f 1 2 `seq` f 2 1           [NoOneShotInfo, OneShot]

Note [Binders in case alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
    case x of y { (a,b) -&gt; f y }
We treat 'a', 'b' as dead, because they don't physically occur in the
case alternative.  (Indeed, a variable is dead iff it doesn't occur in
its scope in the output of OccAnal.)  It really helps to know when
binders are unused.  See esp the call to isDeadBinder in
Simplify.mkDupableAlt

In this example, though, the Simplifier will bring 'a' and 'b' back to
life, beause it binds 'y' to (a,b) (imagine got inlined and
scrutinised y).
-}</span><span>
</span><a name="line-1980"></a><span>
</span><a name="line-1981"></a><span class="hs-identifier">occAnalLamOrRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1982"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1983"></a><a name="occAnalLamOrRhs"><a href="OccurAnal.html#occAnalLamOrRhs"><span class="hs-identifier">occAnalLamOrRhs</span></a></a><span> </span><a name="local-6989586621684707278"><a href="#local-6989586621684707278"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684707279"><a href="#local-6989586621684707279"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1984"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707278"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707279"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707280"><a href="#local-6989586621684707280"><span class="hs-identifier">body_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707281"><a href="#local-6989586621684707281"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707280"><span class="hs-identifier hs-var">body_usage</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707281"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1985"></a><span>      </span><span class="hs-comment">-- RHS of thunk or nullary join point</span><span>
</span><a name="line-1986"></a><span class="hs-identifier">occAnalLamOrRhs</span><span> </span><a name="local-6989586621684707282"><a href="#local-6989586621684707282"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707283"><a href="#local-6989586621684707283"><span class="hs-identifier">bndr</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684707284"><a href="#local-6989586621684707284"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684707285"><a href="#local-6989586621684707285"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1987"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684707283"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-1988"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Important: Keep the environment so that we don't inline into an RHS like</span><span>
</span><a name="line-1989"></a><span>    </span><span class="hs-comment">--   \(@ x) -&gt; C @x (f @x)</span><span>
</span><a name="line-1990"></a><span>    </span><span class="hs-comment">-- (see the beginning of Note [Cascading inlines]).</span><span>
</span><a name="line-1991"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnalLamOrRhs"><span class="hs-identifier hs-var">occAnalLamOrRhs</span></a><span> </span><a href="#local-6989586621684707282"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707284"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684707285"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1992"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621684707286"><a href="#local-6989586621684707286"><span class="hs-identifier">body_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707287"><a href="#local-6989586621684707287"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707288"><a href="#local-6989586621684707288"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707286"><span class="hs-identifier hs-var">body_usage</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707283"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684707287"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707288"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1993"></a><span class="hs-identifier">occAnalLamOrRhs</span><span> </span><a name="local-6989586621684707289"><a href="#local-6989586621684707289"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707290"><a href="#local-6989586621684707290"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621684707291"><a href="#local-6989586621684707291"><span class="hs-identifier">body</span></a></a><span>
</span><a name="line-1994"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707292"><span class="hs-identifier hs-var">env_body</span></a><span> </span><a href="#local-6989586621684707291"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707294"><a href="#local-6989586621684707294"><span class="hs-identifier">body_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707295"><a href="#local-6989586621684707295"><span class="hs-identifier">body'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1995"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-1996"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684707296"><a href="#local-6989586621684707296"><span class="hs-identifier">final_usage</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707297"><a href="#local-6989586621684707297"><span class="hs-identifier">tagged_binders</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#tagLamBinders"><span class="hs-identifier hs-var">tagLamBinders</span></a><span> </span><a href="#local-6989586621684707294"><span class="hs-identifier hs-var">body_usage</span></a><span> </span><a href="#local-6989586621684707293"><span class="hs-identifier hs-var">binders'</span></a><span>
</span><a name="line-1997"></a><span>                      </span><span class="hs-comment">-- Use binders' to put one-shot info on the lambdas</span><span>
</span><a name="line-1998"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-1999"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684707296"><span class="hs-identifier hs-var">final_usage</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707297"><span class="hs-identifier hs-var">tagged_binders</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707295"><span class="hs-identifier hs-var">body'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2000"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2001"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707292"><a href="#local-6989586621684707292"><span class="hs-identifier">env_body</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707293"><a href="#local-6989586621684707293"><span class="hs-identifier">binders'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#oneShotGroup"><span class="hs-identifier hs-var">oneShotGroup</span></a><span> </span><a href="#local-6989586621684707289"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707290"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-2002"></a><span>
</span><a name="line-2003"></a><span class="hs-identifier">occAnalAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2004"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span>
</span><a name="line-2005"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span> </span><a href="OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-2006"></a><a name="occAnalAlt"><a href="OccurAnal.html#occAnalAlt"><span class="hs-identifier">occAnalAlt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707298"><a href="#local-6989586621684707298"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707299"><a href="#local-6989586621684707299"><span class="hs-identifier">scrut_bind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707300"><a href="#local-6989586621684707300"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707301"><a href="#local-6989586621684707301"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707302"><a href="#local-6989586621684707302"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2007"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707298"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707302"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707303"><a href="#local-6989586621684707303"><span class="hs-identifier">rhs_usage1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707304"><a href="#local-6989586621684707304"><span class="hs-identifier">rhs1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2008"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-2009"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621684707305"><a href="#local-6989586621684707305"><span class="hs-identifier">alt_usg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707306"><a href="#local-6989586621684707306"><span class="hs-identifier">tagged_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#tagLamBinders"><span class="hs-identifier hs-var">tagLamBinders</span></a><span> </span><a href="#local-6989586621684707303"><span class="hs-identifier hs-var">rhs_usage1</span></a><span> </span><a href="#local-6989586621684707301"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2010"></a><span>                                </span><span class="hs-comment">-- See Note [Binders in case alternatives]</span><span>
</span><a name="line-2011"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621684707307"><a href="#local-6989586621684707307"><span class="hs-identifier">alt_usg'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707308"><a href="#local-6989586621684707308"><span class="hs-identifier">rhs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#wrapAltRHS"><span class="hs-identifier hs-var">wrapAltRHS</span></a><span> </span><a href="#local-6989586621684707298"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707299"><span class="hs-identifier hs-var">scrut_bind</span></a><span> </span><a href="#local-6989586621684707305"><span class="hs-identifier hs-var">alt_usg</span></a><span> </span><a href="#local-6989586621684707306"><span class="hs-identifier hs-var">tagged_bndrs</span></a><span> </span><a href="#local-6989586621684707304"><span class="hs-identifier hs-var">rhs1</span></a><span>
</span><a name="line-2012"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-2013"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684707307"><span class="hs-identifier hs-var">alt_usg'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707300"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707306"><span class="hs-identifier hs-var">tagged_bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707308"><span class="hs-identifier hs-var">rhs2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2014"></a><span>
</span><a name="line-2015"></a><span class="hs-identifier">wrapAltRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-2016"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- proxy mapping generated by mkAltEnv</span><span>
</span><a name="line-2017"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>              </span><span class="hs-comment">-- usage for entire alt (p -&gt; rhs)</span><span>
</span><a name="line-2018"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span>                     </span><span class="hs-comment">-- alt binders</span><span>
</span><a name="line-2019"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>                  </span><span class="hs-comment">-- alt RHS</span><span>
</span><a name="line-2020"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2021"></a><a name="wrapAltRHS"><a href="OccurAnal.html#wrapAltRHS"><span class="hs-identifier">wrapAltRHS</span></a></a><span> </span><a name="local-6989586621684707309"><a href="#local-6989586621684707309"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707310"><a href="#local-6989586621684707310"><span class="hs-identifier">scrut_var</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707311"><a href="#local-6989586621684707311"><span class="hs-identifier">let_rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684707312"><a href="#local-6989586621684707312"><span class="hs-identifier">alt_usg</span></a></a><span> </span><a name="local-6989586621684707313"><a href="#local-6989586621684707313"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684707314"><a href="#local-6989586621684707314"><span class="hs-identifier">alt_rhs</span></a></a><span>
</span><a name="line-2022"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">occ_binder_swap</span><span> </span><a href="#local-6989586621684707309"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2023"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707310"><span class="hs-identifier hs-var">scrut_var</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#usedIn"><span class="hs-identifier hs-var">usedIn</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707312"><span class="hs-identifier hs-var">alt_usg</span></a><span> </span><span class="hs-comment">-- bndrs are not be present in alt_usg so this</span><span>
</span><a name="line-2024"></a><span>                               </span><span class="hs-comment">-- handles condition (a) in Note [Binder swap]</span><span>
</span><a name="line-2025"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684707315"><span class="hs-identifier hs-var">captured</span></a><span>               </span><span class="hs-comment">-- See condition (b) in Note [Binder swap]</span><span>
</span><a name="line-2026"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684707318"><span class="hs-identifier hs-var">alt_usg'</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707316"><span class="hs-identifier hs-var">let_rhs_usg</span></a><span>
</span><a name="line-2027"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684707319"><span class="hs-identifier hs-var">tagged_scrut_var</span></a><span> </span><a href="#local-6989586621684707317"><span class="hs-identifier hs-var">let_rhs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707314"><span class="hs-identifier hs-var">alt_rhs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2028"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2029"></a><span>    </span><a name="local-6989586621684707315"><a href="#local-6989586621684707315"><span class="hs-identifier">captured</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="OccurAnal.html#usedIn"><span class="hs-identifier hs-var">usedIn</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707316"><span class="hs-identifier hs-var">let_rhs_usg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707313"><span class="hs-identifier hs-var">bndrs</span></a><span>  </span><span class="hs-comment">-- Check condition (b)</span><span>
</span><a name="line-2030"></a><span>
</span><a name="line-2031"></a><span>    </span><span class="hs-comment">-- The rhs of the let may include coercion variables</span><span>
</span><a name="line-2032"></a><span>    </span><span class="hs-comment">-- if the scrutinee was a cast, so we must gather their</span><span>
</span><a name="line-2033"></a><span>    </span><span class="hs-comment">-- usage. See Note [Gather occurrences of coercion variables]</span><span>
</span><a name="line-2034"></a><span>    </span><span class="hs-comment">-- Moreover, the rhs of the let may mention the case-binder, and</span><span>
</span><a name="line-2035"></a><span>    </span><span class="hs-comment">-- we want to gather its occ-info as well</span><span>
</span><a name="line-2036"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707316"><a href="#local-6989586621684707316"><span class="hs-identifier">let_rhs_usg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707317"><a href="#local-6989586621684707317"><span class="hs-identifier">let_rhs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occAnal"><span class="hs-identifier hs-var">occAnal</span></a><span> </span><a href="#local-6989586621684707309"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707311"><span class="hs-identifier hs-var">let_rhs</span></a><span>
</span><a name="line-2037"></a><span>
</span><a name="line-2038"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707318"><a href="#local-6989586621684707318"><span class="hs-identifier">alt_usg'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707319"><a href="#local-6989586621684707319"><span class="hs-identifier">tagged_scrut_var</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#tagLamBinder"><span class="hs-identifier hs-var">tagLamBinder</span></a><span> </span><a href="#local-6989586621684707312"><span class="hs-identifier hs-var">alt_usg</span></a><span> </span><a href="#local-6989586621684707310"><span class="hs-identifier hs-var">scrut_var</span></a><span>
</span><a name="line-2039"></a><span>
</span><a name="line-2040"></a><span class="hs-identifier">wrapAltRHS</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684707320"><a href="#local-6989586621684707320"><span class="hs-identifier">alt_usg</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684707321"><a href="#local-6989586621684707321"><span class="hs-identifier">alt_rhs</span></a></a><span>
</span><a name="line-2041"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707320"><span class="hs-identifier hs-var">alt_usg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707321"><span class="hs-identifier hs-var">alt_rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2042"></a><span>
</span><a name="line-2043"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                    OccEnv
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2050"></a><span>
</span><a name="line-2051"></a><span class="hs-keyword">data</span><span> </span><a name="OccEnv"><a href="OccurAnal.html#OccEnv"><span class="hs-identifier">OccEnv</span></a></a><span>
</span><a name="line-2052"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="OccEnv"><a href="OccurAnal.html#OccEnv"><span class="hs-identifier">OccEnv</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="occ_encl"><a href="OccurAnal.html#occ_encl"><span class="hs-identifier">occ_encl</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="OccurAnal.html#OccEncl"><span class="hs-identifier hs-type">OccEncl</span></a><span>      </span><span class="hs-comment">-- Enclosing context information</span><span>
</span><a name="line-2053"></a><span>           </span><span class="hs-special">,</span><span> </span><a name="occ_one_shots"><a href="OccurAnal.html#occ_one_shots"><span class="hs-identifier">occ_one_shots</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="OccurAnal.html#OneShots"><span class="hs-identifier hs-type">OneShots</span></a><span>     </span><span class="hs-comment">-- See Note [OneShots]</span><span>
</span><a name="line-2054"></a><span>           </span><span class="hs-special">,</span><span> </span><a name="occ_gbl_scrut"><a href="OccurAnal.html#occ_gbl_scrut"><span class="hs-identifier">occ_gbl_scrut</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#GlobalScruts"><span class="hs-identifier hs-type">GlobalScruts</span></a><span>
</span><a name="line-2055"></a><span>
</span><a name="line-2056"></a><span>           </span><span class="hs-special">,</span><span> </span><a name="occ_unf_act"><a href="OccurAnal.html#occ_unf_act"><span class="hs-identifier">occ_unf_act</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>   </span><span class="hs-comment">-- Which Id unfoldings are active</span><span>
</span><a name="line-2057"></a><span>
</span><a name="line-2058"></a><span>           </span><span class="hs-special">,</span><span> </span><a name="occ_rule_act"><a href="OccurAnal.html#occ_rule_act"><span class="hs-identifier">occ_rule_act</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>   </span><span class="hs-comment">-- Which rules are active</span><span>
</span><a name="line-2059"></a><span>             </span><span class="hs-comment">-- See Note [Finding rule RHS free vars]</span><span>
</span><a name="line-2060"></a><span>
</span><a name="line-2061"></a><span>           </span><span class="hs-special">,</span><span> </span><a name="occ_binder_swap"><a href="OccurAnal.html#occ_binder_swap"><span class="hs-identifier">occ_binder_swap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- enable the binder_swap</span><span>
</span><a name="line-2062"></a><span>             </span><span class="hs-comment">-- See CorePrep Note [Dead code in CorePrep]</span><span>
</span><a name="line-2063"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-2064"></a><span>
</span><a name="line-2065"></a><span class="hs-keyword">type</span><span> </span><a name="GlobalScruts"><a href="OccurAnal.html#GlobalScruts"><span class="hs-identifier">GlobalScruts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#IdSet"><span class="hs-identifier hs-type">IdSet</span></a><span>   </span><span class="hs-comment">-- See Note [Binder swap on GlobalId scrutinees]</span><span>
</span><a name="line-2066"></a><span>
</span><a name="line-2067"></a><span class="hs-comment">-----------------------------</span><span>
</span><a name="line-2068"></a><span class="hs-comment">-- OccEncl is used to control whether to inline into constructor arguments</span><span>
</span><a name="line-2069"></a><span class="hs-comment">-- For example:</span><span>
</span><a name="line-2070"></a><span class="hs-comment">--      x = (p,q)               -- Don't inline p or q</span><span>
</span><a name="line-2071"></a><span class="hs-comment">--      y = /\a -&gt; (p a, q a)   -- Still don't inline p or q</span><span>
</span><a name="line-2072"></a><span class="hs-comment">--      z = f (p,q)             -- Do inline p,q; it may make a rule fire</span><span>
</span><a name="line-2073"></a><span class="hs-comment">-- So OccEncl tells enough about the context to know what to do when</span><span>
</span><a name="line-2074"></a><span class="hs-comment">-- we encounter a constructor application or PAP.</span><span>
</span><a name="line-2075"></a><span>
</span><a name="line-2076"></a><span class="hs-keyword">data</span><span> </span><a name="OccEncl"><a href="OccurAnal.html#OccEncl"><span class="hs-identifier">OccEncl</span></a></a><span>
</span><a name="line-2077"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="OccRhs"><a href="OccurAnal.html#OccRhs"><span class="hs-identifier">OccRhs</span></a></a><span>              </span><span class="hs-comment">-- RHS of let(rec), albeit perhaps inside a type lambda</span><span>
</span><a name="line-2078"></a><span>                        </span><span class="hs-comment">-- Don't inline into constructor args here</span><span>
</span><a name="line-2079"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="OccVanilla"><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier">OccVanilla</span></a></a><span>          </span><span class="hs-comment">-- Argument of function, body of lambda, scruintee of case etc.</span><span>
</span><a name="line-2080"></a><span>                        </span><span class="hs-comment">-- Do inline into constructor args here</span><span>
</span><a name="line-2081"></a><span>
</span><a name="line-2082"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="OccurAnal.html#OccEncl"><span class="hs-identifier hs-type">OccEncl</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2083"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="OccurAnal.html#OccRhs"><span class="hs-identifier hs-var">OccRhs</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;occRhs&quot;</span><span>
</span><a name="line-2084"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;occVanilla&quot;</span><span>
</span><a name="line-2085"></a><span>
</span><a name="line-2086"></a><span class="hs-comment">-- See note [OneShots]</span><span>
</span><a name="line-2087"></a><span class="hs-keyword">type</span><span> </span><a name="OneShots"><a href="OccurAnal.html#OneShots"><span class="hs-identifier">OneShots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="BasicTypes.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-2088"></a><span>
</span><a name="line-2089"></a><span class="hs-identifier">initOccEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-2090"></a><a name="initOccEnv"><a href="OccurAnal.html#initOccEnv"><span class="hs-identifier">initOccEnv</span></a></a><span>
</span><a name="line-2091"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-var">OccEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span>
</span><a name="line-2092"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2093"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_gbl_scrut</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-2094"></a><span>                 </span><span class="hs-comment">-- To be conservative, we say that all</span><span>
</span><a name="line-2095"></a><span>                 </span><span class="hs-comment">-- inlines and rules are active</span><span>
</span><a name="line-2096"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_unf_act</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2097"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_rule_act</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2098"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_binder_swap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2099"></a><span>
</span><a name="line-2100"></a><span class="hs-identifier">vanillaCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-2101"></a><a name="vanillaCtxt"><a href="OccurAnal.html#vanillaCtxt"><span class="hs-identifier">vanillaCtxt</span></a></a><span> </span><a name="local-6989586621684707322"><a href="#local-6989586621684707322"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707322"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2102"></a><span>
</span><a name="line-2103"></a><span class="hs-identifier">rhsCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-2104"></a><a name="rhsCtxt"><a href="OccurAnal.html#rhsCtxt"><span class="hs-identifier">rhsCtxt</span></a></a><span> </span><a name="local-6989586621684707323"><a href="#local-6989586621684707323"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707323"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccRhs"><span class="hs-identifier hs-var">OccRhs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2105"></a><span>
</span><a name="line-2106"></a><span class="hs-identifier">argCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#OneShots"><span class="hs-identifier hs-type">OneShots</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#OneShots"><span class="hs-identifier hs-type">OneShots</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2107"></a><a name="argCtxt"><a href="OccurAnal.html#argCtxt"><span class="hs-identifier">argCtxt</span></a></a><span> </span><a name="local-6989586621684707324"><a href="#local-6989586621684707324"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2108"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707324"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2109"></a><span class="hs-identifier">argCtxt</span><span> </span><a name="local-6989586621684707325"><a href="#local-6989586621684707325"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707326"><a href="#local-6989586621684707326"><span class="hs-identifier">one_shots</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684707327"><a href="#local-6989586621684707327"><span class="hs-identifier">one_shots_s</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2110"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707325"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707326"><span class="hs-identifier hs-var">one_shots</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707327"><span class="hs-identifier hs-var">one_shots_s</span></a><span class="hs-special">)</span><span>
</span><a name="line-2111"></a><span>
</span><a name="line-2112"></a><span class="hs-identifier">isRhsEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2113"></a><a name="isRhsEnv"><a href="OccurAnal.html#isRhsEnv"><span class="hs-identifier">isRhsEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-var">OccEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccRhs"><span class="hs-identifier hs-var">OccRhs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2114"></a><span class="hs-identifier">isRhsEnv</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-var">OccEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2115"></a><span>
</span><a name="line-2116"></a><span class="hs-identifier">oneShotGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span>
</span><a name="line-2117"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-2118"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2119"></a><span>        </span><span class="hs-comment">-- The result binders have one-shot-ness set that they might not have had originally.</span><span>
</span><a name="line-2120"></a><span>        </span><span class="hs-comment">-- This happens in (build (\c n -&gt; e)).  Here the occurrence analyser</span><span>
</span><a name="line-2121"></a><span>        </span><span class="hs-comment">-- linearity context knows that c,n are one-shot, and it records that fact in</span><span>
</span><a name="line-2122"></a><span>        </span><span class="hs-comment">-- the binder. This is useful to guide subsequent float-in/float-out tranformations</span><span>
</span><a name="line-2123"></a><span>
</span><a name="line-2124"></a><a name="oneShotGroup"><a href="OccurAnal.html#oneShotGroup"><span class="hs-identifier">oneShotGroup</span></a></a><span> </span><a name="local-6989586621684707328"><a href="#local-6989586621684707328"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-var">OccEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707329"><a href="#local-6989586621684707329"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684707330"><a href="#local-6989586621684707330"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-2125"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707331"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684707329"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621684707330"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2126"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2127"></a><span>    </span><a name="local-6989586621684707331"><a href="#local-6989586621684707331"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684707332"><a href="#local-6989586621684707332"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684707333"><a href="#local-6989586621684707333"><span class="hs-identifier">rev_bndrs</span></a></a><span>
</span><a name="line-2128"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684707328"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707332"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2129"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684707333"><span class="hs-identifier hs-var">rev_bndrs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2130"></a><span>
</span><a name="line-2131"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621684707334"><a href="#local-6989586621684707334"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684707335"><a href="#local-6989586621684707335"><span class="hs-identifier">rev_bndrs</span></a></a><span>
</span><a name="line-2132"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684707328"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2133"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684707335"><span class="hs-identifier hs-var">rev_bndrs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684707334"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2134"></a><span>
</span><a name="line-2135"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684707336"><a href="#local-6989586621684707336"><span class="hs-identifier">ctxt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684707337"><a href="#local-6989586621684707337"><span class="hs-identifier">one_shot</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684707338"><a href="#local-6989586621684707338"><span class="hs-identifier">ctxt'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684707339"><a href="#local-6989586621684707339"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684707340"><a href="#local-6989586621684707340"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684707341"><a href="#local-6989586621684707341"><span class="hs-identifier">rev_bndrs</span></a></a><span>
</span><a name="line-2136"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684707339"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707331"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684707338"><span class="hs-identifier hs-var">ctxt'</span></a><span> </span><a href="#local-6989586621684707340"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707342"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684707341"><span class="hs-identifier hs-var">rev_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2137"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707331"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684707336"><span class="hs-identifier hs-var">ctxt</span></a><span>  </span><a href="#local-6989586621684707340"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707339"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684707341"><span class="hs-identifier hs-var">rev_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2138"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2139"></a><span>        </span><a name="local-6989586621684707342"><a href="#local-6989586621684707342"><span class="hs-identifier">bndr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#updOneShotInfo"><span class="hs-identifier hs-var">updOneShotInfo</span></a><span> </span><a href="#local-6989586621684707339"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621684707337"><span class="hs-identifier hs-var">one_shot</span></a><span>
</span><a name="line-2140"></a><span>               </span><span class="hs-comment">-- Use updOneShotInfo, not setOneShotInfo, as pre-existing</span><span>
</span><a name="line-2141"></a><span>               </span><span class="hs-comment">-- one-shot info might be better than what we can infer, e.g.</span><span>
</span><a name="line-2142"></a><span>               </span><span class="hs-comment">-- due to explicit use of the magic 'oneShot' function.</span><span>
</span><a name="line-2143"></a><span>               </span><span class="hs-comment">-- See Note [The oneShot function]</span><span>
</span><a name="line-2144"></a><span>
</span><a name="line-2145"></a><span>
</span><a name="line-2146"></a><span class="hs-identifier">markJoinOneShots</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BasicTypes.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span>
</span><a name="line-2147"></a><span class="hs-comment">-- Mark the lambdas of a non-recursive join point as one-shot.</span><span>
</span><a name="line-2148"></a><span class="hs-comment">-- This is good to prevent gratuitous float-out etc</span><span>
</span><a name="line-2149"></a><a name="markJoinOneShots"><a href="OccurAnal.html#markJoinOneShots"><span class="hs-identifier">markJoinOneShots</span></a></a><span> </span><a name="local-6989586621684707343"><a href="#local-6989586621684707343"><span class="hs-identifier">mb_join_arity</span></a></a><span> </span><a name="local-6989586621684707344"><a href="#local-6989586621684707344"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-2150"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707343"><span class="hs-identifier hs-var">mb_join_arity</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2151"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707344"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2152"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684707351"><a href="#local-6989586621684707351"><span class="hs-identifier">n</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707345"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684707351"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621684707344"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2153"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2154"></a><span>   </span><a name="local-6989586621684707345"><a href="#local-6989586621684707345"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621684707346"><a href="#local-6989586621684707346"><span class="hs-identifier">bndrs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707346"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2155"></a><span>   </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- This can legitimately happen.</span><span>
</span><a name="line-2156"></a><span>                    </span><span class="hs-comment">-- e.g.    let j = case ... in j True</span><span>
</span><a name="line-2157"></a><span>                    </span><span class="hs-comment">-- This will become an arity-1 join point after the</span><span>
</span><a name="line-2158"></a><span>                    </span><span class="hs-comment">-- simplifier has eta-expanded it; but it may not have</span><span>
</span><a name="line-2159"></a><span>                    </span><span class="hs-comment">-- enough lambdas /yet/. (Lint checks that JoinIds do</span><span>
</span><a name="line-2160"></a><span>                    </span><span class="hs-comment">-- have enough lambdas.)</span><span>
</span><a name="line-2161"></a><span>   </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684707347"><a href="#local-6989586621684707347"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707348"><a href="#local-6989586621684707348"><span class="hs-identifier">b</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684707349"><a href="#local-6989586621684707349"><span class="hs-identifier">bs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707350"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684707345"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707347"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707349"><span class="hs-identifier hs-var">bs</span></a><span>
</span><a name="line-2162"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-2163"></a><span>       </span><a name="local-6989586621684707350"><a href="#local-6989586621684707350"><span class="hs-identifier">b'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684707348"><span class="hs-identifier hs-var">b</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setOneShotLambda"><span class="hs-identifier hs-var">setOneShotLambda</span></a><span> </span><a href="#local-6989586621684707348"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-2164"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707348"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-2165"></a><span>
</span><a name="line-2166"></a><span class="hs-identifier">addAppCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span>
</span><a name="line-2167"></a><a name="addAppCtxt"><a href="OccurAnal.html#addAppCtxt"><span class="hs-identifier">addAppCtxt</span></a></a><span> </span><a name="local-6989586621684707352"><a href="#local-6989586621684707352"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-var">OccEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707353"><a href="#local-6989586621684707353"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684707354"><a href="#local-6989586621684707354"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2168"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707352"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_one_shots</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a><span> </span><a href="#local-6989586621684707354"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="BasicTypes.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684707353"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2169"></a><span>
</span><a name="line-2170"></a><span class="hs-identifier">transClosureFV</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UniqFM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqFM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-2171"></a><span class="hs-comment">-- If (f,g), (g,h) are in the input, then (f,h) is in the output</span><span>
</span><a name="line-2172"></a><span class="hs-comment">--                                   as well as (f,g), (g,h)</span><span>
</span><a name="line-2173"></a><a name="transClosureFV"><a href="OccurAnal.html#transClosureFV"><span class="hs-identifier">transClosureFV</span></a></a><span> </span><a name="local-6989586621684707355"><a href="#local-6989586621684707355"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-2174"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707356"><span class="hs-identifier hs-var">no_change</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707355"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2175"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#transClosureFV"><span class="hs-identifier hs-var">transClosureFV</span></a><span> </span><span class="hs-special">(</span><a href="UniqFM.html#listToUFM"><span class="hs-identifier hs-var">listToUFM</span></a><span> </span><a href="#local-6989586621684707357"><span class="hs-identifier hs-var">new_fv_list</span></a><span class="hs-special">)</span><span>
</span><a name="line-2176"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2177"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707356"><a href="#local-6989586621684707356"><span class="hs-identifier">no_change</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707357"><a href="#local-6989586621684707357"><span class="hs-identifier">new_fv_list</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621684707358"><span class="hs-identifier hs-var">bump</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><a href="UniqFM.html#nonDetUFMToList"><span class="hs-identifier hs-var">nonDetUFMToList</span></a><span> </span><a href="#local-6989586621684707355"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2178"></a><span>      </span><span class="hs-comment">-- It's OK to use nonDetUFMToList here because we'll forget the</span><span>
</span><a name="line-2179"></a><span>      </span><span class="hs-comment">-- ordering by creating a new set with listToUFM</span><span>
</span><a name="line-2180"></a><span>    </span><a name="local-6989586621684707358"><a href="#local-6989586621684707358"><span class="hs-identifier">bump</span></a></a><span> </span><a name="local-6989586621684707359"><a href="#local-6989586621684707359"><span class="hs-identifier">no_change</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707360"><a href="#local-6989586621684707360"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621684707361"><a href="#local-6989586621684707361"><span class="hs-identifier">fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2181"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707363"><span class="hs-identifier hs-var">no_change_here</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707359"><span class="hs-identifier hs-var">no_change</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707360"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621684707361"><span class="hs-identifier hs-var">fvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2182"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">False</span><span class="hs-special">,</span><span>     </span><span class="hs-special">(</span><a href="#local-6989586621684707360"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621684707362"><span class="hs-identifier hs-var">new_fvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2183"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2184"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684707362"><a href="#local-6989586621684707362"><span class="hs-identifier">new_fvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707363"><a href="#local-6989586621684707363"><span class="hs-identifier">no_change_here</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#extendFvs"><span class="hs-identifier hs-var">extendFvs</span></a><span> </span><a href="#local-6989586621684707355"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707361"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-2185"></a><span>
</span><a name="line-2186"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-2187"></a><span class="hs-identifier">extendFvs_</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UniqFM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-2188"></a><a name="extendFvs_"><a href="OccurAnal.html#extendFvs_"><span class="hs-identifier">extendFvs_</span></a></a><span> </span><a name="local-6989586621684707364"><a href="#local-6989586621684707364"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707365"><a href="#local-6989586621684707365"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#extendFvs"><span class="hs-identifier hs-var">extendFvs</span></a><span> </span><a href="#local-6989586621684707364"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684707365"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- Discard the Bool flag</span><span>
</span><a name="line-2189"></a><span>
</span><a name="line-2190"></a><span class="hs-identifier">extendFvs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UniqFM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-2191"></a><span class="hs-comment">-- (extendFVs env s) returns</span><span>
</span><a name="line-2192"></a><span class="hs-comment">--     (s `union` env(s), env(s) `subset` s)</span><span>
</span><a name="line-2193"></a><a name="extendFvs"><a href="OccurAnal.html#extendFvs"><span class="hs-identifier">extendFvs</span></a></a><span> </span><a name="local-6989586621684707366"><a href="#local-6989586621684707366"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707367"><a href="#local-6989586621684707367"><span class="hs-identifier">s</span></a></a><span>
</span><a name="line-2194"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="UniqFM.html#isNullUFM"><span class="hs-identifier hs-var">isNullUFM</span></a><span> </span><a href="#local-6989586621684707366"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707367"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>
</span><a name="line-2196"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2197"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707367"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707368"><span class="hs-identifier hs-var">extras</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707368"><span class="hs-identifier hs-var">extras</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#subVarSet"><span class="hs-identifier hs-var">subVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707367"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-2198"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2199"></a><span>    </span><span class="hs-identifier">extras</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>    </span><span class="hs-comment">-- env(s)</span><span>
</span><a name="line-2200"></a><span>    </span><a name="local-6989586621684707368"><a href="#local-6989586621684707368"><span class="hs-identifier">extras</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#nonDetFoldUFM"><span class="hs-identifier hs-var">nonDetFoldUFM</span></a><span> </span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2201"></a><span>      </span><span class="hs-comment">-- It's OK to use nonDetFoldUFM here because unionVarSet commutes</span><span>
</span><a name="line-2202"></a><span>             </span><a href="UniqFM.html#intersectUFM_C"><span class="hs-identifier hs-var">intersectUFM_C</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684707369"><a href="#local-6989586621684707369"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707369"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707366"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="UniqSet.html#getUniqSet"><span class="hs-identifier hs-var">getUniqSet</span></a><span> </span><a href="#local-6989586621684707367"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-2203"></a><span>
</span><a name="line-2204"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                    Binder swap
*                                                                      *
************************************************************************

Note [Binder swap]
~~~~~~~~~~~~~~~~~~
We do these two transformations right here:

 (1)   case x of b { pi -&gt; ri }
    ==&gt;
      case x of b { pi -&gt; let x=b in ri }

 (2)  case (x |&gt; co) of b { pi -&gt; ri }
    ==&gt;
      case (x |&gt; co) of b { pi -&gt; let x = b |&gt; sym co in ri }

    Why (2)?  See Note [Case of cast]

In both cases, in a particular alternative (pi -&gt; ri), we only
add the binding if
  (a) x occurs free in (pi -&gt; ri)
        (ie it occurs in ri, but is not bound in pi)
  (b) the pi does not bind b (or the free vars of co)
We need (a) and (b) for the inserted binding to be correct.

For the alternatives where we inject the binding, we can transfer
all x's OccInfo to b.  And that is the point.

Notice that
  * The deliberate shadowing of 'x'.
  * That (a) rapidly becomes false, so no bindings are injected.

The reason for doing these transformations here is because it allows
us to adjust the OccInfo for 'x' and 'b' as we go.

  * Suppose the only occurrences of 'x' are the scrutinee and in the
    ri; then this transformation makes it occur just once, and hence
    get inlined right away.

  * If we do this in the Simplifier, we don't know whether 'x' is used
    in ri, so we are forced to pessimistically zap b's OccInfo even
    though it is typically dead (ie neither it nor x appear in the
    ri).  There's nothing actually wrong with zapping it, except that
    it's kind of nice to know which variables are dead.  My nose
    tells me to keep this information as robustly as possible.

The Maybe (Id,CoreExpr) passed to occAnalAlt is the extra let-binding
{x=b}; it's Nothing if the binder-swap doesn't happen.

There is a danger though.  Consider
      let v = x +# y
      in case (f v) of w -&gt; ...v...v...
And suppose that (f v) expands to just v.  Then we'd like to
use 'w' instead of 'v' in the alternative.  But it may be too
late; we may have substituted the (cheap) x+#y for v in the
same simplifier pass that reduced (f v) to v.

I think this is just too bad.  CSE will recover some of it.

Note [Case of cast]
~~~~~~~~~~~~~~~~~~~
Consider        case (x `cast` co) of b { I# -&gt;
                ... (case (x `cast` co) of {...}) ...
We'd like to eliminate the inner case.  That is the motivation for
equation (2) in Note [Binder swap].  When we get to the inner case, we
inline x, cancel the casts, and away we go.

Note [Binder swap on GlobalId scrutinees]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the scrutinee is a GlobalId we must take care in two ways

 i) In order to *know* whether 'x' occurs free in the RHS, we need its
    occurrence info. BUT, we don't gather occurrence info for
    GlobalIds.  That's the reason for the (small) occ_gbl_scrut env in
    OccEnv is for: it says &quot;gather occurrence info for these&quot;.

 ii) We must call localiseId on 'x' first, in case it's a GlobalId, or
     has an External Name. See, for example, SimplEnv Note [Global Ids in
     the substitution].

Note [Zap case binders in proxy bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
From the original
     case x of cb(dead) { p -&gt; ...x... }
we will get
     case x of cb(live) { p -&gt; let x = cb in ...x... }

Core Lint never expects to find an *occurrence* of an Id marked
as Dead, so we must zap the OccInfo on cb before making the
binding x = cb.  See Trac #5028.

NB: the OccInfo on /occurrences/ really doesn't matter much; the simplifier
doesn't use it. So this is only to satisfy the perhpas-over-picky Lint.

Historical note [no-case-of-case]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We *used* to suppress the binder-swap in case expressions when
-fno-case-of-case is on.  Old remarks:
    &quot;This happens in the first simplifier pass,
    and enhances full laziness.  Here's the bad case:
            f = \ y -&gt; ...(case x of I# v -&gt; ...(case x of ...) ... )
    If we eliminate the inner case, we trap it inside the I# v -&gt; arm,
    which might prevent some full laziness happening.  I've seen this
    in action in spectral/cichelli/Prog.hs:
             [(m,n) | m &lt;- [1..max], n &lt;- [1..max]]
    Hence the check for NoCaseOfCase.&quot;
However, now the full-laziness pass itself reverses the binder-swap, so this
check is no longer necessary.

Historical note [Suppressing the case binder-swap]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This old note describes a problem that is also fixed by doing the
binder-swap in OccAnal:

    There is another situation when it might make sense to suppress the
    case-expression binde-swap. If we have

        case x of w1 { DEFAULT -&gt; case x of w2 { A -&gt; e1; B -&gt; e2 }
                       ...other cases .... }

    We'll perform the binder-swap for the outer case, giving

        case x of w1 { DEFAULT -&gt; case w1 of w2 { A -&gt; e1; B -&gt; e2 }
                       ...other cases .... }

    But there is no point in doing it for the inner case, because w1 can't
    be inlined anyway.  Furthermore, doing the case-swapping involves
    zapping w2's occurrence info (see paragraphs that follow), and that
    forces us to bind w2 when doing case merging.  So we get

        case x of w1 { A -&gt; let w2 = w1 in e1
                       B -&gt; let w2 = w1 in e2
                       ...other cases .... }

    This is plain silly in the common case where w2 is dead.

    Even so, I can't see a good way to implement this idea.  I tried
    not doing the binder-swap if the scrutinee was already evaluated
    but that failed big-time:

            data T = MkT !Int

            case v of w  { MkT x -&gt;
            case x of x1 { I# y1 -&gt;
            case x of x2 { I# y2 -&gt; ...

    Notice that because MkT is strict, x is marked &quot;evaluated&quot;.  But to
    eliminate the last case, we must either make sure that x (as well as
    x1) has unfolding MkT y1.  The straightforward thing to do is to do
    the binder-swap.  So this whole note is a no-op.

It's fixed by doing the binder-swap in OccAnal because we can do the
binder-swap unconditionally and still get occurrence analysis
information right.
-}</span><span>
</span><a name="line-2362"></a><span>
</span><a name="line-2363"></a><span class="hs-identifier">mkAltEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2364"></a><span class="hs-comment">-- Does three things: a) makes the occ_one_shots = OccVanilla</span><span>
</span><a name="line-2365"></a><span class="hs-comment">--                    b) extends the GlobalScruts if possible</span><span>
</span><a name="line-2366"></a><span class="hs-comment">--                    c) returns a proxy mapping, binding the scrutinee</span><span>
</span><a name="line-2367"></a><span class="hs-comment">--                       to the case binder, if possible</span><span>
</span><a name="line-2368"></a><a name="mkAltEnv"><a href="OccurAnal.html#mkAltEnv"><span class="hs-identifier">mkAltEnv</span></a></a><span> </span><a name="local-6989586621684707370"><a href="#local-6989586621684707370"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-var">OccEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_gbl_scrut</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707371"><a href="#local-6989586621684707371"><span class="hs-identifier">pe</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684707372"><a href="#local-6989586621684707372"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684707373"><a href="#local-6989586621684707373"><span class="hs-identifier">case_bndr</span></a></a><span>
</span><a name="line-2369"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreUtils.html#stripTicksTopE"><span class="hs-identifier hs-var">stripTicksTopE</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707372"><span class="hs-identifier hs-var">scrut</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2370"></a><span>      </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684707380"><a href="#local-6989586621684707380"><span class="hs-identifier">v</span></a></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707374"><span class="hs-identifier hs-var">add_scrut</span></a><span> </span><a href="#local-6989586621684707380"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684707375"><span class="hs-identifier hs-var">case_bndr'</span></a><span>
</span><a name="line-2371"></a><span>      </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684707381"><a href="#local-6989586621684707381"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684707382"><a href="#local-6989586621684707382"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707374"><span class="hs-identifier hs-var">add_scrut</span></a><span> </span><a href="#local-6989586621684707381"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a href="#local-6989586621684707375"><span class="hs-identifier hs-var">case_bndr'</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621684707382"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2372"></a><span>                          </span><span class="hs-comment">-- See Note [Case of cast]</span><span>
</span><a name="line-2373"></a><span>      </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707370"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-2374"></a><span>
</span><a name="line-2375"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2376"></a><span>    </span><a name="local-6989586621684707374"><a href="#local-6989586621684707374"><span class="hs-identifier">add_scrut</span></a></a><span> </span><a name="local-6989586621684707377"><a href="#local-6989586621684707377"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684707378"><a href="#local-6989586621684707378"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684707370"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_encl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccVanilla"><span class="hs-identifier hs-var">OccVanilla</span></a><span>
</span><a name="line-2377"></a><span>                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_gbl_scrut</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707371"><span class="hs-identifier hs-var">pe</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#extendVarSet"><span class="hs-identifier hs-var">extendVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707377"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2378"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707376"><span class="hs-identifier hs-var">localise</span></a><span> </span><a href="#local-6989586621684707377"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707378"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2379"></a><span>
</span><a name="line-2380"></a><span>    </span><a name="local-6989586621684707375"><a href="#local-6989586621684707375"><span class="hs-identifier">case_bndr'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#zapIdOccInfo"><span class="hs-identifier hs-var">zapIdOccInfo</span></a><span> </span><a href="#local-6989586621684707373"><span class="hs-identifier hs-var">case_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2381"></a><span>                   </span><span class="hs-comment">-- See Note [Zap case binders in proxy bindings]</span><span>
</span><a name="line-2382"></a><span>
</span><a name="line-2383"></a><span>    </span><span class="hs-comment">-- Localise the scrut_var before shadowing it; we're making a</span><span>
</span><a name="line-2384"></a><span>    </span><span class="hs-comment">-- new binding for it, and it might have an External Name, or</span><span>
</span><a name="line-2385"></a><span>    </span><span class="hs-comment">-- even be a GlobalId; Note [Binder swap on GlobalId scrutinees]</span><span>
</span><a name="line-2386"></a><span>    </span><span class="hs-comment">-- Also we don't want any INLINE or NOINLINE pragmas!</span><span>
</span><a name="line-2387"></a><span>    </span><a name="local-6989586621684707376"><a href="#local-6989586621684707376"><span class="hs-identifier">localise</span></a></a><span> </span><a name="local-6989586621684707379"><a href="#local-6989586621684707379"><span class="hs-identifier">scrut_var</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#mkLocalIdOrCoVar"><span class="hs-identifier hs-var">mkLocalIdOrCoVar</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#localiseName"><span class="hs-identifier hs-var">localiseName</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-6989586621684707379"><span class="hs-identifier hs-var">scrut_var</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2388"></a><span>                                          </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621684707379"><span class="hs-identifier hs-var">scrut_var</span></a><span class="hs-special">)</span><span>
</span><a name="line-2389"></a><span>
</span><a name="line-2390"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection[OccurAnal-types]{OccEnv}
*                                                                      *
************************************************************************

Note [UsageDetails and zapping]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

On many occasions, we must modify all gathered occurrence data at once. For
instance, all occurrences underneath a (non-one-shot) lambda set the
'occ_in_lam' flag to become 'True'. We could use 'mapVarEnv' to do this, but
that takes O(n) time and we will do this often---in particular, there are many
places where tail calls are not allowed, and each of these causes all variables
to get marked with 'NoTailCallInfo'.

Instead of relying on `mapVarEnv`, then, we carry three 'IdEnv's around along
with the 'OccInfoEnv'. Each of these extra environments is a &quot;zapped set&quot;
recording which variables have been zapped in some way. Zapping all occurrence
info then simply means setting the corresponding zapped set to the whole
'OccInfoEnv', a fast O(1) operation.
-}</span><span>
</span><a name="line-2413"></a><span>
</span><a name="line-2414"></a><span class="hs-keyword">type</span><span> </span><a name="OccInfoEnv"><a href="OccurAnal.html#OccInfoEnv"><span class="hs-identifier">OccInfoEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-comment">-- A finite map from ids to their usage</span><span>
</span><a name="line-2415"></a><span>                </span><span class="hs-comment">-- INVARIANT: never IAmDead</span><span>
</span><a name="line-2416"></a><span>                </span><span class="hs-comment">-- (Deadness is signalled by not being in the map at all)</span><span>
</span><a name="line-2417"></a><span>
</span><a name="line-2418"></a><span class="hs-keyword">type</span><span> </span><a name="ZappedSet"><a href="OccurAnal.html#ZappedSet"><span class="hs-identifier">ZappedSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a><span> </span><span class="hs-comment">-- Values are ignored</span><span>
</span><a name="line-2419"></a><span>
</span><a name="line-2420"></a><span class="hs-keyword">data</span><span> </span><a name="UsageDetails"><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier">UsageDetails</span></a></a><span>
</span><a name="line-2421"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="UD"><a href="OccurAnal.html#UD"><span class="hs-identifier">UD</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="ud_env"><a href="OccurAnal.html#ud_env"><span class="hs-identifier">ud_env</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a><span>
</span><a name="line-2422"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ud_z_many"><a href="OccurAnal.html#ud_z_many"><span class="hs-identifier">ud_z_many</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#ZappedSet"><span class="hs-identifier hs-type">ZappedSet</span></a><span>   </span><span class="hs-comment">-- apply 'markMany' to these</span><span>
</span><a name="line-2423"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ud_z_in_lam"><a href="OccurAnal.html#ud_z_in_lam"><span class="hs-identifier">ud_z_in_lam</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#ZappedSet"><span class="hs-identifier hs-type">ZappedSet</span></a><span>   </span><span class="hs-comment">-- apply 'markInsideLam' to these</span><span>
</span><a name="line-2424"></a><span>       </span><span class="hs-special">,</span><span> </span><a name="ud_z_no_tail"><a href="OccurAnal.html#ud_z_no_tail"><span class="hs-identifier">ud_z_no_tail</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#ZappedSet"><span class="hs-identifier hs-type">ZappedSet</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-comment">-- apply 'markNonTailCalled' to these</span><span>
</span><a name="line-2425"></a><span>  </span><span class="hs-comment">-- INVARIANT: All three zapped sets are subsets of the OccInfoEnv</span><span>
</span><a name="line-2426"></a><span>
</span><a name="line-2427"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2428"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a name="local-6989586621684706872"><a href="#local-6989586621684706872"><span class="hs-identifier">ud</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_env</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#flattenUsageDetails"><span class="hs-identifier hs-var">flattenUsageDetails</span></a><span> </span><a href="#local-6989586621684706872"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2429"></a><span>
</span><a name="line-2430"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-2431"></a><span class="hs-comment">-- UsageDetails API</span><span>
</span><a name="line-2432"></a><span>
</span><a name="line-2433"></a><span class="hs-identifier">andUDs</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">orUDs</span><span>
</span><a name="line-2434"></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2435"></a><a name="andUDs"><a href="OccurAnal.html#andUDs"><span class="hs-identifier">andUDs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#combineUsageDetailsWith"><span class="hs-identifier hs-var">combineUsageDetailsWith</span></a><span> </span><a href="OccurAnal.html#addOccInfo"><span class="hs-identifier hs-var">addOccInfo</span></a><span>
</span><a name="line-2436"></a><a name="orUDs"><a href="OccurAnal.html#orUDs"><span class="hs-identifier">orUDs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#combineUsageDetailsWith"><span class="hs-identifier hs-var">combineUsageDetailsWith</span></a><span> </span><a href="OccurAnal.html#orOccInfo"><span class="hs-identifier hs-var">orOccInfo</span></a><span>
</span><a name="line-2437"></a><span>
</span><a name="line-2438"></a><span class="hs-identifier">andUDsList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2439"></a><a name="andUDsList"><a href="OccurAnal.html#andUDsList"><span class="hs-identifier">andUDsList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span>
</span><a name="line-2440"></a><span>
</span><a name="line-2441"></a><span class="hs-identifier">mkOneOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#OccEnv"><span class="hs-identifier hs-type">OccEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#InterestingCxt"><span class="hs-identifier hs-type">InterestingCxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2442"></a><a name="mkOneOcc"><a href="OccurAnal.html#mkOneOcc"><span class="hs-identifier">mkOneOcc</span></a></a><span> </span><a name="local-6989586621684707383"><a href="#local-6989586621684707383"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684707384"><a href="#local-6989586621684707384"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684707385"><a href="#local-6989586621684707385"><span class="hs-identifier">int_cxt</span></a></a><span> </span><a name="local-6989586621684707386"><a href="#local-6989586621684707386"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-2443"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a><span> </span><a href="#local-6989586621684707384"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-2444"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707387"><span class="hs-identifier hs-var">singleton</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="BasicTypes.html#OneOcc"><span class="hs-identifier hs-var">OneOcc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_in_lam</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2445"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_one_br</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2446"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_int_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707385"><span class="hs-identifier hs-var">int_cxt</span></a><span>
</span><a name="line-2447"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_tail</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#AlwaysTailCalled"><span class="hs-identifier hs-var">AlwaysTailCalled</span></a><span> </span><a href="#local-6989586621684707386"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2448"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707384"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">occ_gbl_scrut</span><span> </span><a href="#local-6989586621684707383"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2449"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707387"><span class="hs-identifier hs-var">singleton</span></a><span> </span><a href="BasicTypes.html#noOccInfo"><span class="hs-identifier hs-var">noOccInfo</span></a><span>
</span><a name="line-2450"></a><span>
</span><a name="line-2451"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2452"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span>
</span><a name="line-2453"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2454"></a><span>    </span><a name="local-6989586621684707387"><a href="#local-6989586621684707387"><span class="hs-identifier">singleton</span></a></a><span> </span><a name="local-6989586621684707388"><a href="#local-6989586621684707388"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier hs-var">emptyDetails</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#unitVarEnv"><span class="hs-identifier hs-var">unitVarEnv</span></a><span> </span><a href="#local-6989586621684707384"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684707388"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2455"></a><span>
</span><a name="line-2456"></a><span class="hs-identifier">addOneOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2457"></a><a name="addOneOcc"><a href="OccurAnal.html#addOneOcc"><span class="hs-identifier">addOneOcc</span></a></a><span> </span><a name="local-6989586621684707389"><a href="#local-6989586621684707389"><span class="hs-identifier">ud</span></a></a><span> </span><a name="local-6989586621684707390"><a href="#local-6989586621684707390"><span class="hs-identifier">id</span></a></a><span> </span><a name="local-6989586621684707391"><a href="#local-6989586621684707391"><span class="hs-identifier">info</span></a></a><span>
</span><a name="line-2458"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707389"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv_C"><span class="hs-identifier hs-var">extendVarEnv_C</span></a><span> </span><a href="#local-6989586621684707392"><span class="hs-identifier hs-var">plus_zapped</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707389"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707390"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684707391"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2459"></a><span>      </span><span class="hs-special">`</span><a href="OccurAnal.html#alterZappedSets"><span class="hs-identifier hs-var">alterZappedSets</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707390"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-2460"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2461"></a><span>    </span><a name="local-6989586621684707392"><a href="#local-6989586621684707392"><span class="hs-identifier">plus_zapped</span></a></a><span> </span><a name="local-6989586621684707393"><a href="#local-6989586621684707393"><span class="hs-identifier">old</span></a></a><span> </span><a name="local-6989586621684707394"><a href="#local-6989586621684707394"><span class="hs-identifier">new</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#doZapping"><span class="hs-identifier hs-var">doZapping</span></a><span> </span><a href="#local-6989586621684707389"><span class="hs-identifier hs-var">ud</span></a><span> </span><a href="#local-6989586621684707390"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684707393"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#addOccInfo"><span class="hs-identifier hs-var">addOccInfo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707394"><span class="hs-identifier hs-var">new</span></a><span>
</span><a name="line-2462"></a><span>
</span><a name="line-2463"></a><span class="hs-identifier">addManyOccsSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2464"></a><a name="addManyOccsSet"><a href="OccurAnal.html#addManyOccsSet"><span class="hs-identifier">addManyOccsSet</span></a></a><span> </span><a name="local-6989586621684707395"><a href="#local-6989586621684707395"><span class="hs-identifier">usage</span></a></a><span> </span><a name="local-6989586621684707396"><a href="#local-6989586621684707396"><span class="hs-identifier">id_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqSet.html#nonDetFoldUniqSet"><span class="hs-identifier hs-var">nonDetFoldUniqSet</span></a><span> </span><a href="OccurAnal.html#addManyOccs"><span class="hs-identifier hs-var">addManyOccs</span></a><span> </span><a href="#local-6989586621684707395"><span class="hs-identifier hs-var">usage</span></a><span> </span><a href="#local-6989586621684707396"><span class="hs-identifier hs-var">id_set</span></a><span>
</span><a name="line-2465"></a><span>  </span><span class="hs-comment">-- It's OK to use nonDetFoldUFM here because addManyOccs commutes</span><span>
</span><a name="line-2466"></a><span>
</span><a name="line-2467"></a><span class="hs-comment">-- Add several occurrences, assumed not to be tail calls</span><span>
</span><a name="line-2468"></a><span class="hs-identifier">addManyOccs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2469"></a><a name="addManyOccs"><a href="OccurAnal.html#addManyOccs"><span class="hs-identifier">addManyOccs</span></a></a><span> </span><a name="local-6989586621684707397"><a href="#local-6989586621684707397"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684707398"><a href="#local-6989586621684707398"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684707397"><span class="hs-identifier hs-var">v</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#addOneOcc"><span class="hs-identifier hs-var">addOneOcc</span></a><span> </span><a href="#local-6989586621684707398"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621684707397"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="BasicTypes.html#noOccInfo"><span class="hs-identifier hs-var">noOccInfo</span></a><span>
</span><a name="line-2470"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707398"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-2471"></a><span>        </span><span class="hs-comment">-- Give a non-committal binder info (i.e noOccInfo) because</span><span>
</span><a name="line-2472"></a><span>        </span><span class="hs-comment">--   a) Many copies of the specialised thing can appear</span><span>
</span><a name="line-2473"></a><span>        </span><span class="hs-comment">--   b) We don't want to substitute a BIG expression inside a RULE</span><span>
</span><a name="line-2474"></a><span>        </span><span class="hs-comment">--      even if that's the only occurrence of the thing</span><span>
</span><a name="line-2475"></a><span>        </span><span class="hs-comment">--      (Same goes for INLINE.)</span><span>
</span><a name="line-2476"></a><span>
</span><a name="line-2477"></a><span class="hs-identifier">delDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2478"></a><a name="delDetails"><a href="OccurAnal.html#delDetails"><span class="hs-identifier">delDetails</span></a></a><span> </span><a name="local-6989586621684707399"><a href="#local-6989586621684707399"><span class="hs-identifier">ud</span></a></a><span> </span><a name="local-6989586621684707400"><a href="#local-6989586621684707400"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-2479"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707399"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#alterUsageDetails"><span class="hs-identifier hs-var">alterUsageDetails</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707400"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2480"></a><span>
</span><a name="line-2481"></a><span class="hs-identifier">delDetailsList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2482"></a><a name="delDetailsList"><a href="OccurAnal.html#delDetailsList"><span class="hs-identifier">delDetailsList</span></a></a><span> </span><a name="local-6989586621684707401"><a href="#local-6989586621684707401"><span class="hs-identifier">ud</span></a></a><span> </span><a name="local-6989586621684707402"><a href="#local-6989586621684707402"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-2483"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707401"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#alterUsageDetails"><span class="hs-identifier hs-var">alterUsageDetails</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707402"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2484"></a><span>
</span><a name="line-2485"></a><span class="hs-identifier">emptyDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2486"></a><a name="emptyDetails"><a href="OccurAnal.html#emptyDetails"><span class="hs-identifier">emptyDetails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#UD"><span class="hs-identifier hs-var">UD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_env</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-2487"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_z_many</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-2488"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_z_in_lam</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-2489"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_z_no_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2490"></a><span>
</span><a name="line-2491"></a><span class="hs-identifier">isEmptyDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2492"></a><a name="isEmptyDetails"><a href="OccurAnal.html#isEmptyDetails"><span class="hs-identifier">isEmptyDetails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">ud_env</span><span>
</span><a name="line-2493"></a><span>
</span><a name="line-2494"></a><span class="hs-identifier">markAllMany</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">markAllInsideLam</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">markAllNonTailCalled</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">zapDetails</span><span>
</span><a name="line-2495"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2496"></a><a name="markAllMany"><a href="OccurAnal.html#markAllMany"><span class="hs-identifier">markAllMany</span></a></a><span>          </span><a name="local-6989586621684707403"><a href="#local-6989586621684707403"><span class="hs-identifier">ud</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707403"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_z_many</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707403"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2497"></a><a name="markAllInsideLam"><a href="OccurAnal.html#markAllInsideLam"><span class="hs-identifier">markAllInsideLam</span></a></a><span>     </span><a name="local-6989586621684707404"><a href="#local-6989586621684707404"><span class="hs-identifier">ud</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707404"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_z_in_lam</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707404"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2498"></a><a name="markAllNonTailCalled"><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier">markAllNonTailCalled</span></a></a><span> </span><a name="local-6989586621684707405"><a href="#local-6989586621684707405"><span class="hs-identifier">ud</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707405"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_z_no_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707405"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2499"></a><span>
</span><a name="line-2500"></a><a name="zapDetails"><a href="OccurAnal.html#zapDetails"><span class="hs-identifier">zapDetails</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllMany"><span class="hs-identifier hs-var">markAllMany</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><span class="hs-comment">-- effectively sets to noOccInfo</span><span>
</span><a name="line-2501"></a><span>
</span><a name="line-2502"></a><span class="hs-identifier">lookupDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span>
</span><a name="line-2503"></a><a name="lookupDetails"><a href="OccurAnal.html#lookupDetails"><span class="hs-identifier">lookupDetails</span></a></a><span> </span><a name="local-6989586621684707406"><a href="#local-6989586621684707406"><span class="hs-identifier">ud</span></a></a><span> </span><a name="local-6989586621684707407"><a href="#local-6989586621684707407"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-2504"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621684707407"><span class="hs-identifier hs-var">id</span></a><span>  </span><span class="hs-comment">-- We do not currenly gather occurrence info (from types)</span><span>
</span><a name="line-2505"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#noOccInfo"><span class="hs-identifier hs-var">noOccInfo</span></a><span>   </span><span class="hs-comment">-- for CoVars, so we must conservatively mark them as used</span><span>
</span><a name="line-2506"></a><span>                </span><span class="hs-comment">-- See Note [DoO not mark CoVars as dead]</span><span>
</span><a name="line-2507"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2508"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707406"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707407"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2509"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684707408"><a href="#local-6989586621684707408"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#doZapping"><span class="hs-identifier hs-var">doZapping</span></a><span> </span><a href="#local-6989586621684707406"><span class="hs-identifier hs-var">ud</span></a><span> </span><a href="#local-6989586621684707407"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684707408"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-2510"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a><span>
</span><a name="line-2511"></a><span>
</span><a name="line-2512"></a><span class="hs-identifier">usedIn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2513"></a><a name="local-6989586621684707409"><a href="#local-6989586621684707409"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">`</span><a name="usedIn"><a href="OccurAnal.html#usedIn"><span class="hs-identifier">usedIn</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621684707410"><a href="#local-6989586621684707410"><span class="hs-identifier">ud</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a><span> </span><a href="#local-6989586621684707409"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684707409"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#elemVarEnv"><span class="hs-identifier hs-var">elemVarEnv</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707410"><span class="hs-identifier hs-var">ud</span></a><span>
</span><a name="line-2514"></a><span>
</span><a name="line-2515"></a><span class="hs-identifier">udFreeVars</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-2516"></a><span class="hs-comment">-- Find the subset of bndrs that are mentioned in uds</span><span>
</span><a name="line-2517"></a><a name="udFreeVars"><a href="OccurAnal.html#udFreeVars"><span class="hs-identifier">udFreeVars</span></a></a><span> </span><a name="local-6989586621684707411"><a href="#local-6989586621684707411"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684707412"><a href="#local-6989586621684707412"><span class="hs-identifier">ud</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqSet.html#restrictUniqSetToUFM"><span class="hs-identifier hs-var">restrictUniqSetToUFM</span></a><span> </span><a href="#local-6989586621684707411"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707412"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span>
</span><a name="line-2518"></a><span>
</span><a name="line-2519"></a><span class="hs-comment">{- Note [Do not mark CoVars as dead]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's obviously wrong to mark CoVars as dead if they are used.
Currently we don't traverse types to gather usase info for CoVars,
so we had better treat them as having noOccInfo.

This showed up in Trac #15696 we had something like
  case eq_sel d of co -&gt; ...(typeError @(...co...) &quot;urk&quot;)...

Then 'd' was substitued by a dictionary, so the expression
simpified to
  case (Coercion &lt;blah&gt;) of co -&gt; ...(typeError @(...co...) &quot;urk&quot;)...

But then the &quot;drop the case altogether&quot; equation of rebuildCase
thought that 'co' was dead, and discarded the entire case. Urk!

I have no idea how we managed to avoid this pitfall for so long!
-}</span><span>
</span><a name="line-2537"></a><span>
</span><a name="line-2538"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-2539"></a><span class="hs-comment">-- Auxiliary functions for UsageDetails implementation</span><span>
</span><a name="line-2540"></a><span>
</span><a name="line-2541"></a><span class="hs-identifier">combineUsageDetailsWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-2542"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2543"></a><a name="combineUsageDetailsWith"><a href="OccurAnal.html#combineUsageDetailsWith"><span class="hs-identifier">combineUsageDetailsWith</span></a></a><span> </span><a name="local-6989586621684707413"><a href="#local-6989586621684707413"><span class="hs-identifier">plus_occ_info</span></a></a><span> </span><a name="local-6989586621684707414"><a href="#local-6989586621684707414"><span class="hs-identifier">ud1</span></a></a><span> </span><a name="local-6989586621684707415"><a href="#local-6989586621684707415"><span class="hs-identifier">ud2</span></a></a><span>
</span><a name="line-2544"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="OccurAnal.html#isEmptyDetails"><span class="hs-identifier hs-var">isEmptyDetails</span></a><span> </span><a href="#local-6989586621684707414"><span class="hs-identifier hs-var">ud1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707415"><span class="hs-identifier hs-var">ud2</span></a><span>
</span><a name="line-2545"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="OccurAnal.html#isEmptyDetails"><span class="hs-identifier hs-var">isEmptyDetails</span></a><span> </span><a href="#local-6989586621684707415"><span class="hs-identifier hs-var">ud2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707414"><span class="hs-identifier hs-var">ud1</span></a><span>
</span><a name="line-2546"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2547"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#UD"><span class="hs-identifier hs-var">UD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_env</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#plusVarEnv_C"><span class="hs-identifier hs-var">plusVarEnv_C</span></a><span> </span><a href="#local-6989586621684707413"><span class="hs-identifier hs-var">plus_occ_info</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707414"><span class="hs-identifier hs-var">ud1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707415"><span class="hs-identifier hs-var">ud2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2548"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_z_many</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#plusVarEnv"><span class="hs-identifier hs-var">plusVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_many</span><span>    </span><a href="#local-6989586621684707414"><span class="hs-identifier hs-var">ud1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_many</span><span>    </span><a href="#local-6989586621684707415"><span class="hs-identifier hs-var">ud2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2549"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_z_in_lam</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#plusVarEnv"><span class="hs-identifier hs-var">plusVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_in_lam</span><span>  </span><a href="#local-6989586621684707414"><span class="hs-identifier hs-var">ud1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_in_lam</span><span>  </span><a href="#local-6989586621684707415"><span class="hs-identifier hs-var">ud2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2550"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_z_no_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#plusVarEnv"><span class="hs-identifier hs-var">plusVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_no_tail</span><span> </span><a href="#local-6989586621684707414"><span class="hs-identifier hs-var">ud1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_no_tail</span><span> </span><a href="#local-6989586621684707415"><span class="hs-identifier hs-var">ud2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2551"></a><span>
</span><a name="line-2552"></a><span class="hs-identifier">doZapping</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span>
</span><a name="line-2553"></a><a name="doZapping"><a href="OccurAnal.html#doZapping"><span class="hs-identifier">doZapping</span></a></a><span> </span><a name="local-6989586621684707416"><a href="#local-6989586621684707416"><span class="hs-identifier">ud</span></a></a><span> </span><a name="local-6989586621684707417"><a href="#local-6989586621684707417"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684707418"><a href="#local-6989586621684707418"><span class="hs-identifier">occ</span></a></a><span>
</span><a name="line-2554"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#doZappingByUnique"><span class="hs-identifier hs-var">doZappingByUnique</span></a><span> </span><a href="#local-6989586621684707416"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#varUnique"><span class="hs-identifier hs-var">varUnique</span></a><span> </span><a href="#local-6989586621684707417"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707418"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-2555"></a><span>
</span><a name="line-2556"></a><span class="hs-identifier">doZappingByUnique</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span>
</span><a name="line-2557"></a><a name="doZappingByUnique"><a href="OccurAnal.html#doZappingByUnique"><span class="hs-identifier">doZappingByUnique</span></a></a><span> </span><a name="local-6989586621684707419"><a href="#local-6989586621684707419"><span class="hs-identifier">ud</span></a></a><span> </span><a name="local-6989586621684707420"><a href="#local-6989586621684707420"><span class="hs-identifier">uniq</span></a></a><span>
</span><a name="line-2558"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707421"><span class="hs-identifier hs-var">in_subset</span></a><span> </span><span class="hs-identifier">ud_z_many</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#markMany"><span class="hs-identifier hs-var">markMany</span></a><span>
</span><a name="line-2559"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707421"><span class="hs-identifier hs-var">in_subset</span></a><span> </span><span class="hs-identifier">ud_z_in_lam</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#markInsideLam"><span class="hs-identifier hs-var">markInsideLam</span></a><span>
</span><a name="line-2560"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span>
</span><a name="line-2561"></a><span>    </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707421"><span class="hs-identifier hs-var">in_subset</span></a><span> </span><span class="hs-identifier">ud_z_no_tail</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#markNonTailCalled"><span class="hs-identifier hs-var">markNonTailCalled</span></a><span>
</span><a name="line-2562"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span>
</span><a name="line-2563"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2564"></a><span>    </span><a name="local-6989586621684707421"><a href="#local-6989586621684707421"><span class="hs-identifier">in_subset</span></a></a><span> </span><a name="local-6989586621684707422"><a href="#local-6989586621684707422"><span class="hs-identifier">field</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707420"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#elemVarEnvByKey"><span class="hs-identifier hs-var">elemVarEnvByKey</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707422"><span class="hs-identifier hs-var">field</span></a><span> </span><a href="#local-6989586621684707419"><span class="hs-identifier hs-var">ud</span></a><span>
</span><a name="line-2565"></a><span>
</span><a name="line-2566"></a><span class="hs-identifier">alterZappedSets</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#ZappedSet"><span class="hs-identifier hs-type">ZappedSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#ZappedSet"><span class="hs-identifier hs-type">ZappedSet</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2567"></a><a name="alterZappedSets"><a href="OccurAnal.html#alterZappedSets"><span class="hs-identifier">alterZappedSets</span></a></a><span> </span><a name="local-6989586621684707423"><a href="#local-6989586621684707423"><span class="hs-identifier">ud</span></a></a><span> </span><a name="local-6989586621684707424"><a href="#local-6989586621684707424"><span class="hs-identifier">f</span></a></a><span>
</span><a name="line-2568"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707423"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_z_many</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707424"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_many</span><span>    </span><a href="#local-6989586621684707423"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span>
</span><a name="line-2569"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_z_in_lam</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707424"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_in_lam</span><span>  </span><a href="#local-6989586621684707423"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span>
</span><a name="line-2570"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud_z_no_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707424"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_z_no_tail</span><span> </span><a href="#local-6989586621684707423"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2571"></a><span>
</span><a name="line-2572"></a><span class="hs-identifier">alterUsageDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#OccInfoEnv"><span class="hs-identifier hs-type">OccInfoEnv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2573"></a><a name="alterUsageDetails"><a href="OccurAnal.html#alterUsageDetails"><span class="hs-identifier">alterUsageDetails</span></a></a><span> </span><a name="local-6989586621684707425"><a href="#local-6989586621684707425"><span class="hs-identifier">ud</span></a></a><span> </span><a name="local-6989586621684707426"><a href="#local-6989586621684707426"><span class="hs-identifier">f</span></a></a><span>
</span><a name="line-2574"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707425"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707426"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707425"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2575"></a><span>      </span><span class="hs-special">`</span><a href="OccurAnal.html#alterZappedSets"><span class="hs-identifier hs-var">alterZappedSets</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707426"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-2576"></a><span>
</span><a name="line-2577"></a><span class="hs-identifier">flattenUsageDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2578"></a><a name="flattenUsageDetails"><a href="OccurAnal.html#flattenUsageDetails"><span class="hs-identifier">flattenUsageDetails</span></a></a><span> </span><a name="local-6989586621684707427"><a href="#local-6989586621684707427"><span class="hs-identifier">ud</span></a></a><span>
</span><a name="line-2579"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707427"><span class="hs-identifier hs-var">ud</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud_env</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#mapUFM_Directly"><span class="hs-identifier hs-var">mapUFM_Directly</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#doZappingByUnique"><span class="hs-identifier hs-var">doZappingByUnique</span></a><span> </span><a href="#local-6989586621684707427"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ud_env</span><span> </span><a href="#local-6989586621684707427"><span class="hs-identifier hs-var">ud</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2580"></a><span>      </span><span class="hs-special">`</span><a href="OccurAnal.html#alterZappedSets"><span class="hs-identifier hs-var">alterZappedSets</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-2581"></a><span>
</span><a name="line-2582"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-2583"></a><span class="hs-comment">-- See Note [Adjusting right-hand sides]</span><span>
</span><a name="line-2584"></a><span class="hs-identifier">adjustRhsUsage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BasicTypes.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RecFlag"><span class="hs-identifier hs-type">RecFlag</span></a><span>
</span><a name="line-2585"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Outer lambdas, AFTER occ anal</span><span>
</span><a name="line-2586"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2587"></a><a name="adjustRhsUsage"><a href="OccurAnal.html#adjustRhsUsage"><span class="hs-identifier">adjustRhsUsage</span></a></a><span> </span><a name="local-6989586621684707428"><a href="#local-6989586621684707428"><span class="hs-identifier">mb_join_arity</span></a></a><span> </span><a name="local-6989586621684707429"><a href="#local-6989586621684707429"><span class="hs-identifier">rec_flag</span></a></a><span> </span><a name="local-6989586621684707430"><a href="#local-6989586621684707430"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621684707431"><a href="#local-6989586621684707431"><span class="hs-identifier">usage</span></a></a><span>
</span><a name="line-2588"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707432"><span class="hs-identifier hs-var">maybe_mark_lam</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707433"><span class="hs-identifier hs-var">maybe_drop_tails</span></a><span> </span><a href="#local-6989586621684707431"><span class="hs-identifier hs-var">usage</span></a><span class="hs-special">)</span><span>
</span><a name="line-2589"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2590"></a><span>    </span><a name="local-6989586621684707432"><a href="#local-6989586621684707432"><span class="hs-identifier">maybe_mark_lam</span></a></a><span> </span><a name="local-6989586621684707436"><a href="#local-6989586621684707436"><span class="hs-identifier">ud</span></a></a><span>   </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707434"><span class="hs-identifier hs-var">one_shot</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707436"><span class="hs-identifier hs-var">ud</span></a><span>
</span><a name="line-2591"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllInsideLam"><span class="hs-identifier hs-var">markAllInsideLam</span></a><span> </span><a href="#local-6989586621684707436"><span class="hs-identifier hs-var">ud</span></a><span>
</span><a name="line-2592"></a><span>    </span><a name="local-6989586621684707433"><a href="#local-6989586621684707433"><span class="hs-identifier">maybe_drop_tails</span></a></a><span> </span><a name="local-6989586621684707437"><a href="#local-6989586621684707437"><span class="hs-identifier">ud</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707435"><span class="hs-identifier hs-var">exact_join</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707437"><span class="hs-identifier hs-var">ud</span></a><span>
</span><a name="line-2593"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markAllNonTailCalled"><span class="hs-identifier hs-var">markAllNonTailCalled</span></a><span> </span><a href="#local-6989586621684707437"><span class="hs-identifier hs-var">ud</span></a><span>
</span><a name="line-2594"></a><span>
</span><a name="line-2595"></a><span>    </span><a name="local-6989586621684707434"><a href="#local-6989586621684707434"><span class="hs-identifier">one_shot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707428"><span class="hs-identifier hs-var">mb_join_arity</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2596"></a><span>                 </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684707438"><a href="#local-6989586621684707438"><span class="hs-identifier">join_arity</span></a></a><span>
</span><a name="line-2597"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><a href="BasicTypes.html#isRec"><span class="hs-identifier hs-var">isRec</span></a><span> </span><a href="#local-6989586621684707429"><span class="hs-identifier hs-var">rec_flag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2598"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="Id.html#isOneShotBndr"><span class="hs-identifier hs-var">isOneShotBndr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">drop</span><span> </span><a href="#local-6989586621684707438"><span class="hs-identifier hs-var">join_arity</span></a><span> </span><a href="#local-6989586621684707430"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2599"></a><span>                 </span><span class="hs-identifier hs-var">Nothing</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="Id.html#isOneShotBndr"><span class="hs-identifier hs-var">isOneShotBndr</span></a><span> </span><a href="#local-6989586621684707430"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2600"></a><span>
</span><a name="line-2601"></a><span>    </span><a name="local-6989586621684707435"><a href="#local-6989586621684707435"><span class="hs-identifier">exact_join</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684707428"><span class="hs-identifier hs-var">mb_join_arity</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2602"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684707439"><a href="#local-6989586621684707439"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684707430"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707439"><span class="hs-identifier hs-var">join_arity</span></a><span>
</span><a name="line-2603"></a><span>                   </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2604"></a><span>
</span><a name="line-2605"></a><span class="hs-keyword">type</span><span> </span><a name="IdWithOccInfo"><a href="OccurAnal.html#IdWithOccInfo"><span class="hs-identifier">IdWithOccInfo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-2606"></a><span>
</span><a name="line-2607"></a><span class="hs-identifier">tagLamBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>          </span><span class="hs-comment">-- Of scope</span><span>
</span><a name="line-2608"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span>                  </span><span class="hs-comment">-- Binders</span><span>
</span><a name="line-2609"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- Details with binders removed</span><span>
</span><a name="line-2610"></a><span>                 </span><span class="hs-special">[</span><a href="OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Tagged binders</span><span>
</span><a name="line-2611"></a><a name="tagLamBinders"><a href="OccurAnal.html#tagLamBinders"><span class="hs-identifier">tagLamBinders</span></a></a><span> </span><a name="local-6989586621684707440"><a href="#local-6989586621684707440"><span class="hs-identifier">usage</span></a></a><span> </span><a name="local-6989586621684707441"><a href="#local-6989586621684707441"><span class="hs-identifier">binders</span></a></a><span>
</span><a name="line-2612"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707442"><span class="hs-identifier hs-var">usage'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707442"><span class="hs-identifier hs-var">usage'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707443"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2613"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2614"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684707442"><a href="#local-6989586621684707442"><span class="hs-identifier">usage'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707443"><a href="#local-6989586621684707443"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumR</span><span> </span><a href="OccurAnal.html#tagLamBinder"><span class="hs-identifier hs-var">tagLamBinder</span></a><span> </span><a href="#local-6989586621684707440"><span class="hs-identifier hs-var">usage</span></a><span> </span><a href="#local-6989586621684707441"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-2615"></a><span>
</span><a name="line-2616"></a><span class="hs-identifier">tagLamBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>       </span><span class="hs-comment">-- Of scope</span><span>
</span><a name="line-2617"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>                 </span><span class="hs-comment">-- Binder</span><span>
</span><a name="line-2618"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Details with binder removed</span><span>
</span><a name="line-2619"></a><span>                 </span><a href="OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Tagged binders</span><span>
</span><a name="line-2620"></a><span class="hs-comment">-- Used for lambda and case binders</span><span>
</span><a name="line-2621"></a><span class="hs-comment">-- It copes with the fact that lambda bindings can have a</span><span>
</span><a name="line-2622"></a><span class="hs-comment">-- stable unfolding, used for join points</span><span>
</span><a name="line-2623"></a><a name="tagLamBinder"><a href="OccurAnal.html#tagLamBinder"><span class="hs-identifier">tagLamBinder</span></a></a><span> </span><a name="local-6989586621684707444"><a href="#local-6989586621684707444"><span class="hs-identifier">usage</span></a></a><span> </span><a name="local-6989586621684707445"><a href="#local-6989586621684707445"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-2624"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707449"><span class="hs-identifier hs-var">usage2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707447"><span class="hs-identifier hs-var">bndr'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2625"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2626"></a><span>        </span><a name="local-6989586621684707446"><a href="#local-6989586621684707446"><span class="hs-identifier">occ</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#lookupDetails"><span class="hs-identifier hs-var">lookupDetails</span></a><span> </span><a href="#local-6989586621684707444"><span class="hs-identifier hs-var">usage</span></a><span> </span><a href="#local-6989586621684707445"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2627"></a><span>        </span><a name="local-6989586621684707447"><a href="#local-6989586621684707447"><span class="hs-identifier">bndr'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-var">setBinderOcc</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#markNonTailCalled"><span class="hs-identifier hs-var">markNonTailCalled</span></a><span> </span><a href="#local-6989586621684707446"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707445"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2628"></a><span>                   </span><span class="hs-comment">-- Don't try to make an argument into a join point</span><span>
</span><a name="line-2629"></a><span>        </span><a name="local-6989586621684707448"><a href="#local-6989586621684707448"><span class="hs-identifier">usage1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707444"><span class="hs-identifier hs-var">usage</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#delDetails"><span class="hs-identifier hs-var">delDetails</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707445"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2630"></a><span>        </span><a name="local-6989586621684707449"><a href="#local-6989586621684707449"><span class="hs-identifier">usage2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684707445"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#addManyOccsSet"><span class="hs-identifier hs-var">addManyOccsSet</span></a><span> </span><a href="#local-6989586621684707448"><span class="hs-identifier hs-var">usage1</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#idUnfoldingVars"><span class="hs-identifier hs-var">idUnfoldingVars</span></a><span> </span><a href="#local-6989586621684707445"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2631"></a><span>                               </span><span class="hs-comment">-- This is effectively the RHS of a</span><span>
</span><a name="line-2632"></a><span>                               </span><span class="hs-comment">-- non-join-point binding, so it's okay to use</span><span>
</span><a name="line-2633"></a><span>                               </span><span class="hs-comment">-- addManyOccsSet, which assumes no tail calls</span><span>
</span><a name="line-2634"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707448"><span class="hs-identifier hs-var">usage1</span></a><span>
</span><a name="line-2635"></a><span>
</span><a name="line-2636"></a><span class="hs-identifier">tagNonRecBinder</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span>           </span><span class="hs-comment">-- At top level?</span><span>
</span><a name="line-2637"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>           </span><span class="hs-comment">-- Of scope</span><span>
</span><a name="line-2638"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>               </span><span class="hs-comment">-- Binder</span><span>
</span><a name="line-2639"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- Details with binder removed</span><span>
</span><a name="line-2640"></a><span>                    </span><a href="OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a><span class="hs-special">)</span><span>        </span><span class="hs-comment">-- Tagged binder</span><span>
</span><a name="line-2641"></a><span>
</span><a name="line-2642"></a><a name="tagNonRecBinder"><a href="OccurAnal.html#tagNonRecBinder"><span class="hs-identifier">tagNonRecBinder</span></a></a><span> </span><a name="local-6989586621684707450"><a href="#local-6989586621684707450"><span class="hs-identifier">lvl</span></a></a><span> </span><a name="local-6989586621684707451"><a href="#local-6989586621684707451"><span class="hs-identifier">usage</span></a></a><span> </span><a name="local-6989586621684707452"><a href="#local-6989586621684707452"><span class="hs-identifier">binder</span></a></a><span>
</span><a name="line-2643"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-2644"></a><span>     </span><a name="local-6989586621684707453"><a href="#local-6989586621684707453"><span class="hs-identifier">occ</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#lookupDetails"><span class="hs-identifier hs-var">lookupDetails</span></a><span> </span><a href="#local-6989586621684707451"><span class="hs-identifier hs-var">usage</span></a><span> </span><a href="#local-6989586621684707452"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-2645"></a><span>     </span><a name="local-6989586621684707454"><a href="#local-6989586621684707454"><span class="hs-identifier">will_be_join</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#decideJoinPointHood"><span class="hs-identifier hs-var">decideJoinPointHood</span></a><span> </span><a href="#local-6989586621684707450"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621684707451"><span class="hs-identifier hs-var">usage</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621684707452"><span class="hs-identifier hs-var">binder</span></a><span class="hs-special">]</span><span>
</span><a name="line-2646"></a><span>     </span><a name="local-6989586621684707455"><a href="#local-6989586621684707455"><span class="hs-identifier">occ'</span></a></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707454"><span class="hs-identifier hs-var">will_be_join</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- must already be marked AlwaysTailCalled</span><span>
</span><a name="line-2647"></a><span>                              </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span class="hs-identifier">isAlwaysTailCalled</span><span> </span><a href="BasicTypes.html#isAlwaysTailCalled"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><a href="BasicTypes.html#isAlwaysTailCalled"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-2648"></a><span>             </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#markNonTailCalled"><span class="hs-identifier hs-var">markNonTailCalled</span></a><span> </span><a href="#local-6989586621684707453"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-2649"></a><span>     </span><a name="local-6989586621684707456"><a href="#local-6989586621684707456"><span class="hs-identifier">binder'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-var">setBinderOcc</span></a><span> </span><a href="#local-6989586621684707455"><span class="hs-identifier hs-var">occ'</span></a><span> </span><a href="#local-6989586621684707452"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-2650"></a><span>     </span><a name="local-6989586621684707457"><a href="#local-6989586621684707457"><span class="hs-identifier">usage'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707451"><span class="hs-identifier hs-var">usage</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#delDetails"><span class="hs-identifier hs-var">delDetails</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707452"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-2651"></a><span>   </span><span class="hs-keyword">in</span><span>
</span><a name="line-2652"></a><span>   </span><a href="#local-6989586621684707457"><span class="hs-identifier hs-var">usage'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707457"><span class="hs-identifier hs-var">usage'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707456"><span class="hs-identifier hs-var">binder'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2653"></a><span>
</span><a name="line-2654"></a><span class="hs-identifier">tagRecBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span>           </span><span class="hs-comment">-- At top level?</span><span>
</span><a name="line-2655"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>           </span><span class="hs-comment">-- Of body of let ONLY</span><span>
</span><a name="line-2656"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- Binder</span><span>
</span><a name="line-2657"></a><span>                   </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- RHS usage details</span><span>
</span><a name="line-2658"></a><span>                   </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Lambdas in new RHS</span><span>
</span><a name="line-2659"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- Adjusted details for whole scope,</span><span>
</span><a name="line-2660"></a><span>                                        </span><span class="hs-comment">-- with binders removed</span><span>
</span><a name="line-2661"></a><span>                  </span><span class="hs-special">[</span><a href="OccurAnal.html#IdWithOccInfo"><span class="hs-identifier hs-type">IdWithOccInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Tagged binders</span><span>
</span><a name="line-2662"></a><span class="hs-comment">-- Substantially more complicated than non-recursive case. Need to adjust RHS</span><span>
</span><a name="line-2663"></a><span class="hs-comment">-- details *before* tagging binders (because the tags depend on the RHSes).</span><span>
</span><a name="line-2664"></a><a name="tagRecBinders"><a href="OccurAnal.html#tagRecBinders"><span class="hs-identifier">tagRecBinders</span></a></a><span> </span><a name="local-6989586621684707458"><a href="#local-6989586621684707458"><span class="hs-identifier">lvl</span></a></a><span> </span><a name="local-6989586621684707459"><a href="#local-6989586621684707459"><span class="hs-identifier">body_uds</span></a></a><span> </span><a name="local-6989586621684707460"><a href="#local-6989586621684707460"><span class="hs-identifier">triples</span></a></a><span>
</span><a name="line-2665"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-2666"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621684707461"><a href="#local-6989586621684707461"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707462"><a href="#local-6989586621684707462"><span class="hs-identifier">rhs_udss</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip3</span><span> </span><a href="#local-6989586621684707460"><span class="hs-identifier hs-var">triples</span></a><span>
</span><a name="line-2667"></a><span>
</span><a name="line-2668"></a><span>     </span><span class="hs-comment">-- 1. Determine join-point-hood of whole group, as determined by</span><span>
</span><a name="line-2669"></a><span>     </span><span class="hs-comment">--    the *unadjusted* usage details</span><span>
</span><a name="line-2670"></a><span>     </span><a name="local-6989586621684707463"><a href="#local-6989586621684707463"><span class="hs-identifier">unadj_uds</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span> </span><a href="#local-6989586621684707459"><span class="hs-identifier hs-var">body_uds</span></a><span> </span><a href="#local-6989586621684707462"><span class="hs-identifier hs-var">rhs_udss</span></a><span>
</span><a name="line-2671"></a><span>     </span><a name="local-6989586621684707464"><a href="#local-6989586621684707464"><span class="hs-identifier">will_be_joins</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#decideJoinPointHood"><span class="hs-identifier hs-var">decideJoinPointHood</span></a><span> </span><a href="#local-6989586621684707458"><span class="hs-identifier hs-var">lvl</span></a><span> </span><a href="#local-6989586621684707463"><span class="hs-identifier hs-var">unadj_uds</span></a><span> </span><a href="#local-6989586621684707461"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2672"></a><span>
</span><a name="line-2673"></a><span>     </span><span class="hs-comment">-- 2. Adjust usage details of each RHS, taking into account the</span><span>
</span><a name="line-2674"></a><span>     </span><span class="hs-comment">--    join-point-hood decision</span><span>
</span><a name="line-2675"></a><span>     </span><a name="local-6989586621684707465"><a href="#local-6989586621684707465"><span class="hs-identifier">rhs_udss'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684707466"><span class="hs-identifier hs-var">adjust</span></a><span> </span><a href="#local-6989586621684707460"><span class="hs-identifier hs-var">triples</span></a><span>
</span><a name="line-2676"></a><span>     </span><a name="local-6989586621684707466"><a href="#local-6989586621684707466"><span class="hs-identifier">adjust</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684707470"><a href="#local-6989586621684707470"><span class="hs-identifier">bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707471"><a href="#local-6989586621684707471"><span class="hs-identifier">rhs_uds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684707472"><a href="#local-6989586621684707472"><span class="hs-identifier">rhs_bndrs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2677"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#adjustRhsUsage"><span class="hs-identifier hs-var">adjustRhsUsage</span></a><span> </span><a href="#local-6989586621684707473"><span class="hs-identifier hs-var">mb_join_arity</span></a><span> </span><a href="BasicTypes.html#Recursive"><span class="hs-identifier hs-var">Recursive</span></a><span> </span><a href="#local-6989586621684707472"><span class="hs-identifier hs-var">rhs_bndrs</span></a><span> </span><a href="#local-6989586621684707471"><span class="hs-identifier hs-var">rhs_uds</span></a><span>
</span><a name="line-2678"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-2679"></a><span>         </span><span class="hs-comment">-- Can't use willBeJoinId_maybe here because we haven't tagged the</span><span>
</span><a name="line-2680"></a><span>         </span><span class="hs-comment">-- binder yet (the tag depends on these adjustments!)</span><span>
</span><a name="line-2681"></a><span>         </span><a name="local-6989586621684707473"><a href="#local-6989586621684707473"><span class="hs-identifier">mb_join_arity</span></a></a><span>
</span><a name="line-2682"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707464"><span class="hs-identifier hs-var">will_be_joins</span></a><span>
</span><a name="line-2683"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684707474"><a href="#local-6989586621684707474"><span class="hs-identifier">occ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#lookupDetails"><span class="hs-identifier hs-var">lookupDetails</span></a><span> </span><a href="#local-6989586621684707463"><span class="hs-identifier hs-var">unadj_uds</span></a><span> </span><a href="#local-6989586621684707470"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2684"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#AlwaysTailCalled"><span class="hs-identifier hs-var">AlwaysTailCalled</span></a><span> </span><a name="local-6989586621684707475"><a href="#local-6989586621684707475"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><a href="#local-6989586621684707474"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-2685"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684707475"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-2686"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2687"></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-identifier">will_be_joins</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Should be AlwaysTailCalled if</span><span>
</span><a name="line-2688"></a><span>             </span><span class="hs-identifier hs-var">Nothing</span><span>                   </span><span class="hs-comment">-- we are making join points!</span><span>
</span><a name="line-2689"></a><span>
</span><a name="line-2690"></a><span>     </span><span class="hs-comment">-- 3. Compute final usage details from adjusted RHS details</span><span>
</span><a name="line-2691"></a><span>     </span><a name="local-6989586621684707467"><a href="#local-6989586621684707467"><span class="hs-identifier">adj_uds</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="OccurAnal.html#andUDs"><span class="hs-identifier hs-var">andUDs</span></a><span> </span><a href="#local-6989586621684707459"><span class="hs-identifier hs-var">body_uds</span></a><span> </span><a href="#local-6989586621684707465"><span class="hs-identifier hs-var">rhs_udss'</span></a><span>
</span><a name="line-2692"></a><span>
</span><a name="line-2693"></a><span>     </span><span class="hs-comment">-- 4. Tag each binder with its adjusted details</span><span>
</span><a name="line-2694"></a><span>     </span><a name="local-6989586621684707468"><a href="#local-6989586621684707468"><span class="hs-identifier">bndrs'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="OccurAnal.html#setBinderOcc"><span class="hs-identifier hs-var">setBinderOcc</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#lookupDetails"><span class="hs-identifier hs-var">lookupDetails</span></a><span> </span><a href="#local-6989586621684707467"><span class="hs-identifier hs-var">adj_uds</span></a><span> </span><a href="#local-6989586621684707476"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684707476"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2695"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621684707476"><a href="#local-6989586621684707476"><span class="hs-identifier">bndr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684707461"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2696"></a><span>
</span><a name="line-2697"></a><span>     </span><span class="hs-comment">-- 5. Drop the binders from the adjusted details and return</span><span>
</span><a name="line-2698"></a><span>     </span><a name="local-6989586621684707469"><a href="#local-6989586621684707469"><span class="hs-identifier">usage'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707467"><span class="hs-identifier hs-var">adj_uds</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#delDetailsList"><span class="hs-identifier hs-var">delDetailsList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707461"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2699"></a><span>   </span><span class="hs-keyword">in</span><span>
</span><a name="line-2700"></a><span>   </span><span class="hs-special">(</span><a href="#local-6989586621684707469"><span class="hs-identifier hs-var">usage'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707468"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2701"></a><span>
</span><a name="line-2702"></a><span class="hs-identifier">setBinderOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-2703"></a><a name="setBinderOcc"><a href="OccurAnal.html#setBinderOcc"><span class="hs-identifier">setBinderOcc</span></a></a><span> </span><a name="local-6989586621684707477"><a href="#local-6989586621684707477"><span class="hs-identifier">occ_info</span></a></a><span> </span><a name="local-6989586621684707478"><a href="#local-6989586621684707478"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-2704"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684707478"><span class="hs-identifier hs-var">bndr</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707478"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2705"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a><span> </span><a href="#local-6989586621684707478"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="BasicTypes.html#isManyOccs"><span class="hs-identifier hs-var">isManyOccs</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684707478"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2706"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621684707478"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2707"></a><span>                          </span><span class="hs-keyword">else</span><span> </span><a href="Id.html#setIdOccInfo"><span class="hs-identifier hs-var">setIdOccInfo</span></a><span> </span><a href="#local-6989586621684707478"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="BasicTypes.html#noOccInfo"><span class="hs-identifier hs-var">noOccInfo</span></a><span>
</span><a name="line-2708"></a><span>            </span><span class="hs-comment">-- Don't use local usage info for visible-elsewhere things</span><span>
</span><a name="line-2709"></a><span>            </span><span class="hs-comment">-- BUT *do* erase any IAmALoopBreaker annotation, because we're</span><span>
</span><a name="line-2710"></a><span>            </span><span class="hs-comment">-- about to re-generate it and it shouldn't be &quot;sticky&quot;</span><span>
</span><a name="line-2711"></a><span>
</span><a name="line-2712"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdOccInfo"><span class="hs-identifier hs-var">setIdOccInfo</span></a><span> </span><a href="#local-6989586621684707478"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621684707477"><span class="hs-identifier hs-var">occ_info</span></a><span>
</span><a name="line-2713"></a><span>
</span><a name="line-2714"></a><span class="hs-comment">-- | Decide whether some bindings should be made into join points or not.</span><span>
</span><a name="line-2715"></a><span class="hs-comment">-- Returns `False` if they can't be join points. Note that it's an</span><span>
</span><a name="line-2716"></a><span class="hs-comment">-- all-or-nothing decision, as if multiple binders are given, they're</span><span>
</span><a name="line-2717"></a><span class="hs-comment">-- assumed to be mutually recursive.</span><span>
</span><a name="line-2718"></a><span class="hs-comment">--</span><span>
</span><a name="line-2719"></a><span class="hs-comment">-- It must, however, be a final decision. If we say &quot;True&quot; for 'f',</span><span>
</span><a name="line-2720"></a><span class="hs-comment">-- and then subsequently decide /not/ make 'f' into a join point, then</span><span>
</span><a name="line-2721"></a><span class="hs-comment">-- the decision about another binding 'g' might be invalidated if (say)</span><span>
</span><a name="line-2722"></a><span class="hs-comment">-- 'f' tail-calls 'g'.</span><span>
</span><a name="line-2723"></a><span class="hs-comment">--</span><span>
</span><a name="line-2724"></a><span class="hs-comment">-- See Note [Invariants on join points] in CoreSyn.</span><span>
</span><a name="line-2725"></a><span class="hs-identifier">decideJoinPointHood</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TopLevelFlag"><span class="hs-identifier hs-type">TopLevelFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="OccurAnal.html#UsageDetails"><span class="hs-identifier hs-type">UsageDetails</span></a><span>
</span><a name="line-2726"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span>
</span><a name="line-2727"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2728"></a><a name="decideJoinPointHood"><a href="OccurAnal.html#decideJoinPointHood"><span class="hs-identifier">decideJoinPointHood</span></a></a><span> </span><a href="BasicTypes.html#TopLevel"><span class="hs-identifier hs-var">TopLevel</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-2729"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2730"></a><span class="hs-identifier">decideJoinPointHood</span><span> </span><a href="BasicTypes.html#NotTopLevel"><span class="hs-identifier hs-var">NotTopLevel</span></a><span> </span><a name="local-6989586621684707479"><a href="#local-6989586621684707479"><span class="hs-identifier">usage</span></a></a><span> </span><a name="local-6989586621684707480"><a href="#local-6989586621684707480"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-2731"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><a href="#local-6989586621684707480"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2732"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-identifier">all_ok</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;OccurAnal failed to rediscover join point(s):&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span>
</span><a name="line-2733"></a><span>                       </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">bndrs</span><span class="hs-special">)</span><span>
</span><a name="line-2734"></a><span>    </span><a href="#local-6989586621684707481"><span class="hs-identifier hs-var">all_ok</span></a><span>
</span><a name="line-2735"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2736"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707481"><span class="hs-identifier hs-var">all_ok</span></a><span>
</span><a name="line-2737"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2738"></a><span>    </span><span class="hs-comment">-- See Note [Invariants on join points]; invariants cited by number below.</span><span>
</span><a name="line-2739"></a><span>    </span><span class="hs-comment">-- Invariant 2 is always satisfiable by the simplifier by eta expansion.</span><span>
</span><a name="line-2740"></a><span>    </span><a name="local-6989586621684707481"><a href="#local-6989586621684707481"><span class="hs-identifier">all_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Invariant 3: Either all are join points or none are</span><span>
</span><a name="line-2741"></a><span>             </span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621684707482"><span class="hs-identifier hs-var">ok</span></a><span> </span><a href="#local-6989586621684707480"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-2742"></a><span>
</span><a name="line-2743"></a><span>    </span><a name="local-6989586621684707482"><a href="#local-6989586621684707482"><span class="hs-identifier">ok</span></a></a><span> </span><a name="local-6989586621684707485"><a href="#local-6989586621684707485"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-2744"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- Invariant 1: Only tail calls, all same join arity</span><span>
</span><a name="line-2745"></a><span>        </span><a href="BasicTypes.html#AlwaysTailCalled"><span class="hs-identifier hs-var">AlwaysTailCalled</span></a><span> </span><a name="local-6989586621684707486"><a href="#local-6989586621684707486"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#lookupDetails"><span class="hs-identifier hs-var">lookupDetails</span></a><span> </span><a href="#local-6989586621684707479"><span class="hs-identifier hs-var">usage</span></a><span> </span><a href="#local-6989586621684707485"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2746"></a><span>
</span><a name="line-2747"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Invariant 1 as applied to LHSes of rules</span><span>
</span><a name="line-2748"></a><span>        </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684707483"><span class="hs-identifier hs-var">ok_rule</span></a><span> </span><a href="#local-6989586621684707486"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Id.html#idCoreRules"><span class="hs-identifier hs-var">idCoreRules</span></a><span> </span><a href="#local-6989586621684707485"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2749"></a><span>
</span><a name="line-2750"></a><span>        </span><span class="hs-comment">-- Invariant 2a: stable unfoldings</span><span>
</span><a name="line-2751"></a><span>        </span><span class="hs-comment">-- See Note [Join points and INLINE pragmas]</span><span>
</span><a name="line-2752"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684707484"><span class="hs-identifier hs-var">ok_unfolding</span></a><span> </span><a href="#local-6989586621684707486"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#realIdUnfolding"><span class="hs-identifier hs-var">realIdUnfolding</span></a><span> </span><a href="#local-6989586621684707485"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2753"></a><span>
</span><a name="line-2754"></a><span>        </span><span class="hs-comment">-- Invariant 4: Satisfies polymorphism rule</span><span>
</span><a name="line-2755"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Type.html#isValidJoinPointType"><span class="hs-identifier hs-var">isValidJoinPointType</span></a><span> </span><a href="#local-6989586621684707486"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621684707485"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2756"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2757"></a><span>
</span><a name="line-2758"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2759"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2760"></a><span>
</span><a name="line-2761"></a><span>    </span><a name="local-6989586621684707483"><a href="#local-6989586621684707483"><span class="hs-identifier">ok_rule</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- only possible with plugin shenanigans</span><span>
</span><a name="line-2762"></a><span>    </span><span class="hs-identifier">ok_rule</span><span> </span><a name="local-6989586621684707487"><a href="#local-6989586621684707487"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707488"><a href="#local-6989586621684707488"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2763"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707488"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707487"><span class="hs-identifier hs-var">join_arity</span></a><span>
</span><a name="line-2764"></a><span>        </span><span class="hs-comment">-- Invariant 1 as applied to LHSes of rules</span><span>
</span><a name="line-2765"></a><span>
</span><a name="line-2766"></a><span>    </span><span class="hs-comment">-- ok_unfolding returns False if we should /not/ convert a non-join-id</span><span>
</span><a name="line-2767"></a><span>    </span><span class="hs-comment">-- into a join-id, even though it is AlwaysTailCalled</span><span>
</span><a name="line-2768"></a><span>    </span><a name="local-6989586621684707484"><a href="#local-6989586621684707484"><span class="hs-identifier">ok_unfolding</span></a></a><span> </span><a name="local-6989586621684707489"><a href="#local-6989586621684707489"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707490"><a href="#local-6989586621684707490"><span class="hs-identifier">src</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707491"><a href="#local-6989586621684707491"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2769"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span> </span><a href="#local-6989586621684707490"><span class="hs-identifier hs-var">src</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684707489"><span class="hs-identifier hs-var">join_arity</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="CoreArity.html#joinRhsArity"><span class="hs-identifier hs-var">joinRhsArity</span></a><span> </span><a href="#local-6989586621684707491"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2770"></a><span>    </span><span class="hs-identifier">ok_unfolding</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2771"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2772"></a><span>    </span><span class="hs-identifier">ok_unfolding</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-2773"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2774"></a><span>
</span><a name="line-2775"></a><span class="hs-identifier">willBeJoinId_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BasicTypes.html#JoinArity"><span class="hs-identifier hs-type">JoinArity</span></a><span>
</span><a name="line-2776"></a><a name="willBeJoinId_maybe"><a href="OccurAnal.html#willBeJoinId_maybe"><span class="hs-identifier">willBeJoinId_maybe</span></a></a><span> </span><a name="local-6989586621684707492"><a href="#local-6989586621684707492"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-2777"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684707492"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2778"></a><span>      </span><a href="BasicTypes.html#AlwaysTailCalled"><span class="hs-identifier hs-var">AlwaysTailCalled</span></a><span> </span><a name="local-6989586621684707493"><a href="#local-6989586621684707493"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684707493"><span class="hs-identifier hs-var">arity</span></a><span>
</span><a name="line-2779"></a><span>      </span><span class="hs-identifier">_</span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Id.html#isJoinId_maybe"><span class="hs-identifier hs-var">isJoinId_maybe</span></a><span> </span><a href="#local-6989586621684707492"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-2780"></a><span>
</span><a name="line-2781"></a><span>
</span><a name="line-2782"></a><span class="hs-comment">{- Note [Join points and INLINE pragmas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
   f x = let g = \x. not  -- Arity 1
             {-# INLINE g #-}
         in case x of
              A -&gt; g True True
              B -&gt; g True False
              C -&gt; blah2

Here 'g' is always tail-called applied to 2 args, but the stable
unfolding captured by the INLINE pragma has arity 1.  If we try to
convert g to be a join point, its unfolding will still have arity 1
(since it is stable, and we don't meddle with stable unfoldings), and
Lint will complain (see Note [Invariants on join points], (2a), in
CoreSyn.  Trac #13413.

Moreover, since g is going to be inlined anyway, there is no benefit
from making it a join point.

If it is recursive, and uselessly marked INLINE, this will stop us
making it a join point, which is annoying.  But occasionally
(notably in class methods; see Note [Instances and loop breakers] in
TcInstDcls) we mark recursive things as INLINE but the recursion
unravels; so ignoring INLINE pragmas on recursive things isn't good
either.

See Invariant 2a of Note [Invariants on join points] in CoreSyn


************************************************************************
*                                                                      *
\subsection{Operations over OccInfo}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2818"></a><span>
</span><a name="line-2819"></a><span class="hs-identifier">markMany</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">markInsideLam</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">markNonTailCalled</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span>
</span><a name="line-2820"></a><span>
</span><a name="line-2821"></a><a name="markMany"><a href="OccurAnal.html#markMany"><span class="hs-identifier">markMany</span></a></a><span> </span><a href="BasicTypes.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a><span>
</span><a name="line-2822"></a><span class="hs-identifier">markMany</span><span> </span><a name="local-6989586621684707494"><a href="#local-6989586621684707494"><span class="hs-identifier">occ</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#ManyOccs"><span class="hs-identifier hs-var">ManyOccs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">occ_tail</span><span> </span><a href="#local-6989586621684707494"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2823"></a><span>
</span><a name="line-2824"></a><a name="markInsideLam"><a href="OccurAnal.html#markInsideLam"><span class="hs-identifier">markInsideLam</span></a></a><span> </span><a name="local-6989586621684707495"><a href="#local-6989586621684707495"><span class="hs-identifier">occ</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="BasicTypes.html#OneOcc"><span class="hs-identifier hs-var">OneOcc</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707495"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_in_lam</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2825"></a><span class="hs-identifier">markInsideLam</span><span> </span><a name="local-6989586621684707496"><a href="#local-6989586621684707496"><span class="hs-identifier">occ</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707496"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-2826"></a><span>
</span><a name="line-2827"></a><a name="markNonTailCalled"><a href="OccurAnal.html#markNonTailCalled"><span class="hs-identifier">markNonTailCalled</span></a></a><span> </span><a href="BasicTypes.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a><span>
</span><a name="line-2828"></a><span class="hs-identifier">markNonTailCalled</span><span> </span><a name="local-6989586621684707497"><a href="#local-6989586621684707497"><span class="hs-identifier">occ</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707497"><span class="hs-identifier hs-var">occ</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#NoTailCallInfo"><span class="hs-identifier hs-var">NoTailCallInfo</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2829"></a><span>
</span><a name="line-2830"></a><span class="hs-identifier">addOccInfo</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">orOccInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span>
</span><a name="line-2831"></a><span>
</span><a name="line-2832"></a><a name="addOccInfo"><a href="OccurAnal.html#addOccInfo"><span class="hs-identifier">addOccInfo</span></a></a><span> </span><a name="local-6989586621684707498"><a href="#local-6989586621684707498"><span class="hs-identifier">a1</span></a></a><span> </span><a name="local-6989586621684707499"><a href="#local-6989586621684707499"><span class="hs-identifier">a2</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isDeadOcc</span><span> </span><span class="hs-identifier hs-var">a1</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-identifier">isDeadOcc</span><span> </span><span class="hs-identifier">a2</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2833"></a><span>                    </span><a href="BasicTypes.html#ManyOccs"><span class="hs-identifier hs-var">ManyOccs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><a href="#local-6989586621684707498"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andTailCallInfo"><span class="hs-identifier hs-var">andTailCallInfo</span></a><span class="hs-special">`</span><span>
</span><a name="line-2834"></a><span>                                          </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><a href="#local-6989586621684707499"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2835"></a><span>                                </span><span class="hs-comment">-- Both branches are at least One</span><span>
</span><a name="line-2836"></a><span>                                </span><span class="hs-comment">-- (Argument is never IAmDead)</span><span>
</span><a name="line-2837"></a><span>
</span><a name="line-2838"></a><span class="hs-comment">-- (orOccInfo orig new) is used</span><span>
</span><a name="line-2839"></a><span class="hs-comment">-- when combining occurrence info from branches of a case</span><span>
</span><a name="line-2840"></a><span>
</span><a name="line-2841"></a><a name="orOccInfo"><a href="OccurAnal.html#orOccInfo"><span class="hs-identifier">orOccInfo</span></a></a><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#OneOcc"><span class="hs-identifier hs-var">OneOcc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_in_lam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707500"><a href="#local-6989586621684707500"><span class="hs-identifier">in_lam1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_int_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707501"><a href="#local-6989586621684707501"><span class="hs-identifier">int_cxt1</span></a></a><span>
</span><a name="line-2842"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_tail</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707502"><a href="#local-6989586621684707502"><span class="hs-identifier">tail1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2843"></a><span>          </span><span class="hs-special">(</span><a href="BasicTypes.html#OneOcc"><span class="hs-identifier hs-var">OneOcc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_in_lam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707503"><a href="#local-6989586621684707503"><span class="hs-identifier">in_lam2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_int_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707504"><a href="#local-6989586621684707504"><span class="hs-identifier">int_cxt2</span></a></a><span>
</span><a name="line-2844"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_tail</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684707505"><a href="#local-6989586621684707505"><span class="hs-identifier">tail2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2845"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#OneOcc"><span class="hs-identifier hs-var">OneOcc</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_one_br</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- False, because it occurs in both branches</span><span>
</span><a name="line-2846"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_in_lam</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707500"><span class="hs-identifier hs-var">in_lam1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684707503"><span class="hs-identifier hs-var">in_lam2</span></a><span>
</span><a name="line-2847"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_int_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707501"><span class="hs-identifier hs-var">int_cxt1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621684707504"><span class="hs-identifier hs-var">int_cxt2</span></a><span>
</span><a name="line-2848"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">occ_tail</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707502"><span class="hs-identifier hs-var">tail1</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andTailCallInfo"><span class="hs-identifier hs-var">andTailCallInfo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684707505"><span class="hs-identifier hs-var">tail2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2849"></a><span>
</span><a name="line-2850"></a><span class="hs-identifier">orOccInfo</span><span> </span><a name="local-6989586621684707506"><a href="#local-6989586621684707506"><span class="hs-identifier">a1</span></a></a><span> </span><a name="local-6989586621684707507"><a href="#local-6989586621684707507"><span class="hs-identifier">a2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isDeadOcc</span><span> </span><span class="hs-identifier hs-var">a1</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-identifier">isDeadOcc</span><span> </span><span class="hs-identifier">a2</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2851"></a><span>                  </span><a href="BasicTypes.html#ManyOccs"><span class="hs-identifier hs-var">ManyOccs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">occ_tail</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><a href="#local-6989586621684707506"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-special">`</span><a href="OccurAnal.html#andTailCallInfo"><span class="hs-identifier hs-var">andTailCallInfo</span></a><span class="hs-special">`</span><span>
</span><a name="line-2852"></a><span>                                        </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><a href="#local-6989586621684707507"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2853"></a><span>
</span><a name="line-2854"></a><span class="hs-identifier">andTailCallInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#TailCallInfo"><span class="hs-identifier hs-type">TailCallInfo</span></a><span>
</span><a name="line-2855"></a><a name="andTailCallInfo"><a href="OccurAnal.html#andTailCallInfo"><span class="hs-identifier">andTailCallInfo</span></a></a><span> </span><a name="local-6989586621684707508"><a href="#local-6989586621684707508"><span class="hs-identifier">info</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="BasicTypes.html#AlwaysTailCalled"><span class="hs-identifier hs-var">AlwaysTailCalled</span></a><span> </span><a name="local-6989586621684707509"><a href="#local-6989586621684707509"><span class="hs-identifier">arity1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#AlwaysTailCalled"><span class="hs-identifier hs-var">AlwaysTailCalled</span></a><span> </span><a name="local-6989586621684707510"><a href="#local-6989586621684707510"><span class="hs-identifier">arity2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2856"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684707509"><span class="hs-identifier hs-var">arity1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684707510"><span class="hs-identifier hs-var">arity2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684707508"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-2857"></a><span class="hs-identifier">andTailCallInfo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#NoTailCallInfo"><span class="hs-identifier hs-var">NoTailCallInfo</span></a><span>
</span><a name="line-2858"></a></pre></body></html>