<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes, CPP, MultiWayIf, FlexibleContexts, BangPatterns,
             ScopedTypeVariables #-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-comment">-- | Module for (a) type kinds and (b) type coercions,</span><span>
</span><a name="line-9"></a><span class="hs-comment">-- as used in System FC. See 'CoreSyn.Expr' for</span><span>
</span><a name="line-10"></a><span class="hs-comment">-- more on System FC and how coercions fit into it.</span><span>
</span><a name="line-11"></a><span class="hs-comment">--</span><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Coercion</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>        </span><span class="hs-comment">-- * Main data type</span><span>
</span><a name="line-14"></a><span>        </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionP"><span class="hs-identifier hs-type">CoercionP</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="TyCoRep.html#UnivCoProvenance"><span class="hs-identifier hs-type">UnivCoProvenance</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionHole"><span class="hs-identifier hs-type">CoercionHole</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#coHoleCoVar"><span class="hs-identifier hs-var">coHoleCoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#setCoHoleCoVar"><span class="hs-identifier hs-var">setCoHoleCoVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="BasicTypes.html#LeftOrRight"><span class="hs-identifier hs-type">LeftOrRight</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Coercion.html#ltRole"><span class="hs-identifier hs-var">ltRole</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>        </span><span class="hs-comment">-- ** Functions over coercions</span><span>
</span><a name="line-21"></a><span>        </span><a href="Coercion.html#coVarTypes"><span class="hs-identifier hs-var">coVarTypes</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#coVarKind"><span class="hs-identifier hs-var">coVarKind</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#coVarKindsTypesRole"><span class="hs-identifier hs-var">coVarKindsTypesRole</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#coercionKinds"><span class="hs-identifier hs-var">coercionKinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="Coercion.html#mkCoercionType"><span class="hs-identifier hs-var">mkCoercionType</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>        </span><span class="hs-comment">-- ** Constructing coercions</span><span>
</span><a name="line-27"></a><span>        </span><a href="Coercion.html#mkGReflCo"><span class="hs-identifier hs-var">mkGReflCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkCoVarCos"><span class="hs-identifier hs-var">mkCoVarCos</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="Coercion.html#mkAxInstCo"><span class="hs-identifier hs-var">mkAxInstCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkUnbranchedAxInstCo"><span class="hs-identifier hs-var">mkUnbranchedAxInstCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="Coercion.html#mkAxInstRHS"><span class="hs-identifier hs-var">mkAxInstRHS</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkUnbranchedAxInstRHS"><span class="hs-identifier hs-var">mkUnbranchedAxInstRHS</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="Coercion.html#mkAxInstLHS"><span class="hs-identifier hs-var">mkAxInstLHS</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkUnbranchedAxInstLHS"><span class="hs-identifier hs-var">mkUnbranchedAxInstLHS</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="Coercion.html#mkPiCo"><span class="hs-identifier hs-var">mkPiCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkPiCos"><span class="hs-identifier hs-var">mkPiCos</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkCoCast"><span class="hs-identifier hs-var">mkCoCast</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkTransMCo"><span class="hs-identifier hs-var">mkTransMCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#nthCoRole"><span class="hs-identifier hs-var">nthCoRole</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkLRCo"><span class="hs-identifier hs-var">mkLRCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>        </span><a href="Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkAppCos"><span class="hs-identifier hs-var">mkAppCos</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkForAllCos"><span class="hs-identifier hs-var">mkForAllCos</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkHomoForAllCos"><span class="hs-identifier hs-var">mkHomoForAllCos</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>        </span><a href="Coercion.html#mkPhantomCo"><span class="hs-identifier hs-var">mkPhantomCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="Coercion.html#mkUnsafeCo"><span class="hs-identifier hs-var">mkUnsafeCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkHoleCo"><span class="hs-identifier hs-var">mkHoleCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkSubCo"><span class="hs-identifier hs-var">mkSubCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="Coercion.html#mkAxiomInstCo"><span class="hs-identifier hs-var">mkAxiomInstCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-var">mkProofIrrelCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#maybeSubCo"><span class="hs-identifier hs-var">maybeSubCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkAxiomRuleCo"><span class="hs-identifier hs-var">mkAxiomRuleCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="Coercion.html#mkGReflRightCo"><span class="hs-identifier hs-var">mkGReflRightCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkGReflLeftCo"><span class="hs-identifier hs-var">mkGReflLeftCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#castCoercionKind"><span class="hs-identifier hs-var">castCoercionKind</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#castCoercionKindI"><span class="hs-identifier hs-var">castCoercionKindI</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>        </span><a href="Coercion.html#mkHeteroCoercionType"><span class="hs-identifier hs-var">mkHeteroCoercionType</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span>        </span><span class="hs-comment">-- ** Decomposition</span><span>
</span><a name="line-47"></a><span>        </span><a href="Coercion.html#instNewTyCon_maybe"><span class="hs-identifier hs-var">instNewTyCon_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span>        </span><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#NormaliseStepResult"><span class="hs-identifier hs-type">NormaliseStepResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Coercion.html#composeSteppers"><span class="hs-identifier hs-var">composeSteppers</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>        </span><a href="Coercion.html#mapStepResult"><span class="hs-identifier hs-var">mapStepResult</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#unwrapNewTypeStepper"><span class="hs-identifier hs-var">unwrapNewTypeStepper</span></a><span class="hs-special">,</span><span>
</span><a name="line-51"></a><span>        </span><a href="Coercion.html#topNormaliseNewType_maybe"><span class="hs-identifier hs-var">topNormaliseNewType_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#topNormaliseTypeX"><span class="hs-identifier hs-var">topNormaliseTypeX</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span>        </span><a href="Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#decomposePiCos"><span class="hs-identifier hs-var">decomposePiCos</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#getCoVar_maybe"><span class="hs-identifier hs-var">getCoVar_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>        </span><a href="Coercion.html#splitTyConAppCo_maybe"><span class="hs-identifier hs-var">splitTyConAppCo_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>        </span><a href="Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>        </span><a href="Coercion.html#splitFunCo_maybe"><span class="hs-identifier hs-var">splitFunCo_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>        </span><a href="Coercion.html#splitForAllCo_maybe"><span class="hs-identifier hs-var">splitForAllCo_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>        </span><a href="Coercion.html#splitForAllCo_ty_maybe"><span class="hs-identifier hs-var">splitForAllCo_ty_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#splitForAllCo_co_maybe"><span class="hs-identifier hs-var">splitForAllCo_co_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>        </span><a href="Coercion.html#nthRole"><span class="hs-identifier hs-var">nthRole</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#setNominalRole_maybe"><span class="hs-identifier hs-var">setNominalRole_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span>        </span><a href="BasicTypes.html#pickLR"><span class="hs-identifier hs-var">pickLR</span></a><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span>        </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#isGReflCo_maybe"><span class="hs-identifier hs-var">isGReflCo_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#isReflexiveCo"><span class="hs-identifier hs-var">isReflexiveCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#isReflexiveCo_maybe"><span class="hs-identifier hs-var">isReflexiveCo_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span>        </span><a href="Coercion.html#isReflCoVar_maybe"><span class="hs-identifier hs-var">isReflCoVar_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span>        </span><span class="hs-comment">-- ** Coercion variables</span><span>
</span><a name="line-68"></a><span>        </span><a href="Var.html#mkCoVar"><span class="hs-identifier hs-var">mkCoVar</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#coVarName"><span class="hs-identifier hs-var">coVarName</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#setCoVarName"><span class="hs-identifier hs-var">setCoVarName</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#setCoVarUnique"><span class="hs-identifier hs-var">setCoVarUnique</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>        </span><a href="Coercion.html#isCoVar_maybe"><span class="hs-identifier hs-var">isCoVar_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span>        </span><span class="hs-comment">-- ** Free variables</span><span>
</span><a name="line-72"></a><span>        </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCos"><span class="hs-identifier hs-var">tyCoVarsOfCos</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#coVarsOfCo"><span class="hs-identifier hs-var">coVarsOfCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>        </span><a href="TyCoRep.html#tyCoFVsOfCo"><span class="hs-identifier hs-var">tyCoFVsOfCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#tyCoFVsOfCos"><span class="hs-identifier hs-var">tyCoFVsOfCos</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCoDSet"><span class="hs-identifier hs-var">tyCoVarsOfCoDSet</span></a><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>        </span><a href="TyCoRep.html#coercionSize"><span class="hs-identifier hs-var">coercionSize</span></a><span class="hs-special">,</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span>        </span><span class="hs-comment">-- ** Substitution</span><span>
</span><a name="line-77"></a><span>        </span><a href="TyCoRep.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#emptyCvSubstEnv"><span class="hs-identifier hs-var">emptyCvSubstEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-78"></a><span>        </span><a href="TyCoRep.html#lookupCoVar"><span class="hs-identifier hs-var">lookupCoVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>        </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCos"><span class="hs-identifier hs-var">substCos</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCoVar"><span class="hs-identifier hs-var">substCoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCoVars"><span class="hs-identifier hs-var">substCoVars</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCoWith"><span class="hs-identifier hs-var">substCoWith</span></a><span class="hs-special">,</span><span>
</span><a name="line-80"></a><span>        </span><a href="TyCoRep.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span class="hs-special">,</span><span>
</span><a name="line-81"></a><span>        </span><a href="TyCoRep.html#extendTvSubstAndInScope"><span class="hs-identifier hs-var">extendTvSubstAndInScope</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#getCvSubstEnv"><span class="hs-identifier hs-var">getCvSubstEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>
</span><a name="line-83"></a><span>        </span><span class="hs-comment">-- ** Lifting</span><span>
</span><a name="line-84"></a><span>        </span><a href="Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#liftCoSubstTyVar"><span class="hs-identifier hs-var">liftCoSubstTyVar</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#liftCoSubstWith"><span class="hs-identifier hs-var">liftCoSubstWith</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#liftCoSubstWithEx"><span class="hs-identifier hs-var">liftCoSubstWithEx</span></a><span class="hs-special">,</span><span>
</span><a name="line-85"></a><span>        </span><a href="Coercion.html#emptyLiftingContext"><span class="hs-identifier hs-var">emptyLiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#extendLiftingContext"><span class="hs-identifier hs-var">extendLiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#extendLiftingContextAndInScope"><span class="hs-identifier hs-var">extendLiftingContextAndInScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-86"></a><span>        </span><a href="Coercion.html#liftCoSubstVarBndrUsing"><span class="hs-identifier hs-var">liftCoSubstVarBndrUsing</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#isMappedByLC"><span class="hs-identifier hs-var">isMappedByLC</span></a><span class="hs-special">,</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>        </span><a href="Coercion.html#mkSubstLiftingContext"><span class="hs-identifier hs-var">mkSubstLiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>        </span><a href="Coercion.html#substForAllCoBndrUsingLC"><span class="hs-identifier hs-var">substForAllCoBndrUsingLC</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#lcTCvSubst"><span class="hs-identifier hs-var">lcTCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#lcInScopeSet"><span class="hs-identifier hs-var">lcInScopeSet</span></a><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>        </span><a href="Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Coercion.html#liftEnvSubstLeft"><span class="hs-identifier hs-var">liftEnvSubstLeft</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#liftEnvSubstRight"><span class="hs-identifier hs-var">liftEnvSubstRight</span></a><span class="hs-special">,</span><span>
</span><a name="line-92"></a><span>        </span><a href="Coercion.html#substRightCo"><span class="hs-identifier hs-var">substRightCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#substLeftCo"><span class="hs-identifier hs-var">substLeftCo</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#swapLiftCoEnv"><span class="hs-identifier hs-var">swapLiftCoEnv</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#lcSubstLeft"><span class="hs-identifier hs-var">lcSubstLeft</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#lcSubstRight"><span class="hs-identifier hs-var">lcSubstRight</span></a><span class="hs-special">,</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>        </span><span class="hs-comment">-- ** Comparison</span><span>
</span><a name="line-95"></a><span>        </span><a href="Coercion.html#eqCoercion"><span class="hs-identifier hs-var">eqCoercion</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#eqCoercionX"><span class="hs-identifier hs-var">eqCoercionX</span></a><span class="hs-special">,</span><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span>        </span><span class="hs-comment">-- ** Forcing evaluation of coercions</span><span>
</span><a name="line-98"></a><span>        </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span>        </span><span class="hs-comment">-- * Pretty-printing</span><span>
</span><a name="line-101"></a><span>        </span><a href="TyCoRep.html#pprCo"><span class="hs-identifier hs-var">pprCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#pprParendCo"><span class="hs-identifier hs-var">pprParendCo</span></a><span class="hs-special">,</span><span>
</span><a name="line-102"></a><span>        </span><a href="Coercion.html#pprCoAxiom"><span class="hs-identifier hs-var">pprCoAxiom</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#pprCoAxBranch"><span class="hs-identifier hs-var">pprCoAxBranch</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#pprCoAxBranchLHS"><span class="hs-identifier hs-var">pprCoAxBranchLHS</span></a><span class="hs-special">,</span><span>
</span><a name="line-103"></a><span>        </span><a href="Coercion.html#pprCoAxBranchUser"><span class="hs-identifier hs-var">pprCoAxBranchUser</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#tidyCoAxBndrsForUser"><span class="hs-identifier hs-var">tidyCoAxBndrsForUser</span></a><span class="hs-special">,</span><span>
</span><a name="line-104"></a><span>        </span><a href="Coercion.html#etaExpandCoAxBranch"><span class="hs-identifier hs-var">etaExpandCoAxBranch</span></a><span class="hs-special">,</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span>        </span><span class="hs-comment">-- * Tidying</span><span>
</span><a name="line-107"></a><span>        </span><a href="TyCoRep.html#tidyCo"><span class="hs-identifier hs-var">tidyCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#tidyCos"><span class="hs-identifier hs-var">tidyCos</span></a><span class="hs-special">,</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>        </span><span class="hs-comment">-- * Other</span><span>
</span><a name="line-110"></a><span>        </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#buildCoercion"><span class="hs-identifier hs-var">buildCoercion</span></a><span class="hs-special">,</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span>        </span><a href="Coercion.html#simplifyArgsWorker"><span class="hs-identifier hs-var">simplifyArgsWorker</span></a><span>
</span><a name="line-113"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE</span><span> </span><span class="hs-pragma">#-}</span><span> </span><a href="ToIface.html"><span class="hs-identifier">ToIface</span></a><span> </span><span class="hs-special">(</span><a href="ToIface.html#toIfaceTyCon"><span class="hs-identifier hs-var">toIfaceTyCon</span></a><span class="hs-special">,</span><span> </span><a href="ToIface.html#tidyToIfaceTcArgs"><span class="hs-identifier hs-var">tidyToIfaceTcArgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span> </span><a href="IfaceType.html"><span class="hs-identifier">IfaceType</span></a><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><a href="TyCoRep.html"><span class="hs-identifier">TyCoRep</span></a><span>
</span><a name="line-123"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-124"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-125"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span>
</span><a name="line-126"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="OccName.html#varName"><span class="hs-identifier hs-var">varName</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-133"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-136"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span>
</span><a name="line-137"></a><span class="hs-keyword">import</span><span> </span><a href="TysPrim.html"><span class="hs-identifier">TysPrim</span></a><span>          </span><span class="hs-special">(</span><span> </span><a href="TysPrim.html#eqPhantPrimTyCon"><span class="hs-identifier hs-var">eqPhantPrimTyCon</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span class="hs-keyword">import</span><span> </span><a href="ListSetOps.html"><span class="hs-identifier">ListSetOps</span></a><span>
</span><a name="line-139"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-140"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-141"></a><span>
</span><a name="line-142"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Function</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">on</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-144"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">isDigit</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>
</span><a name="line-146"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
     -- The coercion arguments always *precisely* saturate
     -- arity of (that branch of) the CoAxiom.  If there are
     -- any left over, we use AppCo.  See
     -- See [Coercion axioms applied to coercions] in TyCoRep

\subsection{Coercion variables}
%*                                                                      *
%************************************************************************
-}</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-identifier">coVarName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-160"></a><a name="coVarName"><a href="Coercion.html#coVarName"><span class="hs-identifier">coVarName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">varName</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-identifier">setCoVarUnique</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span>
</span><a name="line-163"></a><a name="setCoVarUnique"><a href="Coercion.html#setCoVarUnique"><span class="hs-identifier">setCoVarUnique</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setVarUnique"><span class="hs-identifier hs-var">setVarUnique</span></a><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-identifier">setCoVarName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span>
</span><a name="line-166"></a><a name="setCoVarName"><a href="Coercion.html#setCoVarName"><span class="hs-identifier">setCoVarName</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setVarName"><span class="hs-identifier hs-var">setVarName</span></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
                   Pretty-printing CoAxioms
%*                                                                      *
%************************************************************************

Defined here to avoid module loops. CoAxiom is loaded very early on.

-}</span><span>
</span><a name="line-178"></a><span>
</span><a name="line-179"></a><span class="hs-identifier">etaExpandCoAxBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- Return the (tvs,lhs,rhs) after eta-expanding,</span><span>
</span><a name="line-181"></a><span class="hs-comment">-- to the way in which the axiom was originally written</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- See Note [Eta reduction for data families] in CoAxiom</span><span>
</span><a name="line-183"></a><a name="etaExpandCoAxBranch"><a href="Coercion.html#etaExpandCoAxBranch"><span class="hs-identifier">etaExpandCoAxBranch</span></a></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073059"><a href="#local-6989586621682073059"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-184"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_eta_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073060"><a href="#local-6989586621682073060"><span class="hs-identifier">eta_tvs</span></a></a><span>
</span><a name="line-185"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073061"><a href="#local-6989586621682073061"><span class="hs-identifier">lhs</span></a></a><span>
</span><a name="line-186"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073062"><a href="#local-6989586621682073062"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>  </span><span class="hs-comment">-- ToDo: what about eta_cvs?</span><span>
</span><a name="line-188"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073059"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682073060"><span class="hs-identifier hs-var">eta_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073061"><span class="hs-identifier hs-var">lhs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682073063"><span class="hs-identifier hs-var">eta_tys</span></a><span class="hs-special">,</span><span> </span><a href="Type.html#mkAppTys"><span class="hs-identifier hs-var">mkAppTys</span></a><span> </span><a href="#local-6989586621682073062"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621682073063"><span class="hs-identifier hs-var">eta_tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-190"></a><span>    </span><a name="local-6989586621682073063"><a href="#local-6989586621682073063"><span class="hs-identifier">eta_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-6989586621682073060"><span class="hs-identifier hs-var">eta_tvs</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-identifier">pprCoAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="#local-6989586621682073058"><span class="hs-identifier hs-type">br</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- Used in debug-printing only</span><span>
</span><a name="line-194"></a><a name="pprCoAxiom"><a href="Coercion.html#pprCoAxiom"><span class="hs-identifier">pprCoAxiom</span></a></a><span> </span><a name="local-6989586621682073064"><a href="#local-6989586621682073064"><span class="hs-identifier">ax</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-var">CoAxiom</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_tc</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073065"><a href="#local-6989586621682073065"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073066"><a href="#local-6989586621682073066"><span class="hs-identifier">branches</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;axiom&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073064"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#pprCoAxBranchUser"><span class="hs-identifier hs-var">pprCoAxBranchUser</span></a><span> </span><a href="#local-6989586621682073065"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#fromBranches"><span class="hs-identifier hs-var">fromBranches</span></a><span> </span><a href="#local-6989586621682073066"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-identifier">pprCoAxBranchUser</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-199"></a><span class="hs-comment">-- Used when printing injectivity errors (FamInst.makeInjectivityErrors)</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- and inaccessible branches (TcValidity.inaccessibleCoAxBranch)</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- This happens in error messages: don't print the RHS of a data</span><span>
</span><a name="line-202"></a><span class="hs-comment">--   family axiom, which is meaningless to a user</span><span>
</span><a name="line-203"></a><a name="pprCoAxBranchUser"><a href="Coercion.html#pprCoAxBranchUser"><span class="hs-identifier">pprCoAxBranchUser</span></a></a><span> </span><a name="local-6989586621682073067"><a href="#local-6989586621682073067"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073068"><a href="#local-6989586621682073068"><span class="hs-identifier">br</span></a></a><span>
</span><a name="line-204"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isDataFamilyTyCon"><span class="hs-identifier hs-var">isDataFamilyTyCon</span></a><span> </span><a href="#local-6989586621682073067"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#pprCoAxBranchLHS"><span class="hs-identifier hs-var">pprCoAxBranchLHS</span></a><span> </span><a href="#local-6989586621682073067"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073068"><span class="hs-identifier hs-var">br</span></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#pprCoAxBranch"><span class="hs-identifier hs-var">pprCoAxBranch</span></a><span>    </span><a href="#local-6989586621682073067"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073068"><span class="hs-identifier hs-var">br</span></a><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-identifier">pprCoAxBranchLHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-208"></a><span class="hs-comment">-- Print the family-instance equation when reporting</span><span>
</span><a name="line-209"></a><span class="hs-comment">--   a conflict between equations (FamInst.conflictInstErr)</span><span>
</span><a name="line-210"></a><span class="hs-comment">-- For type families the RHS is important; for data families not so.</span><span>
</span><a name="line-211"></a><span class="hs-comment">--   Indeed for data families the RHS is a mysterious internal</span><span>
</span><a name="line-212"></a><span class="hs-comment">--   type constructor, so we suppress it (Trac #14179)</span><span>
</span><a name="line-213"></a><span class="hs-comment">-- See FamInstEnv Note [Family instance overlap conflicts]</span><span>
</span><a name="line-214"></a><a name="pprCoAxBranchLHS"><a href="Coercion.html#pprCoAxBranchLHS"><span class="hs-identifier">pprCoAxBranchLHS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#ppr_co_ax_branch"><span class="hs-identifier hs-var">ppr_co_ax_branch</span></a><span> </span><a href="#local-6989586621682073069"><span class="hs-identifier hs-var">pp_rhs</span></a><span>
</span><a name="line-215"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-216"></a><span>    </span><a name="local-6989586621682073069"><a href="#local-6989586621682073069"><span class="hs-identifier">pp_rhs</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-identifier">pprCoAxBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-219"></a><a name="pprCoAxBranch"><a href="Coercion.html#pprCoAxBranch"><span class="hs-identifier">pprCoAxBranch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#ppr_co_ax_branch"><span class="hs-identifier hs-var">ppr_co_ax_branch</span></a><span> </span><a href="#local-6989586621682073070"><span class="hs-identifier hs-var">ppr_rhs</span></a><span>
</span><a name="line-220"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-221"></a><span>    </span><a name="local-6989586621682073070"><a href="#local-6989586621682073070"><span class="hs-identifier">ppr_rhs</span></a></a><span> </span><a name="local-6989586621682073071"><a href="#local-6989586621682073071"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682073072"><a href="#local-6989586621682073072"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#equals"><span class="hs-identifier hs-var">equals</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TyCoRep.html#pprPrecTypeX"><span class="hs-identifier hs-var">pprPrecTypeX</span></a><span> </span><a href="#local-6989586621682073071"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="BasicTypes.html#topPrec"><span class="hs-identifier hs-var">topPrec</span></a><span> </span><a href="#local-6989586621682073072"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-identifier">ppr_co_ax_branch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-225"></a><a name="ppr_co_ax_branch"><a href="Coercion.html#ppr_co_ax_branch"><span class="hs-identifier">ppr_co_ax_branch</span></a></a><span> </span><a name="local-6989586621682073073"><a href="#local-6989586621682073073"><span class="hs-identifier">ppr_rhs</span></a></a><span> </span><a name="local-6989586621682073074"><a href="#local-6989586621682073074"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621682073075"><a href="#local-6989586621682073075"><span class="hs-identifier">branch</span></a></a><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr1</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><a href="Outputable.html#hangNotEmpty"><span class="hs-identifier hs-var">hangNotEmpty</span></a><span> </span><span class="hs-number">2</span><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-special">[</span><span> </span><a href="TyCoRep.html#pprUserForAll"><span class="hs-identifier hs-var">pprUserForAll</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#mkTyCoVarBinders"><span class="hs-identifier hs-var">mkTyCoVarBinders</span></a><span> </span><a href="Var.html#Inferred"><span class="hs-identifier hs-var">Inferred</span></a><span> </span><a href="#local-6989586621682073083"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>         </span><span class="hs-comment">-- See Note [Printing foralls in type family instances] in IfaceType</span><span>
</span><a name="line-229"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073081"><span class="hs-identifier hs-var">pp_lhs</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621682073073"><span class="hs-identifier hs-var">ppr_rhs</span></a><span> </span><a href="#local-6989586621682073082"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621682073080"><span class="hs-identifier hs-var">ee_rhs</span></a><span>
</span><a name="line-230"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;-- Defined&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621682073077"><span class="hs-identifier hs-var">pp_loc</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-231"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-232"></a><span>    </span><a name="local-6989586621682073076"><a href="#local-6989586621682073076"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchSpan"><span class="hs-identifier hs-var">coAxBranchSpan</span></a><span> </span><a href="#local-6989586621682073075"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-233"></a><span>    </span><a name="local-6989586621682073077"><a href="#local-6989586621682073077"><span class="hs-identifier">pp_loc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="SrcLoc.html#isGoodSrcSpan"><span class="hs-identifier hs-var">isGoodSrcSpan</span></a><span> </span><a href="#local-6989586621682073076"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;at&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#srcSpanStart"><span class="hs-identifier hs-var">srcSpanStart</span></a><span> </span><a href="#local-6989586621682073076"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;in&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073076"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span>    </span><span class="hs-comment">-- Eta-expand LHS and RHS types, because sometimes data family</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-comment">-- instances are eta-reduced.</span><span>
</span><a name="line-238"></a><span>    </span><span class="hs-comment">-- See Note [Eta reduction for data families] in FamInstEnv.</span><span>
</span><a name="line-239"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073078"><a href="#local-6989586621682073078"><span class="hs-identifier">ee_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073079"><a href="#local-6989586621682073079"><span class="hs-identifier">ee_lhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073080"><a href="#local-6989586621682073080"><span class="hs-identifier">ee_rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#etaExpandCoAxBranch"><span class="hs-identifier hs-var">etaExpandCoAxBranch</span></a><span> </span><a href="#local-6989586621682073075"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span>    </span><a name="local-6989586621682073081"><a href="#local-6989586621682073081"><span class="hs-identifier">pp_lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IfaceType.html#pprIfaceTypeApp"><span class="hs-identifier hs-var">pprIfaceTypeApp</span></a><span> </span><a href="BasicTypes.html#topPrec"><span class="hs-identifier hs-var">topPrec</span></a><span> </span><span class="hs-special">(</span><a href="ToIface.html#toIfaceTyCon"><span class="hs-identifier hs-var">toIfaceTyCon</span></a><span> </span><a href="#local-6989586621682073074"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>                             </span><span class="hs-special">(</span><a href="ToIface.html#tidyToIfaceTcArgs"><span class="hs-identifier hs-var">tidyToIfaceTcArgs</span></a><span> </span><a href="#local-6989586621682073082"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621682073074"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621682073079"><span class="hs-identifier hs-var">ee_lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073082"><a href="#local-6989586621682073082"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073083"><a href="#local-6989586621682073083"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#tidyCoAxBndrsForUser"><span class="hs-identifier hs-var">tidyCoAxBndrsForUser</span></a><span> </span><a href="VarEnv.html#emptyTidyEnv"><span class="hs-identifier hs-var">emptyTidyEnv</span></a><span> </span><a href="#local-6989586621682073078"><span class="hs-identifier hs-var">ee_tvs</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-identifier">tidyCoAxBndrsForUser</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span class="hs-comment">-- Tidy wildcards &quot;_1&quot;, &quot;_2&quot; to &quot;_&quot;, and do not return them</span><span>
</span><a name="line-248"></a><span class="hs-comment">-- in the list of binders to be printed</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- This is so that in error messages we see</span><span>
</span><a name="line-250"></a><span class="hs-comment">--     forall a. F _ [a] _ = ...</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- rather than</span><span>
</span><a name="line-252"></a><span class="hs-comment">--     forall a _1 _2. F _1 [a] _2 = ...</span><span>
</span><a name="line-253"></a><span class="hs-comment">--</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- This is a rather disgusting function</span><span>
</span><a name="line-255"></a><a name="tidyCoAxBndrsForUser"><a href="Coercion.html#tidyCoAxBndrsForUser"><span class="hs-identifier">tidyCoAxBndrsForUser</span></a></a><span> </span><a name="local-6989586621682073084"><a href="#local-6989586621682073084"><span class="hs-identifier">init_env</span></a></a><span> </span><a name="local-6989586621682073085"><a href="#local-6989586621682073085"><span class="hs-identifier">tcvs</span></a></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073086"><span class="hs-identifier hs-var">tidy_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682073087"><span class="hs-identifier hs-var">tidy_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-258"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073086"><a href="#local-6989586621682073086"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073087"><a href="#local-6989586621682073087"><span class="hs-identifier">tidy_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><a href="#local-6989586621682073088"><span class="hs-identifier hs-var">tidy_one</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073084"><span class="hs-identifier hs-var">init_env</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073085"><span class="hs-identifier hs-var">tcvs</span></a><span>
</span><a name="line-259"></a><span>
</span><a name="line-260"></a><span>    </span><a name="local-6989586621682073088"><a href="#local-6989586621682073088"><span class="hs-identifier">tidy_one</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682073090"><a href="#local-6989586621682073090"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621682073091"><a href="#local-6989586621682073091"><span class="hs-identifier">occ_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073092"><a href="#local-6989586621682073092"><span class="hs-identifier">subst</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682073093"><a href="#local-6989586621682073093"><span class="hs-identifier">rev_bndrs'</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073094"><a href="#local-6989586621682073094"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-261"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073089"><span class="hs-identifier hs-var">is_wildcard</span></a><span> </span><a href="#local-6989586621682073094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073097"><span class="hs-identifier hs-var">env_wild</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073093"><span class="hs-identifier hs-var">rev_bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073095"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span>     </span><a href="#local-6989586621682073096"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682073093"><span class="hs-identifier hs-var">rev_bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-263"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-264"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682073095"><a href="#local-6989586621682073095"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073096"><a href="#local-6989586621682073096"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyVarBndr"><span class="hs-identifier hs-var">tidyVarBndr</span></a><span> </span><a href="#local-6989586621682073090"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682073094"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-265"></a><span>        </span><a name="local-6989586621682073097"><a href="#local-6989586621682073097"><span class="hs-identifier">env_wild</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073091"><span class="hs-identifier hs-var">occ_env</span></a><span class="hs-special">,</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621682073092"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><a href="#local-6989586621682073098"><span class="hs-identifier hs-var">wild_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>        </span><a name="local-6989586621682073098"><a href="#local-6989586621682073098"><span class="hs-identifier">wild_bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setVarName"><span class="hs-identifier hs-var">setVarName</span></a><span> </span><a href="#local-6989586621682073094"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-267"></a><span>                    </span><a href="Name.html#tidyNameOcc"><span class="hs-identifier hs-var">tidyNameOcc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varName</span><span> </span><a href="#local-6989586621682073094"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="OccName.html#mkTyVarOcc"><span class="hs-identifier hs-var">mkTyVarOcc</span></a><span> </span><span class="hs-string">&quot;_&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>                    </span><span class="hs-comment">-- Tidy the binder to &quot;_&quot;</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span>    </span><span class="hs-identifier">is_wildcard</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-271"></a><span>    </span><a name="local-6989586621682073089"><a href="#local-6989586621682073089"><span class="hs-identifier">is_wildcard</span></a></a><span> </span><a name="local-6989586621682073099"><a href="#local-6989586621682073099"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccName.html#occNameString"><span class="hs-identifier hs-var">occNameString</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a><span> </span><a href="#local-6989586621682073099"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-272"></a><span>                       </span><span class="hs-special">(</span><span class="hs-char">'_'</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682073100"><a href="#local-6989586621682073100"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isDigit</span><span> </span><a href="#local-6989586621682073100"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-273"></a><span>                       </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
        Destructing coercions
%*                                                                      *
%************************************************************************

Note [Function coercions]
~~~~~~~~~~~~~~~~~~~~~~~~~
Remember that
  (-&gt;) :: forall r1 r2. TYPE r1 -&gt; TYPE r2 -&gt; TYPE LiftedRep

Hence
  FunCo r co1 co2 :: (s1-&gt;t1) ~r (s2-&gt;t2)
is short for
  TyConAppCo (-&gt;) co_rep1 co_rep2 co1 co2
where co_rep1, co_rep2 are the coercions on the representations.
-}</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-comment">-- | This breaks a 'Coercion' with type @T A B C ~ T D E F@ into</span><span>
</span><a name="line-296"></a><span class="hs-comment">-- a list of 'Coercion's of kinds @A ~ D@, @B ~ E@ and @E ~ F@. Hence:</span><span>
</span><a name="line-297"></a><span class="hs-comment">--</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- &gt; decomposeCo 3 c [r1, r2, r3] = [nth r1 0 c, nth r2 1 c, nth r3 2 c]</span><span>
</span><a name="line-299"></a><span class="hs-identifier">decomposeCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-300"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- the roles of the output coercions</span><span>
</span><a name="line-301"></a><span>                       </span><span class="hs-comment">-- this must have at least as many</span><span>
</span><a name="line-302"></a><span>                       </span><span class="hs-comment">-- entries as the Arity provided</span><span>
</span><a name="line-303"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-304"></a><a name="decomposeCo"><a href="Coercion.html#decomposeCo"><span class="hs-identifier">decomposeCo</span></a></a><span> </span><a name="local-6989586621682073101"><a href="#local-6989586621682073101"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621682073102"><a href="#local-6989586621682073102"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073103"><a href="#local-6989586621682073103"><span class="hs-identifier">rs</span></a></a><span>
</span><a name="line-305"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-6989586621682073105"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073104"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682073102"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073104"><a href="#local-6989586621682073104"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><a name="local-6989586621682073105"><a href="#local-6989586621682073105"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="hs-number">0</span><span class="hs-glyph">..</span><span class="hs-special">(</span><a href="#local-6989586621682073101"><span class="hs-identifier hs-var">arity</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073103"><span class="hs-identifier hs-var">rs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-306"></a><span>           </span><span class="hs-comment">-- Remember, Nth is zero-indexed</span><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span class="hs-identifier">decomposeFunCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Util.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a><span>
</span><a name="line-309"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>      </span><span class="hs-comment">-- Role of the input coercion</span><span>
</span><a name="line-310"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>  </span><span class="hs-comment">-- Input coercion</span><span>
</span><a name="line-311"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span class="hs-comment">-- Expects co :: (s1 -&gt; t1) ~ (s2 -&gt; t2)</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- Returns (co1 :: s1~s2, co2 :: t1~t2)</span><span>
</span><a name="line-314"></a><span class="hs-comment">-- See Note [Function coercions] for the &quot;2&quot; and &quot;3&quot;</span><span>
</span><a name="line-315"></a><a name="decomposeFunCo"><a href="Coercion.html#decomposeFunCo"><span class="hs-identifier">decomposeFunCo</span></a></a><span> </span><a name="local-6989586621682073106"><a href="#local-6989586621682073106"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073107"><a href="#local-6989586621682073107"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">all_ok</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">co</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>                      </span><span class="hs-special">(</span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-6989586621682073106"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621682073107"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-6989586621682073106"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621682073107"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-318"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073108"><a href="#local-6989586621682073108"><span class="hs-identifier">s1t1</span></a></a><span> </span><a name="local-6989586621682073109"><a href="#local-6989586621682073109"><span class="hs-identifier">s2t2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073107"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-319"></a><span>    </span><a name="local-6989586621682073110"><a href="#local-6989586621682073110"><span class="hs-identifier">all_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a><span> </span><a href="#local-6989586621682073108"><span class="hs-identifier hs-var">s1t1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a><span> </span><a href="#local-6989586621682073109"><span class="hs-identifier hs-var">s2t2</span></a><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-comment">{- Note [Pushing a coercion into a pi-type]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have this:
    (f |&gt; co) t1 .. tn
Then we want to push the coercion into the arguments, so as to make
progress. For example of why you might want to do so, see Note
[Respecting definitional equality] in TyCoRep.

This is done by decomposePiCos.  Specifically, if
    decomposePiCos co [t1,..,tn] = ([co1,...,cok], cor)
then
    (f |&gt; co) t1 .. tn   =   (f (t1 |&gt; co1) ... (tk |&gt; cok)) |&gt; cor) t(k+1) ... tn

Notes:

* k can be smaller than n! That is decomposePiCos can return *fewer*
  coercions than there are arguments (ie k &lt; n), if the kind provided
  doesn't have enough binders.

* If there is a type error, we might see
       (f |&gt; co) t1
  where co :: (forall a. ty) ~ (ty1 -&gt; ty2)
  Here 'co' is insoluble, but we don't want to crash in decoposePiCos.
  So decomposePiCos carefully tests both sides of the coercion to check
  they are both foralls or both arrows.  Not doing this caused Trac #15343.
-}</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-identifier">decomposePiCos</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Util.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a><span>
</span><a name="line-349"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>  </span><span class="hs-comment">-- Coercion and its kind</span><span>
</span><a name="line-350"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-351"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span class="hs-comment">-- See Note [Pushing a coercion into a pi-type]</span><span>
</span><a name="line-353"></a><a name="decomposePiCos"><a href="Coercion.html#decomposePiCos"><span class="hs-identifier">decomposePiCos</span></a></a><span> </span><a name="local-6989586621682073111"><a href="#local-6989586621682073111"><span class="hs-identifier">orig_co</span></a></a><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073112"><a href="#local-6989586621682073112"><span class="hs-identifier">orig_k1</span></a></a><span> </span><a name="local-6989586621682073113"><a href="#local-6989586621682073113"><span class="hs-identifier">orig_k2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073114"><a href="#local-6989586621682073114"><span class="hs-identifier">orig_args</span></a></a><span>
</span><a name="line-354"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073116"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073115"><span class="hs-identifier hs-var">orig_subst</span></a><span class="hs-special">,</span><a href="#local-6989586621682073112"><span class="hs-identifier hs-var">orig_k1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073111"><span class="hs-identifier hs-var">orig_co</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073115"><span class="hs-identifier hs-var">orig_subst</span></a><span class="hs-special">,</span><a href="#local-6989586621682073113"><span class="hs-identifier hs-var">orig_k2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073114"><span class="hs-identifier hs-var">orig_args</span></a><span>
</span><a name="line-355"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-356"></a><span>    </span><a name="local-6989586621682073115"><a href="#local-6989586621682073115"><span class="hs-identifier">orig_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-357"></a><span>                 </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-6989586621682073114"><span class="hs-identifier hs-var">orig_args</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-6989586621682073111"><span class="hs-identifier hs-var">orig_co</span></a><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- accumulator for argument coercions, reversed</span><span>
</span><a name="line-360"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Lhs kind of coercion</span><span>
</span><a name="line-361"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>        </span><span class="hs-comment">-- coercion originally applied to the function</span><span>
</span><a name="line-362"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Rhs kind of coercion</span><span>
</span><a name="line-363"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Arguments to that function</span><span>
</span><a name="line-364"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-comment">-- Invariant:  co :: subst1(k2) ~ subst2(k2)</span><span>
</span><a name="line-366"></a><span>
</span><a name="line-367"></a><span>    </span><a name="local-6989586621682073116"><a href="#local-6989586621682073116"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682073117"><a href="#local-6989586621682073117"><span class="hs-identifier">acc_arg_cos</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682073118"><a href="#local-6989586621682073118"><span class="hs-identifier">subst1</span></a></a><span class="hs-special">,</span><a name="local-6989586621682073119"><a href="#local-6989586621682073119"><span class="hs-identifier">k1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073120"><a href="#local-6989586621682073120"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682073121"><a href="#local-6989586621682073121"><span class="hs-identifier">subst2</span></a></a><span class="hs-special">,</span><a name="local-6989586621682073122"><a href="#local-6989586621682073122"><span class="hs-identifier">k2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073123"><a href="#local-6989586621682073123"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682073124"><a href="#local-6989586621682073124"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073125"><a href="#local-6989586621682073125"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073126"><a href="#local-6989586621682073126"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-6989586621682073119"><span class="hs-identifier hs-var">k1</span></a><span>
</span><a name="line-369"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073127"><a href="#local-6989586621682073127"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073128"><a href="#local-6989586621682073128"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-6989586621682073122"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-370"></a><span>        </span><span class="hs-comment">-- know     co :: (forall a:s1.t1) ~ (forall b:s2.t2)</span><span>
</span><a name="line-371"></a><span>        </span><span class="hs-comment">--    function :: forall a:s1.t1   (the function is not passed to decomposePiCos)</span><span>
</span><a name="line-372"></a><span>        </span><span class="hs-comment">--           a :: s1</span><span>
</span><a name="line-373"></a><span>        </span><span class="hs-comment">--           b :: s2</span><span>
</span><a name="line-374"></a><span>        </span><span class="hs-comment">--          ty :: s2</span><span>
</span><a name="line-375"></a><span>        </span><span class="hs-comment">-- need arg_co :: s2 ~ s1</span><span>
</span><a name="line-376"></a><span>        </span><span class="hs-comment">--      res_co :: t1[ty |&gt; arg_co / a] ~ t2[ty / b]</span><span>
</span><a name="line-377"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073129"><a href="#local-6989586621682073129"><span class="hs-identifier">arg_co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682073120"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>            </span><a name="local-6989586621682073130"><a href="#local-6989586621682073130"><span class="hs-identifier">res_co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a><span> </span><a href="#local-6989586621682073120"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkGReflLeftCo"><span class="hs-identifier hs-var">mkGReflLeftCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073123"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682073129"><span class="hs-identifier hs-var">arg_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-379"></a><span>            </span><a name="local-6989586621682073131"><a href="#local-6989586621682073131"><span class="hs-identifier">subst1'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendTCvSubst"><span class="hs-identifier hs-var">extendTCvSubst</span></a><span> </span><a href="#local-6989586621682073118"><span class="hs-identifier hs-var">subst1</span></a><span> </span><a href="#local-6989586621682073125"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073123"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073129"><span class="hs-identifier hs-var">arg_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-380"></a><span>            </span><a name="local-6989586621682073132"><a href="#local-6989586621682073132"><span class="hs-identifier">subst2'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendTCvSubst"><span class="hs-identifier hs-var">extendTCvSubst</span></a><span> </span><a href="#local-6989586621682073121"><span class="hs-identifier hs-var">subst2</span></a><span> </span><a href="#local-6989586621682073127"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621682073123"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-381"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-382"></a><span>        </span><a href="#local-6989586621682073116"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073129"><span class="hs-identifier hs-var">arg_co</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682073117"><span class="hs-identifier hs-var">acc_arg_cos</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073131"><span class="hs-identifier hs-var">subst1'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073126"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073130"><span class="hs-identifier hs-var">res_co</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073132"><span class="hs-identifier hs-var">subst2'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073128"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073124"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073133"><a href="#local-6989586621682073133"><span class="hs-identifier">_s1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073134"><a href="#local-6989586621682073134"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a><span> </span><a href="#local-6989586621682073119"><span class="hs-identifier hs-var">k1</span></a><span>
</span><a name="line-385"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073135"><a href="#local-6989586621682073135"><span class="hs-identifier">_s2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073136"><a href="#local-6989586621682073136"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a><span> </span><a href="#local-6989586621682073122"><span class="hs-identifier hs-var">k2</span></a><span>
</span><a name="line-386"></a><span>        </span><span class="hs-comment">-- know     co :: (s1 -&gt; t1) ~ (s2 -&gt; t2)</span><span>
</span><a name="line-387"></a><span>        </span><span class="hs-comment">--    function :: s1 -&gt; t1</span><span>
</span><a name="line-388"></a><span>        </span><span class="hs-comment">--          ty :: s2</span><span>
</span><a name="line-389"></a><span>        </span><span class="hs-comment">-- need arg_co :: s2 ~ s1</span><span>
</span><a name="line-390"></a><span>        </span><span class="hs-comment">--      res_co :: t1 ~ t2</span><span>
</span><a name="line-391"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073137"><a href="#local-6989586621682073137"><span class="hs-identifier">sym_arg_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073138"><a href="#local-6989586621682073138"><span class="hs-identifier">res_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073120"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-392"></a><span>            </span><a name="local-6989586621682073139"><a href="#local-6989586621682073139"><span class="hs-identifier">arg_co</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682073137"><span class="hs-identifier hs-var">sym_arg_co</span></a><span>
</span><a name="line-393"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-394"></a><span>        </span><a href="#local-6989586621682073116"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073139"><span class="hs-identifier hs-var">arg_co</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682073117"><span class="hs-identifier hs-var">acc_arg_cos</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073118"><span class="hs-identifier hs-var">subst1</span></a><span class="hs-special">,</span><a href="#local-6989586621682073134"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073138"><span class="hs-identifier hs-var">res_co</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073121"><span class="hs-identifier hs-var">subst2</span></a><span class="hs-special">,</span><a href="#local-6989586621682073136"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073124"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#isEmptyTCvSubst"><span class="hs-identifier hs-var">isEmptyTCvSubst</span></a><span> </span><a href="#local-6989586621682073118"><span class="hs-identifier hs-var">subst1</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#isEmptyTCvSubst"><span class="hs-identifier hs-var">isEmptyTCvSubst</span></a><span> </span><a href="#local-6989586621682073121"><span class="hs-identifier hs-var">subst2</span></a><span class="hs-special">)</span><span>
</span><a name="line-397"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073116"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073117"><span class="hs-identifier hs-var">acc_arg_cos</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#zapTCvSubst"><span class="hs-identifier hs-var">zapTCvSubst</span></a><span> </span><a href="#local-6989586621682073118"><span class="hs-identifier hs-var">subst1</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621682073118"><span class="hs-identifier hs-var">subst1</span></a><span> </span><a href="#local-6989586621682073119"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>                       </span><a href="#local-6989586621682073120"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-399"></a><span>                       </span><span class="hs-special">(</span><a href="TyCoRep.html#zapTCvSubst"><span class="hs-identifier hs-var">zapTCvSubst</span></a><span> </span><a href="#local-6989586621682073121"><span class="hs-identifier hs-var">subst2</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621682073118"><span class="hs-identifier hs-var">subst1</span></a><span> </span><a href="#local-6989586621682073122"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-400"></a><span>                       </span><span class="hs-special">(</span><a href="#local-6989586621682073123"><span class="hs-identifier hs-var">ty</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682073124"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span>      </span><span class="hs-comment">-- tys might not be empty, if the left-hand type of the original coercion</span><span>
</span><a name="line-403"></a><span>      </span><span class="hs-comment">-- didn't have enough binders</span><span>
</span><a name="line-404"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073140"><a href="#local-6989586621682073140"><span class="hs-identifier">acc_arg_cos</span></a></a><span> </span><a name="local-6989586621682073141"><a href="#local-6989586621682073141"><span class="hs-identifier">_ki1</span></a></a><span> </span><a name="local-6989586621682073142"><a href="#local-6989586621682073142"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073143"><a href="#local-6989586621682073143"><span class="hs-identifier">_ki2</span></a></a><span> </span><a name="local-6989586621682073144"><a href="#local-6989586621682073144"><span class="hs-identifier">_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682073140"><span class="hs-identifier hs-var">acc_arg_cos</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073142"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span class="hs-comment">-- | Attempts to obtain the type variable underlying a 'Coercion'</span><span>
</span><a name="line-407"></a><span class="hs-identifier">getCoVar_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span>
</span><a name="line-408"></a><a name="getCoVar_maybe"><a href="Coercion.html#getCoVar_maybe"><span class="hs-identifier">getCoVar_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a name="local-6989586621682073145"><a href="#local-6989586621682073145"><span class="hs-identifier">cv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682073145"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-409"></a><span class="hs-identifier">getCoVar_maybe</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span class="hs-comment">-- | Attempts to tease a coercion apart into a type constructor and the application</span><span>
</span><a name="line-412"></a><span class="hs-comment">-- of a number of coercion arguments to that constructor</span><span>
</span><a name="line-413"></a><span class="hs-identifier">splitTyConAppCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-414"></a><a name="splitTyConAppCo_maybe"><a href="Coercion.html#splitTyConAppCo_maybe"><span class="hs-identifier">splitTyConAppCo_maybe</span></a></a><span> </span><a name="local-6989586621682073146"><a href="#local-6989586621682073146"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-415"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073147"><a href="#local-6989586621682073147"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073148"><a href="#local-6989586621682073148"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073146"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-416"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073149"><a href="#local-6989586621682073149"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073150"><a href="#local-6989586621682073150"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682073147"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-417"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073151"><a href="#local-6989586621682073151"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a><span> </span><a href="#local-6989586621682073148"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073149"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073150"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-418"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073149"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073151"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-419"></a><span class="hs-identifier">splitTyConAppCo_maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073152"><a href="#local-6989586621682073152"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073153"><a href="#local-6989586621682073153"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073152"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073153"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span class="hs-identifier">splitTyConAppCo_maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073154"><a href="#local-6989586621682073154"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621682073155"><a href="#local-6989586621682073155"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="TysPrim.html#funTyCon"><span class="hs-identifier hs-var">funTyCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073156"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682073156"><a href="#local-6989586621682073156"><span class="hs-identifier">cos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Coercion.html#mkRuntimeRepCo"><span class="hs-identifier hs-var">mkRuntimeRepCo</span></a><span> </span><a href="#local-6989586621682073154"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkRuntimeRepCo"><span class="hs-identifier hs-var">mkRuntimeRepCo</span></a><span> </span><a href="#local-6989586621682073155"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073154"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073155"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">]</span><span>
</span><a name="line-422"></a><span class="hs-identifier">splitTyConAppCo_maybe</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-423"></a><span>
</span><a name="line-424"></a><span class="hs-comment">-- first result has role equal to input; third result is Nominal</span><span>
</span><a name="line-425"></a><span class="hs-identifier">splitAppCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span class="hs-comment">-- ^ Attempt to take a coercion application apart.</span><span>
</span><a name="line-427"></a><a name="splitAppCo_maybe"><a href="Coercion.html#splitAppCo_maybe"><span class="hs-identifier">splitAppCo_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-6989586621682073157"><a href="#local-6989586621682073157"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073158"><a href="#local-6989586621682073158"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073157"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073158"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-428"></a><span class="hs-identifier">splitAppCo_maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-6989586621682073159"><a href="#local-6989586621682073159"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073160"><a href="#local-6989586621682073160"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073161"><a href="#local-6989586621682073161"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073161"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthExceeds"><span class="hs-identifier hs-var">lengthExceeds</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621682073160"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-430"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073162"><a href="#local-6989586621682073162"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073163"><a href="#local-6989586621682073163"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Util.html#snocView"><span class="hs-identifier hs-var">snocView</span></a><span> </span><a href="#local-6989586621682073161"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-431"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-6989586621682073159"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073160"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073162"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073163"><span class="hs-identifier hs-var">arg'</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#mightBeUnsaturatedTyCon"><span class="hs-identifier hs-var">mightBeUnsaturatedTyCon</span></a><span> </span><a href="#local-6989586621682073160"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-434"></a><span>    </span><span class="hs-comment">-- Never create unsaturated type family apps!</span><span>
</span><a name="line-435"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073164"><a href="#local-6989586621682073164"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073165"><a href="#local-6989586621682073165"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Util.html#snocView"><span class="hs-identifier hs-var">snocView</span></a><span> </span><a href="#local-6989586621682073161"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-436"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073166"><a href="#local-6989586621682073166"><span class="hs-identifier">arg''</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#setNominalRole_maybe"><span class="hs-identifier hs-var">setNominalRole_maybe</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#nthRole"><span class="hs-identifier hs-var">nthRole</span></a><span> </span><a href="#local-6989586621682073159"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073160"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682073164"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073165"><span class="hs-identifier hs-var">arg'</span></a><span>
</span><a name="line-437"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-6989586621682073159"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073160"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073164"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073166"><span class="hs-identifier hs-var">arg''</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-438"></a><span>       </span><span class="hs-comment">-- Use mkTyConAppCo to preserve the invariant</span><span>
</span><a name="line-439"></a><span>       </span><span class="hs-comment">--  that identity coercions are always represented by Refl</span><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span class="hs-identifier">splitAppCo_maybe</span><span> </span><a name="local-6989586621682073167"><a href="#local-6989586621682073167"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-442"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073168"><a href="#local-6989586621682073168"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073169"><a href="#local-6989586621682073169"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073167"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-443"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073170"><a href="#local-6989586621682073170"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073171"><a href="#local-6989586621682073171"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitAppTy_maybe"><span class="hs-identifier hs-var">splitAppTy_maybe</span></a><span> </span><a href="#local-6989586621682073168"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-444"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073169"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073170"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-6989586621682073171"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-445"></a><span class="hs-identifier">splitAppCo_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-446"></a><span>
</span><a name="line-447"></a><span class="hs-identifier">splitFunCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-448"></a><a name="splitFunCo_maybe"><a href="Coercion.html#splitFunCo_maybe"><span class="hs-identifier">splitFunCo_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073172"><a href="#local-6989586621682073172"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621682073173"><a href="#local-6989586621682073173"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073172"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073173"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span class="hs-identifier">splitFunCo_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-450"></a><span>
</span><a name="line-451"></a><span class="hs-identifier">splitForAllCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-452"></a><a name="splitForAllCo_maybe"><a href="Coercion.html#splitForAllCo_maybe"><span class="hs-identifier">splitForAllCo_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073174"><a href="#local-6989586621682073174"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682073175"><a href="#local-6989586621682073175"><span class="hs-identifier">k_co</span></a></a><span> </span><a name="local-6989586621682073176"><a href="#local-6989586621682073176"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073174"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073175"><span class="hs-identifier hs-var">k_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073176"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-453"></a><span class="hs-identifier">splitForAllCo_maybe</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-comment">-- | Like 'splitForAllCo_maybe', but only returns Just for tyvar binder</span><span>
</span><a name="line-456"></a><span class="hs-identifier">splitForAllCo_ty_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-457"></a><a name="splitForAllCo_ty_maybe"><a href="Coercion.html#splitForAllCo_ty_maybe"><span class="hs-identifier">splitForAllCo_ty_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073177"><a href="#local-6989586621682073177"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682073178"><a href="#local-6989586621682073178"><span class="hs-identifier">k_co</span></a></a><span> </span><a name="local-6989586621682073179"><a href="#local-6989586621682073179"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-458"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682073177"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073177"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073178"><span class="hs-identifier hs-var">k_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073179"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span class="hs-identifier">splitForAllCo_ty_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-460"></a><span>
</span><a name="line-461"></a><span class="hs-comment">-- | Like 'splitForAllCo_maybe', but only returns Just for covar binder</span><span>
</span><a name="line-462"></a><span class="hs-identifier">splitForAllCo_co_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><a name="splitForAllCo_co_maybe"><a href="Coercion.html#splitForAllCo_co_maybe"><span class="hs-identifier">splitForAllCo_co_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073180"><a href="#local-6989586621682073180"><span class="hs-identifier">cv</span></a></a><span> </span><a name="local-6989586621682073181"><a href="#local-6989586621682073181"><span class="hs-identifier">k_co</span></a></a><span> </span><a name="local-6989586621682073182"><a href="#local-6989586621682073182"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621682073180"><span class="hs-identifier hs-var">cv</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073180"><span class="hs-identifier hs-var">cv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073181"><span class="hs-identifier hs-var">k_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073182"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-465"></a><span class="hs-identifier">splitForAllCo_co_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-466"></a><span>
</span><a name="line-467"></a><span class="hs-comment">-------------------------------------------------------</span><span>
</span><a name="line-468"></a><span class="hs-comment">-- and some coercion kind stuff</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-identifier">coVarTypes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Util.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-471"></a><a name="coVarTypes"><a href="Coercion.html#coVarTypes"><span class="hs-identifier">coVarTypes</span></a></a><span> </span><a name="local-6989586621682073183"><a href="#local-6989586621682073183"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-472"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682073184"><a href="#local-6989586621682073184"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073185"><a href="#local-6989586621682073185"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coVarKindsTypesRole"><span class="hs-identifier hs-var">coVarKindsTypesRole</span></a><span> </span><a href="#local-6989586621682073183"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-473"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621682073184"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073185"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-474"></a><span>
</span><a name="line-475"></a><span class="hs-identifier">coVarKindsTypesRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Util.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">)</span><span>
</span><a name="line-476"></a><a name="coVarKindsTypesRole"><a href="Coercion.html#coVarKindsTypesRole"><span class="hs-identifier">coVarKindsTypesRole</span></a></a><span> </span><a name="local-6989586621682073186"><a href="#local-6989586621682073186"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-477"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073187"><a href="#local-6989586621682073187"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621682073188"><a href="#local-6989586621682073188"><span class="hs-identifier">k1</span></a></a><span class="hs-special">,</span><a name="local-6989586621682073189"><a href="#local-6989586621682073189"><span class="hs-identifier">k2</span></a></a><span class="hs-special">,</span><a name="local-6989586621682073190"><a href="#local-6989586621682073190"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><a name="local-6989586621682073191"><a href="#local-6989586621682073191"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073186"><span class="hs-identifier hs-var">cv</span></a><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-479"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073187"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#eqPrimTyConKey"><span class="hs-identifier hs-var">eqPrimTyConKey</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-480"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073187"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#eqReprPrimTyConKey"><span class="hs-identifier hs-var">eqReprPrimTyConKey</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span>
</span><a name="line-481"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;coVarKindsTypesRole&quot;</span><span>
</span><a name="line-482"></a><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073188"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">,</span><a href="#local-6989586621682073189"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">,</span><a href="#local-6989586621682073190"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><a href="#local-6989586621682073191"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">,</span><span class="hs-keyword">role</span><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;coVarKindsTypesRole, non coercion variable&quot;</span><span>
</span><a name="line-484"></a><span>                        </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073186"><span class="hs-identifier hs-var">cv</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073186"><span class="hs-identifier hs-var">cv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-identifier">coVarKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-487"></a><a name="coVarKind"><a href="Coercion.html#coVarKind"><span class="hs-identifier">coVarKind</span></a></a><span> </span><a name="local-6989586621682073193"><a href="#local-6989586621682073193"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-488"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">cv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>    </span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073193"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-identifier">coVarRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>
</span><a name="line-492"></a><a name="coVarRole"><a href="Coercion.html#coVarRole"><span class="hs-identifier">coVarRole</span></a></a><span> </span><a name="local-6989586621682073194"><a href="#local-6989586621682073194"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-493"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073195"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#eqPrimTyConKey"><span class="hs-identifier hs-var">eqPrimTyConKey</span></a><span>
</span><a name="line-494"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-495"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073195"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#eqReprPrimTyConKey"><span class="hs-identifier hs-var">eqReprPrimTyConKey</span></a><span>
</span><a name="line-496"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span>
</span><a name="line-497"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-498"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;coVarRole: unknown tycon&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073194"><span class="hs-identifier hs-var">cv</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073194"><span class="hs-identifier hs-var">cv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-501"></a><span>    </span><a name="local-6989586621682073195"><a href="#local-6989586621682073195"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#tyConAppTyCon_maybe"><span class="hs-identifier hs-var">tyConAppTyCon_maybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073194"><span class="hs-identifier hs-var">cv</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-502"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073196"><a href="#local-6989586621682073196"><span class="hs-identifier">tc0</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073196"><span class="hs-identifier hs-var">tc0</span></a><span>
</span><a name="line-503"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;coVarRole: not tyconapp&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073194"><span class="hs-identifier hs-var">cv</span></a><span class="hs-special">)</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span class="hs-comment">-- | Makes a coercion type from two types: the types whose equality</span><span>
</span><a name="line-506"></a><span class="hs-comment">-- is proven by the relevant 'Coercion'</span><span>
</span><a name="line-507"></a><span class="hs-identifier">mkCoercionType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-508"></a><a name="mkCoercionType"><a href="Coercion.html#mkCoercionType"><span class="hs-identifier">mkCoercionType</span></a></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkPrimEqPred"><span class="hs-identifier hs-var">mkPrimEqPred</span></a><span>
</span><a name="line-509"></a><span class="hs-identifier">mkCoercionType</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkReprPrimEqPred"><span class="hs-identifier hs-var">mkReprPrimEqPred</span></a><span>
</span><a name="line-510"></a><span class="hs-identifier">mkCoercionType</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682073197"><a href="#local-6989586621682073197"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073198"><a href="#local-6989586621682073198"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-511"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073199"><a href="#local-6989586621682073199"><span class="hs-identifier">ki1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073197"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-512"></a><span>      </span><a name="local-6989586621682073200"><a href="#local-6989586621682073200"><span class="hs-identifier">ki2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073198"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-513"></a><span>  </span><span class="hs-keyword">in</span><span>
</span><a name="line-514"></a><span>  </span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a href="TysPrim.html#eqPhantPrimTyCon"><span class="hs-identifier hs-var">eqPhantPrimTyCon</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682073199"><span class="hs-identifier hs-var">ki1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073200"><span class="hs-identifier hs-var">ki2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073197"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073198"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">]</span><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span class="hs-identifier">mkHeteroCoercionType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-517"></a><a name="mkHeteroCoercionType"><a href="Coercion.html#mkHeteroCoercionType"><span class="hs-identifier">mkHeteroCoercionType</span></a></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkHeteroPrimEqPred"><span class="hs-identifier hs-var">mkHeteroPrimEqPred</span></a><span>
</span><a name="line-518"></a><span class="hs-identifier">mkHeteroCoercionType</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkHeteroReprPrimEqPred"><span class="hs-identifier hs-var">mkHeteroReprPrimEqPred</span></a><span>
</span><a name="line-519"></a><span class="hs-identifier">mkHeteroCoercionType</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkHeteroCoercionType&quot;</span><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span class="hs-comment">-- | Given a coercion @co1 :: (a :: TYPE r1) ~ (b :: TYPE r2)@,</span><span>
</span><a name="line-522"></a><span class="hs-comment">-- produce a coercion @rep_co :: r1 ~ r2@.</span><span>
</span><a name="line-523"></a><span class="hs-identifier">mkRuntimeRepCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Util.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-524"></a><a name="mkRuntimeRepCo"><a href="Coercion.html#mkRuntimeRepCo"><span class="hs-identifier">mkRuntimeRepCo</span></a></a><span> </span><a name="local-6989586621682073201"><a href="#local-6989586621682073201"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621682073202"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-526"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-527"></a><span>    </span><a name="local-6989586621682073202"><a href="#local-6989586621682073202"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073201"><span class="hs-identifier hs-var">co</span></a><span>  </span><span class="hs-comment">-- kind_co :: TYPE r1 ~ TYPE r2</span><span>
</span><a name="line-528"></a><span>                           </span><span class="hs-comment">-- (up to silliness with Constraint)</span><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span class="hs-identifier">isReflCoVar_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-531"></a><span class="hs-comment">-- If cv :: t~t then isReflCoVar_maybe cv = Just (Refl t)</span><span>
</span><a name="line-532"></a><span class="hs-comment">-- Works on all kinds of Vars, not just CoVars</span><span>
</span><a name="line-533"></a><a name="isReflCoVar_maybe"><a href="Coercion.html#isReflCoVar_maybe"><span class="hs-identifier">isReflCoVar_maybe</span></a></a><span> </span><a name="local-6989586621682073203"><a href="#local-6989586621682073203"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-534"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621682073203"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-535"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073204"><a href="#local-6989586621682073204"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073205"><a href="#local-6989586621682073205"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coVarTypes"><span class="hs-identifier hs-var">coVarTypes</span></a><span> </span><a href="#local-6989586621682073203"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-536"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073204"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073205"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-537"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a><span> </span><a href="#local-6989586621682073203"><span class="hs-identifier hs-var">cv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073204"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-539"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-540"></a><span>
</span><a name="line-541"></a><span class="hs-comment">-- | Tests if this coercion is obviously a generalized reflexive coercion.</span><span>
</span><a name="line-542"></a><span class="hs-comment">-- Guaranteed to work very quickly.</span><span>
</span><a name="line-543"></a><span class="hs-identifier">isGReflCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-544"></a><a name="isGReflCo"><a href="Coercion.html#isGReflCo"><span class="hs-identifier">isGReflCo</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-545"></a><span class="hs-identifier">isGReflCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- Refl ty == GRefl N ty MRefl</span><span>
</span><a name="line-546"></a><span class="hs-identifier">isGReflCo</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-547"></a><span>
</span><a name="line-548"></a><span class="hs-comment">-- | Tests if this MCoercion is obviously generalized reflexive</span><span>
</span><a name="line-549"></a><span class="hs-comment">-- Guaranteed to work very quickly.</span><span>
</span><a name="line-550"></a><span class="hs-identifier">isGReflMCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-551"></a><a name="isGReflMCo"><a href="Coercion.html#isGReflMCo"><span class="hs-identifier">isGReflMCo</span></a></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-552"></a><span class="hs-identifier">isGReflMCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073206"><a href="#local-6989586621682073206"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073206"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-553"></a><span class="hs-identifier">isGReflMCo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-554"></a><span>
</span><a name="line-555"></a><span class="hs-comment">-- | Tests if this coercion is obviously reflexive. Guaranteed to work</span><span>
</span><a name="line-556"></a><span class="hs-comment">-- very quickly. Sometimes a coercion can be reflexive, but not obviously</span><span>
</span><a name="line-557"></a><span class="hs-comment">-- so. c.f. 'isReflexiveCo'</span><span>
</span><a name="line-558"></a><span class="hs-identifier">isReflCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-559"></a><a name="isReflCo"><a href="Coercion.html#isReflCo"><span class="hs-identifier">isReflCo</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-560"></a><span class="hs-identifier">isReflCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073207"><a href="#local-6989586621682073207"><span class="hs-identifier">mco</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflMCo"><span class="hs-identifier hs-var">isGReflMCo</span></a><span> </span><a href="#local-6989586621682073207"><span class="hs-identifier hs-var">mco</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-561"></a><span class="hs-identifier">isReflCo</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-comment">-- | Returns the type coerced if this coercion is a generalized reflexive</span><span>
</span><a name="line-564"></a><span class="hs-comment">-- coercion. Guaranteed to work very quickly.</span><span>
</span><a name="line-565"></a><span class="hs-identifier">isGReflCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">)</span><span>
</span><a name="line-566"></a><a name="isGReflCo_maybe"><a href="Coercion.html#isGReflCo_maybe"><span class="hs-identifier">isGReflCo_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a name="local-6989586621682073208"><a href="#local-6989586621682073208"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073209"><a href="#local-6989586621682073209"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073209"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073208"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span class="hs-identifier">isGReflCo_maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-6989586621682073210"><a href="#local-6989586621682073210"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073210"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span class="hs-identifier">isGReflCo_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-569"></a><span>
</span><a name="line-570"></a><span class="hs-comment">-- | Returns the type coerced if this coercion is reflexive. Guaranteed</span><span>
</span><a name="line-571"></a><span class="hs-comment">-- to work very quickly. Sometimes a coercion can be reflexive, but not</span><span>
</span><a name="line-572"></a><span class="hs-comment">-- obviously so. c.f. 'isReflexiveCo_maybe'</span><span>
</span><a name="line-573"></a><span class="hs-identifier">isReflCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">)</span><span>
</span><a name="line-574"></a><a name="isReflCo_maybe"><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier">isReflCo_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-6989586621682073211"><a href="#local-6989586621682073211"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073211"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span>
</span><a name="line-575"></a><span class="hs-identifier">isReflCo_maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a name="local-6989586621682073212"><a href="#local-6989586621682073212"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073213"><a href="#local-6989586621682073213"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073214"><a href="#local-6989586621682073214"><span class="hs-identifier">mco</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflMCo"><span class="hs-identifier hs-var">isGReflMCo</span></a><span> </span><a href="#local-6989586621682073214"><span class="hs-identifier hs-var">mco</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073213"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073212"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-576"></a><span class="hs-identifier">isReflCo_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><span class="hs-comment">-- | Slowly checks if the coercion is reflexive. Don't call this in a loop,</span><span>
</span><a name="line-579"></a><span class="hs-comment">-- as it walks over the entire coercion.</span><span>
</span><a name="line-580"></a><span class="hs-identifier">isReflexiveCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-581"></a><a name="isReflexiveCo"><a href="Coercion.html#isReflexiveCo"><span class="hs-identifier">isReflexiveCo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Coercion.html#isReflexiveCo_maybe"><span class="hs-identifier hs-var">isReflexiveCo_maybe</span></a><span>
</span><a name="line-582"></a><span>
</span><a name="line-583"></a><span class="hs-comment">-- | Extracts the coerced type from a reflexive coercion. This potentially</span><span>
</span><a name="line-584"></a><span class="hs-comment">-- walks over the entire coercion, so avoid doing this in a loop.</span><span>
</span><a name="line-585"></a><span class="hs-identifier">isReflexiveCo_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">)</span><span>
</span><a name="line-586"></a><a name="isReflexiveCo_maybe"><a href="Coercion.html#isReflexiveCo_maybe"><span class="hs-identifier">isReflexiveCo_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-6989586621682073215"><a href="#local-6989586621682073215"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073215"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span class="hs-identifier">isReflexiveCo_maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a name="local-6989586621682073216"><a href="#local-6989586621682073216"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073217"><a href="#local-6989586621682073217"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073218"><a href="#local-6989586621682073218"><span class="hs-identifier">mco</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflMCo"><span class="hs-identifier hs-var">isGReflMCo</span></a><span> </span><a href="#local-6989586621682073218"><span class="hs-identifier hs-var">mco</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073217"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073216"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-588"></a><span class="hs-identifier">isReflexiveCo_maybe</span><span> </span><a name="local-6989586621682073219"><a href="#local-6989586621682073219"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-589"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073220"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073221"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-590"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073220"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073222"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-591"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-592"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-593"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073220"><a href="#local-6989586621682073220"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073221"><a href="#local-6989586621682073221"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073222"><a href="#local-6989586621682073222"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-6989586621682073219"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
            Building coercions
%*                                                                      *
%************************************************************************

These &quot;smart constructors&quot; maintain the invariants listed in the definition
of Coercion, and they perform very basic optimizations.

Note [Role twiddling functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

There are a plethora of functions for twiddling roles:

mkSubCo: Requires a nominal input coercion and always produces a
representational output. This is used when you (the programmer) are sure you
know exactly that role you have and what you want.

downgradeRole_maybe: This function takes both the input role and the output role
as parameters. (The *output* role comes first!) It can only *downgrade* a
role -- that is, change it from N to R or P, or from R to P. This one-way
behavior is why there is the &quot;_maybe&quot;. If an upgrade is requested, this
function produces Nothing. This is used when you need to change the role of a
coercion, but you're not sure (as you're writing the code) of which roles are
involved.

This function could have been written using coercionRole to ascertain the role
of the input. But, that function is recursive, and the caller of downgradeRole_maybe
often knows the input role. So, this is more efficient.

downgradeRole: This is just like downgradeRole_maybe, but it panics if the
conversion isn't a downgrade.

setNominalRole_maybe: This is the only function that can *upgrade* a coercion.
The result (if it exists) is always Nominal. The input can be at any role. It
works on a &quot;best effort&quot; basis, as it should never be strictly necessary to
upgrade a coercion during compilation. It is currently only used within GHC in
splitAppCo_maybe. In order to be a proper inverse of mkAppCo, the second
coercion that splitAppCo_maybe returns must be nominal. But, it's conceivable
that splitAppCo_maybe is operating over a TyConAppCo that uses a
representational coercion. Hence the need for setNominalRole_maybe.
splitAppCo_maybe, in turn, is used only within coercion optimization -- thus,
it is not absolutely critical that setNominalRole_maybe be complete.

Note that setNominalRole_maybe will never upgrade a phantom UnivCo. Phantom
UnivCos are perfectly type-safe, whereas representational and nominal ones are
not. Indeed, `unsafeCoerce` is implemented via a representational UnivCo.
(Nominal ones are no worse than representational ones, so this function *will*
change a UnivCo Representational to a UnivCo Nominal.)

Conal Elliott also came across a need for this function while working with the
GHC API, as he was decomposing Core casts. The Core casts use representational
coercions, as they must, but his use case required nominal coercions (he was
building a GADT). So, that's why this function is exported from this module.

One might ask: shouldn't downgradeRole_maybe just use setNominalRole_maybe as
appropriate? I (Richard E.) have decided not to do this, because upgrading a
role is bizarre and a caller should have to ask for this behavior explicitly.

-}</span><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span class="hs-comment">-- | Make a generalized reflexive coercion</span><span>
</span><a name="line-658"></a><span class="hs-identifier">mkGReflCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#MCoercionN"><span class="hs-identifier hs-type">MCoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-659"></a><a name="mkGReflCo"><a href="Coercion.html#mkGReflCo"><span class="hs-identifier">mkGReflCo</span></a></a><span> </span><a name="local-6989586621682073223"><a href="#local-6989586621682073223"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073224"><a href="#local-6989586621682073224"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073225"><a href="#local-6989586621682073225"><span class="hs-identifier">mco</span></a></a><span>
</span><a name="line-660"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflMCo"><span class="hs-identifier hs-var">isGReflMCo</span></a><span> </span><a href="#local-6989586621682073225"><span class="hs-identifier hs-var">mco</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621682073223"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a href="#local-6989586621682073224"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-661"></a><span>                     </span><span class="hs-keyword">else</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="#local-6989586621682073223"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073224"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>
</span><a name="line-662"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="#local-6989586621682073223"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073224"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682073225"><span class="hs-identifier hs-var">mco</span></a><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span class="hs-comment">-- | Make a reflexive coercion</span><span>
</span><a name="line-665"></a><span class="hs-identifier">mkReflCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-666"></a><a name="mkReflCo"><a href="Coercion.html#mkReflCo"><span class="hs-identifier">mkReflCo</span></a></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a name="local-6989586621682073226"><a href="#local-6989586621682073226"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a href="#local-6989586621682073226"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-667"></a><span class="hs-identifier">mkReflCo</span><span> </span><a name="local-6989586621682073227"><a href="#local-6989586621682073227"><span class="hs-identifier">r</span></a></a><span>       </span><a name="local-6989586621682073228"><a href="#local-6989586621682073228"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="#local-6989586621682073227"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073228"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span class="hs-comment">-- | Make a representational reflexive coercion</span><span>
</span><a name="line-670"></a><span class="hs-identifier">mkRepReflCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-671"></a><a name="mkRepReflCo"><a href="Coercion.html#mkRepReflCo"><span class="hs-identifier">mkRepReflCo</span></a></a><span> </span><a name="local-6989586621682073229"><a href="#local-6989586621682073229"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073229"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>
</span><a name="line-672"></a><span>
</span><a name="line-673"></a><span class="hs-comment">-- | Make a nominal reflexive coercion</span><span>
</span><a name="line-674"></a><span class="hs-identifier">mkNomReflCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-675"></a><a name="mkNomReflCo"><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier">mkNomReflCo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span class="hs-comment">-- | Apply a type constructor to a list of coercions. It is the</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- caller's responsibility to get the roles correct on argument coercions.</span><span>
</span><a name="line-679"></a><span class="hs-identifier">mkTyConAppCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Util.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-680"></a><a name="mkTyConAppCo"><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier">mkTyConAppCo</span></a></a><span> </span><a name="local-6989586621682073230"><a href="#local-6989586621682073230"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073231"><a href="#local-6989586621682073231"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073232"><a href="#local-6989586621682073232"><span class="hs-identifier">cos</span></a></a><span>
</span><a name="line-681"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073231"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#funTyConKey"><span class="hs-identifier hs-var">funTyConKey</span></a><span>
</span><a name="line-682"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621682073233"><a href="#local-6989586621682073233"><span class="hs-identifier">_rep1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073234"><a href="#local-6989586621682073234"><span class="hs-identifier">_rep2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073235"><a href="#local-6989586621682073235"><span class="hs-identifier">co1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073236"><a href="#local-6989586621682073236"><span class="hs-identifier">co2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682073232"><span class="hs-identifier hs-var">cos</span></a><span>   </span><span class="hs-comment">-- See Note [Function coercions]</span><span>
</span><a name="line-683"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- (a :: TYPE ra) -&gt; (b :: TYPE rb)  ~  (c :: TYPE rc) -&gt; (d :: TYPE rd)</span><span>
</span><a name="line-684"></a><span>    </span><span class="hs-comment">-- rep1 :: ra  ~  rc        rep2 :: rb  ~  rd</span><span>
</span><a name="line-685"></a><span>    </span><span class="hs-comment">-- co1  :: a   ~  c         co2  :: b   ~  d</span><span>
</span><a name="line-686"></a><span>    </span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="#local-6989586621682073230"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073235"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682073236"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span>               </span><span class="hs-comment">-- Expand type synonyms</span><span>
</span><a name="line-689"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073237"><a href="#local-6989586621682073237"><span class="hs-identifier">tv_co_prs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073238"><a href="#local-6989586621682073238"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073239"><a href="#local-6989586621682073239"><span class="hs-identifier">leftover_cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#expandSynTyCon_maybe"><span class="hs-identifier hs-var">expandSynTyCon_maybe</span></a><span> </span><a href="#local-6989586621682073231"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073232"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-690"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAppCos"><span class="hs-identifier hs-var">mkAppCos</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a><span> </span><a href="#local-6989586621682073230"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkLiftingContext"><span class="hs-identifier hs-var">mkLiftingContext</span></a><span> </span><a href="#local-6989586621682073237"><span class="hs-identifier hs-var">tv_co_prs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073238"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073239"><span class="hs-identifier hs-var">leftover_cos</span></a><span>
</span><a name="line-691"></a><span>
</span><a name="line-692"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073240"><a href="#local-6989586621682073240"><span class="hs-identifier">tys_roles</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073232"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-693"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073230"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621682073231"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682073240"><span class="hs-identifier hs-var">tys_roles</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-694"></a><span>  </span><span class="hs-comment">-- See Note [Refl invariant]</span><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a href="#local-6989586621682073230"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073231"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073232"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-697"></a><span>
</span><a name="line-698"></a><span class="hs-comment">-- | Build a function 'Coercion' from two other 'Coercion's. That is,</span><span>
</span><a name="line-699"></a><span class="hs-comment">-- given @co1 :: a ~ b@ and @co2 :: x ~ y@ produce @co :: (a -&gt; x) ~ (b -&gt; y)@.</span><span>
</span><a name="line-700"></a><span class="hs-identifier">mkFunCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-701"></a><a name="mkFunCo"><a href="Coercion.html#mkFunCo"><span class="hs-identifier">mkFunCo</span></a></a><span> </span><a name="local-6989586621682073241"><a href="#local-6989586621682073241"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073242"><a href="#local-6989586621682073242"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073243"><a href="#local-6989586621682073243"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-702"></a><span>    </span><span class="hs-comment">-- See Note [Refl invariant]</span><span>
</span><a name="line-703"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073244"><a href="#local-6989586621682073244"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073242"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-704"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073245"><a href="#local-6989586621682073245"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073243"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-705"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073241"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a><span> </span><a href="#local-6989586621682073244"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073245"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-706"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><a href="#local-6989586621682073241"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073242"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682073243"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span class="hs-comment">-- | Apply a 'Coercion' to another 'Coercion'.</span><span>
</span><a name="line-709"></a><span class="hs-comment">-- The second coercion must be Nominal, unless the first is Phantom.</span><span>
</span><a name="line-710"></a><span class="hs-comment">-- If the first is Phantom, then the second can be either Phantom or Nominal.</span><span>
</span><a name="line-711"></a><span class="hs-identifier">mkAppCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>     </span><span class="hs-comment">-- ^ :: t1 ~r t2</span><span>
</span><a name="line-712"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>     </span><span class="hs-comment">-- ^ :: s1 ~N s2, where s1 :: k1, s2 :: k2</span><span>
</span><a name="line-713"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>     </span><span class="hs-comment">-- ^ :: t1 s1 ~r t2 s2</span><span>
</span><a name="line-714"></a><a name="mkAppCo"><a href="Coercion.html#mkAppCo"><span class="hs-identifier">mkAppCo</span></a></a><span> </span><a name="local-6989586621682073246"><a href="#local-6989586621682073246"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073247"><a href="#local-6989586621682073247"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-715"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073254"><a href="#local-6989586621682073254"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073255"><a href="#local-6989586621682073255"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073246"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-716"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073256"><a href="#local-6989586621682073256"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073247"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-717"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073255"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkAppTy"><span class="hs-identifier hs-var">mkAppTy</span></a><span> </span><a href="#local-6989586621682073254"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073256"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073257"><a href="#local-6989586621682073257"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073258"><a href="#local-6989586621682073258"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073246"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-720"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073259"><a href="#local-6989586621682073259"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073260"><a href="#local-6989586621682073260"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682073257"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-721"></a><span>    </span><span class="hs-comment">-- Expand type synonyms; a TyConAppCo can't have a type synonym (Trac #9102)</span><span>
</span><a name="line-722"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-6989586621682073258"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073259"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073248"><span class="hs-identifier hs-var">zip_roles</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a><span> </span><a href="#local-6989586621682073258"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073259"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073260"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-723"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-724"></a><span>    </span><a name="local-6989586621682073248"><a href="#local-6989586621682073248"><span class="hs-identifier">zip_roles</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682073249"><a href="#local-6989586621682073249"><span class="hs-identifier">r1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="#local-6989586621682073249"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073247"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-725"></a><span>    </span><span class="hs-identifier">zip_roles</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073250"><a href="#local-6989586621682073250"><span class="hs-identifier">r1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682073251"><a href="#local-6989586621682073251"><span class="hs-identifier">rs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073252"><a href="#local-6989586621682073252"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682073253"><a href="#local-6989586621682073253"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073250"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-6989586621682073252"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682073248"><span class="hs-identifier hs-var">zip_roles</span></a><span> </span><a href="#local-6989586621682073251"><span class="hs-identifier hs-var">rs</span></a><span> </span><a href="#local-6989586621682073253"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-726"></a><span>    </span><span class="hs-identifier">zip_roles</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;zip_roles&quot;</span><span> </span><span class="hs-comment">-- but the roles are infinite...</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span class="hs-identifier">mkAppCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-6989586621682073261"><a href="#local-6989586621682073261"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073262"><a href="#local-6989586621682073262"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073263"><a href="#local-6989586621682073263"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073264"><a href="#local-6989586621682073264"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-729"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682073261"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-730"></a><span>      </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073262"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073263"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682073264"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>      </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073262"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073263"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682073266"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-732"></a><span>        </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682073265"><a href="#local-6989586621682073265"><span class="hs-identifier">new_role</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-6989586621682073262"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">!!</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682073263"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>              </span><a name="local-6989586621682073266"><a href="#local-6989586621682073266"><span class="hs-identifier">arg'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="#local-6989586621682073265"><span class="hs-identifier hs-var">new_role</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073264"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-734"></a><span>      </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><a href="#local-6989586621682073262"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073263"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">[</span><a href="Coercion.html#toPhantomCo"><span class="hs-identifier hs-var">toPhantomCo</span></a><span> </span><a href="#local-6989586621682073264"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-735"></a><span class="hs-identifier">mkAppCo</span><span> </span><a name="local-6989586621682073267"><a href="#local-6989586621682073267"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073268"><a href="#local-6989586621682073268"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a href="#local-6989586621682073267"><span class="hs-identifier hs-var">co</span></a><span>  </span><a href="#local-6989586621682073268"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-736"></a><span class="hs-comment">-- Note, mkAppCo is careful to maintain invariants regarding</span><span>
</span><a name="line-737"></a><span class="hs-comment">-- where Refl constructors appear; see the comments in the definition</span><span>
</span><a name="line-738"></a><span class="hs-comment">-- of Coercion and the Note [Refl invariant] in TyCoRep.</span><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><span class="hs-comment">-- | Applies multiple 'Coercion's to another 'Coercion', from left to right.</span><span>
</span><a name="line-741"></a><span class="hs-comment">-- See also 'mkAppCo'.</span><span>
</span><a name="line-742"></a><span class="hs-identifier">mkAppCos</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-743"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-744"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-745"></a><a name="mkAppCos"><a href="Coercion.html#mkAppCos"><span class="hs-identifier">mkAppCos</span></a></a><span> </span><a name="local-6989586621682073269"><a href="#local-6989586621682073269"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073270"><a href="#local-6989586621682073270"><span class="hs-identifier">cos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><a href="#local-6989586621682073269"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682073270"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-746"></a><span>
</span><a name="line-747"></a><span class="hs-comment">{- Note [Unused coercion variable in ForAllCo]

See Note [Unused coercion variable in ForAllTy] in TyCoRep for the motivation for
checking coercion variable in types.
To lift the design choice to (ForAllCo cv kind_co body_co), we have two options:

(1) In mkForAllCo, we check whether cv is a coercion variable
    and whether it is not used in body_co. If so we construct a FunCo.
(2) We don't do this check in mkForAllCo.
    In coercionKind, we use mkTyCoForAllTy to perform the check and construct
    a FunTy when necessary.

We chose (2) for two reasons:

* for a coercion, all that matters is its kind, So ForAllCo or FunCo does not
  make a difference.
* even if cv occurs in body_co, it is possible that cv does not occur in the kind
  of body_co. Therefore the check in coercionKind is inevitable.

The last wrinkle is that there are restrictions around the use of the cv in the
coercion, as described in Section 5.8.5.2 of Richard's thesis. The idea is that
we cannot prove that the type system is consistent with unrestricted use of this
cv; the consistency proof uses an untyped rewrite relation that works over types
with all coercions and casts removed. So, we can allow the cv to appear only in
positions that are erased. As an approximation of this (and keeping close to the
published theory), we currently allow the cv only within the type in a Refl node
and under a GRefl node (including in the Coercion stored in a GRefl). It's
possible other places are OK, too, but this is a safe approximation.

Sadly, with heterogeneous equality, this restriction might be able to be violated;
Richard's thesis is unable to prove that it isn't. Specifically, the liftCoSubst
function might create an invalid coercion. Because a violation of the
restriction might lead to a program that &quot;goes wrong&quot;, it is checked all the time,
even in a production compiler and without -dcore-list. We *have* proved that the
problem does not occur with homogeneous equality, so this check can be dropped
once ~# is made to be homogeneous.
-}</span><span>
</span><a name="line-784"></a><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span class="hs-comment">-- | Make a Coercion from a tycovar, a kind coercion, and a body coercion.</span><span>
</span><a name="line-787"></a><span class="hs-comment">-- The kind of the tycovar should be the left-hand kind of the kind coercion.</span><span>
</span><a name="line-788"></a><span class="hs-comment">-- See Note [Unused coercion variable in ForAllCo]</span><span>
</span><a name="line-789"></a><span class="hs-identifier">mkForAllCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-790"></a><a name="mkForAllCo"><a href="Coercion.html#mkForAllCo"><span class="hs-identifier">mkForAllCo</span></a></a><span> </span><a name="local-6989586621682073271"><a href="#local-6989586621682073271"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621682073272"><a href="#local-6989586621682073272"><span class="hs-identifier">kind_co</span></a></a><span> </span><a name="local-6989586621682073273"><a href="#local-6989586621682073273"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-791"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">varType</span><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pFst</span><span> </span><a href="Type.html#eqType"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">coercionKind</span><span> </span><span class="hs-identifier">kind_co</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-792"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-identifier">almostDevoidCoVarOfCo</span><span> </span><a href="TyCoRep.html#almostDevoidCoVarOfCo"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="TyCoRep.html#almostDevoidCoVarOfCo"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="TyCoRep.html#almostDevoidCoVarOfCo"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-793"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073274"><a href="#local-6989586621682073274"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073275"><a href="#local-6989586621682073275"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073273"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-794"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073272"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-795"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073275"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyCoInvForAllTy"><span class="hs-identifier hs-var">mkTyCoInvForAllTy</span></a><span> </span><a href="#local-6989586621682073271"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621682073274"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-796"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-797"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a href="#local-6989586621682073271"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621682073272"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><a href="#local-6989586621682073273"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span class="hs-comment">-- | Like 'mkForAllCo', but the inner coercion shouldn't be an obvious</span><span>
</span><a name="line-800"></a><span class="hs-comment">-- reflexive coercion. For example, it is guaranteed in 'mkForAllCos'.</span><span>
</span><a name="line-801"></a><span class="hs-comment">-- The kind of the tycovar should be the left-hand kind of the kind coercion.</span><span>
</span><a name="line-802"></a><span class="hs-identifier">mkForAllCo_NoRefl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-803"></a><a name="mkForAllCo_NoRefl"><a href="Coercion.html#mkForAllCo_NoRefl"><span class="hs-identifier">mkForAllCo_NoRefl</span></a></a><span> </span><a name="local-6989586621682073276"><a href="#local-6989586621682073276"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621682073277"><a href="#local-6989586621682073277"><span class="hs-identifier">kind_co</span></a></a><span> </span><a name="local-6989586621682073278"><a href="#local-6989586621682073278"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-804"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">varType</span><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">eqType</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pFst</span><span> </span><a href="Type.html#eqType"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">coercionKind</span><span> </span><span class="hs-identifier">kind_co</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-805"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-identifier">almostDevoidCoVarOfCo</span><span> </span><a href="TyCoRep.html#almostDevoidCoVarOfCo"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="TyCoRep.html#almostDevoidCoVarOfCo"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="TyCoRep.html#almostDevoidCoVarOfCo"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-806"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isReflCo</span><span> </span><span class="hs-identifier hs-var">co</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-807"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621682073276"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-808"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073276"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-6989586621682073278"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-809"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073278"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073277"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><a href="#local-6989586621682073278"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-810"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-811"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a href="#local-6989586621682073276"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621682073277"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><a href="#local-6989586621682073278"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span class="hs-comment">-- | Make nested ForAllCos</span><span>
</span><a name="line-814"></a><span class="hs-identifier">mkForAllCos</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-815"></a><a name="mkForAllCos"><a href="Coercion.html#mkForAllCos"><span class="hs-identifier">mkForAllCos</span></a></a><span> </span><a name="local-6989586621682073279"><a href="#local-6989586621682073279"><span class="hs-identifier">bndrs</span></a></a><span> </span><a name="local-6989586621682073280"><a href="#local-6989586621682073280"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-816"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073281"><a href="#local-6989586621682073281"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073282"><a href="#local-6989586621682073282"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073280"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-817"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073283"><a href="#local-6989586621682073283"><span class="hs-identifier">refls_rev'd</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073284"><a href="#local-6989586621682073284"><span class="hs-identifier">non_refls_rev'd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682073279"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-818"></a><span>    </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Coercion.html#mkForAllCo_NoRefl"><span class="hs-identifier hs-var">mkForAllCo_NoRefl</span></a><span class="hs-special">)</span><span>
</span><a name="line-819"></a><span>           </span><span class="hs-special">(</span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073282"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyCoInvForAllTys"><span class="hs-identifier hs-var">mkTyCoInvForAllTys</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621682073283"><span class="hs-identifier hs-var">refls_rev'd</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073281"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>           </span><a href="#local-6989586621682073284"><span class="hs-identifier hs-var">non_refls_rev'd</span></a><span>
</span><a name="line-821"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-822"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="Coercion.html#mkForAllCo_NoRefl"><span class="hs-identifier hs-var">mkForAllCo_NoRefl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073280"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682073279"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-823"></a><span>
</span><a name="line-824"></a><span class="hs-comment">-- | Make a Coercion quantified over a type/coercion variable;</span><span>
</span><a name="line-825"></a><span class="hs-comment">-- the variable has the same type in both sides of the coercion</span><span>
</span><a name="line-826"></a><span class="hs-identifier">mkHomoForAllCos</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-827"></a><a name="mkHomoForAllCos"><a href="Coercion.html#mkHomoForAllCos"><span class="hs-identifier">mkHomoForAllCos</span></a></a><span> </span><a name="local-6989586621682073285"><a href="#local-6989586621682073285"><span class="hs-identifier">vs</span></a></a><span> </span><a name="local-6989586621682073286"><a href="#local-6989586621682073286"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-828"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073287"><a href="#local-6989586621682073287"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073288"><a href="#local-6989586621682073288"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073286"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-829"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073288"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyCoInvForAllTys"><span class="hs-identifier hs-var">mkTyCoInvForAllTys</span></a><span> </span><a href="#local-6989586621682073285"><span class="hs-identifier hs-var">vs</span></a><span> </span><a href="#local-6989586621682073287"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-831"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkHomoForAllCos_NoRefl"><span class="hs-identifier hs-var">mkHomoForAllCos_NoRefl</span></a><span> </span><a href="#local-6989586621682073285"><span class="hs-identifier hs-var">vs</span></a><span> </span><a href="#local-6989586621682073286"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-832"></a><span>
</span><a name="line-833"></a><span class="hs-comment">-- | Like 'mkHomoForAllCos', but the inner coercion shouldn't be an obvious</span><span>
</span><a name="line-834"></a><span class="hs-comment">-- reflexive coercion. For example, it is guaranteed in 'mkHomoForAllCos'.</span><span>
</span><a name="line-835"></a><span class="hs-identifier">mkHomoForAllCos_NoRefl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-836"></a><a name="mkHomoForAllCos_NoRefl"><a href="Coercion.html#mkHomoForAllCos_NoRefl"><span class="hs-identifier">mkHomoForAllCos_NoRefl</span></a></a><span> </span><a name="local-6989586621682073289"><a href="#local-6989586621682073289"><span class="hs-identifier">vs</span></a></a><span> </span><a name="local-6989586621682073290"><a href="#local-6989586621682073290"><span class="hs-identifier">orig_co</span></a></a><span>
</span><a name="line-837"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isReflCo</span><span> </span><span class="hs-identifier">orig_co</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-838"></a><span>    </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682073291"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073290"><span class="hs-identifier hs-var">orig_co</span></a><span> </span><a href="#local-6989586621682073289"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-839"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-840"></a><span>    </span><a name="local-6989586621682073291"><a href="#local-6989586621682073291"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682073292"><a href="#local-6989586621682073292"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621682073293"><a href="#local-6989586621682073293"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkForAllCo_NoRefl"><span class="hs-identifier hs-var">mkForAllCo_NoRefl</span></a><span> </span><a href="#local-6989586621682073292"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073292"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073293"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-841"></a><span>
</span><a name="line-842"></a><span class="hs-identifier">mkCoVarCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-843"></a><span class="hs-comment">-- cv :: s ~# t</span><span>
</span><a name="line-844"></a><span class="hs-comment">-- See Note [mkCoVarCo]</span><span>
</span><a name="line-845"></a><a name="mkCoVarCo"><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier">mkCoVarCo</span></a></a><span> </span><a name="local-6989586621682073294"><a href="#local-6989586621682073294"><span class="hs-identifier">cv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a href="#local-6989586621682073294"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-846"></a><span>
</span><a name="line-847"></a><span class="hs-identifier">mkCoVarCos</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-848"></a><a name="mkCoVarCos"><a href="Coercion.html#mkCoVarCos"><span class="hs-identifier">mkCoVarCos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span>
</span><a name="line-849"></a><span>
</span><a name="line-850"></a><span class="hs-comment">{- Note [mkCoVarCo]
~~~~~~~~~~~~~~~~~~~
In the past, mkCoVarCo optimised (c :: t~t) to (Refl t).  That is
valid (although see Note [Unbound RULE binders] in Rules), but
it's a relatively expensive test and perhaps better done in
optCoercion.  Not a big deal either way.
-}</span><span>
</span><a name="line-857"></a><span>
</span><a name="line-858"></a><span class="hs-comment">-- | Extract a covar, if possible. This check is dirty. Be ashamed</span><span>
</span><a name="line-859"></a><span class="hs-comment">-- of yourself. (It's dirty because it cares about the structure of</span><span>
</span><a name="line-860"></a><span class="hs-comment">-- a coercion, which is morally reprehensible.)</span><span>
</span><a name="line-861"></a><span class="hs-identifier">isCoVar_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span>
</span><a name="line-862"></a><a name="isCoVar_maybe"><a href="Coercion.html#isCoVar_maybe"><span class="hs-identifier">isCoVar_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a name="local-6989586621682073295"><a href="#local-6989586621682073295"><span class="hs-identifier">cv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682073295"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-863"></a><span class="hs-identifier">isCoVar_maybe</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span class="hs-identifier">mkAxInstCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="#local-6989586621682073057"><span class="hs-identifier hs-type">br</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-866"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-867"></a><span class="hs-comment">-- mkAxInstCo can legitimately be called over-staturated;</span><span>
</span><a name="line-868"></a><span class="hs-comment">-- i.e. with more type arguments than the coercion requires</span><span>
</span><a name="line-869"></a><a name="mkAxInstCo"><a href="Coercion.html#mkAxInstCo"><span class="hs-identifier">mkAxInstCo</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682073297"><a href="#local-6989586621682073297"><span class="hs-identifier">ax</span></a></a><span> </span><a name="local-6989586621682073298"><a href="#local-6989586621682073298"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621682073299"><a href="#local-6989586621682073299"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682073300"><a href="#local-6989586621682073300"><span class="hs-identifier">cos</span></a></a><span>
</span><a name="line-870"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073305"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682073301"><span class="hs-identifier hs-var">n_tys</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682073310"><span class="hs-identifier hs-var">ax_role</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-871"></a><span>                     </span><a href="Coercion.html#mkAxiomInstCo"><span class="hs-identifier hs-var">mkAxiomInstCo</span></a><span> </span><a href="#local-6989586621682073302"><span class="hs-identifier hs-var">ax_br</span></a><span> </span><a href="#local-6989586621682073298"><span class="hs-identifier hs-var">index</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073307"><span class="hs-identifier hs-var">rtys</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073300"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-872"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">arity</span><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier">n_tys</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-873"></a><span>                     </span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682073310"><span class="hs-identifier hs-var">ax_role</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-874"></a><span>                     </span><a href="Coercion.html#mkAppCos"><span class="hs-identifier hs-var">mkAppCos</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkAxiomInstCo"><span class="hs-identifier hs-var">mkAxiomInstCo</span></a><span> </span><a href="#local-6989586621682073302"><span class="hs-identifier hs-var">ax_br</span></a><span> </span><a href="#local-6989586621682073298"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-875"></a><span>                                             </span><span class="hs-special">(</span><a href="#local-6989586621682073308"><span class="hs-identifier hs-var">ax_args</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073300"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-876"></a><span>                              </span><a href="#local-6989586621682073309"><span class="hs-identifier hs-var">leftover_args</span></a><span>
</span><a name="line-877"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-878"></a><span>    </span><a name="local-6989586621682073301"><a href="#local-6989586621682073301"><span class="hs-identifier">n_tys</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682073299"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-879"></a><span>    </span><a name="local-6989586621682073302"><a href="#local-6989586621682073302"><span class="hs-identifier">ax_br</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#toBranchedAxiom"><span class="hs-identifier hs-var">toBranchedAxiom</span></a><span> </span><a href="#local-6989586621682073297"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-880"></a><span>    </span><a name="local-6989586621682073303"><a href="#local-6989586621682073303"><span class="hs-identifier">branch</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomNthBranch"><span class="hs-identifier hs-var">coAxiomNthBranch</span></a><span> </span><a href="#local-6989586621682073302"><span class="hs-identifier hs-var">ax_br</span></a><span> </span><a href="#local-6989586621682073298"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-881"></a><span>    </span><a name="local-6989586621682073304"><a href="#local-6989586621682073304"><span class="hs-identifier">tvs</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchTyVars"><span class="hs-identifier hs-var">coAxBranchTyVars</span></a><span> </span><a href="#local-6989586621682073303"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-882"></a><span>    </span><a name="local-6989586621682073305"><a href="#local-6989586621682073305"><span class="hs-identifier">arity</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682073304"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-883"></a><span>    </span><a name="local-6989586621682073306"><a href="#local-6989586621682073306"><span class="hs-identifier">arg_roles</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchRoles"><span class="hs-identifier hs-var">coAxBranchRoles</span></a><span> </span><a href="#local-6989586621682073303"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-884"></a><span>    </span><a name="local-6989586621682073307"><a href="#local-6989586621682073307"><span class="hs-identifier">rtys</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073306"><span class="hs-identifier hs-var">arg_roles</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073299"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-885"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073308"><a href="#local-6989586621682073308"><span class="hs-identifier">ax_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073309"><a href="#local-6989586621682073309"><span class="hs-identifier">leftover_args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-886"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621682073305"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682073307"><span class="hs-identifier hs-var">rtys</span></a><span>
</span><a name="line-887"></a><span>    </span><a name="local-6989586621682073310"><a href="#local-6989586621682073310"><span class="hs-identifier">ax_role</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomRole"><span class="hs-identifier hs-var">coAxiomRole</span></a><span> </span><a href="#local-6989586621682073297"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-888"></a><span>
</span><a name="line-889"></a><span class="hs-comment">-- worker function</span><span>
</span><a name="line-890"></a><span class="hs-identifier">mkAxiomInstCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Branched"><span class="hs-identifier hs-type">Branched</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-891"></a><a name="mkAxiomInstCo"><a href="Coercion.html#mkAxiomInstCo"><span class="hs-identifier">mkAxiomInstCo</span></a></a><span> </span><a name="local-6989586621682073311"><a href="#local-6989586621682073311"><span class="hs-identifier">ax</span></a></a><span> </span><a name="local-6989586621682073312"><a href="#local-6989586621682073312"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621682073313"><a href="#local-6989586621682073313"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-892"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">coAxiomArity</span><span> </span><span class="hs-identifier">ax</span><span> </span><a href="CoAxiom.html#coAxiomArity"><span class="hs-identifier hs-var">index</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-893"></a><span>    </span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a href="#local-6989586621682073311"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682073312"><span class="hs-identifier hs-var">index</span></a><span> </span><a href="#local-6989586621682073313"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-894"></a><span>
</span><a name="line-895"></a><span class="hs-comment">-- to be used only with unbranched axioms</span><span>
</span><a name="line-896"></a><span class="hs-identifier">mkUnbranchedAxInstCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span>
</span><a name="line-897"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-898"></a><a name="mkUnbranchedAxInstCo"><a href="Coercion.html#mkUnbranchedAxInstCo"><span class="hs-identifier">mkUnbranchedAxInstCo</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682073315"><a href="#local-6989586621682073315"><span class="hs-identifier">ax</span></a></a><span> </span><a name="local-6989586621682073316"><a href="#local-6989586621682073316"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682073317"><a href="#local-6989586621682073317"><span class="hs-identifier">cos</span></a></a><span>
</span><a name="line-899"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAxInstCo"><span class="hs-identifier hs-var">mkAxInstCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682073315"><span class="hs-identifier hs-var">ax</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621682073316"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682073317"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-900"></a><span>
</span><a name="line-901"></a><span class="hs-identifier">mkAxInstRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="#local-6989586621682073056"><span class="hs-identifier hs-type">br</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-902"></a><span class="hs-comment">-- Instantiate the axiom with specified types,</span><span>
</span><a name="line-903"></a><span class="hs-comment">-- returning the instantiated RHS</span><span>
</span><a name="line-904"></a><span class="hs-comment">-- A companion to mkAxInstCo:</span><span>
</span><a name="line-905"></a><span class="hs-comment">--    mkAxInstRhs ax index tys = snd (coercionKind (mkAxInstCo ax index tys))</span><span>
</span><a name="line-906"></a><a name="mkAxInstRHS"><a href="Coercion.html#mkAxInstRHS"><span class="hs-identifier">mkAxInstRHS</span></a></a><span> </span><a name="local-6989586621682073318"><a href="#local-6989586621682073318"><span class="hs-identifier">ax</span></a></a><span> </span><a name="local-6989586621682073319"><a href="#local-6989586621682073319"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621682073320"><a href="#local-6989586621682073320"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682073321"><a href="#local-6989586621682073321"><span class="hs-identifier">cos</span></a></a><span>
</span><a name="line-907"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>    </span><a href="Type.html#mkAppTys"><span class="hs-identifier hs-var">mkAppTys</span></a><span> </span><a href="#local-6989586621682073327"><span class="hs-identifier hs-var">rhs'</span></a><span> </span><a href="#local-6989586621682073326"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-909"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-910"></a><span>    </span><a name="local-6989586621682073322"><a href="#local-6989586621682073322"><span class="hs-identifier">branch</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomNthBranch"><span class="hs-identifier hs-var">coAxiomNthBranch</span></a><span> </span><a href="#local-6989586621682073318"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682073319"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-911"></a><span>    </span><a name="local-6989586621682073323"><a href="#local-6989586621682073323"><span class="hs-identifier">tvs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchTyVars"><span class="hs-identifier hs-var">coAxBranchTyVars</span></a><span> </span><a href="#local-6989586621682073322"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-912"></a><span>    </span><a name="local-6989586621682073324"><a href="#local-6989586621682073324"><span class="hs-identifier">cvs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchCoVars"><span class="hs-identifier hs-var">coAxBranchCoVars</span></a><span> </span><a href="#local-6989586621682073322"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-913"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073325"><a href="#local-6989586621682073325"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073326"><a href="#local-6989586621682073326"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-6989586621682073323"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073320"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-914"></a><span>    </span><a name="local-6989586621682073327"><a href="#local-6989586621682073327"><span class="hs-identifier">rhs'</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyWith"><span class="hs-identifier hs-var">substTyWith</span></a><span> </span><a href="#local-6989586621682073323"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073325"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-915"></a><span>                   </span><a href="TyCoRep.html#substTyWithCoVars"><span class="hs-identifier hs-var">substTyWithCoVars</span></a><span> </span><a href="#local-6989586621682073324"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621682073321"><span class="hs-identifier hs-var">cos</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-916"></a><span>                   </span><a href="CoAxiom.html#coAxBranchRHS"><span class="hs-identifier hs-var">coAxBranchRHS</span></a><span> </span><a href="#local-6989586621682073322"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-identifier">mkUnbranchedAxInstRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-919"></a><a name="mkUnbranchedAxInstRHS"><a href="Coercion.html#mkUnbranchedAxInstRHS"><span class="hs-identifier">mkUnbranchedAxInstRHS</span></a></a><span> </span><a name="local-6989586621682073328"><a href="#local-6989586621682073328"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAxInstRHS"><span class="hs-identifier hs-var">mkAxInstRHS</span></a><span> </span><a href="#local-6989586621682073328"><span class="hs-identifier hs-var">ax</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span class="hs-comment">-- | Return the left-hand type of the axiom, when the axiom is instantiated</span><span>
</span><a name="line-922"></a><span class="hs-comment">-- at the types given.</span><span>
</span><a name="line-923"></a><span class="hs-identifier">mkAxInstLHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="#local-6989586621682073055"><span class="hs-identifier hs-type">br</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-924"></a><a name="mkAxInstLHS"><a href="Coercion.html#mkAxInstLHS"><span class="hs-identifier">mkAxInstLHS</span></a></a><span> </span><a name="local-6989586621682073329"><a href="#local-6989586621682073329"><span class="hs-identifier">ax</span></a></a><span> </span><a name="local-6989586621682073330"><a href="#local-6989586621682073330"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621682073331"><a href="#local-6989586621682073331"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682073332"><a href="#local-6989586621682073332"><span class="hs-identifier">cos</span></a></a><span>
</span><a name="line-925"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-926"></a><span>    </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621682073339"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073338"><span class="hs-identifier hs-var">lhs_tys</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073337"><span class="hs-identifier hs-var">tys2</span></a><span class="hs-special">)</span><span>
</span><a name="line-927"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-928"></a><span>    </span><a name="local-6989586621682073333"><a href="#local-6989586621682073333"><span class="hs-identifier">branch</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomNthBranch"><span class="hs-identifier hs-var">coAxiomNthBranch</span></a><span> </span><a href="#local-6989586621682073329"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682073330"><span class="hs-identifier hs-var">index</span></a><span>
</span><a name="line-929"></a><span>    </span><a name="local-6989586621682073334"><a href="#local-6989586621682073334"><span class="hs-identifier">tvs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchTyVars"><span class="hs-identifier hs-var">coAxBranchTyVars</span></a><span> </span><a href="#local-6989586621682073333"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-930"></a><span>    </span><a name="local-6989586621682073335"><a href="#local-6989586621682073335"><span class="hs-identifier">cvs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchCoVars"><span class="hs-identifier hs-var">coAxBranchCoVars</span></a><span> </span><a href="#local-6989586621682073333"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-931"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073336"><a href="#local-6989586621682073336"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073337"><a href="#local-6989586621682073337"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-6989586621682073334"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073331"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-932"></a><span>    </span><a name="local-6989586621682073338"><a href="#local-6989586621682073338"><span class="hs-identifier">lhs_tys</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTysWith"><span class="hs-identifier hs-var">substTysWith</span></a><span> </span><a href="#local-6989586621682073334"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073336"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-933"></a><span>                   </span><a href="TyCoRep.html#substTysWithCoVars"><span class="hs-identifier hs-var">substTysWithCoVars</span></a><span> </span><a href="#local-6989586621682073335"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621682073332"><span class="hs-identifier hs-var">cos</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-934"></a><span>                   </span><a href="CoAxiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a><span> </span><a href="#local-6989586621682073333"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-935"></a><span>    </span><a name="local-6989586621682073339"><a href="#local-6989586621682073339"><span class="hs-identifier">fam_tc</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a><span> </span><a href="#local-6989586621682073329"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span class="hs-comment">-- | Instantiate the left-hand side of an unbranched axiom</span><span>
</span><a name="line-938"></a><span class="hs-identifier">mkUnbranchedAxInstLHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-939"></a><a name="mkUnbranchedAxInstLHS"><a href="Coercion.html#mkUnbranchedAxInstLHS"><span class="hs-identifier">mkUnbranchedAxInstLHS</span></a></a><span> </span><a name="local-6989586621682073340"><a href="#local-6989586621682073340"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAxInstLHS"><span class="hs-identifier hs-var">mkAxInstLHS</span></a><span> </span><a href="#local-6989586621682073340"><span class="hs-identifier hs-var">ax</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span class="hs-comment">-- | Manufacture an unsafe coercion from thin air.</span><span>
</span><a name="line-942"></a><span class="hs-comment">--   Currently (May 14) this is used only to implement the</span><span>
</span><a name="line-943"></a><span class="hs-comment">--   @unsafeCoerce#@ primitive.  Optimise by pushing</span><span>
</span><a name="line-944"></a><span class="hs-comment">--   down through type constructors.</span><span>
</span><a name="line-945"></a><span class="hs-identifier">mkUnsafeCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-946"></a><a name="mkUnsafeCo"><a href="Coercion.html#mkUnsafeCo"><span class="hs-identifier">mkUnsafeCo</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682073342"><a href="#local-6989586621682073342"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073343"><a href="#local-6989586621682073343"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-947"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a><span> </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682073342"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073343"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-948"></a><span>
</span><a name="line-949"></a><span class="hs-comment">-- | Make a coercion from a coercion hole</span><span>
</span><a name="line-950"></a><span class="hs-identifier">mkHoleCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#CoercionHole"><span class="hs-identifier hs-type">CoercionHole</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-951"></a><a name="mkHoleCo"><a href="Coercion.html#mkHoleCo"><span class="hs-identifier">mkHoleCo</span></a></a><span> </span><a name="local-6989586621682073344"><a href="#local-6989586621682073344"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#HoleCo"><span class="hs-identifier hs-var">HoleCo</span></a><span> </span><a href="#local-6989586621682073344"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-952"></a><span>
</span><a name="line-953"></a><span class="hs-comment">-- | Make a universal coercion between two arbitrary types.</span><span>
</span><a name="line-954"></a><span class="hs-identifier">mkUnivCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#UnivCoProvenance"><span class="hs-identifier hs-type">UnivCoProvenance</span></a><span>
</span><a name="line-955"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>       </span><span class="hs-comment">-- ^ role of the built coercion, &quot;r&quot;</span><span>
</span><a name="line-956"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>       </span><span class="hs-comment">-- ^ t1 :: k1</span><span>
</span><a name="line-957"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>       </span><span class="hs-comment">-- ^ t2 :: k2</span><span>
</span><a name="line-958"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>   </span><span class="hs-comment">-- ^ :: t1 ~r t2</span><span>
</span><a name="line-959"></a><a name="mkUnivCo"><a href="Coercion.html#mkUnivCo"><span class="hs-identifier">mkUnivCo</span></a></a><span> </span><a name="local-6989586621682073345"><a href="#local-6989586621682073345"><span class="hs-identifier">prov</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682073347"><a href="#local-6989586621682073347"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073348"><a href="#local-6989586621682073348"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-960"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073347"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073348"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682073347"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-961"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a href="#local-6989586621682073345"><span class="hs-identifier hs-var">prov</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682073347"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073348"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-962"></a><span>
</span><a name="line-963"></a><span class="hs-comment">-- | Create a symmetric version of the given 'Coercion' that asserts</span><span>
</span><a name="line-964"></a><span class="hs-comment">--   equality between the same types but in the other &quot;direction&quot;, so</span><span>
</span><a name="line-965"></a><span class="hs-comment">--   a kind of @t1 ~ t2@ becomes the kind @t2 ~ t1@.</span><span>
</span><a name="line-966"></a><span class="hs-identifier">mkSymCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span class="hs-comment">-- Do a few simple optimizations, but don't bother pushing occurrences</span><span>
</span><a name="line-969"></a><span class="hs-comment">-- of symmetry to the leaves; the optimizer will take care of that.</span><span>
</span><a name="line-970"></a><a name="mkSymCo"><a href="Coercion.html#mkSymCo"><span class="hs-identifier">mkSymCo</span></a></a><span> </span><a name="local-6989586621682073349"><a href="#local-6989586621682073349"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621682073349"><span class="hs-identifier hs-var">co</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073349"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-971"></a><span class="hs-identifier">mkSymCo</span><span>    </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621682073350"><a href="#local-6989586621682073350"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073350"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-972"></a><span class="hs-identifier">mkSymCo</span><span>    </span><span class="hs-special">(</span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621682073351"><a href="#local-6989586621682073351"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a href="#local-6989586621682073351"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-973"></a><span class="hs-identifier">mkSymCo</span><span> </span><a name="local-6989586621682073352"><a href="#local-6989586621682073352"><span class="hs-identifier">co</span></a></a><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a href="#local-6989586621682073352"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-974"></a><span>
</span><a name="line-975"></a><span class="hs-comment">-- | Create a new 'Coercion' by composing the two given 'Coercion's transitively.</span><span>
</span><a name="line-976"></a><span class="hs-comment">--   (co1 ; co2)</span><span>
</span><a name="line-977"></a><span class="hs-identifier">mkTransCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-978"></a><a name="mkTransCo"><a href="Coercion.html#mkTransCo"><span class="hs-identifier">mkTransCo</span></a></a><span> </span><a name="local-6989586621682073353"><a href="#local-6989586621682073353"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073354"><a href="#local-6989586621682073354"><span class="hs-identifier">co2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621682073353"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073354"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-979"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621682073354"><span class="hs-identifier hs-var">co2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073353"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-980"></a><span class="hs-identifier">mkTransCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a name="local-6989586621682073355"><a href="#local-6989586621682073355"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073356"><a href="#local-6989586621682073356"><span class="hs-identifier">t1</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073357"><a href="#local-6989586621682073357"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073358"><a href="#local-6989586621682073358"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="#local-6989586621682073355"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073356"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span> </span><a href="#local-6989586621682073357"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682073358"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span class="hs-identifier">mkTransCo</span><span> </span><a name="local-6989586621682073359"><a href="#local-6989586621682073359"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073360"><a href="#local-6989586621682073360"><span class="hs-identifier">co2</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a href="#local-6989586621682073359"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682073360"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span class="hs-comment">-- | Compose two MCoercions via transitivity</span><span>
</span><a name="line-985"></a><span class="hs-identifier">mkTransMCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span>
</span><a name="line-986"></a><a name="mkTransMCo"><a href="Coercion.html#mkTransMCo"><span class="hs-identifier">mkTransMCo</span></a></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>     </span><a name="local-6989586621682073361"><a href="#local-6989586621682073361"><span class="hs-identifier">co2</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073361"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-987"></a><span class="hs-identifier">mkTransMCo</span><span> </span><a name="local-6989586621682073362"><a href="#local-6989586621682073362"><span class="hs-identifier">co1</span></a></a><span>       </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073362"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-988"></a><span class="hs-identifier">mkTransMCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073363"><a href="#local-6989586621682073363"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073364"><a href="#local-6989586621682073364"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span> </span><a href="#local-6989586621682073363"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682073364"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-989"></a><span>
</span><a name="line-990"></a><span class="hs-identifier">mkNthCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Util.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a><span>
</span><a name="line-991"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>  </span><span class="hs-comment">-- The role of the coercion you're creating</span><span>
</span><a name="line-992"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>   </span><span class="hs-comment">-- Zero-indexed</span><span>
</span><a name="line-993"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-994"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-995"></a><a name="mkNthCo"><a href="Coercion.html#mkNthCo"><span class="hs-identifier">mkNthCo</span></a></a><span> </span><a name="local-6989586621682073365"><a href="#local-6989586621682073365"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073366"><a href="#local-6989586621682073366"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682073367"><a href="#local-6989586621682073367"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-996"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">good_call</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bad_call_msg</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-997"></a><span>    </span><a href="#local-6989586621682073370"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073365"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073366"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682073367"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-998"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-999"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073368"><a href="#local-6989586621682073368"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073369"><a href="#local-6989586621682073369"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073367"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1000"></a><span>
</span><a name="line-1001"></a><span>    </span><a name="local-6989586621682073370"><a href="#local-6989586621682073370"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682073373"><a href="#local-6989586621682073373"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621682073374"><a href="#local-6989586621682073374"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1002"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073375"><a href="#local-6989586621682073375"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073374"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1003"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073376"><a href="#local-6989586621682073376"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-6989586621682073375"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1004"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- works for both tyvar and covar</span><span>
</span><a name="line-1005"></a><span>        </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1006"></a><span>        </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073376"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><span>
</span><a name="line-1008"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073377"><a href="#local-6989586621682073377"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073378"><a href="#local-6989586621682073378"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682073379"><a href="#local-6989586621682073379"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1009"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073384"><a href="#local-6989586621682073384"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073385"><a href="#local-6989586621682073385"><span class="hs-identifier">r0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073379"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1010"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073386"><a href="#local-6989586621682073386"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#tyConAppTyCon"><span class="hs-identifier hs-var">tyConAppTyCon</span></a><span> </span><a href="#local-6989586621682073384"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1011"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">ok_tc_app</span><span> </span><span class="hs-identifier">ty</span><span> </span><a href="#local-6989586621682073380"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073380"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073380"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ty</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1012"></a><span>        </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">nthRole</span><span> </span><span class="hs-identifier hs-var">r0</span><span> </span><span class="hs-identifier">tc</span><span> </span><a href="Coercion.html#nthRole"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Coercion.html#nthRole"><span class="hs-operator hs-var">==</span></a><span> </span><a href="Coercion.html#nthRole"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1013"></a><span>        </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073377"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#tyConAppArgN"><span class="hs-identifier hs-var">tyConAppArgN</span></a><span> </span><a href="#local-6989586621682073378"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682073384"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1014"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">ok_tc_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1015"></a><span>            </span><a name="local-6989586621682073380"><a href="#local-6989586621682073380"><span class="hs-identifier">ok_tc_app</span></a></a><span> </span><a name="local-6989586621682073381"><a href="#local-6989586621682073381"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073382"><a href="#local-6989586621682073382"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-1016"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682073383"><a href="#local-6989586621682073383"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682073381"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1017"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073383"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthExceeds"><span class="hs-identifier hs-var">lengthExceeds</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073382"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1018"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isForAllTy"><span class="hs-identifier hs-var">isForAllTy</span></a><span> </span><a href="#local-6989586621682073381"><span class="hs-identifier hs-var">ty</span></a><span>  </span><span class="hs-comment">-- nth:0 pulls out a kind coercion from a hetero forall</span><span>
</span><a name="line-1019"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073382"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1020"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1021"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1022"></a><span>
</span><a name="line-1023"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073387"><a href="#local-6989586621682073387"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073388"><a href="#local-6989586621682073388"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>        </span><a href="#local-6989586621682073388"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-1026"></a><span>      </span><span class="hs-comment">-- If co :: (forall a1:k1. t1) ~ (forall a2:k2. t2)</span><span>
</span><a name="line-1027"></a><span>      </span><span class="hs-comment">-- then (nth 0 co :: k1 ~N k2)</span><span>
</span><a name="line-1028"></a><span>      </span><span class="hs-comment">-- If co :: (forall a1:t1 ~ t2. t1) ~ (forall a2:t3 ~ t4. t2)</span><span>
</span><a name="line-1029"></a><span>      </span><span class="hs-comment">-- then (nth 0 co :: (t1 ~ t2) ~N (t3 ~ t4))</span><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073389"><a href="#local-6989586621682073389"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073390"><a href="#local-6989586621682073390"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682073391"><a href="#local-6989586621682073391"><span class="hs-identifier">co</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><a name="local-6989586621682073392"><a href="#local-6989586621682073392"><span class="hs-identifier">r0</span></a></a><span> </span><a name="local-6989586621682073393"><a href="#local-6989586621682073393"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621682073394"><a href="#local-6989586621682073394"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1032"></a><span>      </span><span class="hs-comment">-- See Note [Function coercions]</span><span>
</span><a name="line-1033"></a><span>      </span><span class="hs-comment">-- If FunCo _ arg_co res_co ::   (s1:TYPE sk1 -&gt; s2:TYPE sk2)</span><span>
</span><a name="line-1034"></a><span>      </span><span class="hs-comment">--                             ~ (t1:TYPE tk1 -&gt; t2:TYPE tk2)</span><span>
</span><a name="line-1035"></a><span>      </span><span class="hs-comment">-- Then we want to behave as if co was</span><span>
</span><a name="line-1036"></a><span>      </span><span class="hs-comment">--    TyConAppCo argk_co resk_co arg_co res_co</span><span>
</span><a name="line-1037"></a><span>      </span><span class="hs-comment">-- where</span><span>
</span><a name="line-1038"></a><span>      </span><span class="hs-comment">--    argk_co :: sk1 ~ tk1  =  mkNthCo 0 (mkKindCo arg_co)</span><span>
</span><a name="line-1039"></a><span>      </span><span class="hs-comment">--    resk_co :: sk2 ~ tk2  =  mkNthCo 0 (mkKindCo res_co)</span><span>
</span><a name="line-1040"></a><span>      </span><span class="hs-comment">--                             i.e. mkRuntimeRepCo</span><span>
</span><a name="line-1041"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682073390"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1042"></a><span>          </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mkRuntimeRepCo</span><span> </span><span class="hs-identifier">arg</span><span>
</span><a name="line-1043"></a><span>          </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mkRuntimeRepCo</span><span> </span><span class="hs-identifier">res</span><span>
</span><a name="line-1044"></a><span>          </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier hs-var">r0</span><span> </span><span class="hs-special">)</span><span>      </span><span class="hs-identifier">arg</span><span>
</span><a name="line-1045"></a><span>          </span><span class="hs-number">3</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier hs-var">r0</span><span> </span><span class="hs-special">)</span><span>      </span><span class="hs-identifier">res</span><span>
</span><a name="line-1046"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;mkNthCo(FunCo)&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073390"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073391"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1047"></a><span>
</span><a name="line-1048"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073395"><a href="#local-6989586621682073395"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073396"><a href="#local-6989586621682073396"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-6989586621682073397"><a href="#local-6989586621682073397"><span class="hs-identifier">r0</span></a></a><span> </span><a name="local-6989586621682073398"><a href="#local-6989586621682073398"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073399"><a href="#local-6989586621682073399"><span class="hs-identifier">arg_cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">nthRole</span><span> </span><span class="hs-identifier">r0</span><span> </span><span class="hs-identifier">tc</span><span> </span><a href="Coercion.html#nthRole"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1049"></a><span>                                                    </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">vcat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">tc</span><span>
</span><a name="line-1050"></a><span>                                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">arg_cos</span><span>
</span><a name="line-1051"></a><span>                                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">r0</span><span>
</span><a name="line-1052"></a><span>                                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">n</span><span>
</span><a name="line-1053"></a><span>                                                            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1054"></a><span>                                             </span><a href="#local-6989586621682073399"><span class="hs-identifier hs-var">arg_cos</span></a><span> </span><span class="hs-special">`</span><a href="ListSetOps.html#getNth"><span class="hs-identifier hs-var">getNth</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073396"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073400"><a href="#local-6989586621682073400"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073401"><a href="#local-6989586621682073401"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682073402"><a href="#local-6989586621682073402"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1057"></a><span>      </span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><a href="#local-6989586621682073400"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073401"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682073402"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1058"></a><span>
</span><a name="line-1059"></a><span>    </span><span class="hs-comment">-- Assertion checking</span><span>
</span><a name="line-1060"></a><span>    </span><a name="local-6989586621682073371"><a href="#local-6989586621682073371"><span class="hs-identifier">bad_call_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Coercion =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073367"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1061"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;LHS ty =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073368"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1062"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;RHS ty =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073369"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1063"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;n =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073366"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;r =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073365"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1064"></a><span>                        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;coercion role =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073367"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1065"></a><span>    </span><a name="local-6989586621682073372"><a href="#local-6989586621682073372"><span class="hs-identifier">good_call</span></a></a><span>
</span><a name="line-1066"></a><span>      </span><span class="hs-comment">-- If the Coercion passed in is between forall-types, then the Int must</span><span>
</span><a name="line-1067"></a><span>      </span><span class="hs-comment">-- be 0 and the role must be Nominal.</span><span>
</span><a name="line-1068"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073403"><a href="#local-6989586621682073403"><span class="hs-identifier">_tv1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-6989586621682073368"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1069"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073404"><a href="#local-6989586621682073404"><span class="hs-identifier">_tv2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-6989586621682073369"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1070"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073366"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682073365"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span>      </span><span class="hs-comment">-- If the Coercion passed in is between T tys and T tys', then the Int</span><span>
</span><a name="line-1073"></a><span>      </span><span class="hs-comment">-- must be less than the length of tys/tys' (which must be the same</span><span>
</span><a name="line-1074"></a><span>      </span><span class="hs-comment">-- lengths).</span><span>
</span><a name="line-1075"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1076"></a><span>      </span><span class="hs-comment">-- If the role of the Coercion is nominal, then the role passed in must</span><span>
</span><a name="line-1077"></a><span>      </span><span class="hs-comment">-- be nominal. If the role of the Coercion is representational, then the</span><span>
</span><a name="line-1078"></a><span>      </span><span class="hs-comment">-- role passed in must be tyConRolesRepresentational T !! n. If the role</span><span>
</span><a name="line-1079"></a><span>      </span><span class="hs-comment">-- of the Coercion is Phantom, then the role passed in must be Phantom.</span><span>
</span><a name="line-1080"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1081"></a><span>      </span><span class="hs-comment">-- See also Note [NthCo Cached Roles] if you're wondering why it's</span><span>
</span><a name="line-1082"></a><span>      </span><span class="hs-comment">-- blaringly obvious that we should be *computing* this role instead of</span><span>
</span><a name="line-1083"></a><span>      </span><span class="hs-comment">-- passing it in.</span><span>
</span><a name="line-1084"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073405"><a href="#local-6989586621682073405"><span class="hs-identifier">tc1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073406"><a href="#local-6989586621682073406"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682073368"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1085"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073407"><a href="#local-6989586621682073407"><span class="hs-identifier">tc2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073408"><a href="#local-6989586621682073408"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682073369"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1086"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073405"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682073407"><span class="hs-identifier hs-var">tc2</span></a><span>
</span><a name="line-1087"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073409"><a href="#local-6989586621682073409"><span class="hs-identifier">len1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682073406"><span class="hs-identifier hs-var">tys1</span></a><span>
</span><a name="line-1088"></a><span>            </span><a name="local-6989586621682073410"><a href="#local-6989586621682073410"><span class="hs-identifier">len2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682073408"><span class="hs-identifier hs-var">tys2</span></a><span>
</span><a name="line-1089"></a><span>            </span><a name="local-6989586621682073411"><a href="#local-6989586621682073411"><span class="hs-identifier">good_role</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073367"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1090"></a><span>                          </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073365"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1091"></a><span>                          </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073365"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-6989586621682073405"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><a href="#local-6989586621682073366"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1092"></a><span>                          </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073365"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>
</span><a name="line-1093"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621682073409"><span class="hs-identifier hs-var">len1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682073410"><span class="hs-identifier hs-var">len2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682073366"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-6989586621682073409"><span class="hs-identifier hs-var">len1</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682073411"><span class="hs-identifier hs-var">good_role</span></a><span>
</span><a name="line-1094"></a><span>
</span><a name="line-1095"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1096"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1097"></a><span>
</span><a name="line-1098"></a><span>
</span><a name="line-1099"></a><span>
</span><a name="line-1100"></a><span class="hs-comment">-- | If you're about to call @mkNthCo r n co@, then @r@ should be</span><span>
</span><a name="line-1101"></a><span class="hs-comment">-- whatever @nthCoRole n co@ returns.</span><span>
</span><a name="line-1102"></a><span class="hs-identifier">nthCoRole</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>
</span><a name="line-1103"></a><a name="nthCoRole"><a href="Coercion.html#nthCoRole"><span class="hs-identifier">nthCoRole</span></a></a><span> </span><a name="local-6989586621682073412"><a href="#local-6989586621682073412"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682073413"><a href="#local-6989586621682073413"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1104"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073416"><a href="#local-6989586621682073416"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682073414"><span class="hs-identifier hs-var">lty</span></a><span>
</span><a name="line-1105"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#nthRole"><span class="hs-identifier hs-var">nthRole</span></a><span> </span><a href="#local-6989586621682073415"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073416"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073412"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1106"></a><span>
</span><a name="line-1107"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-6989586621682073414"><span class="hs-identifier hs-var">lty</span></a><span>
</span><a name="line-1108"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1109"></a><span>
</span><a name="line-1110"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1111"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;nthCoRole&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073413"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1112"></a><span>
</span><a name="line-1113"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1114"></a><span>    </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073414"><a href="#local-6989586621682073414"><span class="hs-identifier">lty</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682073415"><a href="#local-6989586621682073415"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-6989586621682073413"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1115"></a><span>
</span><a name="line-1116"></a><span class="hs-identifier">mkLRCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#LeftOrRight"><span class="hs-identifier hs-type">LeftOrRight</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1117"></a><a name="mkLRCo"><a href="Coercion.html#mkLRCo"><span class="hs-identifier">mkLRCo</span></a></a><span> </span><a name="local-6989586621682073417"><a href="#local-6989586621682073417"><span class="hs-identifier">lr</span></a></a><span> </span><a name="local-6989586621682073418"><a href="#local-6989586621682073418"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1118"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073419"><a href="#local-6989586621682073419"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073420"><a href="#local-6989586621682073420"><span class="hs-identifier">eq</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073418"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1119"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073420"><span class="hs-identifier hs-var">eq</span></a><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#pickLR"><span class="hs-identifier hs-var">pickLR</span></a><span> </span><a href="#local-6989586621682073417"><span class="hs-identifier hs-var">lr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#splitAppTy"><span class="hs-identifier hs-var">splitAppTy</span></a><span> </span><a href="#local-6989586621682073419"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1120"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1121"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a href="#local-6989586621682073417"><span class="hs-identifier hs-var">lr</span></a><span> </span><a href="#local-6989586621682073418"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1122"></a><span>
</span><a name="line-1123"></a><span class="hs-comment">-- | Instantiates a 'Coercion'.</span><span>
</span><a name="line-1124"></a><span class="hs-identifier">mkInstCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1125"></a><a name="mkInstCo"><a href="Coercion.html#mkInstCo"><span class="hs-identifier">mkInstCo</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073421"><a href="#local-6989586621682073421"><span class="hs-identifier">tcv</span></a></a><span> </span><a name="local-6989586621682073422"><a href="#local-6989586621682073422"><span class="hs-identifier">_kind_co</span></a></a><span> </span><a name="local-6989586621682073423"><a href="#local-6989586621682073423"><span class="hs-identifier">body_co</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073424"><a href="#local-6989586621682073424"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1126"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073425"><a href="#local-6989586621682073425"><span class="hs-identifier">arg</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073424"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1127"></a><span>      </span><span class="hs-comment">-- works for both tyvar and covar</span><span>
</span><a name="line-1128"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substCoUnchecked"><span class="hs-identifier hs-var">substCoUnchecked</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#zipTCvSubst"><span class="hs-identifier hs-var">zipTCvSubst</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682073421"><span class="hs-identifier hs-var">tcv</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682073425"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073423"><span class="hs-identifier hs-var">body_co</span></a><span>
</span><a name="line-1129"></a><span class="hs-identifier">mkInstCo</span><span> </span><a name="local-6989586621682073426"><a href="#local-6989586621682073426"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073427"><a href="#local-6989586621682073427"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a href="#local-6989586621682073426"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682073427"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1130"></a><span>
</span><a name="line-1131"></a><span class="hs-comment">-- | Given @ty :: k1@, @co :: k1 ~ k2@,</span><span>
</span><a name="line-1132"></a><span class="hs-comment">-- produces @co' :: ty ~r (ty |&gt; co)@</span><span>
</span><a name="line-1133"></a><span class="hs-identifier">mkGReflRightCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1134"></a><a name="mkGReflRightCo"><a href="Coercion.html#mkGReflRightCo"><span class="hs-identifier">mkGReflRightCo</span></a></a><span> </span><a name="local-6989586621682073428"><a href="#local-6989586621682073428"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073429"><a href="#local-6989586621682073429"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073430"><a href="#local-6989586621682073430"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1135"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073430"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073428"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073429"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1136"></a><span>    </span><span class="hs-comment">-- the kinds of @k1@ and @k2@ are the same, thus @isGReflCo@</span><span>
</span><a name="line-1137"></a><span>    </span><span class="hs-comment">-- instead of @isReflCo@</span><span>
</span><a name="line-1138"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="#local-6989586621682073428"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073429"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a href="#local-6989586621682073430"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1139"></a><span>
</span><a name="line-1140"></a><span class="hs-comment">-- | Given @ty :: k1@, @co :: k1 ~ k2@,</span><span>
</span><a name="line-1141"></a><span class="hs-comment">-- produces @co' :: (ty |&gt; co) ~r ty@</span><span>
</span><a name="line-1142"></a><span class="hs-identifier">mkGReflLeftCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1143"></a><a name="mkGReflLeftCo"><a href="Coercion.html#mkGReflLeftCo"><span class="hs-identifier">mkGReflLeftCo</span></a></a><span> </span><a name="local-6989586621682073431"><a href="#local-6989586621682073431"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073432"><a href="#local-6989586621682073432"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073433"><a href="#local-6989586621682073433"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1144"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073433"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073431"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073432"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1145"></a><span>    </span><span class="hs-comment">-- the kinds of @k1@ and @k2@ are the same, thus @isGReflCo@</span><span>
</span><a name="line-1146"></a><span>    </span><span class="hs-comment">-- instead of @isReflCo@</span><span>
</span><a name="line-1147"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="#local-6989586621682073431"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073432"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a href="#local-6989586621682073433"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span class="hs-comment">-- | Given @ty :: k1@, @co :: k1 ~ k2@, @co2:: ty ~r ty'@,</span><span>
</span><a name="line-1150"></a><span class="hs-comment">-- produces @co' :: (ty |&gt; co) ~r ty'</span><span>
</span><a name="line-1151"></a><span class="hs-comment">-- It is not only a utility function, but it saves allocation when co</span><span>
</span><a name="line-1152"></a><span class="hs-comment">-- is a GRefl coercion.</span><span>
</span><a name="line-1153"></a><span class="hs-identifier">mkCoherenceLeftCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1154"></a><a name="mkCoherenceLeftCo"><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier">mkCoherenceLeftCo</span></a></a><span> </span><a name="local-6989586621682073434"><a href="#local-6989586621682073434"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073435"><a href="#local-6989586621682073435"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073436"><a href="#local-6989586621682073436"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073437"><a href="#local-6989586621682073437"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-1155"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073436"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073437"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="#local-6989586621682073434"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073435"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a href="#local-6989586621682073436"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073437"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1157"></a><span>
</span><a name="line-1158"></a><span class="hs-comment">-- | Given @ty :: k1@, @co :: k1 ~ k2@, @co2:: ty' ~r ty@,</span><span>
</span><a name="line-1159"></a><span class="hs-comment">-- produces @co' :: ty' ~r (ty |&gt; co)</span><span>
</span><a name="line-1160"></a><span class="hs-comment">-- It is not only a utility function, but it saves allocation when co</span><span>
</span><a name="line-1161"></a><span class="hs-comment">-- is a GRefl coercion.</span><span>
</span><a name="line-1162"></a><span class="hs-identifier">mkCoherenceRightCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1163"></a><a name="mkCoherenceRightCo"><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier">mkCoherenceRightCo</span></a></a><span> </span><a name="local-6989586621682073438"><a href="#local-6989586621682073438"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073439"><a href="#local-6989586621682073439"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073440"><a href="#local-6989586621682073440"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073441"><a href="#local-6989586621682073441"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-1164"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073440"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073441"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1165"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073441"><span class="hs-identifier hs-var">co2</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="#local-6989586621682073438"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073439"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a href="#local-6989586621682073440"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1166"></a><span>
</span><a name="line-1167"></a><span class="hs-comment">-- | Given @co :: (a :: k) ~ (b :: k')@ produce @co' :: k ~ k'@.</span><span>
</span><a name="line-1168"></a><span class="hs-identifier">mkKindCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1169"></a><a name="mkKindCo"><a href="Coercion.html#mkKindCo"><span class="hs-identifier">mkKindCo</span></a></a><span> </span><a name="local-6989586621682073442"><a href="#local-6989586621682073442"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073443"><a href="#local-6989586621682073443"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073442"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073443"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1170"></a><span class="hs-identifier">mkKindCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073444"><a href="#local-6989586621682073444"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073444"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1171"></a><span class="hs-identifier">mkKindCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-6989586621682073445"><a href="#local-6989586621682073445"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073445"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-1172"></a><span class="hs-identifier">mkKindCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a name="local-6989586621682073446"><a href="#local-6989586621682073446"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073446"><span class="hs-identifier hs-var">h</span></a><span>
</span><a name="line-1173"></a><span class="hs-identifier">mkKindCo</span><span> </span><a name="local-6989586621682073447"><a href="#local-6989586621682073447"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1174"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073448"><a href="#local-6989586621682073448"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073449"><a href="#local-6989586621682073449"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073447"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1175"></a><span>       </span><span class="hs-comment">-- generally, calling coercionKind during coercion creation is a bad idea,</span><span>
</span><a name="line-1176"></a><span>       </span><span class="hs-comment">-- as it can lead to exponential behavior. But, we don't have nested mkKindCos,</span><span>
</span><a name="line-1177"></a><span>       </span><span class="hs-comment">-- so it's OK here.</span><span>
</span><a name="line-1178"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073450"><a href="#local-6989586621682073450"><span class="hs-identifier">tk1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073448"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1179"></a><span>        </span><a name="local-6989586621682073451"><a href="#local-6989586621682073451"><span class="hs-identifier">tk2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073449"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1180"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073450"><span class="hs-identifier hs-var">tk1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073451"><span class="hs-identifier hs-var">tk2</span></a><span>
</span><a name="line-1181"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a href="#local-6989586621682073450"><span class="hs-identifier hs-var">tk1</span></a><span>
</span><a name="line-1182"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1183"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><a href="#local-6989586621682073447"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1184"></a><span>
</span><a name="line-1185"></a><span class="hs-identifier">mkSubCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1186"></a><span class="hs-comment">-- Input coercion is Nominal, result is Representational</span><span>
</span><a name="line-1187"></a><span class="hs-comment">-- see also Note [Role twiddling functions]</span><span>
</span><a name="line-1188"></a><a name="mkSubCo"><a href="Coercion.html#mkSubCo"><span class="hs-identifier">mkSubCo</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-6989586621682073452"><a href="#local-6989586621682073452"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073452"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>
</span><a name="line-1189"></a><span class="hs-identifier">mkSubCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a name="local-6989586621682073453"><a href="#local-6989586621682073453"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073454"><a href="#local-6989586621682073454"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073453"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682073454"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1190"></a><span class="hs-identifier">mkSubCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a name="local-6989586621682073455"><a href="#local-6989586621682073455"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073456"><a href="#local-6989586621682073456"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1191"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073455"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#applyRoles"><span class="hs-identifier hs-var">applyRoles</span></a><span> </span><a href="#local-6989586621682073455"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073456"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-1192"></a><span class="hs-identifier">mkSubCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a name="local-6989586621682073457"><a href="#local-6989586621682073457"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621682073458"><a href="#local-6989586621682073458"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1193"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span>
</span><a name="line-1194"></a><span>          </span><span class="hs-special">(</span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073457"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1195"></a><span>          </span><span class="hs-special">(</span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073458"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1196"></a><span class="hs-identifier">mkSubCo</span><span> </span><a name="local-6989586621682073459"><a href="#local-6989586621682073459"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">coercionRole</span><span> </span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="Coercion.html#coercionRole"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">coercionRole</span><span> </span><a href="Outputable.html#assertPprPanic"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1197"></a><span>             </span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a href="#local-6989586621682073459"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1198"></a><span>
</span><a name="line-1199"></a><span class="hs-comment">-- | Changes a role, but only a downgrade. See Note [Role twiddling functions]</span><span>
</span><a name="line-1200"></a><span class="hs-identifier">downgradeRole_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>   </span><span class="hs-comment">-- ^ desired role</span><span>
</span><a name="line-1201"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>   </span><span class="hs-comment">-- ^ current role</span><span>
</span><a name="line-1202"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1203"></a><span class="hs-comment">-- In (downgradeRole_maybe dr cr co) it's a precondition that</span><span>
</span><a name="line-1204"></a><span class="hs-comment">--                                   cr = coercionRole co</span><span>
</span><a name="line-1205"></a><span>
</span><a name="line-1206"></a><a name="downgradeRole_maybe"><a href="Coercion.html#downgradeRole_maybe"><span class="hs-identifier">downgradeRole_maybe</span></a></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><a name="local-6989586621682073460"><a href="#local-6989586621682073460"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682073460"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1207"></a><span class="hs-identifier">downgradeRole_maybe</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><span class="hs-identifier">_</span><span>                </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span class="hs-identifier">downgradeRole_maybe</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><a name="local-6989586621682073461"><a href="#local-6989586621682073461"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSubCo"><span class="hs-identifier hs-var">mkSubCo</span></a><span> </span><a href="#local-6989586621682073461"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1210"></a><span class="hs-identifier">downgradeRole_maybe</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a name="local-6989586621682073462"><a href="#local-6989586621682073462"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682073462"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1211"></a><span class="hs-identifier">downgradeRole_maybe</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>          </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1212"></a><span>
</span><a name="line-1213"></a><span class="hs-identifier">downgradeRole_maybe</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>          </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>          </span><a name="local-6989586621682073463"><a href="#local-6989586621682073463"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682073463"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1214"></a><span class="hs-identifier">downgradeRole_maybe</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>          </span><span class="hs-identifier">_</span><span>                </span><a name="local-6989586621682073464"><a href="#local-6989586621682073464"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#toPhantomCo"><span class="hs-identifier hs-var">toPhantomCo</span></a><span> </span><a href="#local-6989586621682073464"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1215"></a><span>
</span><a name="line-1216"></a><span class="hs-comment">-- | Like 'downgradeRole_maybe', but panics if the change isn't a downgrade.</span><span>
</span><a name="line-1217"></a><span class="hs-comment">-- See Note [Role twiddling functions]</span><span>
</span><a name="line-1218"></a><span class="hs-identifier">downgradeRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>  </span><span class="hs-comment">-- desired role</span><span>
</span><a name="line-1219"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>  </span><span class="hs-comment">-- current role</span><span>
</span><a name="line-1220"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1221"></a><a name="downgradeRole"><a href="Coercion.html#downgradeRole"><span class="hs-identifier">downgradeRole</span></a></a><span> </span><a name="local-6989586621682073465"><a href="#local-6989586621682073465"><span class="hs-identifier">r1</span></a></a><span> </span><a name="local-6989586621682073466"><a href="#local-6989586621682073466"><span class="hs-identifier">r2</span></a></a><span> </span><a name="local-6989586621682073467"><a href="#local-6989586621682073467"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1222"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Coercion.html#downgradeRole_maybe"><span class="hs-identifier hs-var">downgradeRole_maybe</span></a><span> </span><a href="#local-6989586621682073465"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-6989586621682073466"><span class="hs-identifier hs-var">r2</span></a><span> </span><a href="#local-6989586621682073467"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1223"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073468"><a href="#local-6989586621682073468"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073468"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-1224"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;downgradeRole&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073467"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1225"></a><span>
</span><a name="line-1226"></a><span class="hs-comment">-- | If the EqRel is ReprEq, makes a SubCo; otherwise, does nothing.</span><span>
</span><a name="line-1227"></a><span class="hs-comment">-- Note that the input coercion should always be nominal.</span><span>
</span><a name="line-1228"></a><span class="hs-identifier">maybeSubCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Type.html#EqRel"><span class="hs-identifier hs-type">EqRel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1229"></a><a name="maybeSubCo"><a href="Coercion.html#maybeSubCo"><span class="hs-identifier">maybeSubCo</span></a></a><span> </span><a href="Type.html#NomEq"><span class="hs-identifier hs-var">NomEq</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-1230"></a><span class="hs-identifier">maybeSubCo</span><span> </span><a href="Type.html#ReprEq"><span class="hs-identifier hs-var">ReprEq</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSubCo"><span class="hs-identifier hs-var">mkSubCo</span></a><span>
</span><a name="line-1231"></a><span>
</span><a name="line-1232"></a><span>
</span><a name="line-1233"></a><span class="hs-identifier">mkAxiomRuleCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiomRule"><span class="hs-identifier hs-type">CoAxiomRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1234"></a><a name="mkAxiomRuleCo"><a href="Coercion.html#mkAxiomRuleCo"><span class="hs-identifier">mkAxiomRuleCo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span>
</span><a name="line-1235"></a><span>
</span><a name="line-1236"></a><span class="hs-comment">-- | Make a &quot;coercion between coercions&quot;.</span><span>
</span><a name="line-1237"></a><span class="hs-identifier">mkProofIrrelCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>       </span><span class="hs-comment">-- ^ role of the created coercion, &quot;r&quot;</span><span>
</span><a name="line-1238"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>   </span><span class="hs-comment">-- ^ :: phi1 ~N phi2</span><span>
</span><a name="line-1239"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>   </span><span class="hs-comment">-- ^ g1 :: phi1</span><span>
</span><a name="line-1240"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>   </span><span class="hs-comment">-- ^ g2 :: phi2</span><span>
</span><a name="line-1241"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>   </span><span class="hs-comment">-- ^ :: g1 ~r g2</span><span>
</span><a name="line-1242"></a><span>
</span><a name="line-1243"></a><span class="hs-comment">-- if the two coercion prove the same fact, I just don't care what</span><span>
</span><a name="line-1244"></a><span class="hs-comment">-- the individual coercions are.</span><span>
</span><a name="line-1245"></a><a name="mkProofIrrelCo"><a href="Coercion.html#mkProofIrrelCo"><span class="hs-identifier">mkProofIrrelCo</span></a></a><span> </span><a name="local-6989586621682073469"><a href="#local-6989586621682073469"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073470"><a href="#local-6989586621682073470"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073471"><a href="#local-6989586621682073471"><span class="hs-identifier">g</span></a></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073470"><span class="hs-identifier hs-var">co</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073469"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><a href="#local-6989586621682073471"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-1246"></a><span>  </span><span class="hs-comment">-- kco is a kind coercion, thus @isGReflCo@ rather than @isReflCo@</span><span>
</span><a name="line-1247"></a><span class="hs-identifier">mkProofIrrelCo</span><span> </span><a name="local-6989586621682073472"><a href="#local-6989586621682073472"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073473"><a href="#local-6989586621682073473"><span class="hs-identifier">kco</span></a></a><span>        </span><a name="local-6989586621682073474"><a href="#local-6989586621682073474"><span class="hs-identifier">g1</span></a></a><span> </span><a name="local-6989586621682073475"><a href="#local-6989586621682073475"><span class="hs-identifier">g2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a href="#local-6989586621682073473"><span class="hs-identifier hs-var">kco</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073472"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1248"></a><span>                                             </span><span class="hs-special">(</span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><a href="#local-6989586621682073474"><span class="hs-identifier hs-var">g1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><a href="#local-6989586621682073475"><span class="hs-identifier hs-var">g2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1249"></a><span>
</span><a name="line-1250"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
   Roles
%*                                                                      *
%************************************************************************
-}</span><span>
</span><a name="line-1257"></a><span>
</span><a name="line-1258"></a><span class="hs-comment">-- | Converts a coercion to be nominal, if possible.</span><span>
</span><a name="line-1259"></a><span class="hs-comment">-- See Note [Role twiddling functions]</span><span>
</span><a name="line-1260"></a><span class="hs-identifier">setNominalRole_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-comment">-- of input coercion</span><span>
</span><a name="line-1261"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1262"></a><a name="setNominalRole_maybe"><a href="Coercion.html#setNominalRole_maybe"><span class="hs-identifier">setNominalRole_maybe</span></a></a><span> </span><a name="local-6989586621682073476"><a href="#local-6989586621682073476"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073477"><a href="#local-6989586621682073477"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1263"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073476"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682073477"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1264"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073478"><span class="hs-identifier hs-var">setNominalRole_maybe_helper</span></a><span> </span><a href="#local-6989586621682073477"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1265"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1266"></a><span>    </span><a name="local-6989586621682073478"><a href="#local-6989586621682073478"><span class="hs-identifier">setNominalRole_maybe_helper</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a name="local-6989586621682073479"><a href="#local-6989586621682073479"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682073479"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1267"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><a name="local-6989586621682073480"><a href="#local-6989586621682073480"><span class="hs-identifier">co</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682073480"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1268"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073481"><a href="#local-6989586621682073481"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073482"><a href="#local-6989586621682073482"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073481"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682073482"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1269"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a name="local-6989586621682073483"><a href="#local-6989586621682073483"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073484"><a href="#local-6989586621682073484"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1270"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682073485"><a href="#local-6989586621682073485"><span class="hs-identifier">cos'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><a href="Coercion.html#setNominalRole_maybe"><span class="hs-identifier hs-var">setNominalRole_maybe</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073483"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073484"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-1271"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073483"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073485"><span class="hs-identifier hs-var">cos'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1272"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a name="local-6989586621682073486"><a href="#local-6989586621682073486"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073487"><a href="#local-6989586621682073487"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1273"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682073488"><a href="#local-6989586621682073488"><span class="hs-identifier">co1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#setNominalRole_maybe"><span class="hs-identifier hs-var">setNominalRole_maybe</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073486"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1274"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682073489"><a href="#local-6989586621682073489"><span class="hs-identifier">co2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#setNominalRole_maybe"><span class="hs-identifier hs-var">setNominalRole_maybe</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073487"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1275"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073488"><span class="hs-identifier hs-var">co1'</span></a><span> </span><a href="#local-6989586621682073489"><span class="hs-identifier hs-var">co2'</span></a><span>
</span><a name="line-1276"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-1277"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621682073490"><a href="#local-6989586621682073490"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1278"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073478"><span class="hs-identifier hs-var">setNominalRole_maybe_helper</span></a><span> </span><a href="#local-6989586621682073490"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1279"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-6989586621682073491"><a href="#local-6989586621682073491"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073492"><a href="#local-6989586621682073492"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1280"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073478"><span class="hs-identifier hs-var">setNominalRole_maybe_helper</span></a><span> </span><a href="#local-6989586621682073491"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621682073478"><span class="hs-identifier hs-var">setNominalRole_maybe_helper</span></a><span> </span><a href="#local-6989586621682073492"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1281"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-6989586621682073493"><a href="#local-6989586621682073493"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073494"><a href="#local-6989586621682073494"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1282"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073478"><span class="hs-identifier hs-var">setNominalRole_maybe_helper</span></a><span> </span><a href="#local-6989586621682073493"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621682073494"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1283"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073495"><a href="#local-6989586621682073495"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682073496"><a href="#local-6989586621682073496"><span class="hs-identifier">kind_co</span></a></a><span> </span><a name="local-6989586621682073497"><a href="#local-6989586621682073497"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1284"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a href="#local-6989586621682073495"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682073496"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073478"><span class="hs-identifier hs-var">setNominalRole_maybe_helper</span></a><span> </span><a href="#local-6989586621682073497"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1285"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><a name="local-6989586621682073498"><a href="#local-6989586621682073498"><span class="hs-identifier">_r</span></a></a><span> </span><a name="local-6989586621682073499"><a href="#local-6989586621682073499"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682073500"><a href="#local-6989586621682073500"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1286"></a><span>      </span><span class="hs-comment">-- NB, this case recurses via setNominalRole_maybe, not</span><span>
</span><a name="line-1287"></a><span>      </span><span class="hs-comment">-- setNominalRole_maybe_helper!</span><span>
</span><a name="line-1288"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073499"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Coercion.html#setNominalRole_maybe"><span class="hs-identifier hs-var">setNominalRole_maybe</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073500"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073500"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1289"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-6989586621682073501"><a href="#local-6989586621682073501"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073502"><a href="#local-6989586621682073502"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1290"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073478"><span class="hs-identifier hs-var">setNominalRole_maybe_helper</span></a><span> </span><a href="#local-6989586621682073501"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621682073502"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1291"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a name="local-6989586621682073503"><a href="#local-6989586621682073503"><span class="hs-identifier">prov</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073504"><a href="#local-6989586621682073504"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073505"><a href="#local-6989586621682073505"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1292"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682073503"><span class="hs-identifier hs-var">prov</span></a><span> </span><span class="hs-keyword">of</span><span> </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- it's always unsafe</span><span>
</span><a name="line-1293"></a><span>                     </span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- should always be phantom</span><span>
</span><a name="line-1294"></a><span>                     </span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- it's always safe</span><span>
</span><a name="line-1295"></a><span>                     </span><a href="TyCoRep.html#PluginProv"><span class="hs-identifier hs-var">PluginProv</span></a><span> </span><span class="hs-identifier">_</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- who knows? This choice is conservative.</span><span>
</span><a name="line-1296"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a href="#local-6989586621682073503"><span class="hs-identifier hs-var">prov</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073504"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682073505"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-1297"></a><span>    </span><span class="hs-identifier">setNominalRole_maybe_helper</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span class="hs-comment">-- | Make a phantom coercion between two types. The coercion passed</span><span>
</span><a name="line-1300"></a><span class="hs-comment">-- in must be a nominal coercion between the kinds of the</span><span>
</span><a name="line-1301"></a><span class="hs-comment">-- types.</span><span>
</span><a name="line-1302"></a><span class="hs-identifier">mkPhantomCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1303"></a><a name="mkPhantomCo"><a href="Coercion.html#mkPhantomCo"><span class="hs-identifier">mkPhantomCo</span></a></a><span> </span><a name="local-6989586621682073506"><a href="#local-6989586621682073506"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621682073507"><a href="#local-6989586621682073507"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682073508"><a href="#local-6989586621682073508"><span class="hs-identifier">t2</span></a></a><span>
</span><a name="line-1304"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkUnivCo"><span class="hs-identifier hs-var">mkUnivCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a href="#local-6989586621682073506"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><a href="#local-6989586621682073507"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682073508"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span class="hs-comment">-- takes any coercion and turns it into a Phantom coercion</span><span>
</span><a name="line-1307"></a><span class="hs-identifier">toPhantomCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1308"></a><a name="toPhantomCo"><a href="Coercion.html#toPhantomCo"><span class="hs-identifier">toPhantomCo</span></a></a><span> </span><a name="local-6989586621682073509"><a href="#local-6989586621682073509"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1309"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkPhantomCo"><span class="hs-identifier hs-var">mkPhantomCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073509"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073510"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073511"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1310"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073510"><a href="#local-6989586621682073510"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073511"><a href="#local-6989586621682073511"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073509"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1311"></a><span>
</span><a name="line-1312"></a><span class="hs-comment">-- Convert args to a TyConAppCo Nominal to the same TyConAppCo Representational</span><span>
</span><a name="line-1313"></a><span class="hs-identifier">applyRoles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-1314"></a><a name="applyRoles"><a href="Coercion.html#applyRoles"><span class="hs-identifier">applyRoles</span></a></a><span> </span><a name="local-6989586621682073512"><a href="#local-6989586621682073512"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073513"><a href="#local-6989586621682073513"><span class="hs-identifier">cos</span></a></a><span>
</span><a name="line-1315"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621682073514"><a href="#local-6989586621682073514"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="#local-6989586621682073514"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-6989586621682073512"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073513"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-1316"></a><span>
</span><a name="line-1317"></a><span class="hs-comment">-- the Role parameter is the Role of the TyConAppCo</span><span>
</span><a name="line-1318"></a><span class="hs-comment">-- defined here because this is intimately concerned with the implementation</span><span>
</span><a name="line-1319"></a><span class="hs-comment">-- of TyConAppCo</span><span>
</span><a name="line-1320"></a><span class="hs-comment">-- Always returns an infinite list (with a infinite tail of Nominal)</span><span>
</span><a name="line-1321"></a><span class="hs-identifier">tyConRolesX</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">]</span><span>
</span><a name="line-1322"></a><a name="tyConRolesX"><a href="Coercion.html#tyConRolesX"><span class="hs-identifier">tyConRolesX</span></a></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a name="local-6989586621682073515"><a href="#local-6989586621682073515"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-6989586621682073515"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1323"></a><span class="hs-identifier">tyConRolesX</span><span> </span><span class="hs-keyword">role</span><span>             </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span class="hs-comment">-- Returns the roles of the parameters of a tycon, with an infinite tail</span><span>
</span><a name="line-1326"></a><span class="hs-comment">-- of Nominal</span><span>
</span><a name="line-1327"></a><span class="hs-identifier">tyConRolesRepresentational</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">]</span><span>
</span><a name="line-1328"></a><a name="tyConRolesRepresentational"><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier">tyConRolesRepresentational</span></a></a><span> </span><a name="local-6989586621682073517"><a href="#local-6989586621682073517"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConRoles"><span class="hs-identifier hs-var">tyConRoles</span></a><span> </span><a href="#local-6989586621682073517"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1329"></a><span>
</span><a name="line-1330"></a><span class="hs-identifier">nthRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>
</span><a name="line-1331"></a><a name="nthRole"><a href="Coercion.html#nthRole"><span class="hs-identifier">nthRole</span></a></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1332"></a><span class="hs-identifier">nthRole</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>
</span><a name="line-1333"></a><span class="hs-identifier">nthRole</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a name="local-6989586621682073518"><a href="#local-6989586621682073518"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073519"><a href="#local-6989586621682073519"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-1334"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-6989586621682073518"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="ListSetOps.html#getNth"><span class="hs-identifier hs-var">getNth</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073519"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1335"></a><span>
</span><a name="line-1336"></a><span class="hs-identifier">ltRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1337"></a><span class="hs-comment">-- Is one role &quot;less&quot; than another?</span><span>
</span><a name="line-1338"></a><span class="hs-comment">--     Nominal &lt; Representational &lt; Phantom</span><span>
</span><a name="line-1339"></a><a name="ltRole"><a href="Coercion.html#ltRole"><span class="hs-identifier">ltRole</span></a></a><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span>          </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1340"></a><span class="hs-identifier">ltRole</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1341"></a><span class="hs-identifier">ltRole</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1342"></a><span class="hs-identifier">ltRole</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1343"></a><span class="hs-identifier">ltRole</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>          </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1344"></a><span>
</span><a name="line-1345"></a><span class="hs-comment">-------------------------------</span><span>
</span><a name="line-1346"></a><span>
</span><a name="line-1347"></a><span class="hs-comment">-- | like mkKindCo, but aggressively &amp; recursively optimizes to avoid using</span><span>
</span><a name="line-1348"></a><span class="hs-comment">-- a KindCo constructor. The output role is nominal.</span><span>
</span><a name="line-1349"></a><span class="hs-identifier">promoteCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>
</span><a name="line-1350"></a><span>
</span><a name="line-1351"></a><span class="hs-comment">-- First cases handles anything that should yield refl.</span><span>
</span><a name="line-1352"></a><a name="promoteCoercion"><a href="Coercion.html#promoteCoercion"><span class="hs-identifier">promoteCoercion</span></a></a><span> </span><a name="local-6989586621682073520"><a href="#local-6989586621682073520"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1353"></a><span>
</span><a name="line-1354"></a><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073523"><span class="hs-identifier hs-var">ki1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073524"><span class="hs-identifier hs-var">ki2</span></a><span>
</span><a name="line-1355"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073521"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1356"></a><span>     </span><span class="hs-comment">-- no later branch should return refl</span><span>
</span><a name="line-1357"></a><span>     </span><span class="hs-comment">--    The ASSERT( False )s throughout</span><span>
</span><a name="line-1358"></a><span>     </span><span class="hs-comment">-- are these cases explicitly, but they should never fire.</span><span>
</span><a name="line-1359"></a><span>
</span><a name="line-1360"></a><span>    </span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1361"></a><span>              </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-6989586621682073523"><span class="hs-identifier hs-var">ki1</span></a><span>
</span><a name="line-1362"></a><span>
</span><a name="line-1363"></a><span>    </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1364"></a><span>                       </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-6989586621682073523"><span class="hs-identifier hs-var">ki1</span></a><span>
</span><a name="line-1365"></a><span>
</span><a name="line-1366"></a><span>    </span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073525"><a href="#local-6989586621682073525"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073525"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1367"></a><span>
</span><a name="line-1368"></a><span>    </span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073526"><a href="#local-6989586621682073526"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073527"><a href="#local-6989586621682073527"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1369"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073528"><a href="#local-6989586621682073528"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#instCoercions"><span class="hs-identifier hs-var">instCoercions</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621682073526"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073527"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1370"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073528"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-1371"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1372"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1373"></a><span>
</span><a name="line-1374"></a><span>    </span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-6989586621682073529"><a href="#local-6989586621682073529"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073530"><a href="#local-6989586621682073530"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-1375"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073531"><a href="#local-6989586621682073531"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#instCoercion"><span class="hs-identifier hs-var">instCoercion</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073529"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1376"></a><span>                                 </span><span class="hs-special">(</span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073529"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073530"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1377"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073531"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-1378"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1379"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1380"></a><span>
</span><a name="line-1381"></a><span>    </span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073532"><a href="#local-6989586621682073532"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073533"><a href="#local-6989586621682073533"><span class="hs-identifier">g</span></a></a><span>
</span><a name="line-1382"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682073532"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1383"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073533"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-1384"></a><span>
</span><a name="line-1385"></a><span>    </span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1386"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1387"></a><span>         </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-1388"></a><span>      </span><span class="hs-comment">-- See Note [Weird typing rule for ForAllTy] in Type</span><span>
</span><a name="line-1389"></a><span>
</span><a name="line-1390"></a><span>    </span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1391"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1392"></a><span>         </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-1393"></a><span>
</span><a name="line-1394"></a><span>    </span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1395"></a><span>    </span><a href="TyCoRep.html#HoleCo"><span class="hs-identifier hs-var">HoleCo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1396"></a><span>    </span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1397"></a><span>    </span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1398"></a><span>
</span><a name="line-1399"></a><span>    </span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073534"><a href="#local-6989586621682073534"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682073535"><a href="#local-6989586621682073535"><span class="hs-identifier">t2</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkUnsafeCo"><span class="hs-identifier hs-var">mkUnsafeCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073534"><span class="hs-identifier hs-var">t1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073535"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1400"></a><span>    </span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-6989586621682073536"><a href="#local-6989586621682073536"><span class="hs-identifier">kco</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073536"><span class="hs-identifier hs-var">kco</span></a><span>
</span><a name="line-1401"></a><span>    </span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a name="local-6989586621682073537"><a href="#local-6989586621682073537"><span class="hs-identifier">kco</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073537"><span class="hs-identifier hs-var">kco</span></a><span>
</span><a name="line-1402"></a><span>    </span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PluginProv"><span class="hs-identifier hs-var">PluginProv</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1403"></a><span>
</span><a name="line-1404"></a><span>    </span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621682073538"><a href="#local-6989586621682073538"><span class="hs-identifier">g</span></a></a><span>
</span><a name="line-1405"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073538"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-1406"></a><span>
</span><a name="line-1407"></a><span>    </span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-6989586621682073539"><a href="#local-6989586621682073539"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073540"><a href="#local-6989586621682073540"><span class="hs-identifier">co2</span></a></a><span>
</span><a name="line-1408"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073539"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073540"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1409"></a><span>
</span><a name="line-1410"></a><span>    </span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073541"><a href="#local-6989586621682073541"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682073542"><a href="#local-6989586621682073542"><span class="hs-identifier">co1</span></a></a><span>
</span><a name="line-1411"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682073543"><a href="#local-6989586621682073543"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitTyConAppCo_maybe"><span class="hs-identifier hs-var">splitTyConAppCo_maybe</span></a><span> </span><a href="#local-6989586621682073542"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1412"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073543"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthExceeds"><span class="hs-identifier hs-var">lengthExceeds</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073541"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1413"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073543"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><a href="#local-6989586621682073541"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1414"></a><span>
</span><a name="line-1415"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitForAllCo_maybe"><span class="hs-identifier hs-var">splitForAllCo_maybe</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1416"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073541"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1417"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">mkNomReflCo</span><span> </span><span class="hs-identifier">liftedTypeKind</span><span>
</span><a name="line-1418"></a><span>
</span><a name="line-1419"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1420"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1421"></a><span>
</span><a name="line-1422"></a><span>    </span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a name="local-6989586621682073544"><a href="#local-6989586621682073544"><span class="hs-identifier">lr</span></a></a><span> </span><a name="local-6989586621682073545"><a href="#local-6989586621682073545"><span class="hs-identifier">co1</span></a></a><span>
</span><a name="line-1423"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073546"><a href="#local-6989586621682073546"><span class="hs-identifier">lco</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073547"><a href="#local-6989586621682073547"><span class="hs-identifier">rco</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#splitAppCo_maybe"><span class="hs-identifier hs-var">splitAppCo_maybe</span></a><span> </span><a href="#local-6989586621682073545"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-1424"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682073544"><span class="hs-identifier hs-var">lr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1425"></a><span>           </span><a href="BasicTypes.html#CLeft"><span class="hs-identifier hs-var">CLeft</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073546"><span class="hs-identifier hs-var">lco</span></a><span>
</span><a name="line-1426"></a><span>           </span><a href="BasicTypes.html#CRight"><span class="hs-identifier hs-var">CRight</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073547"><span class="hs-identifier hs-var">rco</span></a><span>
</span><a name="line-1427"></a><span>
</span><a name="line-1428"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1429"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1430"></a><span>
</span><a name="line-1431"></a><span>    </span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-6989586621682073548"><a href="#local-6989586621682073548"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1432"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a><span> </span><a href="#local-6989586621682073521"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1433"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isForAllTy_ty</span><span> </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1434"></a><span>         </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073548"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-1435"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1436"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">False</span><span class="hs-special">)</span><span>
</span><a name="line-1437"></a><span>         </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-1438"></a><span>           </span><span class="hs-comment">-- See Note [Weird typing rule for ForAllTy] in Type</span><span>
</span><a name="line-1439"></a><span>
</span><a name="line-1440"></a><span>    </span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1441"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1442"></a><span>         </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-1443"></a><span>
</span><a name="line-1444"></a><span>    </span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a name="local-6989586621682073549"><a href="#local-6989586621682073549"><span class="hs-identifier">g</span></a></a><span>
</span><a name="line-1445"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#promoteCoercion"><span class="hs-identifier hs-var">promoteCoercion</span></a><span> </span><a href="#local-6989586621682073549"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-1446"></a><span>
</span><a name="line-1447"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1448"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073521"><a href="#local-6989586621682073521"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073522"><a href="#local-6989586621682073522"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073520"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1449"></a><span>    </span><a name="local-6989586621682073523"><a href="#local-6989586621682073523"><span class="hs-identifier">ki1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073521"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1450"></a><span>    </span><a name="local-6989586621682073524"><a href="#local-6989586621682073524"><span class="hs-identifier">ki2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073522"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1451"></a><span>
</span><a name="line-1452"></a><span class="hs-comment">-- | say @g = promoteCoercion h@. Then, @instCoercion g w@ yields @Just g'@,</span><span>
</span><a name="line-1453"></a><span class="hs-comment">-- where @g' = promoteCoercion (h w)@.</span><span>
</span><a name="line-1454"></a><span class="hs-comment">-- fails if this is not possible, if @g@ coerces between a forall and an -&gt;</span><span>
</span><a name="line-1455"></a><span class="hs-comment">-- or if second parameter has a representational role and can't be used</span><span>
</span><a name="line-1456"></a><span class="hs-comment">-- with an InstCo.</span><span>
</span><a name="line-1457"></a><span class="hs-identifier">instCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-comment">-- g :: lty ~ rty</span><span>
</span><a name="line-1458"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>  </span><span class="hs-comment">-- ^  must be nominal</span><span>
</span><a name="line-1459"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1460"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>
</span><a name="line-1461"></a><a name="instCoercion"><a href="Coercion.html#instCoercion"><span class="hs-identifier">instCoercion</span></a></a><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073550"><a href="#local-6989586621682073550"><span class="hs-identifier">lty</span></a></a><span> </span><a name="local-6989586621682073551"><a href="#local-6989586621682073551"><span class="hs-identifier">rty</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073552"><a href="#local-6989586621682073552"><span class="hs-identifier">g</span></a></a><span> </span><a name="local-6989586621682073553"><a href="#local-6989586621682073553"><span class="hs-identifier">w</span></a></a><span>
</span><a name="line-1462"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a><span> </span><a href="#local-6989586621682073550"><span class="hs-identifier hs-var">lty</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a><span> </span><a href="#local-6989586621682073551"><span class="hs-identifier hs-var">rty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1463"></a><span>  </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="Type.html#isForAllTy_co"><span class="hs-identifier hs-var">isForAllTy_co</span></a><span> </span><a href="#local-6989586621682073550"><span class="hs-identifier hs-var">lty</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Type.html#isForAllTy_co"><span class="hs-identifier hs-var">isForAllTy_co</span></a><span> </span><a href="#local-6989586621682073551"><span class="hs-identifier hs-var">rty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1464"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073554"><a href="#local-6989586621682073554"><span class="hs-identifier">w'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#setNominalRole_maybe"><span class="hs-identifier hs-var">setNominalRole_maybe</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073553"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073553"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-1465"></a><span>    </span><span class="hs-comment">-- g :: (forall t1. t2) ~ (forall t1. t3)</span><span>
</span><a name="line-1466"></a><span>    </span><span class="hs-comment">-- w :: s1 ~ s2</span><span>
</span><a name="line-1467"></a><span>    </span><span class="hs-comment">-- returns mkInstCo g w' :: t2 [t1 |-&gt; s1 ] ~ t3 [t1 |-&gt; s2]</span><span>
</span><a name="line-1468"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a><span> </span><a href="#local-6989586621682073552"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621682073554"><span class="hs-identifier hs-var">w'</span></a><span>
</span><a name="line-1469"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a><span> </span><a href="#local-6989586621682073550"><span class="hs-identifier hs-var">lty</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a><span> </span><a href="#local-6989586621682073551"><span class="hs-identifier hs-var">rty</span></a><span>
</span><a name="line-1470"></a><span>    </span><span class="hs-comment">-- g :: (t1 -&gt; t2) ~ (t3 -&gt; t4)</span><span>
</span><a name="line-1471"></a><span>    </span><span class="hs-comment">-- returns t2 ~ t4</span><span>
</span><a name="line-1472"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621682073552"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-comment">-- extract result type, which is the 4th argument to (-&gt;)</span><span>
</span><a name="line-1473"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-comment">-- one forall, one funty...</span><span>
</span><a name="line-1474"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1475"></a><span>
</span><a name="line-1476"></a><span class="hs-comment">-- | Repeated use of 'instCoercion'</span><span>
</span><a name="line-1477"></a><span class="hs-identifier">instCoercions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>
</span><a name="line-1478"></a><a name="instCoercions"><a href="Coercion.html#instCoercions"><span class="hs-identifier">instCoercions</span></a></a><span> </span><a name="local-6989586621682073555"><a href="#local-6989586621682073555"><span class="hs-identifier">g</span></a></a><span> </span><a name="local-6989586621682073556"><a href="#local-6989586621682073556"><span class="hs-identifier">ws</span></a></a><span>
</span><a name="line-1479"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073563"><a href="#local-6989586621682073563"><span class="hs-identifier">arg_ty_pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073556"><span class="hs-identifier hs-var">ws</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1480"></a><span>    </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621682073557"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073555"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073555"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621682073563"><span class="hs-identifier hs-var">arg_ty_pairs</span></a><span> </span><a href="#local-6989586621682073556"><span class="hs-identifier hs-var">ws</span></a><span class="hs-special">)</span><span>
</span><a name="line-1481"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1482"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1483"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1484"></a><span>    </span><a name="local-6989586621682073557"><a href="#local-6989586621682073557"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682073558"><a href="#local-6989586621682073558"><span class="hs-identifier">g_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073559"><a href="#local-6989586621682073559"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073560"><a href="#local-6989586621682073560"><span class="hs-identifier">w_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073561"><a href="#local-6989586621682073561"><span class="hs-identifier">w</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1485"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682073562"><a href="#local-6989586621682073562"><span class="hs-identifier">g'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#instCoercion"><span class="hs-identifier hs-var">instCoercion</span></a><span> </span><a href="#local-6989586621682073558"><span class="hs-identifier hs-var">g_tys</span></a><span> </span><a href="#local-6989586621682073559"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621682073561"><span class="hs-identifier hs-var">w</span></a><span>
</span><a name="line-1486"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Type.html#piResultTy"><span class="hs-identifier hs-var">piResultTy</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073558"><span class="hs-identifier hs-var">g_tys</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621682073560"><span class="hs-identifier hs-var">w_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073562"><span class="hs-identifier hs-var">g'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1487"></a><span>
</span><a name="line-1488"></a><span class="hs-comment">-- | Creates a new coercion with both of its types casted by different casts</span><span>
</span><a name="line-1489"></a><span class="hs-comment">-- @castCoercionKind g r t1 t2 h1 h2@, where @g :: t1 ~r t2@,</span><span>
</span><a name="line-1490"></a><span class="hs-comment">-- has type @(t1 |&gt; h1) ~r (t2 |&gt; h2)@.</span><span>
</span><a name="line-1491"></a><span class="hs-comment">-- @h1@ and @h2@ must be nominal.</span><span>
</span><a name="line-1492"></a><span class="hs-identifier">castCoercionKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-1493"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1494"></a><a name="castCoercionKind"><a href="Coercion.html#castCoercionKind"><span class="hs-identifier">castCoercionKind</span></a></a><span> </span><a name="local-6989586621682073564"><a href="#local-6989586621682073564"><span class="hs-identifier">g</span></a></a><span> </span><a name="local-6989586621682073565"><a href="#local-6989586621682073565"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073566"><a href="#local-6989586621682073566"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682073567"><a href="#local-6989586621682073567"><span class="hs-identifier">t2</span></a></a><span> </span><a name="local-6989586621682073568"><a href="#local-6989586621682073568"><span class="hs-identifier">h1</span></a></a><span> </span><a name="local-6989586621682073569"><a href="#local-6989586621682073569"><span class="hs-identifier">h2</span></a></a><span>
</span><a name="line-1495"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span> </span><a href="#local-6989586621682073565"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073567"><span class="hs-identifier hs-var">t2</span></a><span> </span><a href="#local-6989586621682073569"><span class="hs-identifier hs-var">h2</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a><span> </span><a href="#local-6989586621682073565"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073566"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682073568"><span class="hs-identifier hs-var">h1</span></a><span> </span><a href="#local-6989586621682073564"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span class="hs-comment">-- | Creates a new coercion with both of its types casted by different casts</span><span>
</span><a name="line-1498"></a><span class="hs-comment">-- @castCoercionKind g h1 h2@, where @g :: t1 ~r t2@,</span><span>
</span><a name="line-1499"></a><span class="hs-comment">-- has type @(t1 |&gt; h1) ~r (t2 |&gt; h2)@.</span><span>
</span><a name="line-1500"></a><span class="hs-comment">-- @h1@ and @h2@ must be nominal.</span><span>
</span><a name="line-1501"></a><span class="hs-comment">-- It calls @coercionKindRole@, so it's quite inefficient (which 'I' stands for)</span><span>
</span><a name="line-1502"></a><span class="hs-comment">-- Use @castCoercionKind@ instead if @t1@, @t2@, and @r@ are known beforehand.</span><span>
</span><a name="line-1503"></a><span class="hs-identifier">castCoercionKindI</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1504"></a><a name="castCoercionKindI"><a href="Coercion.html#castCoercionKindI"><span class="hs-identifier">castCoercionKindI</span></a></a><span> </span><a name="local-6989586621682073570"><a href="#local-6989586621682073570"><span class="hs-identifier">g</span></a></a><span> </span><a name="local-6989586621682073571"><a href="#local-6989586621682073571"><span class="hs-identifier">h1</span></a></a><span> </span><a name="local-6989586621682073572"><a href="#local-6989586621682073572"><span class="hs-identifier">h2</span></a></a><span>
</span><a name="line-1505"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span> </span><a href="#local-6989586621682073575"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073574"><span class="hs-identifier hs-var">t2</span></a><span> </span><a href="#local-6989586621682073572"><span class="hs-identifier hs-var">h2</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a><span> </span><a href="#local-6989586621682073575"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073573"><span class="hs-identifier hs-var">t1</span></a><span> </span><a href="#local-6989586621682073571"><span class="hs-identifier hs-var">h1</span></a><span> </span><a href="#local-6989586621682073570"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-1506"></a><span>  </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073573"><a href="#local-6989586621682073573"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682073574"><a href="#local-6989586621682073574"><span class="hs-identifier">t2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073575"><a href="#local-6989586621682073575"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-6989586621682073570"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-1507"></a><span>
</span><a name="line-1508"></a><span class="hs-comment">-- See note [Newtype coercions] in TyCon</span><span>
</span><a name="line-1509"></a><span>
</span><a name="line-1510"></a><span class="hs-identifier">mkPiCos</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1511"></a><a name="mkPiCos"><a href="Coercion.html#mkPiCos"><span class="hs-identifier">mkPiCos</span></a></a><span> </span><a name="local-6989586621682073576"><a href="#local-6989586621682073576"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073577"><a href="#local-6989586621682073577"><span class="hs-identifier">vs</span></a></a><span> </span><a name="local-6989586621682073578"><a href="#local-6989586621682073578"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkPiCo"><span class="hs-identifier hs-var">mkPiCo</span></a><span> </span><a href="#local-6989586621682073576"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073578"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682073577"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-1512"></a><span>
</span><a name="line-1513"></a><span class="hs-comment">-- | Make a forall 'Coercion', where both types related by the coercion</span><span>
</span><a name="line-1514"></a><span class="hs-comment">-- are quantified over the same variable.</span><span>
</span><a name="line-1515"></a><span class="hs-identifier">mkPiCo</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1516"></a><a name="mkPiCo"><a href="Coercion.html#mkPiCo"><span class="hs-identifier">mkPiCo</span></a></a><span> </span><a name="local-6989586621682073579"><a href="#local-6989586621682073579"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073580"><a href="#local-6989586621682073580"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621682073581"><a href="#local-6989586621682073581"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682073580"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkHomoForAllCos"><span class="hs-identifier hs-var">mkHomoForAllCos</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682073580"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621682073581"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1517"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621682073580"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyCoVarsOfCo</span><span> </span><span class="hs-identifier">co</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1518"></a><span>                  </span><span class="hs-comment">-- We didn't call mkForAllCo here because if v does not appear</span><span>
</span><a name="line-1519"></a><span>                  </span><span class="hs-comment">-- in co, the argement coercion will be nominal. But here we</span><span>
</span><a name="line-1520"></a><span>                  </span><span class="hs-comment">-- want it to be r. It is only called in 'mkPiCos', which is</span><span>
</span><a name="line-1521"></a><span>                  </span><span class="hs-comment">-- only used in SimplUtils, where we are sure for</span><span>
</span><a name="line-1522"></a><span>                  </span><span class="hs-comment">-- now (Aug 2018) v won't occur in co.</span><span>
</span><a name="line-1523"></a><span>                            </span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="#local-6989586621682073579"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073579"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073580"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073581"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1524"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="#local-6989586621682073579"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073579"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073580"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073581"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1525"></a><span>
</span><a name="line-1526"></a><span class="hs-comment">-- mkCoCast (c :: s1 ~?r t1) (g :: (s1 ~?r t1) ~#R (s2 ~?r t2)) :: s2 ~?r t2</span><span>
</span><a name="line-1527"></a><span class="hs-comment">-- The first coercion might be lifted or unlifted; thus the ~? above</span><span>
</span><a name="line-1528"></a><span class="hs-comment">-- Lifted and unlifted equalities take different numbers of arguments,</span><span>
</span><a name="line-1529"></a><span class="hs-comment">-- so we have to make sure to supply the right parameter to decomposeCo.</span><span>
</span><a name="line-1530"></a><span class="hs-comment">-- Also, note that the role of the first coercion is the same as the role of</span><span>
</span><a name="line-1531"></a><span class="hs-comment">-- the equalities related by the second coercion. The second coercion is</span><span>
</span><a name="line-1532"></a><span class="hs-comment">-- itself always representational.</span><span>
</span><a name="line-1533"></a><span class="hs-identifier">mkCoCast</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1534"></a><a name="mkCoCast"><a href="Coercion.html#mkCoCast"><span class="hs-identifier">mkCoCast</span></a></a><span> </span><a name="local-6989586621682073582"><a href="#local-6989586621682073582"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682073583"><a href="#local-6989586621682073583"><span class="hs-identifier">g</span></a></a><span>
</span><a name="line-1535"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073586"><a href="#local-6989586621682073586"><span class="hs-identifier">g2</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682073587"><a href="#local-6989586621682073587"><span class="hs-identifier">g1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682073585"><span class="hs-identifier hs-var">co_list</span></a><span>
</span><a name="line-1536"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682073587"><span class="hs-identifier hs-var">g1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073582"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073586"><span class="hs-identifier hs-var">g2</span></a><span>
</span><a name="line-1537"></a><span>
</span><a name="line-1538"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1539"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;mkCoCast&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073583"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073583"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1540"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1541"></a><span>    </span><span class="hs-comment">-- g  :: (s1 ~# t1) ~# (s2 ~# t2)</span><span>
</span><a name="line-1542"></a><span>    </span><span class="hs-comment">-- g1 :: s1 ~# s2</span><span>
</span><a name="line-1543"></a><span>    </span><span class="hs-comment">-- g2 :: t1 ~# t2</span><span>
</span><a name="line-1544"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073584"><a href="#local-6989586621682073584"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#splitTyConApp"><span class="hs-identifier hs-var">splitTyConApp</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pFst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073583"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-1545"></a><span>    </span><a name="local-6989586621682073585"><a href="#local-6989586621682073585"><span class="hs-identifier">co_list</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621682073584"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073583"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-6989586621682073584"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1546"></a><span>
</span><a name="line-1547"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
            Newtypes
%*                                                                      *
%************************************************************************
-}</span><span>
</span><a name="line-1554"></a><span>
</span><a name="line-1555"></a><span class="hs-comment">-- | If @co :: T ts ~ rep_ty@ then:</span><span>
</span><a name="line-1556"></a><span class="hs-comment">--</span><span>
</span><a name="line-1557"></a><span class="hs-comment">-- &gt; instNewTyCon_maybe T ts = Just (rep_ty, co)</span><span>
</span><a name="line-1558"></a><span class="hs-comment">--</span><span>
</span><a name="line-1559"></a><span class="hs-comment">-- Checks for a newtype, and for being saturated</span><span>
</span><a name="line-1560"></a><span class="hs-identifier">instNewTyCon_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1561"></a><a name="instNewTyCon_maybe"><a href="Coercion.html#instNewTyCon_maybe"><span class="hs-identifier">instNewTyCon_maybe</span></a></a><span> </span><a name="local-6989586621682073588"><a href="#local-6989586621682073588"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073589"><a href="#local-6989586621682073589"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1562"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073590"><a href="#local-6989586621682073590"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073591"><a href="#local-6989586621682073591"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073592"><a href="#local-6989586621682073592"><span class="hs-identifier">co_tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#unwrapNewTyConEtad_maybe"><span class="hs-identifier hs-var">unwrapNewTyConEtad_maybe</span></a><span> </span><a href="#local-6989586621682073588"><span class="hs-identifier hs-var">tc</span></a><span>  </span><span class="hs-comment">-- Check for newtype</span><span>
</span><a name="line-1563"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073590"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#leLength"><span class="hs-identifier hs-var">leLength</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073589"><span class="hs-identifier hs-var">tys</span></a><span>                                    </span><span class="hs-comment">-- Check saturated enough</span><span>
</span><a name="line-1564"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Type.html#applyTysX"><span class="hs-identifier hs-var">applyTysX</span></a><span> </span><a href="#local-6989586621682073590"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073591"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682073589"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkUnbranchedAxInstCo"><span class="hs-identifier hs-var">mkUnbranchedAxInstCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682073592"><span class="hs-identifier hs-var">co_tc</span></a><span> </span><a href="#local-6989586621682073589"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1565"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1566"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1567"></a><span>
</span><a name="line-1568"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
         Type normalisation
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1575"></a><span>
</span><a name="line-1576"></a><span class="hs-comment">-- | A function to check if we can reduce a type by one step. Used</span><span>
</span><a name="line-1577"></a><span class="hs-comment">-- with 'topNormaliseTypeX'.</span><span>
</span><a name="line-1578"></a><span class="hs-keyword">type</span><span> </span><a name="NormaliseStepper"><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier">NormaliseStepper</span></a></a><span> </span><a name="local-6989586621682073045"><a href="#local-6989586621682073045"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#RecTcChecker"><span class="hs-identifier hs-type">RecTcChecker</span></a><span>
</span><a name="line-1579"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>     </span><span class="hs-comment">-- tc</span><span>
</span><a name="line-1580"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- tys</span><span>
</span><a name="line-1581"></a><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NormaliseStepResult"><span class="hs-identifier hs-type">NormaliseStepResult</span></a><span> </span><a href="#local-6989586621682073045"><span class="hs-identifier hs-type">ev</span></a><span>
</span><a name="line-1582"></a><span>
</span><a name="line-1583"></a><span class="hs-comment">-- | The result of stepping in a normalisation function.</span><span>
</span><a name="line-1584"></a><span class="hs-comment">-- See 'topNormaliseTypeX'.</span><span>
</span><a name="line-1585"></a><span class="hs-keyword">data</span><span> </span><a name="NormaliseStepResult"><a href="Coercion.html#NormaliseStepResult"><span class="hs-identifier">NormaliseStepResult</span></a></a><span> </span><a name="local-6989586621682073044"><a href="#local-6989586621682073044"><span class="hs-identifier">ev</span></a></a><span>
</span><a name="line-1586"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NS_Done"><a href="Coercion.html#NS_Done"><span class="hs-identifier">NS_Done</span></a></a><span>   </span><span class="hs-comment">-- ^ Nothing more to do</span><span>
</span><a name="line-1587"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NS_Abort"><a href="Coercion.html#NS_Abort"><span class="hs-identifier">NS_Abort</span></a></a><span>  </span><span class="hs-comment">-- ^ Utter failure. The outer function should fail too.</span><span>
</span><a name="line-1588"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NS_Step"><a href="Coercion.html#NS_Step"><span class="hs-identifier">NS_Step</span></a></a><span> </span><a href="TyCon.html#RecTcChecker"><span class="hs-identifier hs-type">RecTcChecker</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><a href="#local-6989586621682073044"><span class="hs-identifier hs-type">ev</span></a><span>    </span><span class="hs-comment">-- ^ We stepped, yielding new bits;</span><span>
</span><a name="line-1589"></a><span>                                    </span><span class="hs-comment">-- ^ ev is evidence;</span><span>
</span><a name="line-1590"></a><span>                                    </span><span class="hs-comment">-- Usually a co :: old type ~ new type</span><span>
</span><a name="line-1591"></a><span>
</span><a name="line-1592"></a><span class="hs-identifier">mapStepResult</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073053"><span class="hs-identifier hs-type">ev1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073054"><span class="hs-identifier hs-type">ev2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1593"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NormaliseStepResult"><span class="hs-identifier hs-type">NormaliseStepResult</span></a><span> </span><a href="#local-6989586621682073053"><span class="hs-identifier hs-type">ev1</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NormaliseStepResult"><span class="hs-identifier hs-type">NormaliseStepResult</span></a><span> </span><a href="#local-6989586621682073054"><span class="hs-identifier hs-type">ev2</span></a><span>
</span><a name="line-1594"></a><a name="mapStepResult"><a href="Coercion.html#mapStepResult"><span class="hs-identifier">mapStepResult</span></a></a><span> </span><a name="local-6989586621682073593"><a href="#local-6989586621682073593"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#NS_Step"><span class="hs-identifier hs-var">NS_Step</span></a><span> </span><a name="local-6989586621682073594"><a href="#local-6989586621682073594"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682073595"><a href="#local-6989586621682073595"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073596"><a href="#local-6989586621682073596"><span class="hs-identifier">ev</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#NS_Step"><span class="hs-identifier hs-var">NS_Step</span></a><span> </span><a href="#local-6989586621682073594"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682073595"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073593"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682073596"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1595"></a><span class="hs-identifier">mapStepResult</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a><span>
</span><a name="line-1596"></a><span class="hs-identifier">mapStepResult</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="Coercion.html#NS_Abort"><span class="hs-identifier hs-var">NS_Abort</span></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#NS_Abort"><span class="hs-identifier hs-var">NS_Abort</span></a><span>
</span><a name="line-1597"></a><span>
</span><a name="line-1598"></a><span class="hs-comment">-- | Try one stepper and then try the next, if the first doesn't make</span><span>
</span><a name="line-1599"></a><span class="hs-comment">-- progress.</span><span>
</span><a name="line-1600"></a><span class="hs-comment">-- So if it returns NS_Done, it means that both steppers are satisfied</span><span>
</span><a name="line-1601"></a><span class="hs-identifier">composeSteppers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a><span> </span><a href="#local-6989586621682073052"><span class="hs-identifier hs-type">ev</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a><span> </span><a href="#local-6989586621682073052"><span class="hs-identifier hs-type">ev</span></a><span>
</span><a name="line-1602"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a><span> </span><a href="#local-6989586621682073052"><span class="hs-identifier hs-type">ev</span></a><span>
</span><a name="line-1603"></a><a name="composeSteppers"><a href="Coercion.html#composeSteppers"><span class="hs-identifier">composeSteppers</span></a></a><span> </span><a name="local-6989586621682073597"><a href="#local-6989586621682073597"><span class="hs-identifier">step1</span></a></a><span> </span><a name="local-6989586621682073598"><a href="#local-6989586621682073598"><span class="hs-identifier">step2</span></a></a><span> </span><a name="local-6989586621682073599"><a href="#local-6989586621682073599"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682073600"><a href="#local-6989586621682073600"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073601"><a href="#local-6989586621682073601"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1604"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682073597"><span class="hs-identifier hs-var">step1</span></a><span> </span><a href="#local-6989586621682073599"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682073600"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073601"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1605"></a><span>      </span><a name="local-6989586621682073602"><a href="#local-6989586621682073602"><span class="hs-identifier">success</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Coercion.html#NS_Step"><span class="hs-identifier hs-var">NS_Step</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073602"><span class="hs-identifier hs-var">success</span></a><span>
</span><a name="line-1606"></a><span>      </span><a href="Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073598"><span class="hs-identifier hs-var">step2</span></a><span> </span><a href="#local-6989586621682073599"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682073600"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073601"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1607"></a><span>      </span><a href="Coercion.html#NS_Abort"><span class="hs-identifier hs-var">NS_Abort</span></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NS_Abort"><span class="hs-identifier hs-var">NS_Abort</span></a><span>
</span><a name="line-1608"></a><span>
</span><a name="line-1609"></a><span class="hs-comment">-- | A 'NormaliseStepper' that unwraps newtypes, careful not to fall into</span><span>
</span><a name="line-1610"></a><span class="hs-comment">-- a loop. If it would fall into a loop, it produces 'NS_Abort'.</span><span>
</span><a name="line-1611"></a><span class="hs-identifier">unwrapNewTypeStepper</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1612"></a><a name="unwrapNewTypeStepper"><a href="Coercion.html#unwrapNewTypeStepper"><span class="hs-identifier">unwrapNewTypeStepper</span></a></a><span> </span><a name="local-6989586621682073603"><a href="#local-6989586621682073603"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682073604"><a href="#local-6989586621682073604"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073605"><a href="#local-6989586621682073605"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1613"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073606"><a href="#local-6989586621682073606"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073607"><a href="#local-6989586621682073607"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#instNewTyCon_maybe"><span class="hs-identifier hs-var">instNewTyCon_maybe</span></a><span> </span><a href="#local-6989586621682073604"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073605"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1614"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCon.html#checkRecTc"><span class="hs-identifier hs-var">checkRecTc</span></a><span> </span><a href="#local-6989586621682073603"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682073604"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1615"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073608"><a href="#local-6989586621682073608"><span class="hs-identifier">rec_nts'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NS_Step"><span class="hs-identifier hs-var">NS_Step</span></a><span> </span><a href="#local-6989586621682073608"><span class="hs-identifier hs-var">rec_nts'</span></a><span> </span><a href="#local-6989586621682073606"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621682073607"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1616"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NS_Abort"><span class="hs-identifier hs-var">NS_Abort</span></a><span>
</span><a name="line-1617"></a><span>
</span><a name="line-1618"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1619"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a><span>
</span><a name="line-1620"></a><span>
</span><a name="line-1621"></a><span class="hs-comment">-- | A general function for normalising the top-level of a type. It continues</span><span>
</span><a name="line-1622"></a><span class="hs-comment">-- to use the provided 'NormaliseStepper' until that function fails, and then</span><span>
</span><a name="line-1623"></a><span class="hs-comment">-- this function returns. The roles of the coercions produced by the</span><span>
</span><a name="line-1624"></a><span class="hs-comment">-- 'NormaliseStepper' must all be the same, which is the role returned from</span><span>
</span><a name="line-1625"></a><span class="hs-comment">-- the call to 'topNormaliseTypeX'.</span><span>
</span><a name="line-1626"></a><span class="hs-comment">--</span><span>
</span><a name="line-1627"></a><span class="hs-comment">-- Typically ev is Coercion.</span><span>
</span><a name="line-1628"></a><span class="hs-comment">--</span><span>
</span><a name="line-1629"></a><span class="hs-comment">-- If topNormaliseTypeX step plus ty = Just (ev, ty')</span><span>
</span><a name="line-1630"></a><span class="hs-comment">-- then ty ~ev1~ t1 ~ev2~ t2 ... ~evn~ ty'</span><span>
</span><a name="line-1631"></a><span class="hs-comment">-- and ev = ev1 `plus` ev2 `plus` ... `plus` evn</span><span>
</span><a name="line-1632"></a><span class="hs-comment">-- If it returns Nothing then no newtype unwrapping could happen</span><span>
</span><a name="line-1633"></a><span class="hs-identifier">topNormaliseTypeX</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a><span> </span><a href="#local-6989586621682073051"><span class="hs-identifier hs-type">ev</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073051"><span class="hs-identifier hs-type">ev</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073051"><span class="hs-identifier hs-type">ev</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073051"><span class="hs-identifier hs-type">ev</span></a><span class="hs-special">)</span><span>
</span><a name="line-1634"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073051"><span class="hs-identifier hs-type">ev</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1635"></a><a name="topNormaliseTypeX"><a href="Coercion.html#topNormaliseTypeX"><span class="hs-identifier">topNormaliseTypeX</span></a></a><span> </span><a name="local-6989586621682073609"><a href="#local-6989586621682073609"><span class="hs-identifier">stepper</span></a></a><span> </span><a name="local-6989586621682073610"><a href="#local-6989586621682073610"><span class="hs-identifier">plus</span></a></a><span> </span><a name="local-6989586621682073611"><a href="#local-6989586621682073611"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1636"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073621"><a href="#local-6989586621682073621"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073622"><a href="#local-6989586621682073622"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682073611"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1637"></a><span> </span><span class="hs-special">,</span><span> </span><a href="Coercion.html#NS_Step"><span class="hs-identifier hs-var">NS_Step</span></a><span> </span><a name="local-6989586621682073623"><a href="#local-6989586621682073623"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682073624"><a href="#local-6989586621682073624"><span class="hs-identifier">ty'</span></a></a><span> </span><a name="local-6989586621682073625"><a href="#local-6989586621682073625"><span class="hs-identifier">ev</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682073609"><span class="hs-identifier hs-var">stepper</span></a><span> </span><a href="TyCon.html#initRecTc"><span class="hs-identifier hs-var">initRecTc</span></a><span> </span><a href="#local-6989586621682073621"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073622"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1638"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073612"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073623"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682073625"><span class="hs-identifier hs-var">ev</span></a><span> </span><a href="#local-6989586621682073624"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1639"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1640"></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1641"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1642"></a><span>    </span><a name="local-6989586621682073612"><a href="#local-6989586621682073612"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682073613"><a href="#local-6989586621682073613"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682073614"><a href="#local-6989586621682073614"><span class="hs-identifier">ev</span></a></a><span> </span><a name="local-6989586621682073615"><a href="#local-6989586621682073615"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1643"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073616"><a href="#local-6989586621682073616"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073617"><a href="#local-6989586621682073617"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682073615"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1644"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682073609"><span class="hs-identifier hs-var">stepper</span></a><span> </span><a href="#local-6989586621682073613"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682073616"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682073617"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1645"></a><span>          </span><a href="Coercion.html#NS_Step"><span class="hs-identifier hs-var">NS_Step</span></a><span> </span><a name="local-6989586621682073618"><a href="#local-6989586621682073618"><span class="hs-identifier">rec_nts'</span></a></a><span> </span><a name="local-6989586621682073619"><a href="#local-6989586621682073619"><span class="hs-identifier">ty'</span></a></a><span> </span><a name="local-6989586621682073620"><a href="#local-6989586621682073620"><span class="hs-identifier">ev'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073612"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073618"><span class="hs-identifier hs-var">rec_nts'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073614"><span class="hs-identifier hs-var">ev</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682073610"><span class="hs-identifier hs-var">plus</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073620"><span class="hs-identifier hs-var">ev'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073619"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1646"></a><span>          </span><a href="Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073614"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073615"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1647"></a><span>          </span><a href="Coercion.html#NS_Abort"><span class="hs-identifier hs-var">NS_Abort</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1648"></a><span>
</span><a name="line-1649"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1650"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073614"><span class="hs-identifier hs-var">ev</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073615"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1651"></a><span>
</span><a name="line-1652"></a><span class="hs-identifier">topNormaliseNewType_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1653"></a><span class="hs-comment">-- ^ Sometimes we want to look through a @newtype@ and get its associated coercion.</span><span>
</span><a name="line-1654"></a><span class="hs-comment">-- This function strips off @newtype@ layers enough to reveal something that isn't</span><span>
</span><a name="line-1655"></a><span class="hs-comment">-- a @newtype@.  Specifically, here's the invariant:</span><span>
</span><a name="line-1656"></a><span class="hs-comment">--</span><span>
</span><a name="line-1657"></a><span class="hs-comment">-- &gt; topNormaliseNewType_maybe rec_nts ty = Just (co, ty')</span><span>
</span><a name="line-1658"></a><span class="hs-comment">--</span><span>
</span><a name="line-1659"></a><span class="hs-comment">-- then (a)  @co : ty0 ~ ty'@.</span><span>
</span><a name="line-1660"></a><span class="hs-comment">--      (b)  ty' is not a newtype.</span><span>
</span><a name="line-1661"></a><span class="hs-comment">--</span><span>
</span><a name="line-1662"></a><span class="hs-comment">-- The function returns @Nothing@ for non-@newtypes@,</span><span>
</span><a name="line-1663"></a><span class="hs-comment">-- or unsaturated applications</span><span>
</span><a name="line-1664"></a><span class="hs-comment">--</span><span>
</span><a name="line-1665"></a><span class="hs-comment">-- This function does *not* look through type families, because it has no access to</span><span>
</span><a name="line-1666"></a><span class="hs-comment">-- the type family environment. If you do have that at hand, consider to use</span><span>
</span><a name="line-1667"></a><span class="hs-comment">-- topNormaliseType_maybe, which should be a drop-in replacement for</span><span>
</span><a name="line-1668"></a><span class="hs-comment">-- topNormaliseNewType_maybe</span><span>
</span><a name="line-1669"></a><span class="hs-comment">-- If topNormliseNewType_maybe ty = Just (co, ty'), then co : ty ~R ty'</span><span>
</span><a name="line-1670"></a><a name="topNormaliseNewType_maybe"><a href="Coercion.html#topNormaliseNewType_maybe"><span class="hs-identifier">topNormaliseNewType_maybe</span></a></a><span> </span><a name="local-6989586621682073626"><a href="#local-6989586621682073626"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1671"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#topNormaliseTypeX"><span class="hs-identifier hs-var">topNormaliseTypeX</span></a><span> </span><a href="Coercion.html#unwrapNewTypeStepper"><span class="hs-identifier hs-var">unwrapNewTypeStepper</span></a><span> </span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span> </span><a href="#local-6989586621682073626"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1672"></a><span>
</span><a name="line-1673"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
                   Comparison of coercions
%*                                                                      *
%************************************************************************
-}</span><span>
</span><a name="line-1680"></a><span>
</span><a name="line-1681"></a><span class="hs-comment">-- | Syntactic equality of coercions</span><span>
</span><a name="line-1682"></a><span class="hs-identifier">eqCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1683"></a><a name="eqCoercion"><a href="Coercion.html#eqCoercion"><span class="hs-identifier">eqCoercion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span>
</span><a name="line-1684"></a><span>
</span><a name="line-1685"></a><span class="hs-comment">-- | Compare two 'Coercion's, with respect to an RnEnv2</span><span>
</span><a name="line-1686"></a><span class="hs-identifier">eqCoercionX</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#RnEnv2"><span class="hs-identifier hs-type">RnEnv2</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1687"></a><a name="eqCoercionX"><a href="Coercion.html#eqCoercionX"><span class="hs-identifier">eqCoercionX</span></a></a><span> </span><a name="local-6989586621682073627"><a href="#local-6989586621682073627"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#eqTypeX"><span class="hs-identifier hs-var">eqTypeX</span></a><span> </span><a href="#local-6989586621682073627"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">on</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span>
</span><a name="line-1688"></a><span>
</span><a name="line-1689"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
                   &quot;Lifting&quot; substitution
           [(TyCoVar,Coercion)] -&gt; Type -&gt; Coercion
%*                                                                      *
%************************************************************************

Note [Lifting coercions over types: liftCoSubst]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The KPUSH rule deals with this situation
   data T a = K (a -&gt; Maybe a)
   g :: T t1 ~ T t2
   x :: t1 -&gt; Maybe t1

   case (K @t1 x) |&gt; g of
     K (y:t2 -&gt; Maybe t2) -&gt; rhs

We want to push the coercion inside the constructor application.
So we do this

   g' :: t1~t2  =  Nth 0 g

   case K @t2 (x |&gt; g' -&gt; Maybe g') of
     K (y:t2 -&gt; Maybe t2) -&gt; rhs

The crucial operation is that we
  * take the type of K's argument: a -&gt; Maybe a
  * and substitute g' for a
thus giving *coercion*.  This is what liftCoSubst does.

In the presence of kind coercions, this is a bit
of a hairy operation. So, we refer you to the paper introducing kind coercions,
available at www.cis.upenn.edu/~sweirich/papers/fckinds-extended.pdf

Note [extendLiftingContextEx]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider we have datatype
  K :: \/k. \/a::k. P -&gt; T k  -- P be some type
  g :: T k1 ~ T k2

  case (K @k1 @t1 x) |&gt; g of
    K y -&gt; rhs

We want to push the coercion inside the constructor application.
We first get the coercion mapped by the universal type variable k:
   lc = k |-&gt; Nth 0 g :: k1~k2

Here, the important point is that the kind of a is coerced, and P might be
dependent on the existential type variable a.
Thus we first get the coercion of a's kind
   g2 = liftCoSubst lc k :: k1 ~ k2

Then we store a new mapping into the lifting context
   lc2 = a |-&gt; (t1 ~ t1 |&gt; g2), lc

So later when we can correctly deal with the argument type P
   liftCoSubst lc2 P :: P [k|-&gt;k1][a|-&gt;t1] ~ P[k|-&gt;k2][a |-&gt; (t1|&gt;g2)]

This is exactly what extendLiftingContextEx does.
* For each (tyvar:k, ty) pair, we product the mapping
    tyvar |-&gt; (ty ~ ty |&gt; (liftCoSubst lc k))
* For each (covar:s1~s2, ty) pair, we produce the mapping
    covar |-&gt; (co ~ co')
    co' = Sym (liftCoSubst lc s1) ;; covar ;; liftCoSubst lc s2 :: s1'~s2'

This follows the lifting context extension definition in the
&quot;FC with Explicit Kind Equality&quot; paper.
-}</span><span>
</span><a name="line-1758"></a><span>
</span><a name="line-1759"></a><span class="hs-comment">-- ----------------------------------------------------</span><span>
</span><a name="line-1760"></a><span class="hs-comment">-- See Note [Lifting coercions over types: liftCoSubst]</span><span>
</span><a name="line-1761"></a><span class="hs-comment">-- ----------------------------------------------------</span><span>
</span><a name="line-1762"></a><span>
</span><a name="line-1763"></a><span class="hs-keyword">data</span><span> </span><a name="LiftingContext"><a href="Coercion.html#LiftingContext"><span class="hs-identifier">LiftingContext</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="LC"><a href="Coercion.html#LC"><span class="hs-identifier">LC</span></a></a><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><a href="Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a><span>
</span><a name="line-1764"></a><span>  </span><span class="hs-comment">-- in optCoercion, we need to lift when optimizing InstCo.</span><span>
</span><a name="line-1765"></a><span>  </span><span class="hs-comment">-- See Note [Optimising InstCo] in OptCoercion</span><span>
</span><a name="line-1766"></a><span>  </span><span class="hs-comment">-- We thus propagate the substitution from OptCoercion here.</span><span>
</span><a name="line-1767"></a><span>
</span><a name="line-1768"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1769"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073046"><a href="#local-6989586621682073046"><span class="hs-identifier">env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;LiftingContext:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073046"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1770"></a><span>
</span><a name="line-1771"></a><span class="hs-keyword">type</span><span> </span><a name="LiftCoEnv"><a href="Coercion.html#LiftCoEnv"><span class="hs-identifier">LiftCoEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1772"></a><span>     </span><span class="hs-comment">-- Maps *type variables* to *coercions*.</span><span>
</span><a name="line-1773"></a><span>     </span><span class="hs-comment">-- That's the whole point of this function!</span><span>
</span><a name="line-1774"></a><span>     </span><span class="hs-comment">-- Also maps coercion variables to ProofIrrelCos.</span><span>
</span><a name="line-1775"></a><span>
</span><a name="line-1776"></a><span class="hs-comment">-- like liftCoSubstWith, but allows for existentially-bound types as well</span><span>
</span><a name="line-1777"></a><span class="hs-identifier">liftCoSubstWithEx</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>          </span><span class="hs-comment">-- desired role for output coercion</span><span>
</span><a name="line-1778"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- universally quantified tyvars</span><span>
</span><a name="line-1779"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- coercions to substitute for those</span><span>
</span><a name="line-1780"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- existentially quantified tycovars</span><span>
</span><a name="line-1781"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- types and coercions to be bound to ex vars</span><span>
</span><a name="line-1782"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (lifting function, converted ex args)</span><span>
</span><a name="line-1783"></a><a name="liftCoSubstWithEx"><a href="Coercion.html#liftCoSubstWithEx"><span class="hs-identifier">liftCoSubstWithEx</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682073629"><a href="#local-6989586621682073629"><span class="hs-identifier">univs</span></a></a><span> </span><a name="local-6989586621682073630"><a href="#local-6989586621682073630"><span class="hs-identifier">omegas</span></a></a><span> </span><a name="local-6989586621682073631"><a href="#local-6989586621682073631"><span class="hs-identifier">exs</span></a></a><span> </span><a name="local-6989586621682073632"><a href="#local-6989586621682073632"><span class="hs-identifier">rhos</span></a></a><span>
</span><a name="line-1784"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073633"><a href="#local-6989586621682073633"><span class="hs-identifier">theta</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkLiftingContext"><span class="hs-identifier hs-var">mkLiftingContext</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#zipEqual"><span class="hs-identifier hs-var">zipEqual</span></a><span> </span><span class="hs-string">&quot;liftCoSubstWithExU&quot;</span><span> </span><a href="#local-6989586621682073629"><span class="hs-identifier hs-var">univs</span></a><span> </span><a href="#local-6989586621682073630"><span class="hs-identifier hs-var">omegas</span></a><span class="hs-special">)</span><span>
</span><a name="line-1785"></a><span>        </span><a name="local-6989586621682073634"><a href="#local-6989586621682073634"><span class="hs-identifier">psi</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#extendLiftingContextEx"><span class="hs-identifier hs-var">extendLiftingContextEx</span></a><span> </span><a href="#local-6989586621682073633"><span class="hs-identifier hs-var">theta</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#zipEqual"><span class="hs-identifier hs-var">zipEqual</span></a><span> </span><span class="hs-string">&quot;liftCoSubstWithExX&quot;</span><span> </span><a href="#local-6989586621682073631"><span class="hs-identifier hs-var">exs</span></a><span> </span><a href="#local-6989586621682073632"><span class="hs-identifier hs-var">rhos</span></a><span class="hs-special">)</span><span>
</span><a name="line-1786"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#ty_co_subst"><span class="hs-identifier hs-var">ty_co_subst</span></a><span> </span><a href="#local-6989586621682073634"><span class="hs-identifier hs-var">psi</span></a><span> </span><span class="hs-keyword">role</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">substTys</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstRight"><span class="hs-identifier hs-var">lcSubstRight</span></a><span> </span><a href="#local-6989586621682073634"><span class="hs-identifier hs-var">psi</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyCoVarTys"><span class="hs-identifier hs-var">mkTyCoVarTys</span></a><span> </span><a href="#local-6989586621682073631"><span class="hs-identifier hs-var">exs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1787"></a><span>
</span><a name="line-1788"></a><span class="hs-identifier">liftCoSubstWith</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1789"></a><a name="liftCoSubstWith"><a href="Coercion.html#liftCoSubstWith"><span class="hs-identifier">liftCoSubstWith</span></a></a><span> </span><a name="local-6989586621682073635"><a href="#local-6989586621682073635"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073636"><a href="#local-6989586621682073636"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682073637"><a href="#local-6989586621682073637"><span class="hs-identifier">cos</span></a></a><span> </span><a name="local-6989586621682073638"><a href="#local-6989586621682073638"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1790"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a><span> </span><a href="#local-6989586621682073635"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkLiftingContext"><span class="hs-identifier hs-var">mkLiftingContext</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Util.html#zipEqual"><span class="hs-identifier hs-var">zipEqual</span></a><span> </span><span class="hs-string">&quot;liftCoSubstWith&quot;</span><span> </span><a href="#local-6989586621682073636"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073637"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073638"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1791"></a><span>
</span><a name="line-1792"></a><span class="hs-comment">-- | @liftCoSubst role lc ty@ produces a coercion (at role @role@)</span><span>
</span><a name="line-1793"></a><span class="hs-comment">-- that coerces between @lc_left(ty)@ and @lc_right(ty)@, where</span><span>
</span><a name="line-1794"></a><span class="hs-comment">-- @lc_left@ is a substitution mapping type variables to the left-hand</span><span>
</span><a name="line-1795"></a><span class="hs-comment">-- types of the mapped coercions in @lc@, and similar for @lc_right@.</span><span>
</span><a name="line-1796"></a><span class="hs-identifier">liftCoSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Util.html#HasDebugCallStack"><span class="hs-identifier hs-type">HasDebugCallStack</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1797"></a><a name="liftCoSubst"><a href="Coercion.html#liftCoSubst"><span class="hs-identifier">liftCoSubst</span></a></a><span> </span><a name="local-6989586621682073639"><a href="#local-6989586621682073639"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073640"><a href="#local-6989586621682073640"><span class="hs-identifier">lc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073641"><a href="#local-6989586621682073641"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073642"><a href="#local-6989586621682073642"><span class="hs-identifier">env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073643"><a href="#local-6989586621682073643"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1798"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621682073642"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073639"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621682073641"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073643"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1799"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#ty_co_subst"><span class="hs-identifier hs-var">ty_co_subst</span></a><span> </span><a href="#local-6989586621682073640"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073639"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073643"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1800"></a><span>
</span><a name="line-1801"></a><span class="hs-identifier">emptyLiftingContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-1802"></a><a name="emptyLiftingContext"><a href="Coercion.html#emptyLiftingContext"><span class="hs-identifier">emptyLiftingContext</span></a></a><span> </span><a name="local-6989586621682073644"><a href="#local-6989586621682073644"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a><span> </span><a href="#local-6989586621682073644"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-1803"></a><span>
</span><a name="line-1804"></a><span class="hs-identifier">mkLiftingContext</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-1805"></a><a name="mkLiftingContext"><a href="Coercion.html#mkLiftingContext"><span class="hs-identifier">mkLiftingContext</span></a></a><span> </span><a name="local-6989586621682073645"><a href="#local-6989586621682073645"><span class="hs-identifier">pairs</span></a></a><span>
</span><a name="line-1806"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCos"><span class="hs-identifier hs-var">tyCoVarsOfCos</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621682073645"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1807"></a><span>       </span><span class="hs-special">(</span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><a href="#local-6989586621682073645"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1808"></a><span>
</span><a name="line-1809"></a><span class="hs-identifier">mkSubstLiftingContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-1810"></a><a name="mkSubstLiftingContext"><a href="Coercion.html#mkSubstLiftingContext"><span class="hs-identifier">mkSubstLiftingContext</span></a></a><span> </span><a name="local-6989586621682073646"><a href="#local-6989586621682073646"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a href="#local-6989586621682073646"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-1811"></a><span>
</span><a name="line-1812"></a><span class="hs-comment">-- | Extend a lifting context with a new mapping.</span><span>
</span><a name="line-1813"></a><span class="hs-identifier">extendLiftingContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>  </span><span class="hs-comment">-- ^ original LC</span><span>
</span><a name="line-1814"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span>         </span><span class="hs-comment">-- ^ new variable to map...</span><span>
</span><a name="line-1815"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>        </span><span class="hs-comment">-- ^ ...to this lifted version</span><span>
</span><a name="line-1816"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-1817"></a><span>    </span><span class="hs-comment">-- mappings to reflexive coercions are just substitutions</span><span>
</span><a name="line-1818"></a><a name="extendLiftingContext"><a href="Coercion.html#extendLiftingContext"><span class="hs-identifier">extendLiftingContext</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073647"><a href="#local-6989586621682073647"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073648"><a href="#local-6989586621682073648"><span class="hs-identifier">env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073649"><a href="#local-6989586621682073649"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682073650"><a href="#local-6989586621682073650"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-1819"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073651"><a href="#local-6989586621682073651"><span class="hs-identifier">ty</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#isReflCo_maybe"><span class="hs-identifier hs-var">isReflCo_maybe</span></a><span> </span><a href="#local-6989586621682073650"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1820"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#extendTCvSubst"><span class="hs-identifier hs-var">extendTCvSubst</span></a><span> </span><a href="#local-6989586621682073647"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073649"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682073651"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073648"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1821"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1822"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a href="#local-6989586621682073647"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621682073648"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682073649"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682073650"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1823"></a><span>
</span><a name="line-1824"></a><span class="hs-comment">-- | Extend a lifting context with a new mapping, and extend the in-scope set</span><span>
</span><a name="line-1825"></a><span class="hs-identifier">extendLiftingContextAndInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>  </span><span class="hs-comment">-- ^ Original LC</span><span>
</span><a name="line-1826"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span>         </span><span class="hs-comment">-- ^ new variable to map...</span><span>
</span><a name="line-1827"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>        </span><span class="hs-comment">-- ^ to this coercion</span><span>
</span><a name="line-1828"></a><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-1829"></a><a name="extendLiftingContextAndInScope"><a href="Coercion.html#extendLiftingContextAndInScope"><span class="hs-identifier">extendLiftingContextAndInScope</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073652"><a href="#local-6989586621682073652"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073653"><a href="#local-6989586621682073653"><span class="hs-identifier">env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073654"><a href="#local-6989586621682073654"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682073655"><a href="#local-6989586621682073655"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1830"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#extendLiftingContext"><span class="hs-identifier hs-var">extendLiftingContext</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#extendTCvInScopeSet"><span class="hs-identifier hs-var">extendTCvInScopeSet</span></a><span> </span><a href="#local-6989586621682073652"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-6989586621682073655"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073653"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073654"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682073655"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1831"></a><span>
</span><a name="line-1832"></a><span class="hs-comment">-- | Extend a lifting context with existential-variable bindings.</span><span>
</span><a name="line-1833"></a><span class="hs-comment">-- See Note [extendLiftingContextEx]</span><span>
</span><a name="line-1834"></a><span class="hs-identifier">extendLiftingContextEx</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>    </span><span class="hs-comment">-- ^ original lifting context</span><span>
</span><a name="line-1835"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ ex. var / value pairs</span><span>
</span><a name="line-1836"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-1837"></a><span class="hs-comment">-- Note that this is more involved than extendLiftingContext. That function</span><span>
</span><a name="line-1838"></a><span class="hs-comment">-- takes a coercion to extend with, so it's assumed that the caller has taken</span><span>
</span><a name="line-1839"></a><span class="hs-comment">-- into account any of the kind-changing stuff worried about here.</span><span>
</span><a name="line-1840"></a><a name="extendLiftingContextEx"><a href="Coercion.html#extendLiftingContextEx"><span class="hs-identifier">extendLiftingContextEx</span></a></a><span> </span><a name="local-6989586621682073656"><a href="#local-6989586621682073656"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073656"><span class="hs-identifier hs-var">lc</span></a><span>
</span><a name="line-1841"></a><span class="hs-identifier">extendLiftingContextEx</span><span> </span><a name="local-6989586621682073657"><a href="#local-6989586621682073657"><span class="hs-identifier">lc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073658"><a href="#local-6989586621682073658"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073659"><a href="#local-6989586621682073659"><span class="hs-identifier">env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682073660"><a href="#local-6989586621682073660"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><a name="local-6989586621682073661"><a href="#local-6989586621682073661"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621682073662"><a href="#local-6989586621682073662"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1842"></a><span class="hs-comment">-- This function adds bindings for *Nominal* coercions. Why? Because it</span><span>
</span><a name="line-1843"></a><span class="hs-comment">-- works with existentially bound variables, which are considered to have</span><span>
</span><a name="line-1844"></a><span class="hs-comment">-- nominal roles.</span><span>
</span><a name="line-1845"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682073660"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1846"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073663"><a href="#local-6989586621682073663"><span class="hs-identifier">lc'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073658"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#extendTCvInScopeSet"><span class="hs-identifier hs-var">extendTCvInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-6989586621682073661"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1847"></a><span>                 </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621682073659"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682073660"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1848"></a><span>                  </span><a href="Coercion.html#mkGReflRightCo"><span class="hs-identifier hs-var">mkGReflRightCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1849"></a><span>                                 </span><a href="#local-6989586621682073661"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1850"></a><span>                                 </span><span class="hs-special">(</span><a href="Coercion.html#ty_co_subst"><span class="hs-identifier hs-var">ty_co_subst</span></a><span> </span><a href="#local-6989586621682073657"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621682073660"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1851"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Coercion.html#extendLiftingContextEx"><span class="hs-identifier hs-var">extendLiftingContextEx</span></a><span> </span><a href="#local-6989586621682073663"><span class="hs-identifier hs-var">lc'</span></a><span> </span><a href="#local-6989586621682073662"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1852"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621682073664"><a href="#local-6989586621682073664"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682073661"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1853"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- co      :: s1 ~r s2</span><span>
</span><a name="line-1854"></a><span>    </span><span class="hs-comment">-- lift_s1 :: s1 ~r s1'</span><span>
</span><a name="line-1855"></a><span>    </span><span class="hs-comment">-- lift_s2 :: s2 ~r s2'</span><span>
</span><a name="line-1856"></a><span>    </span><span class="hs-comment">-- kco     :: (s1 ~r s2) ~N (s1' ~r s2')</span><span>
</span><a name="line-1857"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1858"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682073665"><a href="#local-6989586621682073665"><span class="hs-identifier">s1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073666"><a href="#local-6989586621682073666"><span class="hs-identifier">s2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073667"><a href="#local-6989586621682073667"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarKindsTypesRole"><span class="hs-identifier hs-var">coVarKindsTypesRole</span></a><span> </span><a href="#local-6989586621682073660"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1859"></a><span>        </span><a name="local-6989586621682073668"><a href="#local-6989586621682073668"><span class="hs-identifier">lift_s1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#ty_co_subst"><span class="hs-identifier hs-var">ty_co_subst</span></a><span> </span><a href="#local-6989586621682073657"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073667"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073665"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-1860"></a><span>        </span><a name="local-6989586621682073669"><a href="#local-6989586621682073669"><span class="hs-identifier">lift_s2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#ty_co_subst"><span class="hs-identifier hs-var">ty_co_subst</span></a><span> </span><a href="#local-6989586621682073657"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073667"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073666"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-1861"></a><span>        </span><a name="local-6989586621682073670"><a href="#local-6989586621682073670"><span class="hs-identifier">kco</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#equalityTyCon"><span class="hs-identifier hs-var">equalityTyCon</span></a><span> </span><a href="#local-6989586621682073667"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1862"></a><span>                               </span><span class="hs-special">[</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073668"><span class="hs-identifier hs-var">lift_s1</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073669"><span class="hs-identifier hs-var">lift_s2</span></a><span>
</span><a name="line-1863"></a><span>                               </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073668"><span class="hs-identifier hs-var">lift_s1</span></a><span>         </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073669"><span class="hs-identifier hs-var">lift_s2</span></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-1864"></a><span>        </span><a name="local-6989586621682073671"><a href="#local-6989586621682073671"><span class="hs-identifier">lc'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073658"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#extendTCvInScopeSet"><span class="hs-identifier hs-var">extendTCvInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-6989586621682073664"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1865"></a><span>                     </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621682073659"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682073660"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1866"></a><span>                        </span><span class="hs-special">(</span><a href="Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-var">mkProofIrrelCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073670"><span class="hs-identifier hs-var">kco</span></a><span> </span><a href="#local-6989586621682073664"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1867"></a><span>                          </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682073668"><span class="hs-identifier hs-var">lift_s1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073664"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073669"><span class="hs-identifier hs-var">lift_s2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1868"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Coercion.html#extendLiftingContextEx"><span class="hs-identifier hs-var">extendLiftingContextEx</span></a><span> </span><a href="#local-6989586621682073671"><span class="hs-identifier hs-var">lc'</span></a><span> </span><a href="#local-6989586621682073662"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-1869"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1870"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;extendLiftingContextEx&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073660"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;|-&gt;&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073661"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1871"></a><span>
</span><a name="line-1872"></a><span>
</span><a name="line-1873"></a><span class="hs-comment">-- | Erase the environments in a lifting context</span><span>
</span><a name="line-1874"></a><span class="hs-identifier">zapLiftingContext</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-1875"></a><a name="zapLiftingContext"><a href="Coercion.html#zapLiftingContext"><span class="hs-identifier">zapLiftingContext</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073672"><a href="#local-6989586621682073672"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#zapTCvSubst"><span class="hs-identifier hs-var">zapTCvSubst</span></a><span> </span><a href="#local-6989586621682073672"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-1876"></a><span>
</span><a name="line-1877"></a><span class="hs-comment">-- | Like 'substForAllCoBndr', but works on a lifting context</span><span>
</span><a name="line-1878"></a><span class="hs-identifier">substForAllCoBndrUsingLC</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1879"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1880"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1881"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1882"></a><a name="substForAllCoBndrUsingLC"><a href="Coercion.html#substForAllCoBndrUsingLC"><span class="hs-identifier">substForAllCoBndrUsingLC</span></a></a><span> </span><a name="local-6989586621682073673"><a href="#local-6989586621682073673"><span class="hs-identifier">sym</span></a></a><span> </span><a name="local-6989586621682073674"><a href="#local-6989586621682073674"><span class="hs-identifier">sco</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073675"><a href="#local-6989586621682073675"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073676"><a href="#local-6989586621682073676"><span class="hs-identifier">lc_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073677"><a href="#local-6989586621682073677"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682073678"><a href="#local-6989586621682073678"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1883"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a href="#local-6989586621682073679"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682073676"><span class="hs-identifier hs-var">lc_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073680"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073681"><span class="hs-identifier hs-var">co'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1884"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1885"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073679"><a href="#local-6989586621682073679"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073680"><a href="#local-6989586621682073680"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073681"><a href="#local-6989586621682073681"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substForAllCoBndrUsing"><span class="hs-identifier hs-var">substForAllCoBndrUsing</span></a><span> </span><a href="#local-6989586621682073673"><span class="hs-identifier hs-var">sym</span></a><span> </span><a href="#local-6989586621682073674"><span class="hs-identifier hs-var">sco</span></a><span> </span><a href="#local-6989586621682073675"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073677"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682073678"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1886"></a><span>
</span><a name="line-1887"></a><span class="hs-comment">-- | The \&quot;lifting\&quot; operation which substitutes coercions for type</span><span>
</span><a name="line-1888"></a><span class="hs-comment">--   variables in a type to produce a coercion.</span><span>
</span><a name="line-1889"></a><span class="hs-comment">--</span><span>
</span><a name="line-1890"></a><span class="hs-comment">--   For the inverse operation, see 'liftCoMatch'</span><span>
</span><a name="line-1891"></a><span class="hs-identifier">ty_co_subst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1892"></a><a name="ty_co_subst"><a href="Coercion.html#ty_co_subst"><span class="hs-identifier">ty_co_subst</span></a></a><span> </span><a name="local-6989586621682073682"><a href="#local-6989586621682073682"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682073684"><a href="#local-6989586621682073684"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1893"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682073684"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1894"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1895"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1896"></a><span>    </span><a name="local-6989586621682073685"><a href="#local-6989586621682073685"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682073687"><a href="#local-6989586621682073687"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073688"><a href="#local-6989586621682073688"><span class="hs-identifier">ty</span></a></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073689"><a href="#local-6989586621682073689"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-6989586621682073688"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1897"></a><span>                           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073687"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073689"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1898"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><a name="local-6989586621682073690"><a href="#local-6989586621682073690"><span class="hs-identifier">ty</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073686"><span class="hs-identifier hs-var">lift_phantom</span></a><span> </span><a href="#local-6989586621682073690"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1899"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073691"><a href="#local-6989586621682073691"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-6989586621682073692"><a href="#local-6989586621682073692"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;ty_co_subst bad roles&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1900"></a><span>                             </span><a href="Coercion.html#liftCoSubstTyVar"><span class="hs-identifier hs-var">liftCoSubstTyVar</span></a><span> </span><a href="#local-6989586621682073682"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073691"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073692"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1901"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073693"><a href="#local-6989586621682073693"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621682073694"><a href="#local-6989586621682073694"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073695"><a href="#local-6989586621682073695"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073693"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073694"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073695"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1902"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073696"><a href="#local-6989586621682073696"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621682073697"><a href="#local-6989586621682073697"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073698"><a href="#local-6989586621682073698"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="#local-6989586621682073696"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073697"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a><span> </span><a href="#local-6989586621682073696"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073697"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073698"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1903"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073699"><a href="#local-6989586621682073699"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621682073700"><a href="#local-6989586621682073700"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073701"><a href="#local-6989586621682073701"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="#local-6989586621682073699"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073699"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073700"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073699"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073701"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1904"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073702"><a href="#local-6989586621682073702"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073703"><a href="#local-6989586621682073703"><span class="hs-identifier">t</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a name="local-6989586621682073704"><a href="#local-6989586621682073704"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682073705"><a href="#local-6989586621682073705"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1905"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073706"><a href="#local-6989586621682073706"><span class="hs-identifier">lc'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073707"><a href="#local-6989586621682073707"><span class="hs-identifier">v'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073708"><a href="#local-6989586621682073708"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftCoSubstVarBndr"><span class="hs-identifier hs-var">liftCoSubstVarBndr</span></a><span> </span><a href="#local-6989586621682073682"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073704"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1906"></a><span>             </span><a name="local-6989586621682073709"><a href="#local-6989586621682073709"><span class="hs-identifier">body_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#ty_co_subst"><span class="hs-identifier hs-var">ty_co_subst</span></a><span> </span><a href="#local-6989586621682073706"><span class="hs-identifier hs-var">lc'</span></a><span> </span><a href="#local-6989586621682073702"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073705"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1907"></a><span>         </span><span class="hs-keyword">if</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682073707"><span class="hs-identifier hs-var">v'</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="TyCoRep.html#almostDevoidCoVarOfCo"><span class="hs-identifier hs-var">almostDevoidCoVarOfCo</span></a><span> </span><a href="#local-6989586621682073707"><span class="hs-identifier hs-var">v'</span></a><span> </span><a href="#local-6989586621682073709"><span class="hs-identifier hs-var">body_co</span></a><span>
</span><a name="line-1908"></a><span>           </span><span class="hs-comment">-- Lifting a ForAllTy over a coercion variable could fail as ForAllCo</span><span>
</span><a name="line-1909"></a><span>           </span><span class="hs-comment">-- imposes an extra restriction on where a covar can appear. See last</span><span>
</span><a name="line-1910"></a><span>           </span><span class="hs-comment">-- wrinkle in Note [Unused coercion variable in ForAllCo].</span><span>
</span><a name="line-1911"></a><span>           </span><span class="hs-comment">-- We specifically check for this and panic because we know that</span><span>
</span><a name="line-1912"></a><span>           </span><span class="hs-comment">-- there's a hole in the type system here, and we'd rather panic than</span><span>
</span><a name="line-1913"></a><span>           </span><span class="hs-comment">-- fall into it.</span><span>
</span><a name="line-1914"></a><span>         </span><span class="hs-keyword">then</span><span> </span><a href="Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a><span> </span><a href="#local-6989586621682073707"><span class="hs-identifier hs-var">v'</span></a><span> </span><a href="#local-6989586621682073708"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621682073709"><span class="hs-identifier hs-var">body_co</span></a><span>
</span><a name="line-1915"></a><span>         </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;ty_co_subst: covar is not almost devoid&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073703"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-1916"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073710"><a href="#local-6989586621682073710"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073711"><a href="#local-6989586621682073711"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">Nominal</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1917"></a><span>                             </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-6989586621682073711"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1918"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073712"><a href="#local-6989586621682073712"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621682073713"><a href="#local-6989586621682073713"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073714"><a href="#local-6989586621682073714"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#castCoercionKindI"><span class="hs-identifier hs-var">castCoercionKindI</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073712"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073713"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#substLeftCo"><span class="hs-identifier hs-var">substLeftCo</span></a><span> </span><a href="#local-6989586621682073682"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073714"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1919"></a><span>                                                         </span><span class="hs-special">(</span><a href="Coercion.html#substRightCo"><span class="hs-identifier hs-var">substRightCo</span></a><span> </span><a href="#local-6989586621682073682"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073714"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1920"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073715"><a href="#local-6989586621682073715"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621682073716"><a href="#local-6989586621682073716"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-var">mkProofIrrelCo</span></a><span> </span><a href="#local-6989586621682073715"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073717"><span class="hs-identifier hs-var">kco</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#substLeftCo"><span class="hs-identifier hs-var">substLeftCo</span></a><span> </span><a href="#local-6989586621682073682"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073716"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1921"></a><span>                                                  </span><span class="hs-special">(</span><a href="Coercion.html#substRightCo"><span class="hs-identifier hs-var">substRightCo</span></a><span> </span><a href="#local-6989586621682073682"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073716"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1922"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682073717"><a href="#local-6989586621682073717"><span class="hs-identifier">kco</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-6989586621682073716"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1923"></a><span>
</span><a name="line-1924"></a><span>    </span><a name="local-6989586621682073686"><a href="#local-6989586621682073686"><span class="hs-identifier">lift_phantom</span></a></a><span> </span><a name="local-6989586621682073718"><a href="#local-6989586621682073718"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkPhantomCo"><span class="hs-identifier hs-var">mkPhantomCo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682073718"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1925"></a><span>                                  </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstLeft"><span class="hs-identifier hs-var">lcSubstLeft</span></a><span>  </span><a href="#local-6989586621682073682"><span class="hs-identifier hs-var">lc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073718"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1926"></a><span>                                  </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstRight"><span class="hs-identifier hs-var">lcSubstRight</span></a><span> </span><a href="#local-6989586621682073682"><span class="hs-identifier hs-var">lc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073718"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1927"></a><span>
</span><a name="line-1928"></a><span class="hs-comment">{-
Note [liftCoSubstTyVar]
~~~~~~~~~~~~~~~~~~~~~~~~~
This function can fail if a coercion in the environment is of too low a role.

liftCoSubstTyVar is called from two places: in liftCoSubst (naturally), and
also in matchAxiom in OptCoercion. From liftCoSubst, the so-called lifting
lemma guarantees that the roles work out. If we fail in this
case, we really should panic -- something is deeply wrong. But, in matchAxiom,
failing is fine. matchAxiom is trying to find a set of coercions
that match, but it may fail, and this is healthy behavior.
-}</span><span>
</span><a name="line-1940"></a><span>
</span><a name="line-1941"></a><span class="hs-comment">-- See Note [liftCoSubstTyVar]</span><span>
</span><a name="line-1942"></a><span class="hs-identifier">liftCoSubstTyVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1943"></a><a name="liftCoSubstTyVar"><a href="Coercion.html#liftCoSubstTyVar"><span class="hs-identifier">liftCoSubstTyVar</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073719"><a href="#local-6989586621682073719"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073720"><a href="#local-6989586621682073720"><span class="hs-identifier">env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073721"><a href="#local-6989586621682073721"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073722"><a href="#local-6989586621682073722"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-1944"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073723"><a href="#local-6989586621682073723"><span class="hs-identifier">co_arg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621682073720"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682073722"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1945"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#downgradeRole_maybe"><span class="hs-identifier hs-var">downgradeRole_maybe</span></a><span> </span><a href="#local-6989586621682073721"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073723"><span class="hs-identifier hs-var">co_arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073723"><span class="hs-identifier hs-var">co_arg</span></a><span>
</span><a name="line-1946"></a><span>
</span><a name="line-1947"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1948"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682073721"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTyVar"><span class="hs-identifier hs-var">substTyVar</span></a><span> </span><a href="#local-6989586621682073719"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073722"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1949"></a><span>
</span><a name="line-1950"></a><span class="hs-comment">{- Note [liftCoSubstVarBndr]

callback:
  We want 'liftCoSubstVarBndrUsing' to be general enough to be reused in
  FamInstEnv, therefore the input arg 'fun' returns a pair with polymophic type
  in snd.
  However in 'liftCoSubstVarBndr', we don't need the snd, so we use unit and
  ignore the fourth component of the return value.

liftCoSubstTyVarBndrUsing:
  Given
    forall tv:k. t
  We want to get
    forall (tv:k1) (kind_co :: k1 ~ k2) body_co

  We lift the kind k to get the kind_co
    kind_co = ty_co_subst k :: k1 ~ k2

  Now in the LiftingContext, we add the new mapping
    tv |-&gt; (tv :: k1) ~ ((tv |&gt; kind_co) :: k2)

liftCoSubstCoVarBndrUsing:
  Given
    forall cv:(s1 ~ s2). t
  We want to get
    forall (cv:s1'~s2') (kind_co :: (s1'~s2') ~ (t1 ~ t2)) body_co

  We lift s1 and s2 respectively to get
    eta1 :: s1' ~ t1
    eta2 :: s2' ~ t2
  And
    kind_co = TyConAppCo Nominal (~#) eta1 eta2

  Now in the liftingContext, we add the new mapping
    cv |-&gt; (cv :: s1' ~ s2') ~ ((sym eta1;cv;eta2) :: t1 ~ t2)
-}</span><span>
</span><a name="line-1986"></a><span>
</span><a name="line-1987"></a><span class="hs-comment">-- See Note [liftCoSubstVarBndr]</span><span>
</span><a name="line-1988"></a><span class="hs-identifier">liftCoSubstVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span>
</span><a name="line-1989"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1990"></a><a name="liftCoSubstVarBndr"><a href="Coercion.html#liftCoSubstVarBndr"><span class="hs-identifier">liftCoSubstVarBndr</span></a></a><span> </span><a name="local-6989586621682073724"><a href="#local-6989586621682073724"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682073725"><a href="#local-6989586621682073725"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1991"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073729"><a href="#local-6989586621682073729"><span class="hs-identifier">lc'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073730"><a href="#local-6989586621682073730"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073731"><a href="#local-6989586621682073731"><span class="hs-identifier">h</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftCoSubstVarBndrUsing"><span class="hs-identifier hs-var">liftCoSubstVarBndrUsing</span></a><span> </span><a href="#local-6989586621682073726"><span class="hs-identifier hs-var">callback</span></a><span> </span><a href="#local-6989586621682073724"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073725"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1992"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621682073729"><span class="hs-identifier hs-var">lc'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073730"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073731"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-1993"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1994"></a><span>    </span><a name="local-6989586621682073726"><a href="#local-6989586621682073726"><span class="hs-identifier">callback</span></a></a><span> </span><a name="local-6989586621682073727"><a href="#local-6989586621682073727"><span class="hs-identifier">lc'</span></a></a><span> </span><a name="local-6989586621682073728"><a href="#local-6989586621682073728"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#ty_co_subst"><span class="hs-identifier hs-var">ty_co_subst</span></a><span> </span><a href="#local-6989586621682073727"><span class="hs-identifier hs-var">lc'</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073728"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1995"></a><span>
</span><a name="line-1996"></a><span class="hs-comment">-- the callback must produce a nominal coercion</span><span>
</span><a name="line-1997"></a><span class="hs-identifier">liftCoSubstVarBndrUsing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073050"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1998"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span>
</span><a name="line-1999"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073050"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2000"></a><a name="liftCoSubstVarBndrUsing"><a href="Coercion.html#liftCoSubstVarBndrUsing"><span class="hs-identifier">liftCoSubstVarBndrUsing</span></a></a><span> </span><a name="local-6989586621682073732"><a href="#local-6989586621682073732"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682073733"><a href="#local-6989586621682073733"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682073734"><a href="#local-6989586621682073734"><span class="hs-identifier">old_var</span></a></a><span>
</span><a name="line-2001"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682073734"><span class="hs-identifier hs-var">old_var</span></a><span>
</span><a name="line-2002"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftCoSubstTyVarBndrUsing"><span class="hs-identifier hs-var">liftCoSubstTyVarBndrUsing</span></a><span> </span><a href="#local-6989586621682073732"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621682073733"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073734"><span class="hs-identifier hs-var">old_var</span></a><span>
</span><a name="line-2003"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2004"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftCoSubstCoVarBndrUsing"><span class="hs-identifier hs-var">liftCoSubstCoVarBndrUsing</span></a><span> </span><a href="#local-6989586621682073732"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621682073733"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073734"><span class="hs-identifier hs-var">old_var</span></a><span>
</span><a name="line-2005"></a><span>
</span><a name="line-2006"></a><span class="hs-comment">-- Works for tyvar binder</span><span>
</span><a name="line-2007"></a><span class="hs-identifier">liftCoSubstTyVarBndrUsing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073049"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2008"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span>
</span><a name="line-2009"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073049"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2010"></a><a name="liftCoSubstTyVarBndrUsing"><a href="Coercion.html#liftCoSubstTyVarBndrUsing"><span class="hs-identifier">liftCoSubstTyVarBndrUsing</span></a></a><span> </span><a name="local-6989586621682073735"><a href="#local-6989586621682073735"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682073736"><a href="#local-6989586621682073736"><span class="hs-identifier">lc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073737"><a href="#local-6989586621682073737"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073738"><a href="#local-6989586621682073738"><span class="hs-identifier">cenv</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073739"><a href="#local-6989586621682073739"><span class="hs-identifier">old_var</span></a></a><span>
</span><a name="line-2011"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">old_var</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2012"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073737"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073744"><span class="hs-identifier hs-var">new_var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073746"><span class="hs-identifier hs-var">new_cenv</span></a><span>
</span><a name="line-2013"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073744"><span class="hs-identifier hs-var">new_var</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073741"><span class="hs-identifier hs-var">eta</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073742"><span class="hs-identifier hs-var">stuff</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2014"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2015"></a><span>    </span><a name="local-6989586621682073740"><a href="#local-6989586621682073740"><span class="hs-identifier">old_kind</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621682073739"><span class="hs-identifier hs-var">old_var</span></a><span>
</span><a name="line-2016"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073741"><a href="#local-6989586621682073741"><span class="hs-identifier">eta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073742"><a href="#local-6989586621682073742"><span class="hs-identifier">stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073735"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621682073736"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073740"><span class="hs-identifier hs-var">old_kind</span></a><span>
</span><a name="line-2017"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073743"><a href="#local-6989586621682073743"><span class="hs-identifier">k1</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073741"><span class="hs-identifier hs-var">eta</span></a><span>
</span><a name="line-2018"></a><span>    </span><a name="local-6989586621682073744"><a href="#local-6989586621682073744"><span class="hs-identifier">new_var</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a><span> </span><a href="#local-6989586621682073737"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Var.html#setVarType"><span class="hs-identifier hs-var">setVarType</span></a><span> </span><a href="#local-6989586621682073739"><span class="hs-identifier hs-var">old_var</span></a><span> </span><a href="#local-6989586621682073743"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">)</span><span>
</span><a name="line-2019"></a><span>
</span><a name="line-2020"></a><span>    </span><a name="local-6989586621682073745"><a href="#local-6989586621682073745"><span class="hs-identifier">lifted</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkGReflRightCo"><span class="hs-identifier hs-var">mkGReflRightCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a href="#local-6989586621682073744"><span class="hs-identifier hs-var">new_var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073741"><span class="hs-identifier hs-var">eta</span></a><span>
</span><a name="line-2021"></a><span>               </span><span class="hs-comment">-- :: new_var ~ new_var |&gt; eta</span><span>
</span><a name="line-2022"></a><span>    </span><a name="local-6989586621682073746"><a href="#local-6989586621682073746"><span class="hs-identifier">new_cenv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621682073738"><span class="hs-identifier hs-var">cenv</span></a><span> </span><a href="#local-6989586621682073739"><span class="hs-identifier hs-var">old_var</span></a><span> </span><a href="#local-6989586621682073745"><span class="hs-identifier hs-var">lifted</span></a><span>
</span><a name="line-2023"></a><span>
</span><a name="line-2024"></a><span class="hs-comment">-- Works for covar binder</span><span>
</span><a name="line-2025"></a><span class="hs-identifier">liftCoSubstCoVarBndrUsing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073048"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2026"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span>
</span><a name="line-2027"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073048"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2028"></a><a name="liftCoSubstCoVarBndrUsing"><a href="Coercion.html#liftCoSubstCoVarBndrUsing"><span class="hs-identifier">liftCoSubstCoVarBndrUsing</span></a></a><span> </span><a name="local-6989586621682073747"><a href="#local-6989586621682073747"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682073748"><a href="#local-6989586621682073748"><span class="hs-identifier">lc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073749"><a href="#local-6989586621682073749"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073750"><a href="#local-6989586621682073750"><span class="hs-identifier">cenv</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073751"><a href="#local-6989586621682073751"><span class="hs-identifier">old_var</span></a></a><span>
</span><a name="line-2029"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier">old_var</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2030"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073749"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073756"><span class="hs-identifier hs-var">new_var</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073765"><span class="hs-identifier hs-var">new_cenv</span></a><span>
</span><a name="line-2031"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073756"><span class="hs-identifier hs-var">new_var</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073763"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073754"><span class="hs-identifier hs-var">stuff</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2032"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2033"></a><span>    </span><a name="local-6989586621682073752"><a href="#local-6989586621682073752"><span class="hs-identifier">old_kind</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarKind"><span class="hs-identifier hs-var">coVarKind</span></a><span> </span><a href="#local-6989586621682073751"><span class="hs-identifier hs-var">old_var</span></a><span>
</span><a name="line-2034"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073753"><a href="#local-6989586621682073753"><span class="hs-identifier">eta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073754"><a href="#local-6989586621682073754"><span class="hs-identifier">stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073747"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621682073748"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682073752"><span class="hs-identifier hs-var">old_kind</span></a><span>
</span><a name="line-2035"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073755"><a href="#local-6989586621682073755"><span class="hs-identifier">k1</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073753"><span class="hs-identifier hs-var">eta</span></a><span>
</span><a name="line-2036"></a><span>    </span><a name="local-6989586621682073756"><a href="#local-6989586621682073756"><span class="hs-identifier">new_var</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a><span> </span><a href="#local-6989586621682073749"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Var.html#setVarType"><span class="hs-identifier hs-var">setVarType</span></a><span> </span><a href="#local-6989586621682073751"><span class="hs-identifier hs-var">old_var</span></a><span> </span><a href="#local-6989586621682073755"><span class="hs-identifier hs-var">k1</span></a><span class="hs-special">)</span><span>
</span><a name="line-2037"></a><span>
</span><a name="line-2038"></a><span>    </span><span class="hs-comment">-- old_var :: s1  ~r s2</span><span>
</span><a name="line-2039"></a><span>    </span><span class="hs-comment">-- eta     :: (s1' ~r s2') ~N (t1 ~r t2)</span><span>
</span><a name="line-2040"></a><span>    </span><span class="hs-comment">-- eta1    :: s1' ~r t1</span><span>
</span><a name="line-2041"></a><span>    </span><span class="hs-comment">-- eta2    :: s2' ~r t2</span><span>
</span><a name="line-2042"></a><span>    </span><span class="hs-comment">-- co1     :: s1' ~r s2'</span><span>
</span><a name="line-2043"></a><span>    </span><span class="hs-comment">-- co2     :: t1  ~r t2</span><span>
</span><a name="line-2044"></a><span>    </span><span class="hs-comment">-- kind_co :: (s1' ~r s2') ~N (t1 ~r t2)</span><span>
</span><a name="line-2045"></a><span>    </span><span class="hs-comment">-- lifted  :: co1 ~N co2</span><span>
</span><a name="line-2046"></a><span>
</span><a name="line-2047"></a><span>    </span><span class="hs-keyword">role</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a><span> </span><a href="#local-6989586621682073751"><span class="hs-identifier hs-var">old_var</span></a><span>
</span><a name="line-2048"></a><span>    </span><a name="local-6989586621682073758"><a href="#local-6989586621682073758"><span class="hs-identifier">eta'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073753"><span class="hs-identifier hs-var">eta</span></a><span>
</span><a name="line-2049"></a><span>    </span><a name="local-6989586621682073759"><a href="#local-6989586621682073759"><span class="hs-identifier">eta1</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621682073758"><span class="hs-identifier hs-var">eta'</span></a><span>
</span><a name="line-2050"></a><span>    </span><a name="local-6989586621682073760"><a href="#local-6989586621682073760"><span class="hs-identifier">eta2</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621682073758"><span class="hs-identifier hs-var">eta'</span></a><span>
</span><a name="line-2051"></a><span>
</span><a name="line-2052"></a><span>    </span><a name="local-6989586621682073761"><a href="#local-6989586621682073761"><span class="hs-identifier">co1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-6989586621682073756"><span class="hs-identifier hs-var">new_var</span></a><span>
</span><a name="line-2053"></a><span>    </span><a name="local-6989586621682073762"><a href="#local-6989586621682073762"><span class="hs-identifier">co2</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682073759"><span class="hs-identifier hs-var">eta1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073761"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073760"><span class="hs-identifier hs-var">eta2</span></a><span>
</span><a name="line-2054"></a><span>    </span><a name="local-6989586621682073763"><a href="#local-6989586621682073763"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#equalityTyCon"><span class="hs-identifier hs-var">equalityTyCon</span></a><span> </span><span class="hs-keyword">role</span><span class="hs-special">)</span><span>
</span><a name="line-2055"></a><span>                           </span><span class="hs-special">[</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073761"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkKindCo"><span class="hs-identifier hs-var">mkKindCo</span></a><span> </span><a href="#local-6989586621682073762"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-2056"></a><span>                           </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073761"><span class="hs-identifier hs-var">co1</span></a><span>         </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073762"><span class="hs-identifier hs-var">co2</span></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-2057"></a><span>    </span><a name="local-6989586621682073764"><a href="#local-6989586621682073764"><span class="hs-identifier">lifted</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-var">mkProofIrrelCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073763"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><a href="#local-6989586621682073761"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682073762"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-2058"></a><span>
</span><a name="line-2059"></a><span>    </span><a name="local-6989586621682073765"><a href="#local-6989586621682073765"><span class="hs-identifier">new_cenv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621682073750"><span class="hs-identifier hs-var">cenv</span></a><span> </span><a href="#local-6989586621682073751"><span class="hs-identifier hs-var">old_var</span></a><span> </span><a href="#local-6989586621682073764"><span class="hs-identifier hs-var">lifted</span></a><span>
</span><a name="line-2060"></a><span>
</span><a name="line-2061"></a><span class="hs-comment">-- | Is a var in the domain of a lifting context?</span><span>
</span><a name="line-2062"></a><span class="hs-identifier">isMappedByLC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2063"></a><a name="isMappedByLC"><a href="Coercion.html#isMappedByLC"><span class="hs-identifier">isMappedByLC</span></a></a><span> </span><a name="local-6989586621682073766"><a href="#local-6989586621682073766"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073767"><a href="#local-6989586621682073767"><span class="hs-identifier">env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073766"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#elemVarEnv"><span class="hs-identifier hs-var">elemVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073767"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-2064"></a><span>
</span><a name="line-2065"></a><span class="hs-comment">-- If [a |-&gt; g] is in the substitution and g :: t1 ~ t2, substitute a for t1</span><span>
</span><a name="line-2066"></a><span class="hs-comment">-- If [a |-&gt; (g1, g2)] is in the substitution, substitute a for g1</span><span>
</span><a name="line-2067"></a><span class="hs-identifier">substLeftCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-2068"></a><a name="substLeftCo"><a href="Coercion.html#substLeftCo"><span class="hs-identifier">substLeftCo</span></a></a><span> </span><a name="local-6989586621682073768"><a href="#local-6989586621682073768"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682073769"><a href="#local-6989586621682073769"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-2069"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstLeft"><span class="hs-identifier hs-var">lcSubstLeft</span></a><span> </span><a href="#local-6989586621682073768"><span class="hs-identifier hs-var">lc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073769"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2070"></a><span>
</span><a name="line-2071"></a><span class="hs-comment">-- Ditto, but for t2 and g2</span><span>
</span><a name="line-2072"></a><span class="hs-identifier">substRightCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-2073"></a><a name="substRightCo"><a href="Coercion.html#substRightCo"><span class="hs-identifier">substRightCo</span></a></a><span> </span><a name="local-6989586621682073770"><a href="#local-6989586621682073770"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682073771"><a href="#local-6989586621682073771"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-2074"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#lcSubstRight"><span class="hs-identifier hs-var">lcSubstRight</span></a><span> </span><a href="#local-6989586621682073770"><span class="hs-identifier hs-var">lc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073771"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2075"></a><span>
</span><a name="line-2076"></a><span class="hs-comment">-- | Apply &quot;sym&quot; to all coercions in a 'LiftCoEnv'</span><span>
</span><a name="line-2077"></a><span class="hs-identifier">swapLiftCoEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a><span>
</span><a name="line-2078"></a><a name="swapLiftCoEnv"><a href="Coercion.html#swapLiftCoEnv"><span class="hs-identifier">swapLiftCoEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mapVarEnv"><span class="hs-identifier hs-var">mapVarEnv</span></a><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span>
</span><a name="line-2079"></a><span>
</span><a name="line-2080"></a><span class="hs-identifier">lcSubstLeft</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-2081"></a><a name="lcSubstLeft"><a href="Coercion.html#lcSubstLeft"><span class="hs-identifier">lcSubstLeft</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073772"><a href="#local-6989586621682073772"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073773"><a href="#local-6989586621682073773"><span class="hs-identifier">lc_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftEnvSubstLeft"><span class="hs-identifier hs-var">liftEnvSubstLeft</span></a><span> </span><a href="#local-6989586621682073772"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073773"><span class="hs-identifier hs-var">lc_env</span></a><span>
</span><a name="line-2082"></a><span>
</span><a name="line-2083"></a><span class="hs-identifier">lcSubstRight</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-2084"></a><a name="lcSubstRight"><a href="Coercion.html#lcSubstRight"><span class="hs-identifier">lcSubstRight</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073774"><a href="#local-6989586621682073774"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073775"><a href="#local-6989586621682073775"><span class="hs-identifier">lc_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftEnvSubstRight"><span class="hs-identifier hs-var">liftEnvSubstRight</span></a><span> </span><a href="#local-6989586621682073774"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073775"><span class="hs-identifier hs-var">lc_env</span></a><span>
</span><a name="line-2085"></a><span>
</span><a name="line-2086"></a><span class="hs-identifier">liftEnvSubstLeft</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-2087"></a><a name="liftEnvSubstLeft"><a href="Coercion.html#liftEnvSubstLeft"><span class="hs-identifier">liftEnvSubstLeft</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftEnvSubst"><span class="hs-identifier hs-var">liftEnvSubst</span></a><span> </span><span class="hs-identifier">pFst</span><span>
</span><a name="line-2088"></a><span>
</span><a name="line-2089"></a><span class="hs-identifier">liftEnvSubstRight</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-2090"></a><a name="liftEnvSubstRight"><a href="Coercion.html#liftEnvSubstRight"><span class="hs-identifier">liftEnvSubstRight</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftEnvSubst"><span class="hs-identifier hs-var">liftEnvSubst</span></a><span> </span><span class="hs-identifier">pSnd</span><span>
</span><a name="line-2091"></a><span>
</span><a name="line-2092"></a><span class="hs-identifier">liftEnvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621682073047"><a href="#local-6989586621682073047"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="#local-6989586621682073047"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682073047"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftCoEnv"><span class="hs-identifier hs-type">LiftCoEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-2093"></a><a name="liftEnvSubst"><a href="Coercion.html#liftEnvSubst"><span class="hs-identifier">liftEnvSubst</span></a></a><span> </span><a name="local-6989586621682073776"><a href="#local-6989586621682073776"><span class="hs-identifier">selector</span></a></a><span> </span><a name="local-6989586621682073777"><a href="#local-6989586621682073777"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073778"><a href="#local-6989586621682073778"><span class="hs-identifier">lc_env</span></a></a><span>
</span><a name="line-2094"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#composeTCvSubst"><span class="hs-identifier hs-var">composeTCvSubst</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="VarEnv.html#emptyInScopeSet"><span class="hs-identifier hs-var">emptyInScopeSet</span></a><span> </span><a href="#local-6989586621682073782"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621682073783"><span class="hs-identifier hs-var">cenv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073777"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-2095"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2096"></a><span>    </span><a name="local-6989586621682073779"><a href="#local-6989586621682073779"><span class="hs-identifier">pairs</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#nonDetUFMToList"><span class="hs-identifier hs-var">nonDetUFMToList</span></a><span> </span><a href="#local-6989586621682073778"><span class="hs-identifier hs-var">lc_env</span></a><span>
</span><a name="line-2097"></a><span>                       </span><span class="hs-comment">-- It's OK to use nonDetUFMToList here because we</span><span>
</span><a name="line-2098"></a><span>                       </span><span class="hs-comment">-- immediately forget the ordering by creating</span><span>
</span><a name="line-2099"></a><span>                       </span><span class="hs-comment">-- a VarEnv</span><span>
</span><a name="line-2100"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682073780"><a href="#local-6989586621682073780"><span class="hs-identifier">tpairs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073781"><a href="#local-6989586621682073781"><span class="hs-identifier">cpairs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#partitionWith"><span class="hs-identifier hs-var">partitionWith</span></a><span> </span><a href="#local-6989586621682073784"><span class="hs-identifier hs-var">ty_or_co</span></a><span> </span><a href="#local-6989586621682073779"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-2101"></a><span>    </span><a name="local-6989586621682073782"><a href="#local-6989586621682073782"><span class="hs-identifier">tenv</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkVarEnv_Directly"><span class="hs-identifier hs-var">mkVarEnv_Directly</span></a><span> </span><a href="#local-6989586621682073780"><span class="hs-identifier hs-var">tpairs</span></a><span>
</span><a name="line-2102"></a><span>    </span><a name="local-6989586621682073783"><a href="#local-6989586621682073783"><span class="hs-identifier">cenv</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkVarEnv_Directly"><span class="hs-identifier hs-var">mkVarEnv_Directly</span></a><span> </span><a href="#local-6989586621682073781"><span class="hs-identifier hs-var">cpairs</span></a><span>
</span><a name="line-2103"></a><span>
</span><a name="line-2104"></a><span>    </span><span class="hs-identifier">ty_or_co</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-2105"></a><span>    </span><a name="local-6989586621682073784"><a href="#local-6989586621682073784"><span class="hs-identifier">ty_or_co</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682073785"><a href="#local-6989586621682073785"><span class="hs-identifier">u</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073786"><a href="#local-6989586621682073786"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2106"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073788"><a href="#local-6989586621682073788"><span class="hs-identifier">equality_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#isCoercionTy_maybe"><span class="hs-identifier hs-var">isCoercionTy_maybe</span></a><span> </span><a href="#local-6989586621682073787"><span class="hs-identifier hs-var">equality_ty</span></a><span>
</span><a name="line-2107"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073785"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073788"><span class="hs-identifier hs-var">equality_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2108"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2109"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073785"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682073787"><span class="hs-identifier hs-var">equality_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2110"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2111"></a><span>        </span><a name="local-6989586621682073787"><a href="#local-6989586621682073787"><span class="hs-identifier">equality_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073776"><span class="hs-identifier hs-var">selector</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073786"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2112"></a><span>
</span><a name="line-2113"></a><span class="hs-comment">-- | Extract the underlying substitution from the LiftingContext</span><span>
</span><a name="line-2114"></a><span class="hs-identifier">lcTCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-2115"></a><a name="lcTCvSubst"><a href="Coercion.html#lcTCvSubst"><span class="hs-identifier">lcTCvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073789"><a href="#local-6989586621682073789"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073789"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-2116"></a><span>
</span><a name="line-2117"></a><span class="hs-comment">-- | Get the 'InScopeSet' from a 'LiftingContext'</span><span>
</span><a name="line-2118"></a><span class="hs-identifier">lcInScopeSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span>
</span><a name="line-2119"></a><a name="lcInScopeSet"><a href="Coercion.html#lcInScopeSet"><span class="hs-identifier">lcInScopeSet</span></a></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LC"><span class="hs-identifier hs-var">LC</span></a><span> </span><a name="local-6989586621682073790"><a href="#local-6989586621682073790"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a><span> </span><a href="#local-6989586621682073790"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-2120"></a><span>
</span><a name="line-2121"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
            Sequencing on coercions
%*                                                                      *
%************************************************************************
-}</span><span>
</span><a name="line-2128"></a><span>
</span><a name="line-2129"></a><span class="hs-identifier">seqMCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2130"></a><a name="seqMCo"><a href="Coercion.html#seqMCo"><span class="hs-identifier">seqMCo</span></a></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2131"></a><span class="hs-identifier">seqMCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073791"><a href="#local-6989586621682073791"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073791"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2132"></a><span>
</span><a name="line-2133"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2134"></a><a name="seqCo"><a href="Coercion.html#seqCo"><span class="hs-identifier">seqCo</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-6989586621682073792"><a href="#local-6989586621682073792"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><a href="#local-6989586621682073792"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2135"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a name="local-6989586621682073793"><a href="#local-6989586621682073793"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073794"><a href="#local-6989586621682073794"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682073795"><a href="#local-6989586621682073795"><span class="hs-identifier">mco</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073793"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><a href="#local-6989586621682073794"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqMCo"><span class="hs-identifier hs-var">seqMCo</span></a><span> </span><a href="#local-6989586621682073795"><span class="hs-identifier hs-var">mco</span></a><span>
</span><a name="line-2136"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-6989586621682073796"><a href="#local-6989586621682073796"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073797"><a href="#local-6989586621682073797"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073798"><a href="#local-6989586621682073798"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073796"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073797"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCos"><span class="hs-identifier hs-var">seqCos</span></a><span> </span><a href="#local-6989586621682073798"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-2137"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-6989586621682073799"><a href="#local-6989586621682073799"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073800"><a href="#local-6989586621682073800"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073799"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073800"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-2138"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073801"><a href="#local-6989586621682073801"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682073802"><a href="#local-6989586621682073802"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621682073803"><a href="#local-6989586621682073803"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073801"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073802"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-2139"></a><span>                                                       </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073803"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2140"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><a name="local-6989586621682073804"><a href="#local-6989586621682073804"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073805"><a href="#local-6989586621682073805"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073806"><a href="#local-6989586621682073806"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073804"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073805"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073806"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-2141"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a name="local-6989586621682073807"><a href="#local-6989586621682073807"><span class="hs-identifier">cv</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073807"><span class="hs-identifier hs-var">cv</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2142"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#HoleCo"><span class="hs-identifier hs-var">HoleCo</span></a><span> </span><a name="local-6989586621682073808"><a href="#local-6989586621682073808"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#coHoleCoVar"><span class="hs-identifier hs-var">coHoleCoVar</span></a><span> </span><a href="#local-6989586621682073808"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2143"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a name="local-6989586621682073809"><a href="#local-6989586621682073809"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621682073810"><a href="#local-6989586621682073810"><span class="hs-identifier">ind</span></a></a><span> </span><a name="local-6989586621682073811"><a href="#local-6989586621682073811"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073809"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073810"><span class="hs-identifier hs-var">ind</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCos"><span class="hs-identifier hs-var">seqCos</span></a><span> </span><a href="#local-6989586621682073811"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-2144"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a name="local-6989586621682073812"><a href="#local-6989586621682073812"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621682073813"><a href="#local-6989586621682073813"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073814"><a href="#local-6989586621682073814"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682073815"><a href="#local-6989586621682073815"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2145"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqProv"><span class="hs-identifier hs-var">seqProv</span></a><span> </span><a href="#local-6989586621682073812"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073813"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><a href="#local-6989586621682073814"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Type.html#seqType"><span class="hs-identifier hs-var">seqType</span></a><span> </span><a href="#local-6989586621682073815"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-2146"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621682073816"><a href="#local-6989586621682073816"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073816"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2147"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-6989586621682073817"><a href="#local-6989586621682073817"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073818"><a href="#local-6989586621682073818"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073817"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073818"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-2148"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><a name="local-6989586621682073819"><a href="#local-6989586621682073819"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073820"><a href="#local-6989586621682073820"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682073821"><a href="#local-6989586621682073821"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073819"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073820"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073821"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2149"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a name="local-6989586621682073822"><a href="#local-6989586621682073822"><span class="hs-identifier">lr</span></a></a><span> </span><a name="local-6989586621682073823"><a href="#local-6989586621682073823"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073822"><span class="hs-identifier hs-var">lr</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073823"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2150"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-6989586621682073824"><a href="#local-6989586621682073824"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073825"><a href="#local-6989586621682073825"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073824"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073825"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-2151"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><a name="local-6989586621682073826"><a href="#local-6989586621682073826"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073826"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2152"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a name="local-6989586621682073827"><a href="#local-6989586621682073827"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073827"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2153"></a><span class="hs-identifier">seqCo</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073828"><a href="#local-6989586621682073828"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCos"><span class="hs-identifier hs-var">seqCos</span></a><span> </span><a href="#local-6989586621682073828"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-2154"></a><span>
</span><a name="line-2155"></a><span class="hs-identifier">seqProv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#UnivCoProvenance"><span class="hs-identifier hs-type">UnivCoProvenance</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2156"></a><a name="seqProv"><a href="Coercion.html#seqProv"><span class="hs-identifier">seqProv</span></a></a><span> </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2157"></a><span class="hs-identifier">seqProv</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-6989586621682073829"><a href="#local-6989586621682073829"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073829"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2158"></a><span class="hs-identifier">seqProv</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a name="local-6989586621682073830"><a href="#local-6989586621682073830"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073830"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2159"></a><span class="hs-identifier">seqProv</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PluginProv"><span class="hs-identifier hs-var">PluginProv</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2160"></a><span>
</span><a name="line-2161"></a><span class="hs-identifier">seqCos</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2162"></a><a name="seqCos"><a href="Coercion.html#seqCos"><span class="hs-identifier">seqCos</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2163"></a><span class="hs-identifier">seqCos</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073831"><a href="#local-6989586621682073831"><span class="hs-identifier">co</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682073832"><a href="#local-6989586621682073832"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#seqCo"><span class="hs-identifier hs-var">seqCo</span></a><span> </span><a href="#local-6989586621682073831"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Coercion.html#seqCos"><span class="hs-identifier hs-var">seqCos</span></a><span> </span><a href="#local-6989586621682073832"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-2164"></a><span>
</span><a name="line-2165"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
             The kind of a type, and of a coercion
%*                                                                      *
%************************************************************************
-}</span><span>
</span><a name="line-2172"></a><span>
</span><a name="line-2173"></a><span class="hs-identifier">coercionType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-2174"></a><a name="coercionType"><a href="Coercion.html#coercionType"><span class="hs-identifier">coercionType</span></a></a><span> </span><a name="local-6989586621682073833"><a href="#local-6989586621682073833"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Coercion.html#coercionKindRole"><span class="hs-identifier hs-var">coercionKindRole</span></a><span> </span><a href="#local-6989586621682073833"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2175"></a><span>  </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073834"><a href="#local-6989586621682073834"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073835"><a href="#local-6989586621682073835"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073836"><a href="#local-6989586621682073836"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#mkCoercionType"><span class="hs-identifier hs-var">mkCoercionType</span></a><span> </span><a href="#local-6989586621682073836"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073834"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073835"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2176"></a><span>
</span><a name="line-2177"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-2178"></a><span class="hs-comment">-- | If it is the case that</span><span>
</span><a name="line-2179"></a><span class="hs-comment">--</span><span>
</span><a name="line-2180"></a><span class="hs-comment">-- &gt; c :: (t1 ~ t2)</span><span>
</span><a name="line-2181"></a><span class="hs-comment">--</span><span>
</span><a name="line-2182"></a><span class="hs-comment">-- i.e. the kind of @c@ relates @t1@ and @t2@, then @coercionKind c = Pair t1 t2@.</span><span>
</span><a name="line-2183"></a><span>
</span><a name="line-2184"></a><span class="hs-identifier">coercionKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-2185"></a><a name="coercionKind"><a href="Coercion.html#coercionKind"><span class="hs-identifier">coercionKind</span></a></a><span> </span><a name="local-6989586621682073837"><a href="#local-6989586621682073837"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2186"></a><span>  </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073837"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2187"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2188"></a><span>    </span><a name="local-6989586621682073838"><a href="#local-6989586621682073838"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-6989586621682073841"><a href="#local-6989586621682073841"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621682073841"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682073841"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2189"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073842"><a href="#local-6989586621682073842"><span class="hs-identifier">ty</span></a></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621682073842"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682073842"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-2190"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073843"><a href="#local-6989586621682073843"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682073844"><a href="#local-6989586621682073844"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621682073843"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span> </span><a href="#local-6989586621682073843"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682073844"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span>
</span><a name="line-2191"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073845"><a href="#local-6989586621682073845"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682073846"><a href="#local-6989586621682073846"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621682073845"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sequenceA</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073846"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-2192"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-6989586621682073847"><a href="#local-6989586621682073847"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073848"><a href="#local-6989586621682073848"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkAppTy"><span class="hs-identifier hs-var">mkAppTy</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073847"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073848"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-2193"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073849"><a href="#local-6989586621682073849"><span class="hs-identifier">co</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073850"><a href="#local-6989586621682073850"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-6989586621682073851"><a href="#local-6989586621682073851"><span class="hs-identifier">k_co</span></a></a><span> </span><a name="local-6989586621682073852"><a href="#local-6989586621682073852"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- works for both tyvar and covar</span><span>
</span><a name="line-2194"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073851"><span class="hs-identifier hs-var">k_co</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyCoInvForAllTy"><span class="hs-identifier hs-var">mkTyCoInvForAllTy</span></a><span> </span><a href="#local-6989586621682073850"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073852"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-2195"></a><span>         </span><span class="hs-comment">-- kind_co always has kind @Type@, thus @isGReflCo@</span><span>
</span><a name="line-2196"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073840"><span class="hs-identifier hs-var">go_forall</span></a><span> </span><a href="#local-6989586621682073853"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621682073849"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2197"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-2198"></a><span>         </span><a name="local-6989586621682073853"><a href="#local-6989586621682073853"><span class="hs-identifier">empty_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-6989586621682073849"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2199"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073854"><a href="#local-6989586621682073854"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073855"><a href="#local-6989586621682073855"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073854"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073855"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-2200"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a name="local-6989586621682073856"><a href="#local-6989586621682073856"><span class="hs-identifier">cv</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarTypes"><span class="hs-identifier hs-var">coVarTypes</span></a><span> </span><a href="#local-6989586621682073856"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-2201"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#HoleCo"><span class="hs-identifier hs-var">HoleCo</span></a><span> </span><a name="local-6989586621682073857"><a href="#local-6989586621682073857"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarTypes"><span class="hs-identifier hs-var">coVarTypes</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#coHoleCoVar"><span class="hs-identifier hs-var">coHoleCoVar</span></a><span> </span><a href="#local-6989586621682073857"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-2202"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a name="local-6989586621682073858"><a href="#local-6989586621682073858"><span class="hs-identifier">ax</span></a></a><span> </span><a name="local-6989586621682073859"><a href="#local-6989586621682073859"><span class="hs-identifier">ind</span></a></a><span> </span><a name="local-6989586621682073860"><a href="#local-6989586621682073860"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2203"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073861"><a href="#local-6989586621682073861"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073862"><a href="#local-6989586621682073862"><span class="hs-identifier">cvs</span></a></a><span>
</span><a name="line-2204"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073863"><a href="#local-6989586621682073863"><span class="hs-identifier">lhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682073864"><a href="#local-6989586621682073864"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoAxiom.html#coAxiomNthBranch"><span class="hs-identifier hs-var">coAxiomNthBranch</span></a><span> </span><a href="#local-6989586621682073858"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682073859"><span class="hs-identifier hs-var">ind</span></a><span>
</span><a name="line-2205"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682073865"><a href="#local-6989586621682073865"><span class="hs-identifier">tycos1</span></a></a><span> </span><a name="local-6989586621682073866"><a href="#local-6989586621682073866"><span class="hs-identifier">tycos2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sequenceA</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073860"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-2206"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682073867"><a href="#local-6989586621682073867"><span class="hs-identifier">tys1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073868"><a href="#local-6989586621682073868"><span class="hs-identifier">cotys1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-6989586621682073861"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073865"><span class="hs-identifier hs-var">tycos1</span></a><span>
</span><a name="line-2207"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682073869"><a href="#local-6989586621682073869"><span class="hs-identifier">tys2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073870"><a href="#local-6989586621682073870"><span class="hs-identifier">cotys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-6989586621682073861"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073866"><span class="hs-identifier hs-var">tycos2</span></a><span>
</span><a name="line-2208"></a><span>            </span><a name="local-6989586621682073871"><a href="#local-6989586621682073871"><span class="hs-identifier">cos1</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Type.html#stripCoercionTy"><span class="hs-identifier hs-var">stripCoercionTy</span></a><span> </span><a href="#local-6989586621682073868"><span class="hs-identifier hs-var">cotys1</span></a><span>
</span><a name="line-2209"></a><span>            </span><a name="local-6989586621682073872"><a href="#local-6989586621682073872"><span class="hs-identifier">cos2</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Type.html#stripCoercionTy"><span class="hs-identifier hs-var">stripCoercionTy</span></a><span> </span><a href="#local-6989586621682073870"><span class="hs-identifier hs-var">cotys2</span></a><span>
</span><a name="line-2210"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">cos</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">equalLength</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="Util.html#equalLength"><span class="hs-operator hs-var">++</span></a><span> </span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2211"></a><span>                  </span><span class="hs-comment">-- Invariant of AxiomInstCo: cos should</span><span>
</span><a name="line-2212"></a><span>                  </span><span class="hs-comment">-- exactly saturate the axiom branch</span><span>
</span><a name="line-2213"></a><span>        </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTyWith"><span class="hs-identifier hs-var">substTyWith</span></a><span> </span><a href="#local-6989586621682073861"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073867"><span class="hs-identifier hs-var">tys1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2214"></a><span>              </span><a href="TyCoRep.html#substTyWithCoVars"><span class="hs-identifier hs-var">substTyWithCoVars</span></a><span> </span><a href="#local-6989586621682073862"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621682073871"><span class="hs-identifier hs-var">cos1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2215"></a><span>              </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a><span> </span><a href="#local-6989586621682073858"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073863"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2216"></a><span>             </span><span class="hs-special">(</span><a href="TyCoRep.html#substTyWith"><span class="hs-identifier hs-var">substTyWith</span></a><span> </span><a href="#local-6989586621682073861"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682073869"><span class="hs-identifier hs-var">tys2</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2217"></a><span>              </span><a href="TyCoRep.html#substTyWithCoVars"><span class="hs-identifier hs-var">substTyWithCoVars</span></a><span> </span><a href="#local-6989586621682073862"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621682073872"><span class="hs-identifier hs-var">cos2</span></a><span> </span><a href="#local-6989586621682073864"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2218"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073873"><a href="#local-6989586621682073873"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073874"><a href="#local-6989586621682073874"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621682073873"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073874"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2219"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621682073875"><a href="#local-6989586621682073875"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Pair.html#swap"><span class="hs-identifier hs-var">swap</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073875"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2220"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-6989586621682073876"><a href="#local-6989586621682073876"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073877"><a href="#local-6989586621682073877"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pFst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073876"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pSnd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073877"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2221"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073878"><a href="#local-6989586621682073878"><span class="hs-identifier">g</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073879"><a href="#local-6989586621682073879"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621682073880"><a href="#local-6989586621682073880"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2222"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073882"><a href="#local-6989586621682073882"><span class="hs-identifier">argss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Type.html#tyConAppArgs_maybe"><span class="hs-identifier hs-var">tyConAppArgs_maybe</span></a><span> </span><a href="#local-6989586621682073881"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2223"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">and</span></a><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier">lengthExceeds</span><span class="hs-special">`</span><span> </span><a href="Util.html#lengthExceeds"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><a href="Util.html#lengthExceeds"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="Util.html#lengthExceeds"><span class="hs-identifier hs-var">argss</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2224"></a><span>        </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="ListSetOps.html#getNth"><span class="hs-identifier hs-var">getNth</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073879"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073882"><span class="hs-identifier hs-var">argss</span></a><span>
</span><a name="line-2225"></a><span>
</span><a name="line-2226"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682073879"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2227"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073883"><a href="#local-6989586621682073883"><span class="hs-identifier">splits</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><a href="Type.html#splitForAllTy_maybe"><span class="hs-identifier hs-var">splitForAllTy_maybe</span></a><span> </span><a href="#local-6989586621682073881"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2228"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073883"><span class="hs-identifier hs-var">splits</span></a><span>
</span><a name="line-2229"></a><span>
</span><a name="line-2230"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2231"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;coercionKind&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073878"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-2232"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2233"></a><span>        </span><a name="local-6989586621682073881"><a href="#local-6989586621682073881"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073880"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2234"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><a name="local-6989586621682073884"><a href="#local-6989586621682073884"><span class="hs-identifier">lr</span></a></a><span> </span><a name="local-6989586621682073885"><a href="#local-6989586621682073885"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#pickLR"><span class="hs-identifier hs-var">pickLR</span></a><span> </span><a href="#local-6989586621682073884"><span class="hs-identifier hs-var">lr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Type.html#splitAppTy"><span class="hs-identifier hs-var">splitAppTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073885"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2235"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-6989586621682073886"><a href="#local-6989586621682073886"><span class="hs-identifier">aco</span></a></a><span> </span><a name="local-6989586621682073887"><a href="#local-6989586621682073887"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073839"><span class="hs-identifier hs-var">go_app</span></a><span> </span><a href="#local-6989586621682073886"><span class="hs-identifier hs-var">aco</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682073887"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">]</span><span>
</span><a name="line-2236"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><a name="local-6989586621682073888"><a href="#local-6989586621682073888"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073888"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2237"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a name="local-6989586621682073889"><a href="#local-6989586621682073889"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073889"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2238"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span> </span><a name="local-6989586621682073890"><a href="#local-6989586621682073890"><span class="hs-identifier">ax</span></a></a><span> </span><a name="local-6989586621682073891"><a href="#local-6989586621682073891"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;coercionKind&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2239"></a><span>                              </span><span class="hs-identifier">coaxrProves</span><span> </span><a href="#local-6989586621682073890"><span class="hs-identifier hs-var">ax</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073891"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-2240"></a><span>
</span><a name="line-2241"></a><span>    </span><span class="hs-identifier">go_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-2242"></a><span>    </span><span class="hs-comment">-- Collect up all the arguments and apply all at once</span><span>
</span><a name="line-2243"></a><span>    </span><span class="hs-comment">-- See Note [Nested InstCos]</span><span>
</span><a name="line-2244"></a><span>    </span><a name="local-6989586621682073839"><a href="#local-6989586621682073839"><span class="hs-identifier">go_app</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-6989586621682073892"><a href="#local-6989586621682073892"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682073893"><a href="#local-6989586621682073893"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073894"><a href="#local-6989586621682073894"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073839"><span class="hs-identifier hs-var">go_app</span></a><span> </span><a href="#local-6989586621682073892"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073893"><span class="hs-identifier hs-var">arg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682073894"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-2245"></a><span>    </span><span class="hs-identifier">go_app</span><span> </span><a name="local-6989586621682073895"><a href="#local-6989586621682073895"><span class="hs-identifier">co</span></a></a><span>              </span><a name="local-6989586621682073896"><a href="#local-6989586621682073896"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#piResultTys"><span class="hs-identifier hs-var">piResultTys</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073895"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">sequenceA</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073896"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-2246"></a><span>
</span><a name="line-2247"></a><span>    </span><a name="local-6989586621682073840"><a href="#local-6989586621682073840"><span class="hs-identifier">go_forall</span></a></a><span> </span><a name="local-6989586621682073897"><a href="#local-6989586621682073897"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073898"><a href="#local-6989586621682073898"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-6989586621682073899"><a href="#local-6989586621682073899"><span class="hs-identifier">k_co</span></a></a><span> </span><a name="local-6989586621682073900"><a href="#local-6989586621682073900"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2248"></a><span>      </span><span class="hs-comment">-- See Note [Nested ForAllCos]</span><span>
</span><a name="line-2249"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682073898"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-2250"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkInvForAllTy"><span class="hs-identifier hs-var">mkInvForAllTy</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621682073898"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682073902"><span class="hs-identifier hs-var">tv2</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621682073840"><span class="hs-identifier hs-var">go_forall</span></a><span> </span><a href="#local-6989586621682073903"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682073900"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2251"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2252"></a><span>        </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073901"><a href="#local-6989586621682073901"><span class="hs-identifier">k2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073899"><span class="hs-identifier hs-var">k_co</span></a><span>
</span><a name="line-2253"></a><span>        </span><a name="local-6989586621682073902"><a href="#local-6989586621682073902"><span class="hs-identifier">tv2</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setTyVarKind"><span class="hs-identifier hs-var">setTyVarKind</span></a><span> </span><a href="#local-6989586621682073898"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621682073897"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073901"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2254"></a><span>        </span><a name="local-6989586621682073903"><a href="#local-6989586621682073903"><span class="hs-identifier">subst'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isGReflCo"><span class="hs-identifier hs-var">isGReflCo</span></a><span> </span><a href="#local-6989586621682073899"><span class="hs-identifier hs-var">k_co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a><span> </span><a href="#local-6989586621682073897"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073898"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-2255"></a><span>                 </span><span class="hs-comment">-- kind_co always has kind @Type@, thus @isGReflCo@</span><span>
</span><a name="line-2256"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a><span> </span><a href="#local-6989586621682073897"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073902"><span class="hs-identifier hs-var">tv2</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682073898"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2257"></a><span>                                  </span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a href="#local-6989586621682073902"><span class="hs-identifier hs-var">tv2</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682073899"><span class="hs-identifier hs-var">k_co</span></a><span>
</span><a name="line-2258"></a><span>    </span><span class="hs-identifier">go_forall</span><span> </span><a name="local-6989586621682073904"><a href="#local-6989586621682073904"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682073905"><a href="#local-6989586621682073905"><span class="hs-identifier">cv1</span></a></a><span> </span><a name="local-6989586621682073906"><a href="#local-6989586621682073906"><span class="hs-identifier">k_co</span></a></a><span> </span><a name="local-6989586621682073907"><a href="#local-6989586621682073907"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2259"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621682073905"><span class="hs-identifier hs-var">cv1</span></a><span>
</span><a name="line-2260"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyCoInvForAllTy"><span class="hs-identifier hs-var">mkTyCoInvForAllTy</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a href="#local-6989586621682073905"><span class="hs-identifier hs-var">cv1</span></a><span> </span><a href="#local-6989586621682073912"><span class="hs-identifier hs-var">cv2</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621682073840"><span class="hs-identifier hs-var">go_forall</span></a><span> </span><a href="#local-6989586621682073914"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621682073907"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2261"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2262"></a><span>        </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073908"><a href="#local-6989586621682073908"><span class="hs-identifier">k2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073906"><span class="hs-identifier hs-var">k_co</span></a><span>
</span><a name="line-2263"></a><span>        </span><a name="local-6989586621682073909"><a href="#local-6989586621682073909"><span class="hs-identifier">r</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a><span> </span><a href="#local-6989586621682073905"><span class="hs-identifier hs-var">cv1</span></a><span>
</span><a name="line-2264"></a><span>        </span><a name="local-6989586621682073910"><a href="#local-6989586621682073910"><span class="hs-identifier">eta1</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-6989586621682073909"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="#local-6989586621682073909"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073906"><span class="hs-identifier hs-var">k_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2265"></a><span>        </span><a name="local-6989586621682073911"><a href="#local-6989586621682073911"><span class="hs-identifier">eta2</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-6989586621682073909"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="#local-6989586621682073909"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073906"><span class="hs-identifier hs-var">k_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2266"></a><span>
</span><a name="line-2267"></a><span>        </span><span class="hs-comment">-- k_co :: (t1 ~r t2) ~N (s1 ~r s2)</span><span>
</span><a name="line-2268"></a><span>        </span><span class="hs-comment">-- k1    = t1 ~r t2</span><span>
</span><a name="line-2269"></a><span>        </span><span class="hs-comment">-- k2    = s1 ~r s2</span><span>
</span><a name="line-2270"></a><span>        </span><span class="hs-comment">-- cv1  :: t1 ~r t2</span><span>
</span><a name="line-2271"></a><span>        </span><span class="hs-comment">-- cv2  :: s1 ~r s2</span><span>
</span><a name="line-2272"></a><span>        </span><span class="hs-comment">-- eta1 :: t1 ~r s1</span><span>
</span><a name="line-2273"></a><span>        </span><span class="hs-comment">-- eta2 :: t2 ~r s2</span><span>
</span><a name="line-2274"></a><span>        </span><span class="hs-comment">-- n_subst  = (eta1 ; cv2 ; sym eta2) :: t1 ~r t2</span><span>
</span><a name="line-2275"></a><span>
</span><a name="line-2276"></a><span>        </span><a name="local-6989586621682073912"><a href="#local-6989586621682073912"><span class="hs-identifier">cv2</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setVarType"><span class="hs-identifier hs-var">setVarType</span></a><span> </span><a href="#local-6989586621682073905"><span class="hs-identifier hs-var">cv1</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621682073904"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073908"><span class="hs-identifier hs-var">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2277"></a><span>        </span><a name="local-6989586621682073913"><a href="#local-6989586621682073913"><span class="hs-identifier">n_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073910"><span class="hs-identifier hs-var">eta1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-6989586621682073912"><span class="hs-identifier hs-var">cv2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682073911"><span class="hs-identifier hs-var">eta2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2278"></a><span>        </span><a name="local-6989586621682073914"><a href="#local-6989586621682073914"><span class="hs-identifier">subst'</span></a></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621682073906"><span class="hs-identifier hs-var">k_co</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a><span> </span><a href="#local-6989586621682073904"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073905"><span class="hs-identifier hs-var">cv1</span></a><span>
</span><a name="line-2279"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a><span> </span><a href="#local-6989586621682073904"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073912"><span class="hs-identifier hs-var">cv2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2280"></a><span>                                                </span><a href="#local-6989586621682073905"><span class="hs-identifier hs-var">cv1</span></a><span> </span><a href="#local-6989586621682073913"><span class="hs-identifier hs-var">n_subst</span></a><span>
</span><a name="line-2281"></a><span>
</span><a name="line-2282"></a><span>    </span><span class="hs-identifier">go_forall</span><span> </span><a name="local-6989586621682073915"><a href="#local-6989586621682073915"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621682073916"><a href="#local-6989586621682073916"><span class="hs-identifier">other_co</span></a></a><span>
</span><a name="line-2283"></a><span>      </span><span class="hs-comment">-- when other_co is not a ForAllCo</span><span>
</span><a name="line-2284"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621682073915"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">`</span><a href="Pair.html#pLiftSnd"><span class="hs-identifier hs-var">pLiftSnd</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073838"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073916"><span class="hs-identifier hs-var">other_co</span></a><span>
</span><a name="line-2285"></a><span>
</span><a name="line-2286"></a><span class="hs-comment">{-

Note [Nested ForAllCos]
~~~~~~~~~~~~~~~~~~~~~~~

Suppose we need `coercionKind (ForAllCo a1 (ForAllCo a2 ... (ForAllCo an
co)...) )`.   We do not want to perform `n` single-type-variable
substitutions over the kind of `co`; rather we want to do one substitution
which substitutes for all of `a1`, `a2` ... simultaneously.  If we do one
at a time we get the performance hole reported in Trac #11735.

Solution: gather up the type variables for nested `ForAllCos`, and
substitute for them all at once.  Remarkably, for Trac #11735 this single
change reduces /total/ compile time by a factor of more than ten.

-}</span><span>
</span><a name="line-2302"></a><span>
</span><a name="line-2303"></a><span class="hs-comment">-- | Apply 'coercionKind' to multiple 'Coercion's</span><span>
</span><a name="line-2304"></a><span class="hs-identifier">coercionKinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-2305"></a><a name="coercionKinds"><a href="Coercion.html#coercionKinds"><span class="hs-identifier">coercionKinds</span></a></a><span> </span><a name="local-6989586621682073917"><a href="#local-6989586621682073917"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sequenceA</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073917"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-2306"></a><span>
</span><a name="line-2307"></a><span class="hs-comment">-- | Get a coercion's kind and role.</span><span>
</span><a name="line-2308"></a><span class="hs-identifier">coercionKindRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Pair.html#Pair"><span class="hs-identifier hs-type">Pair</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">)</span><span>
</span><a name="line-2309"></a><a name="coercionKindRole"><a href="Coercion.html#coercionKindRole"><span class="hs-identifier">coercionKindRole</span></a></a><span> </span><a name="local-6989586621682073918"><a href="#local-6989586621682073918"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682073918"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073918"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2310"></a><span>
</span><a name="line-2311"></a><span class="hs-comment">-- | Retrieve the role from a coercion.</span><span>
</span><a name="line-2312"></a><span class="hs-identifier">coercionRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>
</span><a name="line-2313"></a><a name="coercionRole"><a href="Coercion.html#coercionRole"><span class="hs-identifier">coercionRole</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073919"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-2314"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2315"></a><span>    </span><a name="local-6989586621682073919"><a href="#local-6989586621682073919"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-2316"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><a name="local-6989586621682073920"><a href="#local-6989586621682073920"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073920"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-2317"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><a name="local-6989586621682073921"><a href="#local-6989586621682073921"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073921"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-2318"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-6989586621682073922"><a href="#local-6989586621682073922"><span class="hs-identifier">co1</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073919"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073922"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-2319"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073923"><a href="#local-6989586621682073923"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073919"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073923"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2320"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><a name="local-6989586621682073924"><a href="#local-6989586621682073924"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073924"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-2321"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a name="local-6989586621682073925"><a href="#local-6989586621682073925"><span class="hs-identifier">cv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a><span> </span><a href="#local-6989586621682073925"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-2322"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#HoleCo"><span class="hs-identifier hs-var">HoleCo</span></a><span> </span><a name="local-6989586621682073926"><a href="#local-6989586621682073926"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#coHoleCoVar"><span class="hs-identifier hs-var">coHoleCoVar</span></a><span> </span><a href="#local-6989586621682073926"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-2323"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><a name="local-6989586621682073927"><a href="#local-6989586621682073927"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomRole"><span class="hs-identifier hs-var">coAxiomRole</span></a><span> </span><a href="#local-6989586621682073927"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-2324"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682073928"><a href="#local-6989586621682073928"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073928"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-2325"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621682073929"><a href="#local-6989586621682073929"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073919"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073929"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2326"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-6989586621682073930"><a href="#local-6989586621682073930"><span class="hs-identifier">co1</span></a></a><span> </span><a name="local-6989586621682073931"><a href="#local-6989586621682073931"><span class="hs-identifier">_co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073919"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073930"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-2327"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><a name="local-6989586621682073932"><a href="#local-6989586621682073932"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682073933"><a href="#local-6989586621682073933"><span class="hs-identifier">_d</span></a></a><span> </span><a name="local-6989586621682073934"><a href="#local-6989586621682073934"><span class="hs-identifier">_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073932"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-2328"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-2329"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-6989586621682073935"><a href="#local-6989586621682073935"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073919"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073935"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2330"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-2331"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span>
</span><a name="line-2332"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span> </span><a name="local-6989586621682073936"><a href="#local-6989586621682073936"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">coaxrRole</span><span> </span><a href="#local-6989586621682073936"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-2333"></a><span>
</span><a name="line-2334"></a><span class="hs-comment">{-
Note [Nested InstCos]
~~~~~~~~~~~~~~~~~~~~~
In Trac #5631 we found that 70% of the entire compilation time was
being spent in coercionKind!  The reason was that we had
   (g @ ty1 @ ty2 .. @ ty100)    -- The &quot;@s&quot; are InstCos
where
   g :: forall a1 a2 .. a100. phi
If we deal with the InstCos one at a time, we'll do this:
   1.  Find the kind of (g @ ty1 .. @ ty99) : forall a100. phi'
   2.  Substitute phi'[ ty100/a100 ], a single tyvar-&gt;type subst
But this is a *quadratic* algorithm, and the blew up Trac #5631.
So it's very important to do the substitution simultaneously;
cf Type.piResultTys (which in fact we call here).

-}</span><span>
</span><a name="line-2350"></a><span>
</span><a name="line-2351"></a><span class="hs-comment">-- | Assuming that two types are the same, ignoring coercions, find</span><span>
</span><a name="line-2352"></a><span class="hs-comment">-- a nominal coercion between the types. This is useful when optimizing</span><span>
</span><a name="line-2353"></a><span class="hs-comment">-- transitivity over coercion applications, where splitting two</span><span>
</span><a name="line-2354"></a><span class="hs-comment">-- AppCos might yield different kinds. See Note [EtaAppCo] in OptCoercion.</span><span>
</span><a name="line-2355"></a><span class="hs-identifier">buildCoercion</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>
</span><a name="line-2356"></a><a name="buildCoercion"><a href="Coercion.html#buildCoercion"><span class="hs-identifier">buildCoercion</span></a></a><span> </span><a name="local-6989586621682073937"><a href="#local-6989586621682073937"><span class="hs-identifier">orig_ty1</span></a></a><span> </span><a name="local-6989586621682073938"><a href="#local-6989586621682073938"><span class="hs-identifier">orig_ty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073937"><span class="hs-identifier hs-var">orig_ty1</span></a><span> </span><a href="#local-6989586621682073938"><span class="hs-identifier hs-var">orig_ty2</span></a><span>
</span><a name="line-2357"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2358"></a><span>    </span><a name="local-6989586621682073939"><a href="#local-6989586621682073939"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682073940"><a href="#local-6989586621682073940"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073941"><a href="#local-6989586621682073941"><span class="hs-identifier">ty2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073942"><a href="#local-6989586621682073942"><span class="hs-identifier">ty1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-6989586621682073940"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073942"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682073941"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2359"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682073943"><a href="#local-6989586621682073943"><span class="hs-identifier">ty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-6989586621682073941"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073940"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073943"><span class="hs-identifier hs-var">ty2'</span></a><span>
</span><a name="line-2360"></a><span>
</span><a name="line-2361"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621682073944"><a href="#local-6989586621682073944"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682073945"><a href="#local-6989586621682073945"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073946"><a href="#local-6989586621682073946"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-2362"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073947"><a href="#local-6989586621682073947"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073944"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073946"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2363"></a><span>            </span><a name="local-6989586621682073948"><a href="#local-6989586621682073948"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073947"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-2364"></a><span>        </span><span class="hs-keyword">in</span><span>  </span><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a><span> </span><a href="#local-6989586621682073948"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073944"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073945"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682073947"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-2365"></a><span>
</span><a name="line-2366"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073949"><a href="#local-6989586621682073949"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621682073950"><a href="#local-6989586621682073950"><span class="hs-identifier">ty2</span></a></a><span> </span><a name="local-6989586621682073951"><a href="#local-6989586621682073951"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2367"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682073952"><a href="#local-6989586621682073952"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073949"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073950"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2368"></a><span>            </span><a name="local-6989586621682073953"><a href="#local-6989586621682073953"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionRole"><span class="hs-identifier hs-var">coercionRole</span></a><span> </span><a href="#local-6989586621682073952"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-2369"></a><span>        </span><span class="hs-keyword">in</span><span>  </span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span> </span><a href="#local-6989586621682073953"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682073950"><span class="hs-identifier hs-var">ty2</span></a><span> </span><a href="#local-6989586621682073951"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682073952"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-2370"></a><span>
</span><a name="line-2371"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073954"><a href="#local-6989586621682073954"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-6989586621682073955"><a href="#local-6989586621682073955"><span class="hs-identifier">tv1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073956"><a href="#local-6989586621682073956"><span class="hs-identifier">_tyvarty</span></a></a><span>
</span><a name="line-2372"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">_tyvarty</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2373"></a><span>                  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">TyVarTy</span><span> </span><span class="hs-identifier">tv2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">tv1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">tv2</span><span>
</span><a name="line-2374"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2375"></a><span>        </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-6989586621682073954"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-2376"></a><span>
</span><a name="line-2377"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621682073958"><a href="#local-6989586621682073958"><span class="hs-identifier">arg1</span></a></a><span> </span><a name="local-6989586621682073959"><a href="#local-6989586621682073959"><span class="hs-identifier">res1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621682073960"><a href="#local-6989586621682073960"><span class="hs-identifier">arg2</span></a></a><span> </span><a name="local-6989586621682073961"><a href="#local-6989586621682073961"><span class="hs-identifier">res2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2378"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073958"><span class="hs-identifier hs-var">arg1</span></a><span> </span><a href="#local-6989586621682073960"><span class="hs-identifier hs-var">arg2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073959"><span class="hs-identifier hs-var">res1</span></a><span> </span><a href="#local-6989586621682073961"><span class="hs-identifier hs-var">res2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2379"></a><span>
</span><a name="line-2380"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621682073962"><a href="#local-6989586621682073962"><span class="hs-identifier">tc1</span></a></a><span> </span><a name="local-6989586621682073963"><a href="#local-6989586621682073963"><span class="hs-identifier">args1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621682073964"><a href="#local-6989586621682073964"><span class="hs-identifier">tc2</span></a></a><span> </span><a name="local-6989586621682073965"><a href="#local-6989586621682073965"><span class="hs-identifier">args2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2381"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">tc2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2382"></a><span>        </span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073962"><span class="hs-identifier hs-var">tc1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073963"><span class="hs-identifier hs-var">args1</span></a><span> </span><a href="#local-6989586621682073965"><span class="hs-identifier hs-var">args2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2383"></a><span>
</span><a name="line-2384"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621682073966"><a href="#local-6989586621682073966"><span class="hs-identifier">ty1a</span></a></a><span> </span><a name="local-6989586621682073967"><a href="#local-6989586621682073967"><span class="hs-identifier">ty1b</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073968"><a href="#local-6989586621682073968"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-2385"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073969"><a href="#local-6989586621682073969"><span class="hs-identifier">ty2a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073970"><a href="#local-6989586621682073970"><span class="hs-identifier">ty2b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#repSplitAppTy_maybe"><span class="hs-identifier hs-var">repSplitAppTy_maybe</span></a><span> </span><a href="#local-6989586621682073968"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2386"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073966"><span class="hs-identifier hs-var">ty1a</span></a><span> </span><a href="#local-6989586621682073969"><span class="hs-identifier hs-var">ty2a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073967"><span class="hs-identifier hs-var">ty1b</span></a><span> </span><a href="#local-6989586621682073970"><span class="hs-identifier hs-var">ty2b</span></a><span class="hs-special">)</span><span>
</span><a name="line-2387"></a><span>
</span><a name="line-2388"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682073971"><a href="#local-6989586621682073971"><span class="hs-identifier">ty1</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621682073972"><a href="#local-6989586621682073972"><span class="hs-identifier">ty2a</span></a></a><span> </span><a name="local-6989586621682073973"><a href="#local-6989586621682073973"><span class="hs-identifier">ty2b</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2389"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682073974"><a href="#local-6989586621682073974"><span class="hs-identifier">ty1a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682073975"><a href="#local-6989586621682073975"><span class="hs-identifier">ty1b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#repSplitAppTy_maybe"><span class="hs-identifier hs-var">repSplitAppTy_maybe</span></a><span> </span><a href="#local-6989586621682073971"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-2390"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAppCo"><span class="hs-identifier hs-var">mkAppCo</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073974"><span class="hs-identifier hs-var">ty1a</span></a><span> </span><a href="#local-6989586621682073972"><span class="hs-identifier hs-var">ty2a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073975"><span class="hs-identifier hs-var">ty1b</span></a><span> </span><a href="#local-6989586621682073973"><span class="hs-identifier hs-var">ty2b</span></a><span class="hs-special">)</span><span>
</span><a name="line-2391"></a><span>
</span><a name="line-2392"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a name="local-6989586621682073976"><a href="#local-6989586621682073976"><span class="hs-identifier">tv1</span></a></a><span> </span><a name="local-6989586621682073977"><a href="#local-6989586621682073977"><span class="hs-identifier">_flag1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073978"><a href="#local-6989586621682073978"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a name="local-6989586621682073979"><a href="#local-6989586621682073979"><span class="hs-identifier">tv2</span></a></a><span> </span><a name="local-6989586621682073980"><a href="#local-6989586621682073980"><span class="hs-identifier">_flag2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073981"><a href="#local-6989586621682073981"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2393"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682073976"><span class="hs-identifier hs-var">tv1</span></a><span>
</span><a name="line-2394"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">tv2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2395"></a><span>        </span><a href="Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a><span> </span><a href="#local-6989586621682073976"><span class="hs-identifier hs-var">tv1</span></a><span> </span><a href="#local-6989586621682073982"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073978"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073984"><span class="hs-identifier hs-var">ty2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2396"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682073982"><a href="#local-6989586621682073982"><span class="hs-identifier">kind_co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621682073976"><span class="hs-identifier hs-var">tv1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621682073979"><span class="hs-identifier hs-var">tv2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2397"></a><span>            </span><a name="local-6989586621682073983"><a href="#local-6989586621682073983"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-6989586621682073981"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-6989586621682073982"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-2398"></a><span>            </span><a name="local-6989586621682073984"><a href="#local-6989586621682073984"><span class="hs-identifier">ty2'</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyWithInScope"><span class="hs-identifier hs-var">substTyWithInScope</span></a><span> </span><a href="#local-6989586621682073983"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682073979"><span class="hs-identifier hs-var">tv2</span></a><span class="hs-special">]</span><span>
</span><a name="line-2399"></a><span>                         </span><span class="hs-special">[</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-6989586621682073976"><span class="hs-identifier hs-var">tv1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682073982"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">]</span><span>
</span><a name="line-2400"></a><span>                         </span><a href="#local-6989586621682073981"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2401"></a><span>
</span><a name="line-2402"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a name="local-6989586621682073985"><a href="#local-6989586621682073985"><span class="hs-identifier">cv1</span></a></a><span> </span><a name="local-6989586621682073986"><a href="#local-6989586621682073986"><span class="hs-identifier">_flag1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073987"><a href="#local-6989586621682073987"><span class="hs-identifier">ty1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a name="local-6989586621682073988"><a href="#local-6989586621682073988"><span class="hs-identifier">cv2</span></a></a><span> </span><a name="local-6989586621682073989"><a href="#local-6989586621682073989"><span class="hs-identifier">_flag2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682073990"><a href="#local-6989586621682073990"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2403"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">cv1</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier">cv2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2404"></a><span>        </span><a href="Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a><span> </span><a href="#local-6989586621682073985"><span class="hs-identifier hs-var">cv1</span></a><span> </span><a href="#local-6989586621682073993"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073987"><span class="hs-identifier hs-var">ty1</span></a><span> </span><a href="#local-6989586621682073999"><span class="hs-identifier hs-var">ty2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2405"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682073991"><a href="#local-6989586621682073991"><span class="hs-identifier">s1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073985"><span class="hs-identifier hs-var">cv1</span></a><span>
</span><a name="line-2406"></a><span>            </span><a name="local-6989586621682073992"><a href="#local-6989586621682073992"><span class="hs-identifier">s2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682073988"><span class="hs-identifier hs-var">cv2</span></a><span>
</span><a name="line-2407"></a><span>            </span><a name="local-6989586621682073993"><a href="#local-6989586621682073993"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682073991"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682073992"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-2408"></a><span>
</span><a name="line-2409"></a><span>            </span><span class="hs-comment">-- s1 = t1 ~r t2</span><span>
</span><a name="line-2410"></a><span>            </span><span class="hs-comment">-- s2 = t3 ~r t4</span><span>
</span><a name="line-2411"></a><span>            </span><span class="hs-comment">-- kind_co :: (t1 ~r t2) ~N (t3 ~r t4)</span><span>
</span><a name="line-2412"></a><span>            </span><span class="hs-comment">-- eta1 :: t1 ~r t3</span><span>
</span><a name="line-2413"></a><span>            </span><span class="hs-comment">-- eta2 :: t2 ~r t4</span><span>
</span><a name="line-2414"></a><span>
</span><a name="line-2415"></a><span>            </span><a name="local-6989586621682073994"><a href="#local-6989586621682073994"><span class="hs-identifier">r</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coVarRole"><span class="hs-identifier hs-var">coVarRole</span></a><span> </span><a href="#local-6989586621682073985"><span class="hs-identifier hs-var">cv1</span></a><span>
</span><a name="line-2416"></a><span>            </span><a name="local-6989586621682073995"><a href="#local-6989586621682073995"><span class="hs-identifier">kind_co'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#downgradeRole"><span class="hs-identifier hs-var">downgradeRole</span></a><span> </span><a href="#local-6989586621682073994"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682073993"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-2417"></a><span>            </span><a name="local-6989586621682073996"><a href="#local-6989586621682073996"><span class="hs-identifier">eta1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-6989586621682073994"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621682073995"><span class="hs-identifier hs-var">kind_co'</span></a><span>
</span><a name="line-2418"></a><span>            </span><a name="local-6989586621682073997"><a href="#local-6989586621682073997"><span class="hs-identifier">eta2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="#local-6989586621682073994"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621682073995"><span class="hs-identifier hs-var">kind_co'</span></a><span>
</span><a name="line-2419"></a><span>
</span><a name="line-2420"></a><span>            </span><a name="local-6989586621682073998"><a href="#local-6989586621682073998"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2421"></a><span>                      </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-6989586621682073990"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">tyCoVarsOfCo</span></a><span> </span><a href="#local-6989586621682073993"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-2422"></a><span>            </span><a name="local-6989586621682073999"><a href="#local-6989586621682073999"><span class="hs-identifier">ty2'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><a href="#local-6989586621682073998"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682073988"><span class="hs-identifier hs-var">cv2</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682073996"><span class="hs-identifier hs-var">eta1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span>
</span><a name="line-2423"></a><span>                                                       </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-6989586621682073985"><span class="hs-identifier hs-var">cv1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span>
</span><a name="line-2424"></a><span>                                                       </span><a href="#local-6989586621682073997"><span class="hs-identifier hs-var">eta2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2425"></a><span>                            </span><a href="#local-6989586621682073990"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-2426"></a><span>
</span><a name="line-2427"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682074000"><a href="#local-6989586621682074000"><span class="hs-identifier">ty1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><a name="local-6989586621682074001"><a href="#local-6989586621682074001"><span class="hs-identifier">lit1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682074002"><a href="#local-6989586621682074002"><span class="hs-identifier">_lit2</span></a></a><span>
</span><a name="line-2428"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">_lit2</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2429"></a><span>                  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">LitTy</span><span> </span><span class="hs-identifier">lit2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">lit1</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">lit2</span><span>
</span><a name="line-2430"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">False</span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2431"></a><span>        </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-6989586621682074000"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-2432"></a><span>
</span><a name="line-2433"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621682074004"><a href="#local-6989586621682074004"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621682074005"><a href="#local-6989586621682074005"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2434"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-var">mkProofIrrelCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682074006"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><a href="#local-6989586621682074004"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682074005"><span class="hs-identifier hs-var">co2</span></a><span>
</span><a name="line-2435"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2436"></a><span>        </span><a name="local-6989586621682074006"><a href="#local-6989586621682074006"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682073939"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-6989586621682074004"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-6989586621682074005"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2437"></a><span>
</span><a name="line-2438"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682074007"><a href="#local-6989586621682074007"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682074008"><a href="#local-6989586621682074008"><span class="hs-identifier">ty2</span></a></a><span>
</span><a name="line-2439"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;buildKindCoercion&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073937"><span class="hs-identifier hs-var">orig_ty1</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682073938"><span class="hs-identifier hs-var">orig_ty2</span></a><span>
</span><a name="line-2440"></a><span>                                           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682074007"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682074008"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2441"></a><span>
</span><a name="line-2442"></a><span class="hs-comment">{-
%************************************************************************
%*                                                                      *
       Simplifying types
%*                                                                      *
%************************************************************************

The function below morally belongs in TcFlatten, but it is used also in
FamInstEnv, and so lives here.

Note [simplifyArgsWorker]
~~~~~~~~~~~~~~~~~~~~~~~~~
Invariant (F2) of Note [Flattening] says that flattening is homogeneous.
This causes some trouble when flattening a function applied to a telescope
of arguments, perhaps with dependency. For example, suppose

  type family F :: forall (j :: Type) (k :: Type). Maybe j -&gt; Either j k -&gt; Bool -&gt; [k]

and we wish to flatten the args of (with kind applications explicit)

  F a b (Just a c) (Right a b d) False

where all variables are skolems and

  a :: Type
  b :: Type
  c :: a
  d :: k

  [G] aco :: a ~ fa
  [G] bco :: b ~ fb
  [G] cco :: c ~ fc
  [G] dco :: d ~ fd

The first step is to flatten all the arguments. This is done before calling
simplifyArgsWorker. We start from

  a
  b
  Just a c
  Right a b d
  False

and get

  (fa,                             co1 :: fa ~ a)
  (fb,                             co2 :: fb ~ b)
  (Just fa (fc |&gt; aco) |&gt; co6,     co3 :: (Just fa (fc |&gt; aco) |&gt; co6) ~ (Just a c))
  (Right fa fb (fd |&gt; bco) |&gt; co7, co4 :: (Right fa fb (fd |&gt; bco) |&gt; co7) ~ (Right a b d))
  (False,                          co5 :: False ~ False)

where
  co6 :: Maybe fa ~ Maybe a
  co7 :: Either fa fb ~ Either a b

We now process the flattened args in left-to-right order. The first two args
need no further processing. But now consider the third argument. Let f3 = the flattened
result, Just fa (fc |&gt; aco) |&gt; co6.
This f3 flattened argument has kind (Maybe a), due to
(F2). And yet, when we build the application (F fa fb ...), we need this
argument to have kind (Maybe fa), not (Maybe a). We must cast this argument.
The coercion to use is
determined by the kind of F: we see in F's kind that the third argument has
kind Maybe j. Critically, we also know that the argument corresponding to j
(in our example, a) flattened with a coercion co1. We can thus know the
coercion needed for the 3rd argument is (Maybe (sym co1)), thus building
(f3 |&gt; Maybe (sym co1))

More generally, we must use the Lifting Lemma, as implemented in
Coercion.liftCoSubst. As we work left-to-right, any variable that is a
dependent parameter (j and k, in our example) gets mapped in a lifting context
to the coercion that is output from flattening the corresponding argument (co1
and co2, in our example). Then, after flattening later arguments, we lift the
kind of these arguments in the lifting context that we've be building up.
This coercion is then used to keep the result of flattening well-kinded.

Working through our example, this is what happens:

  1. Extend the (empty) LC with [j |-&gt; co1]. No new casting must be done,
     because the binder associated with the first argument has a closed type (no
     variables).

  2. Extend the LC with [k |-&gt; co2]. No casting to do.

  3. Lifting the kind (Maybe j) with our LC
     yields co8 :: Maybe fa ~ Maybe a. Use (f3 |&gt; sym co8) as the argument to
     F.

  4. Lifting the kind (Either j k) with our LC
     yields co9 :: Either fa fb ~ Either a b. Use (f4 |&gt; sym co9) as the 4th
     argument to F, where f4 is the flattened form of argument 4, written above.

  5. We lift Bool with our LC, getting &lt;Bool&gt;;
     casting has no effect.

We're now almost done, but the new application (F fa fb (f3 |&gt; sym co8) (f4 &gt; sym co9) False)
has the wrong kind. Its kind is [fb], instead of the original [b].
So we must use our LC one last time to lift the result kind [k],
getting res_co :: [fb] ~ [b], and we cast our result.

Accordingly, the final result is

  F fa fb (Just fa (fc |&gt; aco) |&gt; Maybe (sym aco) |&gt; sym (Maybe (sym aco)))
          (Right fa fb (fd |&gt; bco) |&gt; Either (sym aco) (sym bco) |&gt; sym (Either (sym aco) (sym bco)))
          False
            |&gt; [sym bco]

The res_co (in this case, [sym bco])
is returned as the third return value from simplifyArgsWorker.

Note [Last case in simplifyArgsWorker]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In writing simplifyArgsWorker's `go`, we know here that args cannot be empty,
because that case is first. We've run out of
binders. But perhaps inner_ki is a tyvar that has been instantiated with a
&#928;-type.

Here is an example.

  a :: forall (k :: Type). k -&gt; k
  type family Star
  Proxy :: forall j. j -&gt; Type
  axStar :: Star ~ Type
  type family NoWay :: Bool
  axNoWay :: NoWay ~ False
  bo :: Type
  [G] bc :: bo ~ Bool   (in inert set)

  co :: (forall j. j -&gt; Type) ~ (forall (j :: Star). (j |&gt; axStar) -&gt; Star)
  co = forall (j :: sym axStar). (&lt;j&gt; -&gt; sym axStar)

  We are flattening:
  a (forall (j :: Star). (j |&gt; axStar) -&gt; Star)   -- 1
    (Proxy |&gt; co)                                 -- 2
    (bo |&gt; sym axStar)                            -- 3
    (NoWay |&gt; sym bc)                             -- 4
      :: Star

First, we flatten all the arguments (before simplifyArgsWorker), like so:

    (forall j. j -&gt; Type, co1 :: (forall j. j -&gt; Type) ~
                                 (forall (j :: Star). (j |&gt; axStar) -&gt; Star))  -- 1
    (Proxy |&gt; co,         co2 :: (Proxy |&gt; co) ~ (Proxy |&gt; co))                -- 2
    (Bool |&gt; sym axStar,  co3 :: (Bool |&gt; sym axStar) ~ (bo |&gt; sym axStar))    -- 3
    (False |&gt; sym bc,     co4 :: (False |&gt; sym bc) ~ (NoWay |&gt; sym bc))        -- 4

Then we do the process described in Note [simplifyArgsWorker].

1. Lifting Type (the kind of the first arg) gives us a reflexive coercion, so we
   don't use it. But we do build a lifting context [k -&gt; co1] (where co1 is a
   result of flattening an argument, written above).

2. Lifting k gives us co1, so the second argument becomes (Proxy |&gt; co |&gt; sym co1).
   This is not a dependent argument, so we don't extend the lifting context.

Now we need to deal with argument (3). After flattening, should we tack on a homogenizing
coercion? The way we normally tell is to lift the kind of the binder.
But here, the remainder of the kind of `a` that we're left with
after processing two arguments is just `k`.

The way forward is look up k in the lifting context, getting co1. If we're at
all well-typed, co1 will be a coercion between &#928;-types, with at least one binder.
So, let's
decompose co1 with decomposePiCos. This decomposition needs arguments to use
to instantiate any kind parameters. Look at the type of co1. If we just
decomposed it, we would end up with coercions whose types include j, which is
out of scope here. Accordingly, decomposePiCos takes a list of types whose
kinds are the *right-hand* types in the decomposed coercion. (See comments on
decomposePiCos.) Because the flattened types have unflattened kinds (because
flattening is homogeneous), passing the list of flattened types to decomposePiCos
just won't do: later arguments' kinds won't be as expected. So we need to get
the *unflattened* types to pass to decomposePiCos. We can do this easily enough
by taking the kind of the argument coercions, passed in originally.

(Alternative 1: We could re-engineer decomposePiCos to deal with this situation.
But that function is already gnarly, and taking the right-hand types is correct
at its other call sites, which are much more common than this one.)

(Alternative 2: We could avoid calling decomposePiCos entirely, integrating its
behavior into simplifyArgsWorker. This would work, I think, but then all of the
complication of decomposePiCos would end up layered on top of all the complication
here. Please, no.)

(Alternative 3: We could pass the unflattened arguments into simplifyArgsWorker
so that we don't have to recreate them. But that would complicate the interface
of this function to handle a very dark, dark corner case. Better to keep our
demons to ourselves here instead of exposing them to callers. This decision is
easily reversed if there is ever any performance trouble due to the call of
coercionKind.)

So we now call

  decomposePiCos co1
                 (Pair (forall j. j -&gt; Type) (forall (j :: Star). (j |&gt; axStar) -&gt; Star))
                 [bo |&gt; sym axStar, NoWay |&gt; sym bc]

to get

  co5 :: Star ~ Type
  co6 :: (j |&gt; axStar) ~ (j |&gt; co5), substituted to
                              (bo |&gt; sym axStar |&gt; axStar) ~ (bo |&gt; sym axStar |&gt; co5)
                           == bo ~ bo
  res_co :: Type ~ Star

We then use these casts on (the flattened) (3) and (4) to get

  (Bool |&gt; sym axStar |&gt; co5 :: Type)   -- (C3)
  (False |&gt; sym bc |&gt; co6    :: bo)     -- (C4)

We can simplify to

  Bool                        -- (C3)
  (False |&gt; sym bc :: bo)     -- (C4)

Of course, we still must do the processing in Note [simplifyArgsWorker] to finish
the job. We thus want to recur. Our new function kind is the left-hand type of
co1 (gotten, recall, by lifting the variable k that was the return kind of the
original function). Why the left-hand type (as opposed to the right-hand type)?
Because we have casted all the arguments according to decomposePiCos, which gets
us from the right-hand type to the left-hand one. We thus recur with that new
function kind, zapping our lifting context, because we have essentially applied
it.

This recursive call returns ([Bool, False], [...], Refl). The Bool and False
are the correct arguments we wish to return. But we must be careful about the
result coercion: our new, flattened application will have kind Type, but we
want to make sure that the result coercion casts this back to Star. (Why?
Because we started with an application of kind Star, and flattening is homogeneous.)

So, we have to twiddle the result coercion appropriately.

Let's check whether this is well-typed. We know

  a :: forall (k :: Type). k -&gt; k

  a (forall j. j -&gt; Type) :: (forall j. j -&gt; Type) -&gt; forall j. j -&gt; Type

  a (forall j. j -&gt; Type)
    Proxy
      :: forall j. j -&gt; Type

  a (forall j. j -&gt; Type)
    Proxy
    Bool
      :: Bool -&gt; Type

  a (forall j. j -&gt; Type)
    Proxy
    Bool
    False
      :: Type

  a (forall j. j -&gt; Type)
    Proxy
    Bool
    False
     |&gt; res_co
     :: Star

as desired.

Whew.

-}</span><span>
</span><a name="line-2706"></a><span>
</span><a name="line-2707"></a><span>
</span><a name="line-2708"></a><span class="hs-comment">-- This is shared between the flattener and the normaliser in FamInstEnv.</span><span>
</span><a name="line-2709"></a><span class="hs-comment">-- See Note [simplifyArgsWorker]</span><span>
</span><a name="line-2710"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">simplifyArgsWorker</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-2711"></a><span class="hs-identifier">simplifyArgsWorker</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#TyCoBinder"><span class="hs-identifier hs-type">TyCoBinder</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>
</span><a name="line-2712"></a><span>                       </span><span class="hs-comment">-- the binders &amp; result kind (not a &#928;-type) of the function applied to the args</span><span>
</span><a name="line-2713"></a><span>                       </span><span class="hs-comment">-- list of binders can be shorter or longer than the list of args</span><span>
</span><a name="line-2714"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a><span>   </span><span class="hs-comment">-- free vars of the args</span><span>
</span><a name="line-2715"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- list of roles, r</span><span>
</span><a name="line-2716"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- flattened type arguments, arg</span><span>
</span><a name="line-2717"></a><span>                                         </span><span class="hs-comment">-- each comes with the coercion used to flatten it,</span><span>
</span><a name="line-2718"></a><span>                                         </span><span class="hs-comment">-- with co :: flattened_type ~ original_type</span><span>
</span><a name="line-2719"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">)</span><span>
</span><a name="line-2720"></a><span class="hs-comment">-- Returns (xis, cos, res_co), where each co :: xi ~ arg,</span><span>
</span><a name="line-2721"></a><span class="hs-comment">-- and res_co :: kind (f xis) ~ kind (f tys), where f is the function applied to the args</span><span>
</span><a name="line-2722"></a><span class="hs-comment">-- Precondition: if f :: forall bndrs. inner_ki (where bndrs and inner_ki are passed in),</span><span>
</span><a name="line-2723"></a><span class="hs-comment">-- then (f orig_tys) is well kinded. Note that (f flattened_tys) might *not* be well-kinded.</span><span>
</span><a name="line-2724"></a><span class="hs-comment">-- Massaging the flattened_tys in order to make (f flattened_tys) well-kinded is what this</span><span>
</span><a name="line-2725"></a><span class="hs-comment">-- function is all about. That is, (f xis), where xis are the returned arguments, *is*</span><span>
</span><a name="line-2726"></a><span class="hs-comment">-- well kinded.</span><span>
</span><a name="line-2727"></a><a name="simplifyArgsWorker"><a href="Coercion.html#simplifyArgsWorker"><span class="hs-identifier">simplifyArgsWorker</span></a></a><span> </span><a name="local-6989586621682074009"><a href="#local-6989586621682074009"><span class="hs-identifier">orig_ki_binders</span></a></a><span> </span><a name="local-6989586621682074010"><a href="#local-6989586621682074010"><span class="hs-identifier">orig_inner_ki</span></a></a><span> </span><a name="local-6989586621682074011"><a href="#local-6989586621682074011"><span class="hs-identifier">orig_fvs</span></a></a><span>
</span><a name="line-2728"></a><span>                   </span><a name="local-6989586621682074012"><a href="#local-6989586621682074012"><span class="hs-identifier">orig_roles</span></a></a><span> </span><a name="local-6989586621682074013"><a href="#local-6989586621682074013"><span class="hs-identifier">orig_simplified_args</span></a></a><span>
</span><a name="line-2729"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682074015"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682074014"><span class="hs-identifier hs-var">orig_lc</span></a><span> </span><a href="#local-6989586621682074009"><span class="hs-identifier hs-var">orig_ki_binders</span></a><span> </span><a href="#local-6989586621682074010"><span class="hs-identifier hs-var">orig_inner_ki</span></a><span> </span><a href="#local-6989586621682074012"><span class="hs-identifier hs-var">orig_roles</span></a><span> </span><a href="#local-6989586621682074013"><span class="hs-identifier hs-var">orig_simplified_args</span></a><span>
</span><a name="line-2730"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2731"></a><span>    </span><a name="local-6989586621682074014"><a href="#local-6989586621682074014"><span class="hs-identifier">orig_lc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#emptyLiftingContext"><span class="hs-identifier hs-var">emptyLiftingContext</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682074011"><span class="hs-identifier hs-var">orig_fvs</span></a><span>
</span><a name="line-2732"></a><span>
</span><a name="line-2733"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Xis accumulator, in reverse order</span><span>
</span><a name="line-2734"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Coercions accumulator, in reverse order</span><span>
</span><a name="line-2735"></a><span>                      </span><span class="hs-comment">-- These are in 1-to-1 correspondence</span><span>
</span><a name="line-2736"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>  </span><span class="hs-comment">-- mapping from tyvars to flattening coercions</span><span>
</span><a name="line-2737"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#TyCoBinder"><span class="hs-identifier hs-type">TyCoBinder</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Unsubsted binders of function's kind</span><span>
</span><a name="line-2738"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>        </span><span class="hs-comment">-- Unsubsted result kind of function (not a Pi-type)</span><span>
</span><a name="line-2739"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Roles at which to flatten these ...</span><span>
</span><a name="line-2740"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- flattened arguments, with their flattening coercions</span><span>
</span><a name="line-2741"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">)</span><span>
</span><a name="line-2742"></a><span>    </span><a name="local-6989586621682074015"><a href="#local-6989586621682074015"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682074016"><a href="#local-6989586621682074016"><span class="hs-identifier">acc_xis</span></a></a><span> </span><a name="local-6989586621682074017"><a href="#local-6989586621682074017"><span class="hs-identifier">acc_cos</span></a></a><span> </span><a name="local-6989586621682074018"><a href="#local-6989586621682074018"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682074019"><a href="#local-6989586621682074019"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621682074020"><a href="#local-6989586621682074020"><span class="hs-identifier">inner_ki</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2743"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682074016"><span class="hs-identifier hs-var">acc_xis</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682074017"><span class="hs-identifier hs-var">acc_cos</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682074022"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2744"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2745"></a><span>        </span><a name="local-6989586621682074021"><a href="#local-6989586621682074021"><span class="hs-identifier">final_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyCoPiTys"><span class="hs-identifier hs-var">mkTyCoPiTys</span></a><span> </span><a href="#local-6989586621682074019"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621682074020"><span class="hs-identifier hs-var">inner_ki</span></a><span>
</span><a name="line-2746"></a><span>        </span><a name="local-6989586621682074022"><a href="#local-6989586621682074022"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682074018"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682074021"><span class="hs-identifier hs-var">final_kind</span></a><span>
</span><a name="line-2747"></a><span>
</span><a name="line-2748"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682074023"><a href="#local-6989586621682074023"><span class="hs-identifier">acc_xis</span></a></a><span> </span><a name="local-6989586621682074024"><a href="#local-6989586621682074024"><span class="hs-identifier">acc_cos</span></a></a><span> </span><a name="local-6989586621682074025"><a href="#local-6989586621682074025"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682074026"><a href="#local-6989586621682074026"><span class="hs-identifier">binder</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682074027"><a href="#local-6989586621682074027"><span class="hs-identifier">binders</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682074028"><a href="#local-6989586621682074028"><span class="hs-identifier">inner_ki</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-keyword">role</span><span class="hs-glyph">:</span><a name="local-6989586621682074030"><a href="#local-6989586621682074030"><span class="hs-identifier">roles</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682074031"><a href="#local-6989586621682074031"><span class="hs-identifier">xi</span></a></a><span class="hs-special">,</span><a name="local-6989586621682074032"><a href="#local-6989586621682074032"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621682074033"><a href="#local-6989586621682074033"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2749"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- By Note [Flattening] in TcFlatten invariant (F2),</span><span>
</span><a name="line-2750"></a><span>         </span><span class="hs-comment">-- tcTypeKind(xi) = tcTypeKind(ty). But, it's possible that xi will be</span><span>
</span><a name="line-2751"></a><span>         </span><span class="hs-comment">-- used as an argument to a function whose kind is different, if</span><span>
</span><a name="line-2752"></a><span>         </span><span class="hs-comment">-- earlier arguments have been flattened to new types. We thus</span><span>
</span><a name="line-2753"></a><span>         </span><span class="hs-comment">-- need a coercion (kind_co :: old_kind ~ new_kind).</span><span>
</span><a name="line-2754"></a><span>         </span><span class="hs-comment">--</span><span>
</span><a name="line-2755"></a><span>         </span><span class="hs-comment">-- The bangs here have been observed to improve performance</span><span>
</span><a name="line-2756"></a><span>         </span><span class="hs-comment">-- significantly in optimized builds.</span><span>
</span><a name="line-2757"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682074034"><a href="#local-6989586621682074034"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2758"></a><span>               </span><a href="Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682074025"><span class="hs-identifier hs-var">lc</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#tyCoBinderType"><span class="hs-identifier hs-var">tyCoBinderType</span></a><span> </span><a href="#local-6989586621682074026"><span class="hs-identifier hs-var">binder</span></a><span class="hs-special">)</span><span>
</span><a name="line-2759"></a><span>             </span><span class="hs-glyph">!</span><a name="local-6989586621682074035"><a href="#local-6989586621682074035"><span class="hs-identifier">casted_xi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682074031"><span class="hs-identifier hs-var">xi</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682074034"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-2760"></a><span>             </span><a name="local-6989586621682074036"><a href="#local-6989586621682074036"><span class="hs-identifier">casted_co</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682074031"><span class="hs-identifier hs-var">xi</span></a><span> </span><a href="#local-6989586621682074034"><span class="hs-identifier hs-var">kind_co</span></a><span> </span><a href="#local-6989586621682074032"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2761"></a><span>
</span><a name="line-2762"></a><span>         </span><span class="hs-comment">-- now, extend the lifting context with the new binding</span><span>
</span><a name="line-2763"></a><span>             </span><span class="hs-glyph">!</span><a name="local-6989586621682074037"><a href="#local-6989586621682074037"><span class="hs-identifier">new_lc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682074038"><a href="#local-6989586621682074038"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#tyCoBinderVar_maybe"><span class="hs-identifier hs-var">tyCoBinderVar_maybe</span></a><span> </span><a href="#local-6989586621682074026"><span class="hs-identifier hs-var">binder</span></a><span>
</span><a name="line-2764"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#extendLiftingContextAndInScope"><span class="hs-identifier hs-var">extendLiftingContextAndInScope</span></a><span> </span><a href="#local-6989586621682074025"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682074038"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682074036"><span class="hs-identifier hs-var">casted_co</span></a><span>
</span><a name="line-2765"></a><span>                     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-2766"></a><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682074025"><span class="hs-identifier hs-var">lc</span></a><span>
</span><a name="line-2767"></a><span>         </span><span class="hs-keyword">in</span><span>
</span><a name="line-2768"></a><span>         </span><a href="#local-6989586621682074015"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682074035"><span class="hs-identifier hs-var">casted_xi</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682074023"><span class="hs-identifier hs-var">acc_xis</span></a><span class="hs-special">)</span><span>
</span><a name="line-2769"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621682074036"><span class="hs-identifier hs-var">casted_co</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682074024"><span class="hs-identifier hs-var">acc_cos</span></a><span class="hs-special">)</span><span>
</span><a name="line-2770"></a><span>            </span><a href="#local-6989586621682074037"><span class="hs-identifier hs-var">new_lc</span></a><span>
</span><a name="line-2771"></a><span>            </span><a href="#local-6989586621682074027"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-2772"></a><span>            </span><a href="#local-6989586621682074028"><span class="hs-identifier hs-var">inner_ki</span></a><span>
</span><a name="line-2773"></a><span>            </span><a href="#local-6989586621682074030"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-2774"></a><span>            </span><a href="#local-6989586621682074033"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2775"></a><span>
</span><a name="line-2776"></a><span>
</span><a name="line-2777"></a><span>      </span><span class="hs-comment">-- See Note [Last case in simplifyArgsWorker]</span><span>
</span><a name="line-2778"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682074039"><a href="#local-6989586621682074039"><span class="hs-identifier">acc_xis</span></a></a><span> </span><a name="local-6989586621682074040"><a href="#local-6989586621682074040"><span class="hs-identifier">acc_cos</span></a></a><span> </span><a name="local-6989586621682074041"><a href="#local-6989586621682074041"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682074042"><a href="#local-6989586621682074042"><span class="hs-identifier">inner_ki</span></a></a><span> </span><a name="local-6989586621682074043"><a href="#local-6989586621682074043"><span class="hs-identifier">roles</span></a></a><span> </span><a name="local-6989586621682074044"><a href="#local-6989586621682074044"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-2779"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682074045"><a href="#local-6989586621682074045"><span class="hs-identifier">k</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a><span> </span><a href="#local-6989586621682074042"><span class="hs-identifier hs-var">inner_ki</span></a><span>
</span><a name="line-2780"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682074046"><a href="#local-6989586621682074046"><span class="hs-identifier">co1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#liftCoSubstTyVar"><span class="hs-identifier hs-var">liftCoSubstTyVar</span></a><span> </span><a href="#local-6989586621682074041"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682074045"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-2781"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682074047"><a href="#local-6989586621682074047"><span class="hs-identifier">co1_kind</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682074046"><span class="hs-identifier hs-var">co1</span></a><span>
</span><a name="line-2782"></a><span>            </span><a name="local-6989586621682074048"><a href="#local-6989586621682074048"><span class="hs-identifier">unflattened_tys</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pSnd</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682074044"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-2783"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682074049"><a href="#local-6989586621682074049"><span class="hs-identifier">arg_cos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682074050"><a href="#local-6989586621682074050"><span class="hs-identifier">res_co</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#decomposePiCos"><span class="hs-identifier hs-var">decomposePiCos</span></a><span> </span><a href="#local-6989586621682074046"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682074047"><span class="hs-identifier hs-var">co1_kind</span></a><span> </span><a href="#local-6989586621682074048"><span class="hs-identifier hs-var">unflattened_tys</span></a><span>
</span><a name="line-2784"></a><span>            </span><a name="local-6989586621682074051"><a href="#local-6989586621682074051"><span class="hs-identifier">casted_args</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">args</span><span> </span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">arg_cos</span></a><span>
</span><a name="line-2785"></a><span>                                           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">arg_cos</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2786"></a><span>                                    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682074063"><span class="hs-identifier hs-var">casted_xi</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682074064"><span class="hs-identifier hs-var">casted_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2787"></a><span>                                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682074059"><a href="#local-6989586621682074059"><span class="hs-identifier">xi</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682074060"><a href="#local-6989586621682074060"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682074061"><a href="#local-6989586621682074061"><span class="hs-identifier">arg_co</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">role</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zip3</span><span> </span><a href="#local-6989586621682074044"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621682074049"><span class="hs-identifier hs-var">arg_cos</span></a><span> </span><a href="#local-6989586621682074043"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-2788"></a><span>                                    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682074063"><a href="#local-6989586621682074063"><span class="hs-identifier">casted_xi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682074059"><span class="hs-identifier hs-var">xi</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682074061"><span class="hs-identifier hs-var">arg_co</span></a><span>
</span><a name="line-2789"></a><span>                                          </span><a name="local-6989586621682074064"><a href="#local-6989586621682074064"><span class="hs-identifier">casted_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkCoherenceLeftCo"><span class="hs-identifier hs-var">mkCoherenceLeftCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682074059"><span class="hs-identifier hs-var">xi</span></a><span> </span><a href="#local-6989586621682074061"><span class="hs-identifier hs-var">arg_co</span></a><span> </span><a href="#local-6989586621682074060"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2790"></a><span>               </span><span class="hs-comment">-- In general decomposePiCos can return fewer cos than tys,</span><span>
</span><a name="line-2791"></a><span>               </span><span class="hs-comment">-- but not here; because we're well typed, there will be enough</span><span>
</span><a name="line-2792"></a><span>               </span><span class="hs-comment">-- binders. Note that decomposePiCos does substitutions, so even</span><span>
</span><a name="line-2793"></a><span>               </span><span class="hs-comment">-- if the original substitution results in something ending with</span><span>
</span><a name="line-2794"></a><span>               </span><span class="hs-comment">-- ... -&gt; k, that k will be substituted to perhaps reveal more</span><span>
</span><a name="line-2795"></a><span>               </span><span class="hs-comment">-- binders.</span><span>
</span><a name="line-2796"></a><span>            </span><a name="local-6989586621682074052"><a href="#local-6989586621682074052"><span class="hs-identifier">zapped_lc</span></a></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#zapLiftingContext"><span class="hs-identifier hs-var">zapLiftingContext</span></a><span> </span><a href="#local-6989586621682074041"><span class="hs-identifier hs-var">lc</span></a><span>
</span><a name="line-2797"></a><span>            </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621682074053"><a href="#local-6989586621682074053"><span class="hs-identifier">flattened_kind</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682074047"><span class="hs-identifier hs-var">co1_kind</span></a><span>
</span><a name="line-2798"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682074054"><a href="#local-6989586621682074054"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682074055"><a href="#local-6989586621682074055"><span class="hs-identifier">new_inner</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#splitPiTys"><span class="hs-identifier hs-var">splitPiTys</span></a><span> </span><a href="#local-6989586621682074053"><span class="hs-identifier hs-var">flattened_kind</span></a><span>
</span><a name="line-2799"></a><span>
</span><a name="line-2800"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682074056"><a href="#local-6989586621682074056"><span class="hs-identifier">xis_out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682074057"><a href="#local-6989586621682074057"><span class="hs-identifier">cos_out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682074058"><a href="#local-6989586621682074058"><span class="hs-identifier">res_co_out</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2801"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682074015"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682074039"><span class="hs-identifier hs-var">acc_xis</span></a><span> </span><a href="#local-6989586621682074040"><span class="hs-identifier hs-var">acc_cos</span></a><span> </span><a href="#local-6989586621682074052"><span class="hs-identifier hs-var">zapped_lc</span></a><span> </span><a href="#local-6989586621682074054"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621682074055"><span class="hs-identifier hs-var">new_inner</span></a><span> </span><a href="#local-6989586621682074043"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-6989586621682074051"><span class="hs-identifier hs-var">casted_args</span></a><span>
</span><a name="line-2802"></a><span>        </span><span class="hs-keyword">in</span><span>
</span><a name="line-2803"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621682074056"><span class="hs-identifier hs-var">xis_out</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682074057"><span class="hs-identifier hs-var">cos_out</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682074058"><span class="hs-identifier hs-var">res_co_out</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682074050"><span class="hs-identifier hs-var">res_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-2804"></a><span>
</span><a name="line-2805"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span>
</span><a name="line-2806"></a><span>        </span><span class="hs-string">&quot;simplifyArgsWorker wandered into deeper water than usual&quot;</span><span>
</span><a name="line-2807"></a><span>           </span><span class="hs-comment">-- This debug information is commented out because leaving it in</span><span>
</span><a name="line-2808"></a><span>           </span><span class="hs-comment">-- causes a ~2% increase in allocations in T9872d.</span><span>
</span><a name="line-2809"></a><span>           </span><span class="hs-comment">-- That's independent of the analagous case in flatten_args_fast</span><span>
</span><a name="line-2810"></a><span>           </span><span class="hs-comment">-- in TcFlatten:</span><span>
</span><a name="line-2811"></a><span>           </span><span class="hs-comment">-- each of these causes a 2% increase on its own, so commenting them</span><span>
</span><a name="line-2812"></a><span>           </span><span class="hs-comment">-- both out gives a 4% decrease in T9872d.</span><span>
</span><a name="line-2813"></a><span>           </span><span class="hs-comment">{-

             (vcat [ppr orig_binders,
                    ppr orig_inner_ki,
                    ppr (take 10 orig_roles), -- often infinite!
                    ppr orig_tys])
           -}</span><span>
</span><a name="line-2820"></a></pre></body></html>