<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- (c) The University of Glasgow 2006</span><span>
</span><a name="line-2"></a><span class="hs-comment">--</span><span>
</span><a name="line-3"></a><span class="hs-comment">-- FamInstEnv: Type checked family instance declarations</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE CPP, GADTs, ScopedTypeVariables, BangPatterns, TupleSections #-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FamInstEnv</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-8"></a><span>        </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#FamFlavor"><span class="hs-identifier hs-type">FamFlavor</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var">famInstAxiom</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#famInstTyCon"><span class="hs-identifier hs-var">famInstTyCon</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#famInstRHS"><span class="hs-identifier hs-var">famInstRHS</span></a><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>        </span><a href="FamInstEnv.html#famInstsRepTyCons"><span class="hs-identifier hs-var">famInstsRepTyCons</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#famInstRepTyCon_maybe"><span class="hs-identifier hs-var">famInstRepTyCon_maybe</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#dataFamInstRepTyCon"><span class="hs-identifier hs-var">dataFamInstRepTyCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>        </span><a href="FamInstEnv.html#pprFamInst"><span class="hs-identifier hs-var">pprFamInst</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#pprFamInsts"><span class="hs-identifier hs-var">pprFamInsts</span></a><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>        </span><a href="FamInstEnv.html#mkImportedFamInst"><span class="hs-identifier hs-var">mkImportedFamInst</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>        </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#emptyFamInstEnvs"><span class="hs-identifier hs-var">emptyFamInstEnvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="FamInstEnv.html#extendFamInstEnv"><span class="hs-identifier hs-var">extendFamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#extendFamInstEnvList"><span class="hs-identifier hs-var">extendFamInstEnvList</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="FamInstEnv.html#famInstEnvElts"><span class="hs-identifier hs-var">famInstEnvElts</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#famInstEnvSize"><span class="hs-identifier hs-var">famInstEnvSize</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#familyInstances"><span class="hs-identifier hs-var">familyInstances</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>        </span><span class="hs-comment">-- * CoAxioms</span><span>
</span><a name="line-18"></a><span>        </span><a href="FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier hs-var">mkCoAxBranch</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#mkBranchedCoAxiom"><span class="hs-identifier hs-var">mkBranchedCoAxiom</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#mkUnbranchedCoAxiom"><span class="hs-identifier hs-var">mkUnbranchedCoAxiom</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#mkSingleCoAxiom"><span class="hs-identifier hs-var">mkSingleCoAxiom</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="FamInstEnv.html#mkNewTypeCoAxiom"><span class="hs-identifier hs-var">mkNewTypeCoAxiom</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span>        </span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier hs-var">lookupFamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#lookupFamInstEnvConflicts"><span class="hs-identifier hs-var">lookupFamInstEnvConflicts</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier hs-var">lookupFamInstEnvByTyCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span>        </span><a href="FamInstEnv.html#isDominatedBy"><span class="hs-identifier hs-var">isDominatedBy</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#apartnessCheck"><span class="hs-identifier hs-var">apartnessCheck</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span>        </span><span class="hs-comment">-- Injectivity</span><span>
</span><a name="line-27"></a><span>        </span><a href="FamInstEnv.html#InjectivityCheckResult"><span class="hs-identifier hs-type">InjectivityCheckResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="FamInstEnv.html#lookupFamInstEnvInjectivityConflicts"><span class="hs-identifier hs-var">lookupFamInstEnvInjectivityConflicts</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#injectiveBranches"><span class="hs-identifier hs-var">injectiveBranches</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>        </span><span class="hs-comment">-- Normalisation</span><span>
</span><a name="line-31"></a><span>        </span><a href="FamInstEnv.html#topNormaliseType"><span class="hs-identifier hs-var">topNormaliseType</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier hs-var">topNormaliseType_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="FamInstEnv.html#normaliseType"><span class="hs-identifier hs-var">normaliseType</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#normaliseTcApp"><span class="hs-identifier hs-var">normaliseTcApp</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#normaliseTcArgs"><span class="hs-identifier hs-var">normaliseTcArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier hs-var">reduceTyFamApp_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>        </span><span class="hs-comment">-- Flattening</span><span>
</span><a name="line-36"></a><span>        </span><a href="FamInstEnv.html#flattenTys"><span class="hs-identifier hs-var">flattenTys</span></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Unify.html"><span class="hs-identifier">Unify</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="TyCoRep.html"><span class="hs-identifier">TyCoRep</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="PrelNames.html#eqPrimTyConKey"><span class="hs-identifier hs-var">eqPrimTyConKey</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="UniqDFM.html"><span class="hs-identifier">UniqDFM</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="CoreMap.html"><span class="hs-identifier">CoreMap</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Array</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Array</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">assocs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
          Type checked family instance heads
*                                                                      *
************************************************************************

Note [FamInsts and CoAxioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
* CoAxioms and FamInsts are just like
  DFunIds  and ClsInsts

* A CoAxiom is a System-FC thing: it can relate any two types

* A FamInst is a Haskell source-language thing, corresponding
  to a type/data family instance declaration.
    - The FamInst contains a CoAxiom, which is the evidence
      for the instance

    - The LHS of the CoAxiom is always of form F ty1 .. tyn
      where F is a type family
-}</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-keyword">data</span><span> </span><a name="FamInst"><a href="FamInstEnv.html#FamInst"><span class="hs-identifier">FamInst</span></a></a><span>  </span><span class="hs-comment">-- See Note [FamInsts and CoAxioms]</span><span>
</span><a name="line-91"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="FamInst"><a href="FamInstEnv.html#FamInst"><span class="hs-identifier">FamInst</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="fi_axiom"><a href="FamInstEnv.html#fi_axiom"><span class="hs-identifier">fi_axiom</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span> </span><span class="hs-comment">-- The new coercion axiom</span><span>
</span><a name="line-92"></a><span>                                              </span><span class="hs-comment">-- introduced by this family</span><span>
</span><a name="line-93"></a><span>                                              </span><span class="hs-comment">-- instance</span><span>
</span><a name="line-94"></a><span>                 </span><span class="hs-comment">-- INVARIANT: apart from freshening (see below)</span><span>
</span><a name="line-95"></a><span>                 </span><span class="hs-comment">--    fi_tvs = cab_tvs of the (single) axiom branch</span><span>
</span><a name="line-96"></a><span>                 </span><span class="hs-comment">--    fi_cvs = cab_cvs ...ditto...</span><span>
</span><a name="line-97"></a><span>                 </span><span class="hs-comment">--    fi_tys = cab_lhs ...ditto...</span><span>
</span><a name="line-98"></a><span>                 </span><span class="hs-comment">--    fi_rhs = cab_rhs ...ditto...</span><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="fi_flavor"><a href="FamInstEnv.html#fi_flavor"><span class="hs-identifier">fi_flavor</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamFlavor"><span class="hs-identifier hs-type">FamFlavor</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>            </span><span class="hs-comment">-- Everything below here is a redundant,</span><span>
</span><a name="line-103"></a><span>            </span><span class="hs-comment">-- cached version of the two things above</span><span>
</span><a name="line-104"></a><span>            </span><span class="hs-comment">-- except that the TyVars are freshened</span><span>
</span><a name="line-105"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="fi_fam"><a href="FamInstEnv.html#fi_fam"><span class="hs-identifier">fi_fam</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>          </span><span class="hs-comment">-- Family name</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span>                </span><span class="hs-comment">-- Used for &quot;rough matching&quot;; same idea as for class instances</span><span>
</span><a name="line-108"></a><span>                </span><span class="hs-comment">-- See Note [Rough-match field] in InstEnv</span><span>
</span><a name="line-109"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="fi_tcs"><a href="FamInstEnv.html#fi_tcs"><span class="hs-identifier">fi_tcs</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Top of type args</span><span>
</span><a name="line-110"></a><span>                </span><span class="hs-comment">-- INVARIANT: fi_tcs = roughMatchTcs fi_tys</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span>            </span><span class="hs-comment">-- Used for &quot;proper matching&quot;; ditto</span><span>
</span><a name="line-113"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="fi_tvs"><a href="FamInstEnv.html#fi_tvs"><span class="hs-identifier">fi_tvs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Template tyvars for full match</span><span>
</span><a name="line-114"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="fi_cvs"><a href="FamInstEnv.html#fi_cvs"><span class="hs-identifier">fi_cvs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Template covars for full match</span><span>
</span><a name="line-115"></a><span>                 </span><span class="hs-comment">-- Like ClsInsts, these variables are always fresh</span><span>
</span><a name="line-116"></a><span>                 </span><span class="hs-comment">-- See Note [Template tyvars are fresh] in InstEnv</span><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="fi_tys"><a href="FamInstEnv.html#fi_tys"><span class="hs-identifier">fi_tys</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">--   The LHS type patterns</span><span>
</span><a name="line-119"></a><span>            </span><span class="hs-comment">-- May be eta-reduced; see Note [Eta reduction for data families]</span><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span>            </span><span class="hs-special">,</span><span> </span><a name="fi_rhs"><a href="FamInstEnv.html#fi_rhs"><span class="hs-identifier">fi_rhs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>         </span><span class="hs-comment">--   the RHS, with its freshened vars</span><span>
</span><a name="line-122"></a><span>            </span><span class="hs-special">}</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-keyword">data</span><span> </span><a name="FamFlavor"><a href="FamInstEnv.html#FamFlavor"><span class="hs-identifier">FamFlavor</span></a></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="SynFamilyInst"><a href="FamInstEnv.html#SynFamilyInst"><span class="hs-identifier">SynFamilyInst</span></a></a><span>         </span><span class="hs-comment">-- A synonym family</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DataFamilyInst"><a href="FamInstEnv.html#DataFamilyInst"><span class="hs-identifier">DataFamilyInst</span></a></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>  </span><span class="hs-comment">-- A data family, with its representation TyCon</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-comment">{-
Note [Arity of data families]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Data family instances might legitimately be over- or under-saturated.

Under-saturation has two potential causes:
 U1) Eta reduction. See Note [Eta reduction for data families].
 U2) When the user has specified a return kind instead of written out patterns.
     Example:

       data family Sing (a :: k)
       data instance Sing :: Bool -&gt; Type

     The data family tycon Sing has an arity of 2, the k and the a. But
     the data instance has only one pattern, Bool (standing in for k).
     This instance is equivalent to `data instance Sing (a :: Bool)`, but
     without the last pattern, we have an under-saturated data family instance.
     On its own, this example is not compelling enough to add support for
     under-saturation, but U1 makes this feature more compelling.

Over-saturation is also possible:
  O1) If the data family's return kind is a type variable (see also #12369),
      an instance might legitimately have more arguments than the family.
      Example:

        data family Fix :: (Type -&gt; k) -&gt; k
        data instance Fix f = MkFix1 (f (Fix f))
        data instance Fix f x = MkFix2 (f (Fix f x) x)

      In the first instance here, the k in the data family kind is chosen to
      be Type. In the second, it's (Type -&gt; Type).

      However, we require that any over-saturation is eta-reducible. That is,
      we require that any extra patterns be bare unrepeated type variables;
      see Note [Eta reduction for data families]. Accordingly, the FamInst
      is never over-saturated.

Why can we allow such flexibility for data families but not for type families?
Because data families can be decomposed -- that is, they are generative and
injective. A Type family is neither and so always must be applied to all its
arguments.
-}</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-comment">-- Obtain the axiom of a family instance</span><span>
</span><a name="line-172"></a><span class="hs-identifier">famInstAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span>
</span><a name="line-173"></a><a name="famInstAxiom"><a href="FamInstEnv.html#famInstAxiom"><span class="hs-identifier">famInstAxiom</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fi_axiom</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-comment">-- Split the left-hand side of the FamInst</span><span>
</span><a name="line-176"></a><span class="hs-identifier">famInstSplitLHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><a name="famInstSplitLHS"><a href="FamInstEnv.html#famInstSplitLHS"><span class="hs-identifier">famInstSplitLHS</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873200"><a href="#local-6989586621682873200"><span class="hs-identifier">axiom</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873201"><a href="#local-6989586621682873201"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a><span> </span><a href="#local-6989586621682873200"><span class="hs-identifier hs-var">axiom</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873201"><span class="hs-identifier hs-var">lhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">-- Get the RHS of the FamInst</span><span>
</span><a name="line-181"></a><span class="hs-identifier">famInstRHS</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-182"></a><a name="famInstRHS"><a href="FamInstEnv.html#famInstRHS"><span class="hs-identifier">famInstRHS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fi_rhs</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-comment">-- Get the family TyCon of the FamInst</span><span>
</span><a name="line-185"></a><span class="hs-identifier">famInstTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-186"></a><a name="famInstTyCon"><a href="FamInstEnv.html#famInstTyCon"><span class="hs-identifier">famInstTyCon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="FamInstEnv.html#famInstAxiom"><span class="hs-identifier hs-var">famInstAxiom</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">-- Return the representation TyCons introduced by data family instances, if any</span><span>
</span><a name="line-189"></a><span class="hs-identifier">famInstsRepTyCons</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-190"></a><a name="famInstsRepTyCons"><a href="FamInstEnv.html#famInstsRepTyCons"><span class="hs-identifier">famInstsRepTyCons</span></a></a><span> </span><a name="local-6989586621682873202"><a href="#local-6989586621682873202"><span class="hs-identifier">fis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682873203"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_flavor</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-var">DataFamilyInst</span></a><span> </span><a name="local-6989586621682873203"><a href="#local-6989586621682873203"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873202"><span class="hs-identifier hs-var">fis</span></a><span class="hs-special">]</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- Extracts the TyCon for this *data* (or newtype) instance</span><span>
</span><a name="line-193"></a><span class="hs-identifier">famInstRepTyCon_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-194"></a><a name="famInstRepTyCon_maybe"><a href="FamInstEnv.html#famInstRepTyCon_maybe"><span class="hs-identifier">famInstRepTyCon_maybe</span></a></a><span> </span><a name="local-6989586621682873204"><a href="#local-6989586621682873204"><span class="hs-identifier">fi</span></a></a><span>
</span><a name="line-195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">fi_flavor</span><span> </span><a href="#local-6989586621682873204"><span class="hs-identifier hs-var">fi</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-196"></a><span>       </span><a href="FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-var">DataFamilyInst</span></a><span> </span><a name="local-6989586621682873205"><a href="#local-6989586621682873205"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682873205"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-197"></a><span>       </span><a href="FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-identifier">dataFamInstRepTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-200"></a><a name="dataFamInstRepTyCon"><a href="FamInstEnv.html#dataFamInstRepTyCon"><span class="hs-identifier">dataFamInstRepTyCon</span></a></a><span> </span><a name="local-6989586621682873206"><a href="#local-6989586621682873206"><span class="hs-identifier">fi</span></a></a><span>
</span><a name="line-201"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">fi_flavor</span><span> </span><a href="#local-6989586621682873206"><span class="hs-identifier hs-var">fi</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-202"></a><span>       </span><a href="FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-var">DataFamilyInst</span></a><span> </span><a name="local-6989586621682873207"><a href="#local-6989586621682873207"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873207"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-203"></a><span>       </span><a href="FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;dataFamInstRepTyCon&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873206"><span class="hs-identifier hs-var">fi</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Pretty printing
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span class="hs-keyword">instance</span><span> </span><a href="Name.html#NamedThing"><span class="hs-identifier hs-type">NamedThing</span></a><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-214"></a><span>   </span><a name="local-8214565720325933137"><a href="Name.html#getName"><span class="hs-identifier">getName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomName"><span class="hs-identifier hs-var">coAxiomName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">fi_axiom</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-217"></a><span>   </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#pprFamInst"><span class="hs-identifier hs-var">pprFamInst</span></a><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-identifier">pprFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-220"></a><span class="hs-comment">-- Prints the FamInst as a family instance declaration</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- NB: This function, FamInstEnv.pprFamInst, is used only for internal,</span><span>
</span><a name="line-222"></a><span class="hs-comment">--     debug printing. See PprTyThing.pprFamInst for printing for the user</span><span>
</span><a name="line-223"></a><a name="pprFamInst"><a href="FamInstEnv.html#pprFamInst"><span class="hs-identifier">pprFamInst</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_flavor</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873208"><a href="#local-6989586621682873208"><span class="hs-identifier">flavor</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873209"><a href="#local-6989586621682873209"><span class="hs-identifier">ax</span></a></a><span>
</span><a name="line-224"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873210"><a href="#local-6989586621682873210"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873211"><a href="#local-6989586621682873211"><span class="hs-identifier">tys</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873212"><a href="#local-6989586621682873212"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873213"><span class="hs-identifier hs-var">ppr_tc_sort</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;instance&quot;</span><span>
</span><a name="line-226"></a><span>             </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Coercion.html#pprCoAxBranchUser"><span class="hs-identifier hs-var">pprCoAxBranchUser</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomTyCon"><span class="hs-identifier hs-var">coAxiomTyCon</span></a><span> </span><a href="#local-6989586621682873209"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><a href="#local-6989586621682873209"><span class="hs-identifier hs-var">ax</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#whenPprDebug"><span class="hs-identifier hs-var">whenPprDebug</span></a><span> </span><a href="#local-6989586621682873214"><span class="hs-identifier hs-var">debug_stuff</span></a><span class="hs-special">)</span><span>
</span><a name="line-228"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-229"></a><span>    </span><a name="local-6989586621682873213"><a href="#local-6989586621682873213"><span class="hs-identifier">ppr_tc_sort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682873208"><span class="hs-identifier hs-var">flavor</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-230"></a><span>                     </span><a href="FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type&quot;</span><span>
</span><a name="line-231"></a><span>                     </span><a href="FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-var">DataFamilyInst</span></a><span> </span><a name="local-6989586621682873215"><a href="#local-6989586621682873215"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-232"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isDataTyCon"><span class="hs-identifier hs-var">isDataTyCon</span></a><span>     </span><a href="#local-6989586621682873215"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;data&quot;</span><span>
</span><a name="line-233"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isNewTyCon"><span class="hs-identifier hs-var">isNewTyCon</span></a><span>      </span><a href="#local-6989586621682873215"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;newtype&quot;</span><span>
</span><a name="line-234"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isAbstractTyCon"><span class="hs-identifier hs-var">isAbstractTyCon</span></a><span> </span><a href="#local-6989586621682873215"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;data&quot;</span><span>
</span><a name="line-235"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;WEIRD&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873215"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span>    </span><a name="local-6989586621682873214"><a href="#local-6989586621682873214"><span class="hs-identifier">debug_stuff</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Coercion axiom:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873209"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-238"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Tvs:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873210"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-239"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;LHS:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873211"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-240"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;RHS:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873212"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-241"></a><span>
</span><a name="line-242"></a><span class="hs-identifier">pprFamInsts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-243"></a><a name="pprFamInsts"><a href="FamInstEnv.html#pprFamInsts"><span class="hs-identifier">pprFamInsts</span></a></a><span> </span><a name="local-6989586621682873216"><a href="#local-6989586621682873216"><span class="hs-identifier">finsts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="FamInstEnv.html#pprFamInst"><span class="hs-identifier hs-var">pprFamInst</span></a><span> </span><a href="#local-6989586621682873216"><span class="hs-identifier hs-var">finsts</span></a><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-comment">{-
Note [Lazy axiom match]
~~~~~~~~~~~~~~~~~~~~~~~
It is Vitally Important that mkImportedFamInst is *lazy* in its axiom
parameter. The axiom is loaded lazily, via a forkM, in TcIface. Sometime
later, mkImportedFamInst is called using that axiom. However, the axiom
may itself depend on entities which are not yet loaded as of the time
of the mkImportedFamInst. Thus, if mkImportedFamInst eagerly looks at the
axiom, a dependency loop spontaneously appears and GHC hangs. The solution
is simply for mkImportedFamInst never, ever to look inside of the axiom
until everything else is good and ready to do so. We can assume that this
readiness has been achieved when some other code pulls on the axiom in the
FamInst. Thus, we pattern match on the axiom lazily (in the where clause,
not in the parameter list) and we assert the consistency of names there
also.
-}</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-comment">-- Make a family instance representation from the information found in an</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- interface file.  In particular, we get the rough match info from the iface</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- (instead of computing it here).</span><span>
</span><a name="line-265"></a><span class="hs-identifier">mkImportedFamInst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>               </span><span class="hs-comment">-- Name of the family</span><span>
</span><a name="line-266"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- Rough match info</span><span>
</span><a name="line-267"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span> </span><span class="hs-comment">-- Axiom introduced</span><span>
</span><a name="line-268"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span>            </span><span class="hs-comment">-- Resulting family instance</span><span>
</span><a name="line-269"></a><a name="mkImportedFamInst"><a href="FamInstEnv.html#mkImportedFamInst"><span class="hs-identifier">mkImportedFamInst</span></a></a><span> </span><a name="local-6989586621682873217"><a href="#local-6989586621682873217"><span class="hs-identifier">fam</span></a></a><span> </span><a name="local-6989586621682873218"><a href="#local-6989586621682873218"><span class="hs-identifier">mb_tcs</span></a></a><span> </span><a name="local-6989586621682873219"><a href="#local-6989586621682873219"><span class="hs-identifier">axiom</span></a></a><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-271"></a><span>      </span><span class="hs-identifier">fi_fam</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873217"><span class="hs-identifier hs-var">fam</span></a><span class="hs-special">,</span><span>
</span><a name="line-272"></a><span>      </span><span class="hs-identifier">fi_tcs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873218"><span class="hs-identifier hs-var">mb_tcs</span></a><span class="hs-special">,</span><span>
</span><a name="line-273"></a><span>      </span><span class="hs-identifier">fi_tvs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873221"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-274"></a><span>      </span><span class="hs-identifier">fi_cvs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873222"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-275"></a><span>      </span><span class="hs-identifier">fi_tys</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873220"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">,</span><span>
</span><a name="line-276"></a><span>      </span><span class="hs-identifier">fi_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873223"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span>
</span><a name="line-277"></a><span>      </span><span class="hs-identifier">fi_axiom</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873219"><span class="hs-identifier hs-var">axiom</span></a><span class="hs-special">,</span><span>
</span><a name="line-278"></a><span>      </span><span class="hs-identifier">fi_flavor</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873224"><span class="hs-identifier hs-var">flavor</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-279"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-280"></a><span>     </span><span class="hs-comment">-- See Note [Lazy axiom match]</span><span>
</span><a name="line-281"></a><span>     </span><span class="hs-glyph">~</span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873220"><a href="#local-6989586621682873220"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-282"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873221"><a href="#local-6989586621682873221"><span class="hs-identifier">tvs</span></a></a><span>
</span><a name="line-283"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873222"><a href="#local-6989586621682873222"><span class="hs-identifier">cvs</span></a></a><span>
</span><a name="line-284"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873223"><a href="#local-6989586621682873223"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><a href="#local-6989586621682873219"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-285"></a><span>
</span><a name="line-286"></a><span>         </span><span class="hs-comment">-- Derive the flavor for an imported FamInst rather disgustingly</span><span>
</span><a name="line-287"></a><span>         </span><span class="hs-comment">-- Maybe we should store it in the IfaceFamInst?</span><span>
</span><a name="line-288"></a><span>     </span><a name="local-6989586621682873224"><a href="#local-6989586621682873224"><span class="hs-identifier">flavor</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682873223"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-289"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873225"><a href="#local-6989586621682873225"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-290"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873226"><a href="#local-6989586621682873226"><span class="hs-identifier">ax'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConFamilyCoercion_maybe"><span class="hs-identifier hs-var">tyConFamilyCoercion_maybe</span></a><span> </span><a href="#local-6989586621682873225"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-291"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873226"><span class="hs-identifier hs-var">ax'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682873219"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-292"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#DataFamilyInst"><span class="hs-identifier hs-var">DataFamilyInst</span></a><span> </span><a href="#local-6989586621682873225"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-293"></a><span>                </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#SynFamilyInst"><span class="hs-identifier hs-var">SynFamilyInst</span></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                FamInstEnv
*                                                                      *
************************************************************************

Note [FamInstEnv]
~~~~~~~~~~~~~~~~~
A FamInstEnv maps a family name to the list of known instances for that family.

The same FamInstEnv includes both 'data family' and 'type family' instances.
Type families are reduced during type inference, but not data families;
the user explains when to use a data family instance by using constructors
and pattern matching.

Nevertheless it is still useful to have data families in the FamInstEnv:

 - For finding overlaps and conflicts

 - For finding the representation type...see FamInstEnv.topNormaliseType
   and its call site in Simplify

 - In standalone deriving instance Eq (T [Int]) we need to find the
   representation type for T [Int]

Note [Varying number of patterns for data family axioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For data families, the number of patterns may vary between instances.
For example
   data family T a b
   data instance T Int a = T1 a | T2
   data instance T Bool [a] = T3 a

Then we get a data type for each instance, and an axiom:
   data TInt a = T1 a | T2
   data TBoolList a = T3 a

   axiom ax7   :: T Int ~ TInt   -- Eta-reduced
   axiom ax8 a :: T Bool [a] ~ TBoolList a

These two axioms for T, one with one pattern, one with two;
see Note [Eta reduction for data families]

Note [FamInstEnv determinism]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We turn FamInstEnvs into a list in some places that don't directly affect
the ABI. That happens in family consistency checks and when producing output
for `:info`. Unfortunately that nondeterminism is nonlocal and it's hard
to tell what it affects without following a chain of functions. It's also
easy to accidentally make that nondeterminism affect the ABI. Furthermore
the envs should be relatively small, so it should be free to use deterministic
maps here. Testing with nofib and validate detected no difference between
UniqFM and UniqDFM.
See Note [Deterministic UniqFM].
-}</span><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span class="hs-keyword">type</span><span> </span><a name="FamInstEnv"><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier">FamInstEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#UniqDFM"><span class="hs-identifier hs-type">UniqDFM</span></a><span> </span><a href="FamInstEnv.html#FamilyInstEnv"><span class="hs-identifier hs-type">FamilyInstEnv</span></a><span>  </span><span class="hs-comment">-- Maps a family to its instances</span><span>
</span><a name="line-353"></a><span>     </span><span class="hs-comment">-- See Note [FamInstEnv]</span><span>
</span><a name="line-354"></a><span>     </span><span class="hs-comment">-- See Note [FamInstEnv determinism]</span><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-keyword">type</span><span> </span><a name="FamInstEnvs"><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier">FamInstEnvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>     </span><span class="hs-comment">-- External package inst-env, Home-package inst-env</span><span>
</span><a name="line-358"></a><span>
</span><a name="line-359"></a><span class="hs-keyword">newtype</span><span> </span><a name="FamilyInstEnv"><a href="FamInstEnv.html#FamilyInstEnv"><span class="hs-identifier">FamilyInstEnv</span></a></a><span>
</span><a name="line-360"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="FamIE"><a href="FamInstEnv.html#FamIE"><span class="hs-identifier">FamIE</span></a></a><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- The instances for a particular family, in any order</span><span>
</span><a name="line-361"></a><span>
</span><a name="line-362"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="FamInstEnv.html#FamilyInstEnv"><span class="hs-identifier hs-type">FamilyInstEnv</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-363"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><a name="local-6989586621682873195"><a href="#local-6989586621682873195"><span class="hs-identifier">fs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;FamIE&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873195"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span class="hs-comment">-- INVARIANTS:</span><span>
</span><a name="line-366"></a><span class="hs-comment">--  * The fs_tvs are distinct in each FamInst</span><span>
</span><a name="line-367"></a><span class="hs-comment">--      of a range value of the map (so we can safely unify them)</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span class="hs-identifier">emptyFamInstEnvs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-370"></a><a name="emptyFamInstEnvs"><a href="FamInstEnv.html#emptyFamInstEnvs"><span class="hs-identifier">emptyFamInstEnvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier hs-var">emptyFamInstEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-identifier">emptyFamInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span>
</span><a name="line-373"></a><a name="emptyFamInstEnv"><a href="FamInstEnv.html#emptyFamInstEnv"><span class="hs-identifier">emptyFamInstEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#emptyUDFM"><span class="hs-identifier hs-var">emptyUDFM</span></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-identifier">famInstEnvElts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-376"></a><a name="famInstEnvElts"><a href="FamInstEnv.html#famInstEnvElts"><span class="hs-identifier">famInstEnvElts</span></a></a><span> </span><a name="local-6989586621682873227"><a href="#local-6989586621682873227"><span class="hs-identifier">fi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682873229"><span class="hs-identifier hs-var">elt</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><a name="local-6989586621682873228"><a href="#local-6989586621682873228"><span class="hs-identifier">elts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqDFM.html#eltsUDFM"><span class="hs-identifier hs-var">eltsUDFM</span></a><span> </span><a href="#local-6989586621682873227"><span class="hs-identifier hs-var">fi</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873229"><a href="#local-6989586621682873229"><span class="hs-identifier">elt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873228"><span class="hs-identifier hs-var">elts</span></a><span class="hs-special">]</span><span>
</span><a name="line-377"></a><span>  </span><span class="hs-comment">-- See Note [FamInstEnv determinism]</span><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-identifier">famInstEnvSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-380"></a><a name="famInstEnvSize"><a href="FamInstEnv.html#famInstEnvSize"><span class="hs-identifier">famInstEnvSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#nonDetFoldUDFM"><span class="hs-identifier hs-var">nonDetFoldUDFM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><a name="local-6989586621682873230"><a href="#local-6989586621682873230"><span class="hs-identifier">elt</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682873231"><a href="#local-6989586621682873231"><span class="hs-identifier">sum</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873231"><span class="hs-identifier hs-var">sum</span></a><span> </span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682873230"><span class="hs-identifier hs-var">elt</span></a><span class="hs-special">)</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-381"></a><span>  </span><span class="hs-comment">-- It's OK to use nonDetFoldUDFM here since we're just computing the</span><span>
</span><a name="line-382"></a><span>  </span><span class="hs-comment">-- size.</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span class="hs-identifier">familyInstances</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-385"></a><a name="familyInstances"><a href="FamInstEnv.html#familyInstances"><span class="hs-identifier">familyInstances</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682873232"><a href="#local-6989586621682873232"><span class="hs-identifier">pkg_fie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873233"><a href="#local-6989586621682873233"><span class="hs-identifier">home_fie</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682873234"><a href="#local-6989586621682873234"><span class="hs-identifier">fam</span></a></a><span>
</span><a name="line-386"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873235"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682873233"><span class="hs-identifier hs-var">home_fie</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682873235"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682873232"><span class="hs-identifier hs-var">pkg_fie</span></a><span>
</span><a name="line-387"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-388"></a><span>    </span><a name="local-6989586621682873235"><a href="#local-6989586621682873235"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621682873236"><a href="#local-6989586621682873236"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621682873236"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873234"><span class="hs-identifier hs-var">fam</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-389"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><a name="local-6989586621682873237"><a href="#local-6989586621682873237"><span class="hs-identifier">insts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873237"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-390"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><span class="hs-identifier">extendFamInstEnvList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span>
</span><a name="line-393"></a><a name="extendFamInstEnvList"><a href="FamInstEnv.html#extendFamInstEnvList"><span class="hs-identifier">extendFamInstEnvList</span></a></a><span> </span><a name="local-6989586621682873238"><a href="#local-6989586621682873238"><span class="hs-identifier">inst_env</span></a></a><span> </span><a name="local-6989586621682873239"><a href="#local-6989586621682873239"><span class="hs-identifier">fis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="FamInstEnv.html#extendFamInstEnv"><span class="hs-identifier hs-var">extendFamInstEnv</span></a><span> </span><a href="#local-6989586621682873238"><span class="hs-identifier hs-var">inst_env</span></a><span> </span><a href="#local-6989586621682873239"><span class="hs-identifier hs-var">fis</span></a><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-identifier">extendFamInstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span>
</span><a name="line-396"></a><a name="extendFamInstEnv"><a href="FamInstEnv.html#extendFamInstEnv"><span class="hs-identifier">extendFamInstEnv</span></a></a><span> </span><a name="local-6989586621682873240"><a href="#local-6989586621682873240"><span class="hs-identifier">inst_env</span></a></a><span>
</span><a name="line-397"></a><span>                 </span><a name="local-6989586621682873241"><a href="#local-6989586621682873241"><span class="hs-identifier">ins_item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">fi_fam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873242"><a href="#local-6989586621682873242"><span class="hs-identifier">cls_nm</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#addToUDFM_C"><span class="hs-identifier hs-var">addToUDFM_C</span></a><span> </span><a href="#local-6989586621682873243"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621682873240"><span class="hs-identifier hs-var">inst_env</span></a><span> </span><a href="#local-6989586621682873242"><span class="hs-identifier hs-var">cls_nm</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682873241"><span class="hs-identifier hs-var">ins_item</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-399"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-400"></a><span>    </span><a name="local-6989586621682873243"><a href="#local-6989586621682873243"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><a name="local-6989586621682873244"><a href="#local-6989586621682873244"><span class="hs-identifier">items</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873241"><span class="hs-identifier hs-var">ins_item</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682873244"><span class="hs-identifier hs-var">items</span></a><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>
</span><a name="line-402"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Compatibility
*                                                                      *
************************************************************************

Note [Apartness]
~~~~~~~~~~~~~~~~
In dealing with closed type families, we must be able to check that one type
will never reduce to another. This check is called /apartness/. The check
is always between a target (which may be an arbitrary type) and a pattern.
Here is how we do it:

apart(target, pattern) = not (unify(flatten(target), pattern))

where flatten (implemented in flattenTys, below) converts all type-family
applications into fresh variables. (See Note [Flattening].)

Note [Compatibility]
~~~~~~~~~~~~~~~~~~~~
Two patterns are /compatible/ if either of the following conditions hold:
1) The patterns are apart.
2) The patterns unify with a substitution S, and their right hand sides
equal under that substitution.

For open type families, only compatible instances are allowed. For closed
type families, the story is slightly more complicated. Consider the following:

type family F a where
  F Int = Bool
  F a   = Int

g :: Show a =&gt; a -&gt; F a
g x = length (show x)

Should that type-check? No. We need to allow for the possibility that 'a'
might be Int and therefore 'F a' should be Bool. We can simplify 'F a' to Int
only when we can be sure that 'a' is not Int.

To achieve this, after finding a possible match within the equations, we have to
go back to all previous equations and check that, under the
substitution induced by the match, other branches are surely apart. (See
Note [Apartness].) This is similar to what happens with class
instance selection, when we need to guarantee that there is only a match and
no unifiers. The exact algorithm is different here because the
potentially-overlapping group is closed.

As another example, consider this:

type family G x where
  G Int = Bool
  G a   = Double

type family H y
-- no instances

Now, we want to simplify (G (H Char)). We can't, because (H Char) might later
simplify to be Int. So, (G (H Char)) is stuck, for now.

While everything above is quite sound, it isn't as expressive as we'd like.
Consider this:

type family J a where
  J Int = Int
  J a   = a

Can we simplify (J b) to b? Sure we can. Yes, the first equation matches if
b is instantiated with Int, but the RHSs coincide there, so it's all OK.

So, the rule is this: when looking up a branch in a closed type family, we
find a branch that matches the target, but then we make sure that the target
is apart from every previous *incompatible* branch. We don't check the
branches that are compatible with the matching branch, because they are either
irrelevant (clause 1 of compatible) or benign (clause 2 of compatible).

Note [Compatibility of eta-reduced axioms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In newtype instances of data families we eta-reduce the axioms,
See Note [Eta reduction for data families] in FamInstEnv. This means that
we sometimes need to test compatibility of two axioms that were eta-reduced to
different degrees, e.g.:


data family D a b c
newtype instance D a Int c = DInt (Maybe a)
  -- D a Int ~ Maybe
  -- lhs = [a, Int]
newtype instance D Bool Int Char = DIntChar Float
  -- D Bool Int Char ~ Float
  -- lhs = [Bool, Int, Char]

These are obviously incompatible. We could detect this by saturating
(eta-expanding) the shorter LHS with fresh tyvars until the lists are of
equal length, but instead we can just remove the tail of the longer list, as
those types will simply unify with the freshly introduced tyvars.

By doing this, in case the LHS are unifiable, the yielded substitution won't
mention the tyvars that appear in the tail we dropped off, and we might try
to test equality RHSes of different kinds, but that's fine since this case
occurs only for data families, where the RHS is a unique tycon and the equality
fails anyway.
-}</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span class="hs-comment">-- See Note [Compatibility]</span><span>
</span><a name="line-507"></a><span class="hs-identifier">compatibleBranches</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-508"></a><a name="compatibleBranches"><a href="FamInstEnv.html#compatibleBranches"><span class="hs-identifier">compatibleBranches</span></a></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873245"><a href="#local-6989586621682873245"><span class="hs-identifier">lhs1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873246"><a href="#local-6989586621682873246"><span class="hs-identifier">rhs1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-509"></a><span>                   </span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873247"><a href="#local-6989586621682873247"><span class="hs-identifier">lhs2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873248"><a href="#local-6989586621682873248"><span class="hs-identifier">rhs2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873249"><a href="#local-6989586621682873249"><span class="hs-identifier">commonlhs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873250"><a href="#local-6989586621682873250"><span class="hs-identifier">commonlhs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#zipAndUnzip"><span class="hs-identifier hs-var">zipAndUnzip</span></a><span> </span><a href="#local-6989586621682873245"><span class="hs-identifier hs-var">lhs1</span></a><span> </span><a href="#local-6989586621682873247"><span class="hs-identifier hs-var">lhs2</span></a><span>
</span><a name="line-511"></a><span>             </span><span class="hs-comment">-- See Note [Compatibility of eta-reduced axioms]</span><span>
</span><a name="line-512"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-var">tcUnifyTysFG</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873249"><span class="hs-identifier hs-var">commonlhs1</span></a><span> </span><a href="#local-6989586621682873250"><span class="hs-identifier hs-var">commonlhs2</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-513"></a><span>      </span><a href="Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-514"></a><span>      </span><a href="Unify.html#Unifiable"><span class="hs-identifier hs-var">Unifiable</span></a><span> </span><a name="local-6989586621682873251"><a href="#local-6989586621682873251"><span class="hs-identifier">subst</span></a></a><span>
</span><a name="line-515"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="TyCoRep.html#substTyAddInScope"><span class="hs-identifier hs-var">Type.substTyAddInScope</span></a><span> </span><a href="#local-6989586621682873251"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873246"><span class="hs-identifier hs-var">rhs1</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span>
</span><a name="line-516"></a><span>          </span><a href="TyCoRep.html#substTyAddInScope"><span class="hs-identifier hs-var">Type.substTyAddInScope</span></a><span> </span><a href="#local-6989586621682873251"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873248"><span class="hs-identifier hs-var">rhs2</span></a><span>
</span><a name="line-517"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-518"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span class="hs-comment">-- | Result of testing two type family equations for injectiviy.</span><span>
</span><a name="line-521"></a><span class="hs-keyword">data</span><span> </span><a name="InjectivityCheckResult"><a href="FamInstEnv.html#InjectivityCheckResult"><span class="hs-identifier">InjectivityCheckResult</span></a></a><span>
</span><a name="line-522"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a name="InjectivityAccepted"><a href="FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier">InjectivityAccepted</span></a></a><span>
</span><a name="line-523"></a><span>    </span><span class="hs-comment">-- ^ Either RHSs are distinct or unification of RHSs leads to unification of</span><span>
</span><a name="line-524"></a><span>    </span><span class="hs-comment">-- LHSs</span><span>
</span><a name="line-525"></a><span>   </span><span class="hs-glyph">|</span><span> </span><a name="InjectivityUnified"><a href="FamInstEnv.html#InjectivityUnified"><span class="hs-identifier">InjectivityUnified</span></a></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-526"></a><span>    </span><span class="hs-comment">-- ^ RHSs unify but LHSs don't unify under that substitution.  Relevant for</span><span>
</span><a name="line-527"></a><span>    </span><span class="hs-comment">-- closed type families where equation after unification might be</span><span>
</span><a name="line-528"></a><span>    </span><span class="hs-comment">-- overlpapped (in which case it is OK if they don't unify).  Constructor</span><span>
</span><a name="line-529"></a><span>    </span><span class="hs-comment">-- stores axioms after unification.</span><span>
</span><a name="line-530"></a><span>
</span><a name="line-531"></a><span class="hs-comment">-- | Check whether two type family axioms don't violate injectivity annotation.</span><span>
</span><a name="line-532"></a><span class="hs-identifier">injectiveBranches</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-533"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#InjectivityCheckResult"><span class="hs-identifier hs-type">InjectivityCheckResult</span></a><span>
</span><a name="line-534"></a><a name="injectiveBranches"><a href="FamInstEnv.html#injectiveBranches"><span class="hs-identifier">injectiveBranches</span></a></a><span> </span><a name="local-6989586621682873252"><a href="#local-6989586621682873252"><span class="hs-identifier">injectivity</span></a></a><span>
</span><a name="line-535"></a><span>                  </span><a name="local-6989586621682873253"><a href="#local-6989586621682873253"><span class="hs-identifier">ax1</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873254"><a href="#local-6989586621682873254"><span class="hs-identifier">lhs1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873255"><a href="#local-6989586621682873255"><span class="hs-identifier">rhs1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-536"></a><span>                  </span><a name="local-6989586621682873256"><a href="#local-6989586621682873256"><span class="hs-identifier">ax2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873257"><a href="#local-6989586621682873257"><span class="hs-identifier">lhs2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873258"><a href="#local-6989586621682873258"><span class="hs-identifier">rhs2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>  </span><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements first</span><span>
</span><a name="line-538"></a><span>  </span><span class="hs-comment">-- check described there.</span><span>
</span><a name="line-539"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873259"><a href="#local-6989586621682873259"><span class="hs-identifier">getInjArgs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#filterByList"><span class="hs-identifier hs-var">filterByList</span></a><span> </span><a href="#local-6989586621682873252"><span class="hs-identifier hs-var">injectivity</span></a><span>
</span><a name="line-540"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Unify.html#tcUnifyTyWithTFs"><span class="hs-identifier hs-var">tcUnifyTyWithTFs</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621682873255"><span class="hs-identifier hs-var">rhs1</span></a><span> </span><a href="#local-6989586621682873258"><span class="hs-identifier hs-var">rhs2</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- True = two-way pre-unification</span><span>
</span><a name="line-541"></a><span>       </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a><span> </span><span class="hs-comment">-- RHS are different, so equations are</span><span>
</span><a name="line-542"></a><span>                                      </span><span class="hs-comment">-- injective.</span><span>
</span><a name="line-543"></a><span>       </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873260"><a href="#local-6989586621682873260"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- RHS unify under a substitution</span><span>
</span><a name="line-544"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873261"><a href="#local-6989586621682873261"><span class="hs-identifier">lhs1Subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">Type.substTys</span></a><span> </span><a href="#local-6989586621682873260"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873259"><span class="hs-identifier hs-var">getInjArgs</span></a><span> </span><a href="#local-6989586621682873254"><span class="hs-identifier hs-var">lhs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-545"></a><span>            </span><a name="local-6989586621682873262"><a href="#local-6989586621682873262"><span class="hs-identifier">lhs2Subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">Type.substTys</span></a><span> </span><a href="#local-6989586621682873260"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873259"><span class="hs-identifier hs-var">getInjArgs</span></a><span> </span><a href="#local-6989586621682873257"><span class="hs-identifier hs-var">lhs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-546"></a><span>        </span><span class="hs-comment">-- If LHSs are equal under the substitution used for RHSs then this pair</span><span>
</span><a name="line-547"></a><span>        </span><span class="hs-comment">-- of equations does not violate injectivity annotation. If LHSs are not</span><span>
</span><a name="line-548"></a><span>        </span><span class="hs-comment">-- equal under that substitution then this pair of equations violates</span><span>
</span><a name="line-549"></a><span>        </span><span class="hs-comment">-- injectivity annotation, but for closed type families it still might</span><span>
</span><a name="line-550"></a><span>        </span><span class="hs-comment">-- be the case that one LHS after substitution is unreachable.</span><span>
</span><a name="line-551"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="Type.html#eqTypes"><span class="hs-identifier hs-var">eqTypes</span></a><span> </span><a href="#local-6989586621682873261"><span class="hs-identifier hs-var">lhs1Subst</span></a><span> </span><a href="#local-6989586621682873262"><span class="hs-identifier hs-var">lhs2Subst</span></a><span>
</span><a name="line-552"></a><span>           </span><span class="hs-keyword">then</span><span> </span><a href="FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a><span>
</span><a name="line-553"></a><span>           </span><span class="hs-keyword">else</span><span> </span><a href="FamInstEnv.html#InjectivityUnified"><span class="hs-identifier hs-var">InjectivityUnified</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682873253"><span class="hs-identifier hs-var">ax1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">Type.substTys</span></a><span> </span><a href="#local-6989586621682873260"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873254"><span class="hs-identifier hs-var">lhs1</span></a><span>
</span><a name="line-554"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">Type.substTy</span></a><span>  </span><a href="#local-6989586621682873260"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873255"><span class="hs-identifier hs-var">rhs1</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-555"></a><span>                                   </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682873256"><span class="hs-identifier hs-var">ax2</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">Type.substTys</span></a><span> </span><a href="#local-6989586621682873260"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873257"><span class="hs-identifier hs-var">lhs2</span></a><span>
</span><a name="line-556"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">Type.substTy</span></a><span>  </span><a href="#local-6989586621682873260"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873258"><span class="hs-identifier hs-var">rhs2</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-557"></a><span>
</span><a name="line-558"></a><span class="hs-comment">-- takes a CoAxiom with unknown branch incompatibilities and computes</span><span>
</span><a name="line-559"></a><span class="hs-comment">-- the compatibilities</span><span>
</span><a name="line-560"></a><span class="hs-comment">-- See Note [Storing compatibility] in CoAxiom</span><span>
</span><a name="line-561"></a><span class="hs-identifier">computeAxiomIncomps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span>
</span><a name="line-562"></a><a name="computeAxiomIncomps"><a href="FamInstEnv.html#computeAxiomIncomps"><span class="hs-identifier">computeAxiomIncomps</span></a></a><span> </span><a name="local-6989586621682873263"><a href="#local-6989586621682873263"><span class="hs-identifier">branches</span></a></a><span>
</span><a name="line-563"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="#local-6989586621682873264"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682873263"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-565"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">)</span><span>
</span><a name="line-566"></a><span>    </span><a name="local-6989586621682873264"><a href="#local-6989586621682873264"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682873266"><a href="#local-6989586621682873266"><span class="hs-identifier">prev_brs</span></a></a><span> </span><a name="local-6989586621682873267"><a href="#local-6989586621682873267"><span class="hs-identifier">cur_br</span></a></a><span>
</span><a name="line-567"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873267"><span class="hs-identifier hs-var">cur_br</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682873266"><span class="hs-identifier hs-var">prev_brs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873268"><span class="hs-identifier hs-var">new_br</span></a><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-569"></a><span>         </span><a name="local-6989586621682873268"><a href="#local-6989586621682873268"><span class="hs-identifier">new_br</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873267"><span class="hs-identifier hs-var">cur_br</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_incomps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873265"><span class="hs-identifier hs-var">mk_incomps</span></a><span> </span><a href="#local-6989586621682873266"><span class="hs-identifier hs-var">prev_brs</span></a><span> </span><a href="#local-6989586621682873267"><span class="hs-identifier hs-var">cur_br</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-570"></a><span>
</span><a name="line-571"></a><span>    </span><span class="hs-identifier">mk_incomps</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span>
</span><a name="line-572"></a><span>    </span><a name="local-6989586621682873265"><a href="#local-6989586621682873265"><span class="hs-identifier">mk_incomps</span></a></a><span> </span><a name="local-6989586621682873269"><a href="#local-6989586621682873269"><span class="hs-identifier">prev_brs</span></a></a><span> </span><a name="local-6989586621682873270"><a href="#local-6989586621682873270"><span class="hs-identifier">cur_br</span></a></a><span>
</span><a name="line-573"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="FamInstEnv.html#compatibleBranches"><span class="hs-identifier hs-var">compatibleBranches</span></a><span> </span><a href="#local-6989586621682873270"><span class="hs-identifier hs-var">cur_br</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873269"><span class="hs-identifier hs-var">prev_brs</span></a><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
           Constructing axioms
    These functions are here because tidyType / tcUnifyTysFG
    are not available in CoAxiom

    Also computeAxiomIncomps is too sophisticated for CoAxiom
*                                                                      *
************************************************************************

Note [Tidy axioms when we build them]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Like types and classes, we build axioms fully quantified over all
their variables, and tidy them when we build them. For example,
we print out axioms and don't want to print stuff like
    F k k a b = ...
Instead we must tidy those kind variables.  See Trac #7524.

We could instead tidy when we print, but that makes it harder to get
things like injectivity errors to come out right. Danger of
     Type family equation violates injectivity annotation.
     Kind variable &#8216;k&#8217; cannot be inferred from the right-hand side.
     In the type family equation:
        PolyKindVars @[k1] @[k2] ('[] @k1) = '[] @k2

Note [Always number wildcard types in CoAxBranch]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider the following example (from the DataFamilyInstanceLHS test case):

  data family Sing (a :: k)
  data instance Sing (_ :: MyKind) where
      SingA :: Sing A
      SingB :: Sing B

If we're not careful during tidying, then when this program is compiled with
-ddump-types, we'll get the following information:

  COERCION AXIOMS
    axiom DataFamilyInstanceLHS.D:R:SingMyKind_0 ::
      Sing _ = DataFamilyInstanceLHS.R:SingMyKind_ _

It's misleading to have a wildcard type appearing on the RHS like
that. To avoid this issue, when building a CoAxiom (which is what eventually
gets printed above), we tidy all the variables in an env that already contains
'_'. Thus, any variable named '_' will be renamed, giving us the nicer output
here:

  COERCION AXIOMS
    axiom DataFamilyInstanceLHS.D:R:SingMyKind_0 ::
      Sing _1 = DataFamilyInstanceLHS.R:SingMyKind_ _1

Which is at least legal syntax.

See also Note [CoAxBranch type variables] in CoAxiom; note that we
are tidying (changing OccNames only), not freshening, in accordance with
that Note.
-}</span><span>
</span><a name="line-633"></a><span>
</span><a name="line-634"></a><span class="hs-comment">-- all axiom roles are Nominal, as this is only used with type families</span><span>
</span><a name="line-635"></a><span class="hs-identifier">mkCoAxBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- original, possibly stale, tyvars</span><span>
</span><a name="line-636"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Extra eta tyvars</span><span>
</span><a name="line-637"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- possibly stale covars</span><span>
</span><a name="line-638"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- LHS patterns</span><span>
</span><a name="line-639"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>    </span><span class="hs-comment">-- RHS</span><span>
</span><a name="line-640"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">]</span><span>
</span><a name="line-641"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span>
</span><a name="line-642"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-643"></a><a name="mkCoAxBranch"><a href="FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier">mkCoAxBranch</span></a></a><span> </span><a name="local-6989586621682873271"><a href="#local-6989586621682873271"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682873272"><a href="#local-6989586621682873272"><span class="hs-identifier">eta_tvs</span></a></a><span> </span><a name="local-6989586621682873273"><a href="#local-6989586621682873273"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621682873274"><a href="#local-6989586621682873274"><span class="hs-identifier">lhs</span></a></a><span> </span><a name="local-6989586621682873275"><a href="#local-6989586621682873275"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621682873276"><a href="#local-6989586621682873276"><span class="hs-identifier">roles</span></a></a><span> </span><a name="local-6989586621682873277"><a href="#local-6989586621682873277"><span class="hs-identifier">loc</span></a></a><span>
</span><a name="line-644"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873279"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-645"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_eta_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873281"><span class="hs-identifier hs-var">eta_tvs'</span></a><span>
</span><a name="line-646"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873283"><span class="hs-identifier hs-var">cvs'</span></a><span>
</span><a name="line-647"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyTypes"><span class="hs-identifier hs-var">tidyTypes</span></a><span> </span><a href="#local-6989586621682873282"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873274"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-648"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_roles</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873276"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-649"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_rhs</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a><span> </span><a href="#local-6989586621682873282"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873275"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-650"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_loc</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873277"><span class="hs-identifier hs-var">loc</span></a><span>
</span><a name="line-651"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_incomps</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#placeHolderIncomps"><span class="hs-identifier hs-var">placeHolderIncomps</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-652"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-653"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682873278"><a href="#local-6989586621682873278"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873279"><a href="#local-6989586621682873279"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyVarBndrs"><span class="hs-identifier hs-var">tidyVarBndrs</span></a><span> </span><a href="#local-6989586621682873285"><span class="hs-identifier hs-var">init_tidy_env</span></a><span> </span><a href="#local-6989586621682873271"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-654"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682873280"><a href="#local-6989586621682873280"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873281"><a href="#local-6989586621682873281"><span class="hs-identifier">eta_tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyVarBndrs"><span class="hs-identifier hs-var">tidyVarBndrs</span></a><span> </span><a href="#local-6989586621682873278"><span class="hs-identifier hs-var">env1</span></a><span>          </span><a href="#local-6989586621682873272"><span class="hs-identifier hs-var">eta_tvs</span></a><span>
</span><a name="line-655"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682873282"><a href="#local-6989586621682873282"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621682873283"><a href="#local-6989586621682873283"><span class="hs-identifier">cvs'</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyVarBndrs"><span class="hs-identifier hs-var">tidyVarBndrs</span></a><span> </span><a href="#local-6989586621682873280"><span class="hs-identifier hs-var">env2</span></a><span>          </span><a href="#local-6989586621682873273"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-656"></a><span>    </span><span class="hs-comment">-- See Note [Tidy axioms when we build them]</span><span>
</span><a name="line-657"></a><span>    </span><span class="hs-comment">-- See also Note [CoAxBranch type variables] in CoAxiom</span><span>
</span><a name="line-658"></a><span>
</span><a name="line-659"></a><span>    </span><a name="local-6989586621682873284"><a href="#local-6989586621682873284"><span class="hs-identifier">init_occ_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OccName.html#initTidyOccEnv"><span class="hs-identifier hs-var">initTidyOccEnv</span></a><span> </span><span class="hs-special">[</span><a href="OccName.html#mkTyVarOcc"><span class="hs-identifier hs-var">mkTyVarOcc</span></a><span> </span><span class="hs-string">&quot;_&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-660"></a><span>    </span><a name="local-6989586621682873285"><a href="#local-6989586621682873285"><span class="hs-identifier">init_tidy_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkEmptyTidyEnv"><span class="hs-identifier hs-var">mkEmptyTidyEnv</span></a><span> </span><a href="#local-6989586621682873284"><span class="hs-identifier hs-var">init_occ_env</span></a><span>
</span><a name="line-661"></a><span>    </span><span class="hs-comment">-- See Note [Always number wildcard types in CoAxBranch]</span><span>
</span><a name="line-662"></a><span>
</span><a name="line-663"></a><span class="hs-comment">-- all of the following code is here to avoid mutual dependencies with</span><span>
</span><a name="line-664"></a><span class="hs-comment">-- Coercion</span><span>
</span><a name="line-665"></a><span class="hs-identifier">mkBranchedCoAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Branched"><span class="hs-identifier hs-type">Branched</span></a><span>
</span><a name="line-666"></a><a name="mkBranchedCoAxiom"><a href="FamInstEnv.html#mkBranchedCoAxiom"><span class="hs-identifier">mkBranchedCoAxiom</span></a></a><span> </span><a name="local-6989586621682873286"><a href="#local-6989586621682873286"><span class="hs-identifier">ax_name</span></a></a><span> </span><a name="local-6989586621682873287"><a href="#local-6989586621682873287"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621682873288"><a href="#local-6989586621682873288"><span class="hs-identifier">branches</span></a></a><span>
</span><a name="line-667"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-var">CoAxiom</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_unique</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#nameUnique"><span class="hs-identifier hs-var">nameUnique</span></a><span> </span><a href="#local-6989586621682873286"><span class="hs-identifier hs-var">ax_name</span></a><span>
</span><a name="line-668"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_name</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873286"><span class="hs-identifier hs-var">ax_name</span></a><span>
</span><a name="line-669"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_tc</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873287"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-670"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_role</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-671"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-672"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#manyBranches"><span class="hs-identifier hs-var">manyBranches</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#computeAxiomIncomps"><span class="hs-identifier hs-var">computeAxiomIncomps</span></a><span> </span><a href="#local-6989586621682873288"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span class="hs-identifier">mkUnbranchedCoAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span>
</span><a name="line-675"></a><a name="mkUnbranchedCoAxiom"><a href="FamInstEnv.html#mkUnbranchedCoAxiom"><span class="hs-identifier">mkUnbranchedCoAxiom</span></a></a><span> </span><a name="local-6989586621682873289"><a href="#local-6989586621682873289"><span class="hs-identifier">ax_name</span></a></a><span> </span><a name="local-6989586621682873290"><a href="#local-6989586621682873290"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621682873291"><a href="#local-6989586621682873291"><span class="hs-identifier">branch</span></a></a><span>
</span><a name="line-676"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-var">CoAxiom</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_unique</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#nameUnique"><span class="hs-identifier hs-var">nameUnique</span></a><span> </span><a href="#local-6989586621682873289"><span class="hs-identifier hs-var">ax_name</span></a><span>
</span><a name="line-677"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_name</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873289"><span class="hs-identifier hs-var">ax_name</span></a><span>
</span><a name="line-678"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_tc</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873290"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-679"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_role</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-680"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-681"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#unbranched"><span class="hs-identifier hs-var">unbranched</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873291"><span class="hs-identifier hs-var">branch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_incomps</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span class="hs-identifier">mkSingleCoAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-684"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-685"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-686"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span>
</span><a name="line-687"></a><span class="hs-comment">-- Make a single-branch CoAxiom, incluidng making the branch itself</span><span>
</span><a name="line-688"></a><span class="hs-comment">-- Used for both type family (Nominal) and data family (Representational)</span><span>
</span><a name="line-689"></a><span class="hs-comment">-- axioms, hence passing in the Role</span><span>
</span><a name="line-690"></a><a name="mkSingleCoAxiom"><a href="FamInstEnv.html#mkSingleCoAxiom"><span class="hs-identifier">mkSingleCoAxiom</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682873293"><a href="#local-6989586621682873293"><span class="hs-identifier">ax_name</span></a></a><span> </span><a name="local-6989586621682873294"><a href="#local-6989586621682873294"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682873295"><a href="#local-6989586621682873295"><span class="hs-identifier">eta_tvs</span></a></a><span> </span><a name="local-6989586621682873296"><a href="#local-6989586621682873296"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621682873297"><a href="#local-6989586621682873297"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621682873298"><a href="#local-6989586621682873298"><span class="hs-identifier">lhs_tys</span></a></a><span> </span><a name="local-6989586621682873299"><a href="#local-6989586621682873299"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-691"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-var">CoAxiom</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_unique</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#nameUnique"><span class="hs-identifier hs-var">nameUnique</span></a><span> </span><a href="#local-6989586621682873293"><span class="hs-identifier hs-var">ax_name</span></a><span>
</span><a name="line-692"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_name</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873293"><span class="hs-identifier hs-var">ax_name</span></a><span>
</span><a name="line-693"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_tc</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873297"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-694"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_role</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-695"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-696"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#unbranched"><span class="hs-identifier hs-var">unbranched</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873300"><span class="hs-identifier hs-var">branch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_incomps</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-697"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-698"></a><span>    </span><a name="local-6989586621682873300"><a href="#local-6989586621682873300"><span class="hs-identifier">branch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier hs-var">mkCoAxBranch</span></a><span> </span><a href="#local-6989586621682873294"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621682873295"><span class="hs-identifier hs-var">eta_tvs</span></a><span> </span><a href="#local-6989586621682873296"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621682873298"><span class="hs-identifier hs-var">lhs_tys</span></a><span> </span><a href="#local-6989586621682873299"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-699"></a><span>                          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873294"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-700"></a><span>                          </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621682873293"><span class="hs-identifier hs-var">ax_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span class="hs-comment">-- | Create a coercion constructor (axiom) suitable for the given</span><span>
</span><a name="line-703"></a><span class="hs-comment">--   newtype 'TyCon'. The 'Name' should be that of a new coercion</span><span>
</span><a name="line-704"></a><span class="hs-comment">--   'CoAxiom', the 'TyVar's the arguments expected by the @newtype@ and</span><span>
</span><a name="line-705"></a><span class="hs-comment">--   the type the appropriate right hand side of the @newtype@, with</span><span>
</span><a name="line-706"></a><span class="hs-comment">--   the free variables a subset of those 'TyVar's.</span><span>
</span><a name="line-707"></a><span class="hs-identifier">mkNewTypeCoAxiom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Unbranched"><span class="hs-identifier hs-type">Unbranched</span></a><span>
</span><a name="line-708"></a><a name="mkNewTypeCoAxiom"><a href="FamInstEnv.html#mkNewTypeCoAxiom"><span class="hs-identifier">mkNewTypeCoAxiom</span></a></a><span> </span><a name="local-6989586621682873301"><a href="#local-6989586621682873301"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621682873302"><a href="#local-6989586621682873302"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621682873303"><a href="#local-6989586621682873303"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682873304"><a href="#local-6989586621682873304"><span class="hs-identifier">roles</span></a></a><span> </span><a name="local-6989586621682873305"><a href="#local-6989586621682873305"><span class="hs-identifier">rhs_ty</span></a></a><span>
</span><a name="line-709"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-var">CoAxiom</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">co_ax_unique</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#nameUnique"><span class="hs-identifier hs-var">nameUnique</span></a><span> </span><a href="#local-6989586621682873301"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-710"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_name</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873301"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-711"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-comment">-- See Note [Implicit axioms] in TyCon</span><span>
</span><a name="line-712"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_role</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span>
</span><a name="line-713"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_tc</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873302"><span class="hs-identifier hs-var">tycon</span></a><span>
</span><a name="line-714"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">co_ax_branches</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#unbranched"><span class="hs-identifier hs-var">unbranched</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873306"><span class="hs-identifier hs-var">branch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_incomps</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-715"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-716"></a><span>    </span><a name="local-6989586621682873306"><a href="#local-6989586621682873306"><span class="hs-identifier">branch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier hs-var">mkCoAxBranch</span></a><span> </span><a href="#local-6989586621682873303"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-6989586621682873303"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873305"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-717"></a><span>                          </span><a href="#local-6989586621682873304"><span class="hs-identifier hs-var">roles</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621682873301"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>
</span><a name="line-719"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Looking up a family instance
*                                                                      *
************************************************************************

@lookupFamInstEnv@ looks up in a @FamInstEnv@, using a one-way match.
Multiple matches are only possible in case of type families (not data
families), and then, it doesn't matter which match we choose (as the
instances are guaranteed confluent).

We return the matching family instances and the type instance at which it
matches.  For example, if we lookup 'T [Int]' and have a family instance

  data instance T [a] = ..

desugared to

  data :R42T a = ..
  coe :Co:R42T a :: T [a] ~ :R42T a

we return the matching instance '(FamInst{.., fi_tycon = :R42T}, Int)'.
-}</span><span>
</span><a name="line-743"></a><span>
</span><a name="line-744"></a><span class="hs-comment">-- when matching a type family application, we get a FamInst,</span><span>
</span><a name="line-745"></a><span class="hs-comment">-- and the list of types the axiom should be applied to</span><span>
</span><a name="line-746"></a><span class="hs-keyword">data</span><span> </span><a name="FamInstMatch"><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier">FamInstMatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FamInstMatch"><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier">FamInstMatch</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="fim_instance"><a href="FamInstEnv.html#fim_instance"><span class="hs-identifier">fim_instance</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span>
</span><a name="line-747"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a name="fim_tys"><a href="FamInstEnv.html#fim_tys"><span class="hs-identifier">fim_tys</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-748"></a><span>                                 </span><span class="hs-special">,</span><span> </span><a name="fim_cos"><a href="FamInstEnv.html#fim_cos"><span class="hs-identifier">fim_cos</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span>
</span><a name="line-749"></a><span>                                 </span><span class="hs-special">}</span><span>
</span><a name="line-750"></a><span>  </span><span class="hs-comment">-- See Note [Over-saturated matches]</span><span>
</span><a name="line-751"></a><span>
</span><a name="line-752"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-753"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-var">FamInstMatch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873192"><a href="#local-6989586621682873192"><span class="hs-identifier">inst</span></a></a><span>
</span><a name="line-754"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_tys</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873193"><a href="#local-6989586621682873193"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-755"></a><span>                    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_cos</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873194"><a href="#local-6989586621682873194"><span class="hs-identifier">cos</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;match with&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873192"><span class="hs-identifier hs-var">inst</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873193"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682873194"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span class="hs-identifier">lookupFamInstEnvByTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span class="hs-special">]</span><span>
</span><a name="line-759"></a><a name="lookupFamInstEnvByTyCon"><a href="FamInstEnv.html#lookupFamInstEnvByTyCon"><span class="hs-identifier">lookupFamInstEnvByTyCon</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682873307"><a href="#local-6989586621682873307"><span class="hs-identifier">pkg_ie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873308"><a href="#local-6989586621682873308"><span class="hs-identifier">home_ie</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682873309"><a href="#local-6989586621682873309"><span class="hs-identifier">fam_tc</span></a></a><span>
</span><a name="line-760"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873310"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682873307"><span class="hs-identifier hs-var">pkg_ie</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682873310"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682873308"><span class="hs-identifier hs-var">home_ie</span></a><span>
</span><a name="line-761"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-762"></a><span>    </span><a name="local-6989586621682873310"><a href="#local-6989586621682873310"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621682873311"><a href="#local-6989586621682873311"><span class="hs-identifier">ie</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621682873311"><span class="hs-identifier hs-var">ie</span></a><span> </span><a href="#local-6989586621682873309"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-763"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-764"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><a name="local-6989586621682873312"><a href="#local-6989586621682873312"><span class="hs-identifier">fis</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873312"><span class="hs-identifier hs-var">fis</span></a><span>
</span><a name="line-765"></a><span>
</span><a name="line-766"></a><span class="hs-identifier">lookupFamInstEnv</span><span>
</span><a name="line-767"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-768"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- What we are looking for</span><span>
</span><a name="line-769"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Successful matches</span><span>
</span><a name="line-770"></a><span class="hs-comment">-- Precondition: the tycon is saturated (or over-saturated)</span><span>
</span><a name="line-771"></a><span>
</span><a name="line-772"></a><a name="lookupFamInstEnv"><a href="FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier">lookupFamInstEnv</span></a></a><span>
</span><a name="line-773"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#lookup_fam_inst_env"><span class="hs-identifier hs-var">lookup_fam_inst_env</span></a><span> </span><a href="#local-6989586621682873313"><span class="hs-identifier hs-var">match</span></a><span>
</span><a name="line-774"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-775"></a><span>     </span><a name="local-6989586621682873313"><a href="#local-6989586621682873313"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873314"><a href="#local-6989586621682873314"><span class="hs-identifier">tpl_tys</span></a></a><span> </span><a name="local-6989586621682873315"><a href="#local-6989586621682873315"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a><span> </span><a href="#local-6989586621682873314"><span class="hs-identifier hs-var">tpl_tys</span></a><span> </span><a href="#local-6989586621682873315"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span class="hs-identifier">lookupFamInstEnvConflicts</span><span>
</span><a name="line-778"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-779"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span>          </span><span class="hs-comment">-- Putative new instance</span><span>
</span><a name="line-780"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- Conflicting matches (don't look at the fim_tys field)</span><span>
</span><a name="line-781"></a><span class="hs-comment">-- E.g. when we are about to add</span><span>
</span><a name="line-782"></a><span class="hs-comment">--    f : type instance F [a] = a-&gt;a</span><span>
</span><a name="line-783"></a><span class="hs-comment">-- we do (lookupFamInstConflicts f [b])</span><span>
</span><a name="line-784"></a><span class="hs-comment">-- to find conflicting matches</span><span>
</span><a name="line-785"></a><span class="hs-comment">--</span><span>
</span><a name="line-786"></a><span class="hs-comment">-- Precondition: the tycon is saturated (or over-saturated)</span><span>
</span><a name="line-787"></a><span>
</span><a name="line-788"></a><a name="lookupFamInstEnvConflicts"><a href="FamInstEnv.html#lookupFamInstEnvConflicts"><span class="hs-identifier">lookupFamInstEnvConflicts</span></a></a><span> </span><a name="local-6989586621682873316"><a href="#local-6989586621682873316"><span class="hs-identifier">envs</span></a></a><span> </span><a name="local-6989586621682873317"><a href="#local-6989586621682873317"><span class="hs-identifier">fam_inst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873318"><a href="#local-6989586621682873318"><span class="hs-identifier">new_axiom</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-789"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#lookup_fam_inst_env"><span class="hs-identifier hs-var">lookup_fam_inst_env</span></a><span> </span><a href="#local-6989586621682873321"><span class="hs-identifier hs-var">my_unify</span></a><span> </span><a href="#local-6989586621682873316"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621682873319"><span class="hs-identifier hs-var">fam</span></a><span> </span><a href="#local-6989586621682873320"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-790"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-791"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682873319"><a href="#local-6989586621682873319"><span class="hs-identifier">fam</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873320"><a href="#local-6989586621682873320"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#famInstSplitLHS"><span class="hs-identifier hs-var">famInstSplitLHS</span></a><span> </span><a href="#local-6989586621682873317"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-792"></a><span>        </span><span class="hs-comment">-- In example above,   fam tys' = F [b]</span><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span>    </span><a name="local-6989586621682873321"><a href="#local-6989586621682873321"><span class="hs-identifier">my_unify</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873324"><a href="#local-6989586621682873324"><span class="hs-identifier">old_axiom</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682873325"><a href="#local-6989586621682873325"><span class="hs-identifier">tpl_tvs</span></a></a><span> </span><a name="local-6989586621682873326"><a href="#local-6989586621682873326"><span class="hs-identifier">tpl_tys</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-795"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">tyCoVarsOfTypes</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">disjointVarSet</span><span class="hs-special">`</span><span> </span><a href="VarSet.html#disjointVarSet"><span class="hs-identifier hs-var">tpl_tvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-796"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">fam</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">tys</span><span class="hs-special">)</span><span> </span><span class="hs-operator">$$</span><span>
</span><a name="line-797"></a><span>                  </span><span class="hs-special">(</span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">tpl_tvs</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">tpl_tys</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-798"></a><span>                </span><span class="hs-comment">-- Unification will break badly if the variables overlap</span><span>
</span><a name="line-799"></a><span>                </span><span class="hs-comment">-- They shouldn't because we allocate separate uniques for them</span><span>
</span><a name="line-800"></a><span>         </span><span class="hs-keyword">if</span><span> </span><a href="FamInstEnv.html#compatibleBranches"><span class="hs-identifier hs-var">compatibleBranches</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><a href="#local-6989586621682873324"><span class="hs-identifier hs-var">old_axiom</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873323"><span class="hs-identifier hs-var">new_branch</span></a><span>
</span><a name="line-801"></a><span>           </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-802"></a><span>           </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682873322"><span class="hs-identifier hs-var">noSubst</span></a><span>
</span><a name="line-803"></a><span>      </span><span class="hs-comment">-- Note [Family instance overlap conflicts]</span><span>
</span><a name="line-804"></a><span>
</span><a name="line-805"></a><span>    </span><a name="local-6989586621682873322"><a href="#local-6989586621682873322"><span class="hs-identifier">noSubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;lookupFamInstEnvConflicts noSubst&quot;</span><span>
</span><a name="line-806"></a><span>    </span><a name="local-6989586621682873323"><a href="#local-6989586621682873323"><span class="hs-identifier">new_branch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><a href="#local-6989586621682873318"><span class="hs-identifier hs-var">new_axiom</span></a><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-809"></a><span class="hs-comment">--                 Type family injectivity checking bits                      --</span><span>
</span><a name="line-810"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-811"></a><span>
</span><a name="line-812"></a><span class="hs-comment">{- Note [Verifying injectivity annotation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Injectivity means that the RHS of a type family uniquely determines the LHS (see
Note [Type inference for type families with injectivity]).  User informs about
injectivity using an injectivity annotation and it is GHC's task to verify that
that annotation is correct wrt. to type family equations. Whenever we see a new
equation of a type family we need to make sure that adding this equation to
already known equations of a type family does not violate injectivity annotation
supplied by the user (see Note [Injectivity annotation]).  Of course if the type
family has no injectivity annotation then no check is required.  But if a type
family has injectivity annotation we need to make sure that the following
conditions hold:

1. For each pair of *different* equations of a type family, one of the following
   conditions holds:

   A:  RHSs are different.

   B1: OPEN TYPE FAMILIES: If the RHSs can be unified under some substitution
       then it must be possible to unify the LHSs under the same substitution.
       Example:

          type family FunnyId a = r | r -&gt; a
          type instance FunnyId Int = Int
          type instance FunnyId a = a

       RHSs of these two equations unify under [ a |-&gt; Int ] substitution.
       Under this substitution LHSs are equal therefore these equations don't
       violate injectivity annotation.

   B2: CLOSED TYPE FAMILIES: If the RHSs can be unified under some
       substitution then either the LHSs unify under the same substitution or
       the LHS of the latter equation is overlapped by earlier equations.
       Example 1:

          type family SwapIntChar a = r | r -&gt; a where
              SwapIntChar Int  = Char
              SwapIntChar Char = Int
              SwapIntChar a    = a

       Say we are checking the last two equations. RHSs unify under [ a |-&gt;
       Int ] substitution but LHSs don't. So we apply the substitution to LHS
       of last equation and check whether it is overlapped by any of previous
       equations. Since it is overlapped by the first equation we conclude
       that pair of last two equations does not violate injectivity
       annotation.

   A special case of B is when RHSs unify with an empty substitution ie. they
   are identical.

   If any of the above two conditions holds we conclude that the pair of
   equations does not violate injectivity annotation. But if we find a pair
   of equations where neither of the above holds we report that this pair
   violates injectivity annotation because for a given RHS we don't have a
   unique LHS. (Note that (B) actually implies (A).)

   Note that we only take into account these LHS patterns that were declared
   as injective.

2. If a RHS of a type family equation is a bare type variable then
   all LHS variables (including implicit kind variables) also have to be bare.
   In other words, this has to be a sole equation of that type family and it has
   to cover all possible patterns.  So for example this definition will be
   rejected:

      type family W1 a = r | r -&gt; a
      type instance W1 [a] = a

   If it were accepted we could call `W1 [W1 Int]`, which would reduce to
   `W1 Int` and then by injectivity we could conclude that `[W1 Int] ~ Int`,
   which is bogus.

3. If a RHS of a type family equation is a type family application then the type
   family is rejected as not injective.

4. If a LHS type variable that is declared as injective is not mentioned on
   injective position in the RHS then the type family is rejected as not
   injective.  &quot;Injective position&quot; means either an argument to a type
   constructor or argument to a type family on injective position.

See also Note [Injective type families] in TyCon
-}</span><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span>
</span><a name="line-897"></a><span class="hs-comment">-- | Check whether an open type family equation can be added to already existing</span><span>
</span><a name="line-898"></a><span class="hs-comment">-- instance environment without causing conflicts with supplied injectivity</span><span>
</span><a name="line-899"></a><span class="hs-comment">-- annotations.  Returns list of conflicting axioms (type instance</span><span>
</span><a name="line-900"></a><span class="hs-comment">-- declarations).</span><span>
</span><a name="line-901"></a><span class="hs-identifier">lookupFamInstEnvInjectivityConflicts</span><span>
</span><a name="line-902"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- injectivity annotation for this type family instance</span><span>
</span><a name="line-903"></a><span>                      </span><span class="hs-comment">-- INVARIANT: list contains at least one True value</span><span>
</span><a name="line-904"></a><span>    </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>   </span><span class="hs-comment">-- all type instances seens so far</span><span>
</span><a name="line-905"></a><span>    </span><span class="hs-glyph">-&gt;</span><span>  </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span>       </span><span class="hs-comment">-- new type instance that we're checking</span><span>
</span><a name="line-906"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- conflicting instance declarations</span><span>
</span><a name="line-907"></a><a name="lookupFamInstEnvInjectivityConflicts"><a href="FamInstEnv.html#lookupFamInstEnvInjectivityConflicts"><span class="hs-identifier">lookupFamInstEnvInjectivityConflicts</span></a></a><span> </span><a name="local-6989586621682873327"><a href="#local-6989586621682873327"><span class="hs-identifier">injList</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682873328"><a href="#local-6989586621682873328"><span class="hs-identifier">pkg_ie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873329"><a href="#local-6989586621682873329"><span class="hs-identifier">home_ie</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>                             </span><a name="local-6989586621682873330"><a href="#local-6989586621682873330"><span class="hs-identifier">fam_inst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873331"><a href="#local-6989586621682873331"><span class="hs-identifier">new_axiom</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-909"></a><span>  </span><span class="hs-comment">-- See Note [Verifying injectivity annotation]. This function implements</span><span>
</span><a name="line-910"></a><span>  </span><span class="hs-comment">-- check (1.B1) for open type families described there.</span><span>
</span><a name="line-911"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873335"><span class="hs-identifier hs-var">lookup_inj_fam_conflicts</span></a><span> </span><a href="#local-6989586621682873329"><span class="hs-identifier hs-var">home_ie</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682873335"><span class="hs-identifier hs-var">lookup_inj_fam_conflicts</span></a><span> </span><a href="#local-6989586621682873328"><span class="hs-identifier hs-var">pkg_ie</span></a><span>
</span><a name="line-912"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-913"></a><span>      </span><a name="local-6989586621682873332"><a href="#local-6989586621682873332"><span class="hs-identifier">fam</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#famInstTyCon"><span class="hs-identifier hs-var">famInstTyCon</span></a><span> </span><a href="#local-6989586621682873330"><span class="hs-identifier hs-var">fam_inst</span></a><span>
</span><a name="line-914"></a><span>      </span><a name="local-6989586621682873333"><a href="#local-6989586621682873333"><span class="hs-identifier">new_branch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><a href="#local-6989586621682873331"><span class="hs-identifier hs-var">new_axiom</span></a><span>
</span><a name="line-915"></a><span>
</span><a name="line-916"></a><span>      </span><span class="hs-comment">-- filtering function used by `lookup_inj_fam_conflicts` to check whether</span><span>
</span><a name="line-917"></a><span>      </span><span class="hs-comment">-- a pair of equations conflicts with the injectivity annotation.</span><span>
</span><a name="line-918"></a><span>      </span><a name="local-6989586621682873334"><a href="#local-6989586621682873334"><span class="hs-identifier">isInjConflict</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873336"><a href="#local-6989586621682873336"><span class="hs-identifier">old_axiom</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="FamInstEnv.html#InjectivityAccepted"><span class="hs-identifier hs-var">InjectivityAccepted</span></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-920"></a><span>            </span><a href="FamInstEnv.html#injectiveBranches"><span class="hs-identifier hs-var">injectiveBranches</span></a><span> </span><a href="#local-6989586621682873327"><span class="hs-identifier hs-var">injList</span></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><a href="#local-6989586621682873336"><span class="hs-identifier hs-var">old_axiom</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873333"><span class="hs-identifier hs-var">new_branch</span></a><span>
</span><a name="line-921"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- no conflict</span><span>
</span><a name="line-922"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-923"></a><span>
</span><a name="line-924"></a><span>      </span><a name="local-6989586621682873335"><a href="#local-6989586621682873335"><span class="hs-identifier">lookup_inj_fam_conflicts</span></a></a><span> </span><a name="local-6989586621682873337"><a href="#local-6989586621682873337"><span class="hs-identifier">ie</span></a></a><span>
</span><a name="line-925"></a><span>          </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isOpenFamilyTyCon"><span class="hs-identifier hs-var">isOpenFamilyTyCon</span></a><span> </span><a href="#local-6989586621682873332"><span class="hs-identifier hs-var">fam</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><a name="local-6989586621682873338"><a href="#local-6989586621682873338"><span class="hs-identifier">insts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621682873337"><span class="hs-identifier hs-var">ie</span></a><span> </span><a href="#local-6989586621682873332"><span class="hs-identifier hs-var">fam</span></a><span>
</span><a name="line-926"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#coAxiomSingleBranch"><span class="hs-identifier hs-var">coAxiomSingleBranch</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">fi_axiom</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-927"></a><span>            </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621682873334"><span class="hs-identifier hs-var">isInjConflict</span></a><span> </span><a href="#local-6989586621682873338"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-928"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-929"></a><span>
</span><a name="line-930"></a><span>
</span><a name="line-931"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-932"></a><span class="hs-comment">--                    Type family overlap checking bits                       --</span><span>
</span><a name="line-933"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-934"></a><span>
</span><a name="line-935"></a><span class="hs-comment">{-
Note [Family instance overlap conflicts]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
- In the case of data family instances, any overlap is fundamentally a
  conflict (as these instances imply injective type mappings).

- In the case of type family instances, overlap is admitted as long as
  the right-hand sides of the overlapping rules coincide under the
  overlap substitution.  eg
       type instance F a Int = a
       type instance F Int b = b
  These two overlap on (F Int Int) but then both RHSs are Int,
  so all is well. We require that they are syntactically equal;
  anything else would be difficult to test for at this stage.
-}</span><span>
</span><a name="line-950"></a><span>
</span><a name="line-951"></a><span class="hs-comment">------------------------------------------------------------</span><span>
</span><a name="line-952"></a><span class="hs-comment">-- Might be a one-way match or a unifier</span><span>
</span><a name="line-953"></a><span class="hs-keyword">type</span><span> </span><a name="MatchFun"><a href="FamInstEnv.html#MatchFun"><span class="hs-identifier">MatchFun</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a><span>                </span><span class="hs-comment">-- The FamInst template</span><span>
</span><a name="line-954"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#TyVarSet"><span class="hs-identifier hs-type">TyVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">--   fi_tvs, fi_tys of that FamInst</span><span>
</span><a name="line-955"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>                 </span><span class="hs-comment">-- Target to match against</span><span>
</span><a name="line-956"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-957"></a><span>
</span><a name="line-958"></a><span class="hs-identifier">lookup_fam_inst_env'</span><span>          </span><span class="hs-comment">-- The worker, local to this module</span><span>
</span><a name="line-959"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#MatchFun"><span class="hs-identifier hs-type">MatchFun</span></a><span>
</span><a name="line-960"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInstEnv"><span class="hs-identifier hs-type">FamInstEnv</span></a><span>
</span><a name="line-961"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- What we are looking for</span><span>
</span><a name="line-962"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a><span class="hs-special">]</span><span>
</span><a name="line-963"></a><a name="lookup_fam_inst_env%27"><a href="FamInstEnv.html#lookup_fam_inst_env%27"><span class="hs-identifier">lookup_fam_inst_env'</span></a></a><span> </span><a name="local-6989586621682873339"><a href="#local-6989586621682873339"><span class="hs-identifier">match_fun</span></a></a><span> </span><a name="local-6989586621682873340"><a href="#local-6989586621682873340"><span class="hs-identifier">ie</span></a></a><span> </span><a name="local-6989586621682873341"><a href="#local-6989586621682873341"><span class="hs-identifier">fam</span></a></a><span> </span><a name="local-6989586621682873342"><a href="#local-6989586621682873342"><span class="hs-identifier">match_tys</span></a></a><span>
</span><a name="line-964"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isOpenFamilyTyCon"><span class="hs-identifier hs-var">isOpenFamilyTyCon</span></a><span> </span><a href="#local-6989586621682873341"><span class="hs-identifier hs-var">fam</span></a><span>
</span><a name="line-965"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamIE"><span class="hs-identifier hs-var">FamIE</span></a><span> </span><a name="local-6989586621682873362"><a href="#local-6989586621682873362"><span class="hs-identifier">insts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621682873340"><span class="hs-identifier hs-var">ie</span></a><span> </span><a href="#local-6989586621682873341"><span class="hs-identifier hs-var">fam</span></a><span>
</span><a name="line-966"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873343"><span class="hs-identifier hs-var">find</span></a><span> </span><a href="#local-6989586621682873362"><span class="hs-identifier hs-var">insts</span></a><span>    </span><span class="hs-comment">-- The common case</span><span>
</span><a name="line-967"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-968"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span>    </span><a name="local-6989586621682873343"><a href="#local-6989586621682873343"><span class="hs-identifier">find</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-971"></a><span>    </span><span class="hs-identifier">find</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873348"><a href="#local-6989586621682873348"><span class="hs-identifier">item</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_tcs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873349"><a href="#local-6989586621682873349"><span class="hs-identifier">mb_tcs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873350"><a href="#local-6989586621682873350"><span class="hs-identifier">tpl_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873351"><a href="#local-6989586621682873351"><span class="hs-identifier">tpl_cvs</span></a></a><span>
</span><a name="line-972"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fi_tys</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873352"><a href="#local-6989586621682873352"><span class="hs-identifier">tpl_tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682873353"><a href="#local-6989586621682873353"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-973"></a><span>        </span><span class="hs-comment">-- Fast check for no match, uses the &quot;rough match&quot; fields</span><span>
</span><a name="line-974"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Unify.html#instanceCantMatch"><span class="hs-identifier hs-var">instanceCantMatch</span></a><span> </span><a href="#local-6989586621682873354"><span class="hs-identifier hs-var">rough_tcs</span></a><span> </span><a href="#local-6989586621682873349"><span class="hs-identifier hs-var">mb_tcs</span></a><span>
</span><a name="line-975"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873343"><span class="hs-identifier hs-var">find</span></a><span> </span><a href="#local-6989586621682873353"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span>        </span><span class="hs-comment">-- Proper check</span><span>
</span><a name="line-978"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873357"><a href="#local-6989586621682873357"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873339"><span class="hs-identifier hs-var">match_fun</span></a><span> </span><a href="#local-6989586621682873348"><span class="hs-identifier hs-var">item</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621682873350"><span class="hs-identifier hs-var">tpl_tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873352"><span class="hs-identifier hs-var">tpl_tys</span></a><span> </span><a href="#local-6989586621682873355"><span class="hs-identifier hs-var">match_tys1</span></a><span>
</span><a name="line-979"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-var">FamInstMatch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873348"><span class="hs-identifier hs-var">item</span></a><span>
</span><a name="line-980"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_tys</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyVars"><span class="hs-identifier hs-var">substTyVars</span></a><span> </span><a href="#local-6989586621682873357"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873350"><span class="hs-identifier hs-var">tpl_tvs</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873356"><span class="hs-identifier hs-var">match_tys2</span></a><span>
</span><a name="line-981"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_cos</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isJust</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">lookupCoVar</span><span> </span><span class="hs-identifier">subst</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">tpl_cvs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>                                       </span><a href="TyCoRep.html#substCoVars"><span class="hs-identifier hs-var">substCoVars</span></a><span> </span><a href="#local-6989586621682873357"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873351"><span class="hs-identifier hs-var">tpl_cvs</span></a><span>
</span><a name="line-983"></a><span>                      </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>        </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682873343"><span class="hs-identifier hs-var">find</span></a><span> </span><a href="#local-6989586621682873353"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-985"></a><span>
</span><a name="line-986"></a><span>        </span><span class="hs-comment">-- No match =&gt; try next</span><span>
</span><a name="line-987"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-988"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873343"><span class="hs-identifier hs-var">find</span></a><span> </span><a href="#local-6989586621682873353"><span class="hs-identifier hs-var">rest</span></a><span>
</span><a name="line-989"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-990"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621682873354"><a href="#local-6989586621682873354"><span class="hs-identifier">rough_tcs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873355"><a href="#local-6989586621682873355"><span class="hs-identifier">match_tys1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873356"><a href="#local-6989586621682873356"><span class="hs-identifier">match_tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873344"><span class="hs-identifier hs-var">split_tys</span></a><span> </span><a href="#local-6989586621682873352"><span class="hs-identifier hs-var">tpl_tys</span></a><span>
</span><a name="line-991"></a><span>
</span><a name="line-992"></a><span>      </span><span class="hs-comment">-- Precondition: the tycon is saturated (or over-saturated)</span><span>
</span><a name="line-993"></a><span>
</span><a name="line-994"></a><span>    </span><span class="hs-comment">-- Deal with over-saturation</span><span>
</span><a name="line-995"></a><span>    </span><span class="hs-comment">-- See Note [Over-saturated matches]</span><span>
</span><a name="line-996"></a><span>    </span><a name="local-6989586621682873344"><a href="#local-6989586621682873344"><span class="hs-identifier">split_tys</span></a></a><span> </span><a name="local-6989586621682873358"><a href="#local-6989586621682873358"><span class="hs-identifier">tpl_tys</span></a></a><span>
</span><a name="line-997"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-6989586621682873341"><span class="hs-identifier hs-var">fam</span></a><span>
</span><a name="line-998"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873347"><span class="hs-identifier hs-var">pre_rough_split_tys</span></a><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1001"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873359"><a href="#local-6989586621682873359"><span class="hs-identifier">match_tys1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873360"><a href="#local-6989586621682873360"><span class="hs-identifier">match_tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-6989586621682873358"><span class="hs-identifier hs-var">tpl_tys</span></a><span> </span><a href="#local-6989586621682873342"><span class="hs-identifier hs-var">match_tys</span></a><span>
</span><a name="line-1002"></a><span>            </span><a name="local-6989586621682873361"><a href="#local-6989586621682873361"><span class="hs-identifier">rough_tcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Unify.html#roughMatchTcs"><span class="hs-identifier hs-var">roughMatchTcs</span></a><span> </span><a href="#local-6989586621682873359"><span class="hs-identifier hs-var">match_tys1</span></a><span>
</span><a name="line-1003"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873361"><span class="hs-identifier hs-var">rough_tcs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873359"><span class="hs-identifier hs-var">match_tys1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873360"><span class="hs-identifier hs-var">match_tys2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1004"></a><span>
</span><a name="line-1005"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682873345"><a href="#local-6989586621682873345"><span class="hs-identifier">pre_match_tys1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873346"><a href="#local-6989586621682873346"><span class="hs-identifier">pre_match_tys2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621682873341"><span class="hs-identifier hs-var">fam</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873342"><span class="hs-identifier hs-var">match_tys</span></a><span>
</span><a name="line-1006"></a><span>    </span><a name="local-6989586621682873347"><a href="#local-6989586621682873347"><span class="hs-identifier">pre_rough_split_tys</span></a></a><span>
</span><a name="line-1007"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Unify.html#roughMatchTcs"><span class="hs-identifier hs-var">roughMatchTcs</span></a><span> </span><a href="#local-6989586621682873345"><span class="hs-identifier hs-var">pre_match_tys1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873345"><span class="hs-identifier hs-var">pre_match_tys1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873346"><span class="hs-identifier hs-var">pre_match_tys2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1008"></a><span>
</span><a name="line-1009"></a><span class="hs-identifier">lookup_fam_inst_env</span><span>           </span><span class="hs-comment">-- The worker, local to this module</span><span>
</span><a name="line-1010"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#MatchFun"><span class="hs-identifier hs-type">MatchFun</span></a><span>
</span><a name="line-1011"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-1012"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- What we are looking for</span><span>
</span><a name="line-1013"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-type">FamInstMatch</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Successful matches</span><span>
</span><a name="line-1014"></a><span>
</span><a name="line-1015"></a><span class="hs-comment">-- Precondition: the tycon is saturated (or over-saturated)</span><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><a name="lookup_fam_inst_env"><a href="FamInstEnv.html#lookup_fam_inst_env"><span class="hs-identifier">lookup_fam_inst_env</span></a></a><span> </span><a name="local-6989586621682873363"><a href="#local-6989586621682873363"><span class="hs-identifier">match_fun</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682873364"><a href="#local-6989586621682873364"><span class="hs-identifier">pkg_ie</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873365"><a href="#local-6989586621682873365"><span class="hs-identifier">home_ie</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682873366"><a href="#local-6989586621682873366"><span class="hs-identifier">fam</span></a></a><span> </span><a name="local-6989586621682873367"><a href="#local-6989586621682873367"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1018"></a><span>  </span><span class="hs-glyph">=</span><span>  </span><a href="FamInstEnv.html#lookup_fam_inst_env%27"><span class="hs-identifier hs-var">lookup_fam_inst_env'</span></a><span> </span><a href="#local-6989586621682873363"><span class="hs-identifier hs-var">match_fun</span></a><span> </span><a href="#local-6989586621682873365"><span class="hs-identifier hs-var">home_ie</span></a><span> </span><a href="#local-6989586621682873366"><span class="hs-identifier hs-var">fam</span></a><span> </span><a href="#local-6989586621682873367"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1019"></a><span>  </span><span class="hs-operator hs-var">++</span><span> </span><a href="FamInstEnv.html#lookup_fam_inst_env%27"><span class="hs-identifier hs-var">lookup_fam_inst_env'</span></a><span> </span><a href="#local-6989586621682873363"><span class="hs-identifier hs-var">match_fun</span></a><span> </span><a href="#local-6989586621682873364"><span class="hs-identifier hs-var">pkg_ie</span></a><span>  </span><a href="#local-6989586621682873366"><span class="hs-identifier hs-var">fam</span></a><span> </span><a href="#local-6989586621682873367"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1020"></a><span>
</span><a name="line-1021"></a><span class="hs-comment">{-
Note [Over-saturated matches]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's ok to look up an over-saturated type constructor.  E.g.
     type family F a :: * -&gt; *
     type instance F (a,b) = Either (a-&gt;b)

The type instance gives rise to a newtype TyCon (at a higher kind
which you can't do in Haskell!):
     newtype FPair a b = FP (Either (a-&gt;b))

Then looking up (F (Int,Bool) Char) will return a FamInstMatch
     (FPair, [Int,Bool,Char])
The &quot;extra&quot; type argument [Char] just stays on the end.

We handle data families and type families separately here:

 * For type families, all instances of a type family must have the
   same arity, so we can precompute the split between the match_tys
   and the overflow tys. This is done in pre_rough_split_tys.

 * For data family instances, though, we need to re-split for each
   instance, because the breakdown might be different for each
   instance.  Why?  Because of eta reduction; see
   Note [Eta reduction for data families].
-}</span><span>
</span><a name="line-1047"></a><span>
</span><a name="line-1048"></a><span class="hs-comment">-- checks if one LHS is dominated by a list of other branches</span><span>
</span><a name="line-1049"></a><span class="hs-comment">-- in other words, if an application would match the first LHS, it is guaranteed</span><span>
</span><a name="line-1050"></a><span class="hs-comment">-- to match at least one of the others. The RHSs are ignored.</span><span>
</span><a name="line-1051"></a><span class="hs-comment">-- This algorithm is conservative:</span><span>
</span><a name="line-1052"></a><span class="hs-comment">--   True -&gt; the LHS is definitely covered by the others</span><span>
</span><a name="line-1053"></a><span class="hs-comment">--   False -&gt; no information</span><span>
</span><a name="line-1054"></a><span class="hs-comment">-- It is currently (Oct 2012) used only for generating errors for</span><span>
</span><a name="line-1055"></a><span class="hs-comment">-- inaccessible branches. If these errors go unreported, no harm done.</span><span>
</span><a name="line-1056"></a><span class="hs-comment">-- This is defined here to avoid a dependency from CoAxiom to Unify</span><span>
</span><a name="line-1057"></a><span class="hs-identifier">isDominatedBy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1058"></a><a name="isDominatedBy"><a href="FamInstEnv.html#isDominatedBy"><span class="hs-identifier">isDominatedBy</span></a></a><span> </span><a name="local-6989586621682873368"><a href="#local-6989586621682873368"><span class="hs-identifier">branch</span></a></a><span> </span><a name="local-6989586621682873369"><a href="#local-6989586621682873369"><span class="hs-identifier">branches</span></a></a><span>
</span><a name="line-1059"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">or</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682873371"><span class="hs-identifier hs-var">match</span></a><span> </span><a href="#local-6989586621682873369"><span class="hs-identifier hs-var">branches</span></a><span>
</span><a name="line-1060"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1061"></a><span>      </span><a name="local-6989586621682873370"><a href="#local-6989586621682873370"><span class="hs-identifier">lhs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a><span> </span><a href="#local-6989586621682873368"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-1062"></a><span>      </span><a name="local-6989586621682873371"><a href="#local-6989586621682873371"><span class="hs-identifier">match</span></a></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873372"><a href="#local-6989586621682873372"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1063"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a><span> </span><a href="#local-6989586621682873372"><span class="hs-identifier hs-var">tys</span></a><span> </span><a href="#local-6989586621682873370"><span class="hs-identifier hs-var">lhs</span></a><span>
</span><a name="line-1064"></a><span>
</span><a name="line-1065"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Choosing an axiom application
*                                                                      *
************************************************************************

The lookupFamInstEnv function does a nice job for *open* type families,
but we also need to handle closed ones when normalising a type:
-}</span><span>
</span><a name="line-1075"></a><span>
</span><a name="line-1076"></a><span class="hs-identifier">reduceTyFamApp_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-1077"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>              </span><span class="hs-comment">-- Desired role of result coercion</span><span>
</span><a name="line-1078"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-1079"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1080"></a><span class="hs-comment">-- Attempt to do a *one-step* reduction of a type-family application</span><span>
</span><a name="line-1081"></a><span class="hs-comment">--    but *not* newtypes</span><span>
</span><a name="line-1082"></a><span class="hs-comment">-- Works on type-synonym families always; data-families only if</span><span>
</span><a name="line-1083"></a><span class="hs-comment">--     the role we seek is representational</span><span>
</span><a name="line-1084"></a><span class="hs-comment">-- It does *not* normlise the type arguments first, so this may not</span><span>
</span><a name="line-1085"></a><span class="hs-comment">--     go as far as you want. If you want normalised type arguments,</span><span>
</span><a name="line-1086"></a><span class="hs-comment">--     use normaliseTcArgs first.</span><span>
</span><a name="line-1087"></a><span class="hs-comment">--</span><span>
</span><a name="line-1088"></a><span class="hs-comment">-- The TyCon can be oversaturated.</span><span>
</span><a name="line-1089"></a><span class="hs-comment">-- Works on both open and closed families</span><span>
</span><a name="line-1090"></a><span class="hs-comment">--</span><span>
</span><a name="line-1091"></a><span class="hs-comment">-- Always returns a *homogeneous* coercion -- type family reductions are always</span><span>
</span><a name="line-1092"></a><span class="hs-comment">-- homogeneous</span><span>
</span><a name="line-1093"></a><a name="reduceTyFamApp_maybe"><a href="FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier">reduceTyFamApp_maybe</span></a></a><span> </span><a name="local-6989586621682873373"><a href="#local-6989586621682873373"><span class="hs-identifier">envs</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682873375"><a href="#local-6989586621682873375"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873376"><a href="#local-6989586621682873376"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1094"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-1095"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1096"></a><span>
</span><a name="line-1097"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1098"></a><span>      </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#isOpenFamilyTyCon"><span class="hs-identifier hs-var">isOpenFamilyTyCon</span></a><span>     </span><a href="#local-6989586621682873375"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1099"></a><span>      </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#isOpenTypeFamilyTyCon"><span class="hs-identifier hs-var">isOpenTypeFamilyTyCon</span></a><span> </span><a href="#local-6989586621682873375"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1100"></a><span>       </span><span class="hs-comment">-- If we seek a representational coercion</span><span>
</span><a name="line-1101"></a><span>       </span><span class="hs-comment">-- (e.g. the call in topNormaliseType_maybe) then we can</span><span>
</span><a name="line-1102"></a><span>       </span><span class="hs-comment">-- unwrap data families as well as type-synonym families;</span><span>
</span><a name="line-1103"></a><span>       </span><span class="hs-comment">-- otherwise only type-synonym families</span><span>
</span><a name="line-1104"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FamInstEnv.html#FamInstMatch"><span class="hs-identifier hs-var">FamInstMatch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fim_instance</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#FamInst"><span class="hs-identifier hs-var">FamInst</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fi_axiom</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873377"><a href="#local-6989586621682873377"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1105"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_tys</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873378"><a href="#local-6989586621682873378"><span class="hs-identifier">inst_tys</span></a></a><span>
</span><a name="line-1106"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fim_cos</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873379"><a href="#local-6989586621682873379"><span class="hs-identifier">inst_cos</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#lookupFamInstEnv"><span class="hs-identifier hs-var">lookupFamInstEnv</span></a><span> </span><a href="#local-6989586621682873373"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621682873375"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873376"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1107"></a><span>      </span><span class="hs-comment">-- NB: Allow multiple matches because of compatible overlap</span><span>
</span><a name="line-1108"></a><span>
</span><a name="line-1109"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873380"><a href="#local-6989586621682873380"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkUnbranchedAxInstCo"><span class="hs-identifier hs-var">mkUnbranchedAxInstCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682873377"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682873378"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="#local-6989586621682873379"><span class="hs-identifier hs-var">inst_cos</span></a><span>
</span><a name="line-1110"></a><span>        </span><a name="local-6989586621682873381"><a href="#local-6989586621682873381"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pSnd</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682873380"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1111"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873380"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873381"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1112"></a><span>
</span><a name="line-1113"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873382"><a href="#local-6989586621682873382"><span class="hs-identifier">ax</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#isClosedSynFamilyTyConWithAxiom_maybe"><span class="hs-identifier hs-var">isClosedSynFamilyTyConWithAxiom_maybe</span></a><span> </span><a href="#local-6989586621682873375"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1114"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873383"><a href="#local-6989586621682873383"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873384"><a href="#local-6989586621682873384"><span class="hs-identifier">inst_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873385"><a href="#local-6989586621682873385"><span class="hs-identifier">inst_cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#chooseBranch"><span class="hs-identifier hs-var">chooseBranch</span></a><span> </span><a href="#local-6989586621682873382"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682873376"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1115"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873386"><a href="#local-6989586621682873386"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAxInstCo"><span class="hs-identifier hs-var">mkAxInstCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682873382"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682873383"><span class="hs-identifier hs-var">ind</span></a><span> </span><a href="#local-6989586621682873384"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><a href="#local-6989586621682873385"><span class="hs-identifier hs-var">inst_cos</span></a><span>
</span><a name="line-1116"></a><span>        </span><a name="local-6989586621682873387"><a href="#local-6989586621682873387"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pSnd</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682873386"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1117"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873386"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873387"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1118"></a><span>
</span><a name="line-1119"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873388"><a href="#local-6989586621682873388"><span class="hs-identifier">ax</span></a></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#isBuiltInSynFamTyCon_maybe"><span class="hs-identifier hs-var">isBuiltInSynFamTyCon_maybe</span></a><span> </span><a href="#local-6989586621682873375"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1120"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873389"><a href="#local-6989586621682873389"><span class="hs-identifier">coax</span></a></a><span class="hs-special">,</span><a name="local-6989586621682873390"><a href="#local-6989586621682873390"><span class="hs-identifier">ts</span></a></a><span class="hs-special">,</span><a name="local-6989586621682873391"><a href="#local-6989586621682873391"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">sfMatchFam</span><span> </span><a href="#local-6989586621682873388"><span class="hs-identifier hs-var">ax</span></a><span> </span><a href="#local-6989586621682873376"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1121"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873392"><a href="#local-6989586621682873392"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAxiomRuleCo"><span class="hs-identifier hs-var">mkAxiomRuleCo</span></a><span> </span><a href="#local-6989586621682873389"><span class="hs-identifier hs-var">coax</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">coaxrAsmpRoles</span><span> </span><a href="#local-6989586621682873389"><span class="hs-identifier hs-var">coax</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873390"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1122"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873392"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873391"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1123"></a><span>
</span><a name="line-1124"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1125"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1126"></a><span>
</span><a name="line-1127"></a><span class="hs-comment">-- The axiom can be oversaturated. (Closed families only.)</span><span>
</span><a name="line-1128"></a><span class="hs-identifier">chooseBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#CoAxiom"><span class="hs-identifier hs-type">CoAxiom</span></a><span> </span><a href="CoAxiom.html#Branched"><span class="hs-identifier hs-type">Branched</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-1129"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- found match, with args</span><span>
</span><a name="line-1130"></a><a name="chooseBranch"><a href="FamInstEnv.html#chooseBranch"><span class="hs-identifier">chooseBranch</span></a></a><span> </span><a name="local-6989586621682873393"><a href="#local-6989586621682873393"><span class="hs-identifier">axiom</span></a></a><span> </span><a name="local-6989586621682873394"><a href="#local-6989586621682873394"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1131"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873395"><a href="#local-6989586621682873395"><span class="hs-identifier">num_pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomNumPats"><span class="hs-identifier hs-var">coAxiomNumPats</span></a><span> </span><a href="#local-6989586621682873393"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-1132"></a><span>             </span><span class="hs-special">(</span><a name="local-6989586621682873396"><a href="#local-6989586621682873396"><span class="hs-identifier">target_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873397"><a href="#local-6989586621682873397"><span class="hs-identifier">extra_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">splitAt</span><span> </span><a href="#local-6989586621682873395"><span class="hs-identifier hs-var">num_pats</span></a><span> </span><a href="#local-6989586621682873394"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1133"></a><span>             </span><a name="local-6989586621682873398"><a href="#local-6989586621682873398"><span class="hs-identifier">branches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoAxiom.html#coAxiomBranches"><span class="hs-identifier hs-var">coAxiomBranches</span></a><span> </span><a href="#local-6989586621682873393"><span class="hs-identifier hs-var">axiom</span></a><span>
</span><a name="line-1134"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873399"><a href="#local-6989586621682873399"><span class="hs-identifier">ind</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873400"><a href="#local-6989586621682873400"><span class="hs-identifier">inst_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873401"><a href="#local-6989586621682873401"><span class="hs-identifier">inst_cos</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1135"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#findBranch"><span class="hs-identifier hs-var">findBranch</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unMkBranches</span><span> </span><a href="#local-6989586621682873398"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873396"><span class="hs-identifier hs-var">target_tys</span></a><span>
</span><a name="line-1136"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682873399"><span class="hs-identifier hs-var">ind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873400"><span class="hs-identifier hs-var">inst_tys</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873397"><span class="hs-identifier hs-var">extra_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873401"><span class="hs-identifier hs-var">inst_cos</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1137"></a><span>
</span><a name="line-1138"></a><span class="hs-comment">-- The axiom must *not* be oversaturated</span><span>
</span><a name="line-1139"></a><span class="hs-identifier">findBranch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Array</span><span> </span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-1140"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-1141"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1142"></a><span>    </span><span class="hs-comment">-- coercions relate requested types to returned axiom LHS at role N</span><span>
</span><a name="line-1143"></a><a name="findBranch"><a href="FamInstEnv.html#findBranch"><span class="hs-identifier">findBranch</span></a></a><span> </span><a name="local-6989586621682873402"><a href="#local-6989586621682873402"><span class="hs-identifier">branches</span></a></a><span> </span><a name="local-6989586621682873403"><a href="#local-6989586621682873403"><span class="hs-identifier">target_tys</span></a></a><span>
</span><a name="line-1144"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621682873404"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">assocs</span><span> </span><a href="#local-6989586621682873402"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">)</span><span>
</span><a name="line-1145"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1146"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span class="hs-special">)</span><span>
</span><a name="line-1147"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1148"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#BranchIndex"><span class="hs-identifier hs-type">BranchIndex</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1149"></a><span>    </span><a name="local-6989586621682873404"><a href="#local-6989586621682873404"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682873405"><a href="#local-6989586621682873405"><span class="hs-identifier">index</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873406"><a href="#local-6989586621682873406"><span class="hs-identifier">branch</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682873407"><a href="#local-6989586621682873407"><span class="hs-identifier">other</span></a></a><span>
</span><a name="line-1150"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873408"><a href="#local-6989586621682873408"><span class="hs-identifier">tpl_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_cvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873409"><a href="#local-6989586621682873409"><span class="hs-identifier">tpl_cvs</span></a></a><span>
</span><a name="line-1151"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_lhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873410"><a href="#local-6989586621682873410"><span class="hs-identifier">tpl_lhs</span></a></a><span>
</span><a name="line-1152"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">cab_incomps</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873411"><a href="#local-6989586621682873411"><span class="hs-identifier">incomps</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873406"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-1153"></a><span>            </span><a name="local-6989586621682873412"><a href="#local-6989586621682873412"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#unionVarSets"><span class="hs-identifier hs-var">unionVarSets</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1154"></a><span>                            </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CoAxiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873411"><span class="hs-identifier hs-var">incomps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>            </span><span class="hs-comment">-- See Note [Flattening] below</span><span>
</span><a name="line-1156"></a><span>            </span><a name="local-6989586621682873413"><a href="#local-6989586621682873413"><span class="hs-identifier">flattened_target</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#flattenTys"><span class="hs-identifier hs-var">flattenTys</span></a><span> </span><a href="#local-6989586621682873412"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621682873403"><span class="hs-identifier hs-var">target_tys</span></a><span>
</span><a name="line-1157"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a><span> </span><a href="#local-6989586621682873410"><span class="hs-identifier hs-var">tpl_lhs</span></a><span> </span><a href="#local-6989586621682873403"><span class="hs-identifier hs-var">target_tys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1158"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873414"><a href="#local-6989586621682873414"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-comment">-- matching worked. now, check for apartness.</span><span>
</span><a name="line-1159"></a><span>          </span><span class="hs-glyph">|</span><span>  </span><a href="FamInstEnv.html#apartnessCheck"><span class="hs-identifier hs-var">apartnessCheck</span></a><span> </span><a href="#local-6989586621682873413"><span class="hs-identifier hs-var">flattened_target</span></a><span> </span><a href="#local-6989586621682873406"><span class="hs-identifier hs-var">branch</span></a><span>
</span><a name="line-1160"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- matching worked &amp; we're apart from all incompatible branches.</span><span>
</span><a name="line-1161"></a><span>             </span><span class="hs-comment">-- success</span><span>
</span><a name="line-1162"></a><span>             </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isJust</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">lookupCoVar</span><span> </span><span class="hs-identifier">subst</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">tpl_cvs</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1163"></a><span>             </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873405"><span class="hs-identifier hs-var">index</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTyVars"><span class="hs-identifier hs-var">substTyVars</span></a><span> </span><a href="#local-6989586621682873414"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873408"><span class="hs-identifier hs-var">tpl_tvs</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCoVars"><span class="hs-identifier hs-var">substCoVars</span></a><span> </span><a href="#local-6989586621682873414"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873409"><span class="hs-identifier hs-var">tpl_cvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1164"></a><span>
</span><a name="line-1165"></a><span>        </span><span class="hs-comment">-- failure. keep looking</span><span>
</span><a name="line-1166"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873407"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-1167"></a><span>
</span><a name="line-1168"></a><span class="hs-comment">-- | Do an apartness check, as described in the &quot;Closed Type Families&quot; paper</span><span>
</span><a name="line-1169"></a><span class="hs-comment">-- (POPL '14). This should be used when determining if an equation</span><span>
</span><a name="line-1170"></a><span class="hs-comment">-- ('CoAxBranch') of a closed type family can be used to reduce a certain target</span><span>
</span><a name="line-1171"></a><span class="hs-comment">-- type family application.</span><span>
</span><a name="line-1172"></a><span class="hs-identifier">apartnessCheck</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- ^ /flattened/ target arguments. Make sure</span><span>
</span><a name="line-1173"></a><span>                             </span><span class="hs-comment">-- they're flattened! See Note [Flattening].</span><span>
</span><a name="line-1174"></a><span>                             </span><span class="hs-comment">-- (NB: This &quot;flat&quot; is a different</span><span>
</span><a name="line-1175"></a><span>                             </span><span class="hs-comment">-- &quot;flat&quot; than is used in TcFlatten.)</span><span>
</span><a name="line-1176"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span> </span><span class="hs-comment">-- ^ the candidate equation we wish to use</span><span>
</span><a name="line-1177"></a><span>                             </span><span class="hs-comment">-- Precondition: this matches the target</span><span>
</span><a name="line-1178"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>       </span><span class="hs-comment">-- ^ True &lt;=&gt; equation can fire</span><span>
</span><a name="line-1179"></a><a name="apartnessCheck"><a href="FamInstEnv.html#apartnessCheck"><span class="hs-identifier">apartnessCheck</span></a></a><span> </span><a name="local-6989586621682873415"><a href="#local-6989586621682873415"><span class="hs-identifier">flattened_target</span></a></a><span> </span><span class="hs-special">(</span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-var">CoAxBranch</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cab_incomps</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873416"><a href="#local-6989586621682873416"><span class="hs-identifier">incomps</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1180"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873417"><span class="hs-identifier hs-var">isSurelyApart</span></a><span>
</span><a name="line-1181"></a><span>         </span><span class="hs-operator hs-var">.</span><span> </span><a href="Unify.html#tcUnifyTysFG"><span class="hs-identifier hs-var">tcUnifyTysFG</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="Unify.html#BindMe"><span class="hs-identifier hs-var">BindMe</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873415"><span class="hs-identifier hs-var">flattened_target</span></a><span>
</span><a name="line-1182"></a><span>         </span><span class="hs-operator hs-var">.</span><span> </span><a href="CoAxiom.html#coAxBranchLHS"><span class="hs-identifier hs-var">coAxBranchLHS</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873416"><span class="hs-identifier hs-var">incomps</span></a><span>
</span><a name="line-1183"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1184"></a><span>    </span><a name="local-6989586621682873417"><a href="#local-6989586621682873417"><span class="hs-identifier">isSurelyApart</span></a></a><span> </span><a href="Unify.html#SurelyApart"><span class="hs-identifier hs-var">SurelyApart</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1185"></a><span>    </span><span class="hs-identifier">isSurelyApart</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1186"></a><span>
</span><a name="line-1187"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Looking up a family instance
*                                                                      *
************************************************************************

Note [Normalising types]
~~~~~~~~~~~~~~~~~~~~~~~~
The topNormaliseType function removes all occurrences of type families
and newtypes from the top-level structure of a type. normaliseTcApp does
the type family lookup and is fairly straightforward. normaliseType is
a little more involved.

The complication comes from the fact that a type family might be used in the
kind of a variable bound in a forall. We wish to remove this type family
application, but that means coming up with a fresh variable (with the new
kind). Thus, we need a substitution to be built up as we recur through the
type. However, an ordinary TCvSubst just won't do: when we hit a type variable
whose kind has changed during normalisation, we need both the new type
variable *and* the coercion. We could conjure up a new VarEnv with just this
property, but a usable substitution environment already exists:
LiftingContexts from the liftCoSubst family of functions, defined in Coercion.
A LiftingContext maps a type variable to a coercion and a coercion variable to
a pair of coercions. Let's ignore coercion variables for now. Because the
coercion a type variable maps to contains the destination type (via
coercionKind), we don't need to store that destination type separately. Thus,
a LiftingContext has what we need: a map from type variables to (Coercion,
Type) pairs.

We also benefit because we can piggyback on the liftCoSubstVarBndr function to
deal with binders. However, I had to modify that function to work with this
application. Thus, we now have liftCoSubstVarBndrUsing, which takes
a function used to process the kind of the binder. We don't wish
to lift the kind, but instead normalise it. So, we pass in a callback function
that processes the kind of the binder.

After that brilliant explanation of all this, I'm sure you've forgotten the
dangling reference to coercion variables. What do we do with those? Nothing at
all. The point of normalising types is to remove type family applications, but
there's no sense in removing these from coercions. We would just get back a
new coercion witnessing the equality between the same types as the original
coercion. Because coercions are irrelevant anyway, there is no point in doing
this. So, whenever we encounter a coercion, we just say that it won't change.
That's what the CoercionTy case is doing within normalise_type.

Note [Normalisation and type synonyms]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to be a bit careful about normalising in the presence of type
synonyms (Trac #13035).  Suppose S is a type synonym, and we have
   S t1 t2
If S is family-free (on its RHS) we can just normalise t1 and t2 and
reconstruct (S t1' t2').   Expanding S could not reveal any new redexes
because type families are saturated.

But if S has a type family on its RHS we expand /before/ normalising
the args t1, t2.  If we normalise t1, t2 first, we'll re-normalise them
after expansion, and that can lead to /exponential/ behavour; see Trac #13035.

Notice, though, that expanding first can in principle duplicate t1,t2,
which might contain redexes. I'm sure you could conjure up an exponential
case by that route too, but it hasn't happened in practice yet!
-}</span><span>
</span><a name="line-1250"></a><span>
</span><a name="line-1251"></a><span class="hs-identifier">topNormaliseType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-1252"></a><a name="topNormaliseType"><a href="FamInstEnv.html#topNormaliseType"><span class="hs-identifier">topNormaliseType</span></a></a><span> </span><a name="local-6989586621682873418"><a href="#local-6989586621682873418"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682873419"><a href="#local-6989586621682873419"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier hs-var">topNormaliseType_maybe</span></a><span> </span><a href="#local-6989586621682873418"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873419"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1253"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873420"><a href="#local-6989586621682873420"><span class="hs-identifier">_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873421"><a href="#local-6989586621682873421"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873421"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1254"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873419"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1255"></a><span>
</span><a name="line-1256"></a><span class="hs-identifier">topNormaliseType_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1257"></a><span>
</span><a name="line-1258"></a><span class="hs-comment">-- ^ Get rid of *outermost* (or toplevel)</span><span>
</span><a name="line-1259"></a><span class="hs-comment">--      * type function redex</span><span>
</span><a name="line-1260"></a><span class="hs-comment">--      * data family redex</span><span>
</span><a name="line-1261"></a><span class="hs-comment">--      * newtypes</span><span>
</span><a name="line-1262"></a><span class="hs-comment">-- returning an appropriate Representational coercion.  Specifically, if</span><span>
</span><a name="line-1263"></a><span class="hs-comment">--   topNormaliseType_maybe env ty = Just (co, ty')</span><span>
</span><a name="line-1264"></a><span class="hs-comment">-- then</span><span>
</span><a name="line-1265"></a><span class="hs-comment">--   (a) co :: ty ~R ty'</span><span>
</span><a name="line-1266"></a><span class="hs-comment">--   (b) ty' is not a newtype, and is not a type-family or data-family redex</span><span>
</span><a name="line-1267"></a><span class="hs-comment">--</span><span>
</span><a name="line-1268"></a><span class="hs-comment">-- However, ty' can be something like (Maybe (F ty)), where</span><span>
</span><a name="line-1269"></a><span class="hs-comment">-- (F ty) is a redex.</span><span>
</span><a name="line-1270"></a><span class="hs-comment">--</span><span>
</span><a name="line-1271"></a><span class="hs-comment">-- Always operates homogeneously: the returned type has the same kind as the</span><span>
</span><a name="line-1272"></a><span class="hs-comment">-- original type, and the returned coercion is always homogeneous.</span><span>
</span><a name="line-1273"></a><a name="topNormaliseType_maybe"><a href="FamInstEnv.html#topNormaliseType_maybe"><span class="hs-identifier">topNormaliseType_maybe</span></a></a><span> </span><a name="local-6989586621682873422"><a href="#local-6989586621682873422"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682873423"><a href="#local-6989586621682873423"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1274"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621682873443"><a href="#local-6989586621682873443"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873444"><a href="#local-6989586621682873444"><span class="hs-identifier">mkind_co</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682873445"><a href="#local-6989586621682873445"><span class="hs-identifier">nty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#topNormaliseTypeX"><span class="hs-identifier hs-var">topNormaliseTypeX</span></a><span> </span><a href="#local-6989586621682873424"><span class="hs-identifier hs-var">stepper</span></a><span> </span><a href="#local-6989586621682873425"><span class="hs-identifier hs-var">combine</span></a><span> </span><a href="#local-6989586621682873423"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1275"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682873444"><span class="hs-identifier hs-var">mkind_co</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1276"></a><span>           </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873443"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873445"><span class="hs-identifier hs-var">nty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1277"></a><span>           </span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682873446"><a href="#local-6989586621682873446"><span class="hs-identifier">kind_co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873447"><a href="#local-6989586621682873447"><span class="hs-identifier">nty_casted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873445"><span class="hs-identifier hs-var">nty</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873446"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-1278"></a><span>                              </span><a name="local-6989586621682873448"><a href="#local-6989586621682873448"><span class="hs-identifier">final_co</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682873445"><span class="hs-identifier hs-var">nty</span></a><span>
</span><a name="line-1279"></a><span>                                                              </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873446"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873443"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1280"></a><span>                          </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873448"><span class="hs-identifier hs-var">final_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873447"><span class="hs-identifier hs-var">nty_casted</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1281"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1282"></a><span>    </span><a name="local-6989586621682873424"><a href="#local-6989586621682873424"><span class="hs-identifier">stepper</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873426"><span class="hs-identifier hs-var">unwrapNewTypeStepper'</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#composeSteppers"><span class="hs-identifier hs-var">composeSteppers</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873427"><span class="hs-identifier hs-var">tyFamStepper</span></a><span>
</span><a name="line-1283"></a><span>
</span><a name="line-1284"></a><span>    </span><a name="local-6989586621682873425"><a href="#local-6989586621682873425"><span class="hs-identifier">combine</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682873428"><a href="#local-6989586621682873428"><span class="hs-identifier">c1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873429"><a href="#local-6989586621682873429"><span class="hs-identifier">mc1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873430"><a href="#local-6989586621682873430"><span class="hs-identifier">c2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873431"><a href="#local-6989586621682873431"><span class="hs-identifier">mc2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873428"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873430"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873429"><span class="hs-identifier hs-var">mc1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransMCo"><span class="hs-identifier hs-var">mkTransMCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873431"><span class="hs-identifier hs-var">mc2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1285"></a><span>
</span><a name="line-1286"></a><span>    </span><span class="hs-identifier">unwrapNewTypeStepper'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCoercionN"><span class="hs-identifier hs-type">MCoercionN</span></a><span class="hs-special">)</span><span>
</span><a name="line-1287"></a><span>    </span><a name="local-6989586621682873426"><a href="#local-6989586621682873426"><span class="hs-identifier">unwrapNewTypeStepper'</span></a></a><span> </span><a name="local-6989586621682873432"><a href="#local-6989586621682873432"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682873433"><a href="#local-6989586621682873433"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873434"><a href="#local-6989586621682873434"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1288"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mapStepResult"><span class="hs-identifier hs-var">mapStepResult</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#unwrapNewTypeStepper"><span class="hs-identifier hs-var">unwrapNewTypeStepper</span></a><span> </span><a href="#local-6989586621682873432"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682873433"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873434"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1289"></a><span>
</span><a name="line-1290"></a><span>      </span><span class="hs-comment">-- second coercion below is the kind coercion relating the original type's kind</span><span>
</span><a name="line-1291"></a><span>      </span><span class="hs-comment">-- to the normalised type's kind</span><span>
</span><a name="line-1292"></a><span>    </span><span class="hs-identifier">tyFamStepper</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#NormaliseStepper"><span class="hs-identifier hs-type">NormaliseStepper</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCoercionN"><span class="hs-identifier hs-type">MCoercionN</span></a><span class="hs-special">)</span><span>
</span><a name="line-1293"></a><span>    </span><a name="local-6989586621682873427"><a href="#local-6989586621682873427"><span class="hs-identifier">tyFamStepper</span></a></a><span> </span><a name="local-6989586621682873435"><a href="#local-6989586621682873435"><span class="hs-identifier">rec_nts</span></a></a><span> </span><a name="local-6989586621682873436"><a href="#local-6989586621682873436"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873437"><a href="#local-6989586621682873437"><span class="hs-identifier">tys</span></a></a><span>  </span><span class="hs-comment">-- Try to step a type/data family</span><span>
</span><a name="line-1294"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873438"><a href="#local-6989586621682873438"><span class="hs-identifier">args_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873439"><a href="#local-6989586621682873439"><span class="hs-identifier">ntys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873440"><a href="#local-6989586621682873440"><span class="hs-identifier">res_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#normaliseTcArgs"><span class="hs-identifier hs-var">normaliseTcArgs</span></a><span> </span><a href="#local-6989586621682873422"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682873436"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873437"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1295"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier hs-var">reduceTyFamApp_maybe</span></a><span> </span><a href="#local-6989586621682873422"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621682873436"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873439"><span class="hs-identifier hs-var">ntys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1296"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873441"><a href="#local-6989586621682873441"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873442"><a href="#local-6989586621682873442"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NS_Step"><span class="hs-identifier hs-var">NS_Step</span></a><span> </span><a href="#local-6989586621682873435"><span class="hs-identifier hs-var">rec_nts</span></a><span> </span><a href="#local-6989586621682873442"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873438"><span class="hs-identifier hs-var">args_co</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873441"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a href="#local-6989586621682873440"><span class="hs-identifier hs-var">res_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1297"></a><span>          </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#NS_Done"><span class="hs-identifier hs-var">NS_Done</span></a><span>
</span><a name="line-1298"></a><span>
</span><a name="line-1299"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-1300"></a><span class="hs-identifier">normaliseTcApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1301"></a><span class="hs-comment">-- See comments on normaliseType for the arguments of this function</span><span>
</span><a name="line-1302"></a><a name="normaliseTcApp"><a href="FamInstEnv.html#normaliseTcApp"><span class="hs-identifier">normaliseTcApp</span></a></a><span> </span><a name="local-6989586621682873449"><a href="#local-6989586621682873449"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682873451"><a href="#local-6989586621682873451"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873452"><a href="#local-6989586621682873452"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1303"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#initNormM"><span class="hs-identifier hs-var">initNormM</span></a><span> </span><a href="#local-6989586621682873449"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-6989586621682873452"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1304"></a><span>    </span><a href="FamInstEnv.html#normalise_tc_app"><span class="hs-identifier hs-var">normalise_tc_app</span></a><span> </span><a href="#local-6989586621682873451"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873452"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span class="hs-comment">-- See Note [Normalising types] about the LiftingContext</span><span>
</span><a name="line-1307"></a><span class="hs-identifier">normalise_tc_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1308"></a><a name="normalise_tc_app"><a href="FamInstEnv.html#normalise_tc_app"><span class="hs-identifier">normalise_tc_app</span></a></a><span> </span><a name="local-6989586621682873453"><a href="#local-6989586621682873453"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873454"><a href="#local-6989586621682873454"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1309"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873462"><a href="#local-6989586621682873462"><span class="hs-identifier">tenv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873463"><a href="#local-6989586621682873463"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873464"><a href="#local-6989586621682873464"><span class="hs-identifier">tys'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#expandSynTyCon_maybe"><span class="hs-identifier hs-var">expandSynTyCon_maybe</span></a><span> </span><a href="#local-6989586621682873453"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873454"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1310"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isFamFreeTyCon"><span class="hs-identifier hs-var">isFamFreeTyCon</span></a><span> </span><a href="#local-6989586621682873453"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Expand and try again</span><span>
</span><a name="line-1311"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- A synonym with type families in the RHS</span><span>
</span><a name="line-1312"></a><span>    </span><span class="hs-comment">-- Expand and try again</span><span>
</span><a name="line-1313"></a><span>    </span><span class="hs-comment">-- See Note [Normalisation and type synonyms]</span><span>
</span><a name="line-1314"></a><span>    </span><a href="FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkAppTys"><span class="hs-identifier hs-var">mkAppTys</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTvSubstPrs"><span class="hs-identifier hs-var">mkTvSubstPrs</span></a><span> </span><a href="#local-6989586621682873462"><span class="hs-identifier hs-var">tenv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873463"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873464"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1315"></a><span>
</span><a name="line-1316"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isFamilyTyCon"><span class="hs-identifier hs-var">isFamilyTyCon</span></a><span> </span><a href="#local-6989586621682873453"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-1317"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- A type-family application</span><span>
</span><a name="line-1318"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682873465"><a href="#local-6989586621682873465"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a><span>
</span><a name="line-1319"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a><span>
</span><a name="line-1320"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873467"><a href="#local-6989586621682873467"><span class="hs-identifier">args_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873468"><a href="#local-6989586621682873468"><span class="hs-identifier">ntys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873469"><a href="#local-6989586621682873469"><span class="hs-identifier">res_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#normalise_tc_args"><span class="hs-identifier hs-var">normalise_tc_args</span></a><span> </span><a href="#local-6989586621682873453"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873454"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1321"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="FamInstEnv.html#reduceTyFamApp_maybe"><span class="hs-identifier hs-var">reduceTyFamApp_maybe</span></a><span> </span><a href="#local-6989586621682873465"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682873453"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873468"><span class="hs-identifier hs-var">ntys</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1322"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873470"><a href="#local-6989586621682873470"><span class="hs-identifier">first_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873471"><a href="#local-6989586621682873471"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1323"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873472"><a href="#local-6989586621682873472"><span class="hs-identifier">rest_co</span></a></a><span class="hs-special">,</span><a name="local-6989586621682873473"><a href="#local-6989586621682873473"><span class="hs-identifier">nty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a><span> </span><a href="#local-6989586621682873471"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1324"></a><span>                   </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873455"><span class="hs-identifier hs-var">assemble_result</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682873473"><span class="hs-identifier hs-var">nty</span></a><span>
</span><a name="line-1325"></a><span>                                             </span><span class="hs-special">(</span><a href="#local-6989586621682873467"><span class="hs-identifier hs-var">args_co</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873470"><span class="hs-identifier hs-var">first_co</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873472"><span class="hs-identifier hs-var">rest_co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1326"></a><span>                                             </span><a href="#local-6989586621682873469"><span class="hs-identifier hs-var">res_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1327"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- No unique matching family instance exists;</span><span>
</span><a name="line-1328"></a><span>                </span><span class="hs-comment">-- we do not do anything</span><span>
</span><a name="line-1329"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873455"><span class="hs-identifier hs-var">assemble_result</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621682873453"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873468"><span class="hs-identifier hs-var">ntys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873467"><span class="hs-identifier hs-var">args_co</span></a><span> </span><a href="#local-6989586621682873469"><span class="hs-identifier hs-var">res_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1330"></a><span>
</span><a name="line-1331"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1332"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- A synonym with no type families in the RHS; or data type etc</span><span>
</span><a name="line-1333"></a><span>    </span><span class="hs-comment">-- Just normalise the arguments and rebuild</span><span>
</span><a name="line-1334"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873474"><a href="#local-6989586621682873474"><span class="hs-identifier">args_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873475"><a href="#local-6989586621682873475"><span class="hs-identifier">ntys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873476"><a href="#local-6989586621682873476"><span class="hs-identifier">res_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#normalise_tc_args"><span class="hs-identifier hs-var">normalise_tc_args</span></a><span> </span><a href="#local-6989586621682873453"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873454"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1335"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a><span>
</span><a name="line-1336"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873455"><span class="hs-identifier hs-var">assemble_result</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621682873453"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873475"><span class="hs-identifier hs-var">ntys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873474"><span class="hs-identifier hs-var">args_co</span></a><span> </span><a href="#local-6989586621682873476"><span class="hs-identifier hs-var">res_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1337"></a><span>
</span><a name="line-1338"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1339"></a><span>    </span><span class="hs-identifier">assemble_result</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>       </span><span class="hs-comment">-- r, ambient role in NormM monad</span><span>
</span><a name="line-1340"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>       </span><span class="hs-comment">-- nty, result type, possibly of changed kind</span><span>
</span><a name="line-1341"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>   </span><span class="hs-comment">-- orig_ty ~r nty, possibly heterogeneous</span><span>
</span><a name="line-1342"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span>  </span><span class="hs-comment">-- typeKind(orig_ty) ~N typeKind(nty)</span><span>
</span><a name="line-1343"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- (co :: orig_ty ~r nty_casted, nty_casted)</span><span>
</span><a name="line-1344"></a><span>                                          </span><span class="hs-comment">-- where nty_casted has same kind as orig_ty</span><span>
</span><a name="line-1345"></a><span>    </span><a name="local-6989586621682873455"><a href="#local-6989586621682873455"><span class="hs-identifier">assemble_result</span></a></a><span> </span><a name="local-6989586621682873456"><a href="#local-6989586621682873456"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682873457"><a href="#local-6989586621682873457"><span class="hs-identifier">nty</span></a></a><span> </span><a name="local-6989586621682873458"><a href="#local-6989586621682873458"><span class="hs-identifier">orig_to_nty</span></a></a><span> </span><a name="local-6989586621682873459"><a href="#local-6989586621682873459"><span class="hs-identifier">kind_co</span></a></a><span>
</span><a name="line-1346"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682873461"><span class="hs-identifier hs-var">final_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873460"><span class="hs-identifier hs-var">nty_old_kind</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1347"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-1348"></a><span>        </span><a name="local-6989586621682873460"><a href="#local-6989586621682873460"><span class="hs-identifier">nty_old_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873457"><span class="hs-identifier hs-var">nty</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873459"><span class="hs-identifier hs-var">kind_co</span></a><span>
</span><a name="line-1349"></a><span>        </span><a name="local-6989586621682873461"><a href="#local-6989586621682873461"><span class="hs-identifier">final_co</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span> </span><a href="#local-6989586621682873456"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682873457"><span class="hs-identifier hs-var">nty</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873459"><span class="hs-identifier hs-var">kind_co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873458"><span class="hs-identifier hs-var">orig_to_nty</span></a><span>
</span><a name="line-1350"></a><span>
</span><a name="line-1351"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-1352"></a><span class="hs-comment">-- | Normalise arguments to a tycon</span><span>
</span><a name="line-1353"></a><span class="hs-identifier">normaliseTcArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>          </span><span class="hs-comment">-- ^ env't with family instances</span><span>
</span><a name="line-1354"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>                 </span><span class="hs-comment">-- ^ desired role of output coercion</span><span>
</span><a name="line-1355"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>                </span><span class="hs-comment">-- ^ tc</span><span>
</span><a name="line-1356"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>               </span><span class="hs-comment">-- ^ tys</span><span>
</span><a name="line-1357"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">)</span><span>
</span><a name="line-1358"></a><span>                                        </span><span class="hs-comment">-- ^ co :: tc tys ~ tc new_tys</span><span>
</span><a name="line-1359"></a><span>                                        </span><span class="hs-comment">-- NB: co might not be homogeneous</span><span>
</span><a name="line-1360"></a><span>                                        </span><span class="hs-comment">-- last coercion :: kind(tc tys) ~ kind(tc new_tys)</span><span>
</span><a name="line-1361"></a><a name="normaliseTcArgs"><a href="FamInstEnv.html#normaliseTcArgs"><span class="hs-identifier">normaliseTcArgs</span></a></a><span> </span><a name="local-6989586621682873478"><a href="#local-6989586621682873478"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682873480"><a href="#local-6989586621682873480"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873481"><a href="#local-6989586621682873481"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1362"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#initNormM"><span class="hs-identifier hs-var">initNormM</span></a><span> </span><a href="#local-6989586621682873478"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-6989586621682873481"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1363"></a><span>    </span><a href="FamInstEnv.html#normalise_tc_args"><span class="hs-identifier hs-var">normalise_tc_args</span></a><span> </span><a href="#local-6989586621682873480"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873481"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1364"></a><span>
</span><a name="line-1365"></a><span class="hs-identifier">normalise_tc_args</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>             </span><span class="hs-comment">-- tc tys</span><span>
</span><a name="line-1366"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionN"><span class="hs-identifier hs-type">CoercionN</span></a><span class="hs-special">)</span><span>
</span><a name="line-1367"></a><span>                  </span><span class="hs-comment">-- (co, new_tys), where</span><span>
</span><a name="line-1368"></a><span>                  </span><span class="hs-comment">-- co :: tc tys ~ tc new_tys; might not be homogeneous</span><span>
</span><a name="line-1369"></a><span>                  </span><span class="hs-comment">-- res_co :: typeKind(tc tys) ~N typeKind(tc new_tys)</span><span>
</span><a name="line-1370"></a><a name="normalise_tc_args"><a href="FamInstEnv.html#normalise_tc_args"><span class="hs-identifier">normalise_tc_args</span></a></a><span> </span><a name="local-6989586621682873482"><a href="#local-6989586621682873482"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873483"><a href="#local-6989586621682873483"><span class="hs-identifier">tys</span></a></a><span>
</span><a name="line-1371"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a><span>
</span><a name="line-1372"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873485"><a href="#local-6989586621682873485"><span class="hs-identifier">args_cos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873486"><a href="#local-6989586621682873486"><span class="hs-identifier">nargs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873487"><a href="#local-6989586621682873487"><span class="hs-identifier">res_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#normalise_args"><span class="hs-identifier hs-var">normalise_args</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621682873482"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesX"><span class="hs-identifier hs-var">tyConRolesX</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682873482"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873483"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1373"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkTyConAppCo"><span class="hs-identifier hs-var">mkTyConAppCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682873482"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873485"><span class="hs-identifier hs-var">args_cos</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873486"><span class="hs-identifier hs-var">nargs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873487"><span class="hs-identifier hs-var">res_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1374"></a><span>
</span><a name="line-1375"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-1376"></a><span class="hs-identifier">normaliseType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-1377"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>  </span><span class="hs-comment">-- desired role of coercion</span><span>
</span><a name="line-1378"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1379"></a><a name="normaliseType"><a href="FamInstEnv.html#normaliseType"><span class="hs-identifier">normaliseType</span></a></a><span> </span><a name="local-6989586621682873488"><a href="#local-6989586621682873488"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682873490"><a href="#local-6989586621682873490"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1380"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#initNormM"><span class="hs-identifier hs-var">initNormM</span></a><span> </span><a href="#local-6989586621682873488"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-6989586621682873490"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a><span> </span><a href="#local-6989586621682873490"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1381"></a><span>
</span><a name="line-1382"></a><span class="hs-identifier">normalise_type</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>                     </span><span class="hs-comment">-- old type</span><span>
</span><a name="line-1383"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- (coercion, new type), where</span><span>
</span><a name="line-1384"></a><span>                                           </span><span class="hs-comment">-- co :: old-type ~ new_type</span><span>
</span><a name="line-1385"></a><span class="hs-comment">-- Normalise the input type, by eliminating *all* type-function redexes</span><span>
</span><a name="line-1386"></a><span class="hs-comment">-- but *not* newtypes (which are visible to the programmer)</span><span>
</span><a name="line-1387"></a><span class="hs-comment">-- Returns with Refl if nothing happens</span><span>
</span><a name="line-1388"></a><span class="hs-comment">-- Does nothing to newtypes</span><span>
</span><a name="line-1389"></a><span class="hs-comment">-- The returned coercion *must* be *homogeneous*</span><span>
</span><a name="line-1390"></a><span class="hs-comment">-- See Note [Normalising types]</span><span>
</span><a name="line-1391"></a><span class="hs-comment">-- Try not to disturb type synonyms if possible</span><span>
</span><a name="line-1392"></a><span>
</span><a name="line-1393"></a><a name="normalise_type"><a href="FamInstEnv.html#normalise_type"><span class="hs-identifier">normalise_type</span></a></a><span> </span><a name="local-6989586621682873491"><a href="#local-6989586621682873491"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1394"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873492"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873491"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1395"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1396"></a><span>    </span><a name="local-6989586621682873492"><a href="#local-6989586621682873492"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621682873494"><a href="#local-6989586621682873494"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873495"><a href="#local-6989586621682873495"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#normalise_tc_app"><span class="hs-identifier hs-var">normalise_tc_app</span></a><span> </span><a href="#local-6989586621682873494"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873495"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1397"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873496"><a href="#local-6989586621682873496"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682873497"><a href="#local-6989586621682873497"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a><span>
</span><a name="line-1398"></a><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682873497"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682873496"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873496"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1399"></a><span>
</span><a name="line-1400"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621682873498"><a href="#local-6989586621682873498"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682873499"><a href="#local-6989586621682873499"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873493"><span class="hs-identifier hs-var">go_app_tys</span></a><span> </span><a href="#local-6989586621682873498"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621682873499"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">]</span><span>
</span><a name="line-1401"></a><span>
</span><a name="line-1402"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621682873500"><a href="#local-6989586621682873500"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682873501"><a href="#local-6989586621682873501"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1403"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873502"><a href="#local-6989586621682873502"><span class="hs-identifier">co1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873503"><a href="#local-6989586621682873503"><span class="hs-identifier">nty1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873492"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873500"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1404"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873504"><a href="#local-6989586621682873504"><span class="hs-identifier">co2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873505"><a href="#local-6989586621682873505"><span class="hs-identifier">nty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873492"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873501"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-1405"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682873506"><a href="#local-6989586621682873506"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a><span>
</span><a name="line-1406"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkFunCo"><span class="hs-identifier hs-var">mkFunCo</span></a><span> </span><a href="#local-6989586621682873506"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682873502"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621682873504"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a><span> </span><a href="#local-6989586621682873503"><span class="hs-identifier hs-var">nty1</span></a><span> </span><a href="#local-6989586621682873505"><span class="hs-identifier hs-var">nty2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1407"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a name="local-6989586621682873507"><a href="#local-6989586621682873507"><span class="hs-identifier">tcvar</span></a></a><span> </span><a name="local-6989586621682873508"><a href="#local-6989586621682873508"><span class="hs-identifier">vis</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682873509"><a href="#local-6989586621682873509"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1408"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873510"><a href="#local-6989586621682873510"><span class="hs-identifier">lc'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873511"><a href="#local-6989586621682873511"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873512"><a href="#local-6989586621682873512"><span class="hs-identifier">h</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873513"><a href="#local-6989586621682873513"><span class="hs-identifier">ki'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#normalise_var_bndr"><span class="hs-identifier hs-var">normalise_var_bndr</span></a><span> </span><a href="#local-6989586621682873507"><span class="hs-identifier hs-var">tcvar</span></a><span>
</span><a name="line-1409"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873514"><a href="#local-6989586621682873514"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873515"><a href="#local-6989586621682873515"><span class="hs-identifier">nty</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#withLC"><span class="hs-identifier hs-var">withLC</span></a><span> </span><a href="#local-6989586621682873510"><span class="hs-identifier hs-var">lc'</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a><span> </span><a href="#local-6989586621682873509"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1410"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873516"><a href="#local-6989586621682873516"><span class="hs-identifier">tv2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setTyVarKind"><span class="hs-identifier hs-var">setTyVarKind</span></a><span> </span><a href="#local-6989586621682873511"><span class="hs-identifier hs-var">tv'</span></a><span> </span><a href="#local-6989586621682873513"><span class="hs-identifier hs-var">ki'</span></a><span>
</span><a name="line-1411"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkForAllCo"><span class="hs-identifier hs-var">mkForAllCo</span></a><span> </span><a href="#local-6989586621682873511"><span class="hs-identifier hs-var">tv'</span></a><span> </span><a href="#local-6989586621682873512"><span class="hs-identifier hs-var">h</span></a><span> </span><a href="#local-6989586621682873514"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a href="#local-6989586621682873516"><span class="hs-identifier hs-var">tv2</span></a><span> </span><a href="#local-6989586621682873508"><span class="hs-identifier hs-var">vis</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873515"><span class="hs-identifier hs-var">nty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1412"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-6989586621682873517"><a href="#local-6989586621682873517"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#normalise_tyvar"><span class="hs-identifier hs-var">normalise_tyvar</span></a><span> </span><a href="#local-6989586621682873517"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1413"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621682873518"><a href="#local-6989586621682873518"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682873519"><a href="#local-6989586621682873519"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1414"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873520"><a href="#local-6989586621682873520"><span class="hs-identifier">nco</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873521"><a href="#local-6989586621682873521"><span class="hs-identifier">nty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873492"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873518"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1415"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682873522"><a href="#local-6989586621682873522"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getLC"><span class="hs-identifier hs-var">getLC</span></a><span>
</span><a name="line-1416"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873523"><a href="#local-6989586621682873523"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#substRightCo"><span class="hs-identifier hs-var">substRightCo</span></a><span> </span><a href="#local-6989586621682873522"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682873519"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1417"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#castCoercionKind"><span class="hs-identifier hs-var">castCoercionKind</span></a><span> </span><a href="#local-6989586621682873520"><span class="hs-identifier hs-var">nco</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682873518"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621682873521"><span class="hs-identifier hs-var">nty</span></a><span> </span><a href="#local-6989586621682873519"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682873523"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-1418"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span> </span><a href="#local-6989586621682873521"><span class="hs-identifier hs-var">nty</span></a><span> </span><a href="#local-6989586621682873523"><span class="hs-identifier hs-var">co'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1419"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621682873524"><a href="#local-6989586621682873524"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1420"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682873525"><a href="#local-6989586621682873525"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getLC"><span class="hs-identifier hs-var">getLC</span></a><span>
</span><a name="line-1421"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682873526"><a href="#local-6989586621682873526"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a><span>
</span><a name="line-1422"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873527"><a href="#local-6989586621682873527"><span class="hs-identifier">right_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#substRightCo"><span class="hs-identifier hs-var">substRightCo</span></a><span> </span><a href="#local-6989586621682873525"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682873524"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1423"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span> </span><a href="Coercion.html#mkProofIrrelCo"><span class="hs-identifier hs-var">mkProofIrrelCo</span></a><span> </span><a href="#local-6989586621682873526"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1424"></a><span>                         </span><span class="hs-special">(</span><a href="Coercion.html#liftCoSubst"><span class="hs-identifier hs-var">liftCoSubst</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621682873525"><span class="hs-identifier hs-var">lc</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-6989586621682873524"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1425"></a><span>                         </span><a href="#local-6989586621682873524"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621682873527"><span class="hs-identifier hs-var">right_co</span></a><span>
</span><a name="line-1426"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><a href="#local-6989586621682873527"><span class="hs-identifier hs-var">right_co</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1427"></a><span>
</span><a name="line-1428"></a><span>    </span><span class="hs-identifier">go_app_tys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>   </span><span class="hs-comment">-- function</span><span>
</span><a name="line-1429"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- args</span><span>
</span><a name="line-1430"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1431"></a><span>    </span><span class="hs-comment">-- cf. TcFlatten.flatten_app_ty_args</span><span>
</span><a name="line-1432"></a><span>    </span><a name="local-6989586621682873493"><a href="#local-6989586621682873493"><span class="hs-identifier">go_app_tys</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621682873528"><a href="#local-6989586621682873528"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682873529"><a href="#local-6989586621682873529"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682873530"><a href="#local-6989586621682873530"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873493"><span class="hs-identifier hs-var">go_app_tys</span></a><span> </span><a href="#local-6989586621682873528"><span class="hs-identifier hs-var">ty1</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873529"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682873530"><span class="hs-identifier hs-var">tys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1433"></a><span>    </span><span class="hs-identifier">go_app_tys</span><span> </span><a name="local-6989586621682873531"><a href="#local-6989586621682873531"><span class="hs-identifier">fun_ty</span></a></a><span> </span><a name="local-6989586621682873532"><a href="#local-6989586621682873532"><span class="hs-identifier">arg_tys</span></a></a><span>
</span><a name="line-1434"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873533"><a href="#local-6989586621682873533"><span class="hs-identifier">fun_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873534"><a href="#local-6989586621682873534"><span class="hs-identifier">nfun</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873492"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873531"><span class="hs-identifier hs-var">fun_ty</span></a><span>
</span><a name="line-1435"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#tcSplitTyConApp_maybe"><span class="hs-identifier hs-var">tcSplitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621682873534"><span class="hs-identifier hs-var">nfun</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1436"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873535"><a href="#local-6989586621682873535"><span class="hs-identifier">tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873536"><a href="#local-6989586621682873536"><span class="hs-identifier">xis</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1437"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873537"><a href="#local-6989586621682873537"><span class="hs-identifier">second_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873538"><a href="#local-6989586621682873538"><span class="hs-identifier">nty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873492"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621682873535"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873536"><span class="hs-identifier hs-var">xis</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682873532"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span>                   </span><span class="hs-comment">-- flatten_app_ty_args avoids redundantly processing the xis,</span><span>
</span><a name="line-1439"></a><span>                   </span><span class="hs-comment">-- but that's a much more performance-sensitive function.</span><span>
</span><a name="line-1440"></a><span>                   </span><span class="hs-comment">-- This type normalisation is not called in a loop.</span><span>
</span><a name="line-1441"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkAppCos"><span class="hs-identifier hs-var">mkAppCos</span></a><span> </span><a href="#local-6989586621682873533"><span class="hs-identifier hs-var">fun_co</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><a href="#local-6989586621682873532"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873537"><span class="hs-identifier hs-var">second_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873538"><span class="hs-identifier hs-var">nty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1442"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1443"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873539"><a href="#local-6989586621682873539"><span class="hs-identifier">args_cos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873540"><a href="#local-6989586621682873540"><span class="hs-identifier">nargs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873541"><a href="#local-6989586621682873541"><span class="hs-identifier">res_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#normalise_args"><span class="hs-identifier hs-var">normalise_args</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682873534"><span class="hs-identifier hs-var">nfun</span></a><span class="hs-special">)</span><span>
</span><a name="line-1444"></a><span>                                                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span>
</span><a name="line-1445"></a><span>                                                                  </span><a href="#local-6989586621682873532"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-1446"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a><span>
</span><a name="line-1447"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873543"><a href="#local-6989586621682873543"><span class="hs-identifier">nty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkAppTys"><span class="hs-identifier hs-var">mkAppTys</span></a><span> </span><a href="#local-6989586621682873534"><span class="hs-identifier hs-var">nfun</span></a><span> </span><a href="#local-6989586621682873540"><span class="hs-identifier hs-var">nargs</span></a><span>
</span><a name="line-1448"></a><span>                          </span><a name="local-6989586621682873544"><a href="#local-6989586621682873544"><span class="hs-identifier">nco</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkAppCos"><span class="hs-identifier hs-var">mkAppCos</span></a><span> </span><a href="#local-6989586621682873533"><span class="hs-identifier hs-var">fun_co</span></a><span> </span><a href="#local-6989586621682873539"><span class="hs-identifier hs-var">args_cos</span></a><span>
</span><a name="line-1449"></a><span>                          </span><a name="local-6989586621682873545"><a href="#local-6989586621682873545"><span class="hs-identifier">nty_casted</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873543"><span class="hs-identifier hs-var">nty</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873541"><span class="hs-identifier hs-var">res_co</span></a><span>
</span><a name="line-1450"></a><span>                          </span><a name="local-6989586621682873546"><a href="#local-6989586621682873546"><span class="hs-identifier">final_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkCoherenceRightCo"><span class="hs-identifier hs-var">mkCoherenceRightCo</span></a><span> </span><span class="hs-keyword">role</span><span> </span><a href="#local-6989586621682873543"><span class="hs-identifier hs-var">nty</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873541"><span class="hs-identifier hs-var">res_co</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873544"><span class="hs-identifier hs-var">nco</span></a><span>
</span><a name="line-1451"></a><span>                    </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873546"><span class="hs-identifier hs-var">final_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873545"><span class="hs-identifier hs-var">nty_casted</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1452"></a><span>
</span><a name="line-1453"></a><span class="hs-identifier">normalise_args</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>    </span><span class="hs-comment">-- of the function</span><span>
</span><a name="line-1454"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- roles at which to normalise args</span><span>
</span><a name="line-1455"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- args</span><span>
</span><a name="line-1456"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1457"></a><span class="hs-comment">-- returns (cos, xis, res_co), where each xi is the normalised</span><span>
</span><a name="line-1458"></a><span class="hs-comment">-- version of the corresponding type, each co is orig_arg ~ xi,</span><span>
</span><a name="line-1459"></a><span class="hs-comment">-- and the res_co :: kind(f orig_args) ~ kind(f xis)</span><span>
</span><a name="line-1460"></a><span class="hs-comment">-- NB: The xis might *not* have the same kinds as the input types,</span><span>
</span><a name="line-1461"></a><span class="hs-comment">-- but the resulting application *will* be well-kinded</span><span>
</span><a name="line-1462"></a><span class="hs-comment">-- cf. TcFlatten.flatten_args_slow</span><span>
</span><a name="line-1463"></a><a name="normalise_args"><a href="FamInstEnv.html#normalise_args"><span class="hs-identifier">normalise_args</span></a></a><span> </span><a name="local-6989586621682873547"><a href="#local-6989586621682873547"><span class="hs-identifier">fun_ki</span></a></a><span> </span><a name="local-6989586621682873548"><a href="#local-6989586621682873548"><span class="hs-identifier">roles</span></a></a><span> </span><a name="local-6989586621682873549"><a href="#local-6989586621682873549"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-1464"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682873560"><a href="#local-6989586621682873560"><span class="hs-identifier">normed_args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">zipWithM</span><span> </span><a href="#local-6989586621682873554"><span class="hs-identifier hs-var">normalise1</span></a><span> </span><a href="#local-6989586621682873548"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-6989586621682873549"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1465"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873561"><a href="#local-6989586621682873561"><span class="hs-identifier">xis</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873562"><a href="#local-6989586621682873562"><span class="hs-identifier">cos</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873563"><a href="#local-6989586621682873563"><span class="hs-identifier">res_co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#simplifyArgsWorker"><span class="hs-identifier hs-var">simplifyArgsWorker</span></a><span> </span><a href="#local-6989586621682873550"><span class="hs-identifier hs-var">ki_binders</span></a><span> </span><a href="#local-6989586621682873551"><span class="hs-identifier hs-var">inner_ki</span></a><span> </span><a href="#local-6989586621682873552"><span class="hs-identifier hs-var">fvs</span></a><span> </span><a href="#local-6989586621682873548"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-6989586621682873560"><span class="hs-identifier hs-var">normed_args</span></a><span>
</span><a name="line-1466"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873562"><span class="hs-identifier hs-var">cos</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873561"><span class="hs-identifier hs-var">xis</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873563"><span class="hs-identifier hs-var">res_co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1467"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1468"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682873550"><a href="#local-6989586621682873550"><span class="hs-identifier">ki_binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873551"><a href="#local-6989586621682873551"><span class="hs-identifier">inner_ki</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#splitPiTys"><span class="hs-identifier hs-var">splitPiTys</span></a><span> </span><a href="#local-6989586621682873547"><span class="hs-identifier hs-var">fun_ki</span></a><span>
</span><a name="line-1469"></a><span>    </span><a name="local-6989586621682873552"><a href="#local-6989586621682873552"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfTypes"><span class="hs-identifier hs-var">tyCoVarsOfTypes</span></a><span> </span><a href="#local-6989586621682873549"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1470"></a><span>
</span><a name="line-1471"></a><span>    </span><span class="hs-comment">-- flattener conventions are different from ours</span><span>
</span><a name="line-1472"></a><span>    </span><span class="hs-identifier">impedance_match</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1473"></a><span>    </span><a name="local-6989586621682873553"><a href="#local-6989586621682873553"><span class="hs-identifier">impedance_match</span></a></a><span> </span><a name="local-6989586621682873555"><a href="#local-6989586621682873555"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873556"><a href="#local-6989586621682873556"><span class="hs-identifier">co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873557"><a href="#local-6989586621682873557"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682873555"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-1474"></a><span>                                </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873557"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621682873556"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1475"></a><span>
</span><a name="line-1476"></a><span>    </span><a name="local-6989586621682873554"><a href="#local-6989586621682873554"><span class="hs-identifier">normalise1</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682873559"><a href="#local-6989586621682873559"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1477"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873553"><span class="hs-identifier hs-var">impedance_match</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FamInstEnv.html#withRole"><span class="hs-identifier hs-var">withRole</span></a><span> </span><span class="hs-keyword">role</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a><span> </span><a href="#local-6989586621682873559"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1478"></a><span>
</span><a name="line-1479"></a><span class="hs-identifier">normalise_tyvar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1480"></a><a name="normalise_tyvar"><a href="FamInstEnv.html#normalise_tyvar"><span class="hs-identifier">normalise_tyvar</span></a></a><span> </span><a name="local-6989586621682873564"><a href="#local-6989586621682873564"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1481"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">tv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1482"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682873566"><a href="#local-6989586621682873566"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getLC"><span class="hs-identifier hs-var">getLC</span></a><span>
</span><a name="line-1483"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682873567"><a href="#local-6989586621682873567"><span class="hs-identifier">r</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getRole"><span class="hs-identifier hs-var">getRole</span></a><span>
</span><a name="line-1484"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Coercion.html#liftCoSubstTyVar"><span class="hs-identifier hs-var">liftCoSubstTyVar</span></a><span> </span><a href="#local-6989586621682873566"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682873567"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682873564"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1485"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873568"><a href="#local-6989586621682873568"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873568"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">pSnd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621682873568"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1486"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkReflCo"><span class="hs-identifier hs-var">mkReflCo</span></a><span> </span><a href="#local-6989586621682873567"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621682873565"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873565"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1487"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682873565"><a href="#local-6989586621682873565"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-6989586621682873564"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1488"></a><span>
</span><a name="line-1489"></a><span class="hs-identifier">normalise_var_bndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1490"></a><a name="normalise_var_bndr"><a href="FamInstEnv.html#normalise_var_bndr"><span class="hs-identifier">normalise_var_bndr</span></a></a><span> </span><a name="local-6989586621682873569"><a href="#local-6989586621682873569"><span class="hs-identifier">tcvar</span></a></a><span>
</span><a name="line-1491"></a><span>  </span><span class="hs-comment">-- works for both tvar and covar</span><span>
</span><a name="line-1492"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682873570"><a href="#local-6989586621682873570"><span class="hs-identifier">lc1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getLC"><span class="hs-identifier hs-var">getLC</span></a><span>
</span><a name="line-1493"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621682873571"><a href="#local-6989586621682873571"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInstEnv.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a><span>
</span><a name="line-1494"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873572"><a href="#local-6989586621682873572"><span class="hs-identifier">callback</span></a></a><span> </span><a name="local-6989586621682873573"><a href="#local-6989586621682873573"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682873574"><a href="#local-6989586621682873574"><span class="hs-identifier">ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runNormM</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#normalise_type"><span class="hs-identifier hs-var">normalise_type</span></a><span> </span><a href="#local-6989586621682873574"><span class="hs-identifier hs-var">ki</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873571"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873573"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span>
</span><a name="line-1495"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Coercion.html#liftCoSubstVarBndrUsing"><span class="hs-identifier hs-var">liftCoSubstVarBndrUsing</span></a><span> </span><a href="#local-6989586621682873572"><span class="hs-identifier hs-var">callback</span></a><span> </span><a href="#local-6989586621682873570"><span class="hs-identifier hs-var">lc1</span></a><span> </span><a href="#local-6989586621682873569"><span class="hs-identifier hs-var">tcvar</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1496"></a><span>
</span><a name="line-1497"></a><span class="hs-comment">-- | a monad for the normalisation functions, reading 'FamInstEnvs',</span><span>
</span><a name="line-1498"></a><span class="hs-comment">-- a 'LiftingContext', and a 'Role'.</span><span>
</span><a name="line-1499"></a><span class="hs-keyword">newtype</span><span> </span><a name="NormM"><a href="FamInstEnv.html#NormM"><span class="hs-identifier">NormM</span></a></a><span> </span><a name="local-6989586621682873184"><a href="#local-6989586621682873184"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NormM"><a href="FamInstEnv.html#NormM"><span class="hs-identifier">NormM</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="runNormM"><a href="FamInstEnv.html#runNormM"><span class="hs-identifier">runNormM</span></a></a><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-1500"></a><span>                            </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873184"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1501"></a><span>
</span><a name="line-1502"></a><span class="hs-identifier">initNormM</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>
</span><a name="line-1503"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a><span>   </span><span class="hs-comment">-- the in-scope variables</span><span>
</span><a name="line-1504"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><a href="#local-6989586621682873199"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873199"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1505"></a><a name="initNormM"><a href="FamInstEnv.html#initNormM"><span class="hs-identifier">initNormM</span></a></a><span> </span><a name="local-6989586621682873575"><a href="#local-6989586621682873575"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-keyword">role</span><span> </span><a name="local-6989586621682873577"><a href="#local-6989586621682873577"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a><span> </span><a name="local-6989586621682873578"><a href="#local-6989586621682873578"><span class="hs-identifier">thing_inside</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1506"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873578"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621682873575"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873580"><span class="hs-identifier hs-var">lc</span></a><span> </span><span class="hs-keyword">role</span><span>
</span><a name="line-1507"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1508"></a><span>    </span><a name="local-6989586621682873579"><a href="#local-6989586621682873579"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><a href="#local-6989586621682873577"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-1509"></a><span>    </span><a name="local-6989586621682873580"><a href="#local-6989586621682873580"><span class="hs-identifier">lc</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#emptyLiftingContext"><span class="hs-identifier hs-var">emptyLiftingContext</span></a><span> </span><a href="#local-6989586621682873579"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-1510"></a><span>
</span><a name="line-1511"></a><span class="hs-identifier">getRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span>
</span><a name="line-1512"></a><a name="getRole"><a href="FamInstEnv.html#getRole"><span class="hs-identifier">getRole</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873581"><a href="#local-6989586621682873581"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873581"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1513"></a><span>
</span><a name="line-1514"></a><span class="hs-identifier">getLC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span>
</span><a name="line-1515"></a><a name="getLC"><a href="FamInstEnv.html#getLC"><span class="hs-identifier">getLC</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873582"><a href="#local-6989586621682873582"><span class="hs-identifier">lc</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873582"><span class="hs-identifier hs-var">lc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1516"></a><span>
</span><a name="line-1517"></a><span class="hs-identifier">getEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><a href="FamInstEnv.html#FamInstEnvs"><span class="hs-identifier hs-type">FamInstEnvs</span></a><span>
</span><a name="line-1518"></a><a name="getEnv"><a href="FamInstEnv.html#getEnv"><span class="hs-identifier">getEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682873583"><a href="#local-6989586621682873583"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873583"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1519"></a><span>
</span><a name="line-1520"></a><span class="hs-identifier">withRole</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><a href="#local-6989586621682873198"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><a href="#local-6989586621682873198"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1521"></a><a name="withRole"><a href="FamInstEnv.html#withRole"><span class="hs-identifier">withRole</span></a></a><span> </span><a name="local-6989586621682873584"><a href="#local-6989586621682873584"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621682873585"><a href="#local-6989586621682873585"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682873586"><a href="#local-6989586621682873586"><span class="hs-identifier">envs</span></a></a><span> </span><a name="local-6989586621682873587"><a href="#local-6989586621682873587"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682873588"><a href="#local-6989586621682873588"><span class="hs-identifier">_old_r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">runNormM</span><span> </span><a href="#local-6989586621682873585"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-6989586621682873586"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621682873587"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682873584"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1522"></a><span>
</span><a name="line-1523"></a><span class="hs-identifier">withLC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Coercion.html#LiftingContext"><span class="hs-identifier hs-type">LiftingContext</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><a href="#local-6989586621682873197"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><a href="#local-6989586621682873197"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1524"></a><a name="withLC"><a href="FamInstEnv.html#withLC"><span class="hs-identifier">withLC</span></a></a><span> </span><a name="local-6989586621682873589"><a href="#local-6989586621682873589"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682873590"><a href="#local-6989586621682873590"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682873591"><a href="#local-6989586621682873591"><span class="hs-identifier">envs</span></a></a><span> </span><a name="local-6989586621682873592"><a href="#local-6989586621682873592"><span class="hs-identifier">_old_lc</span></a></a><span> </span><a name="local-6989586621682873593"><a href="#local-6989586621682873593"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">runNormM</span><span> </span><a href="#local-6989586621682873590"><span class="hs-identifier hs-var">thing</span></a><span> </span><a href="#local-6989586621682873591"><span class="hs-identifier hs-var">envs</span></a><span> </span><a href="#local-6989586621682873589"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682873593"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1525"></a><span>
</span><a name="line-1526"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1527"></a><span>  </span><a name="local-6989586621682873186"><a href="#local-6989586621682873186"><span class="hs-identifier">ma</span></a></a><span> </span><a name="local-3458764513820541099"><span class="hs-operator">&gt;&gt;=</span></a><span> </span><a name="local-6989586621682873187"><a href="#local-6989586621682873187"><span class="hs-identifier">fmb</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621682873188"><a href="#local-6989586621682873188"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682873189"><a href="#local-6989586621682873189"><span class="hs-identifier">lc</span></a></a><span> </span><a name="local-6989586621682873190"><a href="#local-6989586621682873190"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1528"></a><span>               </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873191"><a href="#local-6989586621682873191"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runNormM</span><span> </span><a href="#local-6989586621682873186"><span class="hs-identifier hs-var">ma</span></a><span> </span><a href="#local-6989586621682873188"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873189"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682873190"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1529"></a><span>               </span><span class="hs-identifier">runNormM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873187"><span class="hs-identifier hs-var">fmb</span></a><span> </span><a href="#local-6989586621682873191"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873188"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873189"><span class="hs-identifier hs-var">lc</span></a><span> </span><a href="#local-6989586621682873190"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1530"></a><span>
</span><a name="line-1531"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1532"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftM</span><span>
</span><a name="line-1533"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-type">NormM</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1534"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><a name="local-6989586621682873185"><a href="#local-6989586621682873185"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#NormM"><span class="hs-identifier hs-var">NormM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682873185"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1535"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ap</span><span>
</span><a name="line-1536"></a><span>
</span><a name="line-1537"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
              Flattening
*                                                                      *
************************************************************************

Note [Flattening]
~~~~~~~~~~~~~~~~~
As described in &quot;Closed type families with overlapping equations&quot;
http://research.microsoft.com/en-us/um/people/simonpj/papers/ext-f/axioms-extended.pdf
we need to flatten core types before unifying them, when checking for &quot;surely-apart&quot;
against earlier equations of a closed type family.
Flattening means replacing all top-level uses of type functions with
fresh variables, *taking care to preserve sharing*. That is, the type
(Either (F a b) (F a b)) should flatten to (Either c c), never (Either
c d).

Here is a nice example of why it's all necessary:

  type family F a b where
    F Int Bool = Char
    F a   b    = Double
  type family G a         -- open, no instances

How do we reduce (F (G Float) (G Float))? The first equation clearly doesn't match,
while the second equation does. But, before reducing, we must make sure that the
target can never become (F Int Bool). Well, no matter what G Float becomes, it
certainly won't become *both* Int and Bool, so indeed we're safe reducing
(F (G Float) (G Float)) to Double.

This is necessary not only to get more reductions (which we might be
willing to give up on), but for substitutivity. If we have (F x x), we
can see that (F x x) can reduce to Double. So, it had better be the
case that (F blah blah) can reduce to Double, no matter what (blah)
is!  Flattening as done below ensures this.

flattenTys is defined here because of module dependencies.
-}</span><span>
</span><a name="line-1576"></a><span>
</span><a name="line-1577"></a><span class="hs-keyword">data</span><span> </span><a name="FlattenEnv"><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier">FlattenEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="FlattenEnv"><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier">FlattenEnv</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="fe_type_map"><a href="FamInstEnv.html#fe_type_map"><span class="hs-identifier">fe_type_map</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreMap.html#TypeMap"><span class="hs-identifier hs-type">TypeMap</span></a><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span>
</span><a name="line-1578"></a><span>                             </span><span class="hs-special">,</span><span> </span><a name="fe_subst"><a href="FamInstEnv.html#fe_subst"><span class="hs-identifier">fe_subst</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span class="hs-identifier">emptyFlattenEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span>
</span><a name="line-1581"></a><a name="emptyFlattenEnv"><a href="FamInstEnv.html#emptyFlattenEnv"><span class="hs-identifier">emptyFlattenEnv</span></a></a><span> </span><a name="local-6989586621682873594"><a href="#local-6989586621682873594"><span class="hs-identifier">in_scope</span></a></a><span>
</span><a name="line-1582"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-var">FlattenEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fe_type_map</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreMap.html#emptyTypeMap"><span class="hs-identifier hs-var">emptyTypeMap</span></a><span>
</span><a name="line-1583"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fe_subst</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a><span> </span><a href="#local-6989586621682873594"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1584"></a><span>
</span><a name="line-1585"></a><span class="hs-comment">-- See Note [Flattening]</span><span>
</span><a name="line-1586"></a><span class="hs-identifier">flattenTys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>
</span><a name="line-1587"></a><a name="flattenTys"><a href="FamInstEnv.html#flattenTys"><span class="hs-identifier">flattenTys</span></a></a><span> </span><a name="local-6989586621682873595"><a href="#local-6989586621682873595"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621682873596"><a href="#local-6989586621682873596"><span class="hs-identifier">tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="FamInstEnv.html#coreFlattenTys"><span class="hs-identifier hs-var">coreFlattenTys</span></a><span> </span><a href="#local-6989586621682873598"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873596"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1588"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1589"></a><span>    </span><span class="hs-comment">-- when we hit a type function, we replace it with a fresh variable</span><span>
</span><a name="line-1590"></a><span>    </span><span class="hs-comment">-- but, we need to make sure that this fresh variable isn't mentioned</span><span>
</span><a name="line-1591"></a><span>    </span><span class="hs-comment">-- *anywhere* in the types we're flattening, even if locally-bound in</span><span>
</span><a name="line-1592"></a><span>    </span><span class="hs-comment">-- a forall. That way, we can ensure consistency both within and outside</span><span>
</span><a name="line-1593"></a><span>    </span><span class="hs-comment">-- of that forall.</span><span>
</span><a name="line-1594"></a><span>    </span><a name="local-6989586621682873597"><a href="#local-6989586621682873597"><span class="hs-identifier">all_in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873595"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSetSet"><span class="hs-identifier hs-var">extendInScopeSetSet</span></a><span class="hs-special">`</span><span> </span><a href="FamInstEnv.html#allTyCoVarsInTys"><span class="hs-identifier hs-var">allTyCoVarsInTys</span></a><span> </span><a href="#local-6989586621682873596"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1595"></a><span>    </span><a name="local-6989586621682873598"><a href="#local-6989586621682873598"><span class="hs-identifier">env</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#emptyFlattenEnv"><span class="hs-identifier hs-var">emptyFlattenEnv</span></a><span> </span><a href="#local-6989586621682873597"><span class="hs-identifier hs-var">all_in_scope</span></a><span>
</span><a name="line-1596"></a><span>
</span><a name="line-1597"></a><span class="hs-identifier">coreFlattenTys</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1598"></a><a name="coreFlattenTys"><a href="FamInstEnv.html#coreFlattenTys"><span class="hs-identifier">coreFlattenTys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873599"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1599"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1600"></a><span>    </span><a name="local-6989586621682873599"><a href="#local-6989586621682873599"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682873600"><a href="#local-6989586621682873600"><span class="hs-identifier">rtys</span></a></a><span> </span><a name="local-6989586621682873601"><a href="#local-6989586621682873601"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873601"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682873600"><span class="hs-identifier hs-var">rtys</span></a><span class="hs-special">)</span><span>
</span><a name="line-1601"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873602"><a href="#local-6989586621682873602"><span class="hs-identifier">rtys</span></a></a><span> </span><a name="local-6989586621682873603"><a href="#local-6989586621682873603"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682873604"><a href="#local-6989586621682873604"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682873605"><a href="#local-6989586621682873605"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1602"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873606"><a href="#local-6989586621682873606"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873607"><a href="#local-6989586621682873607"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#coreFlattenTy"><span class="hs-identifier hs-var">coreFlattenTy</span></a><span> </span><a href="#local-6989586621682873603"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873604"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1603"></a><span>        </span><a href="#local-6989586621682873599"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873607"><span class="hs-identifier hs-var">ty'</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682873602"><span class="hs-identifier hs-var">rtys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873606"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621682873605"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1604"></a><span>
</span><a name="line-1605"></a><span class="hs-identifier">coreFlattenTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1606"></a><a name="coreFlattenTy"><a href="FamInstEnv.html#coreFlattenTy"><span class="hs-identifier">coreFlattenTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873608"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-1607"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1608"></a><span>    </span><a name="local-6989586621682873608"><a href="#local-6989586621682873608"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682873609"><a href="#local-6989586621682873609"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682873610"><a href="#local-6989586621682873610"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873611"><a href="#local-6989586621682873611"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-6989586621682873610"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873609"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873611"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-1609"></a><span>
</span><a name="line-1610"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873612"><a href="#local-6989586621682873612"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-6989586621682873613"><a href="#local-6989586621682873613"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873612"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTyVar"><span class="hs-identifier hs-var">substTyVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fe_subst</span><span> </span><a href="#local-6989586621682873612"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873613"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1611"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873614"><a href="#local-6989586621682873614"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621682873615"><a href="#local-6989586621682873615"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682873616"><a href="#local-6989586621682873616"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873617"><a href="#local-6989586621682873617"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873618"><a href="#local-6989586621682873618"><span class="hs-identifier">ty1'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873614"><span class="hs-identifier hs-var">env</span></a><span>  </span><a href="#local-6989586621682873615"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1612"></a><span>                                 </span><span class="hs-special">(</span><a name="local-6989586621682873619"><a href="#local-6989586621682873619"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873620"><a href="#local-6989586621682873620"><span class="hs-identifier">ty2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873617"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621682873616"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1613"></a><span>                             </span><span class="hs-special">(</span><a href="#local-6989586621682873619"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a href="#local-6989586621682873618"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682873620"><span class="hs-identifier hs-var">ty2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1614"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873621"><a href="#local-6989586621682873621"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621682873622"><a href="#local-6989586621682873622"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621682873623"><a href="#local-6989586621682873623"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1615"></a><span>         </span><span class="hs-comment">-- NB: Don't just check if isFamilyTyCon: this catches *data* families,</span><span>
</span><a name="line-1616"></a><span>         </span><span class="hs-comment">-- which are generative and thus can be preserved during flattening</span><span>
</span><a name="line-1617"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isGenerativeTyCon"><span class="hs-identifier hs-var">isGenerativeTyCon</span></a><span> </span><a href="#local-6989586621682873622"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span>
</span><a name="line-1618"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873624"><a href="#local-6989586621682873624"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873625"><a href="#local-6989586621682873625"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#coreFlattenTyFamApp"><span class="hs-identifier hs-var">coreFlattenTyFamApp</span></a><span> </span><a href="#local-6989586621682873621"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873622"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873623"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1619"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621682873624"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-6989586621682873625"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1620"></a><span>
</span><a name="line-1621"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1622"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873626"><a href="#local-6989586621682873626"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873627"><a href="#local-6989586621682873627"><span class="hs-identifier">tys'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#coreFlattenTys"><span class="hs-identifier hs-var">coreFlattenTys</span></a><span> </span><a href="#local-6989586621682873621"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873623"><span class="hs-identifier hs-var">tys</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1623"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621682873626"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621682873622"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="#local-6989586621682873627"><span class="hs-identifier hs-var">tys'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1624"></a><span>
</span><a name="line-1625"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873628"><a href="#local-6989586621682873628"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621682873629"><a href="#local-6989586621682873629"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682873630"><a href="#local-6989586621682873630"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873631"><a href="#local-6989586621682873631"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873632"><a href="#local-6989586621682873632"><span class="hs-identifier">ty1'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873628"><span class="hs-identifier hs-var">env</span></a><span>  </span><a href="#local-6989586621682873629"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-1626"></a><span>                                 </span><span class="hs-special">(</span><a name="local-6989586621682873633"><a href="#local-6989586621682873633"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873634"><a href="#local-6989586621682873634"><span class="hs-identifier">ty2'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873631"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621682873630"><span class="hs-identifier hs-var">ty2</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1627"></a><span>                             </span><span class="hs-special">(</span><a href="#local-6989586621682873633"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#mkFunTy"><span class="hs-identifier hs-var">mkFunTy</span></a><span> </span><a href="#local-6989586621682873632"><span class="hs-identifier hs-var">ty1'</span></a><span> </span><a href="#local-6989586621682873634"><span class="hs-identifier hs-var">ty2'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1628"></a><span>
</span><a name="line-1629"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873635"><a href="#local-6989586621682873635"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a name="local-6989586621682873636"><a href="#local-6989586621682873636"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682873637"><a href="#local-6989586621682873637"><span class="hs-identifier">vis</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682873638"><a href="#local-6989586621682873638"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1630"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873639"><a href="#local-6989586621682873639"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873640"><a href="#local-6989586621682873640"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#coreFlattenVarBndr"><span class="hs-identifier hs-var">coreFlattenVarBndr</span></a><span> </span><a href="#local-6989586621682873635"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873636"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1631"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621682873641"><a href="#local-6989586621682873641"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873642"><a href="#local-6989586621682873642"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873639"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621682873638"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1632"></a><span>        </span><span class="hs-special">(</span><a href="#local-6989586621682873641"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a href="#local-6989586621682873640"><span class="hs-identifier hs-var">tv'</span></a><span> </span><a href="#local-6989586621682873637"><span class="hs-identifier hs-var">vis</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682873642"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1633"></a><span>
</span><a name="line-1634"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873643"><a href="#local-6989586621682873643"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682873644"><a href="#local-6989586621682873644"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873643"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873644"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1635"></a><span>
</span><a name="line-1636"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873645"><a href="#local-6989586621682873645"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621682873646"><a href="#local-6989586621682873646"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682873647"><a href="#local-6989586621682873647"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873648"><a href="#local-6989586621682873648"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873649"><a href="#local-6989586621682873649"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873608"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873645"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873646"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1637"></a><span>                                </span><span class="hs-special">(</span><a name="local-6989586621682873650"><a href="#local-6989586621682873650"><span class="hs-identifier">env2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873651"><a href="#local-6989586621682873651"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#coreFlattenCo"><span class="hs-identifier hs-var">coreFlattenCo</span></a><span> </span><a href="#local-6989586621682873648"><span class="hs-identifier hs-var">env1</span></a><span> </span><a href="#local-6989586621682873647"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1638"></a><span>                            </span><span class="hs-special">(</span><a href="#local-6989586621682873650"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a href="#local-6989586621682873649"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621682873651"><span class="hs-identifier hs-var">co'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1639"></a><span>
</span><a name="line-1640"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682873652"><a href="#local-6989586621682873652"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621682873653"><a href="#local-6989586621682873653"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873654"><a href="#local-6989586621682873654"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873655"><a href="#local-6989586621682873655"><span class="hs-identifier">co'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#coreFlattenCo"><span class="hs-identifier hs-var">coreFlattenCo</span></a><span> </span><a href="#local-6989586621682873652"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873653"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1641"></a><span>                             </span><span class="hs-special">(</span><a href="#local-6989586621682873654"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a href="#local-6989586621682873655"><span class="hs-identifier hs-var">co'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1642"></a><span>
</span><a name="line-1643"></a><span class="hs-comment">-- when flattening, we don't care about the contents of coercions.</span><span>
</span><a name="line-1644"></a><span class="hs-comment">-- so, just return a fresh variable of the right (flattened) type</span><span>
</span><a name="line-1645"></a><span class="hs-identifier">coreFlattenCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1646"></a><a name="coreFlattenCo"><a href="FamInstEnv.html#coreFlattenCo"><span class="hs-identifier">coreFlattenCo</span></a></a><span> </span><a name="local-6989586621682873656"><a href="#local-6989586621682873656"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682873657"><a href="#local-6989586621682873657"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1647"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873664"><span class="hs-identifier hs-var">env2</span></a><span class="hs-special">,</span><span> </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-6989586621682873663"><span class="hs-identifier hs-var">covar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1648"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1649"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682873658"><a href="#local-6989586621682873658"><span class="hs-identifier">env1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873659"><a href="#local-6989586621682873659"><span class="hs-identifier">kind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#coreFlattenTy"><span class="hs-identifier hs-var">coreFlattenTy</span></a><span> </span><a href="#local-6989586621682873656"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#coercionType"><span class="hs-identifier hs-var">coercionType</span></a><span> </span><a href="#local-6989586621682873657"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1650"></a><span>    </span><a name="local-6989586621682873660"><a href="#local-6989586621682873660"><span class="hs-identifier">fresh_name</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#mkFlattenFreshCoName"><span class="hs-identifier hs-var">mkFlattenFreshCoName</span></a><span>
</span><a name="line-1651"></a><span>    </span><a name="local-6989586621682873661"><a href="#local-6989586621682873661"><span class="hs-identifier">subst1</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fe_subst</span><span> </span><a href="#local-6989586621682873658"><span class="hs-identifier hs-var">env1</span></a><span>
</span><a name="line-1652"></a><span>    </span><a name="local-6989586621682873662"><a href="#local-6989586621682873662"><span class="hs-identifier">in_scope</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a><span> </span><a href="#local-6989586621682873661"><span class="hs-identifier hs-var">subst1</span></a><span>
</span><a name="line-1653"></a><span>    </span><a name="local-6989586621682873663"><a href="#local-6989586621682873663"><span class="hs-identifier">covar</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><a href="#local-6989586621682873662"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#mkCoVar"><span class="hs-identifier hs-var">mkCoVar</span></a><span> </span><a href="#local-6989586621682873660"><span class="hs-identifier hs-var">fresh_name</span></a><span> </span><a href="#local-6989586621682873659"><span class="hs-identifier hs-var">kind'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1654"></a><span>    </span><a name="local-6989586621682873664"><a href="#local-6989586621682873664"><span class="hs-identifier">env2</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873658"><span class="hs-identifier hs-var">env1</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873661"><span class="hs-identifier hs-var">subst1</span></a><span> </span><span class="hs-special">`</span><a href="TyCoRep.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873663"><span class="hs-identifier hs-var">covar</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1655"></a><span>
</span><a name="line-1656"></a><span class="hs-identifier">coreFlattenVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyCoVar"><span class="hs-identifier hs-type">TyCoVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1657"></a><a name="coreFlattenVarBndr"><a href="FamInstEnv.html#coreFlattenVarBndr"><span class="hs-identifier">coreFlattenVarBndr</span></a></a><span> </span><a name="local-6989586621682873665"><a href="#local-6989586621682873665"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682873666"><a href="#local-6989586621682873666"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-1658"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682873669"><span class="hs-identifier hs-var">kind'</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873667"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-1659"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621682873665"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendTCvSubst"><span class="hs-identifier hs-var">extendTCvSubst</span></a><span> </span><a href="#local-6989586621682873670"><span class="hs-identifier hs-var">old_subst</span></a><span> </span><a href="#local-6989586621682873666"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyCoVarTy"><span class="hs-identifier hs-var">mkTyCoVarTy</span></a><span> </span><a href="#local-6989586621682873666"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1660"></a><span>             </span><span class="hs-comment">-- override any previous binding for tv</span><span>
</span><a name="line-1661"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873666"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1662"></a><span>
</span><a name="line-1663"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1664"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873671"><a href="#local-6989586621682873671"><span class="hs-identifier">new_tv</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a><span> </span><a href="#local-6989586621682873670"><span class="hs-identifier hs-var">old_subst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Var.html#setVarType"><span class="hs-identifier hs-var">setVarType</span></a><span> </span><a href="#local-6989586621682873666"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682873669"><span class="hs-identifier hs-var">kind'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1665"></a><span>        </span><a name="local-6989586621682873672"><a href="#local-6989586621682873672"><span class="hs-identifier">new_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendTCvSubstWithClone"><span class="hs-identifier hs-var">extendTCvSubstWithClone</span></a><span> </span><a href="#local-6989586621682873670"><span class="hs-identifier hs-var">old_subst</span></a><span> </span><a href="#local-6989586621682873666"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621682873671"><span class="hs-identifier hs-var">new_tv</span></a><span>
</span><a name="line-1666"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-1667"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621682873668"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873672"><span class="hs-identifier hs-var">new_subst</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873671"><span class="hs-identifier hs-var">new_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1668"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1669"></a><span>    </span><a name="local-6989586621682873667"><a href="#local-6989586621682873667"><span class="hs-identifier">kind</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621682873666"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1670"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682873668"><a href="#local-6989586621682873668"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682873669"><a href="#local-6989586621682873669"><span class="hs-identifier">kind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#coreFlattenTy"><span class="hs-identifier hs-var">coreFlattenTy</span></a><span> </span><a href="#local-6989586621682873665"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682873667"><span class="hs-identifier hs-var">kind</span></a><span>
</span><a name="line-1671"></a><span>    </span><a name="local-6989586621682873670"><a href="#local-6989586621682873670"><span class="hs-identifier">old_subst</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">fe_subst</span><span> </span><a href="#local-6989586621682873665"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1672"></a><span>
</span><a name="line-1673"></a><span class="hs-identifier">coreFlattenTyFamApp</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span>
</span><a name="line-1674"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>         </span><span class="hs-comment">-- type family tycon</span><span>
</span><a name="line-1675"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- args</span><span>
</span><a name="line-1676"></a><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-type">FlattenEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-1677"></a><a name="coreFlattenTyFamApp"><a href="FamInstEnv.html#coreFlattenTyFamApp"><span class="hs-identifier">coreFlattenTyFamApp</span></a></a><span> </span><a name="local-6989586621682873673"><a href="#local-6989586621682873673"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682873674"><a href="#local-6989586621682873674"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621682873675"><a href="#local-6989586621682873675"><span class="hs-identifier">fam_args</span></a></a><span>
</span><a name="line-1678"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreMap.html#lookupTypeMap"><span class="hs-identifier hs-var">lookupTypeMap</span></a><span> </span><a href="#local-6989586621682873677"><span class="hs-identifier hs-var">type_map</span></a><span> </span><a href="#local-6989586621682873676"><span class="hs-identifier hs-var">fam_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1679"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682873679"><a href="#local-6989586621682873679"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873673"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873679"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1680"></a><span>              </span><span class="hs-comment">-- we need fresh variables here, but this is called far from</span><span>
</span><a name="line-1681"></a><span>              </span><span class="hs-comment">-- any good source of uniques. So, we just use the fam_tc's unique</span><span>
</span><a name="line-1682"></a><span>              </span><span class="hs-comment">-- and trust uniqAway to avoid clashes. Recall that the in_scope set</span><span>
</span><a name="line-1683"></a><span>              </span><span class="hs-comment">-- contains *all* tyvars, even locally bound ones elsewhere in the</span><span>
</span><a name="line-1684"></a><span>              </span><span class="hs-comment">-- overall type, so this really is fresh.</span><span>
</span><a name="line-1685"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621682873680"><a href="#local-6989586621682873680"><span class="hs-identifier">tyvar_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#mkFlattenFreshTyName"><span class="hs-identifier hs-var">mkFlattenFreshTyName</span></a><span> </span><a href="#local-6989586621682873674"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1686"></a><span>                     </span><a name="local-6989586621682873681"><a href="#local-6989586621682873681"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a><span> </span><a href="#local-6989586621682873678"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1687"></a><span>                          </span><a href="Var.html#mkTyVar"><span class="hs-identifier hs-var">mkTyVar</span></a><span> </span><a href="#local-6989586621682873680"><span class="hs-identifier hs-var">tyvar_name</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621682873676"><span class="hs-identifier hs-var">fam_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1688"></a><span>                     </span><a name="local-6989586621682873682"><a href="#local-6989586621682873682"><span class="hs-identifier">env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873673"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fe_type_map</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreMap.html#extendTypeMap"><span class="hs-identifier hs-var">extendTypeMap</span></a><span> </span><a href="#local-6989586621682873677"><span class="hs-identifier hs-var">type_map</span></a><span> </span><a href="#local-6989586621682873676"><span class="hs-identifier hs-var">fam_ty</span></a><span> </span><a href="#local-6989586621682873681"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1689"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#extendTCvInScope"><span class="hs-identifier hs-var">extendTCvInScope</span></a><span> </span><a href="#local-6989586621682873678"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621682873681"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1690"></a><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873682"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873681"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682873676"><a href="#local-6989586621682873676"><span class="hs-identifier">fam_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621682873674"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621682873675"><span class="hs-identifier hs-var">fam_args</span></a><span>
</span><a name="line-1692"></a><span>        </span><a href="FamInstEnv.html#FlattenEnv"><span class="hs-identifier hs-var">FlattenEnv</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fe_type_map</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873677"><a href="#local-6989586621682873677"><span class="hs-identifier">type_map</span></a></a><span>
</span><a name="line-1693"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682873678"><a href="#local-6989586621682873678"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873673"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1694"></a><span>
</span><a name="line-1695"></a><span class="hs-comment">-- | Get the set of all type/coercion variables mentioned anywhere in the list</span><span>
</span><a name="line-1696"></a><span class="hs-comment">-- of types. These variables are not necessarily free.</span><span>
</span><a name="line-1697"></a><span class="hs-identifier">allTyCoVarsInTys</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1698"></a><a name="allTyCoVarsInTys"><a href="FamInstEnv.html#allTyCoVarsInTys"><span class="hs-identifier">allTyCoVarsInTys</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-1699"></a><span class="hs-identifier">allTyCoVarsInTys</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682873683"><a href="#local-6989586621682873683"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682873684"><a href="#local-6989586621682873684"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#allTyCoVarsInTy"><span class="hs-identifier hs-var">allTyCoVarsInTy</span></a><span> </span><a href="#local-6989586621682873683"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="FamInstEnv.html#allTyCoVarsInTys"><span class="hs-identifier hs-var">allTyCoVarsInTys</span></a><span> </span><a href="#local-6989586621682873684"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1700"></a><span>
</span><a name="line-1701"></a><span class="hs-comment">-- | Get the set of all type/coercion variables mentioned anywhere in a type.</span><span>
</span><a name="line-1702"></a><span class="hs-identifier">allTyCoVarsInTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span>
</span><a name="line-1703"></a><a name="allTyCoVarsInTy"><a href="FamInstEnv.html#allTyCoVarsInTy"><span class="hs-identifier">allTyCoVarsInTy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span>
</span><a name="line-1704"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1705"></a><span>    </span><a name="local-6989586621682873685"><a href="#local-6989586621682873685"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-6989586621682873690"><a href="#local-6989586621682873690"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a><span> </span><a href="#local-6989586621682873690"><span class="hs-identifier hs-var">tv</span></a><span>
</span><a name="line-1706"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873691"><a href="#local-6989586621682873691"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="FamInstEnv.html#allTyCoVarsInTys"><span class="hs-identifier hs-var">allTyCoVarsInTys</span></a><span> </span><a href="#local-6989586621682873691"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1707"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621682873692"><a href="#local-6989586621682873692"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682873693"><a href="#local-6989586621682873693"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873692"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873693"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1708"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621682873694"><a href="#local-6989586621682873694"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621682873695"><a href="#local-6989586621682873695"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873694"><span class="hs-identifier hs-var">ty1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873695"><span class="hs-identifier hs-var">ty2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1709"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#Bndr"><span class="hs-identifier hs-var">Bndr</span></a><span> </span><a name="local-6989586621682873696"><a href="#local-6989586621682873696"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682873697"><a href="#local-6989586621682873697"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a><span> </span><a href="#local-6989586621682873696"><span class="hs-identifier hs-var">tv</span></a><span>     </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span>
</span><a name="line-1710"></a><span>                                   </span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621682873696"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span>
</span><a name="line-1711"></a><span>                                   </span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873697"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1712"></a><span>                                   </span><span class="hs-comment">-- Don't remove the tv from the set!</span><span>
</span><a name="line-1713"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-1714"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621682873698"><a href="#local-6989586621682873698"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682873699"><a href="#local-6989586621682873699"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873698"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873699"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1715"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621682873700"><a href="#local-6989586621682873700"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873700"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1716"></a><span>
</span><a name="line-1717"></a><span>    </span><a name="local-6989586621682873686"><a href="#local-6989586621682873686"><span class="hs-identifier">go_mco</span></a></a><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-1718"></a><span>    </span><span class="hs-identifier">go_mco</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621682873701"><a href="#local-6989586621682873701"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873701"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1719"></a><span>
</span><a name="line-1720"></a><span>    </span><a name="local-6989586621682873687"><a href="#local-6989586621682873687"><span class="hs-identifier">go_co</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Refl"><span class="hs-identifier hs-var">Refl</span></a><span> </span><a name="local-6989586621682873702"><a href="#local-6989586621682873702"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873702"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1721"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#GRefl"><span class="hs-identifier hs-var">GRefl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873703"><a href="#local-6989586621682873703"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682873704"><a href="#local-6989586621682873704"><span class="hs-identifier">mco</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873703"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873686"><span class="hs-identifier hs-var">go_mco</span></a><span> </span><a href="#local-6989586621682873704"><span class="hs-identifier hs-var">mco</span></a><span>
</span><a name="line-1722"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConAppCo"><span class="hs-identifier hs-var">TyConAppCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873705"><a href="#local-6989586621682873705"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873688"><span class="hs-identifier hs-var">go_cos</span></a><span> </span><a href="#local-6989586621682873705"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1723"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppCo"><span class="hs-identifier hs-var">AppCo</span></a><span> </span><a name="local-6989586621682873706"><a href="#local-6989586621682873706"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682873707"><a href="#local-6989586621682873707"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873706"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873707"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1724"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllCo"><span class="hs-identifier hs-var">ForAllCo</span></a><span> </span><a name="local-6989586621682873708"><a href="#local-6989586621682873708"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682873709"><a href="#local-6989586621682873709"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-6989586621682873710"><a href="#local-6989586621682873710"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1725"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unionVarSets"><span class="hs-identifier hs-var">unionVarSets</span></a><span> </span><span class="hs-special">[</span><a href="VarSet.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a><span> </span><a href="#local-6989586621682873708"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873710"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873709"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">]</span><span>
</span><a name="line-1726"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunCo"><span class="hs-identifier hs-var">FunCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873711"><a href="#local-6989586621682873711"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621682873712"><a href="#local-6989586621682873712"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873711"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873712"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-1727"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoVarCo"><span class="hs-identifier hs-var">CoVarCo</span></a><span> </span><a name="local-6989586621682873713"><a href="#local-6989586621682873713"><span class="hs-identifier">cv</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a><span> </span><a href="#local-6989586621682873713"><span class="hs-identifier hs-var">cv</span></a><span>
</span><a name="line-1728"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#HoleCo"><span class="hs-identifier hs-var">HoleCo</span></a><span> </span><a name="local-6989586621682873714"><a href="#local-6989586621682873714"><span class="hs-identifier">h</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#unitVarSet"><span class="hs-identifier hs-var">unitVarSet</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#coHoleCoVar"><span class="hs-identifier hs-var">coHoleCoVar</span></a><span> </span><a href="#local-6989586621682873714"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">)</span><span>
</span><a name="line-1729"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomInstCo"><span class="hs-identifier hs-var">AxiomInstCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873715"><a href="#local-6989586621682873715"><span class="hs-identifier">cos</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873688"><span class="hs-identifier hs-var">go_cos</span></a><span> </span><a href="#local-6989586621682873715"><span class="hs-identifier hs-var">cos</span></a><span>
</span><a name="line-1730"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#UnivCo"><span class="hs-identifier hs-var">UnivCo</span></a><span> </span><a name="local-6989586621682873716"><a href="#local-6989586621682873716"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873717"><a href="#local-6989586621682873717"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682873718"><a href="#local-6989586621682873718"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873689"><span class="hs-identifier hs-var">go_prov</span></a><span> </span><a href="#local-6989586621682873716"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873717"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873685"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682873718"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1731"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SymCo"><span class="hs-identifier hs-var">SymCo</span></a><span> </span><a name="local-6989586621682873719"><a href="#local-6989586621682873719"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873719"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1732"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TransCo"><span class="hs-identifier hs-var">TransCo</span></a><span> </span><a name="local-6989586621682873720"><a href="#local-6989586621682873720"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621682873721"><a href="#local-6989586621682873721"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873720"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873721"><span class="hs-identifier hs-var">c2</span></a><span>
</span><a name="line-1733"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#NthCo"><span class="hs-identifier hs-var">NthCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873722"><a href="#local-6989586621682873722"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873722"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1734"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#LRCo"><span class="hs-identifier hs-var">LRCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873723"><a href="#local-6989586621682873723"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873723"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1735"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#InstCo"><span class="hs-identifier hs-var">InstCo</span></a><span> </span><a name="local-6989586621682873724"><a href="#local-6989586621682873724"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621682873725"><a href="#local-6989586621682873725"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873724"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873725"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-1736"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#KindCo"><span class="hs-identifier hs-var">KindCo</span></a><span> </span><a name="local-6989586621682873726"><a href="#local-6989586621682873726"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873726"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1737"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#SubCo"><span class="hs-identifier hs-var">SubCo</span></a><span> </span><a name="local-6989586621682873727"><a href="#local-6989586621682873727"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873727"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1738"></a><span>    </span><span class="hs-identifier">go_co</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AxiomRuleCo"><span class="hs-identifier hs-var">AxiomRuleCo</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682873728"><a href="#local-6989586621682873728"><span class="hs-identifier">cs</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873688"><span class="hs-identifier hs-var">go_cos</span></a><span> </span><a href="#local-6989586621682873728"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-1739"></a><span>
</span><a name="line-1740"></a><span>    </span><a name="local-6989586621682873688"><a href="#local-6989586621682873688"><span class="hs-identifier">go_cos</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span class="hs-special">)</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-1741"></a><span>
</span><a name="line-1742"></a><span>    </span><a name="local-6989586621682873689"><a href="#local-6989586621682873689"><span class="hs-identifier">go_prov</span></a></a><span> </span><a href="TyCoRep.html#UnsafeCoerceProv"><span class="hs-identifier hs-var">UnsafeCoerceProv</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-1743"></a><span>    </span><span class="hs-identifier">go_prov</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PhantomProv"><span class="hs-identifier hs-var">PhantomProv</span></a><span> </span><a name="local-6989586621682873729"><a href="#local-6989586621682873729"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873729"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1744"></a><span>    </span><span class="hs-identifier">go_prov</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ProofIrrelProv"><span class="hs-identifier hs-var">ProofIrrelProv</span></a><span> </span><a name="local-6989586621682873730"><a href="#local-6989586621682873730"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682873687"><span class="hs-identifier hs-var">go_co</span></a><span> </span><a href="#local-6989586621682873730"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1745"></a><span>    </span><span class="hs-identifier">go_prov</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#PluginProv"><span class="hs-identifier hs-var">PluginProv</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span>
</span><a name="line-1746"></a><span>
</span><a name="line-1747"></a><span class="hs-identifier">mkFlattenFreshTyName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Unique.html#Uniquable"><span class="hs-identifier hs-type">Uniquable</span></a><span> </span><a href="#local-6989586621682873196"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621682873196"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1748"></a><a name="mkFlattenFreshTyName"><a href="FamInstEnv.html#mkFlattenFreshTyName"><span class="hs-identifier">mkFlattenFreshTyName</span></a></a><span> </span><a name="local-6989586621682873731"><a href="#local-6989586621682873731"><span class="hs-identifier">unq</span></a></a><span>
</span><a name="line-1749"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#mkSysTvName"><span class="hs-identifier hs-var">mkSysTvName</span></a><span> </span><span class="hs-special">(</span><a href="Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a><span> </span><a href="#local-6989586621682873731"><span class="hs-identifier hs-var">unq</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;flt&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1750"></a><span>
</span><a name="line-1751"></a><span class="hs-identifier">mkFlattenFreshCoName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1752"></a><a name="mkFlattenFreshCoName"><a href="FamInstEnv.html#mkFlattenFreshCoName"><span class="hs-identifier">mkFlattenFreshCoName</span></a></a><span>
</span><a name="line-1753"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#mkSystemVarName"><span class="hs-identifier hs-var">mkSystemVarName</span></a><span> </span><span class="hs-special">(</span><a href="Unique.html#deriveUnique"><span class="hs-identifier hs-var">deriveUnique</span></a><span> </span><a href="PrelNames.html#eqPrimTyConKey"><span class="hs-identifier hs-var">eqPrimTyConKey</span></a><span> </span><span class="hs-number">71</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a><span> </span><span class="hs-string">&quot;flc&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1754"></a></pre></body></html>