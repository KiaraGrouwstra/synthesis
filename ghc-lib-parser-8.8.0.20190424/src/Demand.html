<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998

\section[Demand]{@Demand@: A decoupled implementation of a demand domain}
-}</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE CPP, FlexibleInstances, TypeSynonymInstances, RecordWildCards #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Demand</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-11"></a><span>        </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>        </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#DmdShell"><span class="hs-identifier hs-type">DmdShell</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#getStrDmd"><span class="hs-identifier hs-var">getStrDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#getUseDmd"><span class="hs-identifier hs-var">getUseDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="Demand.html#mkProdDmd"><span class="hs-identifier hs-var">mkProdDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#mkOnceUsedDmd"><span class="hs-identifier hs-var">mkOnceUsedDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#mkManyUsedDmd"><span class="hs-identifier hs-var">mkManyUsedDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#mkHeadStrict"><span class="hs-identifier hs-var">mkHeadStrict</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#oneifyDmd"><span class="hs-identifier hs-var">oneifyDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="Demand.html#toCleanDmd"><span class="hs-identifier hs-var">toCleanDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="Demand.html#absDmd"><span class="hs-identifier hs-var">absDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#botDmd"><span class="hs-identifier hs-var">botDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#seqDmd"><span class="hs-identifier hs-var">seqDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="Demand.html#lubDmd"><span class="hs-identifier hs-var">lubDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#bothDmd"><span class="hs-identifier hs-var">bothDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="Demand.html#lazyApply1Dmd"><span class="hs-identifier hs-var">lazyApply1Dmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#lazyApply2Dmd"><span class="hs-identifier hs-var">lazyApply2Dmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#strictApply1Dmd"><span class="hs-identifier hs-var">strictApply1Dmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="Demand.html#catchArgDmd"><span class="hs-identifier hs-var">catchArgDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="Demand.html#isTopDmd"><span class="hs-identifier hs-var">isTopDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#isAbsDmd"><span class="hs-identifier hs-var">isAbsDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#isSeqDmd"><span class="hs-identifier hs-var">isSeqDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="Demand.html#peelUseCall"><span class="hs-identifier hs-var">peelUseCall</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#cleanUseDmd_maybe"><span class="hs-identifier hs-var">cleanUseDmd_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#strictenDmd"><span class="hs-identifier hs-var">strictenDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#bothCleanDmd"><span class="hs-identifier hs-var">bothCleanDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="Demand.html#addCaseBndrDmd"><span class="hs-identifier hs-var">addCaseBndrDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span>        </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Demand.html#dmdTypeDepth"><span class="hs-identifier hs-var">dmdTypeDepth</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#lubDmdType"><span class="hs-identifier hs-var">lubDmdType</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#bothDmdType"><span class="hs-identifier hs-var">bothDmdType</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="Demand.html#nopDmdType"><span class="hs-identifier hs-var">nopDmdType</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#botDmdType"><span class="hs-identifier hs-var">botDmdType</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#mkDmdType"><span class="hs-identifier hs-var">mkDmdType</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="Demand.html#addDemand"><span class="hs-identifier hs-var">addDemand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#removeDmdTyArgs"><span class="hs-identifier hs-var">removeDmdTyArgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="Demand.html#BothDmdArg"><span class="hs-identifier hs-type">BothDmdArg</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#mkBothDmdArg"><span class="hs-identifier hs-var">mkBothDmdArg</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#toBothDmdArg"><span class="hs-identifier hs-var">toBothDmdArg</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span>        </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="Demand.html#peelFV"><span class="hs-identifier hs-var">peelFV</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#findIdDemand"><span class="hs-identifier hs-var">findIdDemand</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>
</span><a name="line-32"></a><span>        </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="Demand.html#isBotRes"><span class="hs-identifier hs-var">isBotRes</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#isTopRes"><span class="hs-identifier hs-var">isTopRes</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="Demand.html#topRes"><span class="hs-identifier hs-var">topRes</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#botRes"><span class="hs-identifier hs-var">botRes</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#exnRes"><span class="hs-identifier hs-var">exnRes</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#cprProdRes"><span class="hs-identifier hs-var">cprProdRes</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>        </span><a href="Demand.html#vanillaCprProdRes"><span class="hs-identifier hs-var">vanillaCprProdRes</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#cprSumRes"><span class="hs-identifier hs-var">cprSumRes</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="Demand.html#appIsBottom"><span class="hs-identifier hs-var">appIsBottom</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#isBottomingSig"><span class="hs-identifier hs-var">isBottomingSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#pprIfaceStrictSig"><span class="hs-identifier hs-var">pprIfaceStrictSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>        </span><a href="Demand.html#trimCPRInfo"><span class="hs-identifier hs-var">trimCPRInfo</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#returnsCPR_maybe"><span class="hs-identifier hs-var">returnsCPR_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Demand.html#mkStrictSig"><span class="hs-identifier hs-var">mkStrictSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#mkClosedStrictSig"><span class="hs-identifier hs-var">mkClosedStrictSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="Demand.html#nopSig"><span class="hs-identifier hs-var">nopSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#botSig"><span class="hs-identifier hs-var">botSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#exnSig"><span class="hs-identifier hs-var">exnSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#cprProdSig"><span class="hs-identifier hs-var">cprProdSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>        </span><a href="Demand.html#isTopSig"><span class="hs-identifier hs-var">isTopSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#hasDemandEnvSig"><span class="hs-identifier hs-var">hasDemandEnvSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-41"></a><span>        </span><a href="Demand.html#splitStrictSig"><span class="hs-identifier hs-var">splitStrictSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#strictSigDmdEnv"><span class="hs-identifier hs-var">strictSigDmdEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><a href="Demand.html#increaseStrictSigArity"><span class="hs-identifier hs-var">increaseStrictSigArity</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#etaExpandStrictSig"><span class="hs-identifier hs-var">etaExpandStrictSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span>        </span><a href="Demand.html#seqDemand"><span class="hs-identifier hs-var">seqDemand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#seqDemandList"><span class="hs-identifier hs-var">seqDemandList</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#seqDmdType"><span class="hs-identifier hs-var">seqDmdType</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#seqStrictSig"><span class="hs-identifier hs-var">seqStrictSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span>        </span><a href="Demand.html#evalDmd"><span class="hs-identifier hs-var">evalDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#cleanEvalDmd"><span class="hs-identifier hs-var">cleanEvalDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#cleanEvalProdDmd"><span class="hs-identifier hs-var">cleanEvalProdDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#isStrictDmd"><span class="hs-identifier hs-var">isStrictDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>        </span><a href="Demand.html#splitDmdTy"><span class="hs-identifier hs-var">splitDmdTy</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#splitFVs"><span class="hs-identifier hs-var">splitFVs</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>        </span><a href="Demand.html#deferAfterIO"><span class="hs-identifier hs-var">deferAfterIO</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>        </span><a href="Demand.html#postProcessUnsat"><span class="hs-identifier hs-var">postProcessUnsat</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#postProcessDmdType"><span class="hs-identifier hs-var">postProcessDmdType</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>        </span><a href="Demand.html#splitProdDmd_maybe"><span class="hs-identifier hs-var">splitProdDmd_maybe</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#peelCallDmd"><span class="hs-identifier hs-var">peelCallDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#peelManyCalls"><span class="hs-identifier hs-var">peelManyCalls</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#mkCallDmd"><span class="hs-identifier hs-var">mkCallDmd</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>        </span><a href="Demand.html#mkWorkerDemand"><span class="hs-identifier hs-var">mkWorkerDemand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#dmdTransformSig"><span class="hs-identifier hs-var">dmdTransformSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#dmdTransformDataConSig"><span class="hs-identifier hs-var">dmdTransformDataConSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>        </span><a href="Demand.html#dmdTransformDictSelSig"><span class="hs-identifier hs-var">dmdTransformDictSelSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#argOneShots"><span class="hs-identifier hs-var">argOneShots</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#argsOneShots"><span class="hs-identifier hs-var">argsOneShots</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#saturatedByOneShots"><span class="hs-identifier hs-var">saturatedByOneShots</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>        </span><a href="Demand.html#trimToType"><span class="hs-identifier hs-var">trimToType</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span>        </span><a href="Demand.html#useCount"><span class="hs-identifier hs-var">useCount</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#isUsedOnce"><span class="hs-identifier hs-var">isUsedOnce</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#reuseEnv"><span class="hs-identifier hs-var">reuseEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>        </span><a href="Demand.html#killUsageDemand"><span class="hs-identifier hs-var">killUsageDemand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#killUsageSig"><span class="hs-identifier hs-var">killUsageSig</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#zapUsageDemand"><span class="hs-identifier hs-var">zapUsageDemand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#zapUsageEnvSig"><span class="hs-identifier hs-var">zapUsageEnvSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>        </span><a href="Demand.html#zapUsedOnceDemand"><span class="hs-identifier hs-var">zapUsedOnceDemand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#zapUsedOnceSig"><span class="hs-identifier hs-var">zapUsedOnceSig</span></a><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>        </span><a href="Demand.html#strictifyDictDmd"><span class="hs-identifier hs-var">strictifyDictDmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#strictifyDmd"><span class="hs-identifier hs-var">strictifyDmd</span></a><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span>     </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="Binary.html"><span class="hs-identifier">Binary</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>            </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>           </span><span class="hs-special">(</span><span> </span><a href="TyCon.html#isNewTyCon"><span class="hs-identifier hs-var">isNewTyCon</span></a><span class="hs-special">,</span><span> </span><a href="TyCon.html#isClassTyCon"><span class="hs-identifier hs-var">isClassTyCon</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="DataCon.html#splitDataProductType_maybe"><span class="hs-identifier hs-var">splitDataProductType_maybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Joint domain for Strictness and Absence
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-keyword">data</span><span> </span><a name="JointDmd"><a href="Demand.html#JointDmd"><span class="hs-identifier">JointDmd</span></a></a><span> </span><a name="local-6989586621682209570"><a href="#local-6989586621682209570"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621682209571"><a href="#local-6989586621682209571"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="JD"><a href="Demand.html#JD"><span class="hs-identifier">JD</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="sd"><a href="Demand.html#sd"><span class="hs-identifier">sd</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621682209570"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">,</span><span> </span><a name="ud"><a href="Demand.html#ud"><span class="hs-identifier">ud</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621682209571"><span class="hs-identifier hs-type">u</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-90"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-identifier">getStrDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="#local-6989586621682209699"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621682209700"><span class="hs-identifier hs-type">u</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682209699"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-93"></a><a name="getStrDmd"><a href="Demand.html#getStrDmd"><span class="hs-identifier">getStrDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">sd</span><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-identifier">getUseDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="#local-6989586621682209697"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621682209698"><span class="hs-identifier hs-type">u</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682209698"><span class="hs-identifier hs-type">u</span></a><span>
</span><a name="line-96"></a><a name="getUseDmd"><a href="Demand.html#getUseDmd"><span class="hs-identifier">getUseDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ud</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">-- Pretty-printing</span><span>
</span><a name="line-99"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-6989586621682209678"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-6989586621682209679"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="#local-6989586621682209678"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621682209679"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-100"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209680"><a href="#local-6989586621682209680"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209681"><a href="#local-6989586621682209681"><span class="hs-identifier">u</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#angleBrackets"><span class="hs-identifier hs-var">angleBrackets</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209680"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">','</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209681"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-comment">-- Well-formedness preserving constructors for the joint domain</span><span>
</span><a name="line-103"></a><span class="hs-identifier">mkJointDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621682209695"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682209696"><span class="hs-identifier hs-type">u</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="#local-6989586621682209695"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621682209696"><span class="hs-identifier hs-type">u</span></a><span>
</span><a name="line-104"></a><a name="mkJointDmd"><a href="Demand.html#mkJointDmd"><span class="hs-identifier">mkJointDmd</span></a></a><span> </span><a name="local-6989586621682209701"><a href="#local-6989586621682209701"><span class="hs-identifier">s</span></a></a><span> </span><a name="local-6989586621682209702"><a href="#local-6989586621682209702"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209701"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209702"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-identifier">mkJointDmds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682209693"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682209694"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="#local-6989586621682209693"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621682209694"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">]</span><span>
</span><a name="line-107"></a><a name="mkJointDmds"><a href="Demand.html#mkJointDmds"><span class="hs-identifier">mkJointDmds</span></a></a><span> </span><a name="local-6989586621682209703"><a href="#local-6989586621682209703"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#zipWithEqual"><span class="hs-identifier hs-var">zipWithEqual</span></a><span> </span><span class="hs-string">&quot;mkJointDmds&quot;</span><span> </span><a href="Demand.html#mkJointDmd"><span class="hs-identifier hs-var">mkJointDmd</span></a><span> </span><a href="#local-6989586621682209703"><span class="hs-identifier hs-var">ss</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span>
</span><a name="line-110"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
            Strictness domain
*                                                                      *
************************************************************************

        Lazy
         |
  ExnStr x -
           |
        HeadStr
        /     \
    SCall      SProd
        \      /
        HyperStr

Note [Exceptions and strictness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Exceptions need rather careful treatment, especially because of 'catch'
('catch#'), 'catchSTM' ('catchSTM#'), and 'orElse' ('catchRetry#').
See Trac #11555, #10712 and #13330, and for some more background, #11222.

There are three main pieces.

* The Termination type includes ThrowsExn, meaning &quot;under the given
  demand this expression either diverges or throws an exception&quot;.

  This is relatively uncontroversial. The primops raise# and
  raiseIO# both return ThrowsExn; nothing else does.

* An ArgStr has an ExnStr flag to say how to process the Termination
  result of the argument.  If the ExnStr flag is ExnStr, we squash
  ThrowsExn to topRes.  (This is done in postProcessDmdResult.)

Here is the key example

    catchRetry# (\s -&gt; retry# s) blah

We analyse the argument (\s -&gt; retry# s) with demand
    Str ExnStr (SCall HeadStr)
i.e. with the ExnStr flag set.
  - First we analyse the argument with the &quot;clean-demand&quot; (SCall
    HeadStr), getting a DmdResult of ThrowsExn from the saturated
    application of retry#.
  - Then we apply the post-processing for the shell, squashing the
    ThrowsExn to topRes.

This also applies uniformly to free variables.  Consider

    let r = \st -&gt; retry# st
    in catchRetry# (\s -&gt; ...(r s')..) handler st

If we give the first argument of catch a strict signature, we'll get a demand
'C(S)' for 'r'; that is, 'r' is definitely called with one argument, which
indeed it is.  But when we post-process the free-var demands on catchRetry#'s
argument (in postProcessDmdEnv), we'll give 'r' a demand of (Str ExnStr (SCall
HeadStr)); and if we feed that into r's RHS (which would be reasonable) we'll
squash the retry just as if we'd inlined 'r'.

* We don't try to get clever about 'catch#' and 'catchSTM#' at the moment. We
previously (#11222) tried to take advantage of the fact that 'catch#' calls its
first argument eagerly. See especially commit
9915b6564403a6d17651e9969e9ea5d7d7e78e7f. We analyzed that first argument with
a strict demand, and then performed a post-processing step at the end to change
ThrowsExn to TopRes.  The trouble, I believe, is that to use this approach
correctly, we'd need somewhat different information about that argument.
Diverges, ThrowsExn (i.e., diverges or throws an exception), and Dunno are the
wrong split here.  In order to evaluate part of the argument speculatively,
we'd need to know that it *does not throw an exception*. That is, that it
either diverges or succeeds. But we don't currently have a way to talk about
that. Abstractly and approximately,

catch# m f s = case ORACLE m s of
  DivergesOrSucceeds -&gt; m s
  Fails exc -&gt; f exc s

where the magical ORACLE determines whether or not (m s) throws an exception
when run, and if so which one. If we want, we can safely consider (catch# m f s)
strict in anything that both branches are strict in (by performing demand
analysis for 'catch#' in the same way we do for case). We could also safely
consider it strict in anything demanded by (m s) that is guaranteed not to
throw an exception under that demand, but I don't know if we have the means
to express that.

My mind keeps turning to this model (not as an actual change to the type, but
as a way to think about what's going on in the analysis):

newtype IO a = IO {unIO :: State# s -&gt; (# s, (# SomeException | a #) #)}
instance Monad IO where
  return a = IO $ \s -&gt; (# s, (# | a #) #)
  IO m &gt;&gt;= f = IO $ \s -&gt; case m s of
    (# s', (# e | #) #) -&gt; (# s', e #)
    (# s', (# | a #) #) -&gt; unIO (f a) s
raiseIO# e s = (# s, (# e | #) #)
catch# m f s = case m s of
  (# s', (# e | #) #) -&gt; f e s'
  res -&gt; res

Thinking about it this way seems likely to be productive for analyzing IO
exception behavior, but imprecise exceptions and asynchronous exceptions remain
quite slippery beasts. Can we incorporate them? I think we can. We can imagine
applying 'seq#' to evaluate @m s@, determining whether it throws an imprecise
or asynchronous exception or whether it succeeds or throws an IO exception.
This confines the peculiarities to 'seq#', which is indeed rather essentially
peculiar.
-}</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-comment">-- | Vanilla strictness domain</span><span>
</span><a name="line-219"></a><span class="hs-keyword">data</span><span> </span><a name="StrDmd"><a href="Demand.html#StrDmd"><span class="hs-identifier">StrDmd</span></a></a><span>
</span><a name="line-220"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="HyperStr"><a href="Demand.html#HyperStr"><span class="hs-identifier">HyperStr</span></a></a><span>             </span><span class="hs-comment">-- ^ Hyper-strict (bottom of the lattice).</span><span>
</span><a name="line-221"></a><span>                         </span><span class="hs-comment">-- See Note [HyperStr and Use demands]</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="SCall"><a href="Demand.html#SCall"><span class="hs-identifier">SCall</span></a></a><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span>         </span><span class="hs-comment">-- ^ Call demand</span><span>
</span><a name="line-224"></a><span>                         </span><span class="hs-comment">-- Used only for values of function type</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="SProd"><a href="Demand.html#SProd"><span class="hs-identifier">SProd</span></a></a><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- ^ Product</span><span>
</span><a name="line-227"></a><span>                         </span><span class="hs-comment">-- Used only for values of product type</span><span>
</span><a name="line-228"></a><span>                         </span><span class="hs-comment">-- Invariant: not all components are HyperStr (use HyperStr)</span><span>
</span><a name="line-229"></a><span>                         </span><span class="hs-comment">--            not all components are Lazy     (use HeadStr)</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="HeadStr"><a href="Demand.html#HeadStr"><span class="hs-identifier">HeadStr</span></a></a><span>              </span><span class="hs-comment">-- ^ Head-Strict</span><span>
</span><a name="line-232"></a><span>                         </span><span class="hs-comment">-- A polymorphic demand: used for values of all types,</span><span>
</span><a name="line-233"></a><span>                         </span><span class="hs-comment">--                       including a type variable</span><span>
</span><a name="line-234"></a><span>
</span><a name="line-235"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-comment">-- | Strictness of a function argument.</span><span>
</span><a name="line-238"></a><span class="hs-keyword">type</span><span> </span><a name="ArgStr"><a href="Demand.html#ArgStr"><span class="hs-identifier">ArgStr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-type">Str</span></a><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-comment">-- | Strictness demand.</span><span>
</span><a name="line-241"></a><span class="hs-keyword">data</span><span> </span><a name="Str"><a href="Demand.html#Str"><span class="hs-identifier">Str</span></a></a><span> </span><a name="local-6989586621682209569"><a href="#local-6989586621682209569"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Lazy"><a href="Demand.html#Lazy"><span class="hs-identifier">Lazy</span></a></a><span>         </span><span class="hs-comment">-- ^ Lazy (top of the lattice)</span><span>
</span><a name="line-242"></a><span>           </span><span class="hs-glyph">|</span><span> </span><a name="Str"><a href="Demand.html#Str"><span class="hs-identifier">Str</span></a></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-type">ExnStr</span></a><span> </span><a href="#local-6989586621682209569"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-comment">-- ^ Strict</span><span>
</span><a name="line-243"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-comment">-- | How are exceptions handled for strict demands?</span><span>
</span><a name="line-246"></a><span class="hs-keyword">data</span><span> </span><a name="ExnStr"><a href="Demand.html#ExnStr"><span class="hs-identifier">ExnStr</span></a></a><span>  </span><span class="hs-comment">-- See Note [Exceptions and strictness]</span><span>
</span><a name="line-247"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="VanStr"><a href="Demand.html#VanStr"><span class="hs-identifier">VanStr</span></a></a><span>   </span><span class="hs-comment">-- ^ &quot;Vanilla&quot; case, ordinary strictness</span><span>
</span><a name="line-248"></a><span>
</span><a name="line-249"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ExnStr"><a href="Demand.html#ExnStr"><span class="hs-identifier">ExnStr</span></a></a><span>   </span><span class="hs-comment">-- ^ @Str ExnStr d@ means be strict like @d@ but then degrade</span><span>
</span><a name="line-250"></a><span>             </span><span class="hs-comment">-- the 'Termination' info 'ThrowsExn' to 'Dunno'.</span><span>
</span><a name="line-251"></a><span>             </span><span class="hs-comment">-- e.g. the first argument of @catch@ has this strictness.</span><span>
</span><a name="line-252"></a><span>  </span><span class="hs-keyword">deriving</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span>
</span><a name="line-254"></a><span class="hs-comment">-- Well-formedness preserving constructors for the Strictness domain</span><span>
</span><a name="line-255"></a><span class="hs-identifier">strBot</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">strTop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span>
</span><a name="line-256"></a><a name="strBot"><a href="Demand.html#strBot"><span class="hs-identifier">strBot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-257"></a><a name="strTop"><a href="Demand.html#strTop"><span class="hs-identifier">strTop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-identifier">mkSCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span>
</span><a name="line-260"></a><a name="mkSCall"><a href="Demand.html#mkSCall"><span class="hs-identifier">mkSCall</span></a></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-261"></a><span class="hs-identifier">mkSCall</span><span> </span><a name="local-6989586621682209705"><a href="#local-6989586621682209705"><span class="hs-identifier">s</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a href="#local-6989586621682209705"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-identifier">mkSProd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span>
</span><a name="line-264"></a><a name="mkSProd"><a href="Demand.html#mkSProd"><span class="hs-identifier">mkSProd</span></a></a><span> </span><a name="local-6989586621682209706"><a href="#local-6989586621682209706"><span class="hs-identifier">sx</span></a></a><span>
</span><a name="line-265"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="Demand.html#isHyperStr"><span class="hs-identifier hs-var">isHyperStr</span></a><span> </span><a href="#local-6989586621682209706"><span class="hs-identifier hs-var">sx</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-266"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="Demand.html#isLazy"><span class="hs-identifier hs-var">isLazy</span></a><span>     </span><a href="#local-6989586621682209706"><span class="hs-identifier hs-var">sx</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-267"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a href="#local-6989586621682209706"><span class="hs-identifier hs-var">sx</span></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-identifier">isLazy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-270"></a><a name="isLazy"><a href="Demand.html#isLazy"><span class="hs-identifier">isLazy</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-271"></a><span class="hs-identifier">isLazy</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span class="hs-identifier">isHyperStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-274"></a><a name="isHyperStr"><a href="Demand.html#isHyperStr"><span class="hs-identifier">isHyperStr</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-275"></a><span class="hs-identifier">isHyperStr</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-comment">-- Pretty-printing</span><span>
</span><a name="line-278"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-279"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'B'</span><span>
</span><a name="line-280"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209676"><a href="#local-6989586621682209676"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'C'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209676"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'S'</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209677"><a href="#local-6989586621682209677"><span class="hs-identifier">sx</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'S'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#hcat"><span class="hs-identifier hs-var">hcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209677"><span class="hs-identifier hs-var">sx</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><span>
</span><a name="line-284"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-285"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209674"><a href="#local-6989586621682209674"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682209675"><a href="#local-6989586621682209675"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209674"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span class="hs-special">;</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'x'</span><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>                      </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209675"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-287"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'L'</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-identifier">lubArgStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span>
</span><a name="line-290"></a><a name="lubArgStr"><a href="Demand.html#lubArgStr"><span class="hs-identifier">lubArgStr</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>        </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-291"></a><span class="hs-identifier">lubArgStr</span><span> </span><span class="hs-identifier">_</span><span>           </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-292"></a><span class="hs-identifier">lubArgStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209707"><a href="#local-6989586621682209707"><span class="hs-identifier">x1</span></a></a><span> </span><a name="local-6989586621682209708"><a href="#local-6989586621682209708"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209709"><a href="#local-6989586621682209709"><span class="hs-identifier">x2</span></a></a><span> </span><a name="local-6989586621682209710"><a href="#local-6989586621682209710"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209707"><span class="hs-identifier hs-var">x1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#lubExnStr"><span class="hs-identifier hs-var">lubExnStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209709"><span class="hs-identifier hs-var">x2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209708"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#lubStr"><span class="hs-identifier hs-var">lubStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209710"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-identifier">lubExnStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-type">ExnStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-type">ExnStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-type">ExnStr</span></a><span>
</span><a name="line-295"></a><a name="lubExnStr"><a href="Demand.html#lubExnStr"><span class="hs-identifier">lubExnStr</span></a></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span>
</span><a name="line-296"></a><span class="hs-identifier">lubExnStr</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span>   </span><span class="hs-comment">-- ExnStr is lazier</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span>
</span><a name="line-299"></a><a name="lubStr"><a href="Demand.html#lubStr"><span class="hs-identifier">lubStr</span></a></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span> </span><a name="local-6989586621682209711"><a href="#local-6989586621682209711"><span class="hs-identifier">s</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209711"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-300"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209712"><a href="#local-6989586621682209712"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a href="#local-6989586621682209712"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-301"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-302"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209713"><a href="#local-6989586621682209713"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209714"><a href="#local-6989586621682209714"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209713"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#lubStr"><span class="hs-identifier hs-var">lubStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209714"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-304"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209715"><a href="#local-6989586621682209715"><span class="hs-identifier">sx</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a href="#local-6989586621682209715"><span class="hs-identifier hs-var">sx</span></a><span>
</span><a name="line-305"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-306"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209716"><a href="#local-6989586621682209716"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209717"><a href="#local-6989586621682209717"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-307"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209716"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209717"><span class="hs-identifier hs-var">s2</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkSProd"><span class="hs-identifier hs-var">mkSProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Demand.html#lubArgStr"><span class="hs-identifier hs-var">lubArgStr</span></a><span> </span><a href="#local-6989586621682209716"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682209717"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-309"></a><span class="hs-identifier">lubStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-310"></a><span class="hs-identifier">lubStr</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>   </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-identifier">bothArgStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span>
</span><a name="line-313"></a><a name="bothArgStr"><a href="Demand.html#bothArgStr"><span class="hs-identifier">bothArgStr</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>        </span><a name="local-6989586621682209718"><a href="#local-6989586621682209718"><span class="hs-identifier">s</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209718"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-314"></a><span class="hs-identifier">bothArgStr</span><span> </span><a name="local-6989586621682209719"><a href="#local-6989586621682209719"><span class="hs-identifier">s</span></a></a><span>           </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209719"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-315"></a><span class="hs-identifier">bothArgStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209720"><a href="#local-6989586621682209720"><span class="hs-identifier">x1</span></a></a><span> </span><a name="local-6989586621682209721"><a href="#local-6989586621682209721"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209722"><a href="#local-6989586621682209722"><span class="hs-identifier">x2</span></a></a><span> </span><a name="local-6989586621682209723"><a href="#local-6989586621682209723"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209720"><span class="hs-identifier hs-var">x1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothExnStr"><span class="hs-identifier hs-var">bothExnStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209722"><span class="hs-identifier hs-var">x2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209721"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothStr"><span class="hs-identifier hs-var">bothStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209723"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-identifier">bothExnStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-type">ExnStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-type">ExnStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-type">ExnStr</span></a><span>
</span><a name="line-318"></a><a name="bothExnStr"><a href="Demand.html#bothExnStr"><span class="hs-identifier">bothExnStr</span></a></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span>
</span><a name="line-319"></a><span class="hs-identifier">bothExnStr</span><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-identifier">_</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span>
</span><a name="line-322"></a><a name="bothStr"><a href="Demand.html#bothStr"><span class="hs-identifier">bothStr</span></a></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-323"></a><span class="hs-identifier">bothStr</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span> </span><a name="local-6989586621682209724"><a href="#local-6989586621682209724"><span class="hs-identifier">s</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209724"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-324"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-325"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209725"><a href="#local-6989586621682209725"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a href="#local-6989586621682209725"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-326"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209726"><a href="#local-6989586621682209726"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209727"><a href="#local-6989586621682209727"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209726"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothStr"><span class="hs-identifier hs-var">bothStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209727"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>  </span><span class="hs-comment">-- Weird</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-330"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209728"><a href="#local-6989586621682209728"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a href="#local-6989586621682209728"><span class="hs-identifier hs-var">s1</span></a><span>
</span><a name="line-331"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209729"><a href="#local-6989586621682209729"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209730"><a href="#local-6989586621682209730"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-332"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209729"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209730"><span class="hs-identifier hs-var">s2</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkSProd"><span class="hs-identifier hs-var">mkSProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Demand.html#bothArgStr"><span class="hs-identifier hs-var">bothArgStr</span></a><span> </span><a href="#local-6989586621682209729"><span class="hs-identifier hs-var">s1</span></a><span> </span><a href="#local-6989586621682209730"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>  </span><span class="hs-comment">-- Weird</span><span>
</span><a name="line-334"></a><span class="hs-identifier">bothStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-335"></a><span>
</span><a name="line-336"></a><span class="hs-comment">-- utility functions to deal with memory leaks</span><span>
</span><a name="line-337"></a><span class="hs-identifier">seqStrDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-338"></a><a name="seqStrDmd"><a href="Demand.html#seqStrDmd"><span class="hs-identifier">seqStrDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209731"><a href="#local-6989586621682209731"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqStrDmdList"><span class="hs-identifier hs-var">seqStrDmdList</span></a><span> </span><a href="#local-6989586621682209731"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-339"></a><span class="hs-identifier">seqStrDmd</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209732"><a href="#local-6989586621682209732"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqStrDmd"><span class="hs-identifier hs-var">seqStrDmd</span></a><span> </span><a href="#local-6989586621682209732"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-340"></a><span class="hs-identifier">seqStrDmd</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span class="hs-identifier">seqStrDmdList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-343"></a><a name="seqStrDmdList"><a href="Demand.html#seqStrDmdList"><span class="hs-identifier">seqStrDmdList</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-344"></a><span class="hs-identifier">seqStrDmdList</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682209733"><a href="#local-6989586621682209733"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682209734"><a href="#local-6989586621682209734"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqArgStr"><span class="hs-identifier hs-var">seqArgStr</span></a><span> </span><a href="#local-6989586621682209733"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqStrDmdList"><span class="hs-identifier hs-var">seqStrDmdList</span></a><span> </span><a href="#local-6989586621682209734"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-345"></a><span>
</span><a name="line-346"></a><span class="hs-identifier">seqArgStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-347"></a><a name="seqArgStr"><a href="Demand.html#seqArgStr"><span class="hs-identifier">seqArgStr</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span class="hs-identifier">seqArgStr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209735"><a href="#local-6989586621682209735"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682209736"><a href="#local-6989586621682209736"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209735"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqStrDmd"><span class="hs-identifier hs-var">seqStrDmd</span></a><span> </span><a href="#local-6989586621682209736"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-349"></a><span>
</span><a name="line-350"></a><span class="hs-comment">-- Splitting polymorphic demands</span><span>
</span><a name="line-351"></a><span class="hs-identifier">splitArgStrProdDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span class="hs-special">]</span><span>
</span><a name="line-352"></a><a name="splitArgStrProdDmd"><a href="Demand.html#splitArgStrProdDmd"><span class="hs-identifier">splitArgStrProdDmd</span></a></a><span> </span><a name="local-6989586621682209737"><a href="#local-6989586621682209737"><span class="hs-identifier">n</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621682209737"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span class="hs-identifier">splitArgStrProdDmd</span><span> </span><a name="local-6989586621682209738"><a href="#local-6989586621682209738"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209739"><a href="#local-6989586621682209739"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#splitStrProdDmd"><span class="hs-identifier hs-var">splitStrProdDmd</span></a><span> </span><a href="#local-6989586621682209738"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682209739"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-identifier">splitStrProdDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span class="hs-special">]</span><span>
</span><a name="line-356"></a><a name="splitStrProdDmd"><a href="Demand.html#splitStrProdDmd"><span class="hs-identifier">splitStrProdDmd</span></a></a><span> </span><a name="local-6989586621682209740"><a href="#local-6989586621682209740"><span class="hs-identifier">n</span></a></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621682209740"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Demand.html#strBot"><span class="hs-identifier hs-var">strBot</span></a><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span class="hs-identifier">splitStrProdDmd</span><span> </span><a name="local-6989586621682209741"><a href="#local-6989586621682209741"><span class="hs-identifier">n</span></a></a><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621682209741"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Demand.html#strTop"><span class="hs-identifier hs-var">strTop</span></a><span class="hs-special">)</span><span>
</span><a name="line-358"></a><span class="hs-identifier">splitStrProdDmd</span><span> </span><a name="local-6989586621682209742"><a href="#local-6989586621682209742"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209743"><a href="#local-6989586621682209743"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-359"></a><span>                                     </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;splitStrProdDmd&quot;</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">n</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ds</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-360"></a><span>                               </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682209743"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-361"></a><span class="hs-identifier">splitStrProdDmd</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-362"></a><span>      </span><span class="hs-comment">-- This can happen when the programmer uses unsafeCoerce,</span><span>
</span><a name="line-363"></a><span>      </span><span class="hs-comment">-- and we don't then want to crash the compiler (Trac #9208)</span><span>
</span><a name="line-364"></a><span>
</span><a name="line-365"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
            Absence domain
*                                                                      *
************************************************************************

         Used
         /   \
     UCall   UProd
         \   /
         UHead
          |
  Count x -
        |
       Abs
-}</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">-- | Domain for genuine usage</span><span>
</span><a name="line-384"></a><span class="hs-keyword">data</span><span> </span><a name="UseDmd"><a href="Demand.html#UseDmd"><span class="hs-identifier">UseDmd</span></a></a><span>
</span><a name="line-385"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="UCall"><a href="Demand.html#UCall"><span class="hs-identifier">UCall</span></a></a><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>   </span><span class="hs-comment">-- ^ Call demand for absence.</span><span>
</span><a name="line-386"></a><span>                         </span><span class="hs-comment">-- Used only for values of function type</span><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UProd"><a href="Demand.html#UProd"><span class="hs-identifier">UProd</span></a></a><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- ^ Product.</span><span>
</span><a name="line-389"></a><span>                         </span><span class="hs-comment">-- Used only for values of product type</span><span>
</span><a name="line-390"></a><span>                         </span><span class="hs-comment">-- See Note [Don't optimise UProd(Used) to Used]</span><span>
</span><a name="line-391"></a><span>                         </span><span class="hs-comment">--</span><span>
</span><a name="line-392"></a><span>                         </span><span class="hs-comment">-- Invariant: Not all components are Abs</span><span>
</span><a name="line-393"></a><span>                         </span><span class="hs-comment">-- (in that case, use UHead)</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UHead"><a href="Demand.html#UHead"><span class="hs-identifier">UHead</span></a></a><span>                </span><span class="hs-comment">-- ^ May be used but its sub-components are</span><span>
</span><a name="line-396"></a><span>                         </span><span class="hs-comment">-- definitely *not* used.  For product types, UHead</span><span>
</span><a name="line-397"></a><span>                         </span><span class="hs-comment">-- is equivalent to U(AAA); see mkUProd.</span><span>
</span><a name="line-398"></a><span>                         </span><span class="hs-comment">--</span><span>
</span><a name="line-399"></a><span>                         </span><span class="hs-comment">-- UHead is needed only to express the demand</span><span>
</span><a name="line-400"></a><span>                         </span><span class="hs-comment">-- of 'seq' and 'case' which are polymorphic;</span><span>
</span><a name="line-401"></a><span>                         </span><span class="hs-comment">-- i.e. the scrutinised value is of type 'a'</span><span>
</span><a name="line-402"></a><span>                         </span><span class="hs-comment">-- rather than a product type. That's why we</span><span>
</span><a name="line-403"></a><span>                         </span><span class="hs-comment">-- can't use UProd [A,A,A]</span><span>
</span><a name="line-404"></a><span>                         </span><span class="hs-comment">--</span><span>
</span><a name="line-405"></a><span>                         </span><span class="hs-comment">-- Since (UCall _ Abs) is ill-typed, UHead doesn't</span><span>
</span><a name="line-406"></a><span>                         </span><span class="hs-comment">-- make sense for lambdas</span><span>
</span><a name="line-407"></a><span>
</span><a name="line-408"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Used"><a href="Demand.html#Used"><span class="hs-identifier">Used</span></a></a><span>                 </span><span class="hs-comment">-- ^ May be used and its sub-components may be used.</span><span>
</span><a name="line-409"></a><span>                         </span><span class="hs-comment">-- (top of the lattice)</span><span>
</span><a name="line-410"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>
</span><a name="line-412"></a><span class="hs-comment">-- Extended usage demand for absence and counting</span><span>
</span><a name="line-413"></a><span class="hs-keyword">type</span><span> </span><a name="ArgUse"><a href="Demand.html#ArgUse"><span class="hs-identifier">ArgUse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span class="hs-keyword">data</span><span> </span><a name="Use"><a href="Demand.html#Use"><span class="hs-identifier">Use</span></a></a><span> </span><a name="local-6989586621682209568"><a href="#local-6989586621682209568"><span class="hs-identifier">u</span></a></a><span>
</span><a name="line-416"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Abs"><a href="Demand.html#Abs"><span class="hs-identifier">Abs</span></a></a><span>             </span><span class="hs-comment">-- Definitely unused</span><span>
</span><a name="line-417"></a><span>                    </span><span class="hs-comment">-- Bottom of the lattice</span><span>
</span><a name="line-418"></a><span>
</span><a name="line-419"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Use"><a href="Demand.html#Use"><span class="hs-identifier">Use</span></a></a><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span> </span><a href="#local-6989586621682209568"><span class="hs-identifier hs-type">u</span></a><span>     </span><span class="hs-comment">-- May be used with some cardinality</span><span>
</span><a name="line-420"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span class="hs-comment">-- | Abstract counting of usages</span><span>
</span><a name="line-423"></a><span class="hs-keyword">data</span><span> </span><a name="Count"><a href="Demand.html#Count"><span class="hs-identifier">Count</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="One"><a href="Demand.html#One"><span class="hs-identifier">One</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="Many"><a href="Demand.html#Many"><span class="hs-identifier">Many</span></a></a><span>
</span><a name="line-424"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span class="hs-comment">-- Pretty-printing</span><span>
</span><a name="line-427"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-428"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'A'</span><span>
</span><a name="line-429"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><a name="local-6989586621682209672"><a href="#local-6989586621682209672"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209672"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-430"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>  </span><a name="local-6989586621682209673"><a href="#local-6989586621682209673"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'1'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'*'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209673"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-433"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'U'</span><span>
</span><a name="line-434"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209669"><a href="#local-6989586621682209669"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209670"><a href="#local-6989586621682209670"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'C'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209669"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209670"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-435"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'H'</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'U'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#hcat"><span class="hs-identifier hs-var">hcat</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">','</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-439"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'1'</span><span>
</span><a name="line-440"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-441"></a><span>
</span><a name="line-442"></a><span class="hs-identifier">useBot</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">useTop</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span>
</span><a name="line-443"></a><a name="useBot"><a href="Demand.html#useBot"><span class="hs-identifier">useBot</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>
</span><a name="line-444"></a><a name="useTop"><a href="Demand.html#useTop"><span class="hs-identifier">useTop</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span class="hs-identifier">mkUCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-447"></a><span class="hs-comment">--mkUCall c Used = Used c</span><span>
</span><a name="line-448"></a><a name="mkUCall"><a href="Demand.html#mkUCall"><span class="hs-identifier">mkUCall</span></a></a><span> </span><a name="local-6989586621682209744"><a href="#local-6989586621682209744"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209745"><a href="#local-6989586621682209745"><span class="hs-identifier">a</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="#local-6989586621682209744"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621682209745"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-449"></a><span>
</span><a name="line-450"></a><span class="hs-identifier">mkUProd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-451"></a><a name="mkUProd"><a href="Demand.html#mkUProd"><span class="hs-identifier">mkUProd</span></a></a><span> </span><a name="local-6989586621682209746"><a href="#local-6989586621682209746"><span class="hs-identifier">ux</span></a></a><span>
</span><a name="line-452"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209746"><span class="hs-identifier hs-var">ux</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>
</span><a name="line-453"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a href="#local-6989586621682209746"><span class="hs-identifier hs-var">ux</span></a><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-identifier">lubCount</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span>
</span><a name="line-456"></a><a name="lubCount"><a href="Demand.html#lubCount"><span class="hs-identifier">lubCount</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span>
</span><a name="line-457"></a><span class="hs-identifier">lubCount</span><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span>
</span><a name="line-458"></a><span class="hs-identifier">lubCount</span><span> </span><a name="local-6989586621682209747"><a href="#local-6989586621682209747"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier">_</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209747"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span class="hs-identifier">lubArgUse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span>
</span><a name="line-461"></a><a name="lubArgUse"><a href="Demand.html#lubArgUse"><span class="hs-identifier">lubArgUse</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span> </span><a name="local-6989586621682209748"><a href="#local-6989586621682209748"><span class="hs-identifier">x</span></a></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209748"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-462"></a><span class="hs-identifier">lubArgUse</span><span> </span><a name="local-6989586621682209749"><a href="#local-6989586621682209749"><span class="hs-identifier">x</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209749"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-463"></a><span class="hs-identifier">lubArgUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a name="local-6989586621682209750"><a href="#local-6989586621682209750"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621682209751"><a href="#local-6989586621682209751"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a name="local-6989586621682209752"><a href="#local-6989586621682209752"><span class="hs-identifier">c2</span></a></a><span> </span><a name="local-6989586621682209753"><a href="#local-6989586621682209753"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#lubCount"><span class="hs-identifier hs-var">lubCount</span></a><span> </span><a href="#local-6989586621682209750"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-6989586621682209752"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#lubUse"><span class="hs-identifier hs-var">lubUse</span></a><span> </span><a href="#local-6989586621682209751"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-6989586621682209753"><span class="hs-identifier hs-var">a2</span></a><span class="hs-special">)</span><span>
</span><a name="line-464"></a><span>
</span><a name="line-465"></a><span class="hs-identifier">lubUse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-466"></a><a name="lubUse"><a href="Demand.html#lubUse"><span class="hs-identifier">lubUse</span></a></a><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>       </span><a name="local-6989586621682209754"><a href="#local-6989586621682209754"><span class="hs-identifier">u</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209754"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-467"></a><span class="hs-identifier">lubUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209755"><a href="#local-6989586621682209755"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209756"><a href="#local-6989586621682209756"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="#local-6989586621682209755"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621682209756"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-468"></a><span class="hs-identifier">lubUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209757"><a href="#local-6989586621682209757"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621682209758"><a href="#local-6989586621682209758"><span class="hs-identifier">u1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209759"><a href="#local-6989586621682209759"><span class="hs-identifier">c2</span></a></a><span> </span><a name="local-6989586621682209760"><a href="#local-6989586621682209760"><span class="hs-identifier">u2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#lubCount"><span class="hs-identifier hs-var">lubCount</span></a><span> </span><a href="#local-6989586621682209757"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="#local-6989586621682209759"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#lubUse"><span class="hs-identifier hs-var">lubUse</span></a><span> </span><a href="#local-6989586621682209758"><span class="hs-identifier hs-var">u1</span></a><span> </span><a href="#local-6989586621682209760"><span class="hs-identifier hs-var">u2</span></a><span class="hs-special">)</span><span>
</span><a name="line-469"></a><span class="hs-identifier">lubUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-470"></a><span class="hs-identifier">lubUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209761"><a href="#local-6989586621682209761"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a href="#local-6989586621682209761"><span class="hs-identifier hs-var">ux</span></a><span>
</span><a name="line-471"></a><span class="hs-identifier">lubUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209762"><a href="#local-6989586621682209762"><span class="hs-identifier">ux1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209763"><a href="#local-6989586621682209763"><span class="hs-identifier">ux2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-472"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209762"><span class="hs-identifier hs-var">ux1</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209763"><span class="hs-identifier hs-var">ux2</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Demand.html#lubArgUse"><span class="hs-identifier hs-var">lubArgUse</span></a><span> </span><a href="#local-6989586621682209762"><span class="hs-identifier hs-var">ux1</span></a><span> </span><a href="#local-6989586621682209763"><span class="hs-identifier hs-var">ux2</span></a><span>
</span><a name="line-473"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-474"></a><span class="hs-identifier">lubUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-475"></a><span class="hs-comment">-- lubUse (UProd {}) Used             = Used</span><span>
</span><a name="line-476"></a><span class="hs-identifier">lubUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209764"><a href="#local-6989586621682209764"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Demand.html#lubArgUse"><span class="hs-identifier hs-var">lubArgUse</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209764"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span class="hs-identifier">lubUse</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>       </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209765"><a href="#local-6989586621682209765"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Demand.html#lubArgUse"><span class="hs-identifier hs-var">lubArgUse</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209765"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-478"></a><span class="hs-identifier">lubUse</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span> </span><span class="hs-identifier">_</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>  </span><span class="hs-comment">-- Note [Used should win]</span><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span class="hs-comment">-- `both` is different from `lub` in its treatment of counting; if</span><span>
</span><a name="line-481"></a><span class="hs-comment">-- `both` is computed for two used, the result always has</span><span>
</span><a name="line-482"></a><span class="hs-comment">--  cardinality `Many` (except for the inner demands of UCall demand -- [TODO] explain).</span><span>
</span><a name="line-483"></a><span class="hs-comment">--  Also,  x `bothUse` x /= x (for anything but Abs).</span><span>
</span><a name="line-484"></a><span>
</span><a name="line-485"></a><span class="hs-identifier">bothArgUse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span>
</span><a name="line-486"></a><a name="bothArgUse"><a href="Demand.html#bothArgUse"><span class="hs-identifier">bothArgUse</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span> </span><a name="local-6989586621682209766"><a href="#local-6989586621682209766"><span class="hs-identifier">x</span></a></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209766"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-487"></a><span class="hs-identifier">bothArgUse</span><span> </span><a name="local-6989586621682209767"><a href="#local-6989586621682209767"><span class="hs-identifier">x</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209767"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-488"></a><span class="hs-identifier">bothArgUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209768"><a href="#local-6989586621682209768"><span class="hs-identifier">a1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209769"><a href="#local-6989586621682209769"><span class="hs-identifier">a2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#bothUse"><span class="hs-identifier hs-var">bothUse</span></a><span> </span><a href="#local-6989586621682209768"><span class="hs-identifier hs-var">a1</span></a><span> </span><a href="#local-6989586621682209769"><span class="hs-identifier hs-var">a2</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-identifier">bothUse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-492"></a><a name="bothUse"><a href="Demand.html#bothUse"><span class="hs-identifier">bothUse</span></a></a><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>       </span><a name="local-6989586621682209770"><a href="#local-6989586621682209770"><span class="hs-identifier">u</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209770"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-493"></a><span class="hs-identifier">bothUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209771"><a href="#local-6989586621682209771"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209772"><a href="#local-6989586621682209772"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="#local-6989586621682209771"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621682209772"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-comment">-- Exciting special treatment of inner demand for call demands:</span><span>
</span><a name="line-496"></a><span class="hs-comment">--    use `lubUse` instead of `bothUse`!</span><span>
</span><a name="line-497"></a><span class="hs-identifier">bothUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209773"><a href="#local-6989586621682209773"><span class="hs-identifier">u1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209774"><a href="#local-6989586621682209774"><span class="hs-identifier">u2</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209773"><span class="hs-identifier hs-var">u1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#lubUse"><span class="hs-identifier hs-var">lubUse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209774"><span class="hs-identifier hs-var">u2</span></a><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>
</span><a name="line-499"></a><span class="hs-identifier">bothUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-500"></a><span class="hs-identifier">bothUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209775"><a href="#local-6989586621682209775"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a href="#local-6989586621682209775"><span class="hs-identifier hs-var">ux</span></a><span>
</span><a name="line-501"></a><span class="hs-identifier">bothUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209776"><a href="#local-6989586621682209776"><span class="hs-identifier">ux1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209777"><a href="#local-6989586621682209777"><span class="hs-identifier">ux2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209776"><span class="hs-identifier hs-var">ux1</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209777"><span class="hs-identifier hs-var">ux2</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Demand.html#bothArgUse"><span class="hs-identifier hs-var">bothArgUse</span></a><span> </span><a href="#local-6989586621682209776"><span class="hs-identifier hs-var">ux1</span></a><span> </span><a href="#local-6989586621682209777"><span class="hs-identifier hs-var">ux2</span></a><span>
</span><a name="line-503"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-504"></a><span class="hs-identifier">bothUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-505"></a><span class="hs-comment">-- bothUse (UProd {}) Used             = Used  -- Note [Used should win]</span><span>
</span><a name="line-506"></a><span class="hs-identifier">bothUse</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209778"><a href="#local-6989586621682209778"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Demand.html#bothArgUse"><span class="hs-identifier hs-var">bothArgUse</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209778"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-507"></a><span class="hs-identifier">bothUse</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209779"><a href="#local-6989586621682209779"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="Demand.html#bothArgUse"><span class="hs-identifier hs-var">bothArgUse</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209779"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-508"></a><span class="hs-identifier">bothUse</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span> </span><span class="hs-identifier">_</span><span>                      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>  </span><span class="hs-comment">-- Note [Used should win]</span><span>
</span><a name="line-509"></a><span>
</span><a name="line-510"></a><span class="hs-identifier">peelUseCall</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span class="hs-special">)</span><span>
</span><a name="line-511"></a><a name="peelUseCall"><a href="Demand.html#peelUseCall"><span class="hs-identifier">peelUseCall</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209780"><a href="#local-6989586621682209780"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209781"><a href="#local-6989586621682209781"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209780"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">,</span><a href="#local-6989586621682209781"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span class="hs-identifier">peelUseCall</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span class="hs-identifier">addCaseBndrDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>    </span><span class="hs-comment">-- On the case binder</span><span>
</span><a name="line-515"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- On the components of the constructor</span><span>
</span><a name="line-516"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Final demands for the components of the constructor</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- See Note [Demand on case-alternative binders]</span><span>
</span><a name="line-518"></a><a name="addCaseBndrDmd"><a href="Demand.html#addCaseBndrDmd"><span class="hs-identifier">addCaseBndrDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209782"><a href="#local-6989586621682209782"><span class="hs-identifier">ms</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209783"><a href="#local-6989586621682209783"><span class="hs-identifier">mu</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682209784"><a href="#local-6989586621682209784"><span class="hs-identifier">alt_dmds</span></a></a><span>
</span><a name="line-519"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209783"><span class="hs-identifier hs-var">mu</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-520"></a><span>     </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682209784"><span class="hs-identifier hs-var">alt_dmds</span></a><span>
</span><a name="line-521"></a><span>     </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209786"><a href="#local-6989586621682209786"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Demand.html#bothDmd"><span class="hs-identifier hs-var">bothDmd</span></a><span> </span><a href="#local-6989586621682209784"><span class="hs-identifier hs-var">alt_dmds</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#mkJointDmds"><span class="hs-identifier hs-var">mkJointDmds</span></a><span> </span><a href="#local-6989586621682209787"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621682209788"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>             </span><span class="hs-keyword">where</span><span>
</span><a name="line-523"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682209787"><a href="#local-6989586621682209787"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#splitArgStrProdDmd"><span class="hs-identifier hs-var">splitArgStrProdDmd</span></a><span> </span><a href="#local-6989586621682209785"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682209782"><span class="hs-identifier hs-var">ms</span></a><span>  </span><span class="hs-comment">-- Guaranteed not to be a call</span><span>
</span><a name="line-524"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682209788"><a href="#local-6989586621682209788"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#splitUseProdDmd"><span class="hs-identifier hs-var">splitUseProdDmd</span></a><span>      </span><a href="#local-6989586621682209785"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682209786"><span class="hs-identifier hs-var">u</span></a><span>   </span><span class="hs-comment">-- Ditto</span><span>
</span><a name="line-525"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-526"></a><span>    </span><a name="local-6989586621682209785"><a href="#local-6989586621682209785"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682209784"><span class="hs-identifier hs-var">alt_dmds</span></a><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span class="hs-comment">{- Note [Demand on case-alternative binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The demand on a binder in a case alternative comes
  (a) From the demand on the binder itself
  (b) From the demand on the case binder
Forgetting (b) led directly to Trac #10148.

Example. Source code:
  f x@(p,_) = if p then foo x else True

  foo (p,True) = True
  foo (p,q)    = foo (q,p)

After strictness analysis:
  f = \ (x_an1 [Dmd=&lt;S(SL),1*U(U,1*U)&gt;] :: (Bool, Bool)) -&gt;
      case x_an1
      of wild_X7 [Dmd=&lt;L,1*U(1*U,1*U)&gt;]
      { (p_an2 [Dmd=&lt;S,1*U&gt;], ds_dnz [Dmd=&lt;L,A&gt;]) -&gt;
      case p_an2 of _ {
        False -&gt; GHC.Types.True;
        True -&gt; foo wild_X7 }

It's true that ds_dnz is *itself* absent, but the use of wild_X7 means
that it is very much alive and demanded.  See Trac #10148 for how the
consequences play out.

This is needed even for non-product types, in case the case-binder
is used but the components of the case alternative are not.

Note [Don't optimise UProd(Used) to Used]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
These two UseDmds:
   UProd [Used, Used]   and    Used
are semantically equivalent, but we do not turn the former into
the latter, for a regrettable-subtle reason.  Suppose we did.
then
  f (x,y) = (y,x)
would get
  StrDmd = Str  = SProd [Lazy, Lazy]
  UseDmd = Used = UProd [Used, Used]
But with the joint demand of &lt;Str, Used&gt; doesn't convey any clue
that there is a product involved, and so the worthSplittingFun
will not fire.  (We'd need to use the type as well to make it fire.)
Moreover, consider
  g h p@(_,_) = h p
This too would get &lt;Str, Used&gt;, but this time there really isn't any
point in w/w since the components of the pair are not used at all.

So the solution is: don't aggressively collapse UProd [Used,Used] to
Used; intead leave it as-is. In effect we are using the UseDmd to do a
little bit of boxity analysis.  Not very nice.

Note [Used should win]
~~~~~~~~~~~~~~~~~~~~~~
Both in lubUse and bothUse we want (Used `both` UProd us) to be Used.
Why?  Because Used carries the implication the whole thing is used,
box and all, so we don't want to w/w it.  If we use it both boxed and
unboxed, then we are definitely using the box, and so we are quite
likely to pay a reboxing cost.  So we make Used win here.

Example is in the Buffer argument of GHC.IO.Handle.Internals.writeCharBuffer

Baseline: (A) Not making Used win (UProd wins)
Compare with: (B) making Used win for lub and both

            Min          -0.3%     -5.6%    -10.7%    -11.0%    -33.3%
            Max          +0.3%    +45.6%    +11.5%    +11.5%     +6.9%
 Geometric Mean          -0.0%     +0.5%     +0.3%     +0.2%     -0.8%

Baseline: (B) Making Used win for both lub and both
Compare with: (C) making Used win for both, but UProd win for lub

            Min          -0.1%     -0.3%     -7.9%     -8.0%     -6.5%
            Max          +0.1%     +1.0%    +21.0%    +21.0%     +0.5%
 Geometric Mean          +0.0%     +0.0%     -0.0%     -0.1%     -0.1%
-}</span><span>
</span><a name="line-604"></a><span>
</span><a name="line-605"></a><span class="hs-comment">-- If a demand is used multiple times (i.e. reused), than any use-once</span><span>
</span><a name="line-606"></a><span class="hs-comment">-- mentioned there, that is not protected by a UCall, can happen many times.</span><span>
</span><a name="line-607"></a><span class="hs-identifier">markReusedDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span>
</span><a name="line-608"></a><a name="markReusedDmd"><a href="Demand.html#markReusedDmd"><span class="hs-identifier">markReusedDmd</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>
</span><a name="line-609"></a><span class="hs-identifier">markReusedDmd</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209789"><a href="#local-6989586621682209789"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#markReused"><span class="hs-identifier hs-var">markReused</span></a><span> </span><a href="#local-6989586621682209789"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-identifier">markReused</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-612"></a><a name="markReused"><a href="Demand.html#markReused"><span class="hs-identifier">markReused</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209790"><a href="#local-6989586621682209790"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><a href="#local-6989586621682209790"><span class="hs-identifier hs-var">u</span></a><span>   </span><span class="hs-comment">-- No need to recurse here</span><span>
</span><a name="line-613"></a><span class="hs-identifier">markReused</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209791"><a href="#local-6989586621682209791"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Demand.html#markReusedDmd"><span class="hs-identifier hs-var">markReusedDmd</span></a><span> </span><a href="#local-6989586621682209791"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-614"></a><span class="hs-identifier">markReused</span><span> </span><a name="local-6989586621682209792"><a href="#local-6989586621682209792"><span class="hs-identifier">u</span></a></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209792"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-615"></a><span>
</span><a name="line-616"></a><span class="hs-identifier">isUsedMU</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-617"></a><span class="hs-comment">-- True &lt;=&gt; markReusedDmd d = d</span><span>
</span><a name="line-618"></a><a name="isUsedMU"><a href="Demand.html#isUsedMU"><span class="hs-identifier">isUsedMU</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-619"></a><span class="hs-identifier">isUsedMU</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-620"></a><span class="hs-identifier">isUsedMU</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><a name="local-6989586621682209793"><a href="#local-6989586621682209793"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#isUsedU"><span class="hs-identifier hs-var">isUsedU</span></a><span> </span><a href="#local-6989586621682209793"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span class="hs-identifier">isUsedU</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-623"></a><span class="hs-comment">-- True &lt;=&gt; markReused d = d</span><span>
</span><a name="line-624"></a><a name="isUsedU"><a href="Demand.html#isUsedU"><span class="hs-identifier">isUsedU</span></a></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-625"></a><span class="hs-identifier">isUsedU</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-626"></a><span class="hs-identifier">isUsedU</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209794"><a href="#local-6989586621682209794"><span class="hs-identifier">us</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="Demand.html#isUsedMU"><span class="hs-identifier hs-var">isUsedMU</span></a><span> </span><a href="#local-6989586621682209794"><span class="hs-identifier hs-var">us</span></a><span>
</span><a name="line-627"></a><span class="hs-identifier">isUsedU</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-628"></a><span class="hs-identifier">isUsedU</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-comment">-- No need to recurse</span><span>
</span><a name="line-629"></a><span>
</span><a name="line-630"></a><span class="hs-comment">-- Squashing usage demand demands</span><span>
</span><a name="line-631"></a><span class="hs-identifier">seqUseDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-632"></a><a name="seqUseDmd"><a href="Demand.html#seqUseDmd"><span class="hs-identifier">seqUseDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209795"><a href="#local-6989586621682209795"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqArgUseList"><span class="hs-identifier hs-var">seqArgUseList</span></a><span> </span><a href="#local-6989586621682209795"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-633"></a><span class="hs-identifier">seqUseDmd</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209796"><a href="#local-6989586621682209796"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209797"><a href="#local-6989586621682209797"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209796"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqUseDmd"><span class="hs-identifier hs-var">seqUseDmd</span></a><span> </span><a href="#local-6989586621682209797"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-634"></a><span class="hs-identifier">seqUseDmd</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-635"></a><span>
</span><a name="line-636"></a><span class="hs-identifier">seqArgUseList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-637"></a><a name="seqArgUseList"><a href="Demand.html#seqArgUseList"><span class="hs-identifier">seqArgUseList</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-638"></a><span class="hs-identifier">seqArgUseList</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682209798"><a href="#local-6989586621682209798"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682209799"><a href="#local-6989586621682209799"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqArgUse"><span class="hs-identifier hs-var">seqArgUse</span></a><span> </span><a href="#local-6989586621682209798"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqArgUseList"><span class="hs-identifier hs-var">seqArgUseList</span></a><span> </span><a href="#local-6989586621682209799"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-639"></a><span>
</span><a name="line-640"></a><span class="hs-identifier">seqArgUse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-641"></a><a name="seqArgUse"><a href="Demand.html#seqArgUse"><span class="hs-identifier">seqArgUse</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a name="local-6989586621682209800"><a href="#local-6989586621682209800"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209801"><a href="#local-6989586621682209801"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209800"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqUseDmd"><span class="hs-identifier hs-var">seqUseDmd</span></a><span> </span><a href="#local-6989586621682209801"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-642"></a><span class="hs-identifier">seqArgUse</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-643"></a><span>
</span><a name="line-644"></a><span class="hs-comment">-- Splitting polymorphic Maybe-Used demands</span><span>
</span><a name="line-645"></a><span class="hs-identifier">splitUseProdDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span class="hs-special">]</span><span>
</span><a name="line-646"></a><a name="splitUseProdDmd"><a href="Demand.html#splitUseProdDmd"><span class="hs-identifier">splitUseProdDmd</span></a></a><span> </span><a name="local-6989586621682209802"><a href="#local-6989586621682209802"><span class="hs-identifier">n</span></a></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621682209802"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span class="hs-special">)</span><span>
</span><a name="line-647"></a><span class="hs-identifier">splitUseProdDmd</span><span> </span><a name="local-6989586621682209803"><a href="#local-6989586621682209803"><span class="hs-identifier">n</span></a></a><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621682209803"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span class="hs-special">)</span><span>
</span><a name="line-648"></a><span class="hs-identifier">splitUseProdDmd</span><span> </span><a name="local-6989586621682209804"><a href="#local-6989586621682209804"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209805"><a href="#local-6989586621682209805"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">lengthIs</span><span class="hs-special">`</span><span> </span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-649"></a><span>                                      </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;splitUseProdDmd&quot;</span><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">n</span><span>
</span><a name="line-650"></a><span>                                                             </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ds</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span>                                </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682209805"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-652"></a><span class="hs-identifier">splitUseProdDmd</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-653"></a><span>      </span><span class="hs-comment">-- This can happen when the programmer uses unsafeCoerce,</span><span>
</span><a name="line-654"></a><span>      </span><span class="hs-comment">-- and we don't then want to crash the compiler (Trac #9208)</span><span>
</span><a name="line-655"></a><span>
</span><a name="line-656"></a><span class="hs-identifier">useCount</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><a href="#local-6989586621682209692"><span class="hs-identifier hs-type">u</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span>
</span><a name="line-657"></a><a name="useCount"><a href="Demand.html#useCount"><span class="hs-identifier">useCount</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>
</span><a name="line-658"></a><span class="hs-identifier">useCount</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>
</span><a name="line-659"></a><span class="hs-identifier">useCount</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span>
</span><a name="line-660"></a><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
         Clean demand for Strictness and Usage
*                                                                      *
************************************************************************

This domain differst from JointDemand in the sence that pure absence
is taken away, i.e., we deal *only* with non-absent demands.

Note [Strict demands]
~~~~~~~~~~~~~~~~~~~~~
isStrictDmd returns true only of demands that are
   both strict
   and  used
In particular, it is False for &lt;HyperStr, Abs&gt;, which can and does
arise in, say (Trac #7319)
   f x = raise# &lt;some exception&gt;
Then 'x' is not used, so f gets strictness &lt;HyperStr,Abs&gt; -&gt; .
Now the w/w generates
   fx = let x &lt;HyperStr,Abs&gt; = absentError &quot;unused&quot;
        in raise &lt;some exception&gt;
At this point we really don't want to convert to
   fx = case absentError &quot;unused&quot; of x -&gt; raise &lt;some exception&gt;
Since the program is going to diverge, this swaps one error for another,
but it's really a bad idea to *ever* evaluate an absent argument.
In Trac #7319 we get
   T7319.exe: Oops!  Entered absent arg w_s1Hd{v} [lid] [base:GHC.Base.String{tc 36u}]

Note [Dealing with call demands]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Call demands are constructed and deconstructed coherently for
strictness and absence. For instance, the strictness signature for the
following function

f :: (Int -&gt; (Int, Int)) -&gt; (Int, Bool)
f g = (snd (g 3), True)

should be: &lt;L,C(U(AU))&gt;m
-}</span><span>
</span><a name="line-702"></a><span>
</span><a name="line-703"></a><span class="hs-keyword">type</span><span> </span><a name="CleanDemand"><a href="Demand.html#CleanDemand"><span class="hs-identifier">CleanDemand</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-704"></a><span>     </span><span class="hs-comment">-- A demand that is at least head-strict</span><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span class="hs-identifier">bothCleanDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span>
</span><a name="line-707"></a><a name="bothCleanDmd"><a href="Demand.html#bothCleanDmd"><span class="hs-identifier">bothCleanDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209806"><a href="#local-6989586621682209806"><span class="hs-identifier">s1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209807"><a href="#local-6989586621682209807"><span class="hs-identifier">a1</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209808"><a href="#local-6989586621682209808"><span class="hs-identifier">s2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209809"><a href="#local-6989586621682209809"><span class="hs-identifier">a2</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209806"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothStr"><span class="hs-identifier hs-var">bothStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209808"><span class="hs-identifier hs-var">s2</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209807"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothUse"><span class="hs-identifier hs-var">bothUse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209809"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-709"></a><span>
</span><a name="line-710"></a><span class="hs-identifier">mkHeadStrict</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span>
</span><a name="line-711"></a><a name="mkHeadStrict"><a href="Demand.html#mkHeadStrict"><span class="hs-identifier">mkHeadStrict</span></a></a><span> </span><a name="local-6989586621682209810"><a href="#local-6989586621682209810"><span class="hs-identifier">cd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209810"><span class="hs-identifier hs-var">cd</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span class="hs-identifier">mkOnceUsedDmd</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mkManyUsedDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-714"></a><a name="mkOnceUsedDmd"><a href="Demand.html#mkOnceUsedDmd"><span class="hs-identifier">mkOnceUsedDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209811"><a href="#local-6989586621682209811"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209812"><a href="#local-6989586621682209812"><span class="hs-identifier">a</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="#local-6989586621682209811"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a href="#local-6989586621682209812"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-715"></a><a name="mkManyUsedDmd"><a href="Demand.html#mkManyUsedDmd"><span class="hs-identifier">mkManyUsedDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209813"><a href="#local-6989586621682209813"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209814"><a href="#local-6989586621682209814"><span class="hs-identifier">a</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="#local-6989586621682209813"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><a href="#local-6989586621682209814"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span class="hs-identifier">evalDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-718"></a><span class="hs-comment">-- Evaluated strictly, and used arbitrarily deeply</span><span>
</span><a name="line-719"></a><a name="evalDmd"><a href="Demand.html#evalDmd"><span class="hs-identifier">evalDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-720"></a><span>
</span><a name="line-721"></a><span class="hs-identifier">mkProdDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span>
</span><a name="line-722"></a><a name="mkProdDmd"><a href="Demand.html#mkProdDmd"><span class="hs-identifier">mkProdDmd</span></a></a><span> </span><a name="local-6989586621682209815"><a href="#local-6989586621682209815"><span class="hs-identifier">dx</span></a></a><span>
</span><a name="line-723"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkSProd"><span class="hs-identifier hs-var">mkSProd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Demand.html#getStrDmd"><span class="hs-identifier hs-var">getStrDmd</span></a><span> </span><a href="#local-6989586621682209815"><span class="hs-identifier hs-var">dx</span></a><span>
</span><a name="line-724"></a><span>       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkUProd"><span class="hs-identifier hs-var">mkUProd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Demand.html#getUseDmd"><span class="hs-identifier hs-var">getUseDmd</span></a><span> </span><a href="#local-6989586621682209815"><span class="hs-identifier hs-var">dx</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-725"></a><span>
</span><a name="line-726"></a><span class="hs-identifier">mkCallDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span>
</span><a name="line-727"></a><a name="mkCallDmd"><a href="Demand.html#mkCallDmd"><span class="hs-identifier">mkCallDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209816"><a href="#local-6989586621682209816"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209817"><a href="#local-6989586621682209817"><span class="hs-identifier">u</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-728"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkSCall"><span class="hs-identifier hs-var">mkSCall</span></a><span> </span><a href="#local-6989586621682209816"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkUCall"><span class="hs-identifier hs-var">mkUCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a href="#local-6989586621682209817"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-729"></a><span>
</span><a name="line-730"></a><span class="hs-comment">-- See Note [Demand on the worker] in WorkWrap</span><span>
</span><a name="line-731"></a><span class="hs-identifier">mkWorkerDemand</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-732"></a><a name="mkWorkerDemand"><a href="Demand.html#mkWorkerDemand"><span class="hs-identifier">mkWorkerDemand</span></a></a><span> </span><a name="local-6989586621682209818"><a href="#local-6989586621682209818"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209819"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682209818"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-733"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682209819"><a href="#local-6989586621682209819"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-734"></a><span>        </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682209820"><a href="#local-6989586621682209820"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkUCall"><span class="hs-identifier hs-var">mkUCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621682209819"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209820"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-735"></a><span>
</span><a name="line-736"></a><span class="hs-identifier">cleanEvalDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span>
</span><a name="line-737"></a><a name="cleanEvalDmd"><a href="Demand.html#cleanEvalDmd"><span class="hs-identifier">cleanEvalDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-738"></a><span>
</span><a name="line-739"></a><span class="hs-identifier">cleanEvalProdDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span>
</span><a name="line-740"></a><a name="cleanEvalProdDmd"><a href="Demand.html#cleanEvalProdDmd"><span class="hs-identifier">cleanEvalProdDmd</span></a></a><span> </span><a name="local-6989586621682209821"><a href="#local-6989586621682209821"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621682209821"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-741"></a><span>
</span><a name="line-742"></a><span>
</span><a name="line-743"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
           Demand: combining stricness and usage
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-750"></a><span>
</span><a name="line-751"></a><span class="hs-keyword">type</span><span> </span><a name="Demand"><a href="Demand.html#Demand"><span class="hs-identifier">Demand</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span class="hs-identifier">lubDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-754"></a><a name="lubDmd"><a href="Demand.html#lubDmd"><span class="hs-identifier">lubDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209822"><a href="#local-6989586621682209822"><span class="hs-identifier">s1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209823"><a href="#local-6989586621682209823"><span class="hs-identifier">a1</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209824"><a href="#local-6989586621682209824"><span class="hs-identifier">s2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209825"><a href="#local-6989586621682209825"><span class="hs-identifier">a2</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-755"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209822"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#lubArgStr"><span class="hs-identifier hs-var">lubArgStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209824"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-756"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209823"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#lubArgUse"><span class="hs-identifier hs-var">lubArgUse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209825"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-757"></a><span>
</span><a name="line-758"></a><span class="hs-identifier">bothDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-759"></a><a name="bothDmd"><a href="Demand.html#bothDmd"><span class="hs-identifier">bothDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209826"><a href="#local-6989586621682209826"><span class="hs-identifier">s1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209827"><a href="#local-6989586621682209827"><span class="hs-identifier">a1</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209828"><a href="#local-6989586621682209828"><span class="hs-identifier">s2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209829"><a href="#local-6989586621682209829"><span class="hs-identifier">a2</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-760"></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209826"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothArgStr"><span class="hs-identifier hs-var">bothArgStr</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209828"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-761"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209827"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothArgUse"><span class="hs-identifier hs-var">bothArgUse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209829"><span class="hs-identifier hs-var">a2</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-762"></a><span>
</span><a name="line-763"></a><span class="hs-identifier">lazyApply1Dmd</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">lazyApply2Dmd</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">strictApply1Dmd</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">catchArgDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-764"></a><span>
</span><a name="line-765"></a><a name="strictApply1Dmd"><a href="Demand.html#strictApply1Dmd"><span class="hs-identifier">strictApply1Dmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">)</span><span>
</span><a name="line-766"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-767"></a><span>
</span><a name="line-768"></a><span class="hs-comment">-- First argument of catchRetry# and catchSTM#:</span><span>
</span><a name="line-769"></a><span class="hs-comment">--    uses its arg once, applies it once</span><span>
</span><a name="line-770"></a><span class="hs-comment">--    and catches exceptions (the ExnStr) part</span><span>
</span><a name="line-771"></a><a name="catchArgDmd"><a href="Demand.html#catchArgDmd"><span class="hs-identifier">catchArgDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">)</span><span>
</span><a name="line-772"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-773"></a><span>
</span><a name="line-774"></a><a name="lazyApply1Dmd"><a href="Demand.html#lazyApply1Dmd"><span class="hs-identifier">lazyApply1Dmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-775"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-776"></a><span>
</span><a name="line-777"></a><span class="hs-comment">-- Second argument of catch#:</span><span>
</span><a name="line-778"></a><span class="hs-comment">--    uses its arg at most once, applies it once</span><span>
</span><a name="line-779"></a><span class="hs-comment">--    but is lazy (might not be called at all)</span><span>
</span><a name="line-780"></a><a name="lazyApply2Dmd"><a href="Demand.html#lazyApply2Dmd"><span class="hs-identifier">lazyApply2Dmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-781"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-782"></a><span>
</span><a name="line-783"></a><span class="hs-identifier">absDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-784"></a><a name="absDmd"><a href="Demand.html#absDmd"><span class="hs-identifier">absDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span class="hs-identifier">topDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-787"></a><a name="topDmd"><a href="Demand.html#topDmd"><span class="hs-identifier">topDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span class="hs-identifier">botDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-790"></a><a name="botDmd"><a href="Demand.html#botDmd"><span class="hs-identifier">botDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#strBot"><span class="hs-identifier hs-var">strBot</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#useBot"><span class="hs-identifier hs-var">useBot</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-791"></a><span>
</span><a name="line-792"></a><span class="hs-identifier">seqDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-793"></a><a name="seqDmd"><a href="Demand.html#seqDmd"><span class="hs-identifier">seqDmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-794"></a><span>
</span><a name="line-795"></a><span class="hs-identifier">oneifyDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="#local-6989586621682209690"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><a href="#local-6989586621682209691"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="#local-6989586621682209690"><span class="hs-identifier hs-type">s</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><a href="#local-6989586621682209691"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-796"></a><a name="oneifyDmd"><a href="Demand.html#oneifyDmd"><span class="hs-identifier">oneifyDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209830"><a href="#local-6989586621682209830"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209831"><a href="#local-6989586621682209831"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209830"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a href="#local-6989586621682209831"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-797"></a><span class="hs-identifier">oneifyDmd</span><span> </span><a name="local-6989586621682209832"><a href="#local-6989586621682209832"><span class="hs-identifier">jd</span></a></a><span>                            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209832"><span class="hs-identifier hs-var">jd</span></a><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span class="hs-identifier">isTopDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-800"></a><span class="hs-comment">-- Used to suppress pretty-printing of an uninformative demand</span><span>
</span><a name="line-801"></a><a name="isTopDmd"><a href="Demand.html#isTopDmd"><span class="hs-identifier">isTopDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-802"></a><span class="hs-identifier">isTopDmd</span><span> </span><span class="hs-identifier">_</span><span>                                    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span class="hs-identifier">isAbsDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-type">Str</span></a><span> </span><a href="#local-6989586621682209688"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><a href="#local-6989586621682209689"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-805"></a><a name="isAbsDmd"><a href="Demand.html#isAbsDmd"><span class="hs-identifier">isAbsDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>   </span><span class="hs-comment">-- The strictness part can be HyperStr</span><span>
</span><a name="line-806"></a><span class="hs-identifier">isAbsDmd</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- for a bottom demand</span><span>
</span><a name="line-807"></a><span>
</span><a name="line-808"></a><span class="hs-identifier">isSeqDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-809"></a><a name="isSeqDmd"><a href="Demand.html#isSeqDmd"><span class="hs-identifier">isSeqDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-810"></a><span class="hs-identifier">isSeqDmd</span><span> </span><span class="hs-identifier">_</span><span>                                                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-811"></a><span>
</span><a name="line-812"></a><span class="hs-identifier">isUsedOnce</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-type">Str</span></a><span> </span><a href="#local-6989586621682209686"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><a href="#local-6989586621682209687"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-813"></a><a name="isUsedOnce"><a href="Demand.html#isUsedOnce"><span class="hs-identifier">isUsedOnce</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209833"><a href="#local-6989586621682209833"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Demand.html#useCount"><span class="hs-identifier hs-var">useCount</span></a><span> </span><a href="#local-6989586621682209833"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-814"></a><span>                               </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-815"></a><span>                               </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-816"></a><span>
</span><a name="line-817"></a><span class="hs-comment">-- More utility functions for strictness</span><span>
</span><a name="line-818"></a><span class="hs-identifier">seqDemand</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-819"></a><a name="seqDemand"><a href="Demand.html#seqDemand"><span class="hs-identifier">seqDemand</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209834"><a href="#local-6989586621682209834"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209835"><a href="#local-6989586621682209835"><span class="hs-identifier">u</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqArgStr"><span class="hs-identifier hs-var">seqArgStr</span></a><span> </span><a href="#local-6989586621682209834"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqArgUse"><span class="hs-identifier hs-var">seqArgUse</span></a><span> </span><a href="#local-6989586621682209835"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-820"></a><span>
</span><a name="line-821"></a><span class="hs-identifier">seqDemandList</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-822"></a><a name="seqDemandList"><a href="Demand.html#seqDemandList"><span class="hs-identifier">seqDemandList</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span class="hs-identifier">seqDemandList</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682209836"><a href="#local-6989586621682209836"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682209837"><a href="#local-6989586621682209837"><span class="hs-identifier">ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqDemand"><span class="hs-identifier hs-var">seqDemand</span></a><span> </span><a href="#local-6989586621682209836"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqDemandList"><span class="hs-identifier hs-var">seqDemandList</span></a><span> </span><a href="#local-6989586621682209837"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-824"></a><span>
</span><a name="line-825"></a><span class="hs-identifier">isStrictDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-type">Str</span></a><span> </span><a href="#local-6989586621682209684"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><a href="#local-6989586621682209685"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-826"></a><span class="hs-comment">-- See Note [Strict demands]</span><span>
</span><a name="line-827"></a><a name="isStrictDmd"><a href="Demand.html#isStrictDmd"><span class="hs-identifier">isStrictDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-828"></a><span class="hs-identifier">isStrictDmd</span><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-829"></a><span class="hs-identifier">isStrictDmd</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-830"></a><span>
</span><a name="line-831"></a><span class="hs-identifier">isWeakDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-832"></a><a name="isWeakDmd"><a href="Demand.html#isWeakDmd"><span class="hs-identifier">isWeakDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209838"><a href="#local-6989586621682209838"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209839"><a href="#local-6989586621682209839"><span class="hs-identifier">a</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#isLazy"><span class="hs-identifier hs-var">isLazy</span></a><span> </span><a href="#local-6989586621682209838"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Demand.html#isUsedMU"><span class="hs-identifier hs-var">isUsedMU</span></a><span> </span><a href="#local-6989586621682209839"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-833"></a><span>
</span><a name="line-834"></a><span class="hs-identifier">cleanUseDmd_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-835"></a><a name="cleanUseDmd_maybe"><a href="Demand.html#cleanUseDmd_maybe"><span class="hs-identifier">cleanUseDmd_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209840"><a href="#local-6989586621682209840"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682209840"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-836"></a><span class="hs-identifier">cleanUseDmd_maybe</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-837"></a><span>
</span><a name="line-838"></a><span class="hs-identifier">splitFVs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>   </span><span class="hs-comment">-- Thunk</span><span>
</span><a name="line-839"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span class="hs-special">)</span><span>
</span><a name="line-840"></a><a name="splitFVs"><a href="Demand.html#splitFVs"><span class="hs-identifier">splitFVs</span></a></a><span> </span><a name="local-6989586621682209841"><a href="#local-6989586621682209841"><span class="hs-identifier">is_thunk</span></a></a><span> </span><a name="local-6989586621682209842"><a href="#local-6989586621682209842"><span class="hs-identifier">rhs_fvs</span></a></a><span>
</span><a name="line-841"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209841"><span class="hs-identifier hs-var">is_thunk</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#nonDetFoldUFM_Directly"><span class="hs-identifier hs-var">nonDetFoldUFM_Directly</span></a><span> </span><a href="#local-6989586621682209843"><span class="hs-identifier hs-var">add</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span class="hs-special">,</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209842"><span class="hs-identifier hs-var">rhs_fvs</span></a><span>
</span><a name="line-842"></a><span>                </span><span class="hs-comment">-- It's OK to use nonDetFoldUFM_Directly because we</span><span>
</span><a name="line-843"></a><span>                </span><span class="hs-comment">-- immediately forget the ordering by putting the elements</span><span>
</span><a name="line-844"></a><span>                </span><span class="hs-comment">-- in the envs again</span><span>
</span><a name="line-845"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#partitionVarEnv"><span class="hs-identifier hs-var">partitionVarEnv</span></a><span> </span><a href="Demand.html#isWeakDmd"><span class="hs-identifier hs-var">isWeakDmd</span></a><span> </span><a href="#local-6989586621682209842"><span class="hs-identifier hs-var">rhs_fvs</span></a><span>
</span><a name="line-846"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-847"></a><span>    </span><a name="local-6989586621682209843"><a href="#local-6989586621682209843"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621682209844"><a href="#local-6989586621682209844"><span class="hs-identifier">uniq</span></a></a><span> </span><a name="local-6989586621682209845"><a href="#local-6989586621682209845"><span class="hs-identifier">dmd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209846"><a href="#local-6989586621682209846"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209847"><a href="#local-6989586621682209847"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682209848"><a href="#local-6989586621682209848"><span class="hs-identifier">lazy_fv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682209849"><a href="#local-6989586621682209849"><span class="hs-identifier">sig_fv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-848"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682209846"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="UniqFM.html#addToUFM_Directly"><span class="hs-identifier hs-var">addToUFM_Directly</span></a><span> </span><a href="#local-6989586621682209848"><span class="hs-identifier hs-var">lazy_fv</span></a><span> </span><a href="#local-6989586621682209844"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="#local-6989586621682209845"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682209849"><span class="hs-identifier hs-var">sig_fv</span></a><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="UniqFM.html#addToUFM_Directly"><span class="hs-identifier hs-var">addToUFM_Directly</span></a><span> </span><a href="#local-6989586621682209848"><span class="hs-identifier hs-var">lazy_fv</span></a><span> </span><a href="#local-6989586621682209844"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209847"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-850"></a><span>                    </span><span class="hs-special">,</span><span> </span><a href="UniqFM.html#addToUFM_Directly"><span class="hs-identifier hs-var">addToUFM_Directly</span></a><span> </span><a href="#local-6989586621682209849"><span class="hs-identifier hs-var">sig_fv</span></a><span>  </span><a href="#local-6989586621682209844"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209846"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span>    </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-851"></a><span>
</span><a name="line-852"></a><span class="hs-keyword">data</span><span> </span><a name="TypeShape"><a href="Demand.html#TypeShape"><span class="hs-identifier">TypeShape</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TsFun"><a href="Demand.html#TsFun"><span class="hs-identifier">TsFun</span></a></a><span> </span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span>
</span><a name="line-853"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="TsProd"><a href="Demand.html#TsProd"><span class="hs-identifier">TsProd</span></a></a><span> </span><span class="hs-special">[</span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span class="hs-special">]</span><span>
</span><a name="line-854"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="TsUnk"><a href="Demand.html#TsUnk"><span class="hs-identifier">TsUnk</span></a></a><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-857"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Demand.html#TsUnk"><span class="hs-identifier hs-var">TsUnk</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;TsUnk&quot;</span><span>
</span><a name="line-858"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#TsFun"><span class="hs-identifier hs-var">TsFun</span></a><span> </span><a name="local-6989586621682209667"><a href="#local-6989586621682209667"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;TsFun&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209667"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-859"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#TsProd"><span class="hs-identifier hs-var">TsProd</span></a><span> </span><a name="local-6989586621682209668"><a href="#local-6989586621682209668"><span class="hs-identifier">tss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209668"><span class="hs-identifier hs-var">tss</span></a><span class="hs-special">)</span><span>
</span><a name="line-860"></a><span>
</span><a name="line-861"></a><span class="hs-identifier">trimToType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-862"></a><span class="hs-comment">-- See Note [Trimming a demand to a type]</span><span>
</span><a name="line-863"></a><a name="trimToType"><a href="Demand.html#trimToType"><span class="hs-identifier">trimToType</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209850"><a href="#local-6989586621682209850"><span class="hs-identifier">ms</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209851"><a href="#local-6989586621682209851"><span class="hs-identifier">mu</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682209852"><a href="#local-6989586621682209852"><span class="hs-identifier">ts</span></a></a><span>
</span><a name="line-864"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209853"><span class="hs-identifier hs-var">go_ms</span></a><span> </span><a href="#local-6989586621682209850"><span class="hs-identifier hs-var">ms</span></a><span> </span><a href="#local-6989586621682209852"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209855"><span class="hs-identifier hs-var">go_mu</span></a><span> </span><a href="#local-6989586621682209851"><span class="hs-identifier hs-var">mu</span></a><span> </span><a href="#local-6989586621682209852"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-865"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-866"></a><span>    </span><span class="hs-identifier">go_ms</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span>
</span><a name="line-867"></a><span>    </span><a name="local-6989586621682209853"><a href="#local-6989586621682209853"><span class="hs-identifier">go_ms</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>      </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-868"></a><span>    </span><span class="hs-identifier">go_ms</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209857"><a href="#local-6989586621682209857"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682209858"><a href="#local-6989586621682209858"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682209859"><a href="#local-6989586621682209859"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="#local-6989586621682209857"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209854"><span class="hs-identifier hs-var">go_s</span></a><span> </span><a href="#local-6989586621682209858"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621682209859"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-869"></a><span>
</span><a name="line-870"></a><span>    </span><span class="hs-identifier">go_s</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span>
</span><a name="line-871"></a><span>    </span><a name="local-6989586621682209854"><a href="#local-6989586621682209854"><span class="hs-identifier">go_s</span></a></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>    </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-872"></a><span>    </span><span class="hs-identifier">go_s</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209860"><a href="#local-6989586621682209860"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-special">(</span><a href="Demand.html#TsFun"><span class="hs-identifier hs-var">TsFun</span></a><span> </span><a name="local-6989586621682209861"><a href="#local-6989586621682209861"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209854"><span class="hs-identifier hs-var">go_s</span></a><span> </span><a href="#local-6989586621682209860"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621682209861"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-873"></a><span>    </span><span class="hs-identifier">go_s</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209862"><a href="#local-6989586621682209862"><span class="hs-identifier">mss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#TsProd"><span class="hs-identifier hs-var">TsProd</span></a><span> </span><a name="local-6989586621682209863"><a href="#local-6989586621682209863"><span class="hs-identifier">tss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-874"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span> </span><a href="#local-6989586621682209862"><span class="hs-identifier hs-var">mss</span></a><span> </span><a href="#local-6989586621682209863"><span class="hs-identifier hs-var">tss</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621682209853"><span class="hs-identifier hs-var">go_ms</span></a><span> </span><a href="#local-6989586621682209862"><span class="hs-identifier hs-var">mss</span></a><span> </span><a href="#local-6989586621682209863"><span class="hs-identifier hs-var">tss</span></a><span class="hs-special">)</span><span>
</span><a name="line-875"></a><span>    </span><span class="hs-identifier">go_s</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-876"></a><span>
</span><a name="line-877"></a><span>    </span><span class="hs-identifier">go_mu</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span>
</span><a name="line-878"></a><span>    </span><a name="local-6989586621682209855"><a href="#local-6989586621682209855"><span class="hs-identifier">go_mu</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>
</span><a name="line-879"></a><span>    </span><span class="hs-identifier">go_mu</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a name="local-6989586621682209864"><a href="#local-6989586621682209864"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209865"><a href="#local-6989586621682209865"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682209866"><a href="#local-6989586621682209866"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="#local-6989586621682209864"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209856"><span class="hs-identifier hs-var">go_u</span></a><span> </span><a href="#local-6989586621682209865"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621682209866"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-880"></a><span>
</span><a name="line-881"></a><span>    </span><span class="hs-identifier">go_u</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#TypeShape"><span class="hs-identifier hs-type">TypeShape</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-882"></a><span>    </span><a name="local-6989586621682209856"><a href="#local-6989586621682209856"><span class="hs-identifier">go_u</span></a></a><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>       </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>
</span><a name="line-883"></a><span>    </span><span class="hs-identifier">go_u</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209867"><a href="#local-6989586621682209867"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209868"><a href="#local-6989586621682209868"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#TsFun"><span class="hs-identifier hs-var">TsFun</span></a><span> </span><a name="local-6989586621682209869"><a href="#local-6989586621682209869"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="#local-6989586621682209867"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209856"><span class="hs-identifier hs-var">go_u</span></a><span> </span><a href="#local-6989586621682209868"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621682209869"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-884"></a><span>    </span><span class="hs-identifier">go_u</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209870"><a href="#local-6989586621682209870"><span class="hs-identifier">mus</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#TsProd"><span class="hs-identifier hs-var">TsProd</span></a><span> </span><a name="local-6989586621682209871"><a href="#local-6989586621682209871"><span class="hs-identifier">tss</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-885"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span> </span><a href="#local-6989586621682209870"><span class="hs-identifier hs-var">mus</span></a><span> </span><a href="#local-6989586621682209871"><span class="hs-identifier hs-var">tss</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621682209855"><span class="hs-identifier hs-var">go_mu</span></a><span> </span><a href="#local-6989586621682209870"><span class="hs-identifier hs-var">mus</span></a><span> </span><a href="#local-6989586621682209871"><span class="hs-identifier hs-var">tss</span></a><span class="hs-special">)</span><span>
</span><a name="line-886"></a><span>    </span><span class="hs-identifier">go_u</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-887"></a><span>
</span><a name="line-888"></a><span class="hs-comment">{-
Note [Trimming a demand to a type]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this:

  f :: a -&gt; Bool
  f x = case ... of
          A g1 -&gt; case (x |&gt; g1) of (p,q) -&gt; ...
          B    -&gt; error &quot;urk&quot;

where A,B are the constructors of a GADT.  We'll get a U(U,U) demand
on x from the A branch, but that's a stupid demand for x itself, which
has type 'a'. Indeed we get ASSERTs going off (notably in
splitUseProdDmd, Trac #8569).

Bottom line: we really don't want to have a binder whose demand is more
deeply-nested than its type.  There are various ways to tackle this.
When processing (x |&gt; g1), we could &quot;trim&quot; the incoming demand U(U,U)
to match x's type.  But I'm currently doing so just at the moment when
we pin a demand on a binder, in DmdAnal.findBndrDmd.


Note [Threshold demands]
~~~~~~~~~~~~~~~~~~~~~~~~
Threshold usage demand is generated to figure out if
cardinality-instrumented demands of a binding's free variables should
be unleashed. See also [Aggregated demand for cardinality].

Note [Replicating polymorphic demands]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Some demands can be considered as polymorphic. Generally, it is
applicable to such beasts as tops, bottoms as well as Head-Used and
Head-stricts demands. For instance,

S ~ S(L, ..., L)

Also, when top or bottom is occurred as a result demand, it in fact
can be expanded to saturate a callee's arity.
-}</span><span>
</span><a name="line-927"></a><span>
</span><a name="line-928"></a><span class="hs-identifier">splitProdDmd_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span>
</span><a name="line-929"></a><span class="hs-comment">-- Split a product into its components, iff there is any</span><span>
</span><a name="line-930"></a><span class="hs-comment">-- useful information to be extracted thereby</span><span>
</span><a name="line-931"></a><span class="hs-comment">-- The demand is not necessarily strict!</span><span>
</span><a name="line-932"></a><a name="splitProdDmd_maybe"><a href="Demand.html#splitProdDmd_maybe"><span class="hs-identifier">splitProdDmd_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209872"><a href="#local-6989586621682209872"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209873"><a href="#local-6989586621682209873"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209872"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><a href="#local-6989586621682209873"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-934"></a><span>      </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209874"><a href="#local-6989586621682209874"><span class="hs-identifier">sx</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209875"><a href="#local-6989586621682209875"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682209876"><a href="#local-6989586621682209876"><span class="hs-identifier">ux</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Demand.html#splitUseProdDmd"><span class="hs-identifier hs-var">splitUseProdDmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682209874"><span class="hs-identifier hs-var">sx</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209875"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-935"></a><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Demand.html#mkJointDmds"><span class="hs-identifier hs-var">mkJointDmds</span></a><span> </span><a href="#local-6989586621682209874"><span class="hs-identifier hs-var">sx</span></a><span> </span><a href="#local-6989586621682209876"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>      </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209877"><a href="#local-6989586621682209877"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209878"><a href="#local-6989586621682209878"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682209879"><a href="#local-6989586621682209879"><span class="hs-identifier">sx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Demand.html#splitStrProdDmd"><span class="hs-identifier hs-var">splitStrProdDmd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682209878"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209877"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-937"></a><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Demand.html#mkJointDmds"><span class="hs-identifier hs-var">mkJointDmds</span></a><span> </span><a href="#local-6989586621682209879"><span class="hs-identifier hs-var">sx</span></a><span> </span><a href="#local-6989586621682209878"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-938"></a><span>      </span><span class="hs-special">(</span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">,</span><span>    </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209880"><a href="#local-6989586621682209880"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Demand.html#mkJointDmds"><span class="hs-identifier hs-var">mkJointDmds</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682209880"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209880"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-939"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                   Demand results
*                                                                      *
************************************************************************


DmdResult:     Dunno CPRResult
               /
           ThrowsExn
             /
        Diverges


CPRResult:         NoCPR
                   /    \
            RetProd    RetSum ConTag


Product constructors return (Dunno (RetProd rs))
In a fixpoint iteration, start from Diverges
We have lubs, but not glbs; but that is ok.
-}</span><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-967"></a><span class="hs-comment">-- Constructed Product Result</span><span>
</span><a name="line-968"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span class="hs-keyword">data</span><span> </span><a name="Termination"><a href="Demand.html#Termination"><span class="hs-identifier">Termination</span></a></a><span> </span><a name="local-6989586621682209567"><a href="#local-6989586621682209567"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-971"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Diverges"><a href="Demand.html#Diverges"><span class="hs-identifier">Diverges</span></a></a><span>    </span><span class="hs-comment">-- Definitely diverges</span><span>
</span><a name="line-972"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ThrowsExn"><a href="Demand.html#ThrowsExn"><span class="hs-identifier">ThrowsExn</span></a></a><span>   </span><span class="hs-comment">-- Definitely throws an exception or diverges</span><span>
</span><a name="line-973"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Dunno"><a href="Demand.html#Dunno"><span class="hs-identifier">Dunno</span></a></a><span> </span><a href="#local-6989586621682209567"><span class="hs-identifier hs-type">r</span></a><span>     </span><span class="hs-comment">-- Might diverge or converge</span><span>
</span><a name="line-974"></a><span>  </span><span class="hs-keyword">deriving</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-975"></a><span>
</span><a name="line-976"></a><span class="hs-keyword">type</span><span> </span><a name="DmdResult"><a href="Demand.html#DmdResult"><span class="hs-identifier">DmdResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Termination"><span class="hs-identifier hs-type">Termination</span></a><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span>
</span><a name="line-977"></a><span>
</span><a name="line-978"></a><span class="hs-keyword">data</span><span> </span><a name="CPRResult"><a href="Demand.html#CPRResult"><span class="hs-identifier">CPRResult</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NoCPR"><a href="Demand.html#NoCPR"><span class="hs-identifier">NoCPR</span></a></a><span>          </span><span class="hs-comment">-- Top of the lattice</span><span>
</span><a name="line-979"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="RetProd"><a href="Demand.html#RetProd"><span class="hs-identifier">RetProd</span></a></a><span>        </span><span class="hs-comment">-- Returns a constructor from a product type</span><span>
</span><a name="line-980"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a name="RetSum"><a href="Demand.html#RetSum"><span class="hs-identifier">RetSum</span></a></a><span> </span><a href="BasicTypes.html#ConTag"><span class="hs-identifier hs-type">ConTag</span></a><span>  </span><span class="hs-comment">-- Returns a constructor from a data type</span><span>
</span><a name="line-981"></a><span>               </span><span class="hs-keyword">deriving</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>
</span><a name="line-983"></a><span class="hs-identifier">lubCPR</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span>
</span><a name="line-984"></a><a name="lubCPR"><a href="Demand.html#lubCPR"><span class="hs-identifier">lubCPR</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a name="local-6989586621682209881"><a href="#local-6989586621682209881"><span class="hs-identifier">t1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a name="local-6989586621682209882"><a href="#local-6989586621682209882"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-985"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209881"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682209882"><span class="hs-identifier hs-var">t2</span></a><span>                       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a href="#local-6989586621682209881"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-986"></a><span class="hs-identifier">lubCPR</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>     </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>
</span><a name="line-987"></a><span class="hs-identifier">lubCPR</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>                     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>
</span><a name="line-988"></a><span>
</span><a name="line-989"></a><span class="hs-identifier">lubDmdResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>
</span><a name="line-990"></a><a name="lubDmdResult"><a href="Demand.html#lubDmdResult"><span class="hs-identifier">lubDmdResult</span></a></a><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>       </span><a name="local-6989586621682209883"><a href="#local-6989586621682209883"><span class="hs-identifier">r</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209883"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-991"></a><span class="hs-identifier">lubDmdResult</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>      </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>
</span><a name="line-992"></a><span class="hs-identifier">lubDmdResult</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>      </span><a name="local-6989586621682209884"><a href="#local-6989586621682209884"><span class="hs-identifier">r</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209884"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-993"></a><span class="hs-identifier">lubDmdResult</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209885"><a href="#local-6989586621682209885"><span class="hs-identifier">c1</span></a></a><span class="hs-special">)</span><span>     </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a href="#local-6989586621682209885"><span class="hs-identifier hs-var">c1</span></a><span>
</span><a name="line-994"></a><span class="hs-identifier">lubDmdResult</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209886"><a href="#local-6989586621682209886"><span class="hs-identifier">c1</span></a></a><span class="hs-special">)</span><span>     </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a href="#local-6989586621682209886"><span class="hs-identifier hs-var">c1</span></a><span>
</span><a name="line-995"></a><span class="hs-identifier">lubDmdResult</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209887"><a href="#local-6989586621682209887"><span class="hs-identifier">c1</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209888"><a href="#local-6989586621682209888"><span class="hs-identifier">c2</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209887"><span class="hs-identifier hs-var">c1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#lubCPR"><span class="hs-identifier hs-var">lubCPR</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209888"><span class="hs-identifier hs-var">c2</span></a><span class="hs-special">)</span><span>
</span><a name="line-996"></a><span class="hs-comment">-- This needs to commute with defaultDmd, i.e.</span><span>
</span><a name="line-997"></a><span class="hs-comment">-- defaultDmd (r1 `lubDmdResult` r2) = defaultDmd r1 `lubDmd` defaultDmd r2</span><span>
</span><a name="line-998"></a><span class="hs-comment">-- (See Note [Default demand on free variables] for why)</span><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span class="hs-identifier">bothDmdResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Termination"><span class="hs-identifier hs-type">Termination</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>
</span><a name="line-1001"></a><span class="hs-comment">-- See Note [Asymmetry of 'both' for DmdType and DmdResult]</span><span>
</span><a name="line-1002"></a><a name="bothDmdResult"><a href="Demand.html#bothDmdResult"><span class="hs-identifier">bothDmdResult</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>
</span><a name="line-1003"></a><span class="hs-identifier">bothDmdResult</span><span> </span><a name="local-6989586621682209889"><a href="#local-6989586621682209889"><span class="hs-identifier">r</span></a></a><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209889"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682209889"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1004"></a><span class="hs-identifier">bothDmdResult</span><span> </span><a name="local-6989586621682209890"><a href="#local-6989586621682209890"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209890"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1005"></a><span class="hs-comment">-- This needs to commute with defaultDmd, i.e.</span><span>
</span><a name="line-1006"></a><span class="hs-comment">-- defaultDmd (r1 `bothDmdResult` r2) = defaultDmd r1 `bothDmd` defaultDmd r2</span><span>
</span><a name="line-1007"></a><span class="hs-comment">-- (See Note [Default demand on free variables] for why)</span><span>
</span><a name="line-1008"></a><span>
</span><a name="line-1009"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-6989586621682209665"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Termination"><span class="hs-identifier hs-type">Termination</span></a><span> </span><a href="#local-6989586621682209665"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1010"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'b'</span><span>
</span><a name="line-1011"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'x'</span><span>
</span><a name="line-1012"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209666"><a href="#local-6989586621682209666"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209666"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-1013"></a><span>
</span><a name="line-1014"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1015"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1016"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a name="local-6989586621682209664"><a href="#local-6989586621682209664"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'m'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-6989586621682209664"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1017"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'m'</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span class="hs-identifier">seqDmdResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1020"></a><a name="seqDmdResult"><a href="Demand.html#seqDmdResult"><span class="hs-identifier">seqDmdResult</span></a></a><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1021"></a><span class="hs-identifier">seqDmdResult</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1022"></a><span class="hs-identifier">seqDmdResult</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209891"><a href="#local-6989586621682209891"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqCPRResult"><span class="hs-identifier hs-var">seqCPRResult</span></a><span> </span><a href="#local-6989586621682209891"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-1023"></a><span>
</span><a name="line-1024"></a><span class="hs-identifier">seqCPRResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><a name="seqCPRResult"><a href="Demand.html#seqCPRResult"><span class="hs-identifier">seqCPRResult</span></a></a><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span class="hs-identifier">seqCPRResult</span><span> </span><span class="hs-special">(</span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a name="local-6989586621682209892"><a href="#local-6989586621682209892"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209892"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span class="hs-identifier">seqCPRResult</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1028"></a><span>
</span><a name="line-1029"></a><span>
</span><a name="line-1030"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-1031"></a><span class="hs-comment">-- Combined demand result                                             --</span><span>
</span><a name="line-1032"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-1033"></a><span>
</span><a name="line-1034"></a><span class="hs-comment">-- [cprRes] lets us switch off CPR analysis</span><span>
</span><a name="line-1035"></a><span class="hs-comment">-- by making sure that everything uses TopRes</span><span>
</span><a name="line-1036"></a><span class="hs-identifier">topRes</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exnRes</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">botRes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>
</span><a name="line-1037"></a><a name="topRes"><a href="Demand.html#topRes"><span class="hs-identifier">topRes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>
</span><a name="line-1038"></a><a name="exnRes"><a href="Demand.html#exnRes"><span class="hs-identifier">exnRes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>
</span><a name="line-1039"></a><a name="botRes"><a href="Demand.html#botRes"><span class="hs-identifier">botRes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span class="hs-identifier">cprSumRes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#ConTag"><span class="hs-identifier hs-type">ConTag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>
</span><a name="line-1042"></a><a name="cprSumRes"><a href="Demand.html#cprSumRes"><span class="hs-identifier">cprSumRes</span></a></a><span> </span><a name="local-6989586621682209893"><a href="#local-6989586621682209893"><span class="hs-identifier">tag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a href="#local-6989586621682209893"><span class="hs-identifier hs-var">tag</span></a><span>
</span><a name="line-1043"></a><span>
</span><a name="line-1044"></a><span class="hs-identifier">cprProdRes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>
</span><a name="line-1045"></a><a name="cprProdRes"><a href="Demand.html#cprProdRes"><span class="hs-identifier">cprProdRes</span></a></a><span> </span><a name="local-6989586621682209894"><a href="#local-6989586621682209894"><span class="hs-identifier">_arg_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>
</span><a name="line-1046"></a><span>
</span><a name="line-1047"></a><span class="hs-identifier">vanillaCprProdRes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>
</span><a name="line-1048"></a><a name="vanillaCprProdRes"><a href="Demand.html#vanillaCprProdRes"><span class="hs-identifier">vanillaCprProdRes</span></a></a><span> </span><a name="local-6989586621682209895"><a href="#local-6989586621682209895"><span class="hs-identifier">_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>
</span><a name="line-1049"></a><span>
</span><a name="line-1050"></a><span class="hs-identifier">isTopRes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1051"></a><a name="isTopRes"><a href="Demand.html#isTopRes"><span class="hs-identifier">isTopRes</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1052"></a><span class="hs-identifier">isTopRes</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1053"></a><span>
</span><a name="line-1054"></a><span class="hs-identifier">isBotRes</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1055"></a><span class="hs-comment">-- True if the result diverges or throws an exception</span><span>
</span><a name="line-1056"></a><a name="isBotRes"><a href="Demand.html#isBotRes"><span class="hs-identifier">isBotRes</span></a></a><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1057"></a><span class="hs-identifier">isBotRes</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1058"></a><span class="hs-identifier">isBotRes</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1059"></a><span>
</span><a name="line-1060"></a><span class="hs-identifier">trimCPRInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>
</span><a name="line-1061"></a><a name="trimCPRInfo"><a href="Demand.html#trimCPRInfo"><span class="hs-identifier">trimCPRInfo</span></a></a><span> </span><a name="local-6989586621682209896"><a href="#local-6989586621682209896"><span class="hs-identifier">trim_all</span></a></a><span> </span><a name="local-6989586621682209897"><a href="#local-6989586621682209897"><span class="hs-identifier">trim_sums</span></a></a><span> </span><a name="local-6989586621682209898"><a href="#local-6989586621682209898"><span class="hs-identifier">res</span></a></a><span>
</span><a name="line-1062"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209899"><span class="hs-identifier hs-var">trimR</span></a><span> </span><a href="#local-6989586621682209898"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1063"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1064"></a><span>    </span><a name="local-6989586621682209899"><a href="#local-6989586621682209899"><span class="hs-identifier">trimR</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209901"><a href="#local-6989586621682209901"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209900"><span class="hs-identifier hs-var">trimC</span></a><span> </span><a href="#local-6989586621682209901"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-1065"></a><span>    </span><span class="hs-identifier">trimR</span><span> </span><a name="local-6989586621682209902"><a href="#local-6989586621682209902"><span class="hs-identifier">res</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209902"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1066"></a><span>
</span><a name="line-1067"></a><span>    </span><a name="local-6989586621682209900"><a href="#local-6989586621682209900"><span class="hs-identifier">trimC</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a name="local-6989586621682209903"><a href="#local-6989586621682209903"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209896"><span class="hs-identifier hs-var">trim_all</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621682209897"><span class="hs-identifier hs-var">trim_sums</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>
</span><a name="line-1068"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a href="#local-6989586621682209903"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1069"></a><span>    </span><span class="hs-identifier">trimC</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209896"><span class="hs-identifier hs-var">trim_all</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>
</span><a name="line-1070"></a><span>                       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>
</span><a name="line-1071"></a><span>    </span><span class="hs-identifier">trimC</span><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>
</span><a name="line-1072"></a><span>
</span><a name="line-1073"></a><span class="hs-identifier">returnsCPR_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BasicTypes.html#ConTag"><span class="hs-identifier hs-type">ConTag</span></a><span>
</span><a name="line-1074"></a><a name="returnsCPR_maybe"><a href="Demand.html#returnsCPR_maybe"><span class="hs-identifier">returnsCPR_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209904"><a href="#local-6989586621682209904"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#retCPR_maybe"><span class="hs-identifier hs-var">retCPR_maybe</span></a><span> </span><a href="#local-6989586621682209904"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-1075"></a><span class="hs-identifier">returnsCPR_maybe</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1076"></a><span>
</span><a name="line-1077"></a><span class="hs-identifier">retCPR_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="BasicTypes.html#ConTag"><span class="hs-identifier hs-type">ConTag</span></a><span>
</span><a name="line-1078"></a><a name="retCPR_maybe"><a href="Demand.html#retCPR_maybe"><span class="hs-identifier">retCPR_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a name="local-6989586621682209905"><a href="#local-6989586621682209905"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682209905"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1079"></a><span class="hs-identifier">retCPR_maybe</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="BasicTypes.html#fIRST_TAG"><span class="hs-identifier hs-var">fIRST_TAG</span></a><span>
</span><a name="line-1080"></a><span class="hs-identifier">retCPR_maybe</span><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1081"></a><span>
</span><a name="line-1082"></a><span class="hs-comment">-- See Notes [Default demand on free variables]</span><span>
</span><a name="line-1083"></a><span class="hs-comment">-- and [defaultDmd vs. resTypeArgDmd]</span><span>
</span><a name="line-1084"></a><span class="hs-identifier">defaultDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Termination"><span class="hs-identifier hs-type">Termination</span></a><span> </span><a href="#local-6989586621682209683"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1085"></a><a name="defaultDmd"><a href="Demand.html#defaultDmd"><span class="hs-identifier">defaultDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#absDmd"><span class="hs-identifier hs-var">absDmd</span></a><span>
</span><a name="line-1086"></a><span class="hs-identifier">defaultDmd</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#botDmd"><span class="hs-identifier hs-var">botDmd</span></a><span>  </span><span class="hs-comment">-- Diverges or ThrowsExn</span><span>
</span><a name="line-1087"></a><span>
</span><a name="line-1088"></a><span class="hs-identifier">resTypeArgDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Termination"><span class="hs-identifier hs-type">Termination</span></a><span> </span><a href="#local-6989586621682209682"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1089"></a><span class="hs-comment">-- TopRes and BotRes are polymorphic, so that</span><span>
</span><a name="line-1090"></a><span class="hs-comment">--      BotRes === (Bot -&gt; BotRes) === ...</span><span>
</span><a name="line-1091"></a><span class="hs-comment">--      TopRes === (Top -&gt; TopRes) === ...</span><span>
</span><a name="line-1092"></a><span class="hs-comment">-- This function makes that concrete</span><span>
</span><a name="line-1093"></a><span class="hs-comment">-- Also see Note [defaultDmd vs. resTypeArgDmd]</span><span>
</span><a name="line-1094"></a><a name="resTypeArgDmd"><a href="Demand.html#resTypeArgDmd"><span class="hs-identifier">resTypeArgDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a><span>
</span><a name="line-1095"></a><span class="hs-identifier">resTypeArgDmd</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#botDmd"><span class="hs-identifier hs-var">botDmd</span></a><span>   </span><span class="hs-comment">-- Diverges or ThrowsExn</span><span>
</span><a name="line-1096"></a><span>
</span><a name="line-1097"></a><span class="hs-comment">{-
Note [defaultDmd and resTypeArgDmd]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

These functions are similar: They express the demand on something not
explicitly mentioned in the environment resp. the argument list. Yet they are
different:
 * Variables not mentioned in the free variables environment are definitely
   unused, so we can use absDmd there.
 * Further arguments *can* be used, of course. Hence topDmd is used.


************************************************************************
*                                                                      *
           Demand environments and types
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1115"></a><span>
</span><a name="line-1116"></a><span class="hs-keyword">type</span><span> </span><a name="DmdEnv"><a href="Demand.html#DmdEnv"><span class="hs-identifier">DmdEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>   </span><span class="hs-comment">-- See Note [Default demand on free variables]</span><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><span class="hs-keyword">data</span><span> </span><a name="DmdType"><a href="Demand.html#DmdType"><span class="hs-identifier">DmdType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="DmdType"><a href="Demand.html#DmdType"><span class="hs-identifier">DmdType</span></a></a><span>
</span><a name="line-1119"></a><span>                  </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span>        </span><span class="hs-comment">-- Demand on explicitly-mentioned</span><span>
</span><a name="line-1120"></a><span>                                </span><span class="hs-comment">--      free variables</span><span>
</span><a name="line-1121"></a><span>                  </span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Demand on arguments</span><span>
</span><a name="line-1122"></a><span>                  </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>     </span><span class="hs-comment">-- See [Nature of result demand]</span><span>
</span><a name="line-1123"></a><span>
</span><a name="line-1124"></a><span class="hs-comment">{-
Note [Nature of result demand]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A DmdResult contains information about termination (currently distinguishing
definite divergence and no information; it is possible to include definite
convergence here), and CPR information about the result.

The semantics of this depends on whether we are looking at a DmdType, i.e. the
demand put on by an expression _under a specific incoming demand_ on its
environment, or at a StrictSig describing a demand transformer.

For a
 * DmdType, the termination information is true given the demand it was
   generated with, while for
 * a StrictSig it holds after applying enough arguments.

The CPR information, though, is valid after the number of arguments mentioned
in the type is given. Therefore, when forgetting the demand on arguments, as in
dmdAnalRhs, this needs to be considere (via removeDmdTyArgs).

Consider
  b2 x y = x `seq` y `seq` error (show x)
this has a strictness signature of
  &lt;S&gt;&lt;S&gt;b
meaning that &quot;b2 `seq` ()&quot; and &quot;b2 1 `seq` ()&quot; might well terminate, but
for &quot;b2 1 2 `seq` ()&quot; we get definite divergence.

For comparison,
  b1 x = x `seq` error (show x)
has a strictness signature of
  &lt;S&gt;b
and &quot;b1 1 `seq` ()&quot; is known to terminate.

Now consider a function h with signature &quot;&lt;C(S)&gt;&quot;, and the expression
  e1 = h b1
now h puts a demand of &lt;C(S)&gt; onto its argument, and the demand transformer
turns it into
  &lt;S&gt;b
Now the DmdResult &quot;b&quot; does apply to us, even though &quot;b1 `seq` ()&quot; does not
diverge, and we do not anything being passed to b.

Note [Asymmetry of 'both' for DmdType and DmdResult]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
'both' for DmdTypes is *asymmetrical*, because there is only one
result!  For example, given (e1 e2), we get a DmdType dt1 for e1, use
its arg demand to analyse e2 giving dt2, and then do (dt1 `bothType` dt2).
Similarly with
  case e of { p -&gt; rhs }
we get dt_scrut from the scrutinee and dt_rhs from the RHS, and then
compute (dt_rhs `bothType` dt_scrut).

We
 1. combine the information on the free variables,
 2. take the demand on arguments from the first argument
 3. combine the termination results, but
 4. take CPR info from the first argument.

3 and 4 are implementd in bothDmdResult.
-}</span><span>
</span><a name="line-1183"></a><span>
</span><a name="line-1184"></a><span class="hs-comment">-- Equality needed for fixpoints in DmdAnal</span><span>
</span><a name="line-1185"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1186"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541095"><span class="hs-operator">==</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209658"><a href="#local-6989586621682209658"><span class="hs-identifier">fv1</span></a></a><span> </span><a name="local-6989586621682209659"><a href="#local-6989586621682209659"><span class="hs-identifier">ds1</span></a></a><span> </span><a name="local-6989586621682209660"><a href="#local-6989586621682209660"><span class="hs-identifier">res1</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1187"></a><span>       </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209661"><a href="#local-6989586621682209661"><span class="hs-identifier">fv2</span></a></a><span> </span><a name="local-6989586621682209662"><a href="#local-6989586621682209662"><span class="hs-identifier">ds2</span></a></a><span> </span><a name="local-6989586621682209663"><a href="#local-6989586621682209663"><span class="hs-identifier">res2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#nonDetUFMToList"><span class="hs-identifier hs-var">nonDetUFMToList</span></a><span> </span><a href="#local-6989586621682209658"><span class="hs-identifier hs-var">fv1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="UniqFM.html#nonDetUFMToList"><span class="hs-identifier hs-var">nonDetUFMToList</span></a><span> </span><a href="#local-6989586621682209661"><span class="hs-identifier hs-var">fv2</span></a><span>
</span><a name="line-1188"></a><span>         </span><span class="hs-comment">-- It's OK to use nonDetUFMToList here because we're testing for</span><span>
</span><a name="line-1189"></a><span>         </span><span class="hs-comment">-- equality and even though the lists will be in some arbitrary</span><span>
</span><a name="line-1190"></a><span>         </span><span class="hs-comment">-- Unique order, it is the same order for both</span><span>
</span><a name="line-1191"></a><span>                              </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682209659"><span class="hs-identifier hs-var">ds1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682209662"><span class="hs-identifier hs-var">ds2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682209660"><span class="hs-identifier hs-var">res1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682209663"><span class="hs-identifier hs-var">res2</span></a><span>
</span><a name="line-1192"></a><span>
</span><a name="line-1193"></a><span class="hs-identifier">lubDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1194"></a><a name="lubDmdType"><a href="Demand.html#lubDmdType"><span class="hs-identifier">lubDmdType</span></a></a><span> </span><a name="local-6989586621682209906"><a href="#local-6989586621682209906"><span class="hs-identifier">d1</span></a></a><span> </span><a name="local-6989586621682209907"><a href="#local-6989586621682209907"><span class="hs-identifier">d2</span></a></a><span>
</span><a name="line-1195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682209915"><span class="hs-identifier hs-var">lub_fv</span></a><span> </span><a href="#local-6989586621682209916"><span class="hs-identifier hs-var">lub_ds</span></a><span> </span><a href="#local-6989586621682209917"><span class="hs-identifier hs-var">lub_res</span></a><span>
</span><a name="line-1196"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1197"></a><span>    </span><a name="local-6989586621682209908"><a href="#local-6989586621682209908"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">max</span><span> </span><span class="hs-special">(</span><a href="Demand.html#dmdTypeDepth"><span class="hs-identifier hs-var">dmdTypeDepth</span></a><span> </span><a href="#local-6989586621682209906"><span class="hs-identifier hs-var">d1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#dmdTypeDepth"><span class="hs-identifier hs-var">dmdTypeDepth</span></a><span> </span><a href="#local-6989586621682209907"><span class="hs-identifier hs-var">d2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1198"></a><span>    </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209909"><a href="#local-6989586621682209909"><span class="hs-identifier">fv1</span></a></a><span> </span><a name="local-6989586621682209910"><a href="#local-6989586621682209910"><span class="hs-identifier">ds1</span></a></a><span> </span><a name="local-6989586621682209911"><a href="#local-6989586621682209911"><span class="hs-identifier">r1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#ensureArgs"><span class="hs-identifier hs-var">ensureArgs</span></a><span> </span><a href="#local-6989586621682209908"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682209906"><span class="hs-identifier hs-var">d1</span></a><span>
</span><a name="line-1199"></a><span>    </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209912"><a href="#local-6989586621682209912"><span class="hs-identifier">fv2</span></a></a><span> </span><a name="local-6989586621682209913"><a href="#local-6989586621682209913"><span class="hs-identifier">ds2</span></a></a><span> </span><a name="local-6989586621682209914"><a href="#local-6989586621682209914"><span class="hs-identifier">r2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#ensureArgs"><span class="hs-identifier hs-var">ensureArgs</span></a><span> </span><a href="#local-6989586621682209908"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682209907"><span class="hs-identifier hs-var">d2</span></a><span>
</span><a name="line-1200"></a><span>
</span><a name="line-1201"></a><span>    </span><a name="local-6989586621682209915"><a href="#local-6989586621682209915"><span class="hs-identifier">lub_fv</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#plusVarEnv_CD"><span class="hs-identifier hs-var">plusVarEnv_CD</span></a><span> </span><a href="Demand.html#lubDmd"><span class="hs-identifier hs-var">lubDmd</span></a><span> </span><a href="#local-6989586621682209909"><span class="hs-identifier hs-var">fv1</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#defaultDmd"><span class="hs-identifier hs-var">defaultDmd</span></a><span> </span><a href="#local-6989586621682209911"><span class="hs-identifier hs-var">r1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209912"><span class="hs-identifier hs-var">fv2</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#defaultDmd"><span class="hs-identifier hs-var">defaultDmd</span></a><span> </span><a href="#local-6989586621682209914"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1202"></a><span>    </span><a name="local-6989586621682209916"><a href="#local-6989586621682209916"><span class="hs-identifier">lub_ds</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#zipWithEqual"><span class="hs-identifier hs-var">zipWithEqual</span></a><span> </span><span class="hs-string">&quot;lubDmdType&quot;</span><span> </span><a href="Demand.html#lubDmd"><span class="hs-identifier hs-var">lubDmd</span></a><span> </span><a href="#local-6989586621682209910"><span class="hs-identifier hs-var">ds1</span></a><span> </span><a href="#local-6989586621682209913"><span class="hs-identifier hs-var">ds2</span></a><span>
</span><a name="line-1203"></a><span>    </span><a name="local-6989586621682209917"><a href="#local-6989586621682209917"><span class="hs-identifier">lub_res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#lubDmdResult"><span class="hs-identifier hs-var">lubDmdResult</span></a><span> </span><a href="#local-6989586621682209911"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-6989586621682209914"><span class="hs-identifier hs-var">r2</span></a><span>
</span><a name="line-1204"></a><span>
</span><a name="line-1205"></a><span class="hs-comment">{-
Note [The need for BothDmdArg]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Previously, the right argument to bothDmdType, as well as the return value of
dmdAnalStar via postProcessDmdType, was a DmdType. But bothDmdType only needs
to know about the free variables and termination information, but nothing about
the demand put on arguments, nor cpr information. So we make that explicit by
only passing the relevant information.
-}</span><span>
</span><a name="line-1214"></a><span>
</span><a name="line-1215"></a><span class="hs-keyword">type</span><span> </span><a name="BothDmdArg"><a href="Demand.html#BothDmdArg"><span class="hs-identifier">BothDmdArg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#Termination"><span class="hs-identifier hs-type">Termination</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1216"></a><span>
</span><a name="line-1217"></a><span class="hs-identifier">mkBothDmdArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#BothDmdArg"><span class="hs-identifier hs-type">BothDmdArg</span></a><span>
</span><a name="line-1218"></a><a name="mkBothDmdArg"><a href="Demand.html#mkBothDmdArg"><span class="hs-identifier">mkBothDmdArg</span></a></a><span> </span><a name="local-6989586621682209918"><a href="#local-6989586621682209918"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209918"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1219"></a><span>
</span><a name="line-1220"></a><span class="hs-identifier">toBothDmdArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#BothDmdArg"><span class="hs-identifier hs-type">BothDmdArg</span></a><span>
</span><a name="line-1221"></a><a name="toBothDmdArg"><a href="Demand.html#toBothDmdArg"><span class="hs-identifier">toBothDmdArg</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209919"><a href="#local-6989586621682209919"><span class="hs-identifier">fv</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209920"><a href="#local-6989586621682209920"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209919"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682209921"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682209920"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1223"></a><span>    </span><a name="local-6989586621682209921"><a href="#local-6989586621682209921"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1224"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>
</span><a name="line-1225"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>
</span><a name="line-1226"></a><span>
</span><a name="line-1227"></a><span class="hs-identifier">bothDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#BothDmdArg"><span class="hs-identifier hs-type">BothDmdArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1228"></a><a name="bothDmdType"><a href="Demand.html#bothDmdType"><span class="hs-identifier">bothDmdType</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209922"><a href="#local-6989586621682209922"><span class="hs-identifier">fv1</span></a></a><span> </span><a name="local-6989586621682209923"><a href="#local-6989586621682209923"><span class="hs-identifier">ds1</span></a></a><span> </span><a name="local-6989586621682209924"><a href="#local-6989586621682209924"><span class="hs-identifier">r1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682209925"><a href="#local-6989586621682209925"><span class="hs-identifier">fv2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682209926"><a href="#local-6989586621682209926"><span class="hs-identifier">t2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1229"></a><span>    </span><span class="hs-comment">-- See Note [Asymmetry of 'both' for DmdType and DmdResult]</span><span>
</span><a name="line-1230"></a><span>    </span><span class="hs-comment">-- 'both' takes the argument/result info from its *first* arg,</span><span>
</span><a name="line-1231"></a><span>    </span><span class="hs-comment">-- using its second arg just for its free-var info.</span><span>
</span><a name="line-1232"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#plusVarEnv_CD"><span class="hs-identifier hs-var">plusVarEnv_CD</span></a><span> </span><a href="Demand.html#bothDmd"><span class="hs-identifier hs-var">bothDmd</span></a><span> </span><a href="#local-6989586621682209922"><span class="hs-identifier hs-var">fv1</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#defaultDmd"><span class="hs-identifier hs-var">defaultDmd</span></a><span> </span><a href="#local-6989586621682209924"><span class="hs-identifier hs-var">r1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209925"><span class="hs-identifier hs-var">fv2</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#defaultDmd"><span class="hs-identifier hs-var">defaultDmd</span></a><span> </span><a href="#local-6989586621682209926"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1233"></a><span>            </span><a href="#local-6989586621682209923"><span class="hs-identifier hs-var">ds1</span></a><span>
</span><a name="line-1234"></a><span>            </span><span class="hs-special">(</span><a href="#local-6989586621682209924"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothDmdResult"><span class="hs-identifier hs-var">bothDmdResult</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682209926"><span class="hs-identifier hs-var">t2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1235"></a><span>
</span><a name="line-1236"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1237"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209651"><a href="#local-6989586621682209651"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621682209652"><a href="#local-6989586621682209652"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682209653"><a href="#local-6989586621682209653"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1238"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#hcat"><span class="hs-identifier hs-var">hcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209652"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209653"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span>
</span><a name="line-1239"></a><span>            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621682209655"><span class="hs-identifier hs-var">fv_elts</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1240"></a><span>            </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#fsep"><span class="hs-identifier hs-var">fsep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621682209654"><span class="hs-identifier hs-var">pp_elt</span></a><span> </span><a href="#local-6989586621682209655"><span class="hs-identifier hs-var">fv_elts</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1241"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1242"></a><span>      </span><a name="local-6989586621682209654"><a href="#local-6989586621682209654"><span class="hs-identifier">pp_elt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682209656"><a href="#local-6989586621682209656"><span class="hs-identifier">uniq</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682209657"><a href="#local-6989586621682209657"><span class="hs-identifier">dmd</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209656"><span class="hs-identifier hs-var">uniq</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;-&gt;&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209657"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1243"></a><span>      </span><a name="local-6989586621682209655"><a href="#local-6989586621682209655"><span class="hs-identifier">fv_elts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#nonDetUFMToList"><span class="hs-identifier hs-var">nonDetUFMToList</span></a><span> </span><a href="#local-6989586621682209651"><span class="hs-identifier hs-var">fv</span></a><span>
</span><a name="line-1244"></a><span>        </span><span class="hs-comment">-- It's OK to use nonDetUFMToList here because we only do it for</span><span>
</span><a name="line-1245"></a><span>        </span><span class="hs-comment">-- pretty printing</span><span>
</span><a name="line-1246"></a><span>
</span><a name="line-1247"></a><span class="hs-identifier">emptyDmdEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1248"></a><a name="emptyDmdEnv"><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier">emptyDmdEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-1249"></a><span>
</span><a name="line-1250"></a><span class="hs-comment">-- nopDmdType is the demand of doing nothing</span><span>
</span><a name="line-1251"></a><span class="hs-comment">-- (lazy, absent, no CPR information, no termination information).</span><span>
</span><a name="line-1252"></a><span class="hs-comment">-- Note that it is ''not'' the top of the lattice (which would be &quot;may use everything&quot;),</span><span>
</span><a name="line-1253"></a><span class="hs-comment">-- so it is (no longer) called topDmd</span><span>
</span><a name="line-1254"></a><span class="hs-identifier">nopDmdType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">botDmdType</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exnDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1255"></a><a name="nopDmdType"><a href="Demand.html#nopDmdType"><span class="hs-identifier">nopDmdType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="Demand.html#topRes"><span class="hs-identifier hs-var">topRes</span></a><span>
</span><a name="line-1256"></a><a name="botDmdType"><a href="Demand.html#botDmdType"><span class="hs-identifier">botDmdType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="Demand.html#botRes"><span class="hs-identifier hs-var">botRes</span></a><span>
</span><a name="line-1257"></a><a name="exnDmdType"><a href="Demand.html#exnDmdType"><span class="hs-identifier">exnDmdType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="Demand.html#exnRes"><span class="hs-identifier hs-var">exnRes</span></a><span>
</span><a name="line-1258"></a><span>
</span><a name="line-1259"></a><span class="hs-identifier">cprProdDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1260"></a><a name="cprProdDmdType"><a href="Demand.html#cprProdDmdType"><span class="hs-identifier">cprProdDmdType</span></a></a><span> </span><a name="local-6989586621682209927"><a href="#local-6989586621682209927"><span class="hs-identifier">arity</span></a></a><span>
</span><a name="line-1261"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Demand.html#vanillaCprProdRes"><span class="hs-identifier hs-var">vanillaCprProdRes</span></a><span> </span><a href="#local-6989586621682209927"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-1262"></a><span>
</span><a name="line-1263"></a><span class="hs-identifier">isTopDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1264"></a><a name="isTopDmdType"><a href="Demand.html#isTopDmdType"><span class="hs-identifier">isTopDmdType</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209928"><a href="#local-6989586621682209928"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682209929"><a href="#local-6989586621682209929"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1265"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Demand.html#isTopRes"><span class="hs-identifier hs-var">isTopRes</span></a><span> </span><a href="#local-6989586621682209929"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621682209928"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1266"></a><span class="hs-identifier">isTopDmdType</span><span> </span><span class="hs-identifier">_</span><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1267"></a><span>
</span><a name="line-1268"></a><span class="hs-identifier">mkDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1269"></a><a name="mkDmdType"><a href="Demand.html#mkDmdType"><span class="hs-identifier">mkDmdType</span></a></a><span> </span><a name="local-6989586621682209930"><a href="#local-6989586621682209930"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621682209931"><a href="#local-6989586621682209931"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682209932"><a href="#local-6989586621682209932"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682209930"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621682209931"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621682209932"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1270"></a><span>
</span><a name="line-1271"></a><span class="hs-identifier">dmdTypeDepth</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span>
</span><a name="line-1272"></a><a name="dmdTypeDepth"><a href="Demand.html#dmdTypeDepth"><span class="hs-identifier">dmdTypeDepth</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209933"><a href="#local-6989586621682209933"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682209933"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-1273"></a><span>
</span><a name="line-1274"></a><span class="hs-comment">-- Remove any demand on arguments. This is used in dmdAnalRhs on the body</span><span>
</span><a name="line-1275"></a><span class="hs-identifier">removeDmdTyArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1276"></a><a name="removeDmdTyArgs"><a href="Demand.html#removeDmdTyArgs"><span class="hs-identifier">removeDmdTyArgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#ensureArgs"><span class="hs-identifier hs-var">ensureArgs</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1277"></a><span>
</span><a name="line-1278"></a><span class="hs-comment">-- This makes sure we can use the demand type with n arguments,</span><span>
</span><a name="line-1279"></a><span class="hs-comment">-- It extends the argument list with the correct resTypeArgDmd</span><span>
</span><a name="line-1280"></a><span class="hs-comment">-- It also adjusts the DmdResult: Divergence survives additional arguments,</span><span>
</span><a name="line-1281"></a><span class="hs-comment">-- CPR information does not (and definite converge also would not).</span><span>
</span><a name="line-1282"></a><span class="hs-identifier">ensureArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1283"></a><a name="ensureArgs"><a href="Demand.html#ensureArgs"><span class="hs-identifier">ensureArgs</span></a></a><span> </span><a name="local-6989586621682209934"><a href="#local-6989586621682209934"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682209935"><a href="#local-6989586621682209935"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682209934"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682209936"><span class="hs-identifier hs-var">depth</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209935"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-1284"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682209937"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621682209940"><span class="hs-identifier hs-var">ds'</span></a><span> </span><a href="#local-6989586621682209941"><span class="hs-identifier hs-var">r'</span></a><span>
</span><a name="line-1285"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621682209936"><a href="#local-6989586621682209936"><span class="hs-identifier">depth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#dmdTypeDepth"><span class="hs-identifier hs-var">dmdTypeDepth</span></a><span> </span><a href="#local-6989586621682209935"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-1286"></a><span>        </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209937"><a href="#local-6989586621682209937"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621682209938"><a href="#local-6989586621682209938"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682209939"><a href="#local-6989586621682209939"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209935"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-1287"></a><span>
</span><a name="line-1288"></a><span>        </span><a name="local-6989586621682209940"><a href="#local-6989586621682209940"><span class="hs-identifier">ds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><a href="#local-6989586621682209934"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209938"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-special">(</span><a href="Demand.html#resTypeArgDmd"><span class="hs-identifier hs-var">resTypeArgDmd</span></a><span> </span><a href="#local-6989586621682209939"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1289"></a><span>        </span><a name="local-6989586621682209941"><a href="#local-6989586621682209941"><span class="hs-identifier">r'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209939"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-keyword">of</span><span>    </span><span class="hs-comment">-- See [Nature of result demand]</span><span>
</span><a name="line-1290"></a><span>              </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#topRes"><span class="hs-identifier hs-var">topRes</span></a><span>
</span><a name="line-1291"></a><span>              </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682209939"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1292"></a><span>
</span><a name="line-1293"></a><span>
</span><a name="line-1294"></a><span class="hs-identifier">seqDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1295"></a><a name="seqDmdType"><a href="Demand.html#seqDmdType"><span class="hs-identifier">seqDmdType</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209942"><a href="#local-6989586621682209942"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682209943"><a href="#local-6989586621682209943"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682209944"><a href="#local-6989586621682209944"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1296"></a><span>  </span><a href="Demand.html#seqDmdEnv"><span class="hs-identifier hs-var">seqDmdEnv</span></a><span> </span><a href="#local-6989586621682209942"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqDemandList"><span class="hs-identifier hs-var">seqDemandList</span></a><span> </span><a href="#local-6989586621682209943"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="Demand.html#seqDmdResult"><span class="hs-identifier hs-var">seqDmdResult</span></a><span> </span><a href="#local-6989586621682209944"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1297"></a><span>
</span><a name="line-1298"></a><span class="hs-identifier">seqDmdEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1299"></a><a name="seqDmdEnv"><a href="Demand.html#seqDmdEnv"><span class="hs-identifier">seqDmdEnv</span></a></a><span> </span><a name="local-6989586621682209945"><a href="#local-6989586621682209945"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#seqEltsUFM"><span class="hs-identifier hs-var">seqEltsUFM</span></a><span> </span><a href="Demand.html#seqDemandList"><span class="hs-identifier hs-var">seqDemandList</span></a><span> </span><a href="#local-6989586621682209945"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1300"></a><span>
</span><a name="line-1301"></a><span class="hs-identifier">splitDmdTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span class="hs-special">)</span><span>
</span><a name="line-1302"></a><span class="hs-comment">-- Split off one function argument</span><span>
</span><a name="line-1303"></a><span class="hs-comment">-- We already have a suitable demand on all</span><span>
</span><a name="line-1304"></a><span class="hs-comment">-- free vars, so no need to add more!</span><span>
</span><a name="line-1305"></a><a name="splitDmdTy"><a href="Demand.html#splitDmdTy"><span class="hs-identifier">splitDmdTy</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209946"><a href="#local-6989586621682209946"><span class="hs-identifier">fv</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682209947"><a href="#local-6989586621682209947"><span class="hs-identifier">dmd</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621682209948"><a href="#local-6989586621682209948"><span class="hs-identifier">dmds</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682209949"><a href="#local-6989586621682209949"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209947"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682209946"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621682209948"><span class="hs-identifier hs-var">dmds</span></a><span> </span><a href="#local-6989586621682209949"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1306"></a><span class="hs-identifier">splitDmdTy</span><span> </span><a name="local-6989586621682209950"><a href="#local-6989586621682209950"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682209951"><a href="#local-6989586621682209951"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Demand.html#resTypeArgDmd"><span class="hs-identifier hs-var">resTypeArgDmd</span></a><span> </span><a href="#local-6989586621682209951"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682209950"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1307"></a><span>
</span><a name="line-1308"></a><span class="hs-comment">-- When e is evaluated after executing an IO action, and d is e's demand, then</span><span>
</span><a name="line-1309"></a><span class="hs-comment">-- what of this demand should we consider, given that the IO action can cleanly</span><span>
</span><a name="line-1310"></a><span class="hs-comment">-- exit?</span><span>
</span><a name="line-1311"></a><span class="hs-comment">-- * We have to kill all strictness demands (i.e. lub with a lazy demand)</span><span>
</span><a name="line-1312"></a><span class="hs-comment">-- * We can keep usage information (i.e. lub with an absent demand)</span><span>
</span><a name="line-1313"></a><span class="hs-comment">-- * We have to kill definite divergence</span><span>
</span><a name="line-1314"></a><span class="hs-comment">-- * We can keep CPR information.</span><span>
</span><a name="line-1315"></a><span class="hs-comment">-- See Note [IO hack in the demand analyser] in DmdAnal</span><span>
</span><a name="line-1316"></a><span class="hs-identifier">deferAfterIO</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1317"></a><a name="deferAfterIO"><a href="Demand.html#deferAfterIO"><span class="hs-identifier">deferAfterIO</span></a></a><span> </span><a name="local-6989586621682209952"><a href="#local-6989586621682209952"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209953"><a href="#local-6989586621682209953"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1318"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209952"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#lubDmdType"><span class="hs-identifier hs-var">lubDmdType</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#nopDmdType"><span class="hs-identifier hs-var">nopDmdType</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1319"></a><span>        </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209956"><a href="#local-6989586621682209956"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621682209957"><a href="#local-6989586621682209957"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682209956"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621682209957"><span class="hs-identifier hs-var">ds</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682209954"><span class="hs-identifier hs-var">defer_res</span></a><span> </span><a href="#local-6989586621682209953"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1320"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1321"></a><span>  </span><a name="local-6989586621682209954"><a href="#local-6989586621682209954"><span class="hs-identifier">defer_res</span></a></a><span> </span><a name="local-6989586621682209955"><a href="#local-6989586621682209955"><span class="hs-identifier">r</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209955"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1322"></a><span>  </span><span class="hs-identifier">defer_res</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#topRes"><span class="hs-identifier hs-var">topRes</span></a><span>  </span><span class="hs-comment">-- Diverges and ThrowsExn</span><span>
</span><a name="line-1323"></a><span>
</span><a name="line-1324"></a><span class="hs-identifier">strictenDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span>
</span><a name="line-1325"></a><a name="strictenDmd"><a href="Demand.html#strictenDmd"><span class="hs-identifier">strictenDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209958"><a href="#local-6989586621682209958"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209959"><a href="#local-6989586621682209959"><span class="hs-identifier">u</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1326"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209960"><span class="hs-identifier hs-var">poke_s</span></a><span> </span><a href="#local-6989586621682209958"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209961"><span class="hs-identifier hs-var">poke_u</span></a><span> </span><a href="#local-6989586621682209959"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1327"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1328"></a><span>    </span><a name="local-6989586621682209960"><a href="#local-6989586621682209960"><span class="hs-identifier">poke_s</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-1329"></a><span>    </span><span class="hs-identifier">poke_s</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209962"><a href="#local-6989586621682209962"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209962"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1330"></a><span>    </span><a name="local-6989586621682209961"><a href="#local-6989586621682209961"><span class="hs-identifier">poke_u</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>
</span><a name="line-1331"></a><span>    </span><span class="hs-identifier">poke_u</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209963"><a href="#local-6989586621682209963"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209963"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-1332"></a><span>
</span><a name="line-1333"></a><span class="hs-comment">-- Deferring and peeling</span><span>
</span><a name="line-1334"></a><span>
</span><a name="line-1335"></a><span class="hs-keyword">type</span><span> </span><a name="DmdShell"><a href="Demand.html#DmdShell"><span class="hs-identifier">DmdShell</span></a></a><span>   </span><span class="hs-comment">-- Describes the &quot;outer shell&quot;</span><span>
</span><a name="line-1336"></a><span>                </span><span class="hs-comment">-- of a Demand</span><span>
</span><a name="line-1337"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-type">Str</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1338"></a><span>
</span><a name="line-1339"></a><span class="hs-identifier">toCleanDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdShell"><span class="hs-identifier hs-type">DmdShell</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span class="hs-comment">-- Splits a Demand into its &quot;shell&quot; and the inner &quot;clean demand&quot;</span><span>
</span><a name="line-1341"></a><a name="toCleanDmd"><a href="Demand.html#toCleanDmd"><span class="hs-identifier">toCleanDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209964"><a href="#local-6989586621682209964"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209965"><a href="#local-6989586621682209965"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1342"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209966"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209968"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209967"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209969"><span class="hs-identifier hs-var">u'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1343"></a><span>    </span><span class="hs-comment">-- See Note [Analyzing with lazy demand and lambdas]</span><span>
</span><a name="line-1344"></a><span>    </span><span class="hs-comment">-- See Note [Analysing with absent demand]</span><span>
</span><a name="line-1345"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1346"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682209966"><a href="#local-6989586621682209966"><span class="hs-identifier">ss</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682209967"><a href="#local-6989586621682209967"><span class="hs-identifier">s'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209964"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1347"></a><span>                </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209970"><a href="#local-6989586621682209970"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682209971"><a href="#local-6989586621682209971"><span class="hs-identifier">s'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="#local-6989586621682209970"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682209971"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1348"></a><span>                </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">,</span><span>     </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682209968"><a href="#local-6989586621682209968"><span class="hs-identifier">us</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682209969"><a href="#local-6989586621682209969"><span class="hs-identifier">u'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209965"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1351"></a><span>                 </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a name="local-6989586621682209972"><a href="#local-6989586621682209972"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209973"><a href="#local-6989586621682209973"><span class="hs-identifier">u'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="#local-6989586621682209972"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621682209973"><span class="hs-identifier hs-var">u'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1352"></a><span>                 </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span class="hs-special">,</span><span>      </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span class="hs-special">)</span><span>
</span><a name="line-1353"></a><span>
</span><a name="line-1354"></a><span class="hs-comment">-- This is used in dmdAnalStar when post-processing</span><span>
</span><a name="line-1355"></a><span class="hs-comment">-- a function's argument demand. So we only care about what</span><span>
</span><a name="line-1356"></a><span class="hs-comment">-- does to free variables, and whether it terminates.</span><span>
</span><a name="line-1357"></a><span class="hs-comment">-- see Note [The need for BothDmdArg]</span><span>
</span><a name="line-1358"></a><span class="hs-identifier">postProcessDmdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdShell"><span class="hs-identifier hs-type">DmdShell</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#BothDmdArg"><span class="hs-identifier hs-type">BothDmdArg</span></a><span>
</span><a name="line-1359"></a><a name="postProcessDmdType"><a href="Demand.html#postProcessDmdType"><span class="hs-identifier">postProcessDmdType</span></a></a><span> </span><a name="local-6989586621682209974"><a href="#local-6989586621682209974"><span class="hs-identifier">du</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209975"><a href="#local-6989586621682209975"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209976"><a href="#local-6989586621682209976"><span class="hs-identifier">fv</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209977"><a href="#local-6989586621682209977"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1360"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Demand.html#postProcessDmdEnv"><span class="hs-identifier hs-var">postProcessDmdEnv</span></a><span> </span><a href="#local-6989586621682209974"><span class="hs-identifier hs-var">du</span></a><span> </span><a href="#local-6989586621682209976"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682209978"><span class="hs-identifier hs-var">term_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-1361"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-1362"></a><span>       </span><a name="local-6989586621682209978"><a href="#local-6989586621682209978"><span class="hs-identifier">term_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Demand.html#postProcessDmdResult"><span class="hs-identifier hs-var">postProcessDmdResult</span></a><span> </span><a href="#local-6989586621682209975"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621682209977"><span class="hs-identifier hs-var">res_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1363"></a><span>                     </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1364"></a><span>                     </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>
</span><a name="line-1365"></a><span>                     </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>
</span><a name="line-1366"></a><span>
</span><a name="line-1367"></a><span class="hs-identifier">postProcessDmdResult</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-type">Str</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span>
</span><a name="line-1368"></a><a name="postProcessDmdResult"><a href="Demand.html#postProcessDmdResult"><span class="hs-identifier">postProcessDmdResult</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>           </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#topRes"><span class="hs-identifier hs-var">topRes</span></a><span>
</span><a name="line-1369"></a><span class="hs-identifier">postProcessDmdResult</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#topRes"><span class="hs-identifier hs-var">topRes</span></a><span>  </span><span class="hs-comment">-- Key point!</span><span>
</span><a name="line-1370"></a><span class="hs-comment">-- Note that only ThrowsExn results can be caught, not Diverges</span><span>
</span><a name="line-1371"></a><span class="hs-identifier">postProcessDmdResult</span><span> </span><span class="hs-identifier">_</span><span>              </span><a name="local-6989586621682209979"><a href="#local-6989586621682209979"><span class="hs-identifier">res</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209979"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1372"></a><span>
</span><a name="line-1373"></a><span class="hs-identifier">postProcessDmdEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdShell"><span class="hs-identifier hs-type">DmdShell</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span>
</span><a name="line-1374"></a><a name="postProcessDmdEnv"><a href="Demand.html#postProcessDmdEnv"><span class="hs-identifier">postProcessDmdEnv</span></a></a><span> </span><a name="local-6989586621682209980"><a href="#local-6989586621682209980"><span class="hs-identifier">ds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209981"><a href="#local-6989586621682209981"><span class="hs-identifier">ss</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209982"><a href="#local-6989586621682209982"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682209983"><a href="#local-6989586621682209983"><span class="hs-identifier">env</span></a></a><span>
</span><a name="line-1375"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682209982"><span class="hs-identifier hs-var">us</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span>
</span><a name="line-1376"></a><span>    </span><span class="hs-comment">-- In this case (postProcessDmd ds) == id; avoid a redundant rebuild</span><span>
</span><a name="line-1377"></a><span>    </span><span class="hs-comment">-- of the environment. Be careful, bad things will happen if this doesn't</span><span>
</span><a name="line-1378"></a><span>    </span><span class="hs-comment">-- match postProcessDmd (see #13977).</span><span>
</span><a name="line-1379"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682209981"><span class="hs-identifier hs-var">ss</span></a><span>
</span><a name="line-1380"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682209982"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209983"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1381"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mapVarEnv"><span class="hs-identifier hs-var">mapVarEnv</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#postProcessDmd"><span class="hs-identifier hs-var">postProcessDmd</span></a><span> </span><a href="#local-6989586621682209980"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209983"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1382"></a><span>  </span><span class="hs-comment">-- For the Absent case just discard all usage information</span><span>
</span><a name="line-1383"></a><span>  </span><span class="hs-comment">-- We only processed the thing at all to analyse the body</span><span>
</span><a name="line-1384"></a><span>  </span><span class="hs-comment">-- See Note [Always analyse in virgin pass]</span><span>
</span><a name="line-1385"></a><span>
</span><a name="line-1386"></a><span class="hs-identifier">reuseEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span>
</span><a name="line-1387"></a><a name="reuseEnv"><a href="Demand.html#reuseEnv"><span class="hs-identifier">reuseEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mapVarEnv"><span class="hs-identifier hs-var">mapVarEnv</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#postProcessDmd"><span class="hs-identifier hs-var">postProcessDmd</span></a><span>
</span><a name="line-1388"></a><span>                        </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1389"></a><span>
</span><a name="line-1390"></a><span class="hs-identifier">postProcessUnsat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdShell"><span class="hs-identifier hs-type">DmdShell</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1391"></a><a name="postProcessUnsat"><a href="Demand.html#postProcessUnsat"><span class="hs-identifier">postProcessUnsat</span></a></a><span> </span><a name="local-6989586621682209984"><a href="#local-6989586621682209984"><span class="hs-identifier">ds</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209985"><a href="#local-6989586621682209985"><span class="hs-identifier">ss</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682209986"><a href="#local-6989586621682209986"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621682209987"><a href="#local-6989586621682209987"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621682209988"><a href="#local-6989586621682209988"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1392"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#postProcessDmdEnv"><span class="hs-identifier hs-var">postProcessDmdEnv</span></a><span> </span><a href="#local-6989586621682209984"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621682209986"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">)</span><span>
</span><a name="line-1393"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Demand.html#postProcessDmd"><span class="hs-identifier hs-var">postProcessDmd</span></a><span> </span><a href="#local-6989586621682209984"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682209987"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1394"></a><span>            </span><span class="hs-special">(</span><a href="Demand.html#postProcessDmdResult"><span class="hs-identifier hs-var">postProcessDmdResult</span></a><span> </span><a href="#local-6989586621682209985"><span class="hs-identifier hs-var">ss</span></a><span> </span><a href="#local-6989586621682209988"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1395"></a><span>
</span><a name="line-1396"></a><span class="hs-identifier">postProcessDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdShell"><span class="hs-identifier hs-type">DmdShell</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1397"></a><a name="postProcessDmd"><a href="Demand.html#postProcessDmd"><span class="hs-identifier">postProcessDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209989"><a href="#local-6989586621682209989"><span class="hs-identifier">ss</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209990"><a href="#local-6989586621682209990"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209991"><a href="#local-6989586621682209991"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209992"><a href="#local-6989586621682209992"><span class="hs-identifier">a</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1398"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209993"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209994"><span class="hs-identifier hs-var">a'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1399"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1400"></a><span>    </span><a name="local-6989586621682209993"><a href="#local-6989586621682209993"><span class="hs-identifier">s'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209989"><span class="hs-identifier hs-var">ss</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1401"></a><span>           </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-1402"></a><span>           </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#markExnStr"><span class="hs-identifier hs-var">markExnStr</span></a><span> </span><a href="#local-6989586621682209991"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1403"></a><span>           </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682209991"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1404"></a><span>    </span><a name="local-6989586621682209994"><a href="#local-6989586621682209994"><span class="hs-identifier">a'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209990"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1405"></a><span>           </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>
</span><a name="line-1406"></a><span>           </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#markReusedDmd"><span class="hs-identifier hs-var">markReusedDmd</span></a><span> </span><a href="#local-6989586621682209992"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1407"></a><span>           </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682209992"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-1408"></a><span>
</span><a name="line-1409"></a><span class="hs-identifier">markExnStr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span>
</span><a name="line-1410"></a><a name="markExnStr"><a href="Demand.html#markExnStr"><span class="hs-identifier">markExnStr</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a name="local-6989586621682209995"><a href="#local-6989586621682209995"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span> </span><a href="#local-6989586621682209995"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1411"></a><span class="hs-identifier">markExnStr</span><span> </span><a name="local-6989586621682209996"><a href="#local-6989586621682209996"><span class="hs-identifier">s</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209996"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1412"></a><span>
</span><a name="line-1413"></a><span class="hs-comment">-- Peels one call level from the demand, and also returns</span><span>
</span><a name="line-1414"></a><span class="hs-comment">-- whether it was unsaturated (separately for strictness and usage)</span><span>
</span><a name="line-1415"></a><span class="hs-identifier">peelCallDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#DmdShell"><span class="hs-identifier hs-type">DmdShell</span></a><span class="hs-special">)</span><span>
</span><a name="line-1416"></a><span class="hs-comment">-- Exploiting the fact that</span><span>
</span><a name="line-1417"></a><span class="hs-comment">-- on the strictness side      C(B) = B</span><span>
</span><a name="line-1418"></a><span class="hs-comment">-- and on the usage side       C(U) = U</span><span>
</span><a name="line-1419"></a><a name="peelCallDmd"><a href="Demand.html#peelCallDmd"><span class="hs-identifier">peelCallDmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209997"><a href="#local-6989586621682209997"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209998"><a href="#local-6989586621682209998"><span class="hs-identifier">u</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1420"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209999"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210001"><span class="hs-identifier hs-var">u'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210000"><span class="hs-identifier hs-var">ss</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210002"><span class="hs-identifier hs-var">us</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1421"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1422"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682209999"><a href="#local-6989586621682209999"><span class="hs-identifier">s'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682210000"><a href="#local-6989586621682210000"><span class="hs-identifier">ss</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209997"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1423"></a><span>                 </span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682210003"><a href="#local-6989586621682210003"><span class="hs-identifier">s'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210003"><span class="hs-identifier hs-var">s'</span></a><span class="hs-special">,</span><span>       </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1424"></a><span>                 </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1425"></a><span>                 </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span class="hs-special">,</span><span>  </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span class="hs-special">)</span><span>
</span><a name="line-1426"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682210001"><a href="#local-6989586621682210001"><span class="hs-identifier">u'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682210002"><a href="#local-6989586621682210002"><span class="hs-identifier">us</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209998"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1427"></a><span>                 </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682210004"><a href="#local-6989586621682210004"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682210005"><a href="#local-6989586621682210005"><span class="hs-identifier">u'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210005"><span class="hs-identifier hs-var">u'</span></a><span class="hs-special">,</span><span>   </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="#local-6989586621682210004"><span class="hs-identifier hs-var">c</span></a><span>    </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1428"></a><span>                 </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1429"></a><span>       </span><span class="hs-comment">-- The _ cases for usage includes UHead which seems a bit wrong</span><span>
</span><a name="line-1430"></a><span>       </span><span class="hs-comment">-- because the body isn't used at all!</span><span>
</span><a name="line-1431"></a><span>       </span><span class="hs-comment">-- c.f. the Abs case in toCleanDmd</span><span>
</span><a name="line-1432"></a><span>
</span><a name="line-1433"></a><span class="hs-comment">-- Peels that multiple nestings of calls clean demand and also returns</span><span>
</span><a name="line-1434"></a><span class="hs-comment">-- whether it was unsaturated (separately for strictness and usage</span><span>
</span><a name="line-1435"></a><span class="hs-comment">-- see Note [Demands from unsaturated function calls]</span><span>
</span><a name="line-1436"></a><span class="hs-identifier">peelManyCalls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdShell"><span class="hs-identifier hs-type">DmdShell</span></a><span>
</span><a name="line-1437"></a><a name="peelManyCalls"><a href="Demand.html#peelManyCalls"><span class="hs-identifier">peelManyCalls</span></a></a><span> </span><a name="local-6989586621682210006"><a href="#local-6989586621682210006"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210007"><a href="#local-6989586621682210007"><span class="hs-identifier">str</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210008"><a href="#local-6989586621682210008"><span class="hs-identifier">abs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1438"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210009"><span class="hs-identifier hs-var">go_str</span></a><span> </span><a href="#local-6989586621682210006"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682210007"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210010"><span class="hs-identifier hs-var">go_abs</span></a><span> </span><a href="#local-6989586621682210006"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682210008"><span class="hs-identifier hs-var">abs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1439"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1440"></a><span>    </span><span class="hs-identifier">go_str</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-type">Str</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- True &lt;=&gt; unsaturated, defer</span><span>
</span><a name="line-1441"></a><span>    </span><a name="local-6989586621682210009"><a href="#local-6989586621682210009"><span class="hs-identifier">go_str</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1442"></a><span>    </span><span class="hs-identifier">go_str</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- == go_str (n-1) HyperStr, as HyperStr = Call(HyperStr)</span><span>
</span><a name="line-1443"></a><span>    </span><span class="hs-identifier">go_str</span><span> </span><a name="local-6989586621682210011"><a href="#local-6989586621682210011"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682210012"><a href="#local-6989586621682210012"><span class="hs-identifier">d'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210009"><span class="hs-identifier hs-var">go_str</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210011"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210012"><span class="hs-identifier hs-var">d'</span></a><span>
</span><a name="line-1444"></a><span>    </span><span class="hs-identifier">go_str</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-1445"></a><span>
</span><a name="line-1446"></a><span>    </span><span class="hs-identifier">go_abs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-type">Use</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Many &lt;=&gt; unsaturated, or at least</span><span>
</span><a name="line-1447"></a><span>    </span><a name="local-6989586621682210010"><a href="#local-6989586621682210010"><span class="hs-identifier">go_abs</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">--          one UCall Many in the demand</span><span>
</span><a name="line-1448"></a><span>    </span><span class="hs-identifier">go_abs</span><span> </span><a name="local-6989586621682210013"><a href="#local-6989586621682210013"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a name="local-6989586621682210014"><a href="#local-6989586621682210014"><span class="hs-identifier">d'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210010"><span class="hs-identifier hs-var">go_abs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210013"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210014"><span class="hs-identifier hs-var">d'</span></a><span>
</span><a name="line-1449"></a><span>    </span><span class="hs-identifier">go_abs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1450"></a><span>
</span><a name="line-1451"></a><span class="hs-comment">{-
Note [Demands from unsaturated function calls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Consider a demand transformer d1 -&gt; d2 -&gt; r for f.
If a sufficiently detailed demand is fed into this transformer,
e.g &lt;C(C(S)), C1(C1(S))&gt; arising from &quot;f x1 x2&quot; in a strict, use-once context,
then d1 and d2 is precisely the demand unleashed onto x1 and x2 (similar for
the free variable environment) and furthermore the result information r is the
one we want to use.

An anonymous lambda is also an unsaturated function all (needs one argument,
none given), so this applies to that case as well.

But the demand fed into f might be less than &lt;C(C(S)), C1(C1(S))&gt;. There are a few cases:
 * Not enough demand on the strictness side:
   - In that case, we need to zap all strictness in the demand on arguments and
     free variables.
   - Furthermore, we remove CPR information. It could be left, but given the incoming
     demand is not enough to evaluate so far we just do not bother.
   - And finally termination information: If r says that f diverges for sure,
     then this holds when the demand guarantees that two arguments are going to
     be passed. If the demand is lower, we may just as well converge.
     If we were tracking definite convegence, than that would still hold under
     a weaker demand than expected by the demand transformer.
 * Not enough demand from the usage side: The missing usage can be expanded
   using UCall Many, therefore this is subsumed by the third case:
 * At least one of the uses has a cardinality of Many.
   - Even if f puts a One demand on any of its argument or free variables, if
     we call f multiple times, we may evaluate this argument or free variable
     multiple times. So forget about any occurrence of &quot;One&quot; in the demand.

In dmdTransformSig, we call peelManyCalls to find out if we are in any of these
cases, and then call postProcessUnsat to reduce the demand appropriately.

Similarly, dmdTransformDictSelSig and dmdAnal, when analyzing a Lambda, use
peelCallDmd, which peels only one level, but also returns the demand put on the
body of the function.
-}</span><span>
</span><a name="line-1490"></a><span>
</span><a name="line-1491"></a><span class="hs-identifier">peelFV</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span class="hs-special">,</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">)</span><span>
</span><a name="line-1492"></a><a name="peelFV"><a href="Demand.html#peelFV"><span class="hs-identifier">peelFV</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210015"><a href="#local-6989586621682210015"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621682210016"><a href="#local-6989586621682210016"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682210017"><a href="#local-6989586621682210017"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682210018"><a href="#local-6989586621682210018"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;rfv&quot; (ppr id &lt;+&gt; ppr dmd $$ ppr fv)</span><span>
</span><a name="line-1493"></a><span>                               </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682210019"><span class="hs-identifier hs-var">fv'</span></a><span> </span><a href="#local-6989586621682210016"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621682210017"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682210020"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-special">)</span><span>
</span><a name="line-1494"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1495"></a><span>  </span><a name="local-6989586621682210019"><a href="#local-6989586621682210019"><span class="hs-identifier">fv'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210015"><span class="hs-identifier hs-var">fv</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682210018"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-1496"></a><span>  </span><span class="hs-comment">-- See Note [Default demand on free variables]</span><span>
</span><a name="line-1497"></a><span>  </span><a name="local-6989586621682210020"><a href="#local-6989586621682210020"><span class="hs-identifier">dmd</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621682210015"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621682210018"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#defaultDmd"><span class="hs-identifier hs-var">defaultDmd</span></a><span> </span><a href="#local-6989586621682210017"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1498"></a><span>
</span><a name="line-1499"></a><span class="hs-identifier">addDemand</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1500"></a><a name="addDemand"><a href="Demand.html#addDemand"><span class="hs-identifier">addDemand</span></a></a><span> </span><a name="local-6989586621682210021"><a href="#local-6989586621682210021"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210022"><a href="#local-6989586621682210022"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621682210023"><a href="#local-6989586621682210023"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682210024"><a href="#local-6989586621682210024"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682210022"><span class="hs-identifier hs-var">fv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210021"><span class="hs-identifier hs-var">dmd</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682210023"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210024"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1501"></a><span>
</span><a name="line-1502"></a><span class="hs-identifier">findIdDemand</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1503"></a><a name="findIdDemand"><a href="Demand.html#findIdDemand"><span class="hs-identifier">findIdDemand</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210025"><a href="#local-6989586621682210025"><span class="hs-identifier">fv</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210026"><a href="#local-6989586621682210026"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621682210027"><a href="#local-6989586621682210027"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-1504"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621682210025"><span class="hs-identifier hs-var">fv</span></a><span> </span><a href="#local-6989586621682210027"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#defaultDmd"><span class="hs-identifier hs-var">defaultDmd</span></a><span> </span><a href="#local-6989586621682210026"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1505"></a><span>
</span><a name="line-1506"></a><span class="hs-comment">{-
Note [Default demand on free variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If the variable is not mentioned in the environment of a demand type,
its demand is taken to be a result demand of the type.
    For the stricness component,
     if the result demand is a Diverges, then we use HyperStr
                                         else we use Lazy
    For the usage component, we use Absent.
So we use either absDmd or botDmd.

Also note the equations for lubDmdResult (resp. bothDmdResult) noted there.

Note [Always analyse in virgin pass]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Tricky point: make sure that we analyse in the 'virgin' pass. Consider
   rec { f acc x True  = f (...rec { g y = ...g... }...)
         f acc x False = acc }
In the virgin pass for 'f' we'll give 'f' a very strict (bottom) type.
That might mean that we analyse the sub-expression containing the
E = &quot;...rec g...&quot; stuff in a bottom demand.  Suppose we *didn't analyse*
E, but just returned botType.

Then in the *next* (non-virgin) iteration for 'f', we might analyse E
in a weaker demand, and that will trigger doing a fixpoint iteration
for g.  But *because it's not the virgin pass* we won't start g's
iteration at bottom.  Disaster.  (This happened in $sfibToList' of
nofib/spectral/fibheaps.)

So in the virgin pass we make sure that we do analyse the expression
at least once, to initialise its signatures.

Note [Analyzing with lazy demand and lambdas]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The insight for analyzing lambdas follows from the fact that for
strictness S = C(L). This polymorphic expansion is critical for
cardinality analysis of the following example:

{-# NOINLINE build #-}
build g = (g (:) [], g (:) [])

h c z = build (\x -&gt;
                let z1 = z ++ z
                 in if c
                    then \y -&gt; x (y ++ z1)
                    else \y -&gt; x (z1 ++ y))

One can see that `build` assigns to `g` demand &lt;L,C(C1(U))&gt;.
Therefore, when analyzing the lambda `(\x -&gt; ...)`, we
expect each lambda \y -&gt; ... to be annotated as &quot;one-shot&quot;
one. Therefore (\x -&gt; \y -&gt; x (y ++ z)) should be analyzed with a
demand &lt;C(C(..), C(C1(U))&gt;.

This is achieved by, first, converting the lazy demand L into the
strict S by the second clause of the analysis.

Note [Analysing with absent demand]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we analyse an expression with demand &lt;L,A&gt;.  The &quot;A&quot; means
&quot;absent&quot;, so this expression will never be needed.  What should happen?
There are several wrinkles:

* We *do* want to analyse the expression regardless.
  Reason: Note [Always analyse in virgin pass]

  But we can post-process the results to ignore all the usage
  demands coming back. This is done by postProcessDmdType.

* In a previous incarnation of GHC we needed to be extra careful in the
  case of an *unlifted type*, because unlifted values are evaluated
  even if they are not used.  Example (see Trac #9254):
     f :: (() -&gt; (# Int#, () #)) -&gt; ()
          -- Strictness signature is
          --    &lt;C(S(LS)), 1*C1(U(A,1*U()))&gt;
          -- I.e. calls k, but discards first component of result
     f k = case k () of (# _, r #) -&gt; r

     g :: Int -&gt; ()
     g y = f (\n -&gt; (# case y of I# y2 -&gt; y2, n #))

  Here f's strictness signature says (correctly) that it calls its
  argument function and ignores the first component of its result.
  This is correct in the sense that it'd be fine to (say) modify the
  function so that always returned 0# in the first component.

  But in function g, we *will* evaluate the 'case y of ...', because
  it has type Int#.  So 'y' will be evaluated.  So we must record this
  usage of 'y', else 'g' will say 'y' is absent, and will w/w so that
  'y' is bound to an aBSENT_ERROR thunk.

  However, the argument of toCleanDmd always satisfies the let/app
  invariant; so if it is unlifted it is also okForSpeculation, and so
  can be evaluated in a short finite time -- and that rules out nasty
  cases like the one above.  (I'm not quite sure why this was a
  problem in an earlier version of GHC, but it isn't now.)


************************************************************************
*                                                                      *
                     Demand signatures
*                                                                      *
************************************************************************

In a let-bound Id we record its strictness info.
In principle, this strictness info is a demand transformer, mapping
a demand on the Id into a DmdType, which gives
        a) the free vars of the Id's value
        b) the Id's arguments
        c) an indication of the result of applying
           the Id to its arguments

However, in fact we store in the Id an extremely emascuated demand
transfomer, namely

                a single DmdType
(Nevertheless we dignify StrictSig as a distinct type.)

This DmdType gives the demands unleashed by the Id when it is applied
to as many arguments as are given in by the arg demands in the DmdType.
Also see Note [Nature of result demand] for the meaning of a DmdResult in a
strictness signature.

If an Id is applied to less arguments than its arity, it means that
the demand on the function at a call site is weaker than the vanilla
call demand, used for signature inference. Therefore we place a top
demand on all arguments. Otherwise, the demand is specified by Id's
signature.

For example, the demand transformer described by the demand signature
        StrictSig (DmdType {x -&gt; &lt;S,1*U&gt;} &lt;L,A&gt;&lt;L,U(U,U)&gt;m)
says that when the function is applied to two arguments, it
unleashes demand &lt;S,1*U&gt; on the free var x, &lt;L,A&gt; on the first arg,
and &lt;L,U(U,U)&gt; on the second, then returning a constructor.

If this same function is applied to one arg, all we can say is that it
uses x with &lt;L,U&gt;, and its arg with demand &lt;L,U&gt;.
-}</span><span>
</span><a name="line-1643"></a><span>
</span><a name="line-1644"></a><span class="hs-keyword">newtype</span><span> </span><a name="StrictSig"><a href="Demand.html#StrictSig"><span class="hs-identifier">StrictSig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="StrictSig"><a href="Demand.html#StrictSig"><span class="hs-identifier">StrictSig</span></a></a><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1645"></a><span>                  </span><span class="hs-keyword">deriving</span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1646"></a><span>
</span><a name="line-1647"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1648"></a><span>   </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a name="local-6989586621682209650"><a href="#local-6989586621682209650"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682209650"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1649"></a><span>
</span><a name="line-1650"></a><span class="hs-comment">-- Used for printing top-level strictness pragmas in interface files</span><span>
</span><a name="line-1651"></a><span class="hs-identifier">pprIfaceStrictSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1652"></a><a name="pprIfaceStrictSig"><a href="Demand.html#pprIfaceStrictSig"><span class="hs-identifier">pprIfaceStrictSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210028"><a href="#local-6989586621682210028"><span class="hs-identifier">dmds</span></a></a><span> </span><a name="local-6989586621682210029"><a href="#local-6989586621682210029"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1653"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hcat"><span class="hs-identifier hs-var">hcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682210028"><span class="hs-identifier hs-var">dmds</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682210029"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1654"></a><span>
</span><a name="line-1655"></a><span class="hs-identifier">mkStrictSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1656"></a><a name="mkStrictSig"><a href="Demand.html#mkStrictSig"><span class="hs-identifier">mkStrictSig</span></a></a><span> </span><a name="local-6989586621682210030"><a href="#local-6989586621682210030"><span class="hs-identifier">dmd_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a href="#local-6989586621682210030"><span class="hs-identifier hs-var">dmd_ty</span></a><span>
</span><a name="line-1657"></a><span>
</span><a name="line-1658"></a><span class="hs-identifier">mkClosedStrictSig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1659"></a><a name="mkClosedStrictSig"><a href="Demand.html#mkClosedStrictSig"><span class="hs-identifier">mkClosedStrictSig</span></a></a><span> </span><a name="local-6989586621682210031"><a href="#local-6989586621682210031"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682210032"><a href="#local-6989586621682210032"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkStrictSig"><span class="hs-identifier hs-var">mkStrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span> </span><a href="#local-6989586621682210031"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621682210032"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1660"></a><span>
</span><a name="line-1661"></a><span class="hs-identifier">splitStrictSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span class="hs-special">)</span><span>
</span><a name="line-1662"></a><a name="splitStrictSig"><a href="Demand.html#splitStrictSig"><span class="hs-identifier">splitStrictSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210033"><a href="#local-6989586621682210033"><span class="hs-identifier">dmds</span></a></a><span> </span><a name="local-6989586621682210034"><a href="#local-6989586621682210034"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210033"><span class="hs-identifier hs-var">dmds</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682210034"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1663"></a><span>
</span><a name="line-1664"></a><span class="hs-identifier">increaseStrictSigArity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1665"></a><span class="hs-comment">-- Add extra arguments to a strictness signature</span><span>
</span><a name="line-1666"></a><a name="increaseStrictSigArity"><a href="Demand.html#increaseStrictSigArity"><span class="hs-identifier">increaseStrictSigArity</span></a></a><span> </span><a name="local-6989586621682210035"><a href="#local-6989586621682210035"><span class="hs-identifier">arity_increase</span></a></a><span> </span><a name="local-6989586621682210036"><a href="#local-6989586621682210036"><span class="hs-identifier">sig</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a name="local-6989586621682210037"><a href="#local-6989586621682210037"><span class="hs-identifier">dmd_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210038"><a href="#local-6989586621682210038"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682210039"><a href="#local-6989586621682210039"><span class="hs-identifier">dmds</span></a></a><span> </span><a name="local-6989586621682210040"><a href="#local-6989586621682210040"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1667"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Demand.html#isTopDmdType"><span class="hs-identifier hs-var">isTopDmdType</span></a><span> </span><a href="#local-6989586621682210037"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210036"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1668"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682210035"><span class="hs-identifier hs-var">arity_increase</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210036"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1669"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682210038"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682210041"><span class="hs-identifier hs-var">dmds'</span></a><span> </span><a href="#local-6989586621682210040"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1670"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1671"></a><span>    </span><a name="local-6989586621682210041"><a href="#local-6989586621682210041"><span class="hs-identifier">dmds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621682210035"><span class="hs-identifier hs-var">arity_increase</span></a><span> </span><a href="Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621682210039"><span class="hs-identifier hs-var">dmds</span></a><span>
</span><a name="line-1672"></a><span>
</span><a name="line-1673"></a><span class="hs-identifier">etaExpandStrictSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1674"></a><span class="hs-comment">-- We are expanding (\x y. e) to (\x y z. e z)</span><span>
</span><a name="line-1675"></a><span class="hs-comment">-- Add exta demands to the /end/ of the arg demands if necessary</span><span>
</span><a name="line-1676"></a><a name="etaExpandStrictSig"><a href="Demand.html#etaExpandStrictSig"><span class="hs-identifier">etaExpandStrictSig</span></a></a><span> </span><a name="local-6989586621682210042"><a href="#local-6989586621682210042"><span class="hs-identifier">arity</span></a></a><span> </span><a name="local-6989586621682210043"><a href="#local-6989586621682210043"><span class="hs-identifier">sig</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a name="local-6989586621682210044"><a href="#local-6989586621682210044"><span class="hs-identifier">dmd_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210045"><a href="#local-6989586621682210045"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682210046"><a href="#local-6989586621682210046"><span class="hs-identifier">dmds</span></a></a><span> </span><a name="local-6989586621682210047"><a href="#local-6989586621682210047"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1677"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Demand.html#isTopDmdType"><span class="hs-identifier hs-var">isTopDmdType</span></a><span> </span><a href="#local-6989586621682210044"><span class="hs-identifier hs-var">dmd_ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210043"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1678"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682210048"><span class="hs-identifier hs-var">arity_increase</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210043"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1679"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682210045"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621682210049"><span class="hs-identifier hs-var">dmds'</span></a><span> </span><a href="#local-6989586621682210047"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span>
</span><a name="line-1680"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1681"></a><span>    </span><a name="local-6989586621682210048"><a href="#local-6989586621682210048"><span class="hs-identifier">arity_increase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210042"><span class="hs-identifier hs-var">arity</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682210046"><span class="hs-identifier hs-var">dmds</span></a><span>
</span><a name="line-1682"></a><span>    </span><a name="local-6989586621682210049"><a href="#local-6989586621682210049"><span class="hs-identifier">dmds'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210046"><span class="hs-identifier hs-var">dmds</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621682210048"><span class="hs-identifier hs-var">arity_increase</span></a><span> </span><a href="Demand.html#topDmd"><span class="hs-identifier hs-var">topDmd</span></a><span>
</span><a name="line-1683"></a><span>
</span><a name="line-1684"></a><span class="hs-identifier">isTopSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1685"></a><a name="isTopSig"><a href="Demand.html#isTopSig"><span class="hs-identifier">isTopSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a name="local-6989586621682210050"><a href="#local-6989586621682210050"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#isTopDmdType"><span class="hs-identifier hs-var">isTopDmdType</span></a><span> </span><a href="#local-6989586621682210050"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1686"></a><span>
</span><a name="line-1687"></a><span class="hs-identifier">hasDemandEnvSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1688"></a><a name="hasDemandEnvSig"><a href="Demand.html#hasDemandEnvSig"><span class="hs-identifier">hasDemandEnvSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210051"><a href="#local-6989586621682210051"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621682210051"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span>
</span><a name="line-1689"></a><span>
</span><a name="line-1690"></a><span class="hs-identifier">strictSigDmdEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdEnv"><span class="hs-identifier hs-type">DmdEnv</span></a><span>
</span><a name="line-1691"></a><a name="strictSigDmdEnv"><a href="Demand.html#strictSigDmdEnv"><span class="hs-identifier">strictSigDmdEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210052"><a href="#local-6989586621682210052"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210052"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-1692"></a><span>
</span><a name="line-1693"></a><span class="hs-identifier">isBottomingSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1694"></a><span class="hs-comment">-- True if the signature diverges or throws an exception</span><span>
</span><a name="line-1695"></a><a name="isBottomingSig"><a href="Demand.html#isBottomingSig"><span class="hs-identifier">isBottomingSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210053"><a href="#local-6989586621682210053"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#isBotRes"><span class="hs-identifier hs-var">isBotRes</span></a><span> </span><a href="#local-6989586621682210053"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1696"></a><span>
</span><a name="line-1697"></a><span class="hs-identifier">nopSig</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">botSig</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exnSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1698"></a><a name="nopSig"><a href="Demand.html#nopSig"><span class="hs-identifier">nopSig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a href="Demand.html#nopDmdType"><span class="hs-identifier hs-var">nopDmdType</span></a><span>
</span><a name="line-1699"></a><a name="botSig"><a href="Demand.html#botSig"><span class="hs-identifier">botSig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a href="Demand.html#botDmdType"><span class="hs-identifier hs-var">botDmdType</span></a><span>
</span><a name="line-1700"></a><a name="exnSig"><a href="Demand.html#exnSig"><span class="hs-identifier">exnSig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a href="Demand.html#exnDmdType"><span class="hs-identifier hs-var">exnDmdType</span></a><span>
</span><a name="line-1701"></a><span>
</span><a name="line-1702"></a><span class="hs-identifier">cprProdSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1703"></a><a name="cprProdSig"><a href="Demand.html#cprProdSig"><span class="hs-identifier">cprProdSig</span></a></a><span> </span><a name="local-6989586621682210054"><a href="#local-6989586621682210054"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#cprProdDmdType"><span class="hs-identifier hs-var">cprProdDmdType</span></a><span> </span><a href="#local-6989586621682210054"><span class="hs-identifier hs-var">arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-1704"></a><span>
</span><a name="line-1705"></a><span class="hs-identifier">seqStrictSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1706"></a><a name="seqStrictSig"><a href="Demand.html#seqStrictSig"><span class="hs-identifier">seqStrictSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a name="local-6989586621682210055"><a href="#local-6989586621682210055"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#seqDmdType"><span class="hs-identifier hs-var">seqDmdType</span></a><span> </span><a href="#local-6989586621682210055"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1707"></a><span>
</span><a name="line-1708"></a><span class="hs-identifier">dmdTransformSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1709"></a><span class="hs-comment">-- (dmdTransformSig fun_sig dmd) considers a call to a function whose</span><span>
</span><a name="line-1710"></a><span class="hs-comment">-- signature is fun_sig, with demand dmd.  We return the demand</span><span>
</span><a name="line-1711"></a><span class="hs-comment">-- that the function places on its context (eg its args)</span><span>
</span><a name="line-1712"></a><a name="dmdTransformSig"><a href="Demand.html#dmdTransformSig"><span class="hs-identifier">dmdTransformSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a name="local-6989586621682210056"><a href="#local-6989586621682210056"><span class="hs-identifier">dmd_ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210057"><a href="#local-6989586621682210057"><span class="hs-identifier">arg_ds</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682210058"><a href="#local-6989586621682210058"><span class="hs-identifier">cd</span></a></a><span>
</span><a name="line-1713"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#postProcessUnsat"><span class="hs-identifier hs-var">postProcessUnsat</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#peelManyCalls"><span class="hs-identifier hs-var">peelManyCalls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682210057"><span class="hs-identifier hs-var">arg_ds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210058"><span class="hs-identifier hs-var">cd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210056"><span class="hs-identifier hs-var">dmd_ty</span></a><span>
</span><a name="line-1714"></a><span>    </span><span class="hs-comment">-- see Note [Demands from unsaturated function calls]</span><span>
</span><a name="line-1715"></a><span>
</span><a name="line-1716"></a><span class="hs-identifier">dmdTransformDataConSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1717"></a><span class="hs-comment">-- Same as dmdTransformSig but for a data constructor (worker),</span><span>
</span><a name="line-1718"></a><span class="hs-comment">-- which has a special kind of demand transformer.</span><span>
</span><a name="line-1719"></a><span class="hs-comment">-- If the constructor is saturated, we feed the demand on</span><span>
</span><a name="line-1720"></a><span class="hs-comment">-- the result into the constructor arguments.</span><span>
</span><a name="line-1721"></a><a name="dmdTransformDataConSig"><a href="Demand.html#dmdTransformDataConSig"><span class="hs-identifier">dmdTransformDataConSig</span></a></a><span> </span><a name="local-6989586621682210059"><a href="#local-6989586621682210059"><span class="hs-identifier">arity</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210060"><a href="#local-6989586621682210060"><span class="hs-identifier">con_res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1722"></a><span>                             </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210061"><a href="#local-6989586621682210061"><span class="hs-identifier">str</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210062"><a href="#local-6989586621682210062"><span class="hs-identifier">abs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1723"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682210072"><a href="#local-6989586621682210072"><span class="hs-identifier">str_dmds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682210063"><span class="hs-identifier hs-var">go_str</span></a><span> </span><a href="#local-6989586621682210059"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682210061"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-1724"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682210073"><a href="#local-6989586621682210073"><span class="hs-identifier">abs_dmds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682210064"><span class="hs-identifier hs-var">go_abs</span></a><span> </span><a href="#local-6989586621682210059"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682210062"><span class="hs-identifier hs-var">abs</span></a><span>
</span><a name="line-1725"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#mkJointDmds"><span class="hs-identifier hs-var">mkJointDmds</span></a><span> </span><a href="#local-6989586621682210072"><span class="hs-identifier hs-var">str_dmds</span></a><span> </span><a href="#local-6989586621682210073"><span class="hs-identifier hs-var">abs_dmds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210060"><span class="hs-identifier hs-var">con_res</span></a><span>
</span><a name="line-1726"></a><span>                </span><span class="hs-comment">-- Must remember whether it's a product, hence con_res, not TopRes</span><span>
</span><a name="line-1727"></a><span>
</span><a name="line-1728"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-comment">-- Not saturated</span><span>
</span><a name="line-1729"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#nopDmdType"><span class="hs-identifier hs-var">nopDmdType</span></a><span>
</span><a name="line-1730"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1731"></a><span>    </span><a name="local-6989586621682210063"><a href="#local-6989586621682210063"><span class="hs-identifier">go_str</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621682210065"><a href="#local-6989586621682210065"><span class="hs-identifier">dmd</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#splitStrProdDmd"><span class="hs-identifier hs-var">splitStrProdDmd</span></a><span> </span><a href="#local-6989586621682210059"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682210065"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1732"></a><span>    </span><span class="hs-identifier">go_str</span><span> </span><a name="local-6989586621682210066"><a href="#local-6989586621682210066"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682210067"><a href="#local-6989586621682210067"><span class="hs-identifier">s'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210063"><span class="hs-identifier hs-var">go_str</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210066"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210067"><span class="hs-identifier hs-var">s'</span></a><span>
</span><a name="line-1733"></a><span>    </span><span class="hs-identifier">go_str</span><span> </span><a name="local-6989586621682210068"><a href="#local-6989586621682210068"><span class="hs-identifier">n</span></a></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210063"><span class="hs-identifier hs-var">go_str</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210068"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-1734"></a><span>    </span><span class="hs-identifier">go_str</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1735"></a><span>
</span><a name="line-1736"></a><span>    </span><a name="local-6989586621682210064"><a href="#local-6989586621682210064"><span class="hs-identifier">go_abs</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621682210069"><a href="#local-6989586621682210069"><span class="hs-identifier">dmd</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#splitUseProdDmd"><span class="hs-identifier hs-var">splitUseProdDmd</span></a><span> </span><a href="#local-6989586621682210059"><span class="hs-identifier hs-var">arity</span></a><span> </span><a href="#local-6989586621682210069"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1737"></a><span>    </span><span class="hs-identifier">go_abs</span><span> </span><a name="local-6989586621682210070"><a href="#local-6989586621682210070"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a name="local-6989586621682210071"><a href="#local-6989586621682210071"><span class="hs-identifier">u'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210064"><span class="hs-identifier hs-var">go_abs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210070"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210071"><span class="hs-identifier hs-var">u'</span></a><span>
</span><a name="line-1738"></a><span>    </span><span class="hs-identifier">go_abs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1739"></a><span>
</span><a name="line-1740"></a><span class="hs-identifier">dmdTransformDictSelSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#CleanDemand"><span class="hs-identifier hs-type">CleanDemand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span>
</span><a name="line-1741"></a><span class="hs-comment">-- Like dmdTransformDataConSig, we have a special demand transformer</span><span>
</span><a name="line-1742"></a><span class="hs-comment">-- for dictionary selectors.  If the selector is saturated (ie has one</span><span>
</span><a name="line-1743"></a><span class="hs-comment">-- argument: the dictionary), we feed the demand on the result into</span><span>
</span><a name="line-1744"></a><span class="hs-comment">-- the indicated dictionary component.</span><span>
</span><a name="line-1745"></a><a name="dmdTransformDictSelSig"><a href="Demand.html#dmdTransformDictSelSig"><span class="hs-identifier">dmdTransformDictSelSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><a name="local-6989586621682210074"><a href="#local-6989586621682210074"><span class="hs-identifier">dict_dmd</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682210075"><a href="#local-6989586621682210075"><span class="hs-identifier">cd</span></a></a><span>
</span><a name="line-1746"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682210079"><a href="#local-6989586621682210079"><span class="hs-identifier">cd'</span></a></a><span class="hs-special">,</span><a name="local-6989586621682210080"><a href="#local-6989586621682210080"><span class="hs-identifier">defer_use</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Demand.html#peelCallDmd"><span class="hs-identifier hs-var">peelCallDmd</span></a><span> </span><a href="#local-6989586621682210075"><span class="hs-identifier hs-var">cd</span></a><span>
</span><a name="line-1747"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682210081"><a href="#local-6989586621682210081"><span class="hs-identifier">jds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Demand.html#splitProdDmd_maybe"><span class="hs-identifier hs-var">splitProdDmd_maybe</span></a><span> </span><a href="#local-6989586621682210074"><span class="hs-identifier hs-var">dict_dmd</span></a><span>
</span><a name="line-1748"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#postProcessUnsat"><span class="hs-identifier hs-var">postProcessUnsat</span></a><span> </span><a href="#local-6989586621682210080"><span class="hs-identifier hs-var">defer_use</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1749"></a><span>     </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span> </span><span class="hs-special">[</span><a href="Demand.html#mkOnceUsedDmd"><span class="hs-identifier hs-var">mkOnceUsedDmd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#mkProdDmd"><span class="hs-identifier hs-var">mkProdDmd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210076"><span class="hs-identifier hs-var">enhance</span></a><span> </span><a href="#local-6989586621682210079"><span class="hs-identifier hs-var">cd'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210081"><span class="hs-identifier hs-var">jds</span></a><span class="hs-special">]</span><span> </span><a href="Demand.html#topRes"><span class="hs-identifier hs-var">topRes</span></a><span>
</span><a name="line-1750"></a><span>   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1751"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#nopDmdType"><span class="hs-identifier hs-var">nopDmdType</span></a><span>              </span><span class="hs-comment">-- See Note [Demand transformer for a dictionary selector]</span><span>
</span><a name="line-1752"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1753"></a><span>    </span><a name="local-6989586621682210076"><a href="#local-6989586621682210076"><span class="hs-identifier">enhance</span></a></a><span> </span><a name="local-6989586621682210077"><a href="#local-6989586621682210077"><span class="hs-identifier">cd</span></a></a><span> </span><a name="local-6989586621682210078"><a href="#local-6989586621682210078"><span class="hs-identifier">old</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Demand.html#isAbsDmd"><span class="hs-identifier hs-var">isAbsDmd</span></a><span> </span><a href="#local-6989586621682210078"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210078"><span class="hs-identifier hs-var">old</span></a><span>
</span><a name="line-1754"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkOnceUsedDmd"><span class="hs-identifier hs-var">mkOnceUsedDmd</span></a><span> </span><a href="#local-6989586621682210077"><span class="hs-identifier hs-var">cd</span></a><span>  </span><span class="hs-comment">-- This is the one!</span><span>
</span><a name="line-1755"></a><span>
</span><a name="line-1756"></a><span class="hs-identifier">dmdTransformDictSelSig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;dmdTransformDictSelSig: no args&quot;</span><span>
</span><a name="line-1757"></a><span>
</span><a name="line-1758"></a><span class="hs-comment">{-
Note [Demand transformer for a dictionary selector]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we evaluate (op dict-expr) under demand 'd', then we can push the demand 'd'
into the appropriate field of the dictionary. What *is* the appropriate field?
We just look at the strictness signature of the class op, which will be
something like: U(AAASAAAAA).  Then replace the 'S' by the demand 'd'.

For single-method classes, which are represented by newtypes the signature
of 'op' won't look like U(...), so the splitProdDmd_maybe will fail.
That's fine: if we are doing strictness analysis we are also doing inlining,
so we'll have inlined 'op' into a cast.  So we can bale out in a conservative
way, returning nopDmdType.

It is (just.. Trac #8329) possible to be running strictness analysis *without*
having inlined class ops from single-method classes.  Suppose you are using
ghc --make; and the first module has a local -O0 flag.  So you may load a class
without interface pragmas, ie (currently) without an unfolding for the class
ops.   Now if a subsequent module in the --make sweep has a local -O flag
you might do strictness analysis, but there is no inlining for the class op.
This is weird, so I'm not worried about whether this optimises brilliantly; but
it should not fall over.
-}</span><span>
</span><a name="line-1781"></a><span>
</span><a name="line-1782"></a><span class="hs-identifier">argsOneShots</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><a href="BasicTypes.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-1783"></a><span class="hs-comment">-- See Note [Computing one-shot info]</span><span>
</span><a name="line-1784"></a><a name="argsOneShots"><a href="Demand.html#argsOneShots"><span class="hs-identifier">argsOneShots</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210082"><a href="#local-6989586621682210082"><span class="hs-identifier">arg_ds</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682210083"><a href="#local-6989586621682210083"><span class="hs-identifier">n_val_args</span></a></a><span>
</span><a name="line-1785"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682210084"><span class="hs-identifier hs-var">unsaturated_call</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1786"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210085"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682210082"><span class="hs-identifier hs-var">arg_ds</span></a><span>
</span><a name="line-1787"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1788"></a><span>    </span><a name="local-6989586621682210084"><a href="#local-6989586621682210084"><span class="hs-identifier">unsaturated_call</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210082"><span class="hs-identifier hs-var">arg_ds</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthExceeds"><span class="hs-identifier hs-var">lengthExceeds</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682210083"><span class="hs-identifier hs-var">n_val_args</span></a><span>
</span><a name="line-1789"></a><span>
</span><a name="line-1790"></a><span>    </span><a name="local-6989586621682210085"><a href="#local-6989586621682210085"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1791"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682210087"><a href="#local-6989586621682210087"><span class="hs-identifier">arg_d</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682210088"><a href="#local-6989586621682210088"><span class="hs-identifier">arg_ds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#argOneShots"><span class="hs-identifier hs-var">argOneShots</span></a><span> </span><a href="#local-6989586621682210087"><span class="hs-identifier hs-var">arg_d</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682210086"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682210085"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682210088"><span class="hs-identifier hs-var">arg_ds</span></a><span>
</span><a name="line-1792"></a><span>
</span><a name="line-1793"></a><span>    </span><span class="hs-comment">-- Avoid list tail like [ [], [], [] ]</span><span>
</span><a name="line-1794"></a><span>    </span><a name="local-6989586621682210086"><a href="#local-6989586621682210086"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1795"></a><span>    </span><span class="hs-identifier">cons</span><span> </span><a name="local-6989586621682210089"><a href="#local-6989586621682210089"><span class="hs-identifier">a</span></a></a><span>  </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210089"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span>
</span><a name="line-1796"></a><span>
</span><a name="line-1797"></a><span class="hs-comment">-- saturatedByOneShots n C1(C1(...)) = True,</span><span>
</span><a name="line-1798"></a><span class="hs-comment">--   &lt;=&gt;</span><span>
</span><a name="line-1799"></a><span class="hs-comment">-- there are at least n nested C1(..) calls</span><span>
</span><a name="line-1800"></a><span class="hs-comment">-- See Note [Demand on the worker] in WorkWrap</span><span>
</span><a name="line-1801"></a><span class="hs-identifier">saturatedByOneShots</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1802"></a><a name="saturatedByOneShots"><a href="Demand.html#saturatedByOneShots"><span class="hs-identifier">saturatedByOneShots</span></a></a><span> </span><a name="local-6989586621682210091"><a href="#local-6989586621682210091"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210092"><a href="#local-6989586621682210092"><span class="hs-identifier">usg</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1803"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682210092"><span class="hs-identifier hs-var">usg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1804"></a><span>      </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210096"><a href="#local-6989586621682210096"><span class="hs-identifier">arg_usg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682210093"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682210091"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682210096"><span class="hs-identifier hs-var">arg_usg</span></a><span>
</span><a name="line-1805"></a><span>      </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1806"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1807"></a><span>    </span><a name="local-6989586621682210093"><a href="#local-6989586621682210093"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1808"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682210094"><a href="#local-6989586621682210094"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span> </span><a name="local-6989586621682210095"><a href="#local-6989586621682210095"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210093"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682210094"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210095"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-1809"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1810"></a><span>
</span><a name="line-1811"></a><span class="hs-identifier">argOneShots</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>          </span><span class="hs-comment">-- depending on saturation</span><span>
</span><a name="line-1812"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="BasicTypes.html#OneShotInfo"><span class="hs-identifier hs-type">OneShotInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-1813"></a><a name="argOneShots"><a href="Demand.html#argOneShots"><span class="hs-identifier">argOneShots</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210097"><a href="#local-6989586621682210097"><span class="hs-identifier">usg</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1814"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682210097"><span class="hs-identifier hs-var">usg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1815"></a><span>      </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210101"><a href="#local-6989586621682210101"><span class="hs-identifier">arg_usg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682210098"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682210101"><span class="hs-identifier hs-var">arg_usg</span></a><span>
</span><a name="line-1816"></a><span>      </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1817"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1818"></a><span>    </span><a name="local-6989586621682210098"><a href="#local-6989586621682210098"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>  </span><a name="local-6989586621682210099"><a href="#local-6989586621682210099"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#OneShotLam"><span class="hs-identifier hs-var">OneShotLam</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682210098"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682210099"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-1819"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><a name="local-6989586621682210100"><a href="#local-6989586621682210100"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#NoOneShotInfo"><span class="hs-identifier hs-var">NoOneShotInfo</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621682210098"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682210100"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-1820"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1821"></a><span>
</span><a name="line-1822"></a><span class="hs-comment">{- Note [Computing one-shot info]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider a call
    f (\pqr. e1) (\xyz. e2) e3
where f has usage signature
    C1(C(C1(U))) C1(U) U
Then argsOneShots returns a [[OneShotInfo]] of
    [[OneShot,NoOneShotInfo,OneShot],  [OneShot]]
The occurrence analyser propagates this one-shot infor to the
binders \pqr and \xyz; see Note [Use one-shot information] in OccurAnal.
-}</span><span>
</span><a name="line-1833"></a><span>
</span><a name="line-1834"></a><span class="hs-comment">-- appIsBottom returns true if an application to n args</span><span>
</span><a name="line-1835"></a><span class="hs-comment">-- would diverge or throw an exception</span><span>
</span><a name="line-1836"></a><span class="hs-comment">-- See Note [Unsaturated applications]</span><span>
</span><a name="line-1837"></a><span class="hs-identifier">appIsBottom</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1838"></a><a name="appIsBottom"><a href="Demand.html#appIsBottom"><span class="hs-identifier">appIsBottom</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210102"><a href="#local-6989586621682210102"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682210103"><a href="#local-6989586621682210103"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682210104"><a href="#local-6989586621682210104"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-1839"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="Demand.html#isBotRes"><span class="hs-identifier hs-var">isBotRes</span></a><span> </span><a href="#local-6989586621682210103"><span class="hs-identifier hs-var">res</span></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Util.html#lengthExceeds"><span class="hs-identifier hs-var">lengthExceeds</span></a><span> </span><a href="#local-6989586621682210102"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621682210104"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1840"></a><span class="hs-identifier">appIsBottom</span><span> </span><span class="hs-identifier">_</span><span>                              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1841"></a><span>
</span><a name="line-1842"></a><span class="hs-comment">{-
Note [Unsaturated applications]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If a function having bottom as its demand result is applied to a less
number of arguments than its syntactic arity, we cannot say for sure
that it is going to diverge. This is the reason why we use the
function appIsBottom, which, given a strictness signature and a number
of arguments, says conservatively if the function is going to diverge
or not.

Zap absence or one-shot information, under control of flags

Note [Killing usage information]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The flags -fkill-one-shot and -fkill-absence let you switch off the generation
of absence or one-shot information altogether.  This is only used for performance
tests, to see how important they are.
-}</span><span>
</span><a name="line-1860"></a><span>
</span><a name="line-1861"></a><span class="hs-identifier">zapUsageEnvSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1862"></a><span class="hs-comment">-- Remove the usage environment from the demand</span><span>
</span><a name="line-1863"></a><a name="zapUsageEnvSig"><a href="Demand.html#zapUsageEnvSig"><span class="hs-identifier">zapUsageEnvSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682210105"><a href="#local-6989586621682210105"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682210106"><a href="#local-6989586621682210106"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#mkClosedStrictSig"><span class="hs-identifier hs-var">mkClosedStrictSig</span></a><span> </span><a href="#local-6989586621682210105"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621682210106"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1864"></a><span>
</span><a name="line-1865"></a><span class="hs-identifier">zapUsageDemand</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1866"></a><span class="hs-comment">-- Remove the usage info, but not the strictness info, from the demand</span><span>
</span><a name="line-1867"></a><a name="zapUsageDemand"><a href="Demand.html#zapUsageDemand"><span class="hs-identifier">zapUsageDemand</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#kill_usage"><span class="hs-identifier hs-var">kill_usage</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#KillFlags"><span class="hs-identifier hs-var">KillFlags</span></a><span>
</span><a name="line-1868"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">kf_abs</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1869"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kf_used_once</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1870"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kf_called_once</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1871"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1872"></a><span>
</span><a name="line-1873"></a><span class="hs-comment">-- | Remove all 1* information (but not C1 information) from the demand</span><span>
</span><a name="line-1874"></a><span class="hs-identifier">zapUsedOnceDemand</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1875"></a><a name="zapUsedOnceDemand"><a href="Demand.html#zapUsedOnceDemand"><span class="hs-identifier">zapUsedOnceDemand</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#kill_usage"><span class="hs-identifier hs-var">kill_usage</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#KillFlags"><span class="hs-identifier hs-var">KillFlags</span></a><span>
</span><a name="line-1876"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">kf_abs</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1877"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kf_used_once</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1878"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">kf_called_once</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1879"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1880"></a><span>
</span><a name="line-1881"></a><span class="hs-comment">-- | Remove all 1* information (but not C1 information) from the strictness</span><span>
</span><a name="line-1882"></a><span class="hs-comment">--   signature</span><span>
</span><a name="line-1883"></a><span class="hs-identifier">zapUsedOnceSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1884"></a><a name="zapUsedOnceSig"><a href="Demand.html#zapUsedOnceSig"><span class="hs-identifier">zapUsedOnceSig</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210107"><a href="#local-6989586621682210107"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682210108"><a href="#local-6989586621682210108"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682210109"><a href="#local-6989586621682210109"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1885"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682210107"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Demand.html#zapUsedOnceDemand"><span class="hs-identifier hs-var">zapUsedOnceDemand</span></a><span> </span><a href="#local-6989586621682210108"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210109"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1886"></a><span>
</span><a name="line-1887"></a><span class="hs-identifier">killUsageDemand</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1888"></a><span class="hs-comment">-- See Note [Killing usage information]</span><span>
</span><a name="line-1889"></a><a name="killUsageDemand"><a href="Demand.html#killUsageDemand"><span class="hs-identifier">killUsageDemand</span></a></a><span> </span><a name="local-6989586621682210110"><a href="#local-6989586621682210110"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682210111"><a href="#local-6989586621682210111"><span class="hs-identifier">dmd</span></a></a><span>
</span><a name="line-1890"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682210112"><a href="#local-6989586621682210112"><span class="hs-identifier">kfs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Demand.html#killFlags"><span class="hs-identifier hs-var">killFlags</span></a><span> </span><a href="#local-6989586621682210110"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#kill_usage"><span class="hs-identifier hs-var">kill_usage</span></a><span> </span><a href="#local-6989586621682210112"><span class="hs-identifier hs-var">kfs</span></a><span> </span><a href="#local-6989586621682210111"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1891"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210111"><span class="hs-identifier hs-var">dmd</span></a><span>
</span><a name="line-1892"></a><span>
</span><a name="line-1893"></a><span class="hs-identifier">killUsageSig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span>
</span><a name="line-1894"></a><span class="hs-comment">-- See Note [Killing usage information]</span><span>
</span><a name="line-1895"></a><a name="killUsageSig"><a href="Demand.html#killUsageSig"><span class="hs-identifier">killUsageSig</span></a></a><span> </span><a name="local-6989586621682210113"><a href="#local-6989586621682210113"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682210114"><a href="#local-6989586621682210114"><span class="hs-identifier">sig</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a name="local-6989586621682210115"><a href="#local-6989586621682210115"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621682210116"><a href="#local-6989586621682210116"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682210117"><a href="#local-6989586621682210117"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1896"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682210118"><a href="#local-6989586621682210118"><span class="hs-identifier">kfs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Demand.html#killFlags"><span class="hs-identifier hs-var">killFlags</span></a><span> </span><a href="#local-6989586621682210113"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="#local-6989586621682210115"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Demand.html#kill_usage"><span class="hs-identifier hs-var">kill_usage</span></a><span> </span><a href="#local-6989586621682210118"><span class="hs-identifier hs-var">kfs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210116"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210117"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-1897"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210114"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-1898"></a><span>
</span><a name="line-1899"></a><span class="hs-keyword">data</span><span> </span><a name="KillFlags"><a href="Demand.html#KillFlags"><span class="hs-identifier">KillFlags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="KillFlags"><a href="Demand.html#KillFlags"><span class="hs-identifier">KillFlags</span></a></a><span>
</span><a name="line-1900"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="kf_abs"><a href="Demand.html#kf_abs"><span class="hs-identifier">kf_abs</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1901"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="kf_used_once"><a href="Demand.html#kf_used_once"><span class="hs-identifier">kf_used_once</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1902"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="kf_called_once"><a href="Demand.html#kf_called_once"><span class="hs-identifier">kf_called_once</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1903"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1904"></a><span>
</span><a name="line-1905"></a><span class="hs-identifier">killFlags</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Demand.html#KillFlags"><span class="hs-identifier hs-type">KillFlags</span></a><span>
</span><a name="line-1906"></a><span class="hs-comment">-- See Note [Killing usage information]</span><span>
</span><a name="line-1907"></a><a name="killFlags"><a href="Demand.html#killFlags"><span class="hs-identifier">killFlags</span></a></a><span> </span><a name="local-6989586621682210119"><a href="#local-6989586621682210119"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1908"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682210120"><span class="hs-identifier hs-var">kf_abs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621682210121"><span class="hs-identifier hs-var">kf_used_once</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1909"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Demand.html#KillFlags"><span class="hs-identifier hs-var">KillFlags</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1910"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1911"></a><span>    </span><a name="local-6989586621682210120"><a href="#local-6989586621682210120"><span class="hs-identifier">kf_abs</span></a></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_KillAbsence"><span class="hs-identifier hs-var">Opt_KillAbsence</span></a><span> </span><a href="#local-6989586621682210119"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1912"></a><span>    </span><a name="local-6989586621682210121"><a href="#local-6989586621682210121"><span class="hs-identifier">kf_used_once</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_KillOneShot"><span class="hs-identifier hs-var">Opt_KillOneShot</span></a><span> </span><a href="#local-6989586621682210119"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1913"></a><span>    </span><a name="local-6989586621682210122"><a href="#local-6989586621682210122"><span class="hs-identifier">kf_called_once</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210121"><span class="hs-identifier hs-var">kf_used_once</span></a><span>
</span><a name="line-1914"></a><span>
</span><a name="line-1915"></a><span class="hs-identifier">kill_usage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#KillFlags"><span class="hs-identifier hs-type">KillFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1916"></a><a name="kill_usage"><a href="Demand.html#kill_usage"><span class="hs-identifier">kill_usage</span></a></a><span> </span><a name="local-6989586621682210123"><a href="#local-6989586621682210123"><span class="hs-identifier">kfs</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210124"><a href="#local-6989586621682210124"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210125"><a href="#local-6989586621682210125"><span class="hs-identifier">u</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210124"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#zap_musg"><span class="hs-identifier hs-var">zap_musg</span></a><span> </span><a href="#local-6989586621682210123"><span class="hs-identifier hs-var">kfs</span></a><span> </span><a href="#local-6989586621682210125"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">}</span><span>
</span><a name="line-1917"></a><span>
</span><a name="line-1918"></a><span class="hs-identifier">zap_musg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#KillFlags"><span class="hs-identifier hs-type">KillFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span>
</span><a name="line-1919"></a><a name="zap_musg"><a href="Demand.html#zap_musg"><span class="hs-identifier">zap_musg</span></a></a><span> </span><a name="local-6989586621682210126"><a href="#local-6989586621682210126"><span class="hs-identifier">kfs</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>
</span><a name="line-1920"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">kf_abs</span><span> </span><a href="#local-6989586621682210126"><span class="hs-identifier hs-var">kfs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#useTop"><span class="hs-identifier hs-var">useTop</span></a><span>
</span><a name="line-1921"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>
</span><a name="line-1922"></a><span class="hs-identifier">zap_musg</span><span> </span><a name="local-6989586621682210127"><a href="#local-6989586621682210127"><span class="hs-identifier">kfs</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a name="local-6989586621682210128"><a href="#local-6989586621682210128"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682210129"><a href="#local-6989586621682210129"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1923"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">kf_used_once</span><span> </span><a href="#local-6989586621682210127"><span class="hs-identifier hs-var">kfs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#zap_usg"><span class="hs-identifier hs-var">zap_usg</span></a><span> </span><a href="#local-6989586621682210127"><span class="hs-identifier hs-var">kfs</span></a><span> </span><a href="#local-6989586621682210129"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-1924"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="#local-6989586621682210128"><span class="hs-identifier hs-var">c</span></a><span>    </span><span class="hs-special">(</span><a href="Demand.html#zap_usg"><span class="hs-identifier hs-var">zap_usg</span></a><span> </span><a href="#local-6989586621682210127"><span class="hs-identifier hs-var">kfs</span></a><span> </span><a href="#local-6989586621682210129"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-1925"></a><span>
</span><a name="line-1926"></a><span class="hs-identifier">zap_usg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#KillFlags"><span class="hs-identifier hs-type">KillFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span>
</span><a name="line-1927"></a><a name="zap_usg"><a href="Demand.html#zap_usg"><span class="hs-identifier">zap_usg</span></a></a><span> </span><a name="local-6989586621682210130"><a href="#local-6989586621682210130"><span class="hs-identifier">kfs</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682210131"><a href="#local-6989586621682210131"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682210132"><a href="#local-6989586621682210132"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1928"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">kf_called_once</span><span> </span><a href="#local-6989586621682210130"><span class="hs-identifier hs-var">kfs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#zap_usg"><span class="hs-identifier hs-var">zap_usg</span></a><span> </span><a href="#local-6989586621682210130"><span class="hs-identifier hs-var">kfs</span></a><span> </span><a href="#local-6989586621682210132"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-1929"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="#local-6989586621682210131"><span class="hs-identifier hs-var">c</span></a><span>    </span><span class="hs-special">(</span><a href="Demand.html#zap_usg"><span class="hs-identifier hs-var">zap_usg</span></a><span> </span><a href="#local-6989586621682210130"><span class="hs-identifier hs-var">kfs</span></a><span> </span><a href="#local-6989586621682210132"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-1930"></a><span class="hs-identifier">zap_usg</span><span> </span><a name="local-6989586621682210133"><a href="#local-6989586621682210133"><span class="hs-identifier">kfs</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682210134"><a href="#local-6989586621682210134"><span class="hs-identifier">us</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Demand.html#zap_musg"><span class="hs-identifier hs-var">zap_musg</span></a><span> </span><a href="#local-6989586621682210133"><span class="hs-identifier hs-var">kfs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210134"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-1931"></a><span class="hs-identifier">zap_usg</span><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621682210135"><a href="#local-6989586621682210135"><span class="hs-identifier">u</span></a></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210135"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-1932"></a><span>
</span><a name="line-1933"></a><span class="hs-comment">-- If the argument is a used non-newtype dictionary, give it strict</span><span>
</span><a name="line-1934"></a><span class="hs-comment">-- demand. Also split the product type &amp; demand and recur in order to</span><span>
</span><a name="line-1935"></a><span class="hs-comment">-- similarly strictify the argument's contained used non-newtype</span><span>
</span><a name="line-1936"></a><span class="hs-comment">-- superclass dictionaries. We use the demand as our recursive measure</span><span>
</span><a name="line-1937"></a><span class="hs-comment">-- to guarantee termination.</span><span>
</span><a name="line-1938"></a><span class="hs-identifier">strictifyDictDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1939"></a><a name="strictifyDictDmd"><a href="Demand.html#strictifyDictDmd"><span class="hs-identifier">strictifyDictDmd</span></a></a><span> </span><a name="local-6989586621682210136"><a href="#local-6989586621682210136"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682210137"><a href="#local-6989586621682210137"><span class="hs-identifier">dmd</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Demand.html#getUseDmd"><span class="hs-identifier hs-var">getUseDmd</span></a><span> </span><a href="#local-6989586621682210137"><span class="hs-identifier hs-var">dmd</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1940"></a><span>  </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a name="local-6989586621682210138"><a href="#local-6989586621682210138"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span>
</span><a name="line-1941"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682210139"><a href="#local-6989586621682210139"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682210140"><a href="#local-6989586621682210140"><span class="hs-identifier">_arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682210141"><a href="#local-6989586621682210141"><span class="hs-identifier">_data_con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682210142"><a href="#local-6989586621682210142"><span class="hs-identifier">inst_con_arg_tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1942"></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DataCon.html#splitDataProductType_maybe"><span class="hs-identifier hs-var">splitDataProductType_maybe</span></a><span> </span><a href="#local-6989586621682210136"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span>
</span><a name="line-1943"></a><span>    </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isNewTyCon"><span class="hs-identifier hs-var">isNewTyCon</span></a><span> </span><a href="#local-6989586621682210139"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="TyCon.html#isClassTyCon"><span class="hs-identifier hs-var">isClassTyCon</span></a><span> </span><a href="#local-6989586621682210139"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-comment">-- is a non-newtype dictionary</span><span>
</span><a name="line-1944"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#seqDmd"><span class="hs-identifier hs-var">seqDmd</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothDmd"><span class="hs-identifier hs-var">bothDmd</span></a><span class="hs-special">`</span><span> </span><span class="hs-comment">-- main idea: ensure it's strict</span><span>
</span><a name="line-1945"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="Demand.html#splitProdDmd_maybe"><span class="hs-identifier hs-var">splitProdDmd_maybe</span></a><span> </span><a href="#local-6989586621682210137"><span class="hs-identifier hs-var">dmd</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1946"></a><span>         </span><span class="hs-comment">-- superclass cycles should not be a problem, since the demand we are</span><span>
</span><a name="line-1947"></a><span>         </span><span class="hs-comment">-- consuming would also have to be infinite in order for us to diverge</span><span>
</span><a name="line-1948"></a><span>         </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682210137"><span class="hs-identifier hs-var">dmd</span></a><span> </span><span class="hs-comment">-- no components have interesting demand, so stop</span><span>
</span><a name="line-1949"></a><span>                        </span><span class="hs-comment">-- looking for superclass dicts</span><span>
</span><a name="line-1950"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682210143"><a href="#local-6989586621682210143"><span class="hs-identifier">dmds</span></a></a><span>
</span><a name="line-1951"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Demand.html#isAbsDmd"><span class="hs-identifier hs-var">isAbsDmd</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682210143"><span class="hs-identifier hs-var">dmds</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#evalDmd"><span class="hs-identifier hs-var">evalDmd</span></a><span>
</span><a name="line-1952"></a><span>             </span><span class="hs-comment">-- abstract to strict w/ arbitrary component use, since this</span><span>
</span><a name="line-1953"></a><span>             </span><span class="hs-comment">-- smells like reboxing; results in CBV boxed</span><span>
</span><a name="line-1954"></a><span>             </span><span class="hs-comment">--</span><span>
</span><a name="line-1955"></a><span>             </span><span class="hs-comment">-- TODO revisit this if we ever do boxity analysis</span><span>
</span><a name="line-1956"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Demand.html#mkProdDmd"><span class="hs-identifier hs-var">mkProdDmd</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="Demand.html#strictifyDictDmd"><span class="hs-identifier hs-var">strictifyDictDmd</span></a><span> </span><a href="#local-6989586621682210142"><span class="hs-identifier hs-var">inst_con_arg_tys</span></a><span> </span><a href="#local-6989586621682210143"><span class="hs-identifier hs-var">dmds</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1957"></a><span>               </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210144"><a href="#local-6989586621682210144"><span class="hs-identifier">s</span></a></a><span class="hs-special">,</span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210145"><a href="#local-6989586621682210145"><span class="hs-identifier">a</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="#local-6989586621682210144"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="#local-6989586621682210138"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682210145"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1958"></a><span>             </span><span class="hs-comment">-- TODO could optimize with an aborting variant of zipWith since</span><span>
</span><a name="line-1959"></a><span>             </span><span class="hs-comment">-- the superclass dicts are always a prefix</span><span>
</span><a name="line-1960"></a><span>  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621682210137"><span class="hs-identifier hs-var">dmd</span></a><span> </span><span class="hs-comment">-- unused or not a dictionary</span><span>
</span><a name="line-1961"></a><span>
</span><a name="line-1962"></a><span class="hs-identifier">strictifyDmd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#Demand"><span class="hs-identifier hs-type">Demand</span></a><span>
</span><a name="line-1963"></a><a name="strictifyDmd"><a href="Demand.html#strictifyDmd"><span class="hs-identifier">strictifyDmd</span></a></a><span> </span><a name="local-6989586621682210146"><a href="#local-6989586621682210146"><span class="hs-identifier">dmd</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682210147"><a href="#local-6989586621682210147"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1964"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210146"><span class="hs-identifier hs-var">dmd</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682210147"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-special">`</span><a href="Demand.html#bothArgStr"><span class="hs-identifier hs-var">bothArgStr</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1965"></a><span>
</span><a name="line-1966"></a><span class="hs-comment">{-
Note [HyperStr and Use demands]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The information &quot;HyperStr&quot; needs to be in the strictness signature, and not in
the demand signature, because we still want to know about the demand on things. Consider

    f (x,y) True  = error (show x)
    f (x,y) False = x+1

The signature of f should be &lt;S(SL),1*U(1*U(U),A)&gt;&lt;S,1*U&gt;m. If we were not
distinguishing the uses on x and y in the True case, we could either not figure
out how deeply we can unpack x, or that we do not have to pass y.


************************************************************************
*                                                                      *
                     Serialisation
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1987"></a><span>
</span><a name="line-1988"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#StrDmd"><span class="hs-identifier hs-type">StrDmd</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1989"></a><span>  </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209640"><a href="#local-6989586621682209640"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209640"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1990"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209641"><a href="#local-6989586621682209641"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209641"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1991"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209642"><a href="#local-6989586621682209642"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a name="local-6989586621682209643"><a href="#local-6989586621682209643"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209642"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-1992"></a><span>                            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209642"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209643"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-1993"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209644"><a href="#local-6989586621682209644"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a name="local-6989586621682209645"><a href="#local-6989586621682209645"><span class="hs-identifier">sx</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209644"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">3</span><span>
</span><a name="line-1994"></a><span>                            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209644"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209645"><span class="hs-identifier hs-var">sx</span></a><span>
</span><a name="line-1995"></a><span>  </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621682209646"><a href="#local-6989586621682209646"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1996"></a><span>         </span><a name="local-6989586621682209647"><a href="#local-6989586621682209647"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682209646"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-1997"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209647"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1998"></a><span>           </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#HyperStr"><span class="hs-identifier hs-var">HyperStr</span></a><span>
</span><a name="line-1999"></a><span>           </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#HeadStr"><span class="hs-identifier hs-var">HeadStr</span></a><span>
</span><a name="line-2000"></a><span>           </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209648"><a href="#local-6989586621682209648"><span class="hs-identifier">s</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209646"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2001"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SCall"><span class="hs-identifier hs-var">SCall</span></a><span> </span><a href="#local-6989586621682209648"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-2002"></a><span>           </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209649"><a href="#local-6989586621682209649"><span class="hs-identifier">sx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209646"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2003"></a><span>                   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Demand.html#SProd"><span class="hs-identifier hs-var">SProd</span></a><span> </span><a href="#local-6989586621682209649"><span class="hs-identifier hs-var">sx</span></a><span class="hs-special">)</span><span>
</span><a name="line-2004"></a><span>
</span><a name="line-2005"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-type">ExnStr</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2006"></a><span>  </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209636"><a href="#local-6989586621682209636"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209636"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2007"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209637"><a href="#local-6989586621682209637"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209637"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-2008"></a><span>
</span><a name="line-2009"></a><span>  </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621682209638"><a href="#local-6989586621682209638"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209639"><a href="#local-6989586621682209639"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682209638"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2010"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209639"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2011"></a><span>                        </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#VanStr"><span class="hs-identifier hs-var">VanStr</span></a><span>
</span><a name="line-2012"></a><span>                        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Demand.html#ExnStr"><span class="hs-identifier hs-var">ExnStr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2013"></a><span>
</span><a name="line-2014"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#ArgStr"><span class="hs-identifier hs-type">ArgStr</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2015"></a><span>    </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209628"><a href="#local-6989586621682209628"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2016"></a><span>            </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209628"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2017"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209629"><a href="#local-6989586621682209629"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a name="local-6989586621682209630"><a href="#local-6989586621682209630"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621682209631"><a href="#local-6989586621682209631"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2018"></a><span>            </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209629"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-2019"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209629"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209630"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-2020"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209629"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209631"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-2021"></a><span>
</span><a name="line-2022"></a><span>    </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span>  </span><a name="local-6989586621682209632"><a href="#local-6989586621682209632"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2023"></a><span>            </span><a name="local-6989586621682209633"><a href="#local-6989586621682209633"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682209632"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2024"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209633"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2025"></a><span>              </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#Lazy"><span class="hs-identifier hs-var">Lazy</span></a><span>
</span><a name="line-2026"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209634"><a href="#local-6989586621682209634"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209632"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2027"></a><span>                      </span><a name="local-6989586621682209635"><a href="#local-6989586621682209635"><span class="hs-identifier">s</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209632"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2028"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#Str"><span class="hs-identifier hs-var">Str</span></a><span> </span><a href="#local-6989586621682209634"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621682209635"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-2029"></a><span>
</span><a name="line-2030"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#Count"><span class="hs-identifier hs-type">Count</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2031"></a><span>    </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209624"><a href="#local-6989586621682209624"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209624"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2032"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209625"><a href="#local-6989586621682209625"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209625"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-2033"></a><span>
</span><a name="line-2034"></a><span>    </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span>  </span><a name="local-6989586621682209626"><a href="#local-6989586621682209626"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209627"><a href="#local-6989586621682209627"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682209626"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2035"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209627"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2036"></a><span>                   </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#One"><span class="hs-identifier hs-var">One</span></a><span>
</span><a name="line-2037"></a><span>                   </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#Many"><span class="hs-identifier hs-var">Many</span></a><span>
</span><a name="line-2038"></a><span>
</span><a name="line-2039"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#ArgUse"><span class="hs-identifier hs-type">ArgUse</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2040"></a><span>    </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209616"><a href="#local-6989586621682209616"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2041"></a><span>            </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209616"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2042"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209617"><a href="#local-6989586621682209617"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a name="local-6989586621682209618"><a href="#local-6989586621682209618"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209619"><a href="#local-6989586621682209619"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2043"></a><span>            </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209617"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-2044"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209617"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209618"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-2045"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209617"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209619"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-2046"></a><span>
</span><a name="line-2047"></a><span>    </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span>  </span><a name="local-6989586621682209620"><a href="#local-6989586621682209620"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2048"></a><span>            </span><a name="local-6989586621682209621"><a href="#local-6989586621682209621"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682209620"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2049"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209621"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2050"></a><span>              </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#Abs"><span class="hs-identifier hs-var">Abs</span></a><span>
</span><a name="line-2051"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209622"><a href="#local-6989586621682209622"><span class="hs-identifier">c</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209620"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2052"></a><span>                      </span><a name="local-6989586621682209623"><a href="#local-6989586621682209623"><span class="hs-identifier">u</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209620"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2053"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#Use"><span class="hs-identifier hs-var">Use</span></a><span> </span><a href="#local-6989586621682209622"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621682209623"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-2054"></a><span>
</span><a name="line-2055"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#UseDmd"><span class="hs-identifier hs-type">UseDmd</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2056"></a><span>    </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209604"><a href="#local-6989586621682209604"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2057"></a><span>            </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209604"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-2058"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209605"><a href="#local-6989586621682209605"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2059"></a><span>            </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209605"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-2060"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209606"><a href="#local-6989586621682209606"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a name="local-6989586621682209607"><a href="#local-6989586621682209607"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621682209608"><a href="#local-6989586621682209608"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2061"></a><span>            </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209606"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-2062"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209606"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209607"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-2063"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209606"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209608"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-2064"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209609"><a href="#local-6989586621682209609"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a name="local-6989586621682209610"><a href="#local-6989586621682209610"><span class="hs-identifier">ux</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2065"></a><span>            </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209609"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">3</span><span>
</span><a name="line-2066"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209609"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209610"><span class="hs-identifier hs-var">ux</span></a><span>
</span><a name="line-2067"></a><span>
</span><a name="line-2068"></a><span>    </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span>  </span><a name="local-6989586621682209611"><a href="#local-6989586621682209611"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2069"></a><span>            </span><a name="local-6989586621682209612"><a href="#local-6989586621682209612"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682209611"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2070"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209612"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2071"></a><span>              </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#Used"><span class="hs-identifier hs-var">Used</span></a><span>
</span><a name="line-2072"></a><span>              </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#UHead"><span class="hs-identifier hs-var">UHead</span></a><span>
</span><a name="line-2073"></a><span>              </span><span class="hs-number">2</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209613"><a href="#local-6989586621682209613"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209611"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2074"></a><span>                      </span><a name="local-6989586621682209614"><a href="#local-6989586621682209614"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209611"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2075"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UCall"><span class="hs-identifier hs-var">UCall</span></a><span> </span><a href="#local-6989586621682209613"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621682209614"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-2076"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209615"><a href="#local-6989586621682209615"><span class="hs-identifier">ux</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209611"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2077"></a><span>                      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Demand.html#UProd"><span class="hs-identifier hs-var">UProd</span></a><span> </span><a href="#local-6989586621682209615"><span class="hs-identifier hs-var">ux</span></a><span class="hs-special">)</span><span>
</span><a name="line-2078"></a><span>
</span><a name="line-2079"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="#local-6989586621682209596"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">,</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="#local-6989586621682209597"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JointDmd"><span class="hs-identifier hs-type">JointDmd</span></a><span> </span><a href="#local-6989586621682209596"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621682209597"><span class="hs-identifier hs-type">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2080"></a><span>    </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209598"><a href="#local-6989586621682209598"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209599"><a href="#local-6989586621682209599"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682209600"><a href="#local-6989586621682209600"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209598"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209599"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">;</span><span> </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209598"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209600"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-2081"></a><span>    </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span>  </span><a name="local-6989586621682209601"><a href="#local-6989586621682209601"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2082"></a><span>              </span><a name="local-6989586621682209602"><a href="#local-6989586621682209602"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209601"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2083"></a><span>              </span><a name="local-6989586621682209603"><a href="#local-6989586621682209603"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209601"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2084"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Demand.html#JD"><span class="hs-identifier hs-var">JD</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">sd</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209602"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ud</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682209603"><span class="hs-identifier hs-var">y</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2085"></a><span>
</span><a name="line-2086"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-type">StrictSig</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2087"></a><span>    </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209592"><a href="#local-6989586621682209592"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a name="local-6989586621682209593"><a href="#local-6989586621682209593"><span class="hs-identifier">aa</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2088"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209592"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209593"><span class="hs-identifier hs-var">aa</span></a><span>
</span><a name="line-2089"></a><span>    </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621682209594"><a href="#local-6989586621682209594"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2090"></a><span>          </span><a name="local-6989586621682209595"><a href="#local-6989586621682209595"><span class="hs-identifier">aa</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209594"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2091"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Demand.html#StrictSig"><span class="hs-identifier hs-var">StrictSig</span></a><span> </span><a href="#local-6989586621682209595"><span class="hs-identifier hs-var">aa</span></a><span class="hs-special">)</span><span>
</span><a name="line-2092"></a><span>
</span><a name="line-2093"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#DmdType"><span class="hs-identifier hs-type">DmdType</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2094"></a><span>  </span><span class="hs-comment">-- Ignore DmdEnv when spitting out the DmdType</span><span>
</span><a name="line-2095"></a><span>  </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209586"><a href="#local-6989586621682209586"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682209587"><a href="#local-6989586621682209587"><span class="hs-identifier">ds</span></a></a><span> </span><a name="local-6989586621682209588"><a href="#local-6989586621682209588"><span class="hs-identifier">dr</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2096"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209586"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209587"><span class="hs-identifier hs-var">ds</span></a><span>
</span><a name="line-2097"></a><span>            </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209586"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209588"><span class="hs-identifier hs-var">dr</span></a><span>
</span><a name="line-2098"></a><span>  </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621682209589"><a href="#local-6989586621682209589"><span class="hs-identifier">bh</span></a></a><span>
</span><a name="line-2099"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621682209590"><a href="#local-6989586621682209590"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209589"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2100"></a><span>           </span><a name="local-6989586621682209591"><a href="#local-6989586621682209591"><span class="hs-identifier">dr</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209589"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2101"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Demand.html#DmdType"><span class="hs-identifier hs-var">DmdType</span></a><span> </span><a href="Demand.html#emptyDmdEnv"><span class="hs-identifier hs-var">emptyDmdEnv</span></a><span> </span><a href="#local-6989586621682209590"><span class="hs-identifier hs-var">ds</span></a><span> </span><a href="#local-6989586621682209591"><span class="hs-identifier hs-var">dr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2102"></a><span>
</span><a name="line-2103"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#DmdResult"><span class="hs-identifier hs-type">DmdResult</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2104"></a><span>  </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209579"><a href="#local-6989586621682209579"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a name="local-6989586621682209580"><a href="#local-6989586621682209580"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209579"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">;</span><span> </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209579"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209580"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2105"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209581"><a href="#local-6989586621682209581"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209581"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-2106"></a><span>  </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209582"><a href="#local-6989586621682209582"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209582"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-2107"></a><span>
</span><a name="line-2108"></a><span>  </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621682209583"><a href="#local-6989586621682209583"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682209584"><a href="#local-6989586621682209584"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682209583"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2109"></a><span>              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209584"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2110"></a><span>                  </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682209585"><a href="#local-6989586621682209585"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209583"><span class="hs-identifier hs-var">bh</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Demand.html#Dunno"><span class="hs-identifier hs-var">Dunno</span></a><span> </span><a href="#local-6989586621682209585"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2111"></a><span>                  </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#ThrowsExn"><span class="hs-identifier hs-var">ThrowsExn</span></a><span>
</span><a name="line-2112"></a><span>                  </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#Diverges"><span class="hs-identifier hs-var">Diverges</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2113"></a><span>
</span><a name="line-2114"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="Demand.html#CPRResult"><span class="hs-identifier hs-type">CPRResult</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2115"></a><span>    </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682209572"><a href="#local-6989586621682209572"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a name="local-6989586621682209573"><a href="#local-6989586621682209573"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209572"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">;</span><span> </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682209572"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682209573"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2116"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209574"><a href="#local-6989586621682209574"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209574"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-2117"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682209575"><a href="#local-6989586621682209575"><span class="hs-identifier">bh</span></a></a><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682209575"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">2</span><span>
</span><a name="line-2118"></a><span>
</span><a name="line-2119"></a><span>    </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span>  </span><a name="local-6989586621682209576"><a href="#local-6989586621682209576"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2120"></a><span>            </span><a name="local-6989586621682209577"><a href="#local-6989586621682209577"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682209576"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-2121"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682209577"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2122"></a><span>              </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682209578"><a href="#local-6989586621682209578"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682209576"><span class="hs-identifier hs-var">bh</span></a><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Demand.html#RetSum"><span class="hs-identifier hs-var">RetSum</span></a><span> </span><a href="#local-6989586621682209578"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2123"></a><span>              </span><span class="hs-number">1</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#RetProd"><span class="hs-identifier hs-var">RetProd</span></a><span>
</span><a name="line-2124"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Demand.html#NoCPR"><span class="hs-identifier hs-var">NoCPR</span></a><span>
</span><a name="line-2125"></a></pre></body></html>